

* chris 2021-07-15
* export_to_pdf_creator

FUNCTION export_to_pdf_creator
LPARAMETERS cCursor, _tmpfrxname


* ·sª©¥» pdf creator ¥i©T©w output path & file name
* ©w¬° d:\pos6\pdf_export.pdf
* ¤§«á±N d:\pos6\pdf_export.pdf ¦A copy ¥h»Ý­nªº filename
* ¦A erase d:\pos6\pdf_export.pdf 


_pdffile = Sys(5)+Sys(2003)+"\pdf_export.pdf"


_tmpcount = 1
DO WHILE .t.

* ¥ý delete pdf_export.pdf 
* ¦pªG 300¬í³£¤£¯à earase, ¼u¨«

	IF FILE(_pdffile)

		TRY 
			ERASE (_pdffile)
		CATCH 
		FINALLY
		ENDTRY 	
		
	ELSE
		EXIT 	
	ENDIF

	f0Sleep(1000)
	_tmpcount = _tmpcount + 1

	IF _tmpcount = 300
		EXIT
	ENDIF 	

ENDDO 

IF _tmpcount = 300
	fmessagebox("¤£¯à§R°£ " + _pdffile + "¡A½ÐÀË¬d !!")
	RETURN -1
ENDIF
	
IF APRINTERS(printer_list)=0
	fmessagebox("_no_printer_found")	
	RETURN -1
ENDIF
					
IF ASCAN(printer_list,"PDFCreator")=0
	_mess=getmessage("_no_printer_found")+CHR(13)+CHR(13)+"PDFCreator"
	fmessagebox(_mess)
	RETURN -1
ENDIF
					
RELEASE printer_list


IF AT(".FRX",UPPER(_tmpfrxname)) > 0
	_tmpfrxname = SUBSTR(_tmpfrxname,1,LEN(ALLTRIM(_tmpfrxname))-4)
ENDIF

COPY FILE &_tmpfrxname..frx TO tmp.frx
COPY FILE &_tmpfrxname..frt TO tmp.frt

SELECT 0
USE tmp.frx
LOCATE FOR Objtype = 1 AND Objcode = 53
REPLACE tag WITH "",tag2 WITH "" 		&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m
					
FOR i=1 TO 20							&&¥´¦L¾÷§ï§ó¬° PDFCreator
	IF "DEVICE="$MLINE(expr,i)
		lcOld=MLINE(expr,i)
		lcNew="DEVICE=PDFCreator"
		REPLACE expr WITH STRTRAN(Expr,lcOld,lcNew)
		EXIT
	ENDIF
ENDFOR

USE IN tmp


SELECT (cCursor)
SET PRINTER TO NAME PDFCreator
REPORT FORM tmp TO PRINTER NOCONSOLE 


* µ¥ 600 ¬í pdfcreator ²£¥Í pdf_export.pdf

_tmpcount = 1
DO WHILE .t.

	IF FILE(_pdffile)
		EXIT 	
	ENDIF

	f0Sleep(1000)
	_tmpcount = _tmpcount + 1

	IF _tmpcount = 600
		EXIT
	ENDIF 	

ENDDO

IF _tmpcount = 600
	fmessagebox("¤£¯à¶×¥X¦Ü " + _pdffile + "¡A½ÐÀË¬d !!")
	RETURN -1
ENDIF
					
DELETE FILE tmp.*


RETURN 1

ENDFUNC 





#Define CHECK_USB_DOG   1							&& ¬O§_ÀË¬d³n¥óª¯

Function  OXF4EB5
Lparameters Cpara
Return Strconv(Cpara,16)

Endfunc
*-------------------------
*****************************
Function public_define
Public  rv_desc

Public rv_compare_d1, rv_compare_d2, tmpfrx, rv_d1, rv_d2, rv_d3, rv_d4, rv_repo_printer_select
rv_repo_printer_select = 1
rv_compare_d1 = 1
rv_compare_d2 = 2
tmpfrx = ""
rv_d1 = Date()
rv_d2 = Date()
rv_d3 = Date()
rv_d4 = Date()


Public rv_defa_printer, rv_cardno, rv_idno, rv_role, rv_lang, rv_discamt, rv_discper


rv_defa_printer = Alltrim(Set("printer",2))


rv_cardno		= getmessage("_cardno")
rv_idno			= getmessage("_id_no")
rv_role			= getmessage("_user_role")
rv_lang			= getmessage("_default_language")
rv_discamt		= getmessage("_discamt")
rv_discper		= getmessage("_discper")

Public rv_system_name , rv_daterange , rv_datetype , rv_datefrom , rv_dateto , rv_item_code_range , ;
	rv_from , rv_to, rv_item_code_contain , rv_card_contain , rv_sort_by , rv_amount , ;
	rv_ascending , rv_descending , rv_invno_range , rv_show_cost , rv_station , rv_business_area_outlet , ;
	rv_ctrl_c_cancel , rv_exit, rv_ok, rv_time, rv_show, rv_all, rv_itemcode, rv_keyword , ;
	rv_usagelog, rv_errorlog, rv_date_staff , rv_staff_date , rv_chi, rv_eng, rv_active, ;
	rv_ingredient_more , rv_ingredient_less, rv_ingredient_remove, rv_ingredient_only, rv_askprice, rv_multiqty, ;
	rv_display_in_order , rv_not_display_in_order, rv_daily, rv_monthly, rv_month,GL_DEMO, rv_member, rv_perc, rv_exp_cate, rv_user, rv_tel, ;
	rv_email, rv_id_no, rv_job, rv_gender, rv_birth, rv_printer, rv_dine_in, rv_fastfood, rv_srv, rv_printer, rv_modifier, rv_contact , ;
	rv_workhour,rv_tax,rv_askno,rv_sitem,rv_stime,rv_etime,rv_points 
	
	
rv_stime				= getmessage("_start_time")

rv_etime				= getmessage("_end_time")
	
rv_sitem				= getmessage("_sitem")
rv_askno				= getmessage("_askno")

rv_workhour			= getmessage("_workmins")
rv_contact				= getmessage("_contact")
rv_modifier			= getmessage("_modifier")
rv_printer				= getmessage("_printer")
rv_srv				= getmessage("_svr_charge")
rv_fastfood			= getmessage("_fastfood")
rv_dine_in				= getmessage("_dine_in")
rv_printer				= getmessage("_printer")
rv_birth				= getmessage("_date_of_birth")
rv_gender				= getmessage("_gender")
rv_job					= getmessage("_occupation")
rv_id_no				= getmessage("_id_no")
rv_email				= getmessage("_email")
rv_tel					= getmessage("_tel")
rv_user					= getmessage("_user")
rv_exp_cate				= getmessage("_expense_cate")
rv_perc					= getmessage("_percentage")
rv_member				= getmessage("_member")
rv_month				= getmessage("_month")
rv_daily				= getmessage("_daily")
rv_monthly				= getmessage("_monthly")
rv_not_display_in_order = getmessage("_not_display_in_order")
rv_display_in_order 	= getmessage("_display_in_order")
rv_multiqty				= getmessage("_multiqty")
rv_askprice				= getmessage("_askprice")
rv_ingredient_more		= getmessage("_ingredient_more")
rv_ingredient_less		= getmessage("_ingredient_less")
rv_ingredient_remove	= getmessage("_ingredient_remove")
rv_ingredient_only		= getmessage("_ingredient_only")
rv_active				= getmessage("_active")
rv_chi					= getmessage("_chinese")
rv_eng					= getmessage("_eng")
rv_staff_date 			= getmessage("_staff_date")
rv_date_staff 			= getmessage("_date_staff")
rv_errorlog 			= getmessage("_errorlog")
rv_usagelog 			= getmessage("_usagelog")
rv_keyword 				= getmessage("_keyword")
rv_itemcode				= getmessage("_itemcode")
rv_all 					= getmessage("_all")
rv_show 				= getmessage("_show")
rv_time					= getmessage("_time")
rv_ok 					= getmessage("_ok")
rv_exit 				= getmessage("_exit")
rv_ctrl_c_cancel 		= getmessage("_ctrl_c_cancel")
rv_business_area_outlet = getmessage("_business_area_outlet")
rv_station 				= getmessage("_station")
rv_show_cost 			= getmessage("_show_cost")
rv_invno_range 			= getmessage("_invno_range")
rv_descending 			= getmessage("_sort_by_descending")
rv_ascending 			= getmessage("_sort_by_ascending")
rv_amount 				= getmessage("_amount")
rv_sort_by 				= getmessage("_sort_by")
rv_card_contain 		= getmessage("_cardno_contain")
rv_item_code_contain 	= getmessage("_item_name_contain")
rv_to 					= getmessage("_to")
rv_from 				= getmessage("_from")
rv_item_code_range 		= getmessage("_item_code_range")
rv_dateto 				= getmessage("_date_to")
rv_datefrom 			= getmessage("_datefrom")
rv_datetype 			= getmessage("_datetype")
rv_system_name 			= getmessage("_system_name")
rv_daterange 			= getmessage("_daterange")
rv_tax				= getmessage("_tax")
rv_points 				=getmessage("_points")

Public _public_define_yes,_public_define_no, _public_message_id, gd_sdate, gd_edate, gn_datetype, gnStopXFRX, ;
	ntotalpage , gc_repoline1, gc_repoline2 , gc_repofoot1 , gc_repofoot2 , gc_repofoot3 , gc_repofoot4 , ;
	gc_repofoot5 , gc_repofoot6 , gc_repofoot7 , gc_repofoot8 , gc_repofoot9 , gc_repofoot10, gl_viewcost, sdate, edate

_public_define_yes=getmessage("_yes")
_public_define_no=getmessage("_no")
_public_message_id = 0
gn_datetype = 1
gd_sdate = Date()
ge_edate = Date()
gnStopXFRX = 0
gc_repoline1 = ""
gc_repoline2 = ""
gc_repofoot1 = ""
gc_repofoot2 = ""
gc_repofoot3 = ""
gc_repofoot4 = ""
gc_repofoot5 = ""
gc_repofoot6 = ""
gc_repofoot7 = ""
gc_repofoot8 = ""
gc_repofoot9 = ""
gc_repofoot10 = ""
ntotalpage = 0
gl_viewcost = .F.


Public rv_section, rv_section1, rv_section2, rv_section3, rv_section4, rv_section5
Public rv_sectiontime1, rv_sectiontime2, rv_sectiontime3, rv_sectiontime4, rv_sectiontime5


Public rv_date, rv_page, rv_code, rv_name, rv_qty, rv_orgamt, rv_disc, rv_svc, rv_round, rv_net, rv_total, rv_end1, rv_cate, ;
	rv_payway, rv_times, rv_amt, rv_tips, rv_outlet, rv_workmins, rv_qty, rv_cost, rv_profit, rv_waiter, rv_discround, rv_margin, ;
	rv_cover1, rv_invcount, rv_avgcover, rv_avginv, rv_itemqty, rv_tag, rv_hour, rv_paidtime, rv_seattime, rv_dept, rv_tableno, ;
	rv_action1, rv_action2, rv_station_user, rv_invno, rv_cashier, rv_reason, rv_cover,rv_fax,rv_workaddr,rv_carno,rv_addr,rv_payamt,rv_change,rv_dow,;
	rv_expend,rv_invcount,rv_avgcover,rv_remark, rv_year, rv_adduser, rv_item_code, rv_item_name

rv_change=getmessage("_change")		&&§ä¦^
rv_payamt=getmessage("_paid_amt")
rv_dow=getmessage("_dow")	&&¬P´Á
rv_expend=getmessage("_expense_amount")	&&¬P´Á
rv_invcount=getmessage("_inv_count")
rv_avgcover= getmessage("_avgcover")
rv_year	= getmessage("_year")


rv_cover	= getmessage("_pplcnt")
rv_section  = getmessage("_section")
rv_reason	= getmessage("_reason")
rv_cashier 	= getmessage("_cashier")
rv_invno 	= getmessage("_invno")
rv_action1	= getmessage("_action1")
rv_action2	= getmessage("_action2")
rv_station_user = getmessage("_station_user")
rv_tableno 	= getmessage("_tableno")
rv_dept		= getmessage("_dept")
rv_paidtime	= getmessage("_paidtime")
rv_seattime	= getmessage("_seattime")
rv_hour		= getmessage("_hour")
rv_tag 		= ""
rv_itemqty	= getmessage("_itemqty")
rv_cover1	= getmessage("_pplcnt")
rv_invcount	= getmessage("_invcount")
rv_avgcover	= getmessage("_avgcover")
rv_avginv	= getmessage("_avginv")
rv_margin	= getmessage("_margin")
rv_discround = getmessage("_disc_round")
rv_waiter   = getmessage("_waiter")
rv_profit	= getmessage("_profit")
rv_cost		= getmessage("_cost")
rv_qty		= getmessage("_qty")
rv_workmins	= getmessage("_workmins")
rv_outlet	= getmessage("_outlet")
rv_tips		= getmessage("_tips")
rv_amt 		= getmessage("_amount")
rv_times 	= getmessage("_times")
rv_payway 	= getmessage("_payway")
rv_date		= getmessage("_date")
rv_page		= getmessage("_page")
rv_code		= getmessage("_code")
rv_name		= getmessage("_name")
rv_qty		= getmessage("_qty")
rv_orgamt	= getmessage("_orgamt")
rv_disc		= getmessage("_discount")
rv_svc		= getmessage("_svr_charge")
rv_round	= getmessage("_rounding")
rv_net		= getmessage("_net")
rv_total	= getmessage("_total")
rv_end1		= getmessage("_end1")
rv_cate		= getmessage("_cate")
rv_fax		= getmessage("_fax")
rv_workaddr = getmessage("_work_location")
rv_carno	= getmessage("_carno")
rv_addr		= getmessage("_addr")
rv_remark	= getmessage("_remark")
rv_adduser	= getmessage("_add_user") 
rv_item_code = getmessage("_item_code")
rv_item_name = getmessage("_item_name")


Public fr_day
fr_day = 0

If user_access("fr_report_no_limit")
	fr_day = 0
Else
	If user_access("fr_report_90_days")
		fr_day = 90
	Else
		If user_access("fr_report_60_days")
			fr_day = 60
		Else
			If user_access("fr_report_30_days")
				fr_day = 30
			Else
				If user_access("fr_report_7_days")
					fr_day = 7
				Else
					If user_access("fr_report_2_days")
						fr_day = 2
					Else
						fr_day = 1
					Endif
				Endif
			Endif
		Endif
	Endif
Endif

Public __octopus_xfile

Public view_random, view_inv, view_inv_disc, view_inv_detail, view_inv_itemdisc, view_inv_modi,view_inv_pay


view_random = Sys(2015)		&& sys(2015)
view_inv = "inv_view" + view_random
view_inv_disc = "inv_disc_view" + view_random
view_inv_detail= "inv_detail_view" + view_random
view_inv_itemdisc = "inv_itemdisc_view" + view_random
view_inv_modi = "inv_modi_view" + view_random
view_inv_pay = "inv_pay_view" + view_random

Public view_random1, view_inv1, view_inv_disc1, view_inv_detail1, view_inv_itemdisc1, view_inv_modi1,view_inv_pay1


view_random1 = view_random +"1"
view_inv1 = "inv_view" + view_random1
view_inv_disc1 = "inv_disc_view" + view_random1
view_inv_detail1= "inv_detail_view" + view_random1
view_inv_itemdisc1 = "inv_itemdisc_view" + view_random1
view_inv_modi1 = "inv_modi_view" + view_random1
view_inv_pay1 = "inv_pay_view" + view_random1

Return


Endfunc



**************************
* 2008-12-31
* send sms ®É§â tel ¤¤ªº«D + & 0-9 ²¾¥h
**************************
Function trim_tel_no
Lparameters _telno
Local a, b

b=""
For a = 1 To Len(Alltrim(_telno))
	b = b + Iif( Inlist(Substr( _telno, a, 1) , "+" , "0", "1" , "2" , "3" , "4" , ;
		"5", "6" , "7" , "8" , "9") , Substr( _telno, a, 1) , "")
Endfor
Return(b)


***************************
*	load_system_setting
*	¸ü¤J¨t²Î³]©w,¥Í¦¨¤½¦@ÅÜ¶q
*
***************************
Function load_system_setting
Lparameters lReload,cStation

If rms_express Or rms_report

	Return IK0Q492H88CDXP(lReload,cStation)

Endif

#Ifdef  CHECK_USB_DOG

	If Vartype(_Screen.chkdog)="U"
		_Screen.AddProperty("chkdog",-1)

	Endif

	If !File("DOG.DLL")			&& OR !FILE("WIN32DLL.DLL")

*!*				frm_wait.hide
*!*				=fmessagebox("dog.dll not found!!")
*!*				WAIT WINDOW "" TIMEOUT 2
		Return -3

	Endif

	Set Library To dog.Dll
	Local dn
	dn=chkdog()
	If 	dn<0


		If __admin__user

			Messagebox("Please check usb dog!")

		Endif


*!*					frm_wait.hide
*!*					=fmessagebox("ENCRYPT DOG not found !! ")
*!*					WAIT WINDOW "" TIMEOUT 2

		Release Library dog.Dll
		Return -4

	Endif
	_Screen.chkdog=dn


	Release Library dog.Dll
	Return 1

#Else
	Return  IK0Q492H88CDXP(lReload,cStation)

#Endif

Endfunc


**************************
*¥´¦LCOUPON
Function print_coupon
Lparameters nInvID


If __inv_print_to_local=.F.
	Return

Endif


If SQLExec(nhand,"select invamt from inv where id=?ninvID","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return

Endif

_inv_id=nInvID
_inv_amount=cun_tmp.invamt


If Vartype(__inv_print_percent_coupon)="N" And __inv_print_percent_coupon>0


	_coupon_amt=Int(_inv_amount*__inv_print_percent_coupon/100)

	If _coupon_amt=0

		Return

	Endif

	_date=Date()
	_invID=nInvID

	_image=Fullpath("ico\invlogo.bmp")

	If !File(_image)
		_image=""
	Endif

	Select cun_tmp

	Try

		Set Printer To NAME (__sys_inv_printer)
		Report Form  Report\coupon01 To Printer Nodialog Noconsole


	Endtry



Else


	If  _inv_amount>__inv_print_coupon And __inv_print_coupon>0


		Local i
		Select cun_tmp
		For i=1 To  Int(_inv_amount/__inv_print_coupon)

			Try
				Set Printer To NAME (__sys_inv_printer)
				Report Form  Report\coupon To Printer Nodialog Noconsole

			Catch To oError

			Endtry



		Endfor

	Endif


Endif

Endfunc
*******************

********************
*  2008-08-11
* craate  index   for tableno
*********************
Function  Xindex
Lparameters ctext

If Empty(ctext)
	Return ""
Endif

Local i,cstr,nlen

cstr=Alltrim(ctext)
nlen=Len(cstr)

For i=1 To nlen

	If Between(Substr(cstr,i,1),"0","9")			&& 0--9

		Return  Substr(cstr,1,i-1)+Padl(Right(cstr,nlen-i+1),10-i+1,"0")

	Endif


Endfor


Return  Padr(cstr,10,"0")

Endfunc

*****************************

*2008-08-11
Function f0Sleep
Lparameters lnMilliSecs

lnMilliSecs=Iif(Type("lnMillisecs")="N",lnMilliSecs,0)

Declare Sleep In WIN32API Integer nMillisecs

= Sleep(lnMilliSecs)
Endfunc




***********************************
*2008-6-16
*check PC ¦³µL¤Wºô, ping proan.dyndns.org
*¦p¦³ ip §Y¬O ok
***********************************
Function check_internet

If Vartype(__proan_hand)#"U"
	Return

Endif


Public __proan_hand
__proan_hand = -1



If rms_express = .T.
	Return
Endif


If File("mocha.txt")
	Return
Endif

frm_wait.showmessage("Check internet access...")
Wait "" To N Timeout 0.1

*2010-10-12
*²»ÔÙ send error È¥ garment express

*2010-05-19
*ÒòÈÔÎ´ login ËùÒÔÎ´ÓÐ load system setting __check_internet_access

If Vartype(__check_internet_access) = "U" Or (Vartype(__check_internet_access) # "U" And __check_internet_access=.F.)
	Return
Endif

*2008-10-29
* ßíÖªüc½â ping proan.dyndns.org ?ŸoÉÏ¾W•rºÃÂý,
* ¸ÄžéÖ±½ÓÓÃÀÏÄ¸? fix ip

=SQLSetprop(0,"displogin",3)
=SQLSetprop(0,"DispWarnings", .F. )
=SQLSetprop(0,"ConnectTimeOut", 1 )

strSqlConStr =  "Driver=SQL Server;SERVER=garmentexpress.poshk.com,2470;UID=sa;PWD=proanpossapwd;DATABASE=rms6"

__proan_hand = Sqlstringconnect(strSqlConStr)


If __proan_hand > -1

	If Vartype(__start32_code) # "U"


		If Empty(Alltrim(__start32_code)) Or Empty(Alltrim(__start32_shop))
			fmessagebox( "set CODE and SHOP at POS6 !!" )
		Else

			If SQLExec( __proan_hand, "SELECT * FROM pos_lock where c_code = ?ALLTRIM(__start32_code) and shop = ?ALLTRIM(__start32_shop)", "cr1") < 0
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),&__program, Lineno(1))
				Return
			Endif

			If Eof("cr1")
				fmessagebox("Set Start32")
			Else
				=SQLExec(nhand, "UPDATE system_setting SET cvalue = ?cr1.bomb_start_date WHERE pcode = '__bombstartdate'")
				=SQLExec(nhand, "update system_setting set cvalue = ?cr1.bomb_prompt_day where pcode = '__bombpromptday'")


			Endif



		Endif
	Endif

	=SQLIdleDisconnect(__proan_hand)
Endif

If Used("cr1")
	Use In cr1
Endif

*MESSAGEBOX(__bombstartdate )
*MESSAGEBOX(__bombpromptday)
*--	Set Timeout to 3 second (2009-10-13)


=SQLSetprop(0,"ConnectTimeOut", 3 )

Return

Endfunc







*************************
*pass year & month then return first day of that month
Proc p_1stday
Para xyear, xmonth
Return (Datetime( xyear , xmonth, 1))



*************************
*pass year & month then return last day of that month
Proc p_lastday
Para xyear, xmonth
Local _date

a=31
_date = {}
Do While _date = {}
	_date = Datetime( xyear, xmonth, a)
	a=a-1
Enddo
Return(_date)





*=============================================================================
* File Name     : f0Time.prg
* Function Name : f0RMin()
* Prameter		: lcTime1	- current time
* 				  lcTime2	- start time
*=============================================================================
*-- "06:00:00", "00:00:00"			return 64800
*-- "06:00:00", "02:00:00"			return 72000
*-- "06:00:00", "08:00:00"			return 7200
Function f0RMin
Lparameter lcTime1, lcTime2
Local ltTime1, ltTime2, lnDiff

ltTime1		= Ctot(Dtoc(Date()) + " " + lcTime1)
ltTime2		= Ctot(Dtoc(Date()) + " " + lcTime2)
lnDiff		= Round((ltTime2 + Iif(ltTime1 => ltTime2, 86400, 0)) - ltTime1, 0)
lnDiff		= Iif(lnDiff = 86400, 0, lnDiff)
Return lnDiff





* ----FUNCTION¦Cªí---------------------------------------------------------------------------
* FUNCTION connect_sql  				³s±µSQL SERVER (¨ã¦³ºÞ²z¥Î¤áÅv­­¡A¦ý¤£¤@©w¬Osa)
* FUNCTION beep  						¹q¸£³â¥zµoÁn
* FUNCTION Fmessagebox          		¦Û¨îªº MESSAGEBOX
* FUNCTION getservertime				¨ú¨t²Î®É¶¡
* FUNCTION load_system_setting 		 	¸ü¤J¥Î¤á¨t²Î³]©w,¥Í¦¨¤½¦@ÅÜ¶q
* FUNCTION update_system_setting() 		§ó·s¨t²Î³]©w
* FUNCTION data_auto_update				¼Æ¾Ú¦Û°Ê§ó·s

* FUNCTION CHECK_FOR_UPDATE  			³n¥óÀË´ú§ó·s
*
* FUNCTION SAVE_TO_INV					²£¥Í¨Ã¦L¦Cµo²¼
* FUNCTION CLEAN						¤éµ²/²M¾÷

* FUNCTION check_bomb					®É¶¡¬µ¼uÀË¬d
* FUNCTION  syncservertime				»PªA°È¾¹®É¶¡¦P¨B
* FUNCTION getbelongdate				¨ú·í«e¤é´Á(Àç·~®É¶¡)

* FUNCTION create_order_cursor			«Ø¥ß¸¨³æ©Ò»ÝªºÁ{®Éªí(cursor)
* Function Load_order					¸ü¤J¸¨³æ
* FUNCTION load_order_express			¸ü¤J¸¨³æ(Â²³æ¼Ò¦¡¡A¥Î©ó¦L³æ«e«O¦s)
* FUNCTION SAVE_ORDER					«O¦s·í«e¸¨³æ
* FUNCTION MULT_ORDER_ITEM				µæ¦¡¦h»y¨¥¦C¦L
* FUNCTION INV_LOCAL_PRINT				µo²¼¥»¦a¦C¦L
* FUNCTION paylist_local_print			¥I´Ú²M³æ¥»¦a¦C¦L
* FUNCTION INV_REPRINT					µo²¼­«¦L
* Function slip_print					¤Wµæ¯È¥´¦L
* Function outlet_printer				°Ï°ì¥´¦L¾÷³W«h
* Function ITEM_OUTLET_PRINTER			µæ¦¡°Ï°ì¥´¦L¾÷³W«h
* Function order_item_print				µæ¦¡¥´¦L
* FUNCTION new_table					°ó®y¼Ò¦¡¤U¡A¦b¿ï¾Ü¦L³æµo²¼«á¡A«ö·sÂiµ²±b³B²z

* FUNCTION level_rule_check				µæ¦¡¯Å§O³W«h­pºâ
* Function rounding_amount				ª÷ÃB§E¼Æ³B²z
* Function amount_check					ª÷ÃB/§é¦©/ªA°È¶O/­p®Éµ¥ºî¦X­pºâ

* FUNCTION error_catch					¿ù»~®·®»
* FUNCTION write_log					¥Î¤á¾Þ§@°O¿ý
* FUNCTION user_access					¥Î¤á¨¤¦âÅv­­ÀË´ú
* Function sys_user_check				¥Î¤áÅv­­ÀË´ú
* FUNCTION check_print_server			ÀË´ú¥´¦LªA°Èµ{§Ç¬O§_¥¿±`

*---------------------------------------------------------------------------------------------


Function error_catch
Lparameters ctitle,error_code,error_msg,error_prog,error_line,no_show


IF nhand<=0
	cMess="Error Code: "+ALLTRIM(STR(error_code)) +CHR(13)+;
		"Error_msg: "+error_msg+CHR(13)+;
		"Error_prog: "+error_prog + CHR(13)+;
		"Error_line: "+ALLTRIM(STR(error_line))
		
	MESSAGEBOX(cMess)
	
	RETURN 


ENDIF


If Vartype(_android_station)="C"
	_station=_android_station
Else

	_station=getcomputername()
Endif


ssql="Insert into error_log (error_code,error_msg,error_prog,error_line,adduser,error_satation,errer_date, version) values ("+;
	"?error_code,?error_msg,?error_prog,?error_line,?_login_user_name,?_station,getdate(), ?__exe_name )"

SQLExec(nhand,ssql)			&&¼g¤J¿ù»~½X¤é»x,¤£½×¬O§_¼g¤J¦¨¥\
write_log(167,"Error!!!")


*** ¦p¦³ internet access, send error to proan

If Vartype(__proan_hand) <> "U"
	If __proan_hand > 0

		_syslog = ""

		TEXT TO cmd noshow
			select top 20 a.station, a.adduser, a.datetime, a.log_id, a.action , ISNULL(b.desccn , '') as desccn from sys_log a
			left join message_log b on a.log_id = b.id order by a.datetime desc
		ENDTEXT


		If SQLExec(nhand, cmd, "cr_err") > 0
			Select cr_err
			Go Bott
			Do While Not Bof()
				_syslog = _syslog + cr_err.station + Chr(9) + ;
					cr_err.adduser + Chr(9) + ;
					TTOC(cr_err.Datetime) + "  " + Chr(9) + ;
					cr_err.action + Chr(9) + ;
					ALLTRIM(cr_err.desccn) + " (" + Alltrim(Str(cr_err.log_id)) + ")" + Chr(13)

				Skip -1
			Enddo
			Use In cr_err
		Endif


		TEXT TO ssql noshow

			Insert into error_log ( co, error_date,error_code,error_msg,error_prog,error_line,adduser,error_satation, invl1, invl2, invl3, invl4 , version, sys_log )
				values (?__company_name,getdate(), ?error_code,?error_msg,?error_prog,?error_line,?_login_user_name,?_station,
				?__inv_header1_cn, ?__inv_header2_cn, ?__inv_header3_cn, ?__inv_header4_cn, ?__exe_name , '
		ENDTEXT

		ssql = ssql + _syslog + " ') "

*				?_syslog )

		c=SQLExec(__proan_hand,ssql)
	Endif
Endif




*!*	IF gl_demo = .f.  AND rms_express=.f. AND __debug_mode=.f.

*!*		IF !EMPTY(__email_smtp)

*!*			IF __email_method = "vfpwinsock"
*!*
*!*				o = CREATEOBJECT("VFP_Winsock_Send_Mail")

*!*				IF TYPE("error_code") = "N"
*!*					o.message	= "Code : " + ALLTRIM(STR(error_code)) + chr(10)
*!*				ELSE
*!*					o.message	= "Code : " + ALLTRIM(error_code) + chr(10)
*!*				ENDIF
*!*
*!*				o.message	= o.message + "Msg : " + error_msg + chr(10)
*!*				o.message	= o.message + "Prog : " + error_prog + chr(10)
*!*				o.message	= o.message + "Line : " + ALLTRIM(STR(error_line)) + chr(10)
*!*				o.message	= o.message + "User : " + _login_user_name + chr(10)
*!*				o.message	= o.message + "Station : " + _station + chr(10)
*!*				o.message	= o.message + "Date : " + TTOC(DATETIME())

*!*				o.SMTP_HOST 	= allt(__email_smtp)
*!*				o.FROM 			= allt(__email_co) + " @"		&& ¤@©w­A¦³ '@' ¤~·| send ¥X¥h!!
*!*				o.Subject 		= __company_name + "  Error"
*!*				o.TO 			= __email_proan
*!*				o.send()
*!*				o = null

*!*			ELSE		&& re_mail.dll
*!*
*!*				IF FILE("re_mail.dll")
*!*					Declare INTEGER "License" IN re_mail.dll INTEGER @lpassword

*!*					m.q_passdate=DTOS(DATE())
*!*					m.q_password=1943
*!*					m.q_nn=1

*!*					a = 1		&& ¸Õ¹L©óÄ_Â×¦æ¥H¤Uªº loop ¤£¯à exit, ¥[¦h­ÓÀË¬d³Ì¦h¸Õ 1000 ¦¸
*!*					Do WHILE m.q_nn<=LEN(m.q_passdate)
*!*						m.q_password=m.q_password+VAL(SUBS(m.q_passdate,m.q_nn,1))
*!*						m.q_nn=m.q_nn+1

*!*						a=a+1
*!*						IF a > 1000
*!*							m.q_nn = -1
*!*							EXIT
*!*						ENDIF
*!*					Enddo
*!*					=license(@m.q_password)


*!*					IF m.q_nn <> -1
*!*						Declare INTEGER "RESendMail" IN re_mail.dll ;
*!*							STRING smtphost,;
*!*							STRING emailfrom,;
*!*							STRING emailto,;
*!*							STRING subject,;
*!*							STRING msg,;
*!*							STRING attachments,;
*!*							INTEGER hdisplay,;
*!*							INTEGER cdisconnect

*!*						smtpServer	= allt(__email_smtp)
*!*						emailFrom	= allt(__company_name)
*!*						subject		= "RMS6 Error"


*!*						IF TYPE("error_code") = "N"
*!*							lmessage	= "Code : " + ALLTRIM(STR(error_code)) + chr(10)
*!*						ELSE
*!*							lmessage	= "Code : " + ALLTRIM(error_code) + chr(10)
*!*						ENDIF
*!*
*!*						lmessage	= lmessage + "Msg : " + error_msg + chr(10)
*!*						lmessage	= lmessage + "Prog : " + error_prog + chr(10)
*!*						lmessage	= lmessage + "Line : " + ALLTRIM(STR(error_line)) + chr(10)
*!*						lmessage	= lmessage + "User : " + _login_user_name + chr(10)
*!*						lmessage	= lmessage + "Station : " + _station + chr(10)
*!*						lmessage	= lmessage + "Date : " + TTOC(DATETIME())

*!*						emailTo 	= __email_proan
*!*						lattach 	= ""
*!*
*!*						lcode = RESendMail(smtpServer, emailFrom, emailTo, subject, lmessage, lattach, 0, 0)
*!*						CLEAR DLLS re_mail
*!*					ENDIF
*!*	 			ENDIF
*!*			ENDIF
*!*		ENDIF
*!*	ENDIF


If Vartype(_android_station)="U"  And ( no_show=.F.   Or __debug_mode )		&&¦pªG android¦øªA¾¹®É¡A¤£¼uµ¡¤f

	IF Vartype(frm_wait) <> "U"
		frm_wait.Hide
	ENDIF 
	Do Form Form\error_show With ctitle,error_code,error_msg,error_prog,Alltrim(Str(error_line))

Endif



Return

Endfunc


*--------------		&&¨t²Î¾Þ§@°O¿ý
Function write_log
Lparameters pid,cAction		&&pcode ¥i¥H¬O½sµ{¥N½X,¤]¥i¥H¬OID,cAction ¬O

If Parameters()=0 OR nhand<=0
	Return
Endif

Local _id,_action,_version
If Vartype(cAction)#"C"
	_action=""
Else
	_action=Trim(cAction)
Endif

_id=pid
If Vartype(pid)="C"
	Select Id From message_log_tmp Where pcode=_id Into Cursor log_tmp
	If _Tally=0
		Select log_tmp
		Use
		Return
	Endif
	_id=log_tmp.Id
	
	USE IN log_tmp
	
Endif

If Vartype(_android_station)="C"

	_station=_android_station

Else

	_station=getcomputername()


Endif


If GL_DEMO
	ssql="insert into sys_log values (0, ?_station,?_login_user_name,now(),?_id,?_action)"
	c=SQLExec(nhand,ssql)		&&¼g¤J¾Þ§@¤é»x,¤£½×¬O§_¼g¤J¦¨¥\
	If c < 0
		Set Step On
	Endif

Else


	_version=Iif(Vartype(__exe_version)="U","",__exe_version)

	If Vartype(_android_station)="C"

		ssql="insert into sys_log (station,adduser,datetime,log_id,action,auth_by,auth_what,station_time) values (?_station,?_login_user_name,getdate(),?_id,?_action,'android',?_version,?DATETIME())"

	Else

		ssql="insert into sys_log (station,adduser,datetime,log_id,action,station_time) values (?_station,?_login_user_name,getdate(),?_id,?_action,?DATETIME())"


	Endif

	If SQLExec(nhand,ssql)<0		&&¼g¤J¾Þ§@¤é»x,¤£½×¬O§_¼g¤J¦¨¥\
		Aerror(err)

		If __debug_mode

			Messagebox("error:"+err(2))


		Endif


	Endif

Endif

Return

Endfunc



*************************
*
*ÀË¬d¥I´Ú¤è¦¡ªºicon¬O§_¦s¦b©ó¥»¦a
**************************
Function check_payway_pic

If !Directory("ico")

	Md ico
Endif


ssql="select id,file_exp from payway where active=1 and dispwithpic=1"


If SQLExec(nhand,ssql,"cun_tmp")<0
	Return
Endif

If !Eof("cun_tmp")
	Select cun_tmp
	Scan
		_id=Id
		_file="ico\payway"+Alltrim(Str(_id))+"."+Trim(cun_tmp.file_exp)
		If !File("&_file")
			ssql="select image from payway where id=?_Id"
			If SQLExec(nhand,ssql,"cun_tmp1")<0
				Return
			Endif
			Select cun_tmp1
			If !Eof()
				_str=Strconv(cun_tmp1.Image,14)
				If !Empty(_str)
					Strtofile(_str,_file)
				Endif

			Endif

		Endif

	Endscan

Endif

Endfunc


*=============================================================================
* File Name     : f0Time.prg
* Function Name : f0stot1()
*=============================================================================
*-- Convert the time to minutes (34 > "00:00:34" , 94 > "00:01:34" )
Function f0stot1
Lparameter lcSecond, llShowDay
If Parameter() < 2
	llShowDay	= .T.
Endif

Local lnDay, lnHour, lnMinu, lnSec, lcReturn
lnDay  = 0
lnHour = 0
lnMinu = 0
lnSec  = lcSecond
If lnSec => 60
	lnMinu	= Floor(lnSec / 60)
	lnSec	= Mod(lnSec, 60)
Endif
If lnMinu => 60
	lnHour	= Floor(lnMinu / 60)
	lnMinu	= Mod(lnMinu, 60)
Endif
If llShowDay
	If lnHour => 24
		lnDay   = Floor(lnHour / 24)
		lnHour  = Mod(lnHour, 24)
	Endif
Endif

lcDay  = Alltrim(Str(lnDay))
*lcHour = right("00" + alltrim(str(lnHour)), 2)
lcHour = Alltrim(Str(lnHour))
lcMinu = Right("00" + Alltrim(Str(lnMinu)), 2)			&& lnMinu + 1
lcSec  = Right("00" + Alltrim(Str(lnSec)), 2)

If llShowDay
	lcReturn = lcDay + "¤é " + lcHour + ":" + lcMinu + ":" + lcSec
Else
	lcReturn = lcHour + "H " + lcMinu + "M"
Endif
Return lcReturn

*****************************************

Function check_bomb		&&®É¶¡¬µ¼uÀË¬d

If __debug_mode
	Return
Endif



*!*	If __bombpromptday>=9999 Or Empty(__bombstartdate)

*!*		Return
*!*	ENDIF



Local _passday
_less_day=__bombstartdate+__bombpromptday-getbelongdate()
If _less_day<0
	fmessagebox("_user_date_out")
	Clear Events
	Quit

Endif

_passday=getbelongdate()-__bombstartdate

If _passday>=0 And _passday<=__bombpromptday

	_end_date=Dtoc(__bombstartdate+__bombpromptday)

	_mess=getmessage("_to")+_end_date+getmessage("_user_date_end1")+Alltrim(Str(_less_day))+getmessage("_user_date_end2")
	fmessagebox(_mess)

	Return
Endif

Return

Endfunc


Function f0ttom
Lparameter lcTime
Return Val(Left(lcTime, 2))*60 + Val(Right(lcTime, 2))


*******************
*  && ³s±µSQL SERVER
* ¥²¶·«Oµý sysinfo.dat¤å¥ó¦s¦b(¥Î±M¥Îµ{§Ç¼g¤J,¥[±K«O¦s¬ÛÃösql serverªº¦WºÙ¤Î¨ã¦³ºÞ²zµn¤JÅv­­ªº¤á¦W¤Î±K½X)
*
*	ªð¥[  handle ªí¦¨³s±µ¦¨¥\¡A-1¬°¥¢±Ñ
********************
Function connect_sql
Lparameters  link_to_backserver,lcFile
Local cfile

If link_to_backserver
	cfile="linkserver.dat"

Else

	If Vartype(lcFile)="C"

		cfile=lcFile

	Else


		cfile="sysinfo.dat"

	Endif

Endif

If !File("&cfile")
	=Messagebox("system data file not found!",48,"")
	Return -1
Endif

Local cstr,nhandle,ms, lnServer
cstr=Filetostr("&cfile")
cstr=crstr(cstr,"RMS6")		&&unpack

Dimension ms(1)
getmstring(cstr,@ms,"@")

lnServer = __nServer
IF VARTYPE(_nServer_hq_or_mem)="N"
	lnServer = _nServer_hq_or_mem
ENDIF 
*cstr=Trim(ms(__nServer))
cstr=Trim(ms(lnServer))

getmstring(cstr,@ms,";")
If Alen(ms)<6
	Return -1
Endif


_db_name = Trim(ms(6))

csql="driver=sql server;server="+Trim(ms(3))+";uid="+Trim(ms(4))+";pwd="+Trim(ms(5))+";database="+Trim(ms(6))
IF FILE("lihong.txt")
	csql="driver={ODBC Driver 11 for SQL Server};server="+Trim(ms(3))+";uid="+Trim(ms(4))+";pwd="+Trim(ms(5))+";database="+Trim(ms(6))
ENDIF 

=SQLSetprop(0,"displogin",3)  &&do not display error warning

nhandle=Sqlstringconnect(csql)

*Wait Clea
If nhandle<0
*	=Messagebox("server connected  error!",48,"")
	Return -1
Endif
=SQLSetprop(nhandle,"displogin",3)

=SQLExec(nhandle,"set ANSI_WARNINGS  OFF")


Public __dbname
__dbname=_db_name

GL_training=(Val(ms(2))>0)		&&¬O§_°V½m¼Ò¦¡

Return nhandle


Endfunc

*********************
*	¨úªA°È¾¹®É¶¡
*
*******************
Function getservertime
If SQLExec(nhand,"select getdate() as servertime" ,"time_tmp")<0
	Return Datetime()
Endif
Local  _server_time
_server_time=time_tmp.servertime
Select time_tmp
Use
Return _server_time
Endfunc





*****************************************************
*	³]¸m¥»¾÷®É¶¡»PªA°È¾¹®É¶¡¦P¨B
*
****************************************************

Function  syncservertime


If Vartype(__sync_server_time) = "U"  Or  __sync_server_time = .F.
	Return
Endif


Local xdatetime, nYear, nMonth, nDay, nHour, nMinute, nSeconds,xtimezone
xtimezone=8	 			&& gn_timezone 8 for hk

If Vartype(__time_zone) # "U"
	xtimezone = __time_zone
Endif

If SQLExec(nhand,  "select getdate() as ttime" , "cur_tmp_time") > 0

	Select cur_tmp_time
	Go Top
	Store ttime To xdatetime
	Use In cur_tmp_time

	xdatetime = xdatetime - 3600 * xtimezone

	Declare SetSystemTime In kernel32 String @ lpSystemTime

	nYear = Year(xdatetime)
	nMonth = Month(xdatetime)
	nDay = Day(xdatetime)
	nHour = Hour(xdatetime)
	nMinute = Minute(xdatetime)
	nSeconds = Sec(xdatetime)

	cSystemTime = num2word(nYear) + ;
		num2word(nMonth) + ;
		num2word(0) + ;
		num2word(nDay) + ;
		num2word(nHour) + ;
		num2word(nMinute) + ;
		num2word(nSeconds) + ;
		num2word(0)

	SetSystemTime(cSystemTime)
	Clear Dlls SetSystemTime
Endif
Return


Endfunc



***********************************************************
Function num2word (lnValue)
Return Chr(Mod(m.lnValue,256)) + Chr(Int(m.lnValue/256))
Endfunc


*************************
* getbelongdate
*
**************************
Function getbelongdate 
LPARAMETERS ltdatetime &&Lihong 2021.12.22 ¯ùªã
Local csql

IF VARTYPE(ltdatetime) # "T"
	If GL_DEMO
		csql="select now() as _datetime"
	Else
		csql="select getdate() as _datetime"
	Endif
	If SQLExec(nhand,csql,"belongdate_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return Date()
	Endif
ENDIF 

csql="select s_from from system_Period where id=1"
If SQLExec(nhand,csql,"belongdate_tmp1")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	IF VARTYPE(ltdatetime) # "T"
		Return Date()
	ELSE
		RETURN TTOD(ltdatetime)
	ENDIF 
Endif

Local _curdatetime,_belongdate

IF VARTYPE(ltdatetime) # "T"
	*_curdatetime=Time(belongdate_tmp._Datetime)
	_curdatetime=Ttoc(belongdate_tmp._Datetime,2)
ELSE
	_curdatetime=Ttoc(ltdatetime, 2)
ENDIF 

_starttime=belongdate_tmp1.s_from
IF VARTYPE(ltdatetime) # "T"
	_belongdate=Iif(_curdatetime>=_starttime,Ttod(belongdate_tmp._Datetime),Ttod(belongdate_tmp._Datetime)-1)
ELSE
	_belongdate=Iif(_curdatetime>=_starttime,Ttod(ltdatetime),Ttod(ltdatetime)-1)
ENDIF 

*_belongdate=Iif(Val(Time(belongdate_tmp._Datetime))>=Val(belongdate_tmp1.s_from),Ttod(belongdate_tmp._Datetime),Ttod(belongdate_tmp._Datetime)-1)

IF VARTYPE(ltdatetime) # "T"
	Select belongdate_tmp
	USE
ENDIF 
Select belongdate_tmp1
Use

If Vartype(_belongdate)#"D"
	IF VARTYPE(ltdatetime) # "T"
		Return Date()
	ELSE 
		RETURN TTOD(ltdatetime)
	ENDIF 
Endif


Return _belongdate

Endfunc


**********************
Function beep  &&¹q¸£³â¥zµoÁn

*!*	IF  VARTYPE(__beep)#"U" AND __beep = .F.

*!*		RETURN 
*!*	ENDIF

Declare Integer Beep In kernel32 Integer dwFreq, Integer dwDuration
beep(2500,200)   &&ÀW²v¡A®É¶¡(²@¬í)


Clear Dlls 'Beep'

Return

Endfunc



*******************

*§ï¶iªº MESSAGEBOX
Function fmessagebox

Lparameters cCode, nCmdType, cFormCaption    &&cCode ¬°½s½sµ{¥N½X¡A¦p§ä¤£¨ì¡AÅã¥Ü¸Ó¥N½X
Local _code
_code=Lower(cCode)
IF used("message_tmp")

	Select  *  From message_tmp Where m_code==_code Into Cursor mess_tmp
	Select * From message_tmp Where  m_code='_ok'  Or m_code='_cancel'  Or m_code='_retry'  Or m_code='_ignore'  Or m_code='_yes'  Or m_code='_no' Into Cursor mess_tmp1
	Select mess_tmp
	If  Eof()
		If __debug_mode And Left(_code,1)="_"

			_m_code=_code
			_mess_cn=""
			_mess_en=""

			Do Form Form\mess_fly_edit With _m_code,_mess_cn,_mess_en

			If !Empty(_mess_cn) And !Empty(_mess_en)
				Local csql
				=SQLExec(nhand, "select MAX(id) as maxid from message","cr9")

				If Isnull(cr9.maxid)
					_id = 1
				Else
					_id = cr9.maxid + 1
				Endif
				Use In cr9

				csql="insert into MESSAGE (id, m_code,message_cn,message_en) values (?_id, ?_m_code,?_mess_cn,?_mess_en)"
				If SQLExec(nhand,csql)<0
					Aerror(err)

					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return _code

				Endif

				Use In message_tmp

				If	SQLExec(nhand,"select * from message","message_tmp")<0
					Return _code
				Endif

				cMessage=Iif(_system_langue="CN",Trim(_mess_cn),Trim(_mess_en))
			Else
				&&Lihong 2021.01.19Return _code
				cMessage=_code&&	¦pªG¨S§ä¨ì,Åã¥Ücode
			Endif

		Else

			cMessage=_code&&	¦pªG¨S§ä¨ì,Åã¥Ücode
		Endif

	Else
		_public_message_id = mess_tmp.Id
		cMessage=Iif(_system_langue="CN",Trim(message_cn),Trim(message_en))
	Endif

ELSE
	
	cMessage="cCode"
	

ENDIF

beep()
Local nRetVal
Do Case
	Case Pcount() = 1
		Do Form Form\Messagebox With cMessage To nRetVal
	Case Pcount() = 2
		Do Form Form\Messagebox With cMessage,nCmdType To nRetVal
	Case Pcount() = 3
		Do Form Form\Messagebox With cMessage,nCmdType, cFormCaption To nRetVal
Endcase

If Used("mess_tmp")
	Select mess_tmp
	Use
Endif
If Used("mess_tmp1")
	Select mess_tmp1
	Use
Endif



Return (nRetVal)

Endfunc


********************
*  getmessage   ¥Î©ó¨ú«ü©w½sµ{¥N½Xªº¤¤/­^¤å«H®§
*
*****************
Function getmessage

Lparameters cCode,cLan

If Vartype(cCode)<>"C"
	Return ""
Endif

Private  clangue
If Vartype(cLan)<>"C"
	clangue=_system_langue		&&¦pªG¤£«ü©w»y¨¥,«h¥Î·í«e¨t²Î»y¨¥
Else
	clangue=Upper(cLan)
Endif

Local _code
_code=Lower(cCode)

If !Used("message_tmp")
	Return cCode

Endif

&&Lihong 2021.01.22
LOCAL lc_original_alias
lc_original_alias = ALIAS()

If  Used("message_gb_tmp") And _gbk_langue		&&2009.02.23  update for GBK langue

	Select  message_cn,message_en  From message_gb_tmp Where m_code==_code Into Cursor mess_tmp

Else

	Select  message_cn,message_en  From message_tmp Where m_code==_code Into Cursor mess_tmp

Endif


If  _Tally=0

	If __debug_mode

		_m_code=_code
		_mess_cn=""
		_mess_en=""

		Do Form Form\mess_fly_edit With _m_code,_mess_cn,_mess_en

		If !Empty(_m_code)
			Local csql
			TEXT TO csql noshow
				DECLARE @max_id int
				DECLARE @updateno int
				SELECT @max_id=ISNULL(MAX(id),0)+1 FROM message
				SELECT @updateno=ISNULL(MAX(updateno),0)+1 FROM message


				insert into MESSAGE(id,m_code,message_cn,message_en,updateno) values (@max_id,?_m_code,?_mess_cn,?_mess_en,@updateno)

			ENDTEXT


			If SQLExec(nhand,csql)<0
				Aerror(err)

				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				&&Lihong 2021.01.22
				IF !EMPTY(lc_original_alias) AND USED(lc_original_alias)
					SELECT (lc_original_alias)
				ENDIF 

				Return _code

			Endif

			Use In message_tmp
			If	SQLExec(nhand,"select * from message","message_tmp")<0
				&&Lihong 2021.01.22
				IF !EMPTY(lc_original_alias) AND USED(lc_original_alias)
					SELECT (lc_original_alias)
				ENDIF 

				Return _code

			Endif

			cMessage=Iif(clangue="EN",Trim(_mess_en),Trim(_mess_cn))
		Else
			&&Lihong 2021.01.22
			IF !EMPTY(lc_original_alias) AND USED(lc_original_alias)
				SELECT (lc_original_alias)
			ENDIF 

			Return _code

		Endif
	Else

		cMessage=_code&&	¦pªG¨S§ä¨ì,Åã¥Ücode
	Endif

Else

	cMessage=Iif(clangue="EN",Trim(message_en),Trim(message_cn))

Endif
If Used("mess_tmp")
	Select mess_tmp
	Use
Endif

&&Lihong 2021.01.22
IF !EMPTY(lc_original_alias) AND USED(lc_original_alias)
	SELECT (lc_original_alias)
ENDIF 

Return cMessage


Endfunc


**********************
*	getMstring	¥Î©ó±q¥H³r¸¹¤À¹jªº¦r²Å¦ê¤¤¨ú¥X¿W¥ß¦r²Å¡A«O¦s¨ì¼Æ²Õ
*	¦r²Å¦ê®æ¦¡¡G 1,2,3,100,..	ª`·N¡A¶·¥H³r¸¹µ²§ô¡A§_«h³Ì«á¤@­Ó¤£·|ÃÑ§O
*
*	½Õ¥Î¤èªk¡G getMstring(cstring,@s_array)	cstring¬°¥¼¤À¸Ñªº¦r²Å¦ê
*											s_array¬°«O¦s¤À¸Ñ«á¦r²Åªº¼Æ²Õ¡A¶·¥ý©w¸q¼Æ²Õ©ÎÅÜ¶q
*
*	¦p¡G
*	dime s(1)  ©Îs=1 ©Î s=""
*	getmstring("1,2,3,4,",@s)  ·|¥Í¦¨ s(1)=1 s(2)=2  s(3)=3 s(4)=4
*
***************

Function getmstring

Parameters cstring,s_array,cmark

Private   gn,_pos,s_array,ii

If Isnull(cstring)
	cstring=""
Endif

Local _mark
_mark=Iif(Vartype(cmark)="C",Trim(cmark),",")

gn=Occurs(_mark,cstring)
If gn=0
	Dimension s_array(1)
	s_array(1)=""
	Return @s_array

Endif

Dimension s_array(gn)"  &&©w¸q¼Æ²Õ


_pos=1

For ii=1 To gn   &&¤À¸Ñ

	s_array(ii)=Substr(cstring,_pos,At(_mark,cstring,ii)-_pos)
	_pos=At(_mark,cstring,ii)+1

Endfor



Return	@s_array  &&ªð¦^¼Æ²Õ

Endfunc

***************************
* update_system_setting
* §ó·s¨t²Î³]©w
*	¦¨¥\ªð¥[ 1,¥¢±Ñªð¦^ -1
*
*	¥u·|§ó·sµn¤Jªºstationªºsetting
**************************
Function update_system_setting

Parameters _computer		&&¥i«ü©w¤u§@¯¸ÂI,¦p¥¼«ü©w,¨ú¥»¾÷¦WºÙ

*SET STEP ON

UPDATE_holiday()

If Vartype(_computer)<>'C'
	_computer=getcomputername()&&¨ú¥»¾÷¹q¸£¦WºÙ
Endif
Local ssql

&&§R°£±ó¥Îªº¶µ¥Ø
=SQLEXEC(nhand,"alter table system_setting drop column pid")

ssql="delete from system_setting where station_id>0 and pcode not in (select pcode from system_setting where station_id=0)"
=SQLExec(nhand,ssql)

=SQLExec(nhand,"DELETE  from system_setting where station_id >0 and  station_id not in (select id from station)")

=SQLExec(nhand,"update  system_setting set cvalue=default_value where cvalue is null")

If SQLExec(nhand,"select id from station where computer=?_computer","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return


Endif


Select cun_tmp
Scan

	sid=cun_tmp.Id

	TEXT TO ssql noshow

	select pcode from system_setting where active=1 and applyall=0 and station_id=0
		and pcode not in (select pcode from system_setting where station_id=?sid)

	ENDTEXT

	If SQLExec(nhand,ssql,"cun_tmp2")<0

		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

	If !Eof("cun_tmp2")

		Select cun_tmp2
		Scan

			_pcode=Trim(cun_tmp2.pcode)

			_updateno=getupdateno("system_setting")

			If _updateno<0

				Return -1
			Endif


			TEXT TO ssql noshow

			insert into system_setting (active,id,uid,desccn,descen,pcode,type,cvalue,default_value,clistcn,clisten,clist_value,nvaluemax,nvaluemin,intvalue,dispord,show,station_id,forprint,applyall,password,updateno) 
			select active,id,uid,desccn,descen,pcode,type,cvalue,default_value,clistcn,
				clisten,clist_value,nvaluemax,nvaluemin,intvalue,dispord,show,?sid,forprint,0,password,?_updateno
				from system_setting where pcode=?_pcode and station_id=0


			ENDTEXT

			If SQLExec(nhand,ssql)<0

				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return  -1


			Endif

		Endscan




	Endif


Endscan




If Used("cun_tmp1")
	Select cun_tmp1
	Use
Endif
If Used("cun_tmp2")
	Select cun_tmp2
	Use
Endif


Return 1

Endfunc

*********************
* FUNCTION getcomputername
*	¨ú¹q¸£ªº¦WºÙ
*
********************
Function getcomputername
*!*		LOCAL objWMIService,colSettings
*!*		objWMIService = GetObject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
*!*		colSettings = objWMIService.ExecQuery ("Select * from Win32_ComputerSystem")
*!*		For Each objComputer in colSettings
*!*		  RETURN objComputer.Name
*!*		NEXT
*!*		RETURN ""
Return Alltrim(Substr(Sys(0), 1, At("#" , Sys(0)) - 1))
Endfunc



*----------------------------------------------------------------


Function Get_table_updateno

Lparameters cTableName


If Vartype(cTableName)="C"

	ssql="select * from updateno where table_name=?cTableName"
Else

	Release mytable

	ssql="select * from updateno order by table_name"

Endif


If SQLExec(nhand,ssql,"updateno_tmp")<0

	Return -1		&&ªð¦^  -1ªí¥Ü»Ý­n§ó·s

Endif

Local lcName,LL_update



If Vartype(mytable)#"O"

	Public mytable
	mytable=Createobject("empty")


Endif




Select updateno_tmp
Scan

	lcName=Allt(updateno_tmp.table_name)


	If Vartype(mytable.&lcName)="U"

		AddProperty(mytable,lcName,updateno_tmp.max_updateno)
		mytable.&lcName=0	&&updateno_tmp.max_updateno		&& °O¿ý³Ì·sªºupdateno

	Else

		If 	mytable.&lcName=updateno_tmp.max_updateno		&&¦pªGupdateno¬Û¦P¡Aªí¥Ü¤£»Ý­n§ó·s

			Return 1		&&ªð¦^  1 ªí¥Ü¤£»Ý­n§ó·s

		Else

			mytable.&lcName=updateno_tmp.max_updateno		&& °O¿ý³Ì·sªºupdateno

			Return -1


		Endif


	Endif


Endscan


Return -1		&&ªð¦^  -1ªí¥Ü»Ý­n§ó·s


Endfunc


*--------------------------------------

Function  IK0Q492H88CDXP

Lparameters lReload,cStation
**¦pªG¤£»Ý­n§ó·s¡A¤£¸ü¤J

If Vartype(__company_name)#"U"	And lReload=.F.	 AND rms_express=.F. AND rms_report=.f.&&¦pªG²Ä¤@¦¸¡A¤£¶i¦æÀË´ú

	If Get_table_updateno("system_setting")>0

		Return 1

	Endif

Endif

Local _computer

If Vartype(cStation)="C"

	_computer=cStation

Else

	_computer=getcomputername()&&¨ú¥»¾÷¹q¸£¦WºÙ

Endif

If Empty(_computer)
	Return -1
Endif

Local ssql

If SQLExec(nhand,"select id from station where computer=?_computer","cun_tmp")<0

	Return -1


Endif

If Eof("cun_tmp")

	If __admin__user=.T.


		If create_new_station()	<0


			Return -1
		Endif


		update_system_setting(_computer)


	Else



		Return  -1

	Endif




Endif



If rms_report

	ssql="select * from system_setting where active=1 and station_id=0 and applyall=1"	&& report mode


Else

	ssql="select * from system_setting where active=1 and station_id in (select id from station where computer=?_computer) or (station_id=0 and applyall=1)"	&&«ö¹q¸£¦WºÙ¸ü¤J¨t²Î³]©w

Endif



If SQLExec(nhand,ssql,"cun_tmp")<0

	Return -1
Endif
Private _pcode
Select cun_tmp
If Eof()



	Return -1	&&¹q¸£¦WºÙ¨S¦³°O¿ý


Endif



Select cun_tmp
Scan

	_pcode=Trim(cun_tmp.pcode)
	If !Empty(_pcode)
		Public &_pcode
		Do Case

			Case cun_tmp.Type=1	&& Y/N
				&_pcode=Iif( Trim(cun_tmp.cvalue)="1",.T.,.F.)

			Case cun_tmp.Type=2	&&	¼Æ­È
				&_pcode=Iif(cun_tmp.intvalue,Int(Val(cun_tmp.cvalue)),Val(cun_tmp.cvalue))

			Case cun_tmp.Type=6	&&	color
				&_pcode=Val(cun_tmp.cvalue)

			Case cun_tmp.Type=7	&&	date
				&_pcode=Ctod(cun_tmp.cvalue)

			Otherwise
				&_pcode=Trim(cun_tmp.cvalue)



		Endcase

	Endif

Endscan

Public __local_printer		&&¥»¦a¥´¦L¾÷

__local_printer=""

TEXT TO ssql noshow

	if  exists (select printer from printerset  where id=?__inv_Printer and station_id=(select id from station where computer=?_computer))
		select printer from printerset  where id=?__inv_Printer and station_id=(select id from station where computer=?_computer)
			ELSE select printer from printerset  where  station_id=(select id from station where computer=?_computer)

ENDTEXT

If SQLExec(nhand,ssql,"cun_tmp")<0
	Return -1
Endif

__local_printer=Trim(cun_tmp.Printer)


Return 1

Endfunc



**********************************************************************
Function check_for_update

*---------------------------------------------------------------------		&&¦Û°Ê¤É¯Å
*	¦Û°Ê¨ú±o·í«eµ{§Ç¦W,¦Û°ÊÀË´ú¬O§_¦³·sª©¥»,¦Û°Ê§ó·s
*
*---------------------------------------------------------------//--->

Delete File *.bat
Delete File  *.bak

_filename=Substr(Sys(16),Rat("\",Sys(16))+1,Rat(".",Sys(16))-Rat("\",Sys(16))-1)

If Agetfileversion(ver,_filename+".exe")<=0		&&¨ú±o·í«eªºª©¥»¸¹
	_version="000"
Else
	_version=ver(4)

Endif

_Screen.Tag=_version

&&¥Dµ{§Ç¦WºÙ
Local ssql
ssql="select version from system_file where filename=?_filename and version<>?_version"		&&§PÂ_¬O§_¦³·sª©¥»
If SQLExec(nhand,ssql,"cun_tmp")<0
	Messagebox("Unknow system error -1!")
	Quit

Endif

Select cun_tmp
If !Eof()	&&¦³·sªºª©¥»

	Wait "Downloading from server ,please wait ......" Windows At 15,50  Noclear Timeout 3

	ssql="select exefile from system_file where filename=?_filename"		&&¤U¸ü¼Æ¾Ú
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Messagebox("Unknow system error -2!")
		Quit

	Endif

	_FileStr = Strconv( cun_tmp.exefile,14 )
	_file  = Strtofile(_FileStr,"exe_new.exe")

	_exefile=_filename+".exe"

*------------------
	fn=Fcreate("up.bat")						&&«Ø¥ß¤@­Ó§å³B²z¤å¥ó
	Fputs(fn,"ping -n 3 127.0.0.1")				&&©µ®É3¬í,Åý¥Dµ{§Ç¦³®É¶¡°h¥X,¦pªG¦³°ÝÃD,¥i±N 3§ï¦Ü5©ÎªÌ§ó°ª
	Fputs(fn,"ren "+_exefile+" exe.bak")
	Fputs(fn,"ren exe_new.exe "+_exefile)
	Fputs(fn,"del exe.bak")
	Fputs(fn,"start "+_exefile)
	Fclose(fn)
*----------------

	Clear Dlls
	Run /N0 up.bat	&&¹B¦æ
	Quit


Endif

ENDFUNC

****************************
FUNCTION INV_APPLY_SRV

LPARAMETERS _outlet_id

IF VARTYPE(__inv_print_apply_srv)="U" OR __inv_print_apply_srv =.f.

	RETURN 

ENDIF

LOCAL _isholiday , _belongdate ,_srv_per ,_srv_id,ll_allow_service


_belongdate=getbelongdate()			&&¨ú·í«eªºbelongdate
Select Id From work_order_tmp14 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
_isholiday=(_Tally>0)


SELECT work_order_tmp9
LOCATE FOR id=_outlet_id

ll_allow_service= NVL(svccharge,.f.)

_srv_per=IIF(ll_allow_service, NVL(srvper,0) ,0)


LOCAL _curdatetime,_curtime,_curweekday,_curweekday,_day
			
_curdatetime=Datetime()								&&¨ú·í«e®É¶¡
_curtime=Time()
_curweekday=Dow(_curdatetime)
_curweekday=Iif(_curweekday=1,7,_curweekday-1)		&&Âà¬°"¤¤°ê¦¡"ªº¬P´Á­pºâ¤èªk,©P¤@¬°²Ä¤@¤Ñ)
_day="day"+Alltrim(Str(_curweekday))


If Vartype(__outlet_srv)#"U" And __outlet_srv=.F.  AND  ll_allow_service	&&¦pªGªA°È¶O¸ò°Ï°ì³]©w


	Select order_itemlist_tmp
	SCAN 


		Select srv_id From  work_order_tmp Where Id= order_itemlist_tmp.item_id Into Cursor cr_item_srv_tmp
		IF RECCOUNT("cr_item_srv_tmp")>0 &&Lihong 2022.09.27
			_srv_id=cr_item_srv_tmp.srv_id 
		ELSE 
			Select srv_id From  work_order_tmp0 Where Id= order_itemlist_tmp.item_id Into Cursor cr_item_srv_tmp
			_srv_id=cr_item_srv_tmp.srv_id 
		ENDIF 
		
		USE IN cr_item_srv_tmp

		If _srv_id>0

			&&Lihong 2022.03.23 ÂàªA°È¶O²v &&_sit_time ¨Ó¦Û work_table/work_order
			_srv_id = get_tran_srv_id(_srv_id, _outlet_id, order_itemlist_tmp.cate_id, _curdatetime, _sit_time)

			Select Id From work_order_tmp15 Where (_curtime>=s_from And _curtime<=s_to) Or (s_from>s_to And (_curtime>=s_from  Or  _curtime<=s_to)) Into Array tmp_s
			If _Tally>0

				_sid=tmp_s(1)

				Select * From work_order_tmp7 Where Id=_srv_id And ( &_day Or (_isholiday And holiday)) Into Cursor cun_tmp		&&®É¬qªA°È¶O
				If _Tally>0

					If _isholiday		&& ¥ýÀË´ú°²´Á

						If !Empty(cun_tmp.holiday_section)
							_section=Trim(Trim(cun_tmp.holiday_section),',')

							If !Empty(_section)

								If Inlist(_sid,&_section)
									_srv_per=cun_tmp.srvper
								Endif
							Endif

						Endif


					Else

						If &_day
							_day_section=_day+"_section"

							If !Empty(cun_tmp.&_day_section)
								_section=Trim(Trim(cun_tmp.&_day_section),',')
								If !Empty(_section)
									If Inlist(_sid,&_section)
										_srv_per=cun_tmp.srvper

									Endif
								Endif
							Endif

						Endif

					ENDIF
					
					
				Endif


			Endif
			
		
		 	ENDIF
		 	

		Endscan


	ELSE
		
		_srv_per=0


	Endif


	Update order_itemlist_tmp Set srv_per=_srv_per


Endfunc



***************************************************************************
* 	±N¸¨³æ«O¦s,¨Ã¦C¦Lµo²¼
*
*	function  save_to_inv

****************************************************************************
Function SAVE_TO_INV
Lparameters Norder_ID,Inv_langue,Nshare,_tableno,_fastfood,_inv_no,_direct_pay,_run_mode	&&norder_id ³æ¸¹	Nshare ¬°¤À³æ¼Æ (¦pªG¨S¦³¤À²£,«h¬°1), inv_langue µo²¼»y¨¥ CN ¤¤¤å EN ­^¤å

If Vartype(_android_station)="U"

	frm_wait.Show
	*Wait "" To N Timeout 0.01

Endif


&& _fastfood	¬O§_§ÖÀ\¼Ò¦¡	_Inv_no µo²¼¸¹(¦pªG¦L³æ«á¦AÂIµæ,¦A¦L³æ«h´£¨Ñ­ìµo²¼¸¹)
&&_subtable     ¬O§_¤ÀÂi
&&_direct_pay	ª½±µ¥I´Ú,¥u«O¦sµo²¼,¤£¦C¦L
&&_run_Mode  	¼Ò¦¡


If  SQLExec(nhand,"select id,descdisp from order_detail  where id =?Norder_ID and  price=0 and item_id in (select id from item where amtinv=1)","cun_tmp")<0

	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1


Endif

If !Eof("cun_tmp")

	Local cMess,cItem
	cMess =getmessage("_item_noprint_with_zero_price")
	cItem =""
	Select cun_tmp
	Scan

		cItem =cItem +Trim(cun_tmp.descdisp)+"/"
	Endscan

	cItem =Trim(cItem,"/")


	fmessagebox(cMess +Chr(13) + Chr(13) + cItem)

	Return -1

Endif




If Vartype(Nshare)#"N"
	Nshare=1
Endif

If Vartype(_inv_no)="C"

	_inv_no=Val(_inv_no)

Endif

If Vartype(_run_mode)<>"C"
	_run_mode="dine"
Endif

&&Lihong 2021.04.02 ­ì¬OµùÄÀ±¼ªº¡A²{¥´¶}¡A¦]¬°¤U­±¤£¬O¥þ³¡¤À¤ä©w¸q¤F¸ÓÅÜ¶q 
&&Lihong 2023.06.14 ²¾¨ì«á­± _isfastfood=(_fastfood and _run_mode="fastfood")		&&¬O§_§ÖÀ\ 

_link_table=""
*_sauna_remark=""

_same_table_count = .null. &&Lihong 2022.09.22

If LOWER(_run_mode)="dine" AND Vartype(_inv_chnage_mode)="U"	&&ÃöÁpÀ\Âi
	csql="select link_table,remark from tables where tableno=?_tableno"
	csql=csql+CHR(13)+"select tableno from same_table_detail where same_table_id in (select id from same_table where merge_to_tableno=?_tableno) " &&Lihong 2022.09.22

	If SQLExec(nhand,csql,"cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif
	_link_table=Trim(cun_tmp.link_table)
*	_sauna_remark = TRIM(NVL(cun_tmp.remark,""))
	Local ms
	Dimension ms(1)
	getmstring(_link_table,@ms)
	=Asort(ms)
	_link_table=""
	For i=1 To Alen(ms)
		_link_table=_link_table+ms(i)+","

	Endfor

	IF RECCOUNT("cun_tmp1")>0 
		_same_table_count = RECCOUNT("cun_tmp1")
	ENDIF 
	USE IN SELECT("cun_tmp1")
	*SELECT cun_tmp
Endif



Local _printer,_Pid,_station,_station_id


_printer=__sys_inv_printer


Local _table_no,_end_time,_paidtime,paidamt,_askno ,_inv_remark,_inv_remark2


_table_no=Iif(_run_mode="fastfood","",_tableno)


_begtime=Datetime()
_end_time=Datetime()
_paidtime=Ctod('1900-01-01')
_paidamt=0
_belongdate=''
_clnID=0
_clnTime=''
_tel=""
_askno=""
_inv_remark=""	&& 2013.12.18
_inv_remark2=""	&& 2013.12.19

_station_id=__station_id

_seller=""

Do Case

	Case _run_mode="barcode"  Or Vartype(_inv_chnage_mode)#"U"		&&±ø½X¼Ò¦¡	©Î§ó§ïµo²¼¤º®e¤è¦¡

		If SQLExec(nhand,"select outlet_id from order_main where barcode=1 and id=?Norder_ID","cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif
		If Eof("cun_tmp")
			_outlet_id=1
		Else
			_outlet_id=cun_tmp.outlet_Id
		Endif
		_table_name=""

	Case _run_mode="fastfood"		&&§ÖÀ\¼Ò¦¡

		If Vartype(_outlet_id)="U"

			_outlet_id=0

		Endif

		_table_name=""


	Otherwise 	&&°ó®y

		csql="select outlet_id,name,status from tables where tableno=?_tableno"
		If SQLExec(nhand,csql,"cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif
		_outlet_id=cun_tmp.outlet_Id
		_table_name=Trim(cun_tmp.Name)		&&À\Âi¦WºÙ
		_status_for_reprint_inv = TRIM(cun_tmp.status) 

		If Vartype(__input_inv_remark)#"U" And __input_inv_remark			&&¦pªG


			If _inv_no>0


				If SQLExec(nhand,"select inv_remark,inv_remark2 from inv where id=?_inv_no","cun_tmp")<0
					Aerror(err)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1


				Endif


				cinput =Trim(Nvl(cun_tmp.inv_remark,""))
				cinput2 =Trim(Nvl(cun_tmp.inv_remark2,""))


			Else

				cinput=""
				cinput2=""

			Endif


			ctitle = getmessage("_input") +" "+ getmessage("_inv_remark")
			
			
			frm_wait.hide

			Do Form Form\work_order_costom With cinput,.F.,.F.,100,ctitle,cinput2

			If !Empty(cinput)

				_inv_remark =cinput
				_inv_remark2 =cinput2

			Endif


		ENDIF
		
		*----------------------
		
		IF VARTYPE(__inv_commission)#"U" AND __inv_commission	 AND  _inv_no=0	&&¦pªG±Ò¥Î¦þª÷­pºâ¥\¯à
		
			
			DO FORM form\choose_seller TO _seller
			
		
		ENDIF

Endcase

&&Lihong 2020.01.17
LOCAL nSplitNo 
nSplitNo = 0

&&Lihong 2023.06.14 ²¾¨ì«á­±¦¹
_isfastfood=(_outlet_id=0 Or _run_mode="fastfood") &&(_fastfood and _run_mode="fastfood")		&&¬O§_§ÖÀ\ 

If _inv_no>0 And (Vartype(_order_change_and_resave_inv)="U"  Or Vartype(_inv_chnage_mode)#"U")

	&&Lihong 2020.01.17 _cloud_check_valid Split
	ssql = "select Split,begintime,tableno,askno,endtime,paidtime,invamt,belongdate,cln,clntime,TEL,outlet_Id,fastfood,seller,sn,cloud_check_valid,void,deposit_id,order_uid from inv  where id=?_inv_no"

	If SQLExec(nhand, ssql ,"cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	ENDIF
	&&Lihong 2022.10.13 
	IF NVL(cun_tmp.void, .F.) = .T.
		*RETURN _inv_no
	ENDIF 
	
	_end_time=cun_tmp.endtime
	_seller=NVL(cun_tmp.seller,"")
	
	nSplitNo = NVL(cun_tmp.Split,0)
	_cloud_check_valid = cun_tmp.cloud_check_valid

	If Vartype(_inv_chnage_mode)#"U"		&&§ó§ïµo²¼¤º®e
		_paidtime=cun_tmp.paidtime
		_paidamt=cun_tmp.invamt
		_belongdate=cun_tmp.belongdate
		_table_no=cun_tmp.tableno

		_clnID=cun_tmp.cln
		_clnTime=cun_tmp.clnTime
		_tel=Trim(cun_tmp.tel)
		_outlet_id=cun_tmp.outlet_Id
		_askno=Trim(cun_tmp.askno)
		_begtime=cun_tmp.begintime

		_isfastfood=cun_tmp.fastfood
		
		_auto_sn = NVL(cun_tmp.sn,0)

		&&Lihong 2022.11.18 ­qª÷
		*_deposit_id = NVL(cun_tmp.deposit_id,0)
		
		_order_uid = cun_tmp.order_uid 
		
		If !Empty(_askno)

			_table_info=_askno+Iif(!Empty(_table_name) And __inv_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)

		Endif


	Endif


ELSE

	&&Lihong 2020.01.17 _cloud_check_valid
	If _inv_no>0 
		ssql = "select top 1 Split,cloud_check_valid,void from inv with (nolock) where id=?_inv_no " + CHR(13) + " select newid() as check_valid" &&inv_view?
		If SQLExec(nhand, ssql ,"cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1
		ENDIF
		&&Lihong 2022.10.13 
		IF NVL(cun_tmp.void, .F.) = .T.
			*RETURN _inv_no
		ENDIF 

		nSplitNo = NVL(cun_tmp.Split,0)
		_cloud_check_valid = IIF(RECCOUNT("cun_tmp")=0,cun_tmp1.check_valid,cun_tmp.cloud_check_valid)
	ENDIF 
	&&
	
	_isfastfood=(_outlet_id=0 Or _run_mode="fastfood")		&&¬O§_§ÖÀ\

ENDIF

&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h cloud_plat
ssql="select distinct order_main.*,isnull(member.cardno,'') as member_id,isnull(member.name_cn,'') as member_name,member.id as memberID, member.cloud_plat from order_main "+;
	" left join member on order_main.memberno=member.id "+;
	" where  order_main.id=?Norder_ID"


If SQLExec(nhand,ssql,"cun_tmp2")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

ENDIF
*!*	xxx=memberno
*!*	xx2=member_id
*!*	xx3=memberID
*!*	SET STEP ON 

If Eof("cun_tmp2")

	_error_line=Lineno(1)
	_error_code="0"
	_error_msg="Data Error"
	_error_prog=Program()

	_ctitle=getmessage("_sqlserver_error")
	error_catch(_ctitle,_error_code,_error_msg,_error_prog,_error_line)

	Return -1
Endif

IF Vartype(_inv_chnage_mode)="U" OR VARTYPE(_order_uid)="U"
	_order_uid = cun_tmp2.order_uid
ENDIF 

IF Vartype(_inv_chnage_mode)="U" OR _inv_no=0

	_auto_sn = NVL(cun_tmp2.sn,0)
	&&Lihong 2022.11.18 ­qª÷
	*_deposit_id = NVL(cun_tmp2.deposit_id,0)

ENDIF



_inv_amt=cun_tmp2.invamt

If Empty(_tel)
	_tel=Nvl(cun_tmp2.tel,"")
Endif
If Empty(_askno)
	_askno=Trim(cun_tmp2.askno)
Endif

_clangue=Inv_langue(1)

If !Empty(_tel)


	_addr=getaddress(_tel)
	
	&&Lihong 2020.06.10
	IF VARTYPE(_vs_fastfood_info) = "C" 
		_addr = _addr +CHR(0) + _vs_fastfood_info
	ENDIF 
Else

	_addr=""

Endif
*!*	&&Lihong 2022.01.10 PSO_ORDER_SAVE_INV_ONLINE¤Wµæ¯È¥´¦L¹q¸Ü¦a§}¥~½æ¥I´Ú«H®§ «O¦s¨ìinv for ­«¥´
*!*	_PSO_ORDER_SAVE_INV_fastfood_info = ""
*!*	IF VARTYPE(_vs_fastfood_info) = "C" 
*!*		_PSO_ORDER_SAVE_INV_fastfood_info = _vs_fastfood_info
*!*	ENDIF 

*_addr=cun_tmp2.address


_pplcnt=cun_tmp2.pplcnt

If _pplcnt=0

	_pplcnt=1

Endif

_void_id=cun_tmp2.void_id		&&void_id   27/10/2007 add by david


_memberID=cun_tmp2.memberID		&&·|­û½s¸¹
_mem_remark=Trim(Nvl(cun_tmp2.remark,""))	&&³Æª`

_isForeign = Nvl(cun_tmp2.isForeign,.F.)		&& 2012.10.18

&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h
_cloud_plat=""
IF VARTYPE(__storellet)#"U" AND __storellet
	_cloud_plat="storellet"
	IF VARTYPE(__cloud_member)#"U" AND __cloud_member &&AND VARTYPE(__cloud_member_type)#"U" AND __cloud_member_type="white_warrior"
		_cloud_plat=TRIM(NVL(cun_tmp2.cloud_plat, ""))
	ENDIF 
ENDIF 

If Vartype(_inv_chnage_mode)="U"
	_begtime=cun_tmp2.begintime

Endif


Local _inv_points,_inv_points_used,_points_remain
_lms_member_name=""
_lms_member_number=""

_inv_points=Iif(Vartype(_inv_old_points)="N",_inv_old_points,0)		&&·|­û¿n¤À
_inv_points_used=Iif(Vartype(_inv_old_points_used)="N",_inv_old_points_used,0)

_points_remain=Iif(Vartype(_inv_old_points_remain)="N",_inv_old_points_remain,0)

&&Lihong 2020.01.17 §ï¬°¦¹³B
IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split)	&& ÀË¬d¬O§_¦³·|­ûself service   &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)


	 IF crm_check_self_service(_tableno,Norder_ID)<0
	 	
	 	frm_wait.Hide
	 	RETURN -1
	 	
	 ENDIF
ENDIF 

&&Lihong 2020.01.17 ¨Æ°È´£«e ¦]§Y®É¦©¿n¤À§ï¦Ç­ì¦ì¸m
*SQLSetprop(nhand,"Transactions",2)

_old_points = 0 
_old_points_used_pay = 0
_inv_points = 0
lledit_inv_body = .F.

llinv_points_extra_update = .F.  &&ÃB¥~¿n¤Àupdate inv by item
IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active

&&Lihong 2020.01.17 §ï¨ì¤W­±
*!*		 IF crm_check_self_service(_tableno,Norder_ID)<0
*!*		 	
*!*		 	frm_wait.Hide
*!*		 	RETURN -1
*!*		 	
*!*		 ENDIF
	 


ELSE

	
	&&Lihong 2020.01.17 ­ì¨Ó:Norder_ID>0 And _memberID>0 And  Vartype(_inv_chnage_mode)="U" And Vartype(__member_point_enabled)#"U" And __member_point_enabled 	
	If Norder_ID>0 And _memberID>0 And Vartype(__member_point_enabled)#"U" And __member_point_enabled 	&&Lihong 2020.01.17 ­ì¨Ó»¡©ú->:	&&·|­û¿n¤À(§ó§ïµo²¼¤£­pºâ¿n¤À)

		&&Lihong 2020.01.17
		IF Vartype(_inv_chnage_mode)#"U" AND VARTYPE(_inv_resave_mode)="U"		&&§ó§ïµo²¼¤º®e
		lledit_inv_body = .T.
		If SQLExec(nhand,"select belongdate,invamt,points,points_used from inv with (nolock) where id=?_inv_no","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			RETURN -1
		Endif
		_old_points=NVL(cun_tmp.points,0)
		_old_points_used = NVL(cun_tmp.points_used,0)
		_old_invamt = NVL(cun_tmp.invamt,0)
		_old_date = cun_tmp.belongdate
		
		IF SQLEXEC(nhand,"select SUM(amount) as amt from inv_detail with (nolock) where id=?_inv_no and item_id = -6","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			RETURN -1
		ENDIF
		_old_invamt = _old_invamt - NVL(cun_tmp.amt,0) &&ªþ¥[¶O
		IF SQLEXEC(nhand,"select SUM(points) as points from inv_detail with (nolock) where id=?_inv_no and pointed=1 ","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			RETURN -1
		ENDIF
		_old_points_used_pay = _old_points_used - NVL(cun_tmp.points,0)
		If SQLExec(nhand,"select SUM(isnull(points,0)) as points from inv_disc with (nolock) where id=?_inv_no ","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			RETURN -1
		Endif
		_old_points_used_pay = _old_points_used_pay - NVL(cun_tmp.points,0)
		
		*SELECT SUM(payamt) as amt  FROM payment_tmp WHERE pay_id = -4 INTO CURSOR cr_tmp
		*IF _tally>0
			&&Lihong 2020.01.17
			*_add_points = -1 * cr_tmp.amt		&& ¿n¤À·í¿ú¨Ï¡A´î
		*	_add_points = _add_points -1 * NVL(cr_tmp.amt, 0)		&& ¿n¤À·í¿ú¨Ï¡A´î
		*ENDIF
			
		If _old_points<>0 OR _old_points_used_pay<>0
			*¥»¦a§ó·s©ñ«á­±¨Æ°È¤¤
		ENDIF &&_old_points<>0 OR

			&&Lihong 2020.01.17 upload points to cloud  &&¥u§ó§ï«áªº¤W¶Ç¶³ &&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î °O¿ý­ì¿n¤À
			IF _old_points<>0 OR _old_points_used_pay<>0
			IF VARTYPE(__cloud_member)#"U" AND __cloud_member AND _memberID>0 And  Vartype(__member_point_enabled)#"U" And __member_point_enabled 
					*PUBLIC _inv_edit_old_points_to_cashier, _inv_edit_old_points_used_pay_to_cashier
					IF VARTYPE(_inv_edit_old_points_to_cashier)#"U" &&invinfo.scx§ïµo²¼©w¸q
						_inv_edit_old_points_to_cashier = _old_points
						_inv_edit_old_points_used_pay_to_cashier = _old_points_used_pay 
						_inv_edit_old_invamt = _old_invamt 
					ENDIF 
			ENDIF 
			ENDIF 
				
		ENDIF &&Vartype(_inv_chnage_mode)<>"U"
		&&
		
		&&Lihong 2020.01.17 ­ì¨Ó¤è¦¡¥[¤W§ó§ïµo²¼¤º®e
		IF Vartype(_inv_chnage_mode)="U" OR (Vartype(_inv_chnage_mode)#"U" AND VARTYPE(_inv_resave_mode)="U") 
		&&Lihong 2020.07.07 ÃB¥~¿n¤À
		LNorder_ID = Norder_ID 
		llinv_points_extra_update = .T. 

		_inv_points= check_member_point(_memberID,_inv_amt)
		
		If _inv_points<0
			frm_wait.Hide
			Return -1


		Endif


		If SQLExec(nhand,"select points from member where id=?_memberID","cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

		_points_remain=Iif(Isnull(cun_tmp.points),0,cun_tmp.points)		&&·|­û


		If SQLExec(nhand,"select SUM(points) as points from order_detail where id=?Norder_ID and pointed=1","cun_tmp")<0		&&ITEM¥Î¿n¤À

			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

		_inv_points_used=Iif(Isnull(cun_tmp.points),0,cun_tmp.points)

		If SQLExec(nhand,"select SUM(points) as points from order_disc where id=?Norder_ID","cun_tmp")<0		&&§é¦©¥Î¿n¤À

			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

		_inv_points_used=_inv_points_used+Iif(Isnull(cun_tmp.points),0,cun_tmp.points)


		_points_remain=_points_remain+_inv_points					&&·|­û¹ê»Ú©Ò§E¿n¤À

		ENDIF &&Vartype(_inv_chnage_mode)="U"
		
	ENDIF && Norder_ID>0

ENDIF

&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h ±Æ°£storellet³æ
*IF VARTYPE(__storellet)#"U" AND __storellet OR VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
IF _cloud_plat=="storellet" OR VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
ELSE 
	&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î ¥u»Ý¶Ç¿nªº¤À ¡G _points_used§ï¬°0 >0¦b«á­±cashier³B²z
	IF lledit_inv_body = .T. AND VARTYPE(__cloud_member_type)#"U" AND !__cloud_member_type=='proan'  &&§Y®É¤è¦¡¤~¤À¥¿­t &&§ó§ïµo²¼¤º®e
		_points = _inv_points - _old_points + _old_points_used_pay 
		IF _points<0 
		IF VARTYPE(__cloud_member)#"U" AND __cloud_member AND _memberID>0 And  Vartype(__member_point_enabled)#"U" And __member_point_enabled 
			errmsg_upload_points = ""
			IF upload_points("Del_cust_points_20210604", _inv_no, ABS(_points), 0, _old_date, _memberID,  _inv_amt - _old_invamt, 1)=.F. &&, lcaction, lninvid, lnpoints, lnpoints_used, _belongdate,_memberno, _invamt, lnredeem_cust_points
				frm_wait.Hide
				*fmessagebox(errmsg_upload_points) 
				IF EMPTY(errmsg_upload_points)
					errmsg_upload_points = "·|­û¿n¤À¤£¨¬¡I" + CHR(13) + "Edit Inv fail"
				ELSE
					errmsg_upload_points = errmsg_upload_points + CHR(13) + "Edit Inv fail"
				ENDIF 
				RETURN -1
			ENDIF 
		ENDIF 
		ENDIF 
	ENDIF 
ENDIF 

_is_edit  = VARTYPE(_inv_chnage_mode)#"U"

&&Lihong 2020.01.17 ¨Æ°È´£¨ì«e­± ¦]§Y®É¦©¿n¤À§ï¦Ç­ì¦ì¸m
SQLSetprop(nhand,"Transactions",2)

	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) 
	ELSE 
		&&Lihong 2020.01.17
		If _old_points<>0 OR _old_points_used_pay<>0
			If Vartype(__shop_id)#"U" And __shop_id>0
				If SQLExec(nhand,"select MAX(updateno) as updateno from member_log","cun_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					RETURN -1
				Endif
				_updateno=Nvl(cun_tmp.updateno,0)+1
				_uid=Val(Padl(__shop_id,3,"100")+Padl(_updateno,10,"0"))

				If SQLExec(nhand,"insert into member_log (id,inv_id,member_id,amount,times,point,updateno,datetime) values (?_uid,?_inv_no,?_memberID,-?_old_invamt,-1,?_old_points_used_pay-?_old_points,?_updateno,getdate())")<0 
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					RETURN -1
				Endif

				ssql="update member set amount=ISNULL(amount,0)-?_old_invamt,times=ISNULL(times,0)-1, points=ISNULL(points,0)-?_old_points+?_old_points_used_pay where id=?_memberID" 

			Else
				If SQLExec(nhand,"select MAX(updateno) as updateno from member","cun_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					RETURN -1
				Endif
				_updateno=Nvl(cun_tmp.updateno,0)+1

				ssql="update member set amount=ISNULL(amount,0)-?_old_invamt,times=ISNULL(times,0)-1,points=ISNULL(points,0)-?_old_points+?_old_points_used_pay,updateno=?_updateno where id=?_memberID"  

			Endif

			ssql=ssql+Chr(10)+"update updateno set max_updateno=ISNULL(max_updateno,0)+1 where table_name='member' "

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				RETURN -1
			ENDIF
				
		ENDIF &&_old_points<>0 OR
	ENDIF 

* ---  inv lock ----
IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
		
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

ENDIF


Local _id

IF VARTYPE(__cashier_user_id)="U"
	_inv_prt_time = .null.
	_inv_prt_station_id = .null.
	_inv_prt_login_user_id = .null.
	_inv_prt_cashier_user_id = .null.
	llhave_pay_cashier_user_id = .F.
ELSE 
	_inv_prt_time = DATETIME()
	_inv_prt_station_id = __station_id
	_inv_prt_login_user_id = __login_user_id
	_inv_prt_cashier_user_id = __cashier_user_id
	llhave_pay_cashier_user_id = .F.
ENDIF 

_void = 0 &&2022.10.13 Lihong

If _inv_no>0

	_id=_inv_no
	IF !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	ssql="if exists (select id from inv with (nolock) where id=?_id ) delete from inv where id=?_id " &&¥ý²M²z,¥H½T«O¤£·|­«´_¥Í¦¨
	ELSE
		ssql = ""
	ENDIF 
	ssql="select inv_prt_time,inv_prt_station_id,inv_prt_login_user_id,inv_prt_cashier_user_id,pay_station_id,pay_login_user_id,pay_cashier_user_id,same_table_count,void from inv with (nolock) where id=?_id" + CHR(13) + ssql

	If SQLExec(nhand, ssql, "cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	ENDIF
	&&2022.10.13 Lihong
	IF RECCOUNT("cun_tmp")>0 
		*_void = cun_tmp.void 
	ENDIF 
	
	IF Vartype(_inv_chnage_mode)#"U" AND RECCOUNT("cun_tmp")>0 
		IF ISNULL(_same_table_count)
			_same_table_count = cun_tmp.same_table_count 
		ENDIF 
		IF !ISNULL(cun_tmp.inv_prt_cashier_user_id) AND cun_tmp.inv_prt_cashier_user_id>0
			_inv_prt_time = cun_tmp.inv_prt_time
			_inv_prt_station_id = cun_tmp.inv_prt_station_id
			_inv_prt_login_user_id = cun_tmp.inv_prt_login_user_id
			_inv_prt_cashier_user_id = cun_tmp.inv_prt_cashier_user_id
		ENDIF 
		IF !ISNULL(cun_tmp.pay_cashier_user_id) AND cun_tmp.pay_cashier_user_id>0
			_pay_station_id = cun_tmp.pay_station_id
			_pay_login_user_id = cun_tmp.pay_login_user_id
			_pay_cashier_user_id = cun_tmp.pay_cashier_user_id
			llhave_pay_cashier_user_id = .T.
		ENDIF 
	ENDIF 

&&°O¿ý¬°°ÝÃDµo²¼

	ssql="if exists (select inv_id from inv_problem where inv_id=?_inv_no) update inv_problem set reprint_times=reprint_times+1 where inv_id=?_inv_no "+;
		"else insert into inv_problem (inv_id,reprint_times) values (?_inv_no,1)"

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif
Endif

Local _Info_id

IF _isfastfood AND Vartype(_fastfood_info_id)="U"		&&2017.05.26

		IF SQLEXEC(nhand,"select id from fastfood_info order by dispord","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		ENDIF
		
		_Info_id= cun_tmp.id
		
ELSE

	_Info_id=Iif(Vartype(_fastfood_info_id)="U",0,_fastfood_info_id)		&&2009.10.15  ADD

ENDIF


Local _member_id

_member_id=_memberID

If _memberID>0

*	_member_id=cun_tmp2.member_no



Else

	If SQLExec(nhand,"select member_name,member_number from order_disc where id=?Norder_ID and member_number<>'' ","cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	If !Eof("cun_tmp")

		_member_id=-3			&&¦pªG¦³·|­û§é¦©

		_lms_member_name=Alltrim(cun_tmp.member_name)
		_lms_member_number=Alltrim(cun_tmp.member_number)


	Endif


Endif


Local cTableName  &&Lihong 2020.01.17  nSplitNo ¤W²¾


*nSplitNo=0 &&Lihong 2020.01.17

cTableName="inv"

If Vartype(_inv_type)#"N"

	_inv_type=0

Endif

_liked=0

IF VARTYPE(__cust_liked)#"U" AND __cust_liked		&& 2016-06-10  add :  liked

	_liked=1

ENDIF



IF VARTYPE(_inv_only_preview)="U"

			For Ntry=1 To 100
				If _inv_no=0	&&¦pªG²Ä¤@¦¸¦L³æ,«hªö¥Î·sªºµo²¼¸¹

			*		ssql="select ISNULL(MAX(id),0)  as max_inv_id,ISNULL(MAX(id),0) as max_id from inv"


					TEXT TO ssql noshow														&& 2013.07.11
						IF NOT exists (select type from sys_options where type='inv_id'   )
						begin
						declare @nid int
						select @nid=max(id) from inv_view
						insert into sys_options (defavalue,type,active,disporder,update_date) values (@nid ,'inv_id',1,0,'1900-01-01')

						end

					ENDTEXT

					If SQLExec(nhand,ssql)<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						Return -1

					Endif

					TEXT TO ssql noshow
						IF  exists (select type from sys_options where type='inv_id' and defavalue<(select max(id) from inv   )  )
						update sys_options set defavalue=(select max(id) from inv) where type='inv_id'


					ENDTEXT

					If SQLExec(nhand,ssql)<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						Return -1

					Endif
					
					&&Lihong 2020.01.17 cloud_check_valid 
					ssql="select ISNULL(MAX(defavalue),0) as max_id, newid() AS cloud_check_valid from sys_options where  type='inv_id' "

					If SQLExec(nhand,ssql,"cun_tmp")<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						Return -1

					Endif

			*		_invID=cun_tmp.max_inv_id+1		&&¨ú±o³Ì¤jªºµo²¼¸¹

					_id=cun_tmp.max_id+1
					_invID=_id
					_cloud_check_valid = cun_tmp.cloud_check_valid

					If SQLExec(nhand,"update sys_options  set defavalue=?_id,update_date = getdate() where type='inv_id' ")<0		&&¥e¥Î¦¡¼g¤J

						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						Return -1


					Endif



					If Vartype(_inv_split_id)#"U"


						If 	_inv_split_id=0	&&¤À³æ¸¹

							ssql="select ISNULL(MAX(split),0) as max_split from inv "

							If SQLExec(nhand,ssql,"cun_tmp")<0
								Aerror(err)
								Sqlrollback(nhand)
								SQLSetprop(nhand,"Transactions" ,1)
								frm_wait.Hide
								error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
								Return -1

							Endif

							nSplitNo=cun_tmp.max_split+1

							_inv_split_id=nSplitNo

						Else
							nSplitNo=_inv_split_id

						Endif


					Endif





				Else
					_invID=_inv_no			&&§_«hªö¥Î­ìµo²¼¸¹(¦A¦¸¦L³æ)

				Endif



				ssql="select MAX(updateno) as max_updateno from  inv"					&&

			*	ssql="select ISNULL(MAX(updateno),0) as max_updateno from inv union all select ISNULL(MAX(updateno),0) as max_updateno from his_inv order by max_updateno desc"		&& 2010.09.24  his_inv


				If SQLExec(nhand,ssql,"cun_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif
				_updateno=cun_tmp.max_updateno+1
				
				_queue_type=0
				_is_web_inv = .F.
				
				IF _run_mode = "fastfood"  AND VARTYPE(__proan_web_order_call)#"U" AND __proan_web_order_call
					_check_valid =  FormatDatetime_second()  && RIGHT(SYS(2015),9)
				ELSE
					_check_valid = ""
				ENDIF
				
				IF VARTYPE(__pso_order)#"U"
					_is_web_inv = .T.
				
				ENDIF
				
*!*					IF !EMPTY(_sauna_remark)		&&°Í¸¹«O¦s¬°¥s¸¹
*!*					
*!*						_askno= _sauna_remark
*!*					
*!*					ENDIF
*!*					

				&&Lihong 2020.01.17 cloud_check_valid 
				lcpay_cashier_ins = ""
				lcpay_cashier_values = ""
				IF llhave_pay_cashier_user_id = .T.
					lcpay_cashier_ins = ",pay_station_id,pay_login_user_id,pay_cashier_user_id"
					lcpay_cashier_values = ",?_pay_station_id,?_pay_login_user_id,?_pay_cashier_user_id"
				ENDIF 
				IF !ISNULL(_cloud_check_valid) AND EMPTY(_cloud_check_valid)
					_cloud_check_valid = .null.
				ENDIF 
				TEXT TO ssql NOSHOW TEXTMERGE &&2022.10.13 Lihong void:0->?_void
				
					INSERT INTO inv  (id,tableno,askno,pplcnt,begintime,orgamt,amount,modiamt,itemdiscamt,srvamt,taxamt,rndamt,discamt,invamt,
					tips,paidamt,cashed,autocash,memberno,cln,clntime,void,voidreason,voidtime,paidtime,voiduser,xid,fastfood,adduser,station_id,outlet_id,
					tel,endtime,link_table,void_id,updateno,remark,belongdate,points,points_used,points_remain,fastfood_info_id,split,isForeign,inv_type ,inv_remark,inv_remark2,seller,liked,sn,is_edit,queue_type,check_valid,is_web_inv, cloud_check_valid,
					inv_prt_time, inv_prt_station_id, inv_prt_login_user_id, inv_prt_cashier_user_id <<lcpay_cashier_ins>>, deposit_id, inv_srv_type, inv_srv_perc, order_uid )
					values (?_id,?_table_no,?_askno,?_pplcnt,?_begtime,
					<<cun_Tmp2.orgamt>>,<<cun_Tmp2.amount>>,<<cun_Tmp2.modiamt>>,<<cun_Tmp2.itemdiscamt>>,<<cun_Tmp2.srvamt>>,<<cun_Tmp2.taxamt>>,<<cun_Tmp2.rndamt>>,<<cun_Tmp2.discamt>>,<<_inv_amt>>,
					0,0,0,0,?_member_id,?_clnID,?_clnTime,?_void,'','',?_paidtime,'',1,?_isfastfood,?_login_user_name,?_station_id,?_outlet_id,
					?_tel,?_end_time,?_link_table,?_void_id,?_updateno,?_mem_remark,?_belongdate,?_inv_points,?_inv_points_used,?_points_remain,?_info_id,?nSplitNo,?_isForeign,?_inv_type,?_inv_remark,
					?_inv_remark2 ,?_seller,?_liked,?_auto_sn,?_is_edit,?_queue_type,?_check_valid,?_is_web_inv, ?_cloud_check_valid,
					?_inv_prt_time, ?_inv_prt_station_id, ?_inv_prt_login_user_id, ?_inv_prt_cashier_user_id <<lcpay_cashier_values>>, ?cun_Tmp2.deposit_id, ?cun_Tmp2.inv_srv_type, ?cun_Tmp2.inv_srv_perc, ?_order_uid )

				ENDTEXT


				If !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) AND SQLExec(nhand,ssql)<0  &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)

					Aerror(err)
					Ntry=Ntry+1

				Else
					Exit

				Endif

			Endfor

			If Ntry>=100
			SET STEP ON 
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
				lcvs_so_add_order_split_filter = " and uid>?lnvs_so_add_pre_uid"
			ELSE 
				lcvs_so_add_order_split_filter = ""
				
				ssql=" if exists(select id from inv_detail where id=?_id ) delete from inv_detail where id=?_ID "
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				ENDIF
			ENDIF 
			
			&&Lihong 2020.06.01 coupon:cloud_coupon_id, web_coupon_id, web_coupon_code , or item_id= -51
			&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
			TEXT TO ssql TEXTMERGE NOSHOW &&Lihong 2020.04.20 -199 -106 ¦Ü -101 &&Lihong 2022.03.17 ¨Ò®uorgqty_case_mat
				insert into inv_detail (id,uid,parent_id,item_id,item_code,cate_id,descdisp,
				qty,price,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_per,srv_amount,tax_per,tax_amount,
				xdisc,sitem,sitem_sub,mitem,printed,printtime,adduser,level_id,recused,xid,level_disc,handwriting,material,onlysave,tax2,pointed,points,askdept,gift,giftred,transnumber,tel ,source, 
				cloud_coupon_id, web_coupon_id, web_coupon_code, print_single, orgqty_case_mat, same_tableno, price_type, qty_entity, add_user_id, add_user_station_id,srv_per_org,kit_disp_uid,to_printer ) 			
			SELECT ?_id,uid,parent_id,item_id,item_code,cate_id,descdisp,
				qty,price,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_per,srv_amount,tax_per,tax_amount,
				xdisc,sitem,sitem_sub,mitem,printed,printtime,adduser,level_id,recused,xid,level_disc,handwriting,material,onlysave,tax2,pointed,points,askdept,gift,giftred,transnumber,tel ,source, 
				cloud_coupon_id, web_coupon_id, web_coupon_code, print_single, orgqty_case_mat, same_tableno, price_type, qty_entity, add_user_id, add_user_station_id,srv_per_org,kit_disp_uid,to_printer  
				from  order_detail where id=?Norder_ID and (item_id>0 or item_id= -3 or item_id= -199 or item_id= -111 or item_id= -110 or item_id between -104 and -101 or item_id= -51 ) <<lcvs_so_add_order_split_filter>>
			
			ENDTEXT
			
			IF VARTYPE(llvs_so_add_order_split_have_sub)#"U" AND llvs_so_add_order_split_have_sub=.T.
				lcvs_so_add_split_ssql = STRTRAN(ssql, "?_id,", "?lnvs_so_add_split_inv_id,",1,1,1)
			ELSE
				lcvs_so_add_split_ssql = ""
			ENDIF 
			
			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
				ssql = ssql + CHR(13) + lcvs_so_add_split_ssql 
			ELSE 
				&&Lihong 2020.07.07 ÃB¥~¿n¤À
				IF llinv_points_extra_update = .T.
				TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW 

					UPDATE a SET a.pointrate=b.pointrate, a.pointfix=b.pointfix from inv_detail a LEFT JOIN item b ON a.item_id=b.id 
					where a.id=?_id and a.item_id>0 and ISNULL(a.sitem_sub,0)=0 and ISNULL(b.pointrate,0)+ISNULL(b.pointfix,0)>0 
				ENDTEXT  
				ENDIF 
			ENDIF 

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
				lcvs_so_add_order_split_filter = " and item_id>?lnvs_so_add_pre_uid"
			ELSE 
				lcvs_so_add_order_split_filter = ""
				
				ssql="if exists (select id from inv_modi where id=?_id) delete from inv_modi where id=?_ID"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				ENDIF
			ENDIF 
			
			TEXT TO ssql TEXTMERGE noshow
				insert into inv_modi (id,item_id,modi_id,modi_qty,def_id,modi_price,modi_per,descdisp,modi_amount,dispord,multqty,open_Modi)
					 SELECT ?_id,item_id,modi_id,modi_qty,def_id,modi_price,modi_per,descdisp,modi_amount,dispord,multqty,open_Modi from order_modi where id=?Norder_ID <<lcvs_so_add_order_split_filter>>
			ENDTEXT

			IF VARTYPE(llvs_so_add_order_split_have_sub)#"U" AND llvs_so_add_order_split_have_sub=.T.
				lcvs_so_add_split_ssql = STRTRAN(ssql, "?_id,", "?lnvs_so_add_split_inv_id,",1,1,1)
			ELSE
				lcvs_so_add_split_ssql = ""
			ENDIF 
			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
				ssql = ssql + CHR(13) + lcvs_so_add_split_ssql 
			ENDIF 
			
			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif


			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
			ELSE 
				ssql="if exists (select id from inv_itemdisc where id=?_id) delete from inv_itemdisc where id=?_ID"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				ENDIF
			
				&& item discount
				TEXT TO ssql NOSHOW &&Lihong 2020.06.02 coupon    coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code
					insert into inv_itemdisc (id,item_id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_remark,disc_qty,dedu_srv, cloud_coupon_id, web_coupon_id, web_coupon_code,after_inv)
						SELECT ?_id,item_id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_remark,disc_qty,dedu_srv, cloud_coupon_id, web_coupon_id, web_coupon_code,after_inv from order_itemdisc where id=?Norder_ID 
				ENDTEXT
				

				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif
			ENDIF 


			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
			ELSE 
				ssql="if exists (select id from inv_disc where id=?_id) delete from inv_disc where id=?_ID"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif

				TEXT TO ssql noshow
					insert into  inv_disc (id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_remark,disc_qty,autodisc,points,member_number,dedu_srv, after_inv)
					 	SELECT ?_id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_remark,disc_qty,autodisc,points,member_number,dedu_srv, after_inv from order_disc where id=?Norder_ID
				ENDTEXT
			*	ssql="insert into  inv_disc (id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_qty,autodisc,points,member_number,dedu_srv)  SELECT ?_id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_qty,autodisc,points,member_number,dedu_srv from order_disc where id=?Norder_ID"				&&¾ã³æ§é¦©

				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif
			ENDIF 
			*-------------------------------------------------------- 2009.12.12  ³¡ªù¤À±b


			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
			ELSE 
				ssql="if exists (select id from inv_itemdept where id=?_id) delete from inv_itemdept where id=?_ID"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif

				TEXT TO ssql noshow
					insert into  inv_itemdept (id,parent_id,item_id,dept_id,amount,srvamt)
						select ?_id,parent_id,item_id,dept_id,amount,srvamt from order_itemdept where order_id=?Norder_ID
				ENDTEXT
				
		*		ssql="insert into  inv_itemdept (id,parent_id,item_id,dept_id,amount,srvamt from order_itemdept ) select ?_id,parent_id,item_id,dept_id,amount,srvamt from order_itemdept where order_id=?Norder_ID"

				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif
			ENDIF 
			
			*------------------------------------------------  &&2010.04.25   ¦hµ|¶µ

			IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
			ELSE 
				ssql="if exists( select id from inv_tax where id=?_id) delete from inv_tax where id=?_ID"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif
				
				TEXT TO ssql noshow
					insert into  inv_tax (id,item_id,tax_id,tax_per,tax_amount)
						select ?_id,item_id,tax_id,tax_per,tax_amount from order_tax where id=?Norder_ID
				ENDTEXT
				
	*			ssql="insert into  inv_tax (id,item_id,tax_id,tax_per,tax_amount) select ?_id,item_id,tax_id,tax_per,tax_amount from order_tax where id=?Norder_ID"

				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				ENDIF
			ENDIF 
			
*!*				
*!*			*** -------------- 2020.03.28   sauna   by david
*!*			
*!*			IF __special_customer = "sauna"		&&¦L³æ®É¡A§Þ®v­«·s¶i¤J±Æ¶¤
*!*			
*!*				SELECT order_itemlist_tmp
*!*				SCAN
*!*					IF SQLEXEC(nhand,"update sauna_index set is_active=1,createtime=getdate() where  user_id in (select  id from sys_user where name=?order_itemlist_tmp.item_code)")<0
*!*						Aerror(err)
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions" ,1)
*!*						frm_wait.Hide
*!*						error_catch(get					
*!*					
*!*					ENDIF
*!*					
*!*				
*!*				ENDSCAN
*!*			
*!*			
*!*			ENDIF
		
			
			

ELSE

	_invID=0

ENDIF


*-----------------------------------------------------------

_cinvID=Alltrim(Str(_invID))


If Vartype(_inv_chnage_mode)#"U" AND VARTYPE(_inv_resave_mode)="U"		&&§ó§ïµo²¼¤º®e,¹w³]¬°²{ª÷¤è¦¡¥I´Ú	ggg

*!*		&&Lihong 2020.06.02
*!*		IF VARTYPE(__cloud_member_coupon)#"U" AND __cloud_member_coupon 
*!*		*LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lccloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
*!*		IF upload_coupon("revoke_redeemed_coupon", 1, null, 0, _inv_no)=.F. &&1:²{ª÷¨é 2:§I´«¨é
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			frm_wait.Hide
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			*fmessagebox("²{ª÷Â§¨é ºM¾P§I´«¥¢±Ñ¡A½Ðµy«á¦A¸Õ!")
*!*			RETURN -1
*!*		ENDIF
*!*		ENDIF  

&&Lihong 2020.06.02 µùÄÀ±¼­ì¨Ó¥N½X
*!*		ssql="if exists (select id from pay_detail where id=?_invID) delete from pay_detail where id=?_invID"				&&¥ý±N­ì¥I´Ú¤è¦¡§R°£

*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return

*!*		Endif

*!*		ssql="select id from payway  where dispord=1"		&&¨ú²Ä¤@­Ó¥I´Ú¤è¦¡¬°¹w³]ªº¥I´Ú¤è¦¡
*!*		If SQLExec(nhand,ssql,"cun_tmp")<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions" ,1)
*!*			frm_wait.Hide
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1

*!*		Endif
*!*		_payID=cun_tmp.Id
*!*		_payway=getmessage("_cash")


*!*		ssql="insert into   pay_detail (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others) "+;
*!*			"values (?_invID,?_payID,?_payway,1,?_paidamt,'',?_paidamt,0,0,1,1,?_payID,0)"



*!*		ssql=ssql+Chr(10)+"update inv set  adduser=?_login_user_name,station_id=?__station_id,updateno=?_updateno where Id=?_invID"			&&¥H²{ª÷µ²±b .


*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions" ,1)
*!*			frm_wait.Hide
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1

*!*		Endif
&&

Endif


Local inv_pn	&&¥´¦L¥÷¼Æ
*---------->>>>µo²¼¥´¦L¼Æ¾Ú
If _run_mode="fastfood"  &&OR _outlet_id=0

	inv_pn=__inv_qty_for_fastfood		&&§ÖÀ\¥´¦Lµo²¼¥÷¼Æ
Else
	inv_pn=1
	
	&&Lihong 2021.12.01
	IF VARTYPE(__inv_qty_for_dine) = "N" AND !_run_mode=="barcode"
		inv_pn = __inv_qty_for_dine
	ENDIF 
Endif


*IF (inv_pn>0 AND __invoice_print )  	&& AND !(	_run_mode="barcode" AND __print_inv_barcode_mode=.f.)			&&¦pªG«Dª½±µ¥I´Ú,¤Î³]©w­n¦C¦Lµo²¼,¥´¦Lµo²¼

*IF (inv_pn>0 AND __invoice_print AND _direct_pay=.F. )  AND !(	_run_mode="barcode" AND __print_inv_barcode_mode=.f.)			&&¦pªG«Dª½±µ¥I´Ú,¤Î³]©w­n¦C¦Lµo²¼,¥´¦Lµo²¼

&&Lihong 2021.03.05 ¼W¥[ _direct_pay And __direct_pay_print_inv=.F. ?__direct_pay_mode 
&&Lihong 2021.10.08 &&Àç·~°Ï°ì¬O§_¦C¦L¤Wµæ¯È/µo²¼/¥I´Ú²M³æ
ssql="select slip_print, inv_print, paylist_print from outlet where id=?_outlet_id"	
If SQLExec(nhand,ssql, "outlet_inv_print_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	frm_wait.Hide
	Return -1
ENDIF
_outlet_inv_print = NVL(outlet_inv_print_tmp.inv_print, .F.)
USE IN SELECT("outlet_inv_print_tmp")

*!*	&&Lihong 2022.03.25 ¦L³æ«á¦A¤J¹sª÷ÃBµæ¦¡(ª÷ÃB¥¼ÅÜ)À\Âiª¬ºA¤£ÅÜ(by setting)
*!*	IF VARTYPE(_dine_only_zero_amt_item)#"U" AND _dine_only_zero_amt_item = .T.
*!*		_outlet_inv_print = .F.
*!*	ENDIF 


_Printed=(__inv_print_to_local=.T. OR _direct_pay And __direct_pay_print_inv=.F. Or __invoice_print=.F.  OR _run_mode="dine" and _outlet_inv_print=.F. )		&&¦pªG¥»¦a¦C¦L©Î³]©w¤£¦C¦Lµo²¼¡Apriented=.t.   2009.01.13¡@¡@fix by david
&&Lihong 2022.04.13 ¯ùªãÂI¦C¦Lµo²¼»Ý­n¦L
__direct_pay_print_inv_tmp = __direct_pay_print_inv
__invoice_print_tmp = __invoice_print
IF VARTYPE(_cup_direct_pay_only_print_inv)#"U" AND _cup_direct_pay_only_print_inv= .T.
	*_cup_direct_pay_only_print_inv= .F.
	__direct_pay_print_inv_tmp = .T.
	__invoice_print_tmp = .T.
	_Printed=(__inv_print_to_local=.T. OR _direct_pay And __direct_pay_print_inv_tmp=.F. Or __invoice_print_tmp=.F.  OR _run_mode="dine" and _outlet_inv_print=.F. )
ENDIF 


*IF VARTYPE(_inv_chnage_mode)="U"		&&¦pªG§ó§ïµo²¼¤º®e¡A¤£¥´¦Lµo²¼

If Vartype(_table_info)="U"

	IF __special_customer="sauna"

		_table_info=_tableno +Iif(!Empty(_table_name) And __inv_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)


	ELSE
	
		_table_info=Iif(!Empty(cun_tmp2.askno),Trim(cun_tmp2.askno),_tableno)+Iif(!Empty(_table_name) And __inv_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)

	ENDIF
	

Endif


Local lcMember_Name,lcMember_number

lcMember_Name=Iif(Empty(_lms_member_name),ALLTRIM(cun_tmp2.member_name),_lms_member_name)
lcMember_number=Iif(Empty(_lms_member_number),ALLTRIM(cun_tmp2.member_id),_lms_member_number)

&&Lihong 2022.04.13 ¯ùªãÂI¦C¦Lµo²¼»Ý­n¦L
__invoice_print_tmp = __invoice_print
IF VARTYPE(_cup_direct_pay_only_print_inv)#"U" AND _cup_direct_pay_only_print_inv= .T.
	*_cup_direct_pay_only_print_inv= .F.
	__invoice_print_tmp = .T.
ENDIF 

IF (__invoice_print_tmp Or (__invoice_print_in_fastfood And _run_mode="fastfood"))  AND	 VARTYPE(_prt_inv_no_p)="U" AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
&& ((__invoice_print ) Or (__invoice_print_in_fastfood And _run_mode="fastfood"))  AND	 VARTYPE(_prt_inv_no_p)="U"


	If __inv_print_to_local


		Create_inv_print_cursor()		&&¥Í¦¨©Ò»ÝÁ{®Éªí

		_Pid="INV"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"INV"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î


		Insert Into inv_print_main (inv_Id,tableno,pplcnt,Printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,training,tel,address,;
			amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,link_table,remark,points,points_used,points_remain,inv_remark,inv_remark2);
			values ( _invID, _table_info, _pplcnt, _printer, _printer,'', _Printed,Datetime(),Datetime(), _login_user_name, _station_id, Inv_langue(1), _isfastfood, GL_training, _tel, _addr,;
			cun_tmp2.amount, cun_tmp2.discamt, cun_tmp2.itemdiscamt, cun_tmp2.srvamt, cun_tmp2.taxamt, cun_tmp2.rndamt, _inv_amt, _begtime, _paidtime, lcMember_Name,;
			lcMember_number,.F., _link_table, _mem_remark, _inv_points, _inv_points_used, _points_remain,_inv_remark,_inv_remark2)


		If inv_detail_generate("INV",Norder_ID,_Pid,Inv_langue(1),.F.,__inv_print_to_local,.T.,_void_id)<0			&&¥Í¦¨µo²¼²Ó¸`(¥»¦a)

			Return -1

		Endif




	Else


		For p=1 To inv_pn

			_Pid="INV"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"INV"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î

*!*					ssql="insert into inv_print_main (pid,inv_Id,tableno,pplcnt,printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,training,tel,address,"+;
*!*						"amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,link_table,remark,points,points_used,points_remain)"+;
*!*						" values (?_pid,?_invID,?_table_info,?_pplcnt,?_printer,?_printer,'',?_printed,getdate(),'',?_login_user_name,?_station_id,?inv_langue(1),?_isfastfood,?GL_training,?_tel,?_addr,"+;
*!*						"?cun_Tmp2.amount,?cun_Tmp2.discamt,?cun_Tmp2.itemdiscamt,?cun_Tmp2.srvamt,?cun_Tmp2.taxamt,?cun_Tmp2.rndamt,?_inv_amt,?_begtime,?_paidtime,?cun_Tmp2.member_name,"+;
*!*						"?cun_Tmp2.member_id,0,?_link_table,?_mem_remark,?_inv_points,?_inv_points_used,?_points_remain)"
*!*

			TEXT TO ssql NOSHOW TEXTMERGE

				insert into inv_print_main (pid,inv_Id,tableno,pplcnt,printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,training,tel,address,
					amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,link_table,remark,points,points_used,points_remain,inv_remark,inv_remark2)
					 values (?_pid,?_invID,?_table_info,?_pplcnt,?_printer,?_printer,'',?_printed,getdate(),'',?_login_user_name,?_station_id,?inv_langue(1),?_isfastfood,?GL_training,?_tel,?_addr,
					<<cun_Tmp2.amount>>,<<cun_Tmp2.discamt>>,<<cun_Tmp2.itemdiscamt>>,<<cun_Tmp2.srvamt>>,<<cun_Tmp2.taxamt>>,<<cun_Tmp2.rndamt>>,<<_inv_amt>>,?_begtime,?_paidtime,?lcMember_Name,
					?lcMember_number,0,?_link_table,?_mem_remark,?_inv_points,?_inv_points_used,?_points_remain,?_inv_remark,?_inv_remark2)



			ENDTEXT


			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

&&		Norder_ID

			If inv_detail_generate("INV",Norder_ID,_Pid,Inv_langue(1),.F.,__inv_print_to_local,.T.,_void_id)<0			&&¥Í¦¨µo²¼²Ó¸`
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)

				Return -1

			Endif

		Endfor

	Endif


*	write_log(58,"tbl:"+_tableno+" inv:"+ALLTRIM(STR(_invID))+" Amt:"+ALLTRIM(STR(_inv_amt,10,2)))		&&°O¿ý¾Þ§@
	
	&&Lihong 2023.02.24
	IF VARTYPE(__print_edit_inv_as_reprint)#"U" AND __print_edit_inv_as_reprint AND VARTYPE(_status_for_reprint_inv)#"U" AND (_status_for_reprint_inv="T" OR _status_for_reprint_inv="P") AND (__inv_print_to_local=.T. OR _printed=.F.) &&_run_mode="dine"
		*IF  vartype(__inv_reprint_save)#"U"   and __inv_reprint_save		
			lcstation_reprint_inv = getcomputername()
			ssql="insert into inv_reprint(inv_id,invamt,datetime,adduser,station) values (?_invID,?_inv_amt,getdate(),?_login_user_name,?lcstation_reprint_inv)"	

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1

			Endif

		*ENDIF
	ENDIF 

Endif

*ssql="insert into inv_reprint(inv_id,invamt,datetime,adduser,station) values (?_invID,?_inv_amt,getdate(),?_login_user_name,?getcomputername())"	&& 2011 .04.11  // 2014.06 cancel

*!*	TEXT TO ssql NOSHOW TEXTMERGE

*!*		insert into inv_reprint(inv_id,invamt,datetime,adduser,station) values (?_invID,<<_inv_amt>>,getdate(),?_login_user_name,?getcomputername())

*!*	ENDTEXT


*!*	If SQLExec(nhand,ssql)<0
*!*		Aerror(err)
*!*		Sqlrollback(nhand)
*!*		SQLSetprop(nhand,"Transactions" ,1)
*!*		frm_wait.Hide
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		Return -1

*!*	Endif


*!*	IF _inv_no>0 	&&°O¿ý­«¦L³æ

*!*		ssql="insert into inv_reprint(inv_id,invamt,datetime,adduser,station) values (?_invID,?cun_tmp2.invamt,getdate(),?_login_user_name,?getcomputername())"	&& 2011 .04.11

*!*			ssql=ssql+Chr(10)+"insert into inv_reprint_main (pid,inv_Id,tableno,pplcnt,sendtime,username,station_id,langue,fastfood,training,tel,address,"+;
*!*				"amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,reprint,link_table,remark,points,points_used,points_remain,inv_remark,inv_remark2)"+;
*!*				" values (?_pid,?_invID,?_table_info,?cun_tmp2.pplcnt,?DATETIME(),?_login_user_name,?_station_id,?_clangue,?_isfastfood,?GL_training,?cun_tmp2.tel,?_addr,"+;
*!*				"?cun_tmp2.amount,?cun_tmp2.discamt,?cun_tmp2.itemdiscamt,?cun_tmp2.srvamt,?cun_tmp2.taxamt,?cun_tmp2.rndamt,?cun_tmp2.invamt,"+;
*!*				"?cun_tmp2.begintime,?_paidtime,?lcMember_Name,?cun_tmp2.member_id,0,0,?_link_table,"+;
*!*				"?_inv_remark,?_inv_points,?_inv_Points_used,?_points_remain,?_inv_remark,?_inv_remark2)" 


*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions" ,1)
*!*			frm_wait.Hide
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1

*!*		Endif



*!*			ssql="if exists (select inv_id from inv_problem where inv_id=?_invID) update inv_problem set reprint_times=reprint_times+1 where inv_id=?_invID "+;
*!*				" else insert into inv_problem (inv_id,reprint_times) values (?_invID,1)"


*!*			If SQLExec(nhand,ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				frm_wait.Hide
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1

*!*			Endif



*!*	ENDIF


IF VARTYPE(_inv_only_preview)="U" AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)

	ssql="Update order_main set inv_id=?_invID where id=?Norder_Id"		&&§ó·sorder_main
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	&&Âà»ù

	If SQLExec(nhand,"if exists (select id from cp_log where order_id=?Norder_ID and inv_Id=0 ) update  cp_log set inv_Id=?_invID where order_id=?Norder_ID")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	If Vartype(_inv_chnage_mode)#"U"


		TEXT TO ssql noshow		&&§R°£Á{®É¼Æ¾Ú

			DELETE FROM  order_main WHERE id=?Norder_Id
			DELETE FROM  order_detail WHERE id=?Norder_Id
			DELETE FROM order_modi  WHERE id=?Norder_Id
			DELETE FROM order_modi  WHERE id=?Norder_Id
			DELETE FROM order_itemdisc  WHERE id=?Norder_Id
			DELETE FROM order_disc  WHERE id=?Norder_Id
			DELETE FROM order_itemdept  WHERE order_id=?Norder_Id

		ENDTEXT

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

	Endif


	If Upper(_run_mode)="DINE" And Vartype(_inv_chnage_mode)="U" 

	&&¦pªG¬O§ÖÀ\¼Ò¦¡,¤£¥ß§Y´£¥æ,¥H«Oµý¼Æ¾Ú§¹¾ã©Ê(¤£§ó·sÀ\Âiª¬ºA)
		ssql="update tables set status='P',inv_Id=?_invID,have_unfinish=0,nshare_order=?nshare,split=?nSplitNo,ready_pay=0 where tableno=?_tableno and nsubtable=0"			&&§ó·sÀ\Âiª¬ºA¬°"¤w¦L³æ"(¤ÀÂi)

		&&Lihong 2021.12.29 ¦PÂi
		IF VARTYPE(__same_tables)#"U" and __same_tables
			TEXT TO ssql ADDITIVE noshow
			
				update tables set status='P' where tableno in (SELECT tableno FROM same_table_detail WITH (nolock) WHERE tableno<>?_tableno and same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?_tableno ) ) and nsubtable=0 
			ENDTEXT 
		ENDIF 

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1
		Endif

	Endif
	RELEASE work_cashier_call_SplitNo &&Lihong 2020.01.17 

	&&Lihong 2022.08.16 
	IF VARTYPE(__same_tables)#"U" and __same_tables AND (Vartype(_inv_chnage_mode)="U" AND Upper(_run_mode)="DINE" OR Vartype(_inv_chnage_mode)#"U") 
			* DECLARE @same_tables_count int 
			* SET @same_tables_count = (select count(distinct isnull(same_tableno,'')) from inv_detail with (nolock) where id=?_invID)
			* IF @same_tables_count is null OR @same_tables_count<=1 SET @same_tables_count = null 
			* update inv set same_table_count=@same_tables_count where id=?_invID AND tableno<>''
		TEXT TO ssql NOSHOW 
			
			update inv set same_table_count=?_same_table_count where id=?_invID AND tableno<>''
			
		ENDTEXT &&AND fastfood=1 : outlet=0°ó®y¤]¬O1

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1
		Endif
	ENDIF 	

ENDIF


If !(Upper(_run_mode)="FASTFOOD"  And __octopus_installed=.F.)

	If  Sqlcommit(nhand)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif
	SQLSetprop(nhand,"Transactions" ,1)

Endif

&&Lihong 2022.04.13 ¯ùªãÂI¦C¦Lµo²¼»Ý­n¦L
__invoice_print_tmp = __invoice_print
__direct_pay_print_inv_tmp = __direct_pay_print_inv
IF VARTYPE(_cup_direct_pay_only_print_inv)#"U" AND _cup_direct_pay_only_print_inv= .T.
	*_cup_direct_pay_only_print_inv= .F.
	__invoice_print_tmp = .T.
	__direct_pay_print_inv_tmp = .T.
ENDIF 

IF ((Upper(_run_mode)="DINE" AND __invoice_print_tmp) OR (__invoice_print_in_fastfood And _run_mode="fastfood" AND VARTYPE(_fastfood_checkout_print)#"U" AND _fastfood_checkout_print)) ;
And __inv_print_to_local And inv_pn>0 AND VARTYPE(_prt_inv_no_p)="U" AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
&&Upper(_run_mode)="DINE"  And __inv_print_to_local	And inv_pn>0 And __invoice_print   AND VARTYPE(_prt_inv_no_p)="U"

	&&Lihong 2021.10.08 &&Àç·~°Ï°ì¬O§_¦C¦L¤Wµæ¯È/µo²¼/¥I´Ú²M³æ ¼W¥[OR _outlet_inv_print=.F.	
	IF (_direct_pay And __direct_pay_print_inv_tmp=.F. )	 Or  Vartype(_inv_chnage_mode)#"U" OR _outlet_inv_print=.F.
	&& (_direct_pay And __direct_pay_print_inv=.F. )	 Or  Vartype(_inv_chnage_mode)#"U" OR _outlet_inv_print=.F.   &&¦pªG§ó§ïµo²¼¤º®e¡A¤£¥´¦Lµo²¼ &&¦pªGª½±µµ²±b,¦ý¤£¥´¦L,ªð¦^
		frm_wait.Hide
		Return _invID		&&ªð¦^µo²¼¸¹

	Endif

	IF  ALLTRIM(LOWER(__special_customer)) = "amuse"  AND VARTYPE(oMember_info)="U"
	
		
		_print_invoice2=.t.
		
	
	
	ENDIF
	
	IF VARTYPE(__print_invoice2)#"U" AND __print_invoice2
		_print_invoice2=.t.
	
	ENDIF

	For nnn=1 To inv_pn &&Lihong 2021.12.01
		inv_Local_print(_Pid,_printer,Inv_langue(1))		&&ª½¦L¥»¦a¥´¦L¾÷
	ENDFOR 
Else

	write_log(57,"Save inv without print")

Endif

frm_wait.Hide

Return _invID		&&ªð¦^µo²¼¸¹

Endfunc

**********************************
*	¼öÁä®·®»-->Âà²¾
*
Function bindkey
Lparameters obj,nkeycode

obj.key_press(nkeycode,0)

Endfunc


*************************
*	¥Î¤áÅv­­ÀË´ú
*
*	pcode ¬°½sµ{¥N½X
*******************

Function user_access
Lparameters _pcode,_only_check		&&_pcode ¬°½sµ{¥N½X

If 	__admin__user		&&supper admin
	Return .T.
Endif



If Vartype(_pcode)#"C"
	Return .F.
Endif

Local _code
_code=Trim(_pcode)

Local csql, retime, _err1, _err2, _prg, _Lineno

&&Lihong 2022.07.18 Â_½u­«³s, ¤Î«áÁÙ¬O¨úÅv­­¼Æ¾Ú¥¢±Ñ«h¤¹³\°h¥X
retime = 0
_err1 = ""
DO WHILE retime<2
	retime = retime + 1
	&&Lihong Lihong 2021.09.27 ²¾°Ê¨ì«e­±
	csql="select role_list from sys_user with (nolock) where name=?_login_user_name and active=1"
	If SQLExec(nhand,csql,"access_tmp")<0
		
		IF retime>1
			IF LOWER(ALLTRIM(_pcode))=='exit_window'
				RETURN .T.
			ELSE 
				Return .F.
			ENDIF 
		ELSE
			*Aerror(err)
*!*				_err1 = Alltrim(Str(err(1)))
*!*				_err2 = Trim(err(2))
*!*				_prg = Program()
*!*				_Lineno = Lineno(1)
			Local cstr, lnservers
			lnservers =  1
			IF __linkserver_active = .F.
				cstr=crstr(Filetostr("sysinfo.dat"),"RMS6")
				lnservers = OCCURS("@", cstr)
			ENDIF 
			IF __linkserver_active OR lnservers > 1 OR VARTYPE(_setup_memb_change_nhand)#"U"
				*Aerror(err)
				*error_catch(getmessage("_sqlserver_error"),_err1,_err2,_prg,_Lineno, .T. )
				Return .F.
			ENDIF 
		ENDIF 
		IF check_sql_hand() = .T.
			LOOP 
		ELSE 
			IF LOWER(ALLTRIM(_pcode))=='exit_window'
				RETURN .T.
			ELSE 
				Return .F.
			ENDIF 
		ENDIF 
	ELSE 
		IF retime>1 AND !EMPTY(_err1)
			*error_catch(getmessage("_sqlserver_error"),_err1,_err2,_prg,_Lineno, .T. )
		ENDIF 
	ENDIF
ENDDO 

Local _role_list
_role_list=Alltrim(access_tmp.role_list)		&&¨¤¦â

If Empty(_role_list)						&&¨S¦³¨¤¦â,«hªð¦^
	Select access_tmp
	USE
	write_Log(-2,"user_access : "+_pcode+", user : "+_login_user_name+",fail : user empty role_list")
	Return .F.
ENDIF

&&Lihong 2023.07.17
*!*	&&Lihong 2021.09.27 admin¨¤¦â¨ã¦³©Ò¦³Åv­­
*!*	IF ",0," $ "," + _role_list
*!*		USE IN SELECT("access_tmp")
*!*		Return .T.
*!*	ENDIF 

retime = 0
_err1 = ""
DO WHILE retime<2
	retime = retime + 1

	csql="select roleaccess_id,code,fly_add,ask_again from ROLEACCESS with (nolock) where code=?_code"
	If SQLExec(nhand,csql,"access_tmp")<0
		IF retime>1
			IF LOWER(ALLTRIM(_pcode))=='exit_window'
				RETURN .T.
			ELSE 
				Return .F.
			ENDIF 
		ELSE
			*Aerror(err)
*!*				_err1 = Alltrim(Str(err(1)))
*!*				_err2 = Trim(err(2))
*!*				_prg = Program()
*!*				_Lineno = Lineno(1)
			Local cstr, lnservers
			lnservers =  1
			IF __linkserver_active = .F.
				cstr=crstr(Filetostr("sysinfo.dat"),"RMS6")
				lnservers = OCCURS("@", cstr)
			ENDIF 
			IF __linkserver_active OR lnservers > 1 OR VARTYPE(_setup_memb_change_nhand)#"U"
				*Aerror(err)
				*error_catch(getmessage("_sqlserver_error"),_err1,_err2,_prg,_Lineno, .T. )
				Return .F.
			ENDIF 
		ENDIF 
		IF check_sql_hand() = .T.
			LOOP 
		ELSE 
			IF LOWER(ALLTRIM(_pcode))=='exit_window'
				RETURN .T.
			ELSE 
				Return .F.
			ENDIF 
		ENDIF 
	ELSE 
		IF retime>1 AND !EMPTY(_err1)
			*error_catch(getmessage("_sqlserver_error"),_err1,_err2,_prg,_Lineno, .T. )
		ENDIF 
	ENDIF
ENDDO 

&&Lihong 2023.07.17
LOCAL _ask_again
_ask_again=NVL(access_tmp.ask_again,.F.)
&&Lihong 2021.09.27 admin¨¤¦â¨ã¦³©Ò¦³Åv­­
IF ",0," $ "," + _role_list
	USE IN SELECT("access_tmp")
	IF _ask_again=.T. And _only_check=.F.
		beep()
		_access=.F.
		_ask_again_access_login=.T.
		Do Form Form\access_login With _code,_access
		Return _access
	ELSE 
		Return .T.
	ENDIF 
ENDIF 

retime = 0
_err1 = ""
DO WHILE retime<2
	retime = retime + 1
	
	csql="select id,access from role with (nolock) "
	If SQLExec(nhand,csql,"access_tmp1")<0
		IF retime>1
			IF LOWER(ALLTRIM(_pcode))=='exit_window'
				RETURN .T.
			ELSE 
				Return .F.
			ENDIF 
		ELSE
			*Aerror(err)
*!*				_err1 = Alltrim(Str(err(1)))
*!*				_err2 = Trim(err(2))
*!*				_prg = Program()
*!*				_Lineno = Lineno(1)
			Local cstr, lnservers
			lnservers =  1
			IF __linkserver_active = .F.
				cstr=crstr(Filetostr("sysinfo.dat"),"RMS6")
				lnservers = OCCURS("@", cstr)
			ENDIF 
			IF __linkserver_active OR lnservers > 1 OR VARTYPE(_setup_memb_change_nhand)#"U"
				*Aerror(err)
				*error_catch(getmessage("_sqlserver_error"),_err1,_err2,_prg,_Lineno, .T. )
				Return .F.
			ENDIF 
		ENDIF 
		IF check_sql_hand() = .T.
			LOOP 
		ELSE 
			IF LOWER(ALLTRIM(_pcode))=='exit_window'
				RETURN .T.
			ELSE 
				Return .F.
			ENDIF 
		ENDIF 
	ELSE 
		IF retime>1 AND !EMPTY(_err1)
			*error_catch(getmessage("_sqlserver_error"),_err1,_err2,_prg,_Lineno, .T. )
		ENDIF 
	ENDIF
ENDDO 


If Empty(access_tmp.roleaccess_id)		&&¦pªG§ä¤£¨ì¥N½X,ªð¦^ .f.
	Select access_tmp
	Use
	Select access_tmp1
	Use
	write_Log(-2,"user_access : "+_pcode+", user : "+_login_user_name+",fail : roleaccess table no "+_pcode)
	Return .F.
Endif
Local _roleaccess_id,_fly_add		&&fly_add ¬O§_§Y®É°l¥[Åv­­
_roleaccess_id=access_tmp.roleaccess_id		&&Åv­­ID
_fly_add=access_tmp.fly_add

&&Lihong Lihong 2021.09.27 ²¾°Ê¨ì«e­±
*!*	csql="select role_list from sys_user where name=?_login_user_name and active=1"
*!*	If SQLExec(nhand,csql,"access_tmp")<0
*!*		Select access_tmp
*!*		Use
*!*		Select access_tmp1
*!*		Use
*!*		Return .F.
*!*	ENDIF
*!*	Local _role_list
*!*	_role_list=Alltrim(access_tmp.role_list)		&&¨¤¦â
*!*	If Empty(_role_list)						&&¨S¦³¨¤¦â,«hªð¦^
*!*		Select access_tmp
*!*		Use
*!*		Return .F.
*!*	ENDIF

Local Access
Dimension Access(1)
getmstring(_role_list,@m.Access)

For i=1 To Alen(Access) 			&&¨¤¦â¼Æ¶q

	_id=Val(Access(i))
	Select Access From access_tmp1 Where Id=_id Into Cursor access_tmp
	If _Tally=0
		Loop
	Endif

	_role_list=Trim(access_tmp.Access)			&&¨¤¦âÅv­­	ID

	If Empty(_role_list)
		Loop
	Endif

	Local acc
	Dimension acc(1)
	getmstring(_role_list,@acc)
	For k=1 To Alen(acc)
		acc(k)=Val(acc(k))
	Endfor


	If Ascan(acc,_roleaccess_id)>0							&&¨¤¦âÅv­­ID ¬O§_¥]§t©Ò»Ý­nªºID
		Select access_tmp
		Use
		Select access_tmp1
		USE
		IF _ask_again=.T. And _only_check=.F.
			beep()
			_access=.F.
			_ask_again_access_login=.T.
			Do Form Form\access_login With _code,_access
			Return _access
		ELSE 
			Return .T.
		ENDIF 

	Endif

Endfor

If Used("access_tmp")
	Select access_tmp
	Use
Endif
If Used("access_tmp1")
	Select access_tmp1
	Use
Endif

write_Log(-2,"user_access : "+_pcode+", user : "+_login_user_name+",fail : user no "+_pcode)


If _fly_add  And _only_check=.F.
	beep()
	_access=.F.
	Do Form Form\access_login With _code,_access

	Return _access

Endif


Return .F.


Endfunc

*------------------------------------------------------------------
*	ª÷ÃB¹sÀY³B²z
* __rounding ¬°¤½¦@ÅÜ¶q

Function rounding_amount

Lparameters N_amount,rounding_type			&&rounding_type ¬°
If Vartype(N_amount)#"N"
	Return 0
Endif

Local r_type

If Vartype(rounding_type)#"C"


	If Vartype(_run_mode)="C" And Upper(_run_mode)="FASTFOOD" And  Vartype(__rounding_fastfood)#"U" And Vartype(_print_inv_within_order)="U"


		r_type=__rounding_fastfood

	Else

		r_type=__rounding

	Endif


Else

	r_type=rounding_type

Endif




Local _amount

_amount=N_amount

Do Case

	Case r_type="_round_to_dollar"		&&¥|ªÙ¤­¤J¨ì¤¸

		_amount=Iif(Mod(_amount,1)>=0.5,Val(Str(Ceiling(_amount))),Val(Str(Floor(_amount))))

	Case r_type="_round_to_cents"		&&¥|ªÙ¤­¤J¦Ü²@

		_amount=Val(Str(Round(_amount,1),10,1))

	Case r_type="_up_to_dollar"			&&¦h¦¬¦Ü¤¸

		_amount=Val(Str(Ceiling(_amount)))

	Case r_type="_down_to_dollar"		&&¤Ö¦¬¦Ü¤¸
		_amount=Val(Str(Floor(_amount)))

	Case r_type="_up_to_5cents"			&&¦h¦¬¨ì¤­²@
		If _amount>0
			_amount=Iif(Mod(_amount,1)<=0.5 And Mod(_amount,1)>0,Int(_amount)+0.50,Val(Str(Ceiling(_amount))))
		Endif


	Case r_type="_down_to_5cents"		&&¤Ö¦¬¨ì¤­²@
		If _amount>0
			_amount=Iif(Mod(_amount,1)>=0.5,Int(_amount)+0.50,Val(Str(Floor(_amount),10,1)))
		Endif
		&&¤G¤CªÙ¤T¤K¤J¤­¤ò
	Case r_type="_half_updown_to_5cents"

		_amt_dire = IIF(_amount >= 0, 1, -1)
		_amount = _amount * _amt_dire
		 
		_dec_amt = Mod(_amount,1)
		Do Case
			&&Case BETWEEN(_dec_amt, 0.3, 0.4) OR BETWEEN(_dec_amt, 0.6, 0.7)
				&&_amount = Val(Str(Floor(_amount))) + 0.5
			&&Case BETWEEN(_dec_amt, 0.1, 0.2)
			Case _dec_amt < 0.3
				_amount = Val(Str(Floor(_amount))) 
			&&Case BETWEEN(_dec_amt, 0.8, 0.9)
			Case _dec_amt >= 0.8
				_amount = Val(Str(Ceiling(_amount)))
			OTHERWISE
				_amount = Val(Str(Floor(_amount))) + 0.5
		Endcase
		_amount = _amount * _amt_dire
		
	Otherwise								&&¤£ÅÜ


Endcase

Return _amount


Endfunc
******************************
*	µæ¦¡¦h»y¨¥¦C¦L
*
*	MULT_ORDER_ITEM
******************************
Function MULT_ORDER_ITEM

Lparameters _Pid,_qty,cdbf,_ismitem,_modi,_slip,_void,_must_printAmt,_other_langue
&&_ismitem ¬O§_®M¶µ¥Ø¤l¶µ¥Ø &&_modi ¬O§_¯S§O³B²z &&_slip ²M³æ,_void ¬O§_¨ú®øªºµæ¦¡,_must_printAmt¤@©w¥´¦Lª÷ÃB

Local _code,_spec,_item,_amount,_item_qty,csql,csql2,csql3,csql_other,_spec_other,_qty_other

csql_other=""
_spec_other=""
_qty_other=0

Local _print_to_local


If Vartype(_slip_print_to_local)#"U" And _slip_print_to_local

	_print_to_local=.T.

Endif

*!*	IF VARTYPE(ll_kilo)="U"
*!*		ll_kilo=.F.

*!*	ENDIF


If _slip

	_code=Iif(__slip_print_Item_code And _modi=.F.,&cdbf..item_code,"")&&¬O§_¥´¦L½s½X
	Select &cdbf

	If !Empty(Field("amount")) And (__slip_print_Item_amount OR VARTYPE(llfastfood_order_do_pre)#"U")
	
		_amount=&cdbf..amount

	Else
		_amount=Iif( _must_printAmt ,&cdbf..amount,0)		&&¬O§_¦Lª÷ÃB/¤â¤u¶µ¥Ø¤Î³Ì§C®ø¶O¥²¦L

*		_amount=0				&&¬O§_¦Lª÷ÃB/¤â¤u¶µ¥Ø¤Î³Ì§C®ø¶O¥²¦L

	Endif

	_item_qty=Iif(_modi,0,_qty)

	Local _other_desc
	If Val(__mult_langue_code)>0

*		_other_desc=Strconv(Strconv(Trim(&cdbf..desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other_desc=Trim(Nvl(&cdbf..desc_other,""))

	Else
		_other_desc=""

	Endif


	_amount2=_amount
	_amount3=_amount
	_amount4=_amount


	_qty_other=_item_qty

	If  _print_to_local

		csql="insert into slip_print_detail (code,qty,item,amount,dispord,item_unicode) values (_code,_item_qty,_item,_amount,_dispord,'')"
		csql2="insert into slip_print_detail (code,qty,item,amount,dispord,item_unicode) values ( _code,_item_qty2,_item2,_amount2,_dispord,'')"
		csql3="insert into slip_print_detail (code,qty,item,amount,dispord,item_unicode) values (_code,_item_qty3,_item3,_amount3,_dispord,'')"

		If !Empty(_other_desc)

			csql_other="insert into slip_print_detail (code,qty,item,amount,dispord,item_unicode) values (_code,_qty_other,'',_amount4,_dispord,_other_desc)"

		Endif

	Else

		csql="insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,?_code,?_item_qty,?_item,?_amount,?_dispord,'')"
		csql2="insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,?_code,?_item_qty2,?_item2,?_amount2,?_dispord,'')"
		csql3="insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,?_code,?_item_qty3,?_item3,?_amount3,?_dispord,'')"

		If !Empty(_other_desc)
			csql_other="insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,?_code,?_qty_other,'',?_amount4,?_dispord,?_other_desc)"

		Endif

	Endif


Else

	_void_item=Iif(_void,1,0)
	_color=Iif(_modi,1,0)

	_item_Id=Iif(_modi,0,&cdbf..item_id)

	_code=Iif(__kit_print_item_code And _modi=.F.,Trim(&cdbf..item_code)+" ","")		&&¬O§_¦C¦Lµæ¦¡½s¸¹(¯S§O³B²z¤£¦L¦L)


*!*		IF ll_kilo


*!*			IF VARTYPE( __kilo_unit)#"U" AND __kilo_unit="K10"		&&¤Q¶i¨î
*!*
*!*				cKilo	="("+IIF(INT(_qty/10)>0 ,ALLTRIM(STR(INT(_qty/10)))+getmessage("_kilo"),"")+;
*!*							IIF(MOD(_qty,10)>0,ALLTRIM(STR(MOD(_qty,10)))+getmessage("_kilo2"),"")+")"


*!*			ELSE		&&¹w³]¬°¤Q¤»¶i¨î
*!*
*!*				cKilo	="("+IIF(INT(_qty/16)>0 ,ALLTRIM(STR(INT(_qty/16)))+getmessage("_kilo"),"")+;
*!*							IIF(MOD(_qty,16)>0,ALLTRIM(STR(MOD(_qty,16)))+getmessage("_kilo2"),"")+")"

*!*			ENDIF

*!*		ENDIF


	Local _other_desc
	If Val(__mult_langue_code)>0

*		_other_desc=Strconv(Strconv(Trim(&cdbf..desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other_desc=Trim(Nvl(&cdbf..desc_other,""))

	Else
		_other_desc=""
	Endif


	csql="insert into order_print_detail (pid,qty,spec,item,dispord,void,modi,item_id,item_unicode) values (?_pid,?_qty,?_spec,?_item,?_dispord,?_void_item,?_color,?_item_id,'')"
	csql2="insert into order_print_detail (pid,qty,spec,item,dispord,void,modi,item_id,item_unicode) values (?_pid,?_qty,?_spec2,?_item2,?_dispord,?_void_item,?_color,?_item_id,'')"
	csql3="insert into order_print_detail (pid,qty,spec,item,dispord,void,modi,item_id,item_unicode) values (?_pid,?_qty,?_spec3,?_item3,?_dispord,?_void_item,?_color,?_item_id,'')"

	If !Empty(_other_desc)
		csql_other="insert into order_print_detail (pid,qty,spec,item,dispord,void,modi,item_id,item_unicode) values (?_pid,?_qty,?_spec_other,'',?_dispord,?_void_item,?_color,?_item_id,?_other_desc)"
	Endif


Endif

Local _Print_type,_cItem_amt

If 	Lower(cdbf)="cun_modi_tmp" And Vartype(__kit_modi_print_langue)#"U"		&&2009.11.16 ¯S§O³B²z¥´¦L¤º®e¿ï¶µ

	_Print_type=Lower(__kit_modi_print_langue)

Else


	_Print_type=Lower(__kitchen_order)

Endif


Do Case
	Case _Print_type="cn" Or 	_Print_type="cn_other"  Or _Print_type="other"	&&¤¤¤å³øªí¦WºÙ
		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..descinvcn)+"]",Trim(&cdbf..descinvcn))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..descinvcn,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 
		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif

		Else

			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif

		If  _Print_type="other" And !Empty(csql_other)
			_spec_other=_spec
			ssql=csql_other
		Else

			ssql=csql
			If !Empty(csql_other)	And _Print_type="cn_other" 	&&¦pªG¦³¨ä¥¦»y¨¥,«á¥[
				_spec_other=""
				_qty_other=0
				_amount2=0
				_amount3=0
				
				IF VARTYPE(__kitorder_print_unicode_first)#"U"  AND __kitorder_print_unicode_first
					_amount=0					
					ssql=csql_other+Chr(10)+ssql
				ELSE
					_amount4=0
					ssql=ssql+Chr(10)+csql_other
				ENDIF
				

			Endif
		Endif




	Case _Print_type="en" Or _Print_type="en_other"		&&­^¤å³øªí¦WºÙ
	
		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..descinven)+"]",Trim(&cdbf..descinven))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..descinven,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 

		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif

		Else

			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif


		ssql=csql
		If !Empty(csql_other)	And _Print_type="en_other"	&&¦pªG¦³¨ä¥¦»y¨¥,«á¥[
			_spec_other=""
			_qty_other=0
			_amount2=0
			_amount3=0
			

				IF VARTYPE(__kitorder_print_unicode_first)#"U"  AND __kitorder_print_unicode_first
					_amount=0
					ssql=csql_other+Chr(10)+ssql
				ELSE
					_amount4=0
					ssql=ssql+Chr(10)+csql_other
				ENDIF
				
		Endif


	Case _Print_type="kit" Or _Print_type="kit_other"		&&¼p©Ð³æ¦WºÙ

		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..desckit)+"]",Trim(&cdbf..desckit))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..desckit,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 

		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif
		Else

			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif

		ssql=csql
		If !Empty(csql_other) And 	 _Print_type="kit_other"		&&¦pªG¦³¨ä¥¦»y¨¥,«á¥[
			_spec_other=""
			_qty_other=0
			_amount2=0
			_amount3=0
			
				IF VARTYPE(__kitorder_print_unicode_first)#"U"  AND __kitorder_print_unicode_first
					_amount=0
					ssql=csql_other+Chr(10)+ssql
				ELSE
					_amount4=0
					ssql=ssql+Chr(10)+csql_other
				ENDIF
				
		Endif

	Case _Print_type="cn_en"  Or  _Print_type="cn_en_other"


		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..descinvcn)+"]",Trim(&cdbf..descinvcn))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..descinvcn,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 

		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif

		Else
			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif

		ssql=csql

		_spec2=""
		_item_qty2=0
		_amount2=0
		_amount3=0
				
		_item2=Iif(_ismitem,"["+Trim(&cdbf..descinven)+"]",Trim(&cdbf..descinven))

		ssql=ssql+Chr(10)+csql2

		If !Empty(csql_other) And 	 _Print_type="cn_en_other"		&&¦pªG¦³¨ä¥¦»y¨¥,«á¥[

			_spec_other=""
			_qty_other=0
			_amount2=0
			_amount3=0
						
				IF VARTYPE(__kitorder_print_unicode_first)#"U"  AND __kitorder_print_unicode_first
					_amount=0
					ssql=csql_other+Chr(10)+ssql
				ELSE
					_amount4=0
					ssql=ssql+Chr(10)+csql_other
				ENDIF
				
		Endif


	Case _Print_type="cn_kit"

		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..descinvcn)+"]",Trim(&cdbf..descinvcn))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..descinvcn,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 

		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif
		Else

			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif

		ssql=csql

		_spec2=""
		_item_qty2=0
		_amount2=0
		_amount3=0
		
		_item2=Iif(_ismitem,"["+Trim(&cdbf..desckit)+"]",Trim(&cdbf..desckit))
		ssql=ssql+Chr(10)+csql2

	Case _Print_type="en_kit"

		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..descinven)+"]",Trim(&cdbf..descinven))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..descinven,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 

		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif
		Else

			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif

		ssql=csql

		_spec2=""
		_item_qty2=0
		_amount2=0
		_amount3=0		
		
		_item2=Iif(_ismitem,"["+Trim(&cdbf..desckit)+"]",Trim(&cdbf..desckit))

		ssql=ssql+Chr(10)+csql2


	Case _Print_type="cn_en_kit"
		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..descinvcn)+"]",Trim(&cdbf..descinvcn))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..descinvcn,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 

		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif

		Else
			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)


		Endif


		ssql=csql

		_spec2=""
		_item_qty2=0
		_amount2=0
		_amount3=0
				
		_item2=Iif(_ismitem,"["+Trim(&cdbf..descinven)+"]",Trim(&cdbf..descinven))
		_other2=""

		ssql=ssql+Chr(10)+csql2


		_spec3=""
		_item_qty3=0
		_item3=Iif(_ismitem,"["+Trim(&cdbf..desckit)+"]",Trim(&cdbf..desckit))
		ssql=ssql+Chr(10)+csql3

	Otherwise

		_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
		_spec=Iif(_modi,"**","")+Iif(_modi,Iif(_qty>1,_cqty+" x",""),Iif(_qty>0,_cqty+" x",""))
		_item=Iif(_ismitem,"["+Trim(&cdbf..desckit)+"]",Trim(&cdbf..desckit))
		&&Lihong 2022.11.09 
		IF EMPTY(NVL(&cdbf..desckit,"")) AND !EMPTY(FIELD("descdisp",cdbf))
			_item=Iif(_ismitem,"["+Trim(&cdbf..descdisp)+"]",Trim(&cdbf..descdisp))
		ENDIF 


		If _slip
			If _modi
				_cqty=Iif(Mod(_qty,1)=0,Alltrim(Str(_qty)),Alltrim(Str(_qty,10,2)))
				_item=Space(2)+"*"+Iif(_qty=1,_item,_cqty+"x"+_item)

			Endif

		Else

			_item=GetItemString(_item,cdbf,_must_printAmt)		&&¨ú±oµæ¦¡¦WºÙ¤Îª÷ÃB¡]¸òSETTING)

		Endif

		ssql=csql


Endcase


If _slip=.F.

	_item=_code+_item		&&¬O§_¥´¦Lµæ¦¡½s¸¹¬Ýsettting
Endif


*!*	IF ll_kilo						&& kilo 2011.03.
*!*
*!*		_item=_Item+CHR(13)++"** "+ckilo
*!*
*!*	ENDIF


If _slip And Vartype(__slip_print_adduser)#"U"	And  !Empty(Field("adduser"))		&&¤Wµæ¯È¬O§_¦LÂIµæ¤H¤Î®É¶¡

	If __slip_print_adduser

		_dispord=_dispord+1

		_add_user_time="("+Trim(&cdbf..adduser)+Space(2)+Left(Ttoc(Iif(&cdbf..printed,&cdbf..printtime,Datetime()),2),5)+")"

		If  _print_to_local

			ssql=ssql+Chr(10)+"insert into slip_print_detail (code,qty,item,amount,dispord,item_unicode) values ('',0,_add_user_time,0,_dispord,'')"

		Else

			ssql=ssql+Chr(10)+"insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,'',0,?_add_user_time,0,?_dispord,'')"

		Endif


	Endif

Endif


*!*	IF &cdbf.costomer


*!*	ENDIF



If  _print_to_local

	If Alines(s,ssql,4,Chr(10))>0		&&¤À¸ÑSSQL

		Local i,lcCmd

		For i=1 To Alen(s)

			lcCmd=s(i)

			&lcCmd		&&°õ¦æ¥N½X


		Endfor


	Endif

Else

	If SQLExec(nhand,ssql)<0
		Aerror(err)

		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif

Endif


Return 1

Endfunc



****************************
*
* Function Load_order  ¸ü¤J¸¨³æ
*
*************************

Function load_order
Parameters  _curorder,_only_load_detail,_android,_so_add_order
Local ssql

UPDATE_holiday()

If !Used("work_order_tmp19")

	If create_order_database()=-1		&&¦pªGwork_order_tmp¤£¦s¦b¡A­«¸ü¼Æ¾ÚÀô¹Ò

		Return -1
	Endif

ENDIF



*---------------------	CRM APP  2018.08

IF  _android= .f. AND VARTYPE(__crm_app_active)#"U" AND __crm_app_active 

	IF SQLEXEC(nhand,"select  tableno,inv_id from order_main with (nolock) where id=?_curorder","cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	
	ENDIF

	_tableno = TRIM(cun_tmp.tableno)	
	IF crm_check_self_service(_tableno, _curorder)<0
	
		RETURN -1
		
	ENDIF
	
	
ENDIF
*-------------------------------

If _android

	ssql="select a.*,b.leveldiscadd from android_order_main a with (nolock) left join outlet b on a.outlet_id=b.id  where a.mark_id=?_curorder"		&& update 2009.09.29
	ssql=ssql+Chr(10)+"select a.*,b.printer as item_Printer from android_order_detail a with(nolock) left join item b on a.item_code=b.code where mark_id=?_curorder order by uid"
	ssql=ssql+Chr(10)+"select * from android_order_modi with (nolock) where mark_id=?_curorder order by dispord"

Else

	ssql="select a.*,b.leveldiscadd from order_main a with (nolock) left join outlet b on a.outlet_id=b.id  where a.id=?_curorder"		&& update 2009.09.29
	ssql=ssql+Chr(10)+"SELECT * FROM order_detail with (nolock) where id=?_curorder order by uid"
	ssql=ssql+Chr(10)+"select * from order_modi with (nolock) where id=?_curorder order by dispord"

Endif


If _only_load_detail=.F.		&&¬O§_¥u¸ü¤Jµæ¦¡¤Î¯S§O³B²z(¥Î©ó¿ïÂiªº¥\¯à:§Y°_µæ¦¡ «Ø¥ß¼Æ¾ÚÀô¹Ò)

	If _android

		ssql=ssql+Chr(10)+"select * from android_order_itemdisc with (nolock) where mark_id=?_curorder order by dispord"
		ssql=ssql+Chr(10)+"select * from android_order_disc with (nolock) where mark_id=?_curorder order by dispord"

	Else

		ssql=ssql+Chr(10)+"select * from order_itemdisc with (nolock) where id=?_curorder order by dispord"
		ssql=ssql+Chr(10)+"select * from order_disc with (nolock) where id=?_curorder order by dispord"

	Endif

Endif


If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif


If Eof("cun_tmp") And _so_add_order=.F.

	Return 1

Endif


If _android

	ssql="select * from android_order_itemdept with (nolock) where mark_id=?_curorder "			&& android

Else

	ssql="select * from order_itemdept with (nolock) where order_id=?_curorder "			&& 2009.12.10  ³¡ªù¤À±b

Endif


If SQLExec(nhand,ssql,"cun_tmp10")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

If _android

	ssql="select * from android_order_tax with (nolock) where mark_id=?_curorder "			&& 2010.06.29  ¦hµ|¶µ

Else

	ssql="select * from order_tax with (nolock) where id=?_curorder "			&& 2010.06.29  ¦hµ|¶µ
Endif


If SQLExec(nhand,ssql,"cun_tmp11")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif


Local lnLevelDiscAdd
lnLevelDiscAdd=Nvl(cun_tmp.leveldiscadd,0)		&&²Õ¦XÀu´f¥[»ù ¸ò°Ï°ì³]©w


If Vartype(__special_customer)#"U" And "whiteblack"$__special_customer		&&2012.10.18


	Public __order_Foreigner

	__order_Foreigner= Nvl(cun_tmp.isForeign,.F.)


Endif

*!*	_mincharge_mode=cun_tmp.mincharge_mode	&&³Ì§C®ø¶O¼Ò¦¡
*!*	_pplcnt=cun_tmp.pplcnt					&&¤H¼Æ


*----------------------
If _so_add_order	And Reccount("order_itemlist_tmp")>0	 	&&¦pªG¬O«á¥[¦¡¡A±NUID¥[¤j

	Select * From cun_tmp1  Into Cursor cun_tmp1  Readwrite
	Select * From cun_tmp2  Into Cursor cun_tmp2  Readwrite
	Select * From cun_tmp3  Into Cursor cun_tmp3  Readwrite
	Select * From cun_tmp10  Into Cursor cun_tmp10  Readwrite
	Select * From cun_tmp11  Into Cursor cun_tmp11  Readwrite

	IF USED("order_itemlist_repl_tmp") &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
		Select Max(uid) As max_id From (select uid FROM order_itemlist_tmp UNION select uid FROM order_itemlist_repl_tmp) a Into Array tmp_s
	ELSE 
		Select Max(uid) From order_itemlist_tmp Into Array tmp_s
	ENDIF 

	nMaxUid =Int(Nvl(tmp_s(1),0))+1

	Update cun_tmp1 Set uid =uid +  nMaxUid 		&& detail
	Update cun_tmp1 Set parent_id =parent_id +  nMaxUid Where parent_id >0		&& detail -- sitem

	Update cun_tmp2 Set item_id=item_id +  nMaxUid 	&& modi

	Update cun_tmp3 Set item_id=item_id +  nMaxUid 	&& itemdisc

	Update cun_tmp10 Set parent_id =parent_id+  nMaxUid 	&& itemdept
	Update cun_tmp11 Set item_id=item_id+  nMaxUid 	&& tax


Endif

*-------------------

Local _printer,_invdesccn,_invdescen,_desckit,_id,_spndesc,_undefine,_slip_print,_ckilo

Select cun_tmp1		&& order_detail  ¸¨³æ²Ó¸`
Scan


	_printer=IIF(_android , TRIM(cun_tmp1.item_printer) , Trim(cun_tmp1.Printer)) 
	
	&&Lihong 2020.05.13 
	IF _android AND ISNULL(_printer) OR EMPTY(_printer)
		_printer=Trim(cun_tmp1.Printer)
	ENDIF 
	
	_invdesccn=""
	_invdescen=""
	_desckit=""
	_sprinter=cun_tmp1.sprinter
	_id=Val(_sprinter)			&&«ü©wprinter
	_spndesc=""
	_handwriting=cun_tmp1.handwriting		&&¤â¼g³æ
	_ckilo=""
	If _handwriting
		_hand_desc=Trim(cun_tmp1.descdisp)
	Endif
	
	_itemID=cun_tmp1.item_id
	_item_code = TRIM(cun_tmp1.item_code)
	_cate_id = cun_tmp1.cate_id

	&&Lihong 2021.05.07 BarCode
	_print_single = NVL(cun_tmp1.print_single, .F.)
	_ordertime = cun_tmp1.ordertime
	

	IF  cun_tmp1.mitem AND cun_tmp1.undefine AND cun_tmp1.mitem_id<>-1 &&Lihong 2023.04.20 custom for sitem_sub : mitem_id<>-1
			
			
			SELECT * FROM work_order_tmp10 WHERE id =_itemID  INTO CURSOR cr_tmp &&¦h¿ï µæ

			&&Lihong 2022.09.27
			IF RECCOUNT("cr_tmp")=0
				=write_log(215,"No_item_for_mitem_1 id: "+TRANSFORM(_itemID)+", item_code: "+_item_code )
				If SQLExec(nhand,"select * from mitem with(nolock) where id =?_itemID","cr_tmp")<0
					Aerror(err)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				ENDIF
				&&Lihong 2022.09.27
				IF RECCOUNT("cr_tmp")=0
					=write_log(215,"No_item_for_mitem_2 id: "+TRANSFORM(_itemID)+", item_code: "+_item_code )
					SELECT cr_tmp
				ENDIF 
			ENDIF 
			
			_name_cn = TRIM(cr_tmp.desccn)
			_name_en = TRIM(cr_tmp.descen)
			
			USE IN cr_tmp	
		
			_desccn=getmessage("_undefine_item")	+"("+_name_cn  +")"
			_descen="Undefined Item"	+"("+_name_en  +")"	
			
			_descdisp = _desccn
			_invdesccn=_descen
			_invdescen=_descen
			_desckit=_descen
			_desc_other=_descen
			_descpole=""
			_allowdisc=.f.
			_slip_print=.f.				
			_mincharge=.f.			
			_turnup=.f.		
			_askdept=.f.
			_price4=0
			_joinitem=.f.
			_onlyone=.f.

			_timer_trigger=.f.
			_reprice =0
			_ecoupon =.f.

			_custom_item =.f.
			_limitqty =.f.

			_printer=""
			
	ELSE

			&&Lihong 2023.01.16 IF VARTYPE(__pso_order)#"U" AND _so_add_order=.T. &&AND VARTYPE(__pso_order_save_inv)="U" 
			&&Lihong 2022.03.23 ÂàªA°È¶O²v¡HÀ³¼W¥[AND _so_add_order¡G¨â¦¸load_order¡Aby mark_id¼Æ¾Ú¤~»Ý­n³o¼Ë¡A²{¦b¬OVARTYPE(__pso_order_save_inv)#"U"ªºby order_idªA°È¶O·|ÅÜ0,<>"U"ªº³£«ö²{¦b®É¶¡ºâ¤F
				&&Lihong 2022.12.02 «ì´_AND _so_add_order=.T. ¼W¥[AND VARTYPE(__pso_order_save_inv)="U"
			IF VARTYPE(__pso_order)#"U" AND _so_add_order=.T. &&Lihong 2023.01.16 ª`·N«á­±»Ý¦P¼Ë
				IF _itemID=-3
					SELECT * FROM work_order_tmp0 WHERE id=-3 INTO CURSOR pso_tmp
				ELSE 
					SELECT * FROM work_order_tmp WHERE UPPER(code) ==UPPER(_item_code)  INTO CURSOR pso_tmp
					IF _tally=0
						SELECT * FROM work_order_tmp0 WHERE UPPER(code) ==UPPER(_item_code)  INTO CURSOR pso_tmp
					ENDIF
				ENDIF 

				&&Lihong 2022.09.27
				IF RECCOUNT("pso_tmp")=0
					=write_log(215,"No_item_for_pso_1 id: "+TRANSFORM(_itemID)+", item_code: "+_item_code )
					If SQLExec(nhand,"select * from item with(nolock) where code=?_item_code","pso_tmp")<0
						Aerror(err)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1
					ENDIF
					&&Lihong 2022.09.27
					IF RECCOUNT("pso_tmp")=0
						=write_log(215,"No_item_for_pso_2 id: "+TRANSFORM(_itemID)+", item_code: "+_item_code )
						SELECT pso_tmp
					ENDIF 
				ENDIF 
				
				_itemID = pso_tmp.id
				_printer = TRIM(NVL(pso_tmp.printer,""))
				
				&&Lihong 2021.05.07 BarCode
				_print_single = NVL(pso_tmp.print_single, .F.)
				&&Lihong 2022.10.31 _ordertime = DATETIME()  
				

				&&Lihong 2019.12.04 ¼W¥[if = 0 
				IF NVL(_cate_id,0) = 0
					_cate_id = pso_tmp.cate_id
				ENDIF 

				IF VARTYPE(__pso_order_save_inv)#"U"	&& 2019.08.06
					
					_srv_per  = 0
					&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
					_srv_per_org  = 0
				ELSE
					
					&&Lihong 2022.03.23 ÂàªA°È¶O²v ¨â¦¸load_order¡A¹q¸£ªºorder¼Æ¾Ú_srv_per·|«ö²{¦b®É¶¡­«·sºâ¡A¿ù»~¡H
					_srv_per = get_srv_fee(_outlet_id,"pso_tmp")
					&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
					_srv_per_org  = _srv_per 
				
				ENDIF
				
				
				SELECT pso_tmp
			
			ELSE
				
				_srv_per = cun_tmp1.srv_per
				&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
				_srv_per_org  = cun_tmp1.srv_per_org &&NVL(cun_tmp1.srv_per_org, 0.00)
				
				Select work_order_tmp
				Seek _itemID
				&&Lihong 2022.09.27
				IF !FOUND("work_order_tmp")
					&&Lihong 2022.09.27
					=write_log(215,"No_item id: "+TRANSFORM(_itemID)+", item_code: "+_item_code +", for active: 1")
					SELECT work_order_tmp0
					LOCATE FOR id=_itemID
					&&Lihong 2022.09.27
					IF !FOUND("work_order_tmp0")
						=write_log(215,"No_item id: "+TRANSFORM(_itemID)+", item_code: "+_item_code +", for active: 0")
						SELECT work_order_tmp0
					ENDIF 
				ENDIF 
			
			
				&&Lihong 2019.12.04 ¼W¥[if = 0 
				IF NVL(_cate_id,0) = 0
					_cate_id = cate_id
				ENDIF 
			ENDIF


			_kilo=Iif(Isnull(kilo),.F.,kilo)	&&¬O§_«ö¤ç­pºâ		&&2009.06.10 //update 2014.06.30 
			_kilo2=Iif(Isnull(kilo2),.F.,kilo2)	&&¬O§_«ö¨â­pºâ		&&2014.06.30
			


			If _kilo OR _kilo2		&&¦pªG±Ä¥Î¤ç¨â­pºâ		2009.06.19 //2014.06.30
				Local lnQty

				lnQty=cun_tmp1.qty

				If Vartype( __kilo_unit)#"U" And __kilo_unit="K10"		&&¤Q¶i¨î
				
					IF  _kilo2 &&Lihong 2023.03.20 &&«ö¨â­p(­ì¨Ó¤è¦¡©l²×«ö¨â)
						_ckilo	=Iif(Int(lnQty/10)>0 ,Alltrim(Str(Int(lnQty/10)))+getmessage("_kilo"),"")+;
							IIF(Mod(lnQty,10)>0,Alltrim(Str(Mod(lnQty,10)))+getmessage("_kilo2"),"")
					ELSE &&Lihong 2023.03.20 ¼W¥[«ö¤ç­p
						_ckilo	="("+IIF(INT(lnQty)>0 ,ALLTRIM(STR(INT(lnQty)))+getmessage("_kilo"),"")+;
							IIF(MOD(lnQty,1)>0,ALLTRIM(STR(MOD(lnQty,1)*10,2,0)) + getmessage("_kilo2"),"")+")"
					ENDIF 

				Else		&&¹w³]¬°¤Q¤»¶i¨î

						
						IF  _kilo2		&&«ö¨â­p

							_ckilo	="("+IIF(INT(lnQty/16)>0 ,ALLTRIM(STR(INT(lnQty/16)))+getmessage("_kilo"),"")+;
									IIF(MOD(lnQty,16)>0,ALLTRIM(STR(MOD(lnQty,16)))+getmessage("_kilo2"),"")+")"
						
						ELSE		&&«ö¤ç­p
						
							_ckilo	="("+IIF(INT(lnQty)>0 ,ALLTRIM(STR(INT(lnQty)))+getmessage("_kilo"),"")+;
									IIF(MOD(lnQty,1)>0,ALLTRIM(STR(MOD(lnQty,1)*16,2,0)) + getmessage("_kilo2"),"")+")"
									
						ENDIF

					

				Endif


			Endif
			
			
			&&Lihong 2023.01.16 IF VARTYPE(__pso_order)#"U" AND _so_add_order=.T. AND VARTYPE(__pso_order_save_inv)="U"
			IF VARTYPE(__pso_order)#"U" AND _so_add_order=.T. 
				SELECT pso_tmp
				
				_level_id = level_id
				_drink_qty = drink_qty
				
				&&Lihong 2020.09.08
				IF cun_tmp1.drink_qty>0
					_drink_qty  = cun_tmp1.drink_qty
				ENDIF 
			ELSE
				_level_id  = cun_tmp1.level_id
				_drink_qty  = cun_tmp1.drink_qty
				
				Select work_order_tmp
				IF eof("work_order_tmp")
					Select work_order_tmp0
				ENDIF 
			ENDIF
			

			_descen=Trim(Descen)		&& 2011.04.15
			_desccn=Trim(desccn)		&& 2011.06.01
		*	_Printer=Printer
			_invdesccn=Trim(descinvcn)+Iif(Empty(_ckilo),"",Chr(13)+_ckilo)
			_invdescen=Trim(descinven)+Iif(Empty(_ckilo),"",Chr(13)+_ckilo)
			_desckit=Trim(desckit)+Iif(Empty(_ckilo),"",Chr(13)+_ckilo)
			_desc_other=Iif(Isnull(desc_other),'',Trim(desc_other))+Iif(Empty(_ckilo),"",Chr(13)+_ckilo) 
			_descpole=Trim(descpole)
			_allowdisc=disc
			&&LIhong 2021.03.24 ®MÀ\¤l¶µdisc¸ò´ß¡A¦]¬°ÂIµæ¥[¤J¬O¸ò´ß¡A¼È³o¼Ë¡]¥i¯àÀ³¸Ó¬O.F.§ó¦n¡^
			IF cun_tmp1.sitem_sub = .T. 
				lnparent_id = cun_tmp1.parent_id
				IF _android
					IF VARTYPE(__pso_order)#"U"
						SELECT a.disc FROM work_order_tmp a RIGHT JOIN cun_tmp1 b ON ALLTRIM(a.code)==ALLTRIM(b.item_code) WHERE b.uid = lnparent_id ;
						INTO ARRAY Aparent_disc
						IF _tally > 0 AND !ISNULL(Aparent_disc[1])
							_allowdisc=Aparent_disc[1]
						ELSE
							SELECT a.disc FROM work_order_tmp0 a RIGHT JOIN cun_tmp1 b ON ALLTRIM(a.code)==ALLTRIM(b.item_code) WHERE b.uid = lnparent_id ;
							INTO ARRAY Aparent_disc
							IF _tally > 0
								_allowdisc=Aparent_disc[1]
							ENDIF 
						ENDIF 
						
					ELSE
						SELECT a.disc FROM work_order_tmp a RIGHT JOIN cun_tmp1 b ON a.id=b.item_id WHERE b.uid = lnparent_id ;
						INTO ARRAY Aparent_disc
						IF _tally > 0
							_allowdisc=Aparent_disc[1]
						ELSE
							SELECT a.disc FROM work_order_tmp0 a RIGHT JOIN cun_tmp1 b ON a.id=b.item_id WHERE b.uid = lnparent_id ;
							INTO ARRAY Aparent_disc
							IF _tally > 0
								_allowdisc=Aparent_disc[1]
							ENDIF 
						ENDIF 
					ENDIF 
				ELSE 
					*lnrecno = RECNO("cun_tmp1")
					SELECT disc FROM cun_tmp1 WHERE uid = lnparent_id INTO ARRAY Aparent_disc
					IF _tally > 0
						_allowdisc=Aparent_disc[1]
					ENDIF 
				ENDIF 
				_allowdisc = NVL(_allowdisc, .F.)
				*GO lnrecno
			ENDIF 
			
			_slip_print=NVL(slip_Print	, .F.)			&&¬O§_¦C¦L²M³æ(¤Wµæ¯È) &&Lihong 2020.04.13 NVL
			_mincharge=NVL(mincharge, .F.)				&&¬O§_­p¤J³Ì§C®ø¶O &&Lihong 2020.04.13 NVL
			_turnup=Nvl(turnup,.F.)		&& ¬O§_¤¹³\Âà»ù		&&2008.11.27
			_askdept=Nvl(askdept,.F.)
			&&Lihong 2023.04.17
			IF cun_tmp1.sitem_sub = .F.  AND NVL(cun_tmp1.askdept,.F.)=.T. &&VARTYPE(__change_item_set_detail)#"U" AND __change_item_set_detail AND 
				_askdept=.T.
			ENDIF 
			
			&&Lihong 2022-01-12 
			IF cun_tmp1.sitem_sub = .T. 
				_askdept=.F.
			ENDIF 
			
			_price4=Nvl(price4,0)
			_joinitem=Nvl(joinitem,.F.)
			_onlyone=Nvl(onlyone,.F.)

			_timer_trigger=Nvl(timer_begtrigger,.F.)
			_reprice =Nvl(reprice,0)
			_ecoupon =Nvl(ecoupon,.F.)

			_custom_item =Nvl(Custom,.F.)
			_limitqty =NVL(limitqty,.F.)
			
			
			
			

		*	_gift=NVL(gift,.f.)					&&¬O§_Â§«~

			If _handwriting						&&¤â¼g³æ
				_invdesccn=_hand_desc
				_invdescen=_hand_desc
				_desckit=_hand_desc
				_desccn = _hand_desc
				_descen = _hand_desc	
			Endif

			If _custom_item 		&&¦Û©w¸qitem

				_invdesccn=cun_tmp1.descdisp
				_invdescen=cun_tmp1.descdisp
				_desckit=cun_tmp1.descdisp
				
				_descdisp = _invdesccn
			
			ELSE
			
				_descdisp = IIF(VARTYPE(__order_langue)#"U" AND __order_langue="CN",_desccn,_descen)	&&Åã¥Ü¸ò»y¨¥³]©w  2017.05.11
			
			Endif


			If _id>0					&&«ü©w¥´¦L¾÷
				Select work_order_tmp12
				Locate For Id=_id
				If Found()
					_spndesc=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))
					_printer=Alltrim(Str(_id))
				Endif
			ELSE
	*			_printer = TRIM(NVL(cun_tmp1.printer,""))
			Endif
			If Isnull(_printer)
				_printer=""
			Endif
	
	ENDIF
	
	&&Lihong 2023.02.17
	IF EMPTY(_descdisp)
		_descdisp = TRIM(cun_tmp1.descdisp)
	ENDIF 

*		_undefine=(EMPTY(cun_tmp1.item_code) AND cun_tmp1.printed=.f.)		&&¥¼©wµæ¦¡
	&&Lihong 2020.06.01 coupon: cloud_coupon_id, web_coupon_id, web_coupon_code 
	&&Lihong 2022.03.17 ¨Ò®uorgqty_case_mat
	&&Lihong 2023-06-02 ¼pÅã kit_disp_uid 
	Insert Into  order_itemlist_tmp (uid,parent_id,cate_id,item_id,item_code,descdisp,qty,price,orgamt,;
		amount,real_amount,sitem,sitem_sub,mitem,mustmodi,hold,printed,printtime,adduser,modi_list,;
		modi_amount,disc_amount,srv_per,srv_amount,tax_per,tax_amount,level_id,drink_qty,Show,sprinter,spn_desc,;
		Printer,descinvcn,descinven,desckit,remin_times,Undefine,onlysave,disc,hhqty,hhprice,handwriting,mitem_id,slip_Print,mincharge,;
		timer_active,timer_style,free_hours,free_style,timer_begtime,timer_endtime,timer_mincharge,timer_disc,;
		desc_other,material,orgsrv,price0,turnup,org_price,tax2,points,pointed,kilo,level_disc,leveldiscadd,askdept,;
		item_warning,warning_begtime,warning_endtime,warning_inMinute,Descen,descpole,price4,joinitem,pre_price,sub_amt,desccn,;
		gift,giftred,transnumber,tel,member_number,onlyone,ordertime,timer_trigger,reprice,ecoupon,price_mc,modi_need,modi_must,modi_def,amtinv,save_type,delay_minute,limitqty,kilo2,fix_price, ;
		coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code, print_single, same_tableno, orgqty_case_mat, price_type, qty_entity, add_user_id, add_user_station_id,srv_per_org, ;
		kit_disp_uid, to_printer, has_hold );
		values (cun_tmp1.uid,cun_tmp1.parent_id,_cate_id, _itemID ,cun_tmp1.item_code,;
		_descdisp ,NVL(cun_tmp1.qty,1),cun_tmp1.price,cun_tmp1.orgamt,cun_tmp1.amount,cun_tmp1.real_amount,;
		cun_tmp1.sitem,cun_tmp1.sitem_sub,cun_tmp1.mitem,cun_tmp1.mustmodi,;
		cun_tmp1.hold,cun_tmp1.printed,cun_tmp1.printtime,cun_tmp1.adduser,;
		cun_tmp1.modi_list,cun_tmp1.modi_amount,cun_tmp1.disc_amount*-1,;
		_srv_per,cun_tmp1.srv_amount,cun_tmp1.tax_per,cun_tmp1.tax_amount,_level_id,_drink_qty,.T.,;
		_sprinter,_spndesc,_printer,_invdesccn,_invdescen,_desckit,;
		IIF(Isnull(cun_tmp1.remin_times),0,cun_tmp1.remin_times),cun_tmp1.Undefine,cun_tmp1.onlysave,_allowdisc,;  && NVL(cun_tmp1.disc,.f.)
		IIF(Isnull(cun_tmp1.hhqty),0,cun_tmp1.hhqty),Iif(Isnull(cun_tmp1.hhprice),0,cun_tmp1.hhprice),_handwriting,;
		IIF(Isnull(cun_tmp1.mitem_id),0,cun_tmp1.mitem_id),_slip_print,_mincharge,;
		cun_tmp1.timer_active,cun_tmp1.timer_style,cun_tmp1.free_hours,cun_tmp1.free_style,;
		cun_tmp1.timer_begtime,cun_tmp1.timer_endtime,cun_tmp1.timer_mincharge,cun_tmp1.timer_disc,_desc_other,;
		IIF(Isnull(cun_tmp1.material),.F.,cun_tmp1.material),Iif(Isnull(cun_tmp1.orgsrv),.F.,cun_tmp1.orgsrv),;
		IIF(Isnull(cun_tmp1.price0),cun_tmp1.price,cun_tmp1.price0),_turnup,Iif(Isnull(cun_tmp1.org_price),cun_tmp1.price,cun_tmp1.org_price),;
		IIF(Isnull(cun_tmp1.tax2),0,cun_tmp1.tax2),;
		IIF(Isnull(cun_tmp1.points),0,cun_tmp1.points),;
		IIF(Isnull(cun_tmp1.pointed),.F.,cun_tmp1.pointed),_kilo,cun_tmp1.level_disc,lnLevelDiscAdd,_askdept,;
		NVL(cun_tmp1.item_warning,.F.),Nvl(cun_tmp1.warning_begtime,"00:00"),Nvl(cun_tmp1.warning_endtime,"00:00"),;
		NVL(cun_tmp1.warning_inMinute,0.00),_descen,_descpole,_price4,_joinitem,Nvl(cun_tmp1.pre_price,0.00),;
		NVL(cun_tmp1.sub_amt,0.00),_desccn,;
		Nvl(cun_tmp1.gift,.F.),Nvl(cun_tmp1.giftred,.F.),Nvl(cun_tmp1.transnumber,''),;
		Nvl(cun_tmp1.tel,""),Nvl(cun_tmp1.member_number,""),_onlyone,_ordertime, _timer_trigger,_reprice,_ecoupon,Nvl(cun_tmp1.price_mc,0),;
		NVL(cun_tmp1.modi_need,""),Nvl(cun_tmp1.modi_must,""),Nvl(cun_tmp1.modi_def,""),Nvl(cun_tmp1.amtinv,.F.),Nvl(cun_tmp1.save_type,""),;
		NVL(cun_tmp1.delay_minute,0),_limitqty,_kilo2,NVL(cun_tmp1.fix_price,.f.), ;
		cun_tmp1.coupon_lock_valid, NVL(cun_tmp1.cloud_coupon_id,0), cun_tmp1.web_coupon_id, NVL(cun_tmp1.web_coupon_code,""), _print_single, ;
		NVL(cun_tmp1.same_tableno,""), NVL(cun_tmp1.orgqty_case_mat,0), NVL(cun_tmp1.price_type,0), NVL(cun_tmp1.qty_entity,0), NVL(cun_tmp1.add_user_id,0), ;
		NVL(cun_tmp1.add_user_station_id,0),_srv_per_org, cun_tmp1.kit_disp_uid, NVL(cun_tmp1.to_printer, ""), NVL(cun_tmp1.has_hold, .F.) )


Endscan

If _android	&& ³B²zandroid°e³æ«ásave order ¦L¤Wµæ¯Èªº°ÝÃD

	Update order_itemlist_tmp Set just_send=.T. Where uid In (Select uid From cun_tmp1 Where Id=0)

*!*	ELSE

*!*		UPDATE order_itemlist_tmp SET save_type=""


Endif

Select cun_tmp1
Use

Update order_itemlist_tmp Set descinvcn=descdisp,descinven=descdisp,desckit=descdisp  Where item_id=-3		&&³Ì§C®ø¶O

Local  _def_id,_modi_id,_def
Select cun_tmp2	&& order_modi  ¶µ¥Ø¯S§O³B²z
SCAN

	_modi_id=cun_tmp2.modi_id
	_def_id=cun_tmp2.def_id
	_open_modi=cun_tmp2.open_Modi		&&¬O§_¦Û©w¯S§O³B²z

	Select work_order_tmp20
	Locate For Id=_def_id

	If Found()

		_def=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

	Else

		_def=""

	Endif
	
	Select * From work_order_tmp4 Where Id=_modi_id Into Cursor cun_tmp21

	IF _modi_id=-999
		
		_invdesccn = TRIM(cun_tmp2.descdisp)
		_invdescen = _invdesccn &&Lihong 2023.07.03 _invdescen 
		_desckit	      = _invdesccn &&Lihong 2023.07.03 _invdescen 
		_desc_other = _invdesccn &&Lihong 2023.07.03 _invdescen 
		_modi_per=Iif(Isnull(cun_tmp2.modi_per),0,cun_tmp2.modi_per)
	
	ELSE
	
		_invdesccn=Iif(_open_modi,Trim(cun_tmp2.descdisp),_def+Trim(cun_tmp21.descinvcn))
		_invdescen=Iif(_open_modi,Trim(cun_tmp2.descdisp),_def+" "+Trim(cun_tmp21.descinven))
		_desckit=Iif(_open_modi,Trim(cun_tmp2.descdisp),_def+Trim(cun_tmp21.desckit))
		_desc_other=Iif(_open_modi ,Trim(cun_tmp2.descdisp),Iif(Isnull(cun_tmp21.desc_other),'',_def+Trim(cun_tmp21.desc_other)))
		_modi_per=Iif(Isnull(cun_tmp2.modi_per),0,cun_tmp2.modi_per)

	ENDIF
	

	Insert Into  item_modi_tmp (uid,item_id,modi_id,modi_qty,modi_price,descdisp,modi_amount,modi_per,def_id,descinvcn ,descinven ,desckit,multqty,modi_idx,open_Modi,desc_other,;
		modi_need ,modi_must ,modi_idx ,def_idx ,modi_parentid) Values ;
		(Sys(2015),cun_tmp2.item_id,cun_tmp2.modi_id,cun_tmp2.modi_qty,cun_tmp2.modi_price,cun_tmp2.descdisp,cun_tmp2.modi_amount,_modi_per,;
		cun_tmp2.def_id,_invdesccn,_invdescen,_desckit,cun_tmp2.multqty,cun_tmp2.dispord,_open_modi,_desc_other,Nvl(cun_tmp2.modi_need,.F.) ,Nvl(cun_tmp2.modi_must,.F.),;
		NVL(cun_tmp2.modi_idx,0),Nvl(cun_tmp2.def_idx,""),cun_tmp21.parent_id)


Endscan
Select cun_tmp2
Use
If Used("cun_tmp21")
	Select cun_tmp21
	Use


Endif

If _only_load_detail		&&¥u¸ü¤Jitem¤Î¯S§O³B²z,¤£¸ü¤J§é¦©

	Return 1
Endif


Select cun_tmp3		&&order_itemdisc   ¶µ¥Ø§é¦©
Scan

	Select  Iif(_system_langue="CN",desccn,Descen) As descdisp From work_order_tmp5 Where Id=cun_tmp3.disc_id Into Array tmp_s
	If _Tally>0
		_desc=tmp_s(1,1)

		&&Lihong 2020.06.02 coupon    coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code
		Insert Into item_disc_tmp (uid,item_id,disc_id,disc_type,descdisp,disc_per,disc_amount,member_id,adduser,disc_reason,disc_remark,disc_qty,minamt,dedu_srv, coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code,after_inv) Values ;
			(Sys(2015),cun_tmp3.item_id,cun_tmp3.disc_id,cun_tmp3.disc_type,_desc,cun_tmp3.disc_per,cun_tmp3.disc_amount,cun_tmp3.member_id,;
			cun_tmp3.adduser,NVL(cun_tmp3.disc_reason,0),NVL(cun_tmp3.disc_remark,""),cun_tmp3.disc_qty,Nvl(cun_tmp3.minamt,0),Nvl(cun_tmp3.dedu_srv,.F.), cun_tmp3.coupon_lock_valid, NVL(cun_tmp3.cloud_coupon_id,0), cun_tmp3.web_coupon_id, NVL(cun_tmp3.web_coupon_code,""), NVL(cun_tmp3.after_inv,.F.) )
	Else
*!*			fmessagebox("_unknow_error")
*!*			RETURN -1
	Endif


Endscan
Select cun_tmp3
Use


Select cun_tmp4		&&order_disc            ¾ã³æ§é¦©
Scan



	If member_id>0	Or !Empty(member_number)	&&¦pªG¬O·|­û§é¦©		2010.01.11

		_desc=getmessage("_member_disc")

	Else

		Select  Iif(_system_langue="CN",desccn,Descen) As descdisp From work_order_tmp5 Where Id=cun_tmp4.disc_id Into Array tmp_s

		If _Tally>0
			_desc=tmp_s(1)
		Else

			Loop

		Endif
	Endif


	Select disclevel From work_order_tmp5 Where Id=cun_tmp4.disc_id Into  Array tmp_s
	If _Tally>0

		_disc_level=Trim(tmp_s(1))
	Else

		_disc_level=Iif(cun_tmp4.disc_id= -99,"all", "") &&Lihong 2023-08-10 ¥ý¹F·|­û§é¦© disc_id= -1 -> -99
	Endif

	Insert Into order_disc_tmp (uid,disc_id,disc_type,descdisp,disc_per,disc_amount,member_id,adduser,disc_level,disc_reason,disc_remark,disc_qty,autodisc,points,member_number,member_name,minamt,dedu_srv,after_inv) Values ;
		(Sys(2015),cun_tmp4.disc_id,cun_tmp4.disc_type,_desc,cun_tmp4.disc_per,cun_tmp4.disc_amount,cun_tmp4.member_id,;
		cun_tmp4.adduser,_disc_level,Nvl(cun_tmp4.disc_reason,0),Nvl(cun_tmp4.disc_remark,""),cun_tmp4.disc_qty,Iif(Isnull(cun_tmp4.autodisc),.F.,cun_tmp4.autodisc),;
		nvl(cun_tmp4.points,0),Nvl(cun_tmp4.member_number,""),Nvl(cun_tmp4.member_name,""),Nvl(cun_tmp4.minamt,0),Nvl(cun_tmp4.dedu_srv,.F.),Nvl(cun_tmp4.after_inv,.F.))


Endscan
Select cun_tmp4
Use


*-------------------------------2009.12.10  ³¡ªù¤À±b
Select cun_tmp10
Scan

	Insert Into order_dept_tmp (parent_id,item_id,dept_id,amount,srvamt) Values (cun_tmp10.parent_id,cun_tmp10.item_id,cun_tmp10.dept_id,cun_tmp10.amount,cun_tmp10.srvamt)


Endscan

Use In cun_tmp10

*----------------------------- 2010.06.29  ¦hµ|¶µ
Select cun_tmp11
Scan
	Insert Into  order_tax_tmp (parent_id ,tax_id ,tax_per ,amount ) Values (cun_tmp11.item_id,cun_tmp11.tax_id,cun_tmp11.tax_per,cun_tmp11.tax_amount)


Endscan

Use In cun_tmp11


Select uid From order_itemlist_tmp  Where uid>9999 Into Cursor cun_tmp
If _Tally>0


*SET DECIMALS TO 5



	Local lnUid,lnUid2

	lnUid2=0
	Select uid,parent_id From order_itemlist_tmp Into Cursor cun_tmp

	Select cun_tmp
	Scan

		lnUid = cun_tmp.uid

		If cun_tmp.parent_id=0

			lnUid2 = lnUid2 +1

		Else

			lnUid2 =  lnUid2 +0.00001

		Endif


		Update order_itemlist_tmp Set uid =lnUid2 Where uid = lnUid
		Update order_itemlist_tmp Set parent_id = lnUid2 Where parent_id= lnUid

		Update item_disc_tmp Set item_id = lnUid2  Where item_id = lnUid
		Update item_modi_tmp Set item_id = lnUid2 Where item_id = lnUid

		Update order_dept_tmp Set parent_id =lnUid2  Where parent_id= lnUid
		Update order_tax_tmp Set parent_id = lnUid2 Where parent_id= lnUid



	Endscan


	Select Min(uid) As min_uid From order_itemlist_tmp Into Cursor cun_tmp

	If cun_tmp.min_uid>1

		_min_uid =cun_tmp.min_uid

		Update order_itemlist_tmp Set uid =uid -_min_uid
		Update item_disc_tmp Set item_id = item_id - _min_uid
		Update item_modi_tmp Set item_id = item_id - _min_uid
		Update order_dept_tmp Set parent_id = parent_id -  _min_uid
		Update order_tax_tmp Set parent_id = parent_id -  _min_uid


	Endif

*SET DECIMALS TO 2


Endif




Return 1

Endfunc
************************
*	Function slip_print
*
*	²M³æ¥´¦L
************************
Function slip_Print
Lparameters _order_id,_printer,_print_all,_voiditem,_print_barcode, _print_en  		&&_printer¥´¦L¾÷¦WºÙ ,_Print_all±j¨î¥þ³¡¥´¦L,_voiditem¬°¨ú®øµæ¦¡±¡ªp

Local  _table_name,_table_info


If Vartype(_android_station)#"U"  

	_slip_print_to_local=.F.

Else

	_slip_print_to_local=check_local_printer(_printer)

ENDIF

IF  VARTYPE(_html_fileName)="C"

	_slip_print_to_local =.t.

ENDIF

IF VARTYPE(_work_order_fastfood_slip_print)="U" OR VARTYPE(llfastfood_order_do_hold)#"U" &&Lihong 2022.09.13 ÂIµæ¯È

If SQLExec(nhand,"select * from order_main with(nolock) where id=?_order_id","cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

ENDIF

ELSE 
	SELECT * from fastfood_slip_order_main_tmp into CURSOR cun_tmp READWRITE 
	USE IN SELECT("fastfood_slip_order_main_tmp") 
	SELECT cun_tmp 
ENDIF 

IF EOF("cun_tmp")

	RETURN -1
ENDIF

llis_fastfood = EMPTY(cun_tmp.tableno)

_tel=Trim(Nvl(cun_tmp.tel,""))

If !Empty(_tel)
	_addr=getaddress(_tel)


Else

	_addr=""

ENDIF 


lnInv_id =cun_tmp.inv_id
_tableno=Trim(cun_tmp.tableno)

&&Lihong 2020.05.29 android¥~½æ¤Wµæ¯È
_tableno=IIF(EMPTY(_tableno), Trim(cun_tmp.askno), _tableno)

_memb_id=cun_tmp.memberno
_pplcnt=cun_tmp.pplcnt								&&¤H¼Æ

_discamt=cun_tmp.discamt		&&¾ã³æ§é¦©ª÷ÃB

_amount=cun_tmp.amount		&&¤p­pª÷ÃB
_srvamt=cun_tmp.srvamt
_taxamt=cun_tmp.taxamt
_rndamt=cun_tmp.rndamt
_invamt=cun_tmp.invamt 
_itemdiscamt=cun_tmp.itemdiscamt

_table_name=""
_timer_endtime=""
_timer_begtime=cun_tmp.begintime	

_sittime =cun_tmp.begintime 		&&¤J®y®É¶¡ 

IF VARTYPE(_work_order_fastfood_slip_print)="U" &&Lihong 2022.09.13 ÂIµæ¯È

If SQLExec(nhand,"select * from tables with(nolock)  where tableno=?_tableno and nsubtable=0","cun_tmp")<0 &&Lihing 2022.04.14 ¼W¥[ and nsubtable=0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

Endif

&&Lihing 2022.04.14 ¤Wµæ¤Wµæ¦LQrcode
lnoutlet_id = cun_tmp.outlet_id

If __slip_print_table_name

	_table_name=Trim(cun_tmp.Name)

Endif

_check_valid = TRIM(NVL(cun_tmp.check_valid ,""))

_sitting_endtime  = ""

IF LOWER(__special_customer)="urawa"
	
	_sitting_endtime  = LEFT(TTOC(_sittime + NVL(cun_tmp.timer_minutes,0)* 60,2),5)
	
ENDIF

ELSE 
	lnoutlet_id = 0
	If __slip_print_table_name
		_table_name=""
	ENDIF
	_check_valid = ""
	_sitting_endtime  = ""
ENDIF 


Select uid From order_itemlist_tmp Where timer_active  Into Cursor cun_tmp 	&&¬O§_¦³­p®Éªº¶µ¥Ø
If _Tally>0


	Select ordertime From order_itemlist_tmp Where 	timer_active And timer_trigger Into Cursor  cun_tmp Order By ordertime
	If _Tally>0

		_timer_begtime=cun_tmp.ordertime

		
	ENDIF


	SELECT 	SUM(free_hours) as free_hours FROM order_itemlist_tmp WHERE timer_style=2 AND timer_begtime="00:00" AND timer_endtime="23:59" INTO CURSOR cun_tmp
	_timer_free_hours = NVL(cun_tmp.free_hours,0)
	
	_timer_endtime=IIF(_timer_free_hours=0,"",  getmessage("_date_end")+":"+ LEFT( TTOC(_timer_begtime + _timer_free_hours*3600,2),5))
	
	
ELSE
	
	
	IF VARTYPE(__order_endtime) #"U" AND   __order_endtime>0
	
		_timer_endtime=getmessage("_end_time")+":"+LEFT( TTOC(_timer_begtime+ __order_endtime*60,2),5)
	
	
	ENDIF
	
	
ENDIF





*!*	SELECT uid FROM order_itemlist_tmp WHERE timer_style=2  INTO ARRAY tmp_s

*!*	IF _tally>0


*!*		_timer_endtime=IIF( EMPTY(NVL(timer_endtime,"")) , "" ,  getmessage("_date_end")+":"+  LEFT(TTOC(cun_tmp.timer_endtime,2), 5)) 
*!*		
*!*		
*!*	ENDIF




_member_name=""
_member_no=""

If _memb_id>0
	ssql="select member.*,member_type.default_disc from member join member_type on member.type_id=member_type.id where member.id=?_memb_Id order by member.id"

	If SQLExec(nhand,ssql,"cun_tmp")<0

		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	Endif

	_member_name=Trim(cun_tmp.name_cn)
	_member_no=Trim(cun_tmp.cardno)

Else

	If SQLExec(nhand,"select member_name,member_number from order_disc where id=?_order_id and member_number<>'' ","cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	If !Eof("cun_tmp")

&&¦pªG¦³·|­û§é¦©

		_member_name=Alltrim(cun_tmp.member_name)
		_member_no=Alltrim(cun_tmp.member_number)


	Endif


Endif


Select order_itemlist_tmp
Count To N For printed AND just_send=.F.  &&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯Èbug : ¼W¥[ AND just_send=.F. 

*SUM amount TO _amount		&&ªÙ­pª÷ÃB
 
If N=0	Or _print_all &&²Ä¤@¦¸(©Î¥þ³¡¥´¦L)
	If _voiditem
		_rem=getmessage("_slip_change")

	Else

		_rem=""
	Endif

Else

	Select order_itemlist_tmp
	Count To N For printed=.F. OR just_send=.T.  &&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯Èbug
	
	
	IF n=0 AND (__slip_print_mode = "new" OR __slip_print_mode = "all")	&& fix bug  2019.11.19 &&Lihong 2020.04.20 OR __slip_print_mode = "all" : ¦ýµLnew item ¤£¥´¦L
	
		RETURN 0
	ENDIF
	

	If  ( N=0 Or Vartype(__new_order_send)#"U" 	) 	And   Vartype(__old_order_send)="U"		&& sss

		_rem=""

	Else

		_rem=Iif(__slip_print_mode="new",getmessage("_slip_new"),getmessage("_slip_change"))		&& ·s¥[/§ó§ï

	Endif


	Release __new_order_send	,__old_order_send

Endif


&&Lihong 2020.11.09 §ï¬°¡G¸ò_system_langue(android¦bavs¨½¤w³]©w¬°¶Ç¤J±o»y¨¥)
*_clangue=Iif(Upper(__slip_content)="EN","EN","CN")		&&»y¨¥
_clangue=_system_langue

If _print_en  		&&±j¨î¦L­^¤å³æ

	_clangue="EN"
Endif

_table_info=_tableno+Iif(!Empty(_table_name) And __slip_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)

_Pid="LST"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")

_slip_sitem = .F.
_mprinter="0"
_dispord=1

_nitem=0

_pre_setting = __kitchen_order
__kitchen_order = __slip_content 		&&¤Wµæ¯Èªº¥´¦L¤º®e

If _print_en  		&&±j¨î¦L­^¤å³æ

	__kitchen_order ="EN"

Endif

If Vartype(__slip_print_on_dept)#"U" And __slip_print_on_dept		&&¦pªG¤Wµæ¯È«ö³¡ªù±Æ§Ç

	If SQLExec(nhand,"select * from itemdept","itemdept_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	Endif
	
	&&Lihong 2022.09.27 ¼W¥[ cc  &&Lihong 2023.05.05 alway_print_0_amt
	&&Lihong 2022.10.07 
*!*		Select a.*,b.dept_id ,IIF(ISNULL(c.id),cc.invlst_noprint,c.invlst_noprint) as invlst_noprint,IIF(ISNULL(c.id),cc.invlst_zeronoprint,c.invlst_zeronoprint) as invlst_zeronoprint From order_itemlist_tmp a Left Join itemdept_tmp b On a.item_id=b.item_id ;
*!*		LEFT JOIN  work_order_tmp c ON a.item_id=c.id LEFT JOIN  work_order_tmp0 cc ON a.item_id=cc.id ;
*!*		Order By b.dept_id,a.item_code Into Cursor slip_itm_tmp READWRITE 
	Select a.*,CAST(0 as int) as dept_id ,IIF(ISNULL(c.id),cc.invlst_noprint,c.invlst_noprint) as invlst_noprint,IIF(ISNULL(c.id),cc.invlst_zeronoprint,c.invlst_zeronoprint) as invlst_zeronoprint,;
	IIF(ISNULL(c.id),cc.alway_print_0_amt,c.alway_print_0_amt) as alway_print_0_amt From order_itemlist_tmp a ;
	LEFT JOIN  work_order_tmp c ON a.item_id=c.id LEFT JOIN  work_order_tmp0 cc ON a.item_id=cc.id ;
	Into Cursor slip_itm_tmp READWRITE 
	
	*SELECT RECNO() as sn,* FROM itemdept_tmp ORDER BY sn DESC INTO CURSOR itemdept_tmp 
	UPDATE a SET a.dept_id = NVL(b.dept_id,0) from slip_itm_tmp a left join itemdept_tmp b on a.item_id=b.item_id WHERE a.parent_id=0
	UPDATE a SET a.dept_id = NVL(b.dept_id,0) from slip_itm_tmp a left join slip_itm_tmp b on INT(a.uid)=b.uid WHERE a.parent_id<>0
	SELECT * FROM slip_itm_tmp Order By dept_id,uid,item_code Into Cursor slip_itm_tmp

Else
	&&Lihong 2022.09.27 ¼W¥[ bb &&Lihong 2023.05.05 alway_print_0_amt
	Select a.*,IIF(ISNULL(b.id),bb.invlst_noprint,b.invlst_noprint) as invlst_noprint,IIF(ISNULL(b.id),bb.invlst_zeronoprint,b.invlst_zeronoprint) as invlst_zeronoprint,;
	IIF(ISNULL(b.id),bb.alway_print_0_amt,b.alway_print_0_amt) as alway_print_0_amt From order_itemlist_tmp a LEFT JOIN work_order_tmp b ON a.item_id=b.id ;
	LEFT JOIN work_order_tmp0 bb ON a.item_id=bb.id Into Cursor slip_itm_tmp


Endif

&&Lihong 2022.09.13 ¯ùªã±Æ«á
SELECT slip_itm_tmp
&&Lihong 2022.09.13 ¯ùªã±Æ«á
IF VARTYPE(__cup)#"U" AND __cup AND VARTYPE(_vs_all_style_save_order)="U" AND llis_fastfood=.F.
	lccup_item_ids = ""
	*!*	_outlet_id=cun_tmp.outlet_id
	*!*	IF Used("work_order_tmp9")=.F. Or Get_table_updateno("outlet")<0
	*!*		ssql="select * from outlet with (nolock)"
	*!*		If SQLExec(nhand,ssql,"work_order_tmp9")<0
	*!*			Aerror(err)
	*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	*!*			Return .F.
	*!*		Endif
	*!*		SELECT * FROM work_order_tmp9 INTO CURSOR work_order_tmp9 READWRITE 
	*!*		UPDATE work_order_tmp9 SET item_id_cup_list="" WHERE ISNULL(item_id_cup_list)
	*!*	Endif
	SELECT work_order_tmp9 &&Àç·~°Ï°ì
	LOCATE FOR id = lnoutlet_id
	IF FOUND() AND !EMPTY(NVL(item_id_cup_list,"")) 
		lccup_item_ids = "," + ALLTRIM(work_order_tmp9.item_id_cup_list)
	ENDIF 
	SELECT uid, item_id FROM slip_itm_tmp WHERE "," + TRANSFORM(item_id) + "," $ lccup_item_ids AND sitem_sub =.f. INTO CURSOR inv_detail_tmp1 READWRITE  
	SELECT uid, item_id FROM slip_itm_tmp WHERE sitem_sub =.T. AND parent_id in (SELECT uid FROM inv_detail_tmp1) INTO CURSOR inv_detail_tmp4
	SELECT id FROM work_order_tmp WHERE NVL(show_in_cup_mode,.F.)=.T. UNION ALL SELECT id FROM work_order_tmp0 WHERE NVL(show_in_cup_mode,.F.)=.T. INTO CURSOR work_order_tmp_cup_slip &&Lihong 2022.09.27 UNION 
	SELECT uid FROM slip_itm_tmp WHERE item_id>0 AND sitem=.F. AND sitem_sub =.f. AND item_id NOT in (SELECT item_id FROM inv_detail_tmp1) ;
		AND  item_id in (SELECT id FROM work_order_tmp_cup_slip) INTO CURSOR inv_detail_tmp 
	USE IN SELECT("work_order_tmp_cup_slip")
	
	SELECT inv_detail_tmp1 
	APPEND FROM DBF("inv_detail_tmp4")

	SELECT * FROM slip_itm_tmp WHERE uid in (SELECT uid FROM inv_detail_tmp1) ORDER BY item_code INTO CURSOR inv_detail_tmp4
	SELECT * FROM slip_itm_tmp WHERE uid in (SELECT uid FROM inv_detail_tmp) ORDER BY item_code INTO CURSOR inv_detail_tmp3
	SELECT * FROM slip_itm_tmp WHERE uid NOT in (SELECT uid FROM inv_detail_tmp1) AND uid NOT in (SELECT uid FROM inv_detail_tmp) INTO CURSOR slip_itm_tmp READWRITE  
	APPEND FROM DBF("inv_detail_tmp4")
	APPEND FROM DBF("inv_detail_tmp3")
	
	Use In SELECT("inv_detail_tmp")
	Use In SELECT("inv_detail_tmp1")
	*Use In SELECT("inv_detail_tmp2")
	Use In SELECT("inv_detail_tmp4")
	Use In SELECT("inv_detail_tmp3")

ENDIF 
&&



IF EOF("slip_itm_tmp")

	RETURN -1
ENDIF


If _slip_print_to_local		&&¥»¦a¦C¦L¤è¦¡

	Create Cursor   slip_print_main(;
		tableno c(30) ,;
		printer c(20) ,;
		def_printer c(20) ,;
		act_printer c(20) ,;
		printed L,;
		sendtime T ,;
		printtime T,;
		username c(20),;
		langue c(4) ,;
		training L,;
		rem c(10),;
		nitem Int ,;
		order_id Int,;
		barcode L,;
		amount N(12, 2),;
		member_name c(100),;
		member_no c(100),;
		tel c(20),;
		address c(250),;
		discamt N(12, 2),;
		pplcnt Int,;
		srvamt N(12, 2) ,;
		taxamt N(12, 2) ,;
		rndamt N(12, 2) ,;
		invamt N(12, 2) ,;
		itemdiscamt N(12, 2),;
		fastfood_info c(30),;
		sittime T ; 
		)


	Create Cursor slip_print_detail(;
		qty N(12, 2) ,;
		code c(8) ,;
		item c(100) ,;
		amount N(12, 2) ,;
		dispord Int,;
		item_unicode c(254) ;
		)


Endif

*!*	&&Lihong 2023.05.05 alway_print_0_amt
*!*	Select *,.F. As has_itemdisc From slip_itm_tmp Into Cursor slip_itm_tmp Readwrite
&&Lihong 2020.06.02 coupon item_id= -51
Select slip_itm_tmp
Scan FOR item_id>0 	And slip_Print And Undefine=.F. Or (item_id=-3 And amount>0) OR (INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) And amount>0)	&&¶¡½u¤Î«H®§¤£§@¦C¦L ,¥¼©wµæ¦¡¤£¥´¦L &&Lihong 2020.04.20 OR (INLIST 


	If __slip_print_mode="new" And !_print_all					&&¥u¦C¦L¿Ë¼Wªº
		If printed And just_send=.F.		&&¦pªG¥Î°e³æ¥\¯à¥´¦L,¤´­n¦C²M³æ
			Loop
		Endif
	Endif

	&&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯Èbug
	Update order_itemlist_tmp Set just_send=.F. WHERE uid=slip_itm_tmp.uid and just_send=.T.

*!*		&&Lihong 2023.05.05 alway_print_0_amt ¤§«eµL
*!*		Select item_id From item_disc_tmp Where item_id=slip_itm_tmp.uid Into Cursor cun_tmp
*!*		If _Tally>0
*!*			Select slip_itm_tmp
*!*			Replace has_itemdisc With .T.
*!*		Endif
*!*		Select slip_itm_tmp

*!*		_have_pointed_item=.F.

	IF  Nvl(invlst_noprint,.F.) and (slip_itm_tmp.amount<>0 or !((VARTYPE(__inv_print_0_amt_item)="U" OR __inv_print_0_amt_item=.F.) AND nvl(slip_itm_tmp.alway_print_0_amt,.F.)=.T. ))		&&¤@©w¤£¦C¦L &&Lihong  2023.05.05 alway_print_0_amt
	
		LOOP 
	
	ENDIF
	
	IF VARTYPE(__inv_print_0_amt_item) <> "U" AND __inv_print_0_amt_item AND NVL(invlst_zeroNoprint,.f.) AND  slip_itm_tmp.amount=0 		&&¹sª÷ÃB¬O§_¦C¦L  &&Lihong 2023.05.05 alway_print_0_amt
	
		LOOP 
	
	ENDIF
	
*!*		&&Lihong 2023.05.05 alway_print_0_amt ¤§«eµL
*!*		If Empty(Field("points"))=.F. And Empty(Field("pointed"))=.F.		&&¦pªG¦³¿n¤À´«ÁÊ¶µ¥Ø,¤@©w¦C
*!*			If pointed And points>0
*!*				_have_pointed_item=.T.
*!*			Endif
*!*		Endif

*!*		&&Lihong 2023.05.05 alway_print_0_amt ¤§«eµL
*!*		&&¬O§_¤@©w¦C¦L¡A¸òÀHitemªº³]©w,update 2010.07.14  &&Lihong 2023.05.05 alway_print_0_amt 
*!*		If invlst_noprint=.f. AND _have_pointed_item=.F. And slip_itm_tmp.amount=0 And (__inv_print_0_amt_item=.F. AND nvl(slip_itm_tmp.alway_print_0_amt,.F.)=.F. OR slip_itm_tmp.item_id=-3) AND slip_itm_tmp.has_itemdisc=.F.	
*!*		&&ª÷ÃB¬°¹s,¤£§@¦C¦L(®Ú¾Ú³]©w)	³Ì§C®ø¶O®tÃB¬°¹s¤£§@¦C¦L**
*!*			Select slip_itm_tmp
*!*			Loop
*!*		Endif
*!*		&&Lihong 2023.05.05 alway_print_0_amt ¤§«eµL
*!*		&&¬O§_¤@©w¦C¦L¡A¸òÀHitemªº³]©w,update 2010.07.14
*!*		If invlst_noprint=.f. AND  slip_itm_tmp.sitem_sub=.T.   And  __inv_print_sitem_detail=.F. And slip_itm_tmp.amount=0 And slip_itm_tmp.modi_amount=0 and slip_itm_tmp.has_itemdisc=.F. 	&&®MÀ\¶µ¥Ø¤£§@¦C¦L(®Ú¾Ú³]©w)	**¯S§O³B²zª÷ÃB¬°¹s®É
*!*			Select slip_itm_tmp
*!*			Loop
*!*		Endif



	_uid=slip_itm_tmp.uid
	_sitem=slip_itm_tmp.sitem				&&¬O§_®MÀ\
	_mitem=slip_itm_tmp.sitem_sub 			&&¬O§_®MÀ\¤l¶µ
	If _sitem
		_slip_sitem =.T.
	Endif

	_qty=slip_itm_tmp.qty
	&&Lihong 2022.03.17 ¨Ò®u
	IF slip_itm_tmp.orgqty_case_mat>0
		_qty=slip_itm_tmp.orgqty_case_mat
	ENDIF 
	IF slip_itm_tmp.qty_entity>0
		_qty=slip_itm_tmp.qty_entity
	ELSE 
		&&Lihong 2023.04.28 ¨Ò®u ¤ç¨â §ï
		ll_kilo=.F.			&&¬O§_ kilo¤è¦¡­p»ù
		If !Empty(NVL(slip_itm_tmp.kilo,.F.))
			ll_kilo=Nvl(slip_itm_tmp.kilo or slip_itm_tmp.kilo2,.F.)
		Endif
		IF ll_kilo=.T. 
			_qty=1
		ENDIF 
	ENDIF 

	_id=0

	If   _mitem And (Vartype(_slip_sitem)#"U"	)	&&®MÀ\,"´ß"¥u¦C¦L¤@¦¸

		_parent_id=slip_itm_tmp.parent_id
		Select * From slip_itm_tmp Where uid=_parent_id Into Cursor cun_tmp

&&_Pid,_qty,cdbf,_ismitem,_modi,_slip,_void,_not_printAmt

		If MULT_ORDER_ITEM(_Pid,_qty,"cun_tmp",.F.,.F.,.T.,.F.)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥(®MÀ\)
			__kitchen_order=_pre_setting &&ÁÙ­ì
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			Return -1
		Endif
		_dispord=_dispord+1

	Endif
&&__slip_print_Item_amount

	If (slip_itm_tmp.handwriting  And __slip_handwriting_print_amt   )   Or   (slip_itm_tmp.item_id=-3)		&&³Ì§C®ø¶O®tÃB¤@©w¦Cª÷ÃB ,¤â¼g¶µ¥Ø¸òsetting
		_must_printAmt=.T.
	Else
		_must_printAmt=__slip_print_Item_amount
	Endif

	&&Lihong 2023.02.03
	IF VARTYPE(llfastfood_order_do_pre)#"U" &&¹wÂI©l²×¥´¦Lª÷ÃB
		_must_printAmt=.T.
	ENDIF 

	If MULT_ORDER_ITEM(_Pid,_qty,"slip_itm_tmp",_mitem,.F.,.T.,.F.,_must_printAmt)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥
		__kitchen_order=_pre_setting &&ÁÙ­ì
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		Return -1

	Endif
	_nitem=_nitem+1			&&¶µ¥Ø¼Æ
	Release _slip_sitem



	_dispord=_dispord+1

*-------------------

	If Vartype(__slip_print_include_modifier)="U"
		__slip_print_include_modifier=.T.
	Endif

	If Vartype(__slip_print_free_modifier)="U"

		__slip_print_free_modifier=.T.

	Endif

	If __slip_print_include_modifier Or slip_itm_tmp.modi_amount<>0	&&¬O§_¦C¦L¯S§O³B²z¸òsetting(¦pªG¯S§O³B²zª÷ÃB>0,¤@©w¦L)

&&¯S§O³B²z
		Select * From item_modi_tmp Where item_id=_uid And modi_qty>0 Into Cursor cun_modi_tmp

		If _Tally>0
			Select cun_modi_tmp
			Scan
				_qty=modi_qty
&&_Pid,_qty,cdbf,_ismitem,_modi,_slip,_void,_not_printAmt

				If  __slip_print_free_modifier=.F.  And cun_modi_tmp.modi_amount=0  		&&¯S§O³B²z¤£¥[»ù¬O§_¦C¦L
					Loop
				Endif
				If MULT_ORDER_ITEM(_Pid,_qty,"cun_modi_tmp",.F.,.T.,.T.,.T.)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥(¯S§O³B²z)
					__kitchen_order=_pre_setting &&ÁÙ­ì
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					Return -1
				Endif

				_dispord=_dispord+1

			Endscan

		Endif

	ENDIF
	


	If Vartype(__slip_print_call)#"U"		&&¬O§_¦C¦L¸òsetting
		If slip_itm_tmp.hold>0 And __slip_print_call  								&&¥s°_
			_item="* "+getmessage("_waitcall")
			_dispord=_dispord+1

			If _slip_print_to_local		&&¥»¦a¦C¦L¤è¦¡


				Insert Into slip_print_detail (Code,qty,Item,amount,dispord,item_unicode) Values ('',0,_item,0,_dispord,'')

			Else

				ssql="insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,'',0,?_item,0,?_dispord,'')"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				Endif

			Endif


		Endif
	Endif

	If Vartype(__slip_print_patch)#"U"
		If slip_itm_tmp.onlysave And __slip_print_patch AND NVL(slip_itm_tmp.hold,0)<=0 AND NVL(slip_itm_tmp.has_hold,.F.)	=.F. AND !LOWER(__special_customer)=="ms"						&&¸É³æ &&Lihong 2023.07.20 AND !slip_itm_tmp.hold>0
			_item="<"+getmessage("_supp_order")+" >" 
			
			&&Lihong 2022.04.28 MS¼È¤£¥´¦L¡§¸É³æ¡¨¦r¼Ë
			IF LOWER(__special_customer)=="ms"
				_item=""
			ENDIF 
			
			_dispord=_dispord+1

			If _slip_print_to_local		&&¥»¦a¦C¦L¤è¦¡

				Insert Into slip_print_detail (Code,qty,Item,amount,dispord,item_unicode) Values ('',0,_item,0,_dispord,'')

			Else

				ssql="insert into slip_print_detail (pid,code,qty,item,amount,dispord,item_unicode) values (?_pid,'',0,?_item,0,?_dispord,'')"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				Endif

			Endif


		Endif
	Endif


Endscan




*-----------------
If __slip_min_line>0	And _dispord<__slip_min_line		&&¦pªG³]©w¤F³Ì¤p¦æ¼Æ¡A´¡¤JªÅ¦æ

	Local _ord

	For i=1 To __slip_min_line-_dispord

		_ord=i+_dispord

		If _slip_print_to_local		&&¥»¦a¦C¦L¤è¦¡

			Insert Into slip_print_detail(qty,Code,Item,amount,dispord,item_unicode) Values (0,'','',0,_ord,'')

		Else

			ssql="insert into slip_print_detail(pid,qty,code,item,amount,dispord,item_unicode) values (?_pid,0,'','',0,?_ord,'')"

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)

				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return

			Endif


		Endif

	Endfor
Endif

*---------------------

If  Vartype(_preview_slip_html)#"U"		&& ¨¾¤î§ÖÀ\¼Ò¦¡¦L¤Wµæ¯È 2008.12.03

	_slip_print_to_local=.T.

Endif

_fastfoodinfo=Iif(Vartype(_FastFood_info)#"U",_FastFood_info,"")

IF VARTYPE(llfastfood_order_do_hold)#"U" AND VARTYPE(__fastfood_hold_inv_print)#"U" AND __fastfood_hold_inv_print &&Lihong 2022-09-16 fastfood hold
	_fastfoodinfo = _fastfoodinfo + "("+ getmessage("_fastfood_hold") + ")" &&¼È¦s Hold"
ENDIF 
IF VARTYPE(llfastfood_order_do_pre)#"U" &&Lihong 2022.11.17
	_fastfoodinfo = _fastfoodinfo + "("+ getmessage("_fastfood_pre") + ")" &&Not Paid ¥¼¥I´Ú
ENDIF 
IF VARTYPE(_work_order_fastfood_slip_print)="U" OR VARTYPE(llfastfood_order_do_hold)#"U" &&Lihong 2022.09.13 ÂIµæ¯È
ELSE
	_fastfoodinfo = _fastfoodinfo + "("+ getmessage("_fastfood_slip") + ")" &&ÂIµæ¯È
ENDIF

&&Lihong 2020.08.07 µùÄÀ±¼2020.07.11§ï°Ê,¦bfrx¨½¹ê²{qty¥´¦L
&&  2020.07.11  ¤Wµæ¯È¶µ¥Ø¼Æ¶q§ï¬°QTY²Î­p 
SELECT slip_itm_tmp
*!*	SUM qty TO _nitem
COUNT TO _nitem2 FOR item_id>0  && 2020.07.24


If _slip_print_to_local		&&¥»¦a¦C¦L¤è¦¡

	Insert Into slip_print_main (tableno,Printer,def_printer,act_printer,printed,sendtime,printtime,username,langue,training,rem,order_id,barcode,amount,;
		member_name,member_no,tel,address,discamt,pplcnt,nitem,srvamt,taxamt,rndamt,invamt,itemdiscamt,fastfood_info,sittime) ;
		values( _table_info, _printer, _printer,'', _slip_print_to_local,Datetime(),Datetime(), _login_user_name, _clangue, GL_training, _rem, _order_id, _print_barcode, _amount,;
		_member_name, _member_no, _tel, _addr, _discamt, _pplcnt, _nitem, _srvamt, _taxamt, _rndamt, _invamt, _itemdiscamt, _fastfoodinfo,_sittime)

Else

	&&Lihong 2022.01.10 PSO_ORDER_SAVE_INV_ONLINE¤Wµæ¯È¥´¦L¥I´Ú«H®§
	IF VARTYPE(_vs_payway) = "C" 
		_fastfoodinfo = _fastfoodinfo + CHR(0) + _vs_payway
	ENDIF 
	
	ssql="insert into slip_print_main (pid,tableno,printer,def_printer,act_printer,printed,sendtime,printtime,username,langue,training,rem,order_id,barcode,amount,"+;
		"member_name,member_no,tel,address,discamt,pplcnt,nitem,srvamt,taxamt,rndamt,invamt,itemdiscamt,fastfood_info,sittime) "+;
		"values(?_pid,?_table_info,?_printer,?_printer,'',?_slip_print_to_local,getdate(),'',?_login_user_name,?_clangue,?GL_training,?_rem,?_order_id,?_print_barcode,?_amount,"+;
		"?_member_name,?_member_no,?_tel,?_addr,?_discamt,?_pplcnt,?_nitem,?_srvamt,?_taxamt,?_rndamt,?_invamt,?_itemdiscamt,?_fastfoodinfo,?_sittime)"

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif

Endif

__kitchen_order=_pre_setting &&ÁÙ­ì

QRcode_file=""

IF VARTYPE(_work_order_fastfood_slip_print)="U" &&Lihong 2022.09.13 ÂIµæ¯È

IF  VARTYPE(__crm_app_active)#"U" AND __crm_app_active OR VARTYPE(__order_slip_show_qrcode)#"U" AND __order_slip_show_qrcode	&&¥Í¦¨QRCODE (slip) &&Lihing 2022.04.14 ¤Wµæ¤Wµæ¦LQrcode

	&&Lihing 2022.04.14 ¤Wµæ¤Wµæ¦LQrcode &&¥Í¦¨QRCODE (slip)
	*QRcode_file=""
	IF VARTYPE(__order_slip_show_qrcode)#"U" AND __order_slip_show_qrcode 
	IF !EMPTY(_check_valid)
		IF VARTYPE(item_upgrade_ids) # "C"
			item_upgrade_ids = ""
			IF VARTYPE(__qrcode_item_upgrade)#"U" AND __qrcode_item_upgrade AND VARTYPE(__proan_web_so)#"U" AND __proan_web_so

				TEXT TO ssql NOSHOW TEXTMERGE 
					select item_id from order_detail with(nolock)  where id=?_order_id
					AND item_id > 0 AND item_id in (select belong_to_item_id from item_upgrade WITH (nolock)) group by item_id order by item_id 
					
				ENDTEXT 

				IF SQLEXEC(nhand,ssql ,"item_upgrade_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)

					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				ENDIF
				
				IF RECCOUNT("item_upgrade_tmp") > 0 
					SELECT item_upgrade_tmp
					SCAN 
						item_upgrade_ids = item_upgrade_ids + IIF(EMPTY(item_upgrade_ids ), "", ",") + TRANSFORM(item_upgrade_tmp.item_id)
					ENDSCAN 
				ENDIF 
				USE IN SELECT("item_upgrade_tmp")
				
			ENDIF 
		ENDIF 
		lcQRcode = getQrcode_string(_tableno, TRANSFORM(lnoutlet_id), _pplcnt, item_upgrade_ids)  &&lcTableno,lcOutlet_id, lnppl, lcupgrade_item_id
		QRcode_file= FULLPATH(SYS(2015)+".bmp")
			
		 Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
					STRING code,;
					STRING sFileName,;
					INTEGER width, ;
					INTEGER height	
		

		IF GetQrCode_rms(lcQRcode , QRcode_file, 300, 300)<>1
		
			QRcode_file=""
		
		ENDIF
	ENDIF 
	ELSE 
		*SET STEP ON 
		lcQRcode = getQrcode_string(_tableno) 
		
	*	lcQRcode = Encrypt_string(lcQRcode)

		QRcode_file= FULLPATH(SYS(2015)+".bmp")
			
		 Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
					STRING code,;
					STRING sFileName,;
					INTEGER width, ;
					INTEGER height	
		

		IF GetQrCode_rms(lcQRcode , QRcode_file, 300, 300)<>1
		
			QRcode_file=""
		
		ENDIF
		
		
	*!*		SET CLASSLIB TO "class\qrcode.vcx" ADDITIVE
	*!*		oQRcode=CREATEOBJECT("qrcode")	
	*!*		oQRcode.data =lcQRcode
	*!*		QRcode_file= FULLPATH(SYS(2015)+".bmp")
	*!*		
	*!*		oQRcode.buildqrcode(QRcode_file)	&&¥Í¦¨QRCODE IMAGE

	ENDIF 


ENDIF

ENDIF &&Lihong 2022.09.13 ÂIµæ¯È

&&Lihong 2021.01.21 android GET_ORDER_LIST_SLIP µLµæ¦¡»Ý­n¦C¦L«hµ¹­Ó´£¥Ü
If (Vartype(_preview_slip_html)#"U" Or Vartype(_html_fileName)="C") AND RECCOUNT("slip_print_detail")=0 		&& ¥Í¦¨HTML
	*_item="<"+getmessage("_no_item_need_print")+" >" &&¨S¦³µæ¦¡»Ý­n¦C¦L No item need printed
	Insert Into slip_print_detail (Code,qty,Item,amount,dispord,item_unicode) ;
	Values ('',0,"<No item need to be printed>",0,1,'')
ENDIF 

If _slip_print_to_local AND RECCOUNT("slip_print_detail")>0 &&Lihong 2021.01.07 ¼W¥[>0

	Local _pre_langue
	_pre_langue =_system_langue

	If _print_en OR LOWER(__special_customer)="bespoke"
		_system_langue="EN"
	Endif

	slip_local_print(_Pid,_printer)		&&¤Wµæ¯È¥»¦a¤è¦¡¦C¦L

	_system_langue=_pre_langue
	
	
	IF VARTYPE(__slip_print_open_drawer)#"U" AND __slip_print_open_drawer	&&¦Û°Ê¼u¿úÂd  2014.08.19
	
		
		open_drawer(_printer)		
	
	ENDIF
	
	

Endif




If Used("cun_modi_tmp")
	Select cun_modi_tmp
	Use

Endif

If Used("slip_item_tmp")
	Use In slip_item_tmp

Endif

If Used("slip_print_main")

	Use In slip_print_main

Endif

If Used("slip_print_detail")

	Use In slip_print_detail

Endif




Return 1


Endfunc





******************
*  ¤¤­^¤å¦Û°Ê¤Á´« *
******************
* Usage: ChangeUI(thisform)
* notes: please add your form name into table "Langue" first
*
Function ChangeUI
Parameters obj
_form_name = Alltrim(obj.Name)
Local ssql
ssql="select * from langue where form_name=?_form_name"
If SQLExec(nhand,ssql,"cr_langue") > 0
	Select cr_langue
	Scan
		_name = Alltrim(objname)
		obj.&_name = Iif(_system_langue="EN",Trim(cr_langue.en),Trim(cr_langue.cn))
	Endscan
	If Used("cr_langue")
		Use In cr_langue
	Endif
Endif
Return
Endfunc


*******************************
*	sys_user_check
*
*	¨t²Î±b¤áÀË¬d
*******************************
Function sys_user_check

Local ssql,nhand2

If __linkserver_active
	nhand2=connect_sql(.T.) &&¥Î¨ã¦³ºÞ²zµn¤JÅv­­ªº±b¤á³s±µSQL

Else

	nhand2=connect_sql() &&¥Î¨ã¦³ºÞ²zµn¤JÅv­­ªº±b¤á³s±µSQL
Endif

If nhand2<0
	Return -1

Endif




Local cstr,nhandle,_db
cstr=Iif(__linkserver_active, Filetostr("linkserver.dat"), Filetostr("sysinfo.dat"))
cstr=crstr(cstr,"RMS6")		&&unpack

Local ms,_db
Dimension ms(1)
getmstring(cstr,@ms,"@")

cstr=Trim(ms(__nServer))
getmstring(cstr,@ms,";")
_db=Trim(ms(6))			&&database


ssql="select * from sys_user where id=0"
If SQLExec(nhand2,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

ssql="select * from role where id=0"
If SQLExec(nhand2,ssql,"cun_tmp1")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

ssql="select roleaccess_id from roleaccess"
If SQLExec(nhand2,ssql,"cun_tmp2")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

If SQLExec(nhand,"alter table role add updateno int null")>0			&& role

	=SQLExec(nhand,"UPDATE role SET updateno=id+10")

Endif

_updateno=getupdateno("role")

If _updateno<0

	Return -1

Endif


_access_list=""
Select cun_tmp2
Scan
	_access_list=_access_list+Alltrim(Str(cun_tmp2.roleaccess_id))+","

Endscan

Local _password,_role
_password=Strconv(Strconv('1',13),13)		&&¥[±K
_role="0,"
ssql="if not exists (select id from sys_user where id=0) insert into sys_user (active,id,name,password,cardno,role_list,autologin,timeout,autoexit,discamt_order,discper_order,discamt_month,user_language,level_list) ";
	+" values (1,0,'admin',?_password,'',?_role,0,0,0,99999999.99,100,0,'CN','ALL')"

ssql=ssql+Chr(10)+"delete from role where id=0"
ssql=ssql+Chr(10)+"insert into role (active,id,name,access,remark,updateno) values(1,0,'admin',?_access_list,'',?_updateno)"		&&¥[¤J¨¤¦âadmin¤Î©Ò¦³Åv­­

If SQLExec(nhand2,ssql)<0
	Aerror(err)

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

*!*	Local _newID,new_user

*!*	_newID=0
*!*	new_user=_db+"0"			&&"rms_user0"  &&¦bSQL SERVER¤W¼W¥[·s¥Î¤á ,±K½X§¡¬° "rms2006"

*!*	*!*		ssql="sp_addlogin '&new_user','rms2006','"+_db+"'"
*!*	*!*	*	If SQLExec(nhand2,ssql)>0
*!*	*!*			=SQLExec(nhand2,"sp_grantdbaccess '&new_user','&new_user'")   &&¦brms6¤W²K¥[¸Ó¥Î¤á
*!*	*!*			=SQLExec(nhand2,"sp_addrolemember N'db_owner',N'&new_user'")  &&³]©w¬° rms6ªº owner ¥H¶i¦æ¼Æ¾Ú®wªº¾Þ§@
*!*	*!*			=SQLExec(nhand2,"sp_addsrvrolemember @loginame = N'&new_user', @rolename = N'processadmin'")		&& add processadmin

*!*	*!*	*	Endif

*!*	ssql="delete from role where id=0"
*!*	ssql=ssql+Chr(10)+"insert into role (active,id,name,access,remark) values(1,0,'admin',?_access_list,'')"		&&¥[¤J¨¤¦âadmin¤Î©Ò¦³Åv­­
*!*	*		ssql=ssql+CHR(10)+"update updateno set max_updateno=max_updateno+1 where table_name='role' "

*!*	If SQLExec(nhand2,ssql)<0
*!*		Aerror(err)

*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		=SQLDisconnect(nhand2)

*!*		Return 	-1
*!*	Endif



If Used("cun_tmp1")
	Select cun_tmp1
	Use
Endif

If Used("cun_tmp2")
	Select cun_tmp2
	Use
Endif
=SQLDisconnect(nhand2)


Return 1


Endfunc



*****************
* FUNCTION ITEM_OUTLET_PRINTER
*	µæ¦¡--°Ï°ì¥´¦L¾÷
*
***************
Function ITEM_OUTLET_PRINTER

Lparameters _item_Id,_outlet_id		&&¨ú±oitemªº«ü©w¥´¦L¾÷
Local ssql,_prn
ssql="select  printer_id from item_outlet_printer where item_id=?_item_Id and outlet_id=?_outlet_id"
If SQLExec(nhand,ssql,"cun_tmp")<0
	Return ""
Endif

If Reccount("cun_tmp")>0
	_prn=""
	Select cun_tmp
	Scan
		_prn=_prn+Alltrim(Str(cun_tmp.printer_id))+","

	Endscan

	Return _prn

Endif

Return ""

Endfunc

*******************
*	FUNCTION outlet_printer
*	°Ï°ì¥´¦L¾÷
******************
Function outlet_printer

Lparameters _outlet_id,_printer		&&ÀË´úitem ¦boutlet ¬O§_¦³¥´¦L¾÷Âà¦V
Local ssql,_curtime,_prn

_curtime=Left(Time(),5)


ssql="select to_printer_id from outlet_printer where outlet_id=?_outlet_id and printer_id=?_printer and  (station_id=0 or station_id=?__station_id) "+;
	"and ((begtime<=endtime and begtime<=?_curtime and endtime>=?_curtime) or (begtime>endtime and  (begtime<=?_curtime or endtime<=?_curtime)))"

If SQLExec(nhand,ssql,"cun_tmp")<0
	Return ""
Endif

If Reccount("cun_tmp")>0

	_prn=""
	Select cun_tmp
	Scan

		_prn=_prn+Alltrim(Str(cun_tmp.to_printer_id))+","

	Endscan

	Return _prn

Endif

Return ""

Endfunc

*------------------------
*¤â¤uª½±µÂà¦V¥´¦L¾÷
*

Function direct_printer
Lparameters nPrinterID

If SQLExec(nhand,"select d_printer from direct_printer where s_printer=?nPrinterID","cun_tmp")<0

	Return ""

Endif


If !Eof("cun_tmp")

	Return Alltrim(Str(cun_tmp.d_printer))


Endif

Return ""

Endfunc


********************************************
*
* FUNCTION create_order_cursor
*	³Ð«Ø¸¨³æ¥²»ÝªºÁ{®Éªí

Function create_order_cursor

If Used("order_itemlist_tmp")
	Select order_itemlist_tmp
	Use
Endif
If Used("item_modi_tmp")
	Select item_modi_tmp
	Use
Endif
If Used("item_disc_tmp")
	Select item_disc_tmp
	Use
Endif
If Used("order_disc_tmp")
	Select order_disc_tmp
	Use
Endif

&&Lihong 2020.06.01 coupon¥[ cloud_coupon_id, web_coupon_id, web_coupon_code
*--------«Ø¥ßÁ{®Écursor   UID¨ú5¦ì¤p¼Æ,¬O¬°¤À©î°O¿ý¸¹¤§¥Î,¦p1,¤À©î«á¥i¬°1.001,1002..³Ì¤j999­Ó¤À©î. ³Ì¤jorder¼Æ9999,¦p»Ý­n¦A§@ÂX®i
&&Lihong 2022.03.17 ¨Ò®uorgqty_case_mat
&&Lihong 2022.05.28 srv_amount N(12,4) ->srv_amount N(12,2)
&&Lihong 2023-06-02 ¼pÅã kit_disp_uid 
&&Lihong 2023.07.13 item desc 50->100
Select 0
Create Cursor order_itemlist_tmp (uid N(10,5),parent_id N(10,5),cate_id Int(4),item_id Int(4),item_code c(8),descdisp c(100),qty N(12,2),;
	price N(12,2),orgamt N(12,2),amount N(12,2),sitem L(1),sitem_sub L(1),mitem L(1),mustmodi L(1),nmustmodi Int(4),hold N(8,2),printed L(1),printtime T,;
	adduser c(20),Selected L(1),Show L(1),modi_list c(254),modi_amount N(12,2),remin_times Int(4),srv_free L,tax_free L,;
	disc_amount N(12,2),srv_amount N(12,2),srv_per N(8,3),tax_amount N(12,4),tax_per N(8,3),real_amount N(12,2),round_amount N(6,2),xdisc N(8,2),;
	level_id Int(4),level_price N(12,2),drink_qty Int(4),level_disc L(1),level_mainID N(10,5),level_subID N(10,5),mincharge L,no_Ldisc L,;
	onfocus L(1),modi_need c(254),modi_must c(254),modi_def c(254),Undefine L(1),Printer c(254),sprinter c(4),slip_Print L,;
	spn_desc c(20),descinvcn c(100),descinven c(100),desckit c(100),desc_other c(254),onlysave L(1),disc L,limitqty L,hhqty Int(4),hhprice N(12,2),handwriting L,mitem_id Int(4),;
	timer_active L,timer_style Int,free_hours Int,free_style Int,timer_begtime c(5),timer_endtime c(5),timer_mincharge N(6,1),timer_disc L,time_free L,material L,;
	just_send L,org_price N(12,2),turnup L,orgsrv L,price0 N(12,2),tax2 N(6,2),points N(12,2),pointed L,kilo L,leveldiscadd N(12,2),askdept ;
	L,item_warning L,warning_begtime c(5),warning_endtime c(5),warning_inMinute N(6,2),Descen c(100),descpole c(100),price4 N(12,2),joinitem L,;
	pre_price N(12,2),sub_amt N(12,2),desccn c(100),gift L,giftred L,tel c(20),onlymember L,transnumber c(20),member_number c(20),onlyone L,;
	hh_used L,hh_disc L,ordertime T Null,timer_trigger L,reprice N(12,2),ecoupon L,price_mc N(12,2),amtinv L,save_type c(20),delay_minute Int(4),kilo2 L,iqchar L , fix_price L, ;
	coupon_lock_valid C(36) NULL DEFAULT null, cloud_coupon_id int DEFAULT 0, web_coupon_id C(36) NULL DEFAULT null, web_coupon_code C(100) DEFAULT "", print_single L, ;
	same_tableno C(8), orgqty_case_mat N(8,2), price_type Int(4), qty_entity N(8,2), add_user_id Int, add_user_station_id Int,srv_per_org N(8,3) NULL DEFAULT null, ;
	kit_disp_uid C(36) NULL DEFAULT null, to_printer C(50), has_hold L )

Select 0
Create Cursor item_modi_tmp (uid c(10),item_id N(10,5),modi_id Int(4),def_id Int(4),modi_parentid Int(4),descdisp c(50),modi_price N(12,2),modi_per N(8,3),modi_qty Int(4),;
	modi_amount N(12,2),descinvcn c(50),descinven c(50),desckit c(50),desc_other c(254),modi_need L,modi_must L,modi_idx N(12,6),def_idx c(100),Selected L,multqty L,open_Modi L)			&&¯S§O³B²z¦Cªí

Select 0
Create Cursor item_disc_tmp (uid c(10),item_id N(10,5),disc_id Int(4),disc_type Int(4),descdisp c(40),disc_per N(6,3),disc_amount N(12,2),member_id Int(4),adduser c(20),;
	disc_reason Int,disc_remark C(30),disc_qty Int,autodisc L,minamt N(12,2),dedu_srv L,new L,disc_level c(200),;
	coupon_lock_valid C(36) NULL DEFAULT null, cloud_coupon_id int DEFAULT 0, web_coupon_id C(36) NULL DEFAULT null, web_coupon_code C(100) DEFAULT "", after_inv L )		&&¶µ¥Ø§é¦©¦Cªí

Select 0 &&&&Lihong 2021.10.08 disc_level c(200) -> 254
Create Cursor order_disc_tmp (uid c(10),disc_id Int(4),disc_type Int(4),descdisp c(40),disc_per N(6,3),disc_amount N(12,2),member_id Int(4),adduser c(20),;
	disc_reason Int,disc_remark C(30),disc_level c(254),disc_qty Int,autodisc L,points N(12,2),member_number c(20),member_name c(30),minamt N(12,2),dedu_srv L,new L,after_inv L)				&&¾ã³æ§é¦©¦Cªí

Select 0
Create Cursor order_dept_tmp (parent_id N(10,5), item_id Int ,dept_id Int,amount N(12,2),srvamt N(12,2))		&& 2009.12.10

Select 0
Create Cursor order_tax_tmp (parent_id N(10,5),tax_id Int,tax_per N(6,2),amount N(12,2))		&&2010.04.24

Endfunc

*-------------

**¤½²³°²´ÁÀË¬d§ó·s
Function UPDATE_holiday
Local ssql,_begdate ,_enddate
ssql="select begdate,enddate,id,pbegdate,penddate from holi where recur=1 and year(begdate)<year(GETDATE())"
If SQLExec(nhand,ssql,"cun_tmp")<0
	Return -1
Endif
If Eof("cun_tmp")

	Return 1

Endif

Select cun_tmp
Scan

	_begdate=Gomonth(begdate,(Year(Date())-Year(begdate))*12)
	_enddate=Gomonth(enddate,(Year(Date())-Year(begdate))*12)

	_pbegdate=Gomonth(pbegdate,(Year(Date())-Year(pbegdate))*12)
	_penddate=Gomonth(penddate,(Year(Date())-Year(pbegdate))*12)

	_updateno=getupdateno("holi")

	If _updateno<0


		Return -1
	Endif


	ssql="update holi set begdate=?_begdate,enddate=?_enddate,pbegdate=?_pbegdate,penddate=?_penddate,updateno=?_updateno where id=?cun_tmp.id"
	If SQLExec(nhand,ssql)<0
		Return  -1
	Endif

Endscan

=SQLExec(nhand,"update updateno set max_updateno=max_updateno+1 where table_name='holi' ")

Return 1

ENDFUNC


**¸`°²¤éÀË¬d§ó·s
Function UPDATE_festival
Local ssql,_begdate ,_enddate
ssql="select begdate,enddate,id,pbegdate,penddate from festival where recur=1 and year(begdate)<year(GETDATE())"
If SQLExec(nhand,ssql,"cun_tmp")<0
	Return -1
Endif
If Eof("cun_tmp")

	Return 1

Endif

Select cun_tmp
Scan

	_begdate=Gomonth(begdate,(Year(Date())-Year(begdate))*12)
	_enddate=Gomonth(enddate,(Year(Date())-Year(begdate))*12)

	_pbegdate=Gomonth(pbegdate,(Year(Date())-Year(pbegdate))*12)
	_penddate=Gomonth(penddate,(Year(Date())-Year(pbegdate))*12)

	_updateno=getupdateno("festival")

	If _updateno<0


		Return -1
	Endif


	ssql="update festival set begdate=?_begdate,enddate=?_enddate,pbegdate=?_pbegdate,penddate=?_penddate,updateno=?_updateno where id=?cun_tmp.id"
	If SQLExec(nhand,ssql)<0
		Return  -1
	Endif

Endscan

=SQLExec(nhand,"update updateno set max_updateno=max_updateno+1 where table_name='festival' ")

Return 1

Endfunc

*************************************************
*	FUNCTION AMOUNT_CHECK	ª÷ÃB/§é¦©ÀË¬d­pºâ
*
************************************************
Function amount_check			&&ª÷ÃBÀË¬d(¸¨³æ¥Î)
LPARAMETERS lninv_no_id1 &&Lihong 2021.04.23 ¼W¥[°Ñ¼Æ
IF VARTYPE(lninv_no_id1)#"N"
	lninv_no_id1 = -1
ENDIF 
lninv_no_id= lninv_no_id1

&&§R°£¬ÛÀ³ªº¯S§O³B²z
Delete From item_modi_tmp   Where modi_id>0 And item_id In (Select uid From order_itemlist_tmp Where Empty(modi_list))

UPDATE order_itemlist_tmp SET disc=.f. WHERE price<0

&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
IF VARTYPE(_inv_srv_type)="N"
	UPDATE order_itemlist_tmp SET srv_per=IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per_org + _inv_srv_perc,MAX(srv_per_org,_inv_srv_perc)),srv_per_org) ;
	WHERE (item_id>0 OR item_id=-3) AND !ISNULL(srv_per_org) 
ENDIF 

Select item_disc_tmp 		&&§R°£¤£¦X­n¨Dªº¶µ¥Ø§é¦©
Scan


	Select uid From order_itemlist_tmp Where uid=item_disc_tmp.item_id And amount<item_disc_tmp.minamt Into Cursor cun_tmp

	If _Tally>0

*!*			&&Lihong 2021.04.23 ¦P®É³B²zdisc_log
*!*			IF lninv_no_id>-1
*!*				ssql =" update disc_log set void = 1 ,datetime= getdate() where disc_type='1' and id = (select MAX(id) from disc_log where disc_type='1' and inv_no =?lninv_no_id and disc_id=?item_disc_tmp.disc_id and disc_amount = ?item_disc_tmp.disc_amount) "
*!*				If SQLExec(nhand, ssql)<0
*!*					Aerror(err)
*!*					*Sqlrollback(nhand)
*!*					*SQLSetprop(nhand,"Transactions",1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return .F.
*!*				ENDIF 
*!*			ENDIF 

		Select item_disc_tmp
		Delete

	Endif


Endscan


Update order_itemlist_tmp Set disc_amount=0,srv_free=.F.,tax_free=.F.,round_amount=0,xdisc=0,hh_used=.F.,hh_disc=.F.		&&´_¦ì

*Update order_itemlist_tmp Set disc_amount=0, round_amount=0,xdisc=0,hh_used=.f.,hh_disc=.f.		&&´_¦ì


Update order_tax_tmp Set amount=0		&&´_¦ì

**Update order_itemlist_tmp Set srv_amount=Iif(srv_free,0,Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*srv_per/100,Iif(orgsrv,price0*qty,amount)	*srv_per/100))	&&§é¦©«áªA°È¶O(¸òsetting)
&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
IF VARTYPE(__change_item_set_detail)#"U" AND __change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
	Update order_itemlist_tmp Set srv_amount= Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*srv_per/100,Iif(orgsrv,price0*qty,amount)*srv_per/100)
ELSE 
	Update order_itemlist_tmp Set srv_amount= Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*srv_per/100,Iif(orgsrv,price0*qty,amount)	*srv_per/100)  WHERE  askdept=.f.  &&§é¦©«áªA°È¶O(¸òsetting) 
ENDIF 
*!*	IF VARTYPE(__change_item_set_detail)#"U" AND __change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
*!*		Update order_itemlist_tmp Set srv_amount= Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100,;
*!*		Iif(orgsrv,price0*qty,amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100)
*!*	ELSE 
*!*		Update order_itemlist_tmp Set srv_amount= Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100,;
*!*		Iif(orgsrv,price0*qty,amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100)  WHERE  askdept=.f.  &&§é¦©«áªA°È¶O(¸òsetting) 
*!*	ENDIF 

*!*	IF MESSAGEBOX("susp?",260)=6

*!*		SET STEP on
*!*
*!*	ENDIF

Update order_itemlist_tmp Set srv_amount=0 Where  srv_amount<0

***

Update order_itemlist_tmp Set tax_amount=0 Where  tax_amount<0

Update order_itemlist_tmp Set modi_amount=0		&& ¥ý²M¹s

Select order_itemlist_tmp
Go Top
Do Whil !Eof()
	Select order_itemlist_tmp
	If item_id<=0
		Skip
		Loop

	Endif

	_rec=Recno()
	_uid=uid
	_qty=qty
	Select * From item_modi_tmp Where item_id=_uid Into Cursor cun_tmp		&&­pºâ¯S§O³B²zª÷ÃB
	Select cun_tmp
	Scan
		_muid=uid
		If modi_per<>0
			_amount=Iif(multqty ,(modi_per/100)*Iif(order_itemlist_tmp.level_disc,order_itemlist_tmp.level_price,order_itemlist_tmp.price)*modi_qty*_qty,;
				(modi_per/100)*Iif(order_itemlist_tmp.level_disc,order_itemlist_tmp.level_price,order_itemlist_tmp.price)*modi_qty)
*			_amount=(modi_per/100)*Iif(order_itemlist_tmp.level_disc,order_itemlist_tmp.level_price,order_itemlist_tmp.price)*modi_qty

		Else
			_amount=Iif(multqty ,modi_price*modi_qty*_qty,modi_price*modi_qty)			&&¯S§O³B²z»ù®æ*¯S§O³B²z¼Æ¶q(*item¼Æ¶q,¸òsetting)
*		_amount=modi_price*modi_qty				&&¯S§O³B²z»ù®æ*¯S§O³B²z¼Æ¶q(*item¼Æ¶q,¸òsetting) ppp

		Endif

		Update item_modi_tmp Set modi_amount=_amount Where uid=_muid

	Endscan


	Select item_modi_tmp
	Sum modi_amount To _modi_amount For item_id=_uid


	Select order_itemlist_tmp
	If Vartype(__level_disc_modi_amount )="U"		&&¬O§_­pºâ¯S§O³B²z¥[»ù¸òSETTING

		Replace modi_amount With _modi_amount

	Else

		If level_disc=.F.		Or  __level_disc_modi_amount 		&&¦³²Õ¦XÀu´f¤£¦A­p¯S§O³B²z¥[»ù
			Replace modi_amount With _modi_amount
		Endif

	Endif


*Replace modi_amount With IIF(__item_qty_with_modi,_modi_amount,_modi_amount*qty)

	If hh_used=.F.

		Replace amount With price*qty+modi_amount						&&¥¿±`±¡ªp

	Endif

	If level_disc
		Replace amount With qty*(level_price+leveldiscadd) + modi_amount			&&¦Ò¼{¨ì¬O§_¦³²Õ¦XÀu´f 2009.09.29  leveldiscadd

	Endif


*---



	If sitem_sub=.F.  And hhqty>0		&&¦pªG¦³®É¬qÀu´f(®MÀ\¤l¶µ¥Ø¤£°Ñ»P)	(¤ñ²Õ¦XÀu´fÀu¥ý)  update  2011.11.15 ¥i¤À´²¤J

		Local nItem_id,nHHqty,nHhprice
		lnItem_id=order_itemlist_tmp.item_id
		nHHqty=order_itemlist_tmp.hhqty
		nHhprice=order_itemlist_tmp.hhprice

		Select Sum(qty) As qty From order_itemlist_tmp Where item_id=lnItem_id And hh_disc=.F.   AND NVL(fix_price,.f.) = .f. Into Cursor cun_tmp	&& fix_price   2018.08

		If cun_tmp.qty>=nHHqty


			Select  uid,qty,hhqty,price,amount  From order_itemlist_tmp Where uid>=_uid And  hh_used=.F. And hhqty>0 And item_id=lnItem_id Into Cursor cun_tmp
*	SET STEP ON
			hh=0
			hh_amt=0
			Select cun_tmp
			Scan

				Update order_itemlist_tmp Set hh_used=.T. Where uid=cun_tmp.uid

				hh=hh+cun_tmp.qty

				If hh>=nHHqty

					Update order_itemlist_tmp Set amount= Int(hh/hhqty)*hhprice - hh_amt+ Mod(hh,hhqty)*price,hh_disc=.T.  Where uid=cun_tmp.uid


					hh_amt=Mod(hh,cun_tmp.hhqty)*cun_tmp.price

					hh=Mod(hh,nHHqty)


					Loop

				Endif

				hh_amt=hh_amt+cun_tmp.amount



			Endscan




			Select order_itemlist_tmp
			Go _rec




		Endif



	Endif

*----


	Select order_itemlist_tmp

	If amount<0 And Vartype(__modi_item_allow_neg)#"U" And __modi_item_allow_neg=.F.  		&&2010.02.04 ¥[¤Jsetting,¯S§O³B²zª÷ÃB¬°­t¼Æ®É,µæ¦¡ª÷ÃB¬O§_¤¹³\¬°­t¼Æ

		Replace amount With 0

	Endif

	If Vartype(__item_rounding)#"U"		&& 2011.04.12  add  item rounding


		Replace amount With rounding_amount(amount,__item_rounding)


	Endif

	IF    askdept=.f. OR VARTYPE(__change_item_set_detail)#"U" AND __change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
	
		
		&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
		Replace srv_amount With  Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*srv_per/100,Iif(orgsrv,price0*qty,amount)	*srv_per/100)
*!*			Replace srv_amount With  Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount)-disc_amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100,;
*!*			Iif(orgsrv,price0*qty,amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100)
		
		IF  level_disc =.t.  AND  (  VARTYPE(__leveldisc_drink_srv)="U"   OR ( VARTYPE(__leveldisc_drink_srv)#"U" AND __leveldisc_drink_srv=.f. )  )	&&À\¶¼ªA°È¶O¬O§_¸ò¶¼«~
		*SET STEP ON 

	*		_uid = order_itemlist_tmp.uid
			_main_uid = order_itemlist_tmp.level_mainID
			&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
			SELECT srv_per FROM order_itemlist_tmp WHERE uid=_main_uid  INTO CURSOR cun_tmp 
*!*				SELECT IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per) as srv_per FROM order_itemlist_tmp WHERE uid=_main_uid  INTO CURSOR cun_tmp 
			IF _tally>0 AND cun_tmp.srv_per=0 
				
				Select order_itemlist_tmp
				Replace srv_amount With  0	FOR  level_mainID =_main_uid	&&¦pªG­¹«~¤£¦¬ªA°È¶O¡A¶¼«~¤]¤£¦¬ªA°È¶O
				
			ENDIF
		
		ENDIF

	ENDIF

	
	check_item_disc(order_itemlist_tmp.uid)						&&¶µ¥Ø§é¦©ÀË¬d

	Select order_itemlist_tmp
	Go _rec
	Skip

ENDDO

*SET STEP ON 


*!*	If Vartype(__srv_fee_be_tax)#"U" And __srv_fee_be_tax=.F.

*!*		Update order_itemlist_tmp Set tax_amount=Iif(Vartype(__disc_tax)#"U" And __disc_tax,(amount -disc_amount-xdisc)*tax_per/100,amount*tax_per/100) WHERE tax_free = .f. 	&&ªA°È¶O¤£­pµ|

*!*	Else

*!*		Update order_itemlist_tmp Set tax_amount=Iif(Vartype(__disc_tax)#"U" And __disc_tax,(amount +srv_amount-disc_amount-xdisc)*tax_per/100,(amount+srv_amount)*tax_per/100) WHERE tax_free = .f.	&&ªA°È¶O«á¦A­pµ|
*!*	Endif

*!* Update order_itemlist_tmp Set real_amount=amount+srv_amount-disc_amount+tax_amount


*Update order_itemlist_tmp Set disc_amount=0 Where amount<0		&&­tª÷ÃB®É,¤£¤¹³\¦³§é¦©
*--------------------


Update order_itemlist_tmp Set no_Ldisc=.T.  		&& 2012.03.31


*Select	order_itemlist_tmp
*Sum amount To _amount For disc=.T.		&&¥u¹ï¤¹³\§é¦©ªº¶i¦æ¾ã³æ§é¦©­pºâ

*Sum real_amount,disc_amount,srv_amount,tax_amount To _totalamt,_item_discamt,_srvamt,_taxamt FOR item_id>0 		&&¶µ¥Ø¹ê¦¬ª÷ÃB¦X­p
*SET STEP ON
&&_totalamt		&&¹ê¦¬¦X­p
_disc_amount=0
_level_disc_amount=0
Select 	order_disc_tmp									&&­«·s­pºâ¾ã³æ§é¦©
Scan
	_ndiscid=disc_id
	_disc_type=disc_type
	_discper=disc_per
	_discamt=disc_amount
	_recn=Recno()

	_level_id=Trim(disc_level) 			&&level id

	Update order_itemlist_tmp Set no_Ldisc=.T.

	If  !Empty(_level_id) And Lower(_level_id)<>"all"	&&

*Dimension lv(1)
*getmstring(_level_id,@lv)

		Alines(lv,_level_id,4,",")

		For i=1 To Alen(lv)
			lv(i)=Val(lv(i))
		Endfor


		Select order_itemlist_tmp
		Scan For disc

			If Ascan(lv,level_id)>0

				Replace no_Ldisc With .F.

			Endif

		Endscan


	Else

		If Lower(_level_id)="all"

			Update order_itemlist_tmp Set no_Ldisc=.F.

		Endif


	Endif

	If Vartype(__itemdisc_disc )#"U" And __itemdisc_disc =.F.		&&¶µ¥Ø§é¦©«á¬O§_¦A¤¹³\¾ã³æ§é¦©


		Update order_itemlist_tmp Set no_Ldisc=.T. Where uid In (Select item_id From item_disc_tmp)

	Endif


	Do Case

		Case _disc_type=3		&&¦Û©w§é¦©
			_amt=_discamt
*		_disc_amount=_disc_amount+_amt			&&¾ã³æ§é¦©¦X­p


		Case _disc_type=4		&&§KªA°È¶O



			Select order_itemlist_tmp
			Sum srv_amount To _srvamt For item_id>0 And no_Ldisc=.F. And srv_free=.F.

			_amt=  _srvamt

*			_amt= IIF(__disc_srv, _srvamt,0)

			Update order_itemlist_tmp Set   srv_amount=0,srv_free= .T.  Where  item_id>0 And no_Ldisc=.F. And srv_free=.F.
			

*		UPDATE order_dept_tmp  SET srvamt =0 




		Case _disc_type=5		&&§Kµ|¶µ

			Select order_itemlist_tmp
			Sum tax_amount To _taxamt For item_id>0 And no_Ldisc=.F. And tax_free=.F.
			_amt=_taxamt

			Update order_itemlist_tmp Set   tax_amount=0,tax_free= .T.  Where  item_id>0 And no_Ldisc=.F.  And tax_free=.F.


		Otherwise			&&¤@¯ë§é¦©

	*SET STEP ON

			Select	order_itemlist_tmp

			Sum amount ,xdisc,disc_amount To _amount,_xdisc,_item_discamt   For disc=.T. And  no_Ldisc=.F.	&&¥u¹ï¤¹³\§é¦©ªº¶i¦æ¾ã³æ§é¦©­pºâ

			
*!*				IF MESSAGEBOX("susp?",260)=6
*!*				
*!*					SET STEP ON 
*!*				ENDIF
			
			
			
			Count To nDisc For  disc=.T. And  no_Ldisc=.F.

			Sum srv_amount  To  _srvamt    For  item_id>0 And no_Ldisc=.F. And srv_free=.F.
			Sum tax_amount  To  _taxamt    For  item_id>0 And no_Ldisc=.F. And tax_free=.F.


	*		Select item_disc_tmp
		*	Sum disc_amount To _item_discamt For disc_type<4 	&&disc_id= _ndiscid
			
		
			
*!*				IF nDisc =0
*!*				
*!*					nXdisc=0
*!*					
*!*				ELSE
*!*				
*!*					
*!*					SELECT SUM(disc_amount ) as amt  FROM order_disc_tmp WHERE disc_id=_ndiscid INTO CURSOR cr_tmp
*!*				
*!*						nXdisc=cr_tmp.amt
*!*						
*!*					
*!*				
*!*				ENDIF
*!*										
*SET STEP ON 
*			_amt=Iif(_discper>0,(_amount-_item_discamt- _xdisc)*_discper/100,Iif(nDisc>0, _discamt ,0))
*			_amt=Iif(_discper>0,(_amount  +IIF(__disc_srv ,_srvamt ,0)  +  IIF(__disc_tax ,_taxamt ,0)   -_item_discamt- _disc_amount)*_discper/100,Iif(nDisc>0, _discamt ,0))

			IF VARTYPE(__tax_after_total)#"U" AND __tax_after_total
			
				_amt=Iif(_discper>0,(_amount  +IIF(__disc_srv and _discper<100  ,_srvamt ,0)    -_item_discamt- _xdisc)*_discper/100,Iif(nDisc>0, _discamt ,0))
			
			ELSE
			
				_amt=Iif(_discper>0,(_amount  +IIF(__disc_srv and _discper<100  ,_srvamt ,0)  +  IIF(__disc_tax and _discper<100 ,_taxamt ,0)   -_item_discamt- _xdisc)*_discper/100,Iif(nDisc>0, _discamt ,0))
			
			ENDIF
			
			
	*		SET STEP ON 

*			_amt=Iif(_discper>0,(_amount    -_item_discamt- _disc_amount)*_discper/100,Iif(nDisc>0, _discamt ,0))

			_disc_amount = _disc_amount+_amt			&&¾ã³æ§é¦©¦X­p

			If __disc_srv  And _discper=100		&& §K¶O©^°e®É¡AªA°È¶O¤]§é¦© 

				Update order_itemlist_tmp Set  srv_amount=0, srv_free=.T.   Where  srv_free=.F.
				
*		UPDATE order_dept_tmp  SET srvamt =0 
				

			ENDIF 


			If __disc_tax  And _discper=100		&& §K¶O©^°e®É¡Aµ|¶µ¤]§é¦© 

				Update order_itemlist_tmp Set  tax_amount=0, tax_free=.T.   &&Where  tax_free=.F.

			Endif



	Endcase


*	_disc_amount=_disc_amount+_amt

	If _amt<0

		_amt=0

	Endif


*!*		&&Lihong 2021.04.23 ¦P®É³B²zdisc_log 
*!*		IF NVL(order_disc_tmp.autodisc, .F.) = .F. AND lninv_no_id>0 AND order_disc_tmp.disc_amount <>_amt
*!*			ssql =" update disc_log set disc_amount = ?_amt where disc_type='0' and id = (select MAX(id) from disc_log where disc_type='0' and inv_no =?lninv_no_id and disc_id=?order_disc_tmp.disc_id and disc_amount = ?order_disc_tmp.disc_amount) "
*!*			If SQLExec(nhand, ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				*SQLSetprop(nhand,"Transactions",1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return .F.
*!*			ENDIF 
*!*		ENDIF 

		Select order_disc_tmp
		Replace disc_amount With  _amt		&&


	Select order_itemlist_tmp				&&¤À°t¾ã³æ§é¦©¨ì¦U­Ó¶µ¥Ø(level)
	Sum amount To _tm For disc=.T.  And no_Ldisc=.F.
	
 
	If _tm >0 AND  _disc_type<>4  AND _disc_type<>5


		Select order_disc_tmp
		Replace disc_amount With  _amt		&&¼g¤J§é¦©ª÷ÃB
		
		_total_xdisc = 0.00
		&&Lihong 2021.03.10 ¦Û©w§é¥i¯à¤j©ó¥i§é
		_total_amount = 0.00
		
		SELECT order_itemlist_tmp
		GO TOP 
		Scan For disc=.T. And real_amount>0 	And no_Ldisc=.F.

			_xdisc=ROUND(amount/_tm* _amt ,2) 		&&¥e¾ã³æ§é¦©¥÷ÃB
			&&Lihong 2021.03.10 ¦Û©w§é¥i¯à¤j©ó¥i§é¡A¤£¯à¶W¹Lamount
			_xdisc=IIF(_xdisc > amount, amount, _xdisc)
			_total_amount = _total_amount + amount

			Replace xdisc With xdisc + _xdisc

			_total_xdisc = _total_xdisc + _xdisc

		Endscan


		_xvalue= _amt  - _total_xdisc			&& §é¦©­pºâ »~®t
		&&Lihong 2021.03.10 ¦Û©w§é¥i¯à¤j©ó¥i§é
		IF _amt >= _total_amount 
			_xvalue = _total_amount - _total_xdisc	
		ENDIF 

		If _xvalue<>0

			Select Top 1 uid  From order_itemlist_tmp Where disc=.T.  And no_Ldisc=.F. Order By real_amount Desc  Into Cursor cun_tmp		&&±N­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤
			_uid=cun_tmp.uid
			Update order_itemlist_tmp Set xdisc=xdisc+_xvalue Where uid=_uid

		ENDIF
	

	
	ENDIF
	

	
	Select 	order_disc_tmp
	Go _recn

Endscan

*SET STEP ON 




IF VARTYPE(__tax_after_total)="U"  OR (VARTYPE(__tax_after_total)#"U" AND __tax_after_total= .f.)

	If Vartype(__srv_fee_be_tax)#"U" And __srv_fee_be_tax=.F.

		Update order_itemlist_tmp Set tax_amount=Iif(Vartype(__disc_tax)#"U" And __disc_tax, (amount -disc_amount)*tax_per/100,amount*tax_per/100) WHERE tax_free = .f. 	&&ªA°È¶O¤£­pµ|

	Else

		Update order_itemlist_tmp Set tax_amount=Iif(Vartype(__disc_tax)#"U" And __disc_tax, (amount + srv_amount-disc_amount )*tax_per/100,(amount+srv_amount)*tax_per/100) WHERE tax_free = .f.	&&ªA°È¶O«á¦A­pµ|

	Endif


ELSE

	Update order_itemlist_tmp Set tax_amount=  (amount +srv_amount-disc_amount -xdisc)*tax_per/100

ENDIF

Update order_itemlist_tmp Set real_amount=amount+srv_amount-disc_amount+tax_amount

order_disc_check()


Select	order_itemlist_tmp
Sum amount,srv_amount  To _totalamt ,_totalSrv  For disc=.T.  &&And no_Ldisc=.F.  		&&¥u¹ï¤¹³\§é¦©ªº¶i¦æ¾ã³æ§é¦©­pºâ

Select order_disc_tmp
Sum disc_amount To _disc_amount	 For disc_type<4			&&ªA°È¶O¤Îµ|¶µ¤£­pºâ

*SELECT item_disc_tmp
*Sum disc_amount  To _item_discamt 

*SET STEP ON 
If _totalamt>=0 And _disc_amount>_totalamt		&& ¤£¯à¤j©ó¥i§é¦©ª÷ÃB

	_disc_amount=_totalamt

Endif



*!*	LOCAL _total_disc_amt 

*!*	_total_disc_amt =_disc_amount

*!*	If _total_disc_amt >0

*	SET STEP ON 

*!*		_total_xdisc = 0.00

*!*		Select order_itemlist_tmp				&&¤À°t¾ã³æ§é¦©¨ì¦U­Ó¶µ¥Ø(level)
*!*		Sum amount To _tm For disc=.T. 	&&And no_Ldisc=.F.
	
*!*		If _tm>0
*!*			Go Top
*!*			Scan For disc=.T. And real_amount>0 	&&And no_Ldisc=.F.

*!*				_xdisc=ROUND(amount/_tm * _total_disc_amt,2) 		&&¥e¾ã³æ§é¦©¥÷ÃB


*!*				Replace xdisc With xdisc + _xdisc

*!*				_total_xdisc = _total_xdisc + _xdisc

*!*			Endscan

*!*		Endif

*!*		_xvalue=_total_disc_amt  - _total_xdisc			&& §é¦©­pºâ »~®t

*!*		If _xvalue<>0

*!*	*		Select Top 1 uid  From order_itemlist_tmp Where disc=.T.  And no_Ldisc=.F. Order By real_amount Desc  Into Cursor cun_tmp		&&±N­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤
*!*			Select Top 1 uid  From order_itemlist_tmp Where disc=.T.   Order By real_amount Desc  Into Cursor cun_tmp		&&±N­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤

*!*			_uid=cun_tmp.uid

*!*			Update order_itemlist_tmp Set xdisc=xdisc+_xvalue Where uid=_uid

*!*		Endif



*!*	Endif

*------------------------



*Update order_itemlist_tmp Set disc_amount=0 Where amount<0		&&­tª÷ÃB®É,¤£¤¹³\¦³§é¦©

Select order_itemlist_tmp
Sum xdisc To _total_xdisc
_xvalue=_disc_amount - _total_xdisc			&& §é¦©­pºâ »~®t

&&Lihong 2021.03.10 ¦Û©w§é¥i¯à¤j©ó¥i§é
_disc_amount = _total_xdisc

_xamt=	_totalamt - _disc_amount			&&=(Á`ª÷ÃB+¯S§O³B²zª÷ÃB¦X­p-¶µ¥Ø§é¦©ª÷ÃB¦X­p)-¾ã³æ§é¦©

_real_amount=rounding_amount(_xamt)		&&¹sÀY³B²z


_round_amount=_real_amount-_xamt		&&·L½Õ

*Select Top 1 uid  From order_itemlist_tmp Where disc=.T.  And  no_Ldisc=.F.  Order By real_amount Desc  Into Cursor cun_tmp		&&±N·L½Õ¤Î­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤
Select Top 1 uid  From order_itemlist_tmp Where disc=.T.   Order By real_amount Desc  Into Cursor cun_tmp		&&±N·L½Õ¤Î­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤


_uid=cun_tmp.uid
Update order_itemlist_tmp Set round_amount=0
*Update order_itemlist_tmp Set round_amount=_round_amount,xdisc=xdisc+_xvalue Where uid=_uid
Update order_itemlist_tmp Set round_amount=_round_amount Where uid=_uid

Update order_itemlist_tmp Set real_amount=amount+srv_amount-disc_amount+tax_amount


If Used("order_disc_tmp1")
	Use In  order_disc_tmp1
Endif

*** ³Ì§C®ø¶O ****

Select orgamt From order_itemlist_tmp Where item_id=-3 Into Cursor cun_tmp
Select cun_tmp
_mincharge=orgamt		&&³Ì§C®ø¶O

Select order_itemlist_tmp
&&Lihong 2021.03.10 µùÄÀ±¼§ï¬°¤U­± ¦Û©w§é¥i¯à¤j©ó¥i§é¡]¦P®É¼W¥[¨ä¥L­titem_id¡^
*Sum amount,srv_amount,tax_amount To _amount,_srvamt,_taxamt For  item_id>0 OR item_id=-51 && Lihong 2020.06.02
Sum amount,disc_amount,srv_amount,tax_amount To _amount,_item_discamt,_srvamt,_taxamt For  item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) && Lihong 2020.06.02

Sum srv_amount To _freeSrv_amt For   item_id>0 And srv_free	&& §KªA°È¶Oª÷ÃB

_srvamt  = _srvamt  - _freeSrv_amt

&&Lihong 2021.03.10 µùÄÀ±¼§ï¬°¤W­±
*Select item_disc_tmp
*Sum disc_amount  To _item_discamt  For disc_type<4  &&¶µ¥Ø§é¦©(¤£­p§K¶O¶µ)


&&Lihong 2021.03.10 µùÄÀ±¼§ï¬°¤W­±_total_xdisc ¦Û©w§é¥i¯à¤j©ó¥i§é
*Select order_disc_tmp
*Sum disc_amount To _disc_amount   For disc_type<4 	&&¾ã³æ§é¦©(¤£­p§K¶O¶µ)

	
SELECT order_itemlist_tmp
SUM amount   TO _can_disc_amount FOR disc=.t.  &&Lihong AND no_Ldisc=.f.  &&Lihong 2021.01.25 ¥h±¼no_Ldisc=.F.
IF _disc_amount >_can_disc_amount 
	
	_disc_amount =_can_disc_amount 

ENDIF



If _totalamt>=0 And  _disc_amount > _totalamt && +_srvamt 		&& ¤£¯à¤j©ó¥i§é¦©ª÷ÃB

	_disc_amount=_totalamt

Endif


_totalamt=_amount  +_srvamt + _taxamt - _disc_amount - _item_discamt



*SET STEP ON 

*_totalamt=IIF(_totalamt<0,0,_totalamt)

If _mincharge>0 		&&¦pªG¥¼¹F¨ì³Ì§C¦¬¶O,«ö³Ì§C®ø¶O­p
	Select order_itemlist_tmp
	Sum amount,srv_amount,tax_amount,disc_amount,xdisc To _amount1,_srvamt1,_taxamt1,_item_discamt1,_xdiscamt1 For  item_id>0 And mincharge=.T.
	Sum amount,srv_amount,tax_amount,disc_amount,xdisc To _amount2,_srvamt2,_taxamt2,_item_discamt2,_xdiscamt2 For  item_id>0 And mincharge=.F.

	_sub_amt1=_amount1 - _xdiscamt1 - _item_discamt1						&&¤p­p,¤£§tªA°È¶O(­p¤J³Ì§C®ø¶Oªº¶µ¥Ø)
	_sub_amt2=_amount2 - _xdiscamt2 - _item_discamt2+_srvamt2+_taxamt2		&&¤p­p,§tªA°È¶O(¤£­p¤J³Ì§C®ø¶Oªº¶µ¥Ø)

	If  _sub_amt1<_mincharge
		Update order_itemlist_tmp Set amount=Iif(_mincharge - _sub_amt1<0,0,_mincharge - _sub_amt1 ),Show=.T. Where item_id=-3
		&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
		Update order_itemlist_tmp Set srv_amount=amount*srv_per/100 Where item_id=-3
*!*			Update order_itemlist_tmp Set srv_amount=amount*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100 Where item_id=-3

		If Vartype(__srv_fee_be_tax)#"U" And __srv_fee_be_tax=.F.
			Update order_itemlist_tmp Set real_amount=amount-disc_amount+tax_amount Where item_id=-3

		Else
			Update order_itemlist_tmp Set real_amount=amount+srv_amount-disc_amount+tax_amount Where item_id=-3

		Endif

*			UPDATE order_itemlist_tmp SET real_amount= 0 WHERE real_amount<0

		Select srv_amount From order_itemlist_tmp Where item_id=-3 Into Cursor cun_tmp
		_mincharge_srv=cun_tmp.srv_amount							&&³Ì§C®ø¶OªºªA°È¶O

		_totalamt=_mincharge+_mincharge_srv+_srvamt1+_taxamt1  &&+2	 		&&³Ì§C®ø¶O+ªA°È¶O+¤£­p¤J³Ì§C®ø¶Oªº¶µ¥Ø

	Else
		Update order_itemlist_tmp Set amount=0,srv_amount=0,real_amount= 0,Show=.F. Where item_id=-3		&&¤£Åã¥Ü
	Endif

Endif


Select order_tax_tmp
Scan


	Select tax_amount,tax_per From order_itemlist_tmp Where uid=order_tax_tmp.parent_id Into Cursor cun_tmp
	If _Tally>0
		If cun_tmp.tax_per>0

			Select order_tax_tmp
			Replace amount With  tax_per/cun_tmp.tax_per*cun_tmp.tax_amount		&&¤À°t¦hµ|¶µ


		Endif



	Endif



Endscan

IF _amount  >0 AND _totalamt<0

	_totalamt=0

ENDIF



*_totalamt=IIF(_totalamt<0,0,_totalamt)
auto_check_itemdept()



IF VARTYPE(_pso_inv)#"U"

	RETURN _totalamt
ENDIF


Return  rounding_amount(_totalamt)

ENDFUNC

*--------------------------------------------

*-¾ã³æ§é¦©ÀË¬d
Function order_disc_check

Local _disc_amount,_rest_disc,_tm,_xdisc,_srv,_amount

Select order_disc_tmp
GO top
IF EOF()

	RETURN 
	
ENDIF


Sum disc_amount To _disc_amount For disc_type<4			&&ªA°È¶O¤Îµ|¶µ¤£­pºâ

SUM disc_amount TO _cust_disc_amount FOR (disc_type=2 OR disc_type=3) AND dedu_srv=.t.

Select	order_itemlist_tmp
Sum amount To _amount For disc=.T.	 And no_Ldisc=.F.	&&¥u¹ï¤¹³\§é¦©ªº¶i¦æ¾ã³æ§é¦©­pºâ

_rest_disc=0
If _disc_amount>_amount		&&¦pªG§é¦©¦³§E,¦A§éªA°È¶O

	_rest_disc=_disc_amount-_amount

Endif

_disc_amount=Iif(_disc_amount>_amount,_amount,_disc_amount)		&&¤£¥i¥H¬°­t¼Æ


Local lnAmount

Select order_itemlist_tmp
Scan For no_Ldisc=.F.

		&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
		_samt=(amount-disc_amount-xdisc)*srv_per/100
*!*			_samt=(amount-disc_amount-xdisc)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100
*!*			lnAmount=Iif(orgsrv,price0*qty,amount)		&&¬O§_«ö­ì»ù­pªA°È¶O		24/07/2008

*!*			Replace srv_amount With Iif(srv_free,0,Iif(__disc_srv,(lnAmount-disc_amount-xdisc)*srv_per/100,lnAmount*srv_per/100))		&&

*!*			If Vartype(__srv_fee_be_tax)#"U" And __srv_fee_be_tax=.F.
*!*				Replace tax_amount  With  Iif(tax_free,0,Iif(Vartype(__disc_tax)#"U" And __disc_tax,(amount -disc_amount)*tax_per/100,amount*tax_per/100))	&&ªA°È¶O¤£­pµ|
*!*			Else

*!*				Replace tax_amount  With  Iif(tax_free,0,Iif(Vartype(__disc_tax)#"U" And __disc_tax,(amount +srv_amount-disc_amount)*tax_per/100,(amount+srv_amount)*tax_per/100)) 	&&ªA°È¶O«á¦A­pµ|
*!*			ENDIF
*!*			
		
	IF (_rest_disc>0 OR  amount -disc_amount= 0) And	_cust_disc_amount >0	&&¦Û©w§é¦©¬O§_¥i¥H§KªA°È¶O
		
		IF 	_rest_disc>0

			_srv=srv_amount - _rest_disc
		
		ELSE
		
			_srv=srv_amount - _cust_disc_amount 
		ENDIF
		
		
		_rest_disc=_rest_disc-srv_amount
		_cust_disc_amount=_cust_disc_amount -srv_amount
		
		
		Replace srv_amount With Iif(_srv<0,0,_srv)		&&¤À°t§E¤Uªº§é¦©
		

	Endif

Endscan



Select order_itemlist_tmp
Sum srv_amount To _total_srv

Update order_itemlist_tmp Set srv_amount=Round(srv_amount,2)

Select order_itemlist_tmp
Sum srv_amount To _total_xsrv
_xvalue=_total_srv - _total_xsrv			&& §é¦©­pºâ »~®t(ªA°È¶O)

If _xvalue<>0

	Select Top 1 uid  From order_itemlist_tmp Where disc=.T. And srv_amount>0 Order By real_amount Desc  Into Cursor cun_tmp		&&±N­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤
	_uid=cun_tmp.uid
	Update order_itemlist_tmp Set srv_amount=srv_amount+_xvalue Where uid=_uid


Endif

*
Update order_itemlist_tmp Set srv_amount=0 Where  srv_amount<0

*!*	If Vartype(__srv_fee_be_tax)#"U" And __srv_fee_be_tax=.F.
*!*		Update order_itemlist_tmp Set tax_amount=Iif(tax_free,0,Iif(Vartype(__disc_tax)#"U" And __disc_tax,(amount-disc_amount-xdisc)*tax_per/100,amount*tax_per/100)) Where item_id>0	&&ªA°È¶O¤£­pµ|
*!*	Else
*!*		Update order_itemlist_tmp Set tax_amount=Iif(tax_free,0,Iif(Vartype(__disc_tax)#"U" And __disc_tax,(amount+srv_amount-disc_amount-xdisc)*tax_per/100,(amount+srv_amount)*tax_per/100)) Where item_id>0	&&ªA°È¶O«á¦A­pµ|

*!*	Endif


Update order_itemlist_tmp Set tax_amount=0 Where  tax_amount<0
Update order_itemlist_tmp Set real_amount=amount+srv_amount-disc_amount+tax_amount Where item_id>0		&&¦A­pºâ¤@¦¸


Endfunc



**************************
FUNCTION  auto_check_itemdept

SELECT * FROM order_itemlist_tmp WHERE askdept AND uid in (SELECT parent_id FROM order_dept_tmp) INTO CURSOR check_itemdept_tmp
SELECT check_itemdept_tmp

SCAN
	
*	lnItem_amount=check_itemdept_tmp.real_amount + check_itemdept_tmp.round_amount - check_itemdept_tmp.xdisc    - check_itemdept_tmp.srv_amount
	lnItem_amount=check_itemdept_tmp.real_amount - ROUND(check_itemdept_tmp.srv_amount,2) &&Lihong 2022.05.27 add ROUND, 

	lnItem_SrvAmt=ROUND(check_itemdept_tmp.srv_amount,2) &&Lihong 2022.05.27 add ROUND
	

	SELECT  SUM(amount) as amount,SUM(srvamt) as srvamt  FROM order_dept_tmp WHERE parent_id=check_itemdept_tmp.uid INTO CURSOR cun_tmp
	lnDept_Amount=cun_tmp.amount
	
	lnDept_Srvamt =cun_tmp.srvamt

	IF lnItem_amount<> lnDept_Amount
	
		
		SELECT order_dept_tmp 
		SCAN FOR  parent_id=check_itemdept_tmp.uid
		
			*REPLACE  amount  WITH   ROUND( lnItem_amount  *  amount / lnDept_Amount ,2)  
			&&Lihong 2022.02.23 ¼W¥[IIF(lnDept_Amount=0, 0.00
			REPLACE  amount  WITH   ROUND( IIF(lnDept_Amount=0, 0.00, lnItem_amount  *  amount / lnDept_Amount) ,1)  &&Lihong 2022.05.27 §ï¬°1¦ì¤p¼Æ
			*IF lnDept_Amount <> 0
			*	REPLACE  amount  WITH   ROUND( lnItem_amount  *  amount / lnDept_Amount ,2) 
			*ELSE
			*ENDIF 
		ENDSCAN
		
		SELECT order_dept_tmp 	
		SUM amount TO lnAmt   FOR  parent_id=check_itemdept_tmp.uid
		
		IF  lnItem_amount <>	lnAmt 
		
			SELECT TOP 1 dept_id FROM order_dept_tmp  WHERE parent_id=check_itemdept_tmp.uid  ORDER BY amount  DESC INTO CURSOR cun_tmp
			
			UPDATE  order_dept_tmp  SET  amount =amount + (lnItem_amount - lnAmt) WHERE dept_id=cun_tmp.dept_id  AND  parent_id=check_itemdept_tmp.uid 
			
		
		ENDIF
		
		
	ENDIF
	

	IF lnItem_SrvAmt<> lnDept_Srvamt 


		SELECT order_dept_tmp 
		SCAN FOR  parent_id=check_itemdept_tmp.uid
		
		IF VARTYPE(__change_item_set_detail)#"U" AND __change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
			REPLACE   srvamt  WITH 	 ROUND(IIF(lnDept_Srvamt=0, 0.00, lnItem_SrvAmt * srvamt /lnDept_Srvamt) , 1) &&Lihong 2022.05.27 §ï¬°1¦ì¤p¼Æ
		ELSE 
			REPLACE   srvamt  WITH 	 ROUND(IIF(lnDept_Srvamt=0, 0.00, lnDept_Srvamt  * srvamt /lnDept_Srvamt) , 1) &&Lihong 2022.01.19 ¼W¥[IIF(lnDept_Srvamt=0, 0.00 &&Lihong 2022.05.27 §ï¬°1¦ì¤p¼Æ
		ENDIF 	
	
		ENDSCAN

		SELECT order_dept_tmp 	
		SUM srvamt  TO lnSrv  FOR  parent_id=check_itemdept_tmp.uid
		
		IF VARTYPE(__change_item_set_detail)#"U" AND __change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
			IF  lnItem_SrvAmt <>	lnSrv  
				SELECT TOP 1 dept_id FROM order_dept_tmp  WHERE parent_id=check_itemdept_tmp.uid  ORDER BY amount  DESC INTO CURSOR cun_tmp
				UPDATE  order_dept_tmp  SET  srvamt =srvamt + (lnItem_SrvAmt - lnSrv ) WHERE dept_id=cun_tmp.dept_id  AND  parent_id=check_itemdept_tmp.uid 
			ENDIF
		ELSE 
			IF  lnDept_Srvamt  <>	lnSrv  
			
				SELECT TOP 1 dept_id FROM order_dept_tmp  WHERE parent_id=check_itemdept_tmp.uid  ORDER BY amount  DESC INTO CURSOR cun_tmp
				
				UPDATE  order_dept_tmp  SET  srvamt =srvamt + (lnDept_Srvamt - lnSrv ) WHERE dept_id=cun_tmp.dept_id  AND  parent_id=check_itemdept_tmp.uid 
				
			
			ENDIF
		ENDIF 

		
	
	ENDIF
	


ENDSCAN




ENDFUNC



*	FUNCTION CHECK_ITEM_DISC
*	ÀË¬d¶µ¥Ø§é¦©
************************
Function check_item_disc
Lparameters _NitemId


Select * From item_disc_tmp Where item_id=_NitemId Into Cursor  cun_tmp
Delete From item_disc_tmp  Where  item_id=_NitemId	&&§R°£·í«e¶µ¥Øªº¥þ³¡§é¦©

Select * From order_itemlist_tmp Where uid=_NitemId  Into Cursor cun_tmp1
Select cun_tmp1
_amount=cun_tmp1.amount
&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
_srvper=cun_tmp1.srv_per
*!*	_srvper=IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,cun_tmp1.srv_per + _inv_srv_perc,MAX(cun_tmp1.srv_per,_inv_srv_perc)),cun_tmp1.srv_per)
_srvamt=cun_tmp1.srv_amount

_taxamt=cun_tmp1.tax_amount
_taxper=cun_tmp1.tax_per
_realAmt=_amount+_srvamt+_taxamt

*_orgsrv=cun_tmp1.orgsrv

Local  _disc_amount
_disc_amount=0
Select cun_tmp						&&¦A­«·s²K¥[ , ­pºâ§é¦©
Scan

*SET STEP ON 
	_ndiscid=cun_tmp.disc_id
	_disc_type=cun_tmp.disc_type
	_desc=cun_tmp.descdisp
	_discper=cun_tmp.disc_per
	_discamt=cun_tmp.disc_amount
	_uid=cun_tmp.uid

	_adduser=cun_tmp.adduser
	_disc_qty=cun_tmp.disc_qty

	_minamt=cun_tmp.minamt
	_dedu_srv=cun_tmp.dedu_srv

	Do Case


		Case _disc_type=4		&&§KªA°È¶O


			Select order_itemlist_tmp
			Sum srv_amount  To _srvamt For uid=_NitemId   And srv_free=.F.

*			_amt= IIF(__disc_srv, _srvamt ,0)

			_amt = _srvamt

			Update order_itemlist_tmp Set srv_amount=0,srv_free=.T. Where uid=_NitemId And srv_free=.F.

		*	UPDATE order_dept_tmp  SET srvamt =0  WHERE  parent_id = _NitemId 




		Case _disc_type=5		&&§Kµ|¶µ


			Select order_itemlist_tmp
			Sum tax_amount To _taxamt For uid=_NitemId
			_amt=_taxamt


			Update order_itemlist_tmp Set tax_amount =0,tax_free=.T. Where uid=_NitemId 	&&And tax_free=.F.

			*SET STEP ON 

		Otherwise


*			_amt=Iif(_discper>0,Iif(__disc_srv,(_amount-_disc_amount)*_discper/100, _amount*_discper/100),_discamt)

			Select order_itemlist_tmp
			Sum srv_amount  To _srvamt For uid=_NitemId   And srv_free=.F.
			Sum tax_amount  To _taxamt For uid=_NitemId   And tax_free=.F.
	
			_taxamt  = IIF(VARTYPE(__tax_after_total )#"U" and __tax_after_total , 0,_taxamt  )
			
			_amt=Iif(_discper>0, (_amount  + IIF(__disc_srv , _srvamt  , 0)  +   IIF(__disc_tax , _taxamt  , 0) - _disc_amount)*_discper/100,_discamt)

*			_amt=Iif(_discper>0, (_amount   - _disc_amount)*_discper/100,_discamt)


			If __disc_srv  And _discper=100		&& §K¶O©^°e®É¡AªA°È¶O¤]§é¦©
			
				
				_amt=Iif(_discper>0, (_amount   - _disc_amount)*_discper/100,_discamt)

				Update order_itemlist_tmp Set srv_free=.T.,srv_amount =0 Where uid=_NitemId And srv_free=.F.


			ENDIF
			
			
			If __disc_tax  And _discper=100		&& §K¶O©^°e®É¡Aµ|¶µ¤]§é¦©
			
				
			*	_amt=Iif(_discper>0, (_amount   - _disc_amount)*_discper/100,_discamt)

				Update order_itemlist_tmp Set tax_free=.T.,tax_amount =0 Where uid=_NitemId And tax_free=.F.


			Endif			


			_disc_amount=_disc_amount+_amt




	Endcase


*!*		&&Lihong 2021.04.23 ¦P®É³B²zdisc_log
*!*		IF lninv_no_id>0
*!*			If _amt>=0
*!*				IF _amt <> cun_tmp.disc_amount
*!*					ssql =" update disc_log set disc_amount = ?_amt where disc_type='1' and id = (select MAX(id) from disc_log where disc_type='1' and inv_no =?lninv_no_id and disc_id=?cun_tmp.disc_id and disc_amount = ?cun_tmp.disc_amount) "
*!*				ELSE
*!*					ssql =""
*!*				ENDIF 
*!*			ELSE 
*!*				ssql =" update disc_log set void = 1 ,datetime= getdate() where disc_type='1' and id = (select MAX(id) from disc_log where disc_type='1' and inv_no =?lninv_no_id and disc_id=?cun_tmp.disc_id and disc_amount = ?cun_tmp.disc_amount) "
*!*			ENDIF 
*!*			If !EMPTY(ssql) AND SQLExec(nhand, ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				*SQLSetprop(nhand,"Transactions",1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return .F.
*!*			ENDIF 
*!*		ENDIF 

	If _amt>=0
		&&Lihong 2020.06.02 coupon coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code
		Insert Into item_disc_tmp (uid,item_id,disc_id,disc_type,descdisp,disc_per,disc_amount,adduser,disc_reason,disc_remark,disc_qty,minamt,dedu_srv,new, ;
		coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code, after_inv) ;
			VALUES (_uid,_NitemId ,_ndiscid,_disc_type,_desc,_discper,_amt,_adduser,cun_tmp.disc_reason,cun_tmp.disc_remark,_disc_qty,_minamt,_dedu_srv,cun_tmp.new, ;
			cun_tmp.coupon_lock_valid, NVL(cun_tmp.cloud_coupon_id,0), cun_tmp.web_coupon_id, NVL(cun_tmp.web_coupon_code,""), cun_tmp.after_inv )
	Endif


	If _disc_type<4
			&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
		IF VARTYPE(m.__change_item_set_detail)#"U" AND m.__change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
			Update order_itemlist_tmp Set srv_amount=Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount) - disc_amount)*srv_per/100,Iif(orgsrv,price0*qty,amount)	*srv_per/100) Where uid=_NitemId AND srv_free=.F. 
		ELSE 
			Update order_itemlist_tmp Set srv_amount=Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount) - disc_amount)*srv_per/100,Iif(orgsrv,price0*qty,amount)	*srv_per/100) Where uid=_NitemId AND srv_free=.F. AND askdept=.f.  &&§é¦©«áªA°È¶O(¸òsetting) 
		ENDIF 
*!*			IF VARTYPE(m.__change_item_set_detail)#"U" AND m.__change_item_set_detail &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
*!*				Update order_itemlist_tmp Set srv_amount=Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount) - disc_amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100,;
*!*				Iif(orgsrv,price0*qty,amount)	*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100) Where uid=_NitemId AND srv_free=.F. 
*!*			ELSE 
*!*				Update order_itemlist_tmp Set srv_amount=Iif(__disc_srv,(Iif(orgsrv,price0*qty,amount) - disc_amount)*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100,;
*!*				Iif(orgsrv,price0*qty,amount)	*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100) Where uid=_NitemId AND srv_free=.F. AND askdept=.f.  &&§é¦©«áªA°È¶O(¸òsetting) 
*!*			ENDIF 

		If Vartype(__srv_fee_be_tax)#"U" And __srv_fee_be_tax=.F.
			Update order_itemlist_tmp Set tax_amount=Iif( __disc_tax,(amount-disc_amount-xdisc)*tax_per/100,amount*tax_per/100) Where  uid=_NitemId AND tax_free=.F.	&&ªA°È¶O¤£­pµ|
		Else
			Update order_itemlist_tmp Set tax_amount=Iif( __disc_tax,(amount+srv_amount-disc_amount-xdisc)*tax_per/100,(amount+srv_amount)*tax_per/100) Where uid=_NitemId  AND tax_free=.F.&&ªA°È¶O«á¦A­pµ|

		Endif

	Endif



Endscan

&&Lihong 2023.02.15
Select * From order_itemlist_tmp Where uid=_NitemId  Into Cursor cun_tmp1
Select cun_tmp1
_srvamt=cun_tmp1.srv_amount
_taxamt=cun_tmp1.tax_amount
_realAmt=_amount+_srvamt+_taxamt
&&

&&Lihong 2021.03.26
*_disc_amount=Iif(_disc_amount>_realAmt,_realAmt,_disc_amount)
_disc_amount=IIF(_realAmt<=0, 0, IIF(_disc_amount>_realAmt, _realAmt, _disc_amount) )

Update order_itemlist_tmp Set  disc_amount=_disc_amount Where  uid=_NitemId AND disc=.t.  &&§ó·s¶µ¥Ø§é¦©


Select item_disc_tmp
Sum disc_amount To _disc_amount For  item_id=_NitemId	&&ªA°È¶O¤Îµ|¶µ¤£­pºâ

Sum disc_amount To _cust_disc_amount For  dedu_srv And item_id=_NitemId	&&¥i¹ï¨RªA°È¶Oªº§é¦©

If _disc_amount>_amount And _cust_disc_amount >0		&&¦pªG§é¦©¦³§E¡A¥Ñ¥i¹ï¨RªA°È¶Oªº§é¦©¨Ó¦©´î


	Update order_itemlist_tmp  Set srv_amount=srv_amount-(_disc_amount- _amount) Where uid=_NitemId


Endif


Update order_itemlist_tmp Set srv_amount=0 Where  srv_amount<0
Update order_itemlist_tmp Set tax_amount=0 Where  tax_amount<0
If Used("cun_tmp2")
	Use In cun_tmp2
Endif


Endfunc

************************
*	FUNCTION CLEAN_REPORT		²M¾÷¤Î¤éµ²
*
***********************
Function clean_report

parameters _email, _do_print, _chkinv_detail, _chkvoided_item, _chkdept, _dayEnd_report, _show_cashier,_begdate, _enddate, _clnID, _cln_time




&&_do_print ¬°.t.®É¥´¦L,.f.®É¬°¹wÄý¤è¦¡
*_chkinv_detail 	µo²¼²Ó¸`
*_chkvoided_item	¨ú®øµo²¼
*_chkdept			³¡ªù¤ÀªR
*_dayEnd_report		¬O§_¤éµ²
*_dayend_print		¬O§_¤éµ²¥´¦L

SET DECIMALS TO 2

frm_wait.Show
Wait "" To N Timeout 0.1

Local i
For i=1 To 23
	_curs="cun_tmp"+Alltrim(Str(i))

	If Used("&_curs")
		Select &_curs
		Use

	Endif

Endfor

*Local _clean_reprint
_clean_reprint=.F.

If Vartype(_clnID)="N"			&&¬O§_­«¦L²M¾÷³æ

	_clean_reprint=Iif(_clnID>0,.T.,.F.)

Endif

sdate=""
edate=""


If _clean_reprint
	_cln_no=getmessage("_cln_no")+":"+Alltrim(Str(_clnID))
	_ReprintInfo=""


Else

	_cln_no=""
	_ReprintInfo=""

Endif


If Vartype(_begdate)="D"
	sdate=_begdate

Else
	sdate=getbelongdate()

Endif

If Vartype(_enddate)="D"
	edate=_enddate

Else
	edate=getbelongdate()

Endif


_clnTime=Datetime()		&&²M¾÷®É¶¡


If Vartype(_clnID)="N"	 And _clnID>0		&&¬O§_­«¦L²M¾÷³æ


*	ssql="select computer  from station where id in (( select top 1 station_id from inv where cln=?_clnID ) union all (select top 1 station_id from his_inv where cln=?_clnID ))"		&& 2010.09.24

	ssql="select computer  from station where id in ( select top 1 station_id from inv where cln=?_clnID )"		&& 2010.09.24

	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif

	_computer=Trim(cun_tmp.computer)

*Else

*	_computer=getcomputername()

Endif

*_station_id=__station_id

*!*	&&Lihong 2022.05.10
*!*	Do Case
*!*		Case _clean_reprint			&&­«¦L²M¾÷³æ
*!*		Case  _dayEnd_report		&&¤éµ²
*!*		Otherwise 					&&²M¾÷
*!*		IF LOWER(__special_customer)=="ms"
*!*		*(isnull(pay_cashier_user_id, -1) = ?__login_user_id or isnull(pay_cashier_user_id, -1) = -1 and adduser = ?_login_user_name )
*!*			TEXT TO ssql TEXTMERGE NOSHOW 
*!*				/*
*!*				 SELECT id,tableno FROM inv WITH (nolock) where id>0 AND id in (SELECT inv_id FROM order_main WITH (nolock) WHERE id in (SELECT order_id FROM tables WITH (nolock) WHERE nsubtable=0) )
*!*				 and year(paidtime)<=2000 and cln=0 and void=0 and (isnull(inv_prt_cashier_user_id, -1) = ?__login_user_id or isnull(inv_prt_cashier_user_id, -1) = -1 and adduser = ?_login_user_name ) 
*!*				 */
*!*				
*!*				SELECT tableno FROM inv WITH (nolock) where id>0 AND (split=0 and id in (SELECT inv_id FROM order_main WITH (nolock) WHERE id in (SELECT order_id FROM tables WITH (nolock) WHERE nsubtable=0) ) 
*!*				or split>0 and split in (SELECT split FROM tables WITH (nolock) WHERE nsubtable=0) )
*!*				and year(paidtime)<=2000 and cln=0 and void=0 and (isnull(inv_prt_cashier_user_id, -1) = ?__login_user_id or isnull(inv_prt_cashier_user_id, -1) = -1 and adduser = ?_login_user_name )
*!*				group by tableno
*!*			ENDTEXT 

*!*			If SQLExec(nhand,ssql,"cun_tmp_nopaid_inv")<0
*!*				Aerror(err)
*!*				frm_wait.Hide
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return -1
*!*			Endif
*!*			IF RECCOUNT("cun_tmp_nopaid_inv")>0
*!*				fmessagebox("§A¦³¥¼¦¬»Èµo²¼¡A®à¸¹¡G"+UPPER(TRIM(cun_tmp_nopaid_inv.tableno)) +CHR(13) + "¤£¯à¶i¦æ²M¾÷!")
*!*				Return -1
*!*			ENDIF 
*!*		ENDIF 
*!*	Endcase


&&Lihong 2022.02.25 
USE IN SELECT("cun_tmp")
USE IN SELECT("cun_tmp23")
IF USED("cun_itemdept")
	USE IN "cun_itemdept"
ENDIF 

IF clean_report_extend()<0
	RETURN -1
ENDIF 


&&Lihong 2022.05.10
*Lihong 2023.08.03 IF LOWER(__special_customer)=="ms" 
	SELECT cun_tmp
	REPLACE ALL adduser WITH pay_cashier_user FOR !ISNULL(pay_cashier_user_id)
	GO TOP 
	SELECT cun_tmp11
	REPLACE ALL adduser WITH pay_cashier_user FOR !ISNULL(pay_cashier_user_id)
	GO TOP 
	&&Lihong 2023.08.03
	SELECT cun_tmp13
	REPLACE ALL adduser WITH pay_cashier_user FOR !ISNULL(pay_cashier_user_id)
	GO TOP 
	IF VARTYPE(__deposit_once)#"U" and __deposit_once AND USED("cun_tmp23") AND !Eof("cun_tmp23")
		SELECT cun_tmp23
		REPLACE ALL adduser WITH pay_cashier_user FOR !ISNULL(pay_cashier_user_id)
		GO TOP 
	ENDIF 
*ENDIF 

&&Lihong 2021.12.15 ·|­û®ø¶O°O¿ý cun_tmp22->23  
IF _Memb_Record
	SELECT * FROM cun_tmp22 INTO CURSOR cun_tmp220
	USE IN SELECT("cun_tmp22")
ENDIF 

_tmpprefix = "'" + Alltrim(__member_card_mark) + "'"

=SQLExec(nhand, "drop table #t1")

cond=""

&&Lihong 2020.09.01 RMS ¥R­È ©ó²M¾÷/¤éµ²®É¤À¶}2±ø¼Æ
_orgamt_points_sales = 0
_corgamt_points_sales = ""
IF Vartype(__points_show_in_dayend)#"U" And __points_show_in_dayend ;
AND !"redant"$Lower(__special_customer) ;
AND !"shirokiya"$Lower(__special_customer) ;
AND !"kamloi"$Lower(__special_customer) ;
AND !LOWER(__special_customer)="good" 

	_corgamt_points_sales = __points_show_in_dayend_name
	LOCAL points_sale_id
	Do Case
		Case _clean_reprint			&&­«¦L²M¾÷³æ
			points_sale_id = "select id from " + view_inv +" where  void=0 and cln=?_clnID "
		Case  _dayEnd_report		&&¤éµ²
	*!*			Local cond
	*!*			cond=""
	*!*			If _outlet_id<>-1
	*!*				cond=" and inv.outlet_id=?_outlet_id "
	*!*			Endif
			points_sale_id = "select id from " + view_inv +" as inv where  belongdate>=?_begdate and belongdate<=?_enddate and void=0 " + cond
		Otherwise 					&&²M¾÷
			Do Case
				Case Upper(__checked_method)="USER"		&&²M¾÷¤è¦¡,«öuser
				&&Lihong 2022.05.10 "ms"¥¼¥Î
				lcadduser_filter = "adduser=?_login_user_name"
*!*					IF LOWER(__special_customer)=="ms" 
*!*						lcadduser_filter = "(isnull(pay_cashier_user_id, -1) = ?__login_user_id or isnull(pay_cashier_user_id, -1) = -1 and adduser = ?_login_user_name)"
*!*					ENDIF 
				points_sale_id = "select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter
				Case Upper(__checked_method)="STATION"		&&²M¾÷¤è¦¡,«östation
				points_sale_id = "select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id "
				Otherwise								&&²M¾÷¤è¦¡,¥þ³¡
				points_sale_id = "select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 "
			Endcase
	ENDCASE
	TEXT TO ssql TEXTMERGE NOSHOW 
		select SUM(ISNULL(a.real_amount, 0) + ISNULL(a.round_amount, 0) + ISNULL(a.xdisc, 0)) as orgamt from inv_detail_view a with (nolock) 
		where ( ISNULL(a.PointRate, 0)>0 or ISNULL(a.PointFix, 0)>0 )
		and a.id in ( <<points_sale_id>> )
	ENDTEXT 
	If SQLExec(nhand,ssql, "points_sale_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
	_orgamt_points_sales = NVL(points_sale_tmp.orgamt, 0) 
	USE IN SELECT("points_sale_tmp")
ENDIF 
&&

Do Case

	Case _clean_reprint			&&­«¦L²M¾÷³æ

		cond="a.cln=?_clnID"

	Case  _dayEnd_report		&&¤éµ²

		cond="a.belongdate>=?_begdate and a.belongdate<=?_enddate order by a.id "

	Otherwise 					&&²M¾÷


		Do Case
			Case Upper(__checked_method)="USER"		&&²M¾÷¤è¦¡,«öuser
				&&Lihong 2022.05.10 "ms"¥¼¥Î
				lcadduser_filter = "a.adduser=?_login_user_name"
*!*					IF LOWER(__special_customer)=="ms" 
*!*						lcadduser_filter = "(isnull(a.pay_cashier_user_id, -1) = ?__login_user_id or isnull(a.pay_cashier_user_id, -1) = -1 and a.adduser = ?_login_user_name)"
*!*					ENDIF 
				cond="year(a.paidtime)>2000 and a.cln=0 and "+lcadduser_filter+" order by a.id"

			Case Upper(__checked_method)="STATION"		&&²M¾÷¤è¦¡,«östation
				cond="year(a.paidtime)>2000 and a.cln=0 and  a.station_id=?_station_id order by a.id"

			Otherwise								&&²M¾÷¤è¦¡,¥þ³¡

				cond="year(a.paidtime)>2000 and a.cln=0  order by a.id"

		Endcase


Endcase


If Vartype(__member_printer_installed)#"U" And __member_printer_installed

	&&Lihong 2022.05.10 "ms"¥¼¥Î
	lcadduser_field = "a.adduser as cashier"
	lcadduser_join = ""
*!*		IF LOWER(__special_customer)=="ms" 
*!*			lcadduser_field = "case when isnull(a.pay_cashier_user_id, -1) = -1 then a.adduser else isnull(sys_user.name,'') end as as cashier"
*!*			lcadduser_join = "left join sys_user with (nolock) on a.pay_cashier_user_id=sys_user.id"
*!*		ENDIF 
	
	&&Lihong 2022.05.10 left join sys_user,   -> case when isnull(a.pay_cashier_user_id, -1) = -1 then a.adduser else isnull(sys_user.name,'') end as as cashier
	TEXT TO cmd NOSHOW TEXTMERGE
		select <<_tmpprefix>> + rtrim(cast(a.id as nvarchar(10))) as id , a.id as invno ,
		 a.discamt as discount, <<lcadduser_field>>  into #t1
		from inv a with (nolock) left join inv_problem b with (nolock) on a.id = b.inv_id <<lcadduser_join>>
		where a.discamt = 0 and void=0 and <<cond>>

		select a.* , isnull(b.card_no, '') as cardno,b.amount from #t1 a left join lms_log b on a.id = b.inv_no where a.id in (select inv_no from lms_log WHERE member_type='Ant Club' )  ORDER BY invno
	ENDTEXT


	If SQLExec(nhand, cmd, "cun_tmp22") < 0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))


		Return -1
	Endif


Endif




If SQLExec(nhand,"select * from fastfood_info order by dispord","fastfood_info_tmp")<0		&&2009.10.21
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif


If _show_section		&&Àç·~®É¬q 2011.07.28


	If SQLExec(nhand, "select * from system_period order by id", "section_tmp") < 0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif


Endif



If Eof("cun_tmp") And Eof("cun_tmp1")		&&¨S¦³µo²¼¤Î¨ú®øµo²¼(¦p¦³¨ú®øµo²¼¤]¤¹³\²M¾÷©Î¤éµ²)

	frm_wait.Hide
	If _dayEnd_report
		fmessagebox("_no_data_for_dayend")
		write_log(105,"No_data_for_dayend:"+TTOC(DATETIME())+",login_user_id="+TRANSFORM(__login_user_id) )
	Else

		fmessagebox("_all_inv_checked")
		write_log(105,"All_inv_checked:"+TTOC(DATETIME())+",login_user_id="+TRANSFORM(__login_user_id) )
	Endif

	Return -1
Endif

_cln_reprint=Iif( _clean_reprint ,getmessage("_clean_reprint")  ,"")		&&²M¾÷­«¦L
_cReportName=Iif(_dayEnd_report And _clean_reprint=.F. ,getmessage("_dayEnd_report"),getmessage("_crashier_report"))	&&²M¾÷³øªí



_ctime=getmessage("_time")+":"
If Vartype(_cln_time)="T"

	_CleanTime=Ttoc(_cln_time)
Else

	If _dayEnd_report

		_CleanTime=Iif(sdate=edate,Dtoc(sdate),Dtoc(sdate)+" "+getmessage("_to")+" "+Dtoc(edate))

	Else

		_CleanTime=Ttoc(Datetime())
		
	Endif

Endif





_cMachineNo=Iif(Upper(__checked_method)="STATION",getmessage("_machineno"),"")

_Machine=Iif(Upper(__checked_method)="STATION",_computer,"")


*!*	_cCashier=Iif(Upper(__checked_method)="USER",getmessage("_cashier"),"")
*!*	_Cashier=Iif(Upper(__checked_method)="USER",_login_user_name,"")

_cCashier=getmessage("_cashier")
_Cashier=_login_user_name


_cUser=getmessage("_user")			&&	¨Ï¥ÎªÌ

_cInvList=getmessage("_inv_list")

_cinvno=getmessage("_invno")		&&µo²¼¸¹½X
_cPplCnt=getmessage("_pplcnt")		&&¤H¼Æ
_cPayway=getmessage("_payway")		&&¥I´Ú¤è¦¡
_cAmt=getmessage("_amount")			&&ª÷ÃB
_cTips=getmessage("_tips")			&&¤p±b
_ctotal=getmessage("_total")	&&+"("+TRIM(__local_CURRENCY)+")"		&&¦X­p

_cvoid_InvList=getmessage("_void_inv_list")		&&¨ú®øµo²¼²M³æ
_cPayAnalyse=getmessage("_pay_analyse")			&&¥I´Ú¤ÀªR
_cDiscAnalyse=getmessage("_Disc_Analyse")		&&§é¦©¤ÀªR
_cDeptAnalyse=getmessage("_dept_analyse")		&&³¡ªù¤ÀªR
_coutletAnalyse=getmessage("_outlet_Analyse")	&&°Ï°ì¤ÀªR
_citemAnalyse=getmessage("_item_Analyse")		&&µæ¦¡¤ÀªR
_cExpenseAnalyse=getmessage("_expense_Analyse") &&¶}¤ä¤ÀªR

_cTaxAnalyse=getmessage("_tax_Analyse")			&&µ|¶µ¤ÀªR

&&·|­û®ø¶O°O¿ý
*IF _Memb_Record
	_cMembAnalyse=getmessage("_member_sales") &&·|­û®ø¶O°O¿ý Member Sales History
	_cPurchase_count = getmessage("_purchased_count") &&®ø¶O¦¸¼Æ Purchased Count
	_cPurchase_amount = getmessage("_purchased_amount") &&®ø¶Oª÷ÃB Purchased Amount
	_cRecharge_count = getmessage("_recharged_count") &&¥R­È¦¸¼Æ Recharge Count
	_cRecharge_amount = getmessage("_recharge_amount") &&¥R­Èª÷ÃB 
	_cMember_name = getmessage("_member_name")
*ENDIF 
_cvoid_inv_count = getmessage("_void_inv_count")  &&¨ú®øµo²¼±i¼Æ Voided Invoice Count
_cvoid_inv_amount = getmessage("_void_inv_amount")  &&¨ú®øµo²¼ª÷ÃB Voided Invoice Amount


_cvoidreason=getmessage("_void_reason")		&&¨ú®ø­ì¦]
_ctimes=getmessage("_times")				&&¦¸¼Æ

_corgamt=getmessage("_orgamt")				&&­ì©lª÷ÃB
_crounding=getmessage("_rounding")			&&·L½Õ
_csubtotal=getmessage("_subtotalamt")			&&¤p­p
_csrv=getmessage("_svr_charge")				&&ªA°È¶O
_ctax=getmessage("_taxfee")					&&µ|¶µ

_cpayamt=getmessage("_pay_only")
_ctotal_tips=getmessage("_total_tips")

_ctotal_income=getmessage("_total_income")	&&¦@¦¬ª÷ÃB

_cvoid_itemlist=getmessage("_void_item")	&&¨ú®øµæ¦¡
_citem=getmessage("_item_name")					&&µæ¦¡
_cqty=getmessage("_qty")					&&¼Æ¶q


_cinv_qty=getmessage("_inv_qty")			&&µo²¼±i¶q
_ccust_qty=getmessage("_cust_qty")			&&ÅU«È¤H¼Æ
_cAmtPerhead=getmessage("_amtperhead")		&&¤H§¡®ø¶O
_cAmtPerorder=getmessage("_amtperorder")		&&¥­§¡¨C³æ®ø¶O

_cdine_In=getmessage("_dine_in")			&&°ó®y
_cfastfood=getmessage("_fastfood")			&&§ÖÀ\

_cend=getmessage("_end")					&&µ²§ô
_cdiscount=getmessage("_discount")			&&§é¦©

_citemqty=getmessage("_item_qty")			&&µæ¦¡¼Æ¶q

_cdept=getmessage("_department")			&&³¡ªù
_cdeptAmt=getmessage("_dept_amt")			&&³¡ªù¤À±b

_coutlet=getmessage("_outlet")				&&Àç·~°Ï°ì
_citem=getmessage("_item_name")				&&µæ¦¡¦WºÙ

_cexpense_desc=getmessage("_expense_desc")
_cExpense_amt=getmessage("_expense_amount")		&&¤ä¥Xª÷ÃB

_cCash_amt=getmessage("_cash_amt")			&&¹ê¦¬²{ª÷

_cChgPriceLog=getmessage("_change_price_log")		&&§ó§ï»ù®æ°O¿ý


_cChgInvLog=getmessage("_change_inv_log")		&&§ó§ïµo²¼°O¿ý


_cTax_desc=getmessage("_tax")				&&µ|¶µ

_ctotal_cash=getmessage("_total_cash")

_cDesc=getmessage("_name")
_cFastFood_Analyse=getmessage("_cFastFood_Analyse")		&&§ÖÀ\¤ÀªR

_cdisc_after_inv=getmessage("_cDisc_after_inv")		&& ¦L³æ«á§é¦©

_cNoDisc_points_card=getmessage("_cNoDisc_points_card")
_cMember_no=getmessage("_member_no")

_cdiscamt=getmessage("_discamt")		&&§é¦©ª÷ÃB

_cNetAmt =getmessage("_netamt")		&&¹ê¦¬ª÷ÃB

_cless_cash =getmessage("_less_cash")	&&¤Ö¦¬²{ª÷
_hourly_sales =getmessage("_hourly_sales")	&&¨C¤p®ÉÀç·~ÃB

_systemperiod=getmessage("_systemperiod")		&&Àç·~®É¬q

_cdisc_after_inv=getmessage("_cdisc_after_inv")	&&¦L³æ«á§é¦©

_percentage=getmessage("_percentage")		&&¦Ê¤À¤ñ

_time_frame=getmessage("_time_frame")	&&®É¬q

_cnodisc_points_card=getmessage("_cnodisc_points_card")	&&µL¿n¤À¦³§é¦©·|­û¥d

_inv_qty=getmessage("_inv_qty")	&&µo²¼¼Æ¶q

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
_cdepositList = getmessage("_deposit_list") &&­qª÷²M³æ	Deposit List
_cDepositNo = getmessage("lbl_deposit_no")
_cPayAnalyse_depost = getmessage("_pay_analyse_deposit") &&¦¬¨üªº­qª÷ Deposit Received

If Used("cln_tmp")
	Select cln_tmp
	Use

Endif

Create Cursor cln_tmp (r_id Int)				&&report index
Append Blank
Replace r_id With 1		&&-->¥Î©óµo²¼²M³æ

&&Lihong 2021.04.14
IF !__special_customer == "fung_shou_hotpot"
	Append Blank
	Replace r_id With 2		&&-->¥Î©ó¨ú®øµo²¼²M³æ
	Append Blank
	Replace r_id With 3		&&-->¥Î©ó¨ú®øµæ¦¡
ENDIF 

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
Append Blank
Replace r_id With 24
	
Append Blank
Replace r_id With 4		&&-->¥Î©ó¥I´Ú¤ÀªR

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ VARTYPE(__deposit_once)#"U" and __deposit_once
Append Blank
Replace r_id With 25		&&­qª÷¦¬´Ú
	
Append Blank
Replace r_id With 5		&&-->¥Î©ó§é¦©¤ÀªR
Append Blank
Replace r_id With 6		&&-->¥Î©ó³¡ªù¤ÀªR
Append Blank
Replace r_id With 7		&&-->¥Î©ó°Ï°ì¤ÀªR
Append Blank
Replace r_id With 8		&&-->¥Î©óµæ¦¡¤ÀªR
Append Blank
Replace r_id With 9		&&-->¥Î©ó¶}¤ä¤ÀªR

Append Blank
Replace r_id With 10		&&-->¥Î©ó§ó§ï»ù®æ°O¿ý

Append Blank
Replace r_id With 11		&&-->¥Î©ó HOLLAND TAX

Append Blank
Replace r_id With 12		&&-->¥Î©ó µo²¼§ó§ï°O¿ý

Append Blank
Replace r_id With 13		&&-->¥Î©ó §ÖÀ\¤ÀªR

Append Blank 				&&--->¥Î©ó ¦L³æ«á§é¦©
Replace r_id With 14

Append Blank 				&&-->¥Î©ó·|­ûµL§é¦©¿n¤À
Replace r_id With 15


Append Blank 				&&-->¥Î©ó®É¬q¤ÀªR
Replace r_id With 16


Append Blank
Replace r_id With 17		&& ¨C¤p®ÉÀç·~ÃB


Append Blank
Replace r_id With 18		&& ®ø¶O¤ÀªR¡]¥»¦a¤H¡B¥~°ê¤H¡^

Append Blank
Replace r_id With 19		&& ²{ª÷¨é¤ÀªR


Append Blank
Replace r_id With 20		&& µo²¼§é¦©²Ó¸`


Append Blank
Replace r_id With 21		&& ¦L³æ«áÂà»O

Append Blank
Replace r_id With 22		&& ­û¤u¼úª÷

&&Lihong 2021.04.14
IF __special_customer == "fung_shou_hotpot"
	Append Blank
	Replace r_id With 2		&&-->¥Î©ó¨ú®øµo²¼²M³æ
	Append Blank
	Replace r_id With 3		&&-->¥Î©ó¨ú®øµæ¦¡
ENDIF 

&&Lihong 2021.12.15 
*IF _Memb_Record
	Append Blank
	Replace r_id With 23		&&·|­û®ø¶O°O¿ý
*ENDIF 

	
&&µo²¼²M³æ
Create Cursor cln_tmp1(r_id Int,inv_Id N(10,0),pplcnt N(8,0),payway c(20),amt N(12,2),tips N(12,2), discamt N(12,2),tableno c(10) )
Index On r_id Tag inv_list

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
Create Cursor cln_tmp24(r_id Int,inv_Id N(10,0),pplcnt N(8,0),payway c(20),amt N(12,2),tips N(12,2), discamt N(12,2),tableno c(10) )
Index On r_id Tag inv_list

&&¨ú®øµo²¼²M³æ
Create Cursor cln_tmp2(r_id Int,inv_Id N(10,0),amt N(12,2),void_reason c(30))
Index On r_id Tag inv_void

&&¨ú®øµæ¦¡
Create Cursor cln_tmp3(r_id Int,descdisp c(50),qty N(12,2),amt N(12,2),void_user c(20),void_reason c(20),void_time c(20),Id Int,tableno c(10), inv_Id int)
Index On r_id Tag item_void

&&¥I´Ú¤ÀªR
&&Lihong 2022.02.25 MS¼W¥[cln
Create Cursor cln_tmp4(r_id Int,cln int,crasher c(50),payway c(30),paytimes N(6,0),tips N(12,2),amt N(12,2),Changes N(12,2),tamt N(12,2),netamt N(12,2),adduser c(20),istotal L,islocal L,pay_id Int)
Index On r_id Tag pay

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
Create Cursor cln_tmp25(r_id Int,cln int,crasher c(50),payway c(30),paytimes N(6,0),tips N(12,2),amt N(12,2),Changes N(12,2),tamt N(12,2),netamt N(12,2),adduser c(20),istotal L,islocal L,pay_id Int)
Index On r_id Tag pay

&&§é¦©¤ÀªR
Create Cursor cln_tmp5(r_id Int,descdisp c(50),qty N(12,2),amt N(12,2))
Index On r_id Tag discount


&&³¡ªù¤ÀªR
Create Cursor cln_tmp6(r_id Int,descdisp c(80),qty N(12,2),amt N(18,4), org_amount n(18,4), discount_amount n(18,4), round_amount n(12,2), real_amount n(18,4), dept_amt N(18,4),Id Int,srv N(18,4) , s_from c(10),s_to c(10) )
Index On r_id Tag dept

&&°Ï°ì¤ÀªR
Create Cursor cln_tmp7(r_id Int,descdisp c(50),amt N(12,2),pplcnt N(8,0),amtperhead N(12,2) )
Index On r_id Tag outlet


&&µæ¦¡¤ÀªR
Create Cursor cln_tmp8(r_id Int,descdisp c(50),qty N(12,2),amt N(12,2),item_code c(10),cate c(50),cate_id int )
Index On r_id Tag Item

&&¤ä¥X
Create Cursor cln_tmp9(r_id Int,descdisp c(50),payway c(30),amt N(12,2),adduser c(20))
Index On r_id Tag expense

&&»ù®æ§ó§ï°O¿ý
Create Cursor cln_tmp10(r_id Int,action  c(200),Datetime T,adduser c(20))
Index On r_id Tag chgPrice

&&TAX2
Create Cursor cln_tmp11(r_id Int,descdisp c(50),orgamt N(12,2), amt N(12,2))
Index On r_id Tag tax

&&»ù®æ§ó§ï°O¿ý
Create Cursor cln_tmp12(r_id Int,action  c(50),Datetime T,adduser c(20))
Index On r_id Tag chgInv

&&§ÖÀ\¤ÀªR
Create Cursor cln_tmp13(r_id Int,descdisp c(50),qty N(12,2), amt N(12,2))
Index On r_id Tag fastfood

&&¦L³æ«á§é¦©
Create Cursor cln_tmp14(r_id Int,inv_no N(10,0),cUser c(20), amt N(12,2))
Index On r_id Tag discinv


&&·|­ûµL§é¦©¿n¤À
Create Cursor cln_tmp15(r_id Int,cardno c(50),inv_no N(10,0),cUser c(20), amt N(12,2))
Index On r_id Tag discpoint

&&®É¬q¤ÀªR
&&Lihong 2022.02.25 ¼W¥[srvamt
Create Cursor cln_tmp16( r_id Int,descdisp c(50),pplcnt N(8,0),amt N(12,2),s_from c(10),s_to c(10), srvamt N(12,2))
Index On r_id Tag section


&&¨C¤p®ÉÀç·~ÃB

Create Cursor cln_tmp17 (r_id Int,descdisp c(30) , Cnt N(8,0) ,qty N(12,2), amt N(12,2), per N(6,2) ,sTime c(5),eTime c(5) )
Index On r_id Tag hourly


&& ®ø¶O¤ÀªR ¡]¥»¦a¤H/¥~°ê¤H)

Create Cursor cln_tmp18 (r_id Int,descdisp c(30) , Cnt N(8,0) , pplcnt N(8,0) , amt N(12,2) )
Index On r_id Tag hourly


&& ²{ª÷¨é¤ÀªR

Create Cursor cln_tmp19 (r_id Int,descdisp c(30) , Cnt N(8,0) , netamt N(12,2),  amt N(12,2) )
Index On r_id Tag coupon


&&µo²¼§é¦©²Ó¸`

Create Cursor cln_tmp20 (r_id Int, inv_Id N(10,0), disc_desc c(30) ,  discamt N(12,2) )
Index On r_id Tag invdisc



&&¦L³æ«áÂà»O

Create Cursor cln_tmp21 (r_id Int, descdisp c(30) ,  qty N(12,2) ,amt N(12,2),Datetime T,adduser c(20))

Index On r_id Tag itemmove


&&­û¤u¼úª÷

Create Cursor cln_tmp22 (r_id Int, descdisp c(30) ,  award N(12,2) ,liked_inv_per C(10),liked_amt_per C(10) )  &&­û¤u ¡A ¼úª÷ ¡A ¦n³æ¡]%¡^ ¡A¦n³æª÷ÃB¡]%¡^

Index On r_id Tag award


&&Lihong 2021.12.15 ·|­û®ø¶O°O¿ý
USE IN SELECT("cln_tmp23")
IF _Memb_Record
	SELECT CAST(23 as int) as r_id, * FROM cun_tmp220 INTO CURSOR cln_tmp23 READWRITE 
ELSE
	CREATE CURSOR cln_tmp23 (r_id Int, cardno C(1), name_cn C(1), name_en C(1), tel C(1), invamt int, invamt_noRecharge int, recharge_amount int, ;
						invcnt int, invcnt_noRecharge int, recharge_count int)
ENDIF 
Index On r_id Tag memb

*-----------------------------------------------------------------------------------
_print_inv_list=.F.
_total_inv_pplcnt=0
_total_inv_amt=0
_total_inv_tips=0



If !Eof("cun_tmp") And _chkinv_detail		&&µo²¼²Ó¸`

*	SET STEP ON 
	_print_inv_list=.T.
	Select cun_tmp
	Scan
		_Pid=pay_id
		Select cun_tmp2
		Locate For Id=_Pid
		If Found()
			_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))
		Else
			_payway=""
		Endif


		Select cln_tmp1
		Append Blank
		Replace r_id With 1,inv_Id With cun_tmp.Id,pplcnt With cun_tmp.pplcnt,payway With _payway,amt With cun_tmp.netamt,tips With cun_tmp.tips1,discamt With cun_tmp.itemdiscamt +cun_tmp.discamt
		REPLACE tableno WITH TRIM(cun_tmp.tableno)



	Endscan

	Select cln_tmp1
	Go Top
	Do Whil !Eof()			&&¬Û¦Pªºinv_id¥u«O¯d²Ä¤@¦æ
		_recn=Recno()
		_id=inv_Id
		Replace inv_Id With 0,pplcnt With 0 For Recno()>_recn And inv_Id=_id
		Go _recn
		Skip

	Enddo


Endif

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
*cun_tmp23 cln_tmp24 r_id=24
_print_deposit_list=.F.
_total_deposit_pplcnt=0
_total_deposit_amt=0
_total_deposit_tips=0
_total_orgamt_deposit=0
_total_discamt_deposit=0
IF VARTYPE(__deposit_once)#"U" and __deposit_once AND USED("cun_tmp23") AND !Eof("cun_tmp23") And _chkdeposit_detail		&&deposit²Ó¸`

*	SET STEP ON 
	*_print_deposit_list=.T.
	Select cun_tmp23
	Scan
		_Pid=pay_id
		Select cun_tmp2
		Locate For Id=_Pid
		If Found()
			_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))
		Else
			_payway=""
		Endif


		Select cln_tmp24 
		Append Blank
		Replace r_id With 24,inv_Id With cun_tmp23.Id,pplcnt With 0,payway With _payway,amt With NVL(cun_tmp23.netamt,0),tips With NVL(cun_tmp.tips1,0),discamt With 0
		REPLACE tableno WITH TRIM(cun_tmp23.tableno)



	Endscan

	Select cln_tmp24 
	Go Top
	Do Whil !Eof()			&&¬Û¦Pªºinv_id¥u«O¯d²Ä¤@¦æ
		_recn=Recno()
		_id=inv_Id
		Replace inv_Id With 0,pplcnt With 0 For Recno()>_recn And inv_Id=_id
		Go _recn
		Skip

	Enddo

	Sum pplcnt,amt,tips,amt,0 To _total_deposit_pplcnt,_total_deposit_amt,_total_deposit_tips,_total_orgamt_deposit,_total_discamt_deposit FOR inv_Id>0
	_total_deposit_pplcnt=Int(_total_deposit_pplcnt)
ENDIF

Select cun_tmp11

Sum pplcnt,invamt,tips,orgamt,itemdiscamt + discamt To _total_inv_pplcnt,_total_inv_amt,_total_inv_tips,_total_orgamt,_total_discamt

&&Lihong 2020.09.01 _total_orgamt ¬O§_³øªí¥Î¨ì»Ý­n©î¥Xpoints sales:¤£¥Î

_total_inv_pplcnt=Int(_total_inv_pplcnt)



Go Top In cun_tmp11
If Eof("cun_tmp11")					&& ¥´¦Lµo²¼ªº°_©l/²×¤î¸¹¤Î¼Æ¶q

	_total_inv_remark=""

Else

	Go Top In cun_tmp11
	_beg_inv=cun_tmp11.Id
	Go Bottom In cun_tmp11
	_end_Inv=cun_tmp11.Id


	_total_inv_remark=getmessage("_invno")+Space(1)+getmessage("_from") + ":" +Alltrim(Str(_beg_inv))+getmessage("_to")+Alltrim(Str(_end_Inv))+Space(2)+;
		getmessage("_total")+":"+Alltrim(Str(Reccount("cun_tmp11")))+Space(1)+getmessage("_invoice")

Endif


_print_void_Inv=.F.		&&¥´¦L¨ú®øµo²¼
_total_void_amt=0

If !Eof("cun_tmp1")
	_print_void_Inv=.T.

	Select cun_tmp1
	Scan

		Select cln_tmp2
		Append Blank
		Replace r_id With 2,inv_Id With cun_tmp1.Id,amt With cun_tmp1.invamt,void_reason With Nvl(Iif(_system_langue="CN",cun_tmp1.desccn,cun_tmp1.Descen),"")

	Endscan
	Select cln_tmp2
	Sum amt To _total_void_amt

Else
	_cvoid_InvList=""

Endif
Set Seconds Off
*--------------------------------------------------------------------------------
_print_void_item=.F.
If _chkvoided_item>0

	If !Eof("cun_tmp3")
		_print_void_item=.T.
		Select cun_tmp3																	&&¨ú®øµæ¦¡
		Scan
			If _chkvoided_item=2 And cun_tmp3.inv_Id=0		&& bug fix 2009.05.04
				Loop
			Endif
			Select cln_tmp3
			Append Blank &&amt With cun_tmp3.amount+cun_tmp3.modi_amount -> cun_tmp3.amount
			Replace r_id With 3,descdisp With  cun_tmp3.descdisp,qty With cun_tmp3.qty,amt With cun_tmp3.amount,;
				void_user With cun_tmp3.void_user,void_reason With Nvl(Iif(_system_langue="CN",cun_tmp3.desccn,cun_tmp3.Descen),""),void_time With Ttoc(cun_tmp3.void_time),Id With cun_tmp3.Id,;
				tableno With Nvl(cun_tmp3.tableno,"") , inv_id WITH NVL(cun_tmp3.inv_id,0)

		Endscan
	Endif

Endif
Set Seconds On

*----------------------------------------
_mult_crasher=.F.
_octopus=getmessage("_octopus")
_amt=0.00

_recn=0


Private  _header,_crasher,lnCrasher

lnCrasher=1

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
IF USED("cun_tmp23")
	SELECT cun_tmp23
	GO TOP 
ENDIF 
LOCAL lnpay,ii
lnpay = 1
USE IN SELECT("cun_tmp23_cln")
USE IN SELECT("cun_tmp_org")
IF VARTYPE(__deposit_once)#"U" and __deposit_once AND USED("cun_tmp23") AND !Eof("cun_tmp23") 
	IF _do_print AND _dayEnd_report = .F.
		SELECT id FROM cun_tmp23 GROUP BY id INTO CURSOR cun_tmp23_cln
	ENDIF 
	IF VARTYPE(__cln_pay_includ_deposit_received)#"U" AND __cln_pay_includ_deposit_received
		SELECT * FROM cun_tmp INTO CURSOR cun_tmp_org READWRITE 
		SELECT cun_tmp
		APPEND FROM DBF("cun_tmp23")
	ELSE
		lnpay = 2
	ENDIF 
ENDIF 

FOR ii=1 TO lnpay &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
_recn=0
lnCrasher=1
IF ii=2 &&MS«á­±¥¼¹ê²{
	 SELECT * FROM cln_tmp4 INTO CURSOR cln_tmp4_bak4deposit
	 SELECT * FROM cln_tmp4 WHERE 1<>1 INTO CURSOR cln_tmp4 READWRITE 
	 SELECT * FROM cun_tmp23 INTO CURSOR cun_tmp READWRITE 
ENDIF 

&&Lihong 2022.01.18 delete from pay_detail where payamt = 0 and netamt = 0 and pay_others = 0
IF ii=1
	SELECT * FROM cun_tmp INTO CURSOR cun_tmp_befor_delete_0pay READWRITE 
ENDIF 
SELECT * FROM cun_tmp WHERE !(pay_id=1 AND NVL(payamt, 0) = 0 and NVL(netamt, 0) = 0 and NVL(pay_others, 0) = 0) INTO CURSOR cun_tmp 
Select pay_id Distinct From cun_tmp Order By pay_id Into Array tmp_s			&&¥I´Ú¤ÀªR --- ppp
If _Tally=0 AND !LOWER(__special_customer)=="ms" &&¥¼¦³¨ä¥¦¥I´Ú¤è¦¡,­nÀË¬d¬O§_¦³¤K¹F³qvoid ³æ &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"
	IF ii=1
	
	Select cun_tmp13					&&²Î­p¤K¹F³qvoid ³æ
	Go Top
	If !Eof()
		Select cun_tmp13
		Sum netamt To _amt For pay_id=-1		&&¤K¹F³q¥I´Ú(void
		Count To npay For pay_id=-1
		Select cun_tmp2
		Locate For Id>0 And Lock
		_pay_id=Id
		_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))


		Select cln_tmp4
		Append Blank		&&¤K¹F³q
		Replace r_id With 4,payway With _octopus ,paytimes With npay,pay_id With -1,islocal With .T.
		Replace amt With _amt,tamt With _amt			&&
	
		Append Blank		&&²{ª÷(­t¼Æ)
		Replace r_id With 4,payway With _payway,paytimes With npay,pay_id With _pay_id,islocal With .T.
		Replace amt With amt -_amt,tamt With tamt-_amt			&&

	Endif
	
	ENDIF 
Else
 
	IF LOWER(__special_customer)=="ms" AND _clean_reprint AND VARTYPE(_MS_dayend_ms_split)#"U" AND _MS_dayend_ms_split=.T.  &&ms­«¦L²M¾÷³æ
		IF ii=1
			=clean_report_ms_cashier()
		ENDIF 
	ELSE 
	If _show_cashier

&&Åã¥Ü­Ó¦¬»È­û
		RELEASE tmp_s1
		Select adduser Distinct From cun_tmp Order By adduser Into Array tmp_s1		&&¦¬»È­û
		lnCrasher=IIF(VARTYPE(tmp_s1)="U", 0, Alen(tmp_s1))

		If lnCrasher>1 OR  (lnCrasher>0 AND LOWER(__special_customer)=="ms") &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"

			For k=1 To Alen(tmp_s1)
				_crasher=tmp_s1(k)		&&¦¬»È­û¦WºÙ
				
				IF !LOWER(__special_customer)=="ms" &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"
					If Empty(_crasher)
						Loop

					Endif
				ENDIF 

				_header=.T.
				For i=1 To Alen(tmp_s)
					_Pid=tmp_s(i)
					Select cun_tmp2
					Locate For Id=_Pid

					_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))
					_islocal=(cun_tmp2.rate=1)

					Select cun_tmp
					Sum(pay_qty) To N For  pay_id=_Pid  And adduser=_crasher

					Sum tips1,payamt To _tips,_payamt For pay_id=_Pid And pay_others=0 And adduser=_crasher
					Sum pay_others To _pay_others For pay_id=_Pid And pay_others>0 And adduser=_crasher
					Sum Changes To _changes For changes_id=_Pid And adduser=_crasher
					Sum netamt To _netamt For pay_id=_Pid And adduser=_crasher

					If  N>0

						Select cln_tmp4
						Append Blank
						If lnCrasher>1 And _header=.T. OR LOWER(__special_customer)=="ms" 	&&¦pªG¦³¦h©ó¤@­Ó¦¬»È­û(¬O§_Åã¥Ü¸òsetting) &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"
							Replace crasher With _crasher,r_id With 4,pay_id With _Pid
							_header=.F.
						Endif

*					REPLACE r_id WITH 4,payway WITH _payway,paytimes WITH n,tips WITH _tips,amt WITH _netamt-_tips,tamt WITH _netamt-_tips,adduser WITH _crasher,islocal WITH _islocal,pay_id WITH _pid

						Replace r_id With 4,payway With _payway,paytimes With N,tips With _tips,amt With Iif(_pay_others>0 ,_pay_others, _payamt ) -_changes-_tips,tamt With amt+tips,netamt With _netamt,adduser With _crasher,islocal With _islocal,pay_id With _Pid

					Endif


				Endfor

				IF ii=1
				Select cun_tmp13					&&²Î­p¤K¹F³qvoid ³æ
				Go Top
				If !Eof()
					Sum netamt To _amt For pay_id=-1 And adduser=_crasher
					If _amt>0

						Sum pay_qty To npay For pay_id=-1 And adduser=_crasher
						Select cun_tmp2
						Locate For Id>0 And Lock
						If !Found()
							Loop
						Endif

						_pay_id=Id
						_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))



						Select cln_tmp4
						Locate For pay_id=-1 And adduser=_crasher
						If Found()

							Replace amt With amt +_amt,tamt With tamt+_amt			&&

						Else

							Select cln_tmp4
							Append Blank		&&¤K¹F³q
							Replace r_id With 4,payway With _octopus ,paytimes With npay,pay_id With -1,islocal With .T.,adduser With _crasher
							Replace amt With _amt,tamt With amt			&&

						Endif

						Select cln_tmp4		&&²{ª÷­nÅÜ¬°¥[¤@­Ó­t¼Æ
						Locate For pay_id=_pay_id  And adduser=_crasher
						If !Found()
							Append Blank
							Replace r_id With 4,payway With _payway,paytimes With npay,pay_id With _pay_id,islocal With .T.,adduser With _crasher
						Endif


					Endif


				Endif
				ENDIF &&ii=1

				Select cln_tmp4
*				SUM tips,amt,tamt TO _crasher_tips,_crasher_amt,_crasher_tamt FOR adduser=_crasher
				Sum tips,amt  To _crasher_tips,_crasher_amt For adduser=_crasher

				Append Blank
				Replace r_id With 4,crasher With Replicate("-",70),payway With _ctotal,tips With _crasher_tips,amt With _crasher_amt,tamt With amt+tips ,istotal With .T.



			Endfor

		ENDIF &&If lnCrasher>1 OR




&&¦pªG¦h©ó¤@­Ó¦¬»È­û¡A¦A¥[¤W¥þ³¡¥I´Ú¤è¤è¦¡²Î­p

		If lnCrasher>1

			Select cln_tmp4
			Append Blank
			Replace r_id With 4,crasher With Replicate("-",70)

		Endif


	ENDIF &&_show_cashier


	Select cln_tmp4
	If !Bof() AND !EOF() 

		_recn=Recno()

	Endif

*--------------------------------------¦X­p


	Select pay_id,Sum(pay_qty) As qty,Sum(tips1) As tips,Sum(payamt) As payamt,Sum(netamt) As netamt,;
		sum(pay_others) As pay_others,Sum(Changes) As Changes From cun_tmp Where pay_id=changes_id	Group By pay_id  Order By pay_id   Into Cursor PayAnalyse_tmp


	Select PayAnalyse_tmp
	Scan

		Select cun_tmp2
		Locate  For Id=PayAnalyse_tmp.pay_id
		_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))


		Select r_id From cln_tmp4 Where pay_id=PayAnalyse_tmp.pay_id And Recno()>_recn Into Array tmp_s

		If _Tally=0
			Select cln_tmp4
			Append Blank
			Replace r_id With 4,pay_id With PayAnalyse_tmp.pay_id,payway With _payway

		Endif

		Update cln_tmp4 Set paytimes=paytimes+PayAnalyse_tmp.qty,;
			tips =tips+ PayAnalyse_tmp.tips,;
			amt = amt+ Iif(  PayAnalyse_tmp.pay_others>0 ,PayAnalyse_tmp.pay_others,PayAnalyse_tmp.payamt ) - PayAnalyse_tmp.Changes - PayAnalyse_tmp.tips ,;
			netamt=netamt+PayAnalyse_tmp.netamt ;
			Where pay_id=PayAnalyse_tmp.pay_id And Recno()>_recn


	Endscan


*SET STEP ON

	Select pay_id,changes_id,Count(0) As qty,Sum(tips) As tips,Sum(payamt) As payamt,Sum(netamt) As netamt,;
		sum(pay_others) As pay_others,Sum(Changes) As Changes From cun_tmp Where pay_id<>changes_id	Group By pay_id,changes_id  Order By pay_id   Into Cursor PayAnalyse_tmp

	Select PayAnalyse_tmp		&&
	Scan
		Select cun_tmp2
		Locate  For Id=PayAnalyse_tmp.pay_id

		_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

		Select r_id From cln_tmp4 Where pay_id=PayAnalyse_tmp.pay_id And Recno()>_recn Into Array tmp_s

		If _Tally=0
			Select cln_tmp4
			Append Blank
			Replace r_id With 4,pay_id With PayAnalyse_tmp.pay_id,payway With _payway

		Endif



		Update cln_tmp4 Set paytimes=paytimes+PayAnalyse_tmp.qty,tips =tips+ PayAnalyse_tmp.tips,;
			amt = amt+ Iif(  PayAnalyse_tmp.pay_others>0 ,PayAnalyse_tmp.pay_others,PayAnalyse_tmp.payamt ) , netamt=netamt+PayAnalyse_tmp.netamt ;
			Where  pay_id=PayAnalyse_tmp.pay_id And Recno()>_recn

		If PayAnalyse_tmp.Changes>0		&&¤£¦P³f¹ô§ä¦^ªº±¡ªp

			Select cun_tmp2
			Locate  For Id=PayAnalyse_tmp.changes_id
			_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

			Select r_id From cln_tmp4 Where pay_id=PayAnalyse_tmp.changes_id And Recno()>_recn Into Array tmp_s
			If _Tally=0
				Select cln_tmp4
				Append Blank
				Replace r_id With 4,pay_id With PayAnalyse_tmp.changes_id ,payway With _payway

			Endif

			Update cln_tmp4 Set amt = amt-PayAnalyse_tmp.Changes Where  pay_id=PayAnalyse_tmp.changes_id And Recno()>_recn

		Endif

	Endscan


	Use In PayAnalyse_tmp

	Update cln_tmp4 Set tamt=amt+tips




	ENDIF &&ELSE _show_cashier

Endif

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
*cun_tmp23 cln_tmp25 r_id=25



&&--------------- ¦X­p ----------------------


Select cun_tmp2
Locate For Id>0 And Lock
_cash_id=Id

IF ii=1
	Select cln_tmp4
	Sum tips,amt,netamt,paytimes To _total_tips,_total_amt, _total_netamt,_paytimes For Recno()>_recn   &&FOR istotal=.f. AND islocal		&&¥»¦a³f¹ô¦X­p

	*_total_amt=_total_tips+_total_netamt

	Sum tamt To _total_cash_amt  For Recno()>_recn And pay_id=_cash_id	&&FOR pay_id=_cash_id AND istotal=.f.		&&²{ª÷


	Select cln_tmp4
	Append Blank
	Replace r_id With 4,crasher With Replicate("-",70),payway With _ctotal+"("+Trim(__local_CURRENCY)+")",paytimes With _paytimes,tips With _total_tips,amt With _total_netamt,tamt With _total_amt + _total_tips,istotal With .T.	&&¥»¦a¥I´Ú¤è¦¡





	Select cln_tmp4
	Sum tips To _total_payway_tips For istotal=.F.

	IF _show_cashier AND (lnCrasher>1 OR  (lnCrasher>0 AND LOWER(__special_customer)=="ms"))  &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"


		_total_payway_tips= _total_payway_tips /2
		

	ENDIF
	
ELSE &&ii=2
	Select cln_tmp4
	Sum tips,amt,netamt,paytimes To _total_tips_deposit,_total_amt_deposit, _total_netamt_deposit,_paytimes_deposit For Recno()>_recn   &&FOR istotal=.f. AND islocal		&&¥»¦a³f¹ô¦X­p
	*_total_amt=_total_tips+_total_netamt
	Sum tamt To _total_cash_amt_deposit  For Recno()>_recn And pay_id=_cash_id	&&FOR pay_id=_cash_id AND istotal=.f.		&&²{ª÷

	Select cln_tmp4
	Append Blank
	Replace r_id With 4,crasher With Replicate("-",70),payway With _ctotal+"("+Trim(__local_CURRENCY)+")",paytimes With _paytimes_deposit,tips With _total_tips_deposit,amt With _total_netamt_deposit,tamt With _total_amt_deposit + _total_tips_deposit,istotal With .T.	&&¥»¦a¥I´Ú¤è¦¡





	Select cln_tmp4
	Sum tips To _total_payway_tips_deposit For istotal=.F.

	IF _show_cashier AND (lnCrasher>1 OR  (lnCrasher>0 AND LOWER(__special_customer)=="ms"))  &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"


		_total_payway_tips_deposit= _total_payway_tips_deposit /2
		

	ENDIF
	
	SELECT * FROM cln_tmp4 INTO CURSOR cln_tmp25 READWRITE 
	REPLACE ALL r_id WITH 25
	Index On r_id Tag pay
	SELECT * FROM cln_tmp4_bak4deposit INTO CURSOR cln_tmp4 READWRITE 
	Index On r_id Tag pay

ENDIF 

ENDFOR &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷


*!*	IF _show_cashier AND lnCrasher>1

*!*	_total_payway_tips =_total_payway_tips /lnCrasher

*!*	ENDIF


*----------------------&& coupon ¤ÀªR

&&&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ 
IF USED("cun_tmp_org")
	SELECT * FROM cun_tmp_org WHERE !(pay_id=1 AND NVL(payamt, 0) = 0 and NVL(netamt, 0) = 0 and NVL(pay_others, 0) = 0) INTO CURSOR cun_tmp
ENDIF 

Select pay_id, Count(0) As Cnt ,Sum(netamt) As netamt ,Sum(payamt+pay_others -Changes -tips) As amt From cun_tmp ;
	group By pay_id Into Cursor PayAnalyse_tmp

Select PayAnalyse_tmp

Scan

	Select cun_tmp2
	Locate  For Id=PayAnalyse_tmp.pay_id

	If Nvl(coupon,.F.)=.F.
		Loop

	Endif


	_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))


	Select cln_tmp19
	Append Blank


	Replace r_id With 19, descdisp With _payway,Cnt With  PayAnalyse_tmp.Cnt,netamt With PayAnalyse_tmp.netamt,amt With PayAnalyse_tmp.amt


Endscan

Select cln_tmp19
Sum amt To _total_coupon_amt

Use In PayAnalyse_tmp

*---------------------------

&&Lihong 2022.01.18 delete from pay_detail where payamt = 0 and netamt = 0 and pay_others = 0
IF USED("cun_tmp_org") &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	SELECT * FROM cun_tmp_org INTO CURSOR cun_tmp
ELSE 
	SELECT * FROM cun_tmp_befor_delete_0pay INTO CURSOR cun_tmp
ENDIF 
SELECT cun_tmp_befor_delete_0pay 
DELETE FOR pay_id=1 AND NVL(payamt, 0) = 0 and NVL(netamt, 0) = 0 and NVL(pay_others, 0) = 0
*USE IN SELECT("cun_tmp_befor_delete_0pay")


*---------------------------
_invdisc=.F.
_total_disc_qty=0
_total_disc_amt=0
If !Eof("cun_tmp4") Or  !Eof("cun_tmp5")


	_invdisc=.T.
	Select disc_id,disc_type From cun_tmp4 Into Cursor cun_tmp25 Readwrite					&&§é¦©¤ÀªR
	Select disc_id,disc_type From cun_tmp5 Into Array tmp_s
	If _Tally>0
		Select cun_tmp25
		Append From Array tmp_s

	Endif

	Select disc_id Distinct From cun_tmp25 Into Cursor cun_tmp26
	Select cun_tmp26
	Scan
		_id=disc_id
		Select cun_tmp6
		Locate For Id=_id
		_descdisp=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))
		_type=disc_type


		Select cun_tmp4
		If _type>2			&&§K¶O¶µ­n°Ï§O¹ï«Ý
			Sum disc_amount To m1 For disc_id=_id And disc_type=_type
			Sum disc_qty To q1 For disc_id=_id And disc_type=_type
		Else
			Sum disc_amount To m1 For disc_id=_id
			Sum disc_qty To q1 For disc_id=_id
		Endif


		Select cun_tmp5
		If _type>2			&&§K¶O¶µ­n°Ï§O¹ï«Ý
			Sum disc_amount To m2 For disc_id=_id And disc_type=_type
			Sum disc_qty To q2 For disc_id=_id And disc_type=_type
		Else
			Sum disc_amount To m2 For disc_id=_id
			Sum disc_qty To q2 For disc_id=_id
		Endif

		Select cln_tmp5
		Append Blank
		Replace r_id With 5,descdisp With _descdisp,qty With q1+q2,amt With m1+m2
		_total_disc_qty=_total_disc_qty+q1+q2
		_total_disc_amt=_total_disc_amt+m1+m2

	Endscan




	If Used("cun_tmp25 ")

		Use In cun_tmp25
	Endif

	If Used("cun_tmp26")

		Use In cun_tmp26
	Endif


Endif




*-----------------------------------------------------
_print_dept_analyse=.F.				&&³¡ªù¤ÀªR (³¡ªù¤À±b)

_nosrv_amt=getmessage("_no_srv_amt")
_total_dept_qty=0
_total_dept_amt=0
_total_dept_real_amt=0
_total_dept_srv_amt=0
_total_dept_disc_amt =0
_total_dept_rnd_amt = 0 
_total_dept_orgamt = 0


If _chkdept>0


	_print_dept_analyse=.T.


	Do Case


		Case  Lower(__special_customer) = "shirokiya"


			cPeriod=getmessage("_section")

			nRep =60

			Select section_tmp
			Scan

				cFrom = Trim(section_tmp.s_from)
				cTo = Trim(section_tmp.s_to)





				If cFrom  > cTo 		&&¸ó¤Ñ


					Select  b.dept_id, c.desccn ,c.Descen, Sum( a.amount*b.price_per/100) As amount  ;
						FROM cun_tmp8 a Left Join cun_tmp9 b On a.item_id=b.item_id  ;
						LEFT Join cun_tmp7 c On b.dept_id=c.Id ;
						WHERE  a.Id In (Select Id From cun_tmp11 Where Substr(Ttoc(paidtime,2),1,5) >= cFrom  Or   Substr(Ttoc(paidtime,2),1,5) <= cTo ) ;
						AND  Nvl(a.askdept,.F.) =.F. ;
						GROUP By b.dept_id,c.desccn,c.Descen  Order By c.desccn	Into Cursor  cr_tmp


					Select 	 Sum(a.disc_amount+a.xdisc) As discount, Sum(a.srv_amount) As srv ,Sum(a.round_amount) As rnd	;
						FROM cun_tmp8 a 	Where  a.Id In (Select Id From cun_tmp11 Where Substr(Ttoc(paidtime,2),1,5) >= cFrom  Or   Substr(Ttoc(paidtime,2),1,5) <= cTo ) ;
						AND  Nvl(a.askdept,.F.) =.F.  Into Cursor cr_tmp1


					Select Count(0) As tn , Sum(pplcnt) As ppl From cun_tmp11 Where  Substr(Ttoc(paidtime,2),1,5) >= cFrom  Or   Substr(Ttoc(paidtime,2),1,5) <= cTo ;
						INTO Cursor cr_tmp2


				Else

					Select  b.dept_id, c.desccn ,c.Descen, Sum( a.amount *b.price_per/100) As amount  ;
						FROM cun_tmp8 a Left Join cun_tmp9 b On a.item_id=b.item_id  ;
						LEFT Join cun_tmp7 c On b.dept_id=c.Id ;
						WHERE  a.Id In (Select Id From cun_tmp11 Where Substr(Ttoc(paidtime,2),1,5) >= cFrom  And   Substr(Ttoc(paidtime,2),1,5) <= cTo ) ;
						AND  Nvl(a.askdept,.F.) =.F. ;
						GROUP By b.dept_id,c.desccn,c.Descen  Order By c.desccn	Into Cursor  cr_tmp


					Select 	 Sum(a.disc_amount+a.xdisc) As discount, Sum(a.srv_amount) As srv ,Sum(a.round_amount) As rnd	;
						FROM cun_tmp8 a 	Where  a.Id In (Select Id From cun_tmp11 Where Substr(Ttoc(paidtime,2),1,5) >= cFrom  And   Substr(Ttoc(paidtime,2),1,5) <= cTo ) ;
						AND  Nvl(a.askdept,.F.) =.F.  Into Cursor cr_tmp1



					Select Count(0) As tn , Sum(pplcnt) As ppl From cun_tmp11 Where  Substr(Ttoc(paidtime,2),1,5) >= cFrom  And    Substr(Ttoc(paidtime,2),1,5) <= cTo ;
						INTO Cursor cr_tmp2

				Endif

				Select cr_tmp
				Sum  amount   To _amount

				If _amount =0		&&

					Loop


				Endif


				Select cln_tmp6
				Append Blank
				Replace r_id  With 6,descdisp With cPeriod + ": " + cFrom  +" -- " +  cTo
				Append Blank
				Replace r_id With 6 ,descdisp With Replicate("-",nRep )



				Select cr_tmp
				Scan For amount>0

					Select cln_tmp6
					Append Blank
					Replace r_id  With 6,descdisp With Iif(_system_langue="CN",Trim(cr_tmp.desccn),Trim(cr_tmp.Descen)), amt With cr_tmp.amount ,Id With 1


				Endscan



				Select cr_tmp1

				Sum discount,srv,rnd To _disc,_srv,_Rnd





*---------------

				Select cln_tmp6
				Append Blank
				Replace r_id With 6 ,descdisp With " - " +  _cdiscount 	,amt With _disc,  Id With -1	&&  - §é¦©

				Append Blank
				Replace r_id With 6 ,descdisp With " + " +  _csrv 	, amt With _srv,Id With -2	&&  + ªA°È¶O

				Append Blank
				Replace r_id With 6 ,descdisp With " + " +  _crounding , amt With _Rnd, Id With -3		&& + ·L½Õ


*--------------- TOTAL

				_total = _amount + _disc + _srv + _Rnd

				Select cln_tmp6
				Append Blank
				Replace r_id With 6 ,descdisp With Replicate("-",nRep )

				Append Blank
				Replace r_id With 6 ,descdisp With   _ctotal, amt With _total ,Id With 2		&& ¦X­p


				Select cln_tmp6

				Append Blank
				Replace r_id With 6 ,descdisp With   _cinv_qty +"/ " +  _cAmtPerorder  , qty With  cr_tmp2.tn, amt With  _total / cr_tmp2.tn   &&³æ¼Æ /¥­§¡


				Select cln_tmp6
				Append Blank
				Replace r_id With 6 ,descdisp With   _cPplCnt +"/ " +  _cAmtPerhead , qty With  cr_tmp2.ppl , amt With  _total / cr_tmp2.ppl

				Select cln_tmp6
				Append Blank
				Replace r_id With 6 ,descdisp With Replicate("-",nRep )


			Endscan


*---------------------------------------------------------------------    Grand -- Total

			Select cln_tmp6
*!*			Append Blank
*!*			REPLACE r_id WITH 6 ,descdisp WITH REPLICATE("-",nRep )

			Append Blank
			Replace r_id With 6 ,descdisp With   _cdept +" -- "	 + 	_ctotal

			Append Blank
			Replace r_id With 6 ,descdisp With Replicate("-",nRep )


			Select  descdisp,Sum(amt) As amt From cln_tmp6 Where Id=1 Group By descdisp  Order By descdisp  Into Cursor cr_tmp


			Select cr_tmp
			Scan

				Select cln_tmp6

				Append Blank
				Replace r_id With 6 ,descdisp With   cr_tmp.descdisp, amt With cr_tmp.amt


			Endscan


			Select cln_tmp6
			Sum amt To _disc For Id= -1  && discount
			Sum amt To _srv For Id=  -2   &&service
			Sum amt To _Rnd For Id= -3   && rounding
			Sum amt To _total  For Id=2   &&  total

			Select cln_tmp6
			Append Blank

			Replace r_id With 6 ,descdisp With " - " +  _cdiscount 	,amt With _disc	&&  - §é¦©

			Append Blank
			Replace r_id With 6 ,descdisp With " + " +  _csrv 	, amt With _srv	&&  + ªA°È¶O

			Append Blank
			Replace r_id With 6 ,descdisp With " + " +  _crounding , amt With _Rnd	&& + ·L½Õ


*--------------- ALL TOTAL

			Select cln_tmp6
			Append Blank
			Replace r_id With 6 ,descdisp With Replicate("-",nRep )

			Append Blank
			Replace r_id With 6 ,descdisp With   _ctotal, amt With _total 		&& ¦X­p


			Select Count(0) As tn , Sum(pplcnt) As ppl From cun_tmp11 Into Cursor cr_tmp2


			Select cln_tmp6

			Append Blank
			Replace r_id With 6 ,descdisp With   _cinv_qty +"/ " +  _cAmtPerorder  , qty With  cr_tmp2.tn, amt With  _total / cr_tmp2.tn   &&³æ¼Æ /¥­§¡


			Select cln_tmp6
			Append Blank
			Replace r_id With 6 ,descdisp With   _cPplCnt +"/ " +  _cAmtPerhead , qty With  cr_tmp2.ppl , amt With  _total / cr_tmp2.ppl

			Select cln_tmp6
			Append Blank
			Replace r_id With 6 ,descdisp With Replicate("-",nRep )



			If Used("cr_tmp")

				Use In cr_tmp

			Endif

			If Used("cr_tmp1")

				Use In cr_tmp1

			Endif


			If Used("cr_tmp2")

				Use In cr_tmp2

			Endif


*!*			CASE   VARTYPE(__holland_tax_active)#"U" AND __holland_tax_active		&& ²üÄõµ|¼Ò¦¡¡A¹ïDEPT ¤ÎTAX ¶i¦æ¤À²Õ²Î­p
*!*

*!*					select c.desccn,b.dept_id,a.tax2, IIF(_chkdept=1 , sum(a.amount*b.price_per/100)  ,    sum(a.real_amount+a.round_amount+a.xdisc)*.b.price_per/100  )    as amt ;
*!*					SUM(a.srv_amount*a.price_per/100) as srv_amt,SUM(a.qty*b.price_per/100) as qty, ;
*!*					IIF(_chkdept=1, SUM(a.amount * a.tax2*a.price_per/10000) , sum(a.real_amount+a.round_amount+a.xdisc)*a.tax2*.b.price_per/10000   )    as tax_amt,;
*!*					 from cun_tmp8 a left join itemdept bon a.item_id=b.item_id ;
*!*					left join cun_tmp7 c on b.dept_id=c.id;
*!*					 group by c.desccn,b.dept_id,a.tax2  ORDER BY c.desccn,a.tax2 ;
*!*					 INTO CURSOR cr_tmp
*!*
*!*
*!*					SELECT cr_tmp
*!*					SCAN
*!*
*!*						SELECT cln_tmp6
*!*						APPEND BLANK
*!*						REPLACE r_id WITH 6 ,descdisp WITH Iif(_system_langue="CN",Trim(cr_tmp.desccn),TRIM(cr_tmp.descen),id WITH cr_tmp.dept_id,;
*!*						dept_amt WITH 	cr_tmp.amt - cr_tmp.srv_amt - cr_tmp.tax_amt, srv_amt WITH cr_tmp.srv_amt ,qty WITH cr_tmp.qty
*!*
*!*
*!*					ENDSCAN
*!*

*!*				Select cln_tmp6
*!*				Delete For qty=0		&&¼Æ¶q¬°¹s¤£²Î­p¡A¦ýª÷ÃB¬°¹s²Î­p

*!*				Sum qty To _total_dept_qty
*!*				Sum amt  To _total_dept_amt	&&§tªA°È¶O
*!*				Sum srv To _total_dept_srv_amt	&&ªA°È¶O
*!*				Sum dept_amt To _total_dept_real_amt	&&¤£§tªA°È¶O


		Case Lower(__special_customer) = "test" AND __debug		&& ³¡ªù¤À±b¡]¼Ð·Ç¡^
			

			Local _dept_amt,_dept_srv

			Select cun_tmp7					&&department
			Scan
				Select cln_tmp6
				Append Blank
				Replace r_id  With 6,descdisp With Iif(_system_langue="CN",Trim(cun_tmp7.desccn),Trim(cun_tmp7.Descen)),Id With cun_tmp7.Id
			Endscan




			Select cun_tmp8		&&inv_detail
			Scan For  NVL(askdept ,.f.) =.F. 

				_item_Id=item_id
				
				
&&cun_tmp9  --itemdept
				Select dept_id,price_per From cun_tmp9 Where item_id=_item_Id  Into Cursor cun_tmp25
				Select cun_tmp25
				Scan			&&¼Æ¶q¤Îª÷ÃB§¡¤À±b    _chkdept=1  «ö­ì»ù­p¡A  =2 «ö¹ê»ù­p


					_dept_amt=Iif(_chkdept=1,(cun_tmp8.amount)*cun_tmp25.price_per/100, (cun_tmp8.real_amount+cun_tmp8.round_amount+cun_tmp8.xdisc)*cun_tmp25.price_per/100)
					
					_dept_org_amt = (cun_tmp8.amount)*cun_tmp25.price_per/100
					_dept_real_amt = (cun_tmp8.real_amount+cun_tmp8.round_amount+cun_tmp8.xdisc)*cun_tmp25.price_per/100
					
					_dept_disc_amt = (cun_tmp8.disc_amount + cun_tmp8.xdisc)*cun_tmp25.price_per/100
					_dept_rnd_amt = (cun_tmp8.round_amount)*cun_tmp25.price_per/100
					
					_dept_srv=(cun_tmp8.srv_amount)*cun_tmp25.price_per/100
					_dept_tax=(cun_tmp8.tax_amount)*cun_tmp25.price_per/100


					Update cln_tmp6 Set qty=qty+NVL(cun_tmp8.qty,1)*cun_tmp25.price_per/100, ;
						amt=amt+_dept_amt, ;
						dept_amt=dept_amt+_dept_amt -_dept_srv -_dept_tax, ;
						srv=srv+ _dept_srv,;
						org_amount  = org_amount + _dept_org_amt, ;
						real_amount = real_amount + _dept_real_amt,;
						round_amount = round_amount + _dept_rnd_amt,;
						discount_amount = discount_amount + _dept_disc_amt ;
						WHERE id=cun_tmp25.dept_id

				Endscan


			ENDSCAN
			
			
			
				
			Select cun_tmp8
			Scan For NVL(askdept,.f.)=.t.
			
				_item_Id=item_id

				Select * From cun_tmp17 Where Id= cun_tmp8.Id AND parent_id=cun_tmp8.uid  And item_id=_item_Id  And amount>0 Into Cursor cun_tmp26
				If _Tally>0
					Select cun_tmp26
					Sum amount To tm
					Go Top
					SCAN

						Update cln_tmp6 Set qty=qty + NVL(cun_tmp8.qty,1)*cun_tmp26.amount/tm, ;
							amt=amt+cun_tmp26.amount+cun_tmp26.srvamt,;
							dept_amt=dept_amt+ cun_tmp26.amount,;
							org_amount = org_amount +  cun_tmp26.amount,;
							real_amount = real_amount + cun_tmp26.amount,;
							srv=srv+cun_tmp26.srvamt ;
							WHERE Id=cun_tmp26.dept_id
					Endscan
				Endif

			ENDSCAN
			
			&&SET STEP ON 

			Update cln_tmp6 Set qty=Round(qty,1),amt=Round(amt,1),dept_amt=Round(dept_amt,1),srv=Round(srv,1),org_amount = round(org_amount,1),;
				real_amount = round(real_amount,1), discount_amount = round(discount_amount,1)

			Select cun_tmp8
			
			If _chkdept=1  &&_chkdept=1  «ö­ì»ù­p¡A  =2 «ö¹ê»ù­p

				Sum amount To tm1 FOR id>0

			Else
				
				Sum real_amount+round_amount+xdisc To tm1 FOR id>0
				
			Endif
				
			

				Select cln_tmp6
				
				Sum  amt To tm2

				If tm1<>tm2

					Select cln_tmp6
					Locate For qty>0

					Replace amt With amt+(tm1-tm2),dept_amt With dept_amt+(tm1-tm2)
	&&*				Replace dept_amt With dept_amt+(tm1-tm2)


				Endif





			If Used("cun_tmp25")

				Use In cun_tmp25
			Endif

			If Used("cun_tmp26")

				Use In cun_tmp26
			Endif


			Select cln_tmp6
			Delete For qty=0	 AND dept_amt =0	&&¼Æ¶q¬°¹s¤£²Î­p¡A¦ýª÷ÃB¬°¹s²Î­p
			

			IF  Lower(__special_customer) = "nathanhotel"
			
*			SET STEP ON 
			
				_descdisp =getmessage("_dept_amt") + " " +getmessage("_svr_charge")
				
*				Select cun_tmp8
			Select cln_tmp6


				Sum srv To _dept_srv_amt	&&ªA°È¶O
				
				APPEND BLANK 
				
				REPLACE  r_id WITH 6, descdisp  WITH _descdisp ,dept_amt WITH _dept_srv_amt
				
			
			ENDIF
			
		
			Sum qty To _total_dept_qty
			Sum amt  To _total_dept_amt	&&§tªA°È¶O*
			Sum srv To _total_dept_srv_amt	&&ªA°È¶O
			sum org_amount to _total_dept_orgamt
			sum real_amount to _total_dept_real_amt 
			sum discount_amount to _total_dept_disc_amt
			sum round_amount to _total_dept_rnd_amt
	&&		Sum dept_amt To _total_dept_real_amt FOR id>0	&&¤£§tªA°È¶O
	OTHERWISE &&³¡ªù¤À±b ¼Ð·Ç(§ï) 2022-09-27
		IF USED("cun_itemdept")
			
			&& §âround_amount ©ñ¨ì disc_amount¤¤, 2022-10-08	--SUM(tax_amt) as tax_amt,SUM(real_amt) as real_amt,						
			SELECT dept_id, desccn, descen, disporder, SUM(qty) as qty, SUM(org_amt) as org_amt, SUM(net_amt) as net_amt, SUM(disc_round) as disc_round, ;
					SUM(svc_amt) as svc_amt, SUM(disc_round) as discount_amount, 0 as round_amount ;
				from cun_itemdept ;
				group by dept_id, desccn, descen, disporder INTO CURSOR cun_itemdept_gp readwrite
			
			&&&&¥[¤@
			IF VARTYPE(__srv_as_dept)#"U" and __srv_as_dept
				Local _plusOne_dept_id, _plusOne_dept_name   
				_plusOne_dept_id  = 0
				_plusOne_dept_name  =""
				SELECT cun_tmp7
				LOCATE FOR srv_to_dept = .t.
				IF FOUND()
					_plusOne_dept_id = cun_tmp7.id
					_plusOne_dept_name = IIF(_system_langue = "EN", cun_tmp7.descen, cun_tmp7.desccn)
				ELSE
					GO TOP IN "cun_tmp7"
					LOCATE FOR desccn = "¥[¤@"
					IF FOUND()
						_plusOne_dept_id = cun_tmp7.id
						_plusOne_dept_name = IIF(_system_langue = "EN", cun_tmp7.descen, cun_tmp7.desccn)
					ENDIF 
				ENDIF
				 		
				IF _plusOne_dept_id > 0  
					IF USED("cun_itemdept_plusone_qty")
						SELECT cun_itemdept_plusone_qty
						COUNT TO _plusOne_dept_qty 
					ELSE
						_plusOne_dept_qty = 0
					ENDIF 
		
					
					SELECT cun_itemdept_gp 			
					&&replace ALL real_amt WITH real_amt - svc_amt FOR dept_id <> _plusOne_dept_id
					replace ALL net_amt WITH net_amt - svc_amt FOR dept_id <> _plusOne_dept_id
					
					SUM svc_amt TO _sum_svc_amt FOR dept_id <> _plusOne_dept_id
					replace ALL svc_amt WITH 0 FOR dept_id <> _plusOne_dept_id
								
					&&real_amt 	WITH real_amt + _sum_svc_amt, ; 	 
					SELECT cun_itemdept_gp
					GO TOP 
					LOCATE FOR dept_id = _plusOne_dept_id
					IF !FOUND()
						APPEND BLANK
						replace dept_id 	with _plusOne_dept_id
					ENDIF
					IF alltrim(_plusOne_dept_name) = "ªA°È¶O"
					 	replace org_amt 	with org_amt + _sum_svc_amt
					ELSE
						replace svc_amt 	with svc_amt + _sum_svc_amt
					ENDIF
					replace net_amt	with net_amt + _sum_svc_amt, ;
							qty			with _plusOne_dept_qty	
								
				ENDIF 

			ENDIF 
				
				

			Local _dept_amt	
			Select cun_tmp7					&&department
			SCAN
				_descdisp = Iif(_system_langue="CN",Trim(cun_tmp7.desccn),Trim(cun_tmp7.Descen))
				_dept_id = cun_tmp7.Id
						 
				Select cln_tmp6
				Append Blank
				Replace r_id  With 6, descdisp With _descdisp, Id With _dept_id 
				
				SELECT cun_itemdept_gp
				LOCATE FOR dept_id = _dept_id 
				IF FOUND()
					_dept_amt = Iif(_chkdept=1, cun_itemdept_gp.org_amt, cun_itemdept_gp.net_amt)
					&&real_amount 	WITH cun_itemdept_gp.real_amt, ; && - cun_itemdept_gp.tax_amt
					replace qty WITH cun_itemdept_gp.qty IN cln_tmp6
					replace org_amount 		WITH cun_itemdept_gp.org_amt, ;
							amt 			WITH _dept_amt, ;
							dept_amt 		WITH _dept_amt - cun_itemdept_gp.svc_amt, ;		
							real_amount		WITH cun_itemdept_gp.net_amt, ;		&&¹ê¦¬ real_amount -> net_amt (layout ªº¹ê¦¬Äæ¦ìÅÜ¶q_total_dept_real_amt)  2022-10-08 by sam 
							srv 			WITH cun_itemdept_gp.svc_amt, ;
							discount_amount WITH cun_itemdept_gp.disc_round, ;
							round_amount	WITH cun_itemdept_gp.round_amount IN cln_tmp6
					
				ENDIF
				
				SELECT cun_tmp7 
			ENDSCAN		
			
				
*!*				Select cun_itemdept_gp 
*!*				
*!*				If _chkdept=1  &&_chkdept=1  «ö­ì»ù­p¡A  =2 «ö¹ê»ù­p

*!*					Sum org_amt To tm1 FOR id>0
*!*				Else
*!*					Sum net_amt FOR id>0
*!*				Endif
*!*					
*!*				Select cln_tmp6
*!*				Sum amt To tm2

*!*				If tm1<>tm2
*!*					Select cln_tmp6
*!*					Locate For qty>0
*!*						Replace amt With amt+(tm1-tm2),dept_amt With dept_amt+(tm1-tm2)

*!*				Endif


			If Used("cun_tmp25")
				Use In cun_tmp25
			Endif

			If Used("cun_tmp26")
				Use In cun_tmp26
			Endif

			Select cln_tmp6
			Delete For qty=0 AND dept_amt =0	&&¼Æ¶q¬°¹s¤£²Î­p¡A¦ýª÷ÃB¬°¹s²Î­p
			

			IF  Lower(__special_customer) = "nathanhotel"
			
				_descdisp =getmessage("_dept_amt") + " " +getmessage("_svr_charge")
				
				Select cln_tmp6
				Sum srv To _dept_srv_amt	&&ªA°È¶O
				
				APPEND BLANK 
				REPLACE  r_id WITH 6, descdisp  WITH _descdisp ,dept_amt WITH _dept_srv_amt
			
			ENDIF
			
			Sum qty To _total_dept_qty
			_total_dept_qty = ROUND(_total_dept_qty, 0)
			Sum amt  To _total_dept_amt	&&§tªA°È¶O*
			Sum srv To _total_dept_srv_amt	&&ªA°È¶O
			sum org_amount to _total_dept_orgamt
			sum real_amount to _total_dept_real_amt  
			sum discount_amount to _total_dept_disc_amt
			sum round_amount to _total_dept_rnd_amt
			
		ENDIF 

	Endcase
			
Endif
*-------------------------------------------
*!* Select cln_tmp6
*!* Sum amt To _total_dept_amt  FOR id>0

*!* IF  _total_dept_amt-_total_dept_srv_amt <>_total_dept_real_amt 
	*!* nsub=_total_dept_amt-_total_dept_srv_amt -_total_dept_real_amt 
	
	*!* _total_dept_real_amt =_total_dept_real_amt +nsub
	
	*!* SELECT cln_tmp6 
	*!* GO TOP 
	*!* REPLACE dept_amt WITH  dept_amt +nsub
	*!* SET STEP ON 	

*!* ENDIF





Select Sum(dept_amt) As amt From cln_tmp6 Where Id In (Select Id From cun_tmp7 Where Descen='TIPS') Into Cursor cr_tmp

_tips_amt =NVL(cr_tmp.amt,0)

_saleamt = _total_netamt- _tips_amt 		&&Àç·~ÃB¡]¥¼¥]¬A¤p¶O¡^




Use In cr_tmp


*--------------------------------------------


&&Àç·~°Ï°ì¤ÀªR

_total_outlet_amt=0
Select cun_tmp10
Scan

	_id=Id

	Select Id,invamt,pplcnt Distinct  From cun_tmp Where outlet_Id=_id Into Cursor cun_tmp000
	Select cun_tmp000
	Sum invamt,pplcnt To m,p
	If p>0
		Select cln_tmp7
		Append Blank
		Replace r_id With 7,descdisp With Iif(_system_langue="CN",Trim(cun_tmp10.desccn),Trim(cun_tmp10.Descen)),amt With m,pplcnt With p,amtperhead With m/p
		_total_outlet_amt=_total_outlet_amt+m
	Endif

	Select cun_tmp000
	Use


Endscan

*------------------------------

&& µæ¦¡¤ÀªR
Select cun_tmp12
Scan

	_id=cun_tmp12.Id
	Select cun_tmp8
	Sum qty,  real_amount+xdisc+round_amount         To _qty,_amt For item_id=_id		&& 2013.11.19

	If Vartype(_show_item_with_zero_amt)#"U" And _show_item_with_zero_amt=.F.		&&¦pªGª÷ÃB¬°¹s¡A¬O§_Åã¥Ü¸òÀH³]©w

		If _amt=0 AND _qty=0
			Loop

		Endif


	Endif


	Select cln_tmp8
	Append Blank
	Replace r_id With 8,descdisp With Iif(_system_langue="CN",Trim(cun_tmp12.desccn),Trim(cun_tmp12.Descen)),qty With _qty,amt With _amt ,item_code WITH TRIM(cun_tmp12.code) 	
		

Endscan


Select * From cln_tmp8 Order By descdisp Into Cursor cln_tmp8 Readwrite
Index On r_id Tag Item


&& ¶}¤ä¤ÀªR

Select cun_tmp14
Scan
	Select cln_tmp9
	Append Blank
	Replace r_id With 9,descdisp With  Iif(_system_langue="CN",Trim(cun_tmp14.desccn),Trim(cun_tmp14.Descen)),payway With cun_tmp14.cpayway, amt With cun_tmp14.amount

Endscan

Select cln_tmp9
Sum amt To _total_expense_amt For Upper(payway)="CASH"		&&¤ä¥Xª÷ÃB(²{ª÷)

*_total_expense_amt=-1*_total_expense_amt
*--------------------------------------------


&&§ó§ï»ù®æ°O¿ý

If _print_chg_price_Log  And Used("cun_tmp15")

	Select cun_tmp15
	Scan
		Select cln_tmp10
		Append Blank
		Replace r_id With 10,action With  Trim(cun_tmp15.action),Datetime With cun_tmp15.Datetime,adduser With Trim(cun_tmp15.adduser)

	Endscan

Endif

*------------HOLLAND TAX   add by david 2009.01.02

_total_tax_amt=0.00

Update cun_tmp8 Set tax2=0 Where Isnull(tax2)
*********TAX2  ADD BY DAVID  2009.01.02
*Select tax2,Sum((real_amount+round_amount+xdisc)-(real_amount+round_amount+xdisc)/(1+tax2/100)) As amt  From cun_tmp8 Group By tax2 Where tax2>0 Into Cursor tax2_tmp		&&¬O§_¦³²üÄõµ|
Select tax2  From cun_tmp8 Group By tax2 Where tax2>0 Into Cursor tax2_tmp		&&¬O§_¦³²üÄõµ|

If _Tally>0


	Select c.desccn,c.Descen,b.dept_id,a.tax2,  SUM((a.real_amount+a.round_amount+a.xdisc)/(1+tax2/100) ) AS orgamt  ,Sum((a.real_amount+a.round_amount+a.xdisc)-(a.real_amount+a.round_amount+a.xdisc)/(1+tax2/100))  As amt ;
		from cun_tmp8 a Left Join cun_tmp9 b On a.item_id=b.item_id ;
		left Join cun_tmp7 c On b.dept_id=c.Id Where tax2>0 ;
		group By c.desccn,c.Descen,b.dept_id,a.tax2  Order By c.desccn,a.tax2 ;
		INTO Cursor tax2_tmp

	Select tax2_tmp
	Go Top
	_same=.F.
	Do Whil !Eof()

		_dept_id =dept_id

		If _same=.F.

			Insert Into cln_tmp11 (r_id,descdisp )Values (11, Iif(_system_langue="CN" , Trim(tax2_tmp.desccn) ,Trim(tax2_tmp.Descen)) )

		Endif

		Select tax2_tmp

		Skip

		If dept_id =_dept_id
			_same=.T.

		Else

			_same=.F.

		Endif


		Skip -1

		Insert Into cln_tmp11 (r_id,descdisp,orgamt, amt )Values (11, Space(8) + Alltrim(Str(tax2_tmp.tax2,10,2))+"%", tax2_tmp.orgamt,  tax2_tmp.amt )


		Select tax2_tmp

		Skip




	Enddo



Else		&&µ|¶µ


	Select tax_id,Sum(tax_amount) As amt From cun_tmp18 Group By tax_id Into Cursor tax2_tmp


	Select tax2_tmp
	Scan

		Select desccn,Descen From cun_tmp18 Where tax_id=tax2_tmp.tax_id Into Cursor tax3_tmp

		_desc=Iif(_system_langue="CN",NVL(Trim(tax3_tmp.desccn),""),NVL(Trim(tax3_tmp.Descen),""))

		Insert Into cln_tmp11 (r_id,descdisp,amt) Values (11,_desc,tax2_tmp.amt)


	Endscan



Endif

Select cln_tmp11
Sum amt To _total_tax_amt 


If Used("tax3_tmp")
	Use In tax3_tmp

Endif

If Used("tax2_tmp")
	Use In tax2_tmp

Endif




&&§ó§ï»ù®æ°O¿ý

If  Used("cun_tmp16")

	Select cun_tmp16
	Scan
		Select cln_tmp12
		Append Blank
		Replace r_id With 12,action With  Trim(cun_tmp16.action),Datetime With cun_tmp16.Datetime,adduser With Trim(cun_tmp16.adduser)

	Endscan

Endif

*--------------------------
Select fastfood_info_tmp		&&2009.10.22   §ÖÀ\¤ÀªR
Scan

*SELECT count(0) as qty,SUM(invamt) as amt FROM cun_tmp WHERE fastfood  AND fastfood_info_id=fastfood_info_tmp.id INTO CURSOR fastinfo_tmp

	Select cun_tmp11
	Count To _fastfood_qty For fastfood  And fastfood_info_id=fastfood_info_tmp.Id

	If _fastfood_qty>0

		Sum invamt To _fastfood_amt For fastfood  And fastfood_info_id=fastfood_info_tmp.Id
		Insert Into cln_tmp13 (r_id,descdisp,qty,amt) Values (13,Iif(_system_langue="CN",Trim(fastfood_info_tmp.desccn),Trim(fastfood_info_tmp.Descen)),_fastfood_qty,_fastfood_amt )



	Endif


Endscan

Select cln_tmp13

Sum qty,amt To _total_fastfood_qty,_total_fastfood_amt

*SET STEP ON
*
If Used("fastinfo_tmp")

	Use In fastinfo_tmp

Endif

*-----------------------------------
* 2010.07.30 ¦L³æ«á§é¦©


If _disc_after_inv

	Select cun_tmp19
	Scan

		Insert Into cln_tmp14 (r_id,inv_no,cUser,amt) Values (14,cun_tmp19.inv_no,cun_tmp19.adduser,cun_tmp19.disc_amount)


	Endscan

Endif

Select cln_tmp14
Sum amt  To  _total_invdisc_amt


If _noDisc_have_points And Vartype(__member_printer_installed)#"U" And __member_printer_installed


	Select cun_tmp22
	Scan

		Insert Into cln_tmp15 (r_id,cardno,inv_no,cUser,amt) Values (15,cun_tmp22.cardno,cun_tmp22.invno,cun_tmp22.cashier,cun_tmp22.amount)


	Endscan



Endif

Select cln_tmp15
Sum amt To _total_card_amt


*-------




If _show_section	&& 2011.07.28  ®É¬q¤ÀªR


	IF _section_type=1
	
		cFieldName="begintime"
		
	ELSE

		cFieldName="paidtime"
	
	
	ENDIF
	

	Select section_tmp
	Scan
		Insert Into cln_tmp16 (r_id,descdisp,s_from,s_to) Values (16,Iif(_system_langue="CN",Trim(section_tmp.desccn),Trim(section_tmp.Descen)),Trim(section_tmp.s_from),Trim(section_tmp.s_to))


	Endscan

	&&Lihong 2022.04.09 ms fastfood
	IF LOWER(__special_customer)=="ms" 
		
	Select cln_tmp16
	Scan
		If cln_tmp16.s_from > cln_tmp16.s_to		&&¸ó¤Ñ
			Select cun_tmp11
			Sum invamt,pplcnt,srvamt To _amt,_ppl,_srvamt For fastfood=.F. AND Substr(Ttoc(&cFieldName,2),1,5) >= cln_tmp16.s_from Or   Substr(Ttoc(&cFieldName,2),1,5) <= cln_tmp16.s_to
		Else
			Select cun_tmp11
			Sum invamt,pplcnt,srvamt To _amt,_ppl,_srvamt For fastfood=.F. AND Substr(Ttoc(&cFieldName,2),1,5) >= cln_tmp16.s_from And  Substr(Ttoc(&cFieldName,2),1,5) <= cln_tmp16.s_to
		Endif
		Select cln_tmp16
		Replace amt With _amt,pplcnt With Int(_ppl),srvamt  WITH _srvamt 
	Endscan
	Select cun_tmp11
	Sum invamt,pplcnt,srvamt To _amt,_ppl,_srvamt For fastfood=.T. 
	lcmsg_fastfood = getmessage("_fastfood")
	Select cln_tmp16
	Insert Into cln_tmp16 (r_id,descdisp,s_from,s_to) Values (16,lcmsg_fastfood,"","") 
	Replace amt With _amt,pplcnt With Int(_ppl),srvamt  WITH _srvamt 
		

	ELSE 
	
	Select cln_tmp16
	Scan


		&&Lihong 2022.02.25 ¼W¥[srvamt
		If cln_tmp16.s_from > cln_tmp16.s_to		&&¸ó¤Ñ
		
		
*		SET STEP ON 

			Select cun_tmp11
			
			Sum invamt,pplcnt,srvamt To _amt,_ppl,_srvamt For Substr(Ttoc(&cFieldName,2),1,5) >= cln_tmp16.s_from Or   Substr(Ttoc(&cFieldName,2),1,5) <= cln_tmp16.s_to


			If "redant"$Lower(__special_customer)


				Select Sum(real_amount+round_amount+xdisc) As  amt From cun_tmp8 Where (item_code='CARDTIPS' Or  item_code='CASHTIPS') ;
					AND Id In (Select Id From cun_tmp Where  Substr(Ttoc(&cFieldName,2),1,5) >= cln_tmp16.s_from Or   Substr(Ttoc(&cFieldName,2),1,5) <= cln_tmp16.s_to) Into Cursor  cr_tmp

				_amt = _amt -  Nvl(cr_tmp.amt,0)


			Endif





		Else
			Select cun_tmp11
			Sum invamt,pplcnt,srvamt To _amt,_ppl,_srvamt For Substr(Ttoc(&cFieldName,2),1,5) >= cln_tmp16.s_from And  Substr(Ttoc(&cFieldName,2),1,5) <= cln_tmp16.s_to

			If "redant"$Lower(__special_customer)


				Select Sum(real_amount+round_amount+xdisc) As  amt From cun_tmp8 Where (item_code='CARDTIPS' Or item_code='CASHTIPS' );
					AND Id In (Select Id From cun_tmp Where Substr(Ttoc(&cFieldName,2),1,5) >= cln_tmp16.s_from And  Substr(Ttoc(&cFieldName,2),1,5) <= cln_tmp16.s_to ) Into Cursor cr_tmp

				_amt = _amt -  Nvl(cr_tmp.amt,0)


			Endif


		Endif


		Select cln_tmp16
		Replace amt With _amt,pplcnt With Int(_ppl),srvamt  WITH _srvamt 


	Endscan

	ENDIF &&"ms" 


Endif



*----

If Vartype(_show_sa_hourly)#"U" And _show_sa_hourly		&& ¨C¤p®ÉÀç·~ÃB


	For i =0 To  23

		Insert Into cln_tmp17 (r_id, descdisp ,sTime ,eTime ) Values (17, Padl(i,2,"0")+":00"+"--"+Padl(i,2,"0")+":59", Padl(i,2,"0")+":00",Padl(i,2,"0")+":59")

	Endfor

	Local nHour,nqty


	Select cln_tmp17
	Scan

		nHour=Val(cln_tmp17.sTime)
		Select cun_tmp11
		Count To tn For Hour(begintime) = nHour
		Sum invamt To nAmt For Hour(paidtime) = nHour

		Select Sum(qty) As qty From cun_tmp8 Where Id In (Select Id From cun_tmp11 Where Hour(paidtime) = nHour) Into Cursor cr_tmp
		nqty=Nvl(cr_tmp.qty,1)


		Select cln_tmp17
		Replace Cnt With tn, qty With nqty , amt With Nvl(nAmt,0)

	Endscan


	Select cln_tmp17

	Sum amt To nTamt

	If nTamt >0

		Scan

			Replace per With  amt/nTamt * 100


		Endscan

	Endif



	If Used("cr_tmp")

		Use In cr_tmp

	Endif


	SELECT cln_tmp17
	REPLACE ALL qty WITH 0 FOR cnt = 0 AND amt = 0



Endif

*------------------	®ø¶O¤ÀªR
If Vartype(__special_customer)#"U" And "whiteblack"$Lower(__special_customer)


	Local lcPerson

	lcPerson =	getmessage("_local")

	Select Count(0) As Cnt,Sum(pplcnt) As pplcnt,Sum(invamt) As invamt From cun_tmp Where Nvl(isForeign,.F.)=.F.  Into Cursor cr_tmp

	Select cln_tmp18
	Append Blank
	Replace r_id With 18,descdisp  With lcPerson ,Cnt With Nvl(cr_tmp.Cnt,0),pplcnt With Nvl(cr_tmp.pplcnt,0) , amt  With Nvl(cr_tmp.invamt,0)

	lcPerson = getmessage("_Foreigner")

	Select Count(0) As Cnt,Sum(pplcnt) As pplcnt,Sum(invamt) As invamt From cun_tmp Where Nvl(isForeign,.F.)  Into Cursor cr_tmp

	Select cln_tmp18
	Append Blank
	Replace r_id With 18,descdisp  With lcPerson ,Cnt With Nvl(cr_tmp.Cnt,0),pplcnt With Nvl(cr_tmp.pplcnt,0) , amt  With Nvl(cr_tmp.invamt,0)


Endif


*-------------------------  && µo²¼§é¦©²M³æ²Ó¸`

If _inv_disclist


	Select Id  Distinct From cun_tmp Where Id In (Select Id From cun_tmp4) Or Id In (Select Id From cun_tmp5) Order By Id Into Cursor invdisc_tmp

	If _Tally>0


		Select invdisc_tmp
		Scan

*!*				SELECT cln_tmp20
*!*				APPEND BLANK
*!*				REPLACE r_id WITH 20,inv_id WITH invdisc_tmp.id

			Select a.disc_id,b.desccn,b.Descen, Sum(disc_amount) As amt From cun_tmp4 a Left Join cun_tmp6 b On a.disc_id=b.Id Where a.Id=invdisc_tmp.Id Group By a.disc_id,b.desccn,b.Descen  ;
				UNION 	Select a.disc_id,b.desccn,b.Descen, Sum(disc_amount) As amt From cun_tmp5 a Left Join cun_tmp6 b On a.disc_id=b.Id Where a.Id=invdisc_tmp.Id Group By a.disc_id,b.desccn,b.Descen  ;
				INTO Cursor invdisc_tmp1

			Select 	invdisc_tmp1
			Scan

				Select cln_tmp20
				Append Blank
				Replace r_id With 20,inv_Id With invdisc_tmp.Id,disc_desc With Iif(_system_langue="CN",Trim(invdisc_tmp1.desccn),Trim(invdisc_tmp1.Descen)),discamt With invdisc_tmp1.amt


			Endscan


		Endscan


		Use In invdisc_tmp1


	Endif

	Use In invdisc_tmp



Endif

*------------------------
If _item_move	&&¦L³æ«áÂà»O

	Select cun_tmp20
	Scan


		Insert Into cln_tmp21 (r_id,	descdisp , qty, amt ,Datetime,adduser );
			VALUES (21,Iif(_system_langue="CN",Trim(NVL(cun_tmp20.desccn,"")),Trim(NVL(cun_tmp20.Descen,""))), cun_tmp20.qty, cun_tmp20.amount, cun_tmp20.Datetime,cun_tmp20.adduser)


	Endscan


Endif

*------------------------
*Create Cursor cln_tmp21 (r_id Int, descdisp c(30) ,  award N(12,2) ,liked_inv_per N(6,2),liked_amt_per N(6,2) )  &&­û¤u ¡A ¼úª÷ ¡A ¦n³æ¡]%¡^ ¡A¦n³æª÷ÃB¡]%¡^

IF LOWER(__special_customer)="good"		&&­û¤u¼úª÷

	SELECT adduser,SUM(invamt) as invamt, SUM(invamt)*__staff_award_percent/100  as award,COUNT(0) as nliked FROM cun_tmp11 WHERE liked GROUP BY adduser ORDER BY adduser INTO CURSOR cr_tmp
	
	SELECT cr_tmp
	SCAN
	
		SELECT SUM(invamt) as invamt, COUNT(0) as nQty FROM cun_tmp11 WHERE adduser=cr_tmp.adduser INTO CURSOR cr_tmp2
		
		SELECT cln_tmp22
		APPEND BLANK 
		REPLACE r_id WITH 22 ,descdisp WITH cr_tmp.adduser, award WITH cr_tmp.award , liked_inv_per WITH ALLTRIM(STR(cr_tmp.nliked/cr_tmp2.nQty * 100 ,10, 2))+"%", ;
			liked_amt_per WITH ALLTRIM(STR(cr_tmp.invamt/cr_tmp2.invamt*100,10,2))+"%"
		
	
	ENDSCAN

	USE IN cr_tmp
	USE IN cr_tmp2
	

ENDIF

*-------------------------


Select cun_tmp21
Sum amount To _less_cash_amt		&& ¤Ö¦¬²{ª÷


*---------------------------
Select cun_tmp17
Sum srvamt To _itemdept_srvamt		&&


Select cun_tmp11
Sum orgamt,amount,modiamt,rndamt,srvamt,taxamt,tips,pplcnt,discamt,itemdiscamt,invamt To _orgamt,_amount,_modiamt,_rndamt,_srvamt,_taxamt,_total_tips,_cust_qty,_discamt,_itemdisc,_invamt		&&­ì©lª÷ÃB,·L½Õ,ÅU«È¤H¼Æ


If Lower(__special_customer) = "shirokiya"


	_orgamt= _amount - _itemdept_srvamt

	_discamt = _discamt+_itemdisc

	_subtotal=_orgamt + _discamt +  _rndamt					&&¤p­p


Else


	_orgamt=_amount+_discamt+_itemdisc  &&- _itemdept_srvamt
	
	_subtotal=_orgamt+_rndamt					&&¤p­p

Endif

&&Lihong 2020.09.01 ¥u§ï³q¥Îª©frx
*_orgamt = _orgamt - _orgamt_points_sales 

_cust_qty=Int(_cust_qty)

&&_srvamt=_srvamt +_itemdept_srvamt

_payamt=_invamt								&&À³¦¬ª÷ÃB
_total_income=_invamt						&&¦@¦¬ª÷ÃB

If _cust_qty<=0
	_amt_perhead=0

Else

	_amt_perhead=_invamt/_cust_qty

Endif


_amt_dine_in=""
_amt_fastfood=""

Count To _inv_qty							&&µo²¼±i¼Æ
If _inv_qty=0

	_amt_perorder=0
Else

	_amt_perorder=_invamt/_inv_qty

Endif


cnotice=Iif(GL_training,getmessage("_training"),"")

*-------------------------------------------------------------------------
Select cln_tmp 						&&«Ø¥ßÃöÁp,¦hDETAIL³øªí¥²¶·
Set Relation To r_id Into cln_tmp1
Set Relation To r_id Into cln_tmp2 Additive
Set Relation To r_id Into cln_tmp3 Additive
Set Relation To r_id Into cln_tmp4 Additive
Set Relation To r_id Into cln_tmp5 Additive
Set Relation To r_id Into cln_tmp6 Additive
Set Relation To r_id Into cln_tmp7 Additive
Set Relation To r_id Into cln_tmp8 Additive
Set Relation To r_id Into cln_tmp9 Additive
Set Relation To r_id Into cln_tmp10 Additive
Set Relation To r_id Into cln_tmp11 Additive
Set Relation To r_id Into cln_tmp12 Additive
Set Relation To r_id Into cln_tmp13 Additive
Set Relation To r_id Into cln_tmp14 Additive
Set Relation To r_id Into cln_tmp15 Additive
Set Relation To r_id Into cln_tmp16 Additive
Set Relation To r_id Into cln_tmp17 Additive
Set Relation To r_id Into cln_tmp18 Additive
Set Relation To r_id Into cln_tmp19 Additive
Set Relation To r_id Into cln_tmp20 Additive
Set Relation To r_id Into cln_tmp21 Additive
Set Relation To r_id Into cln_tmp22 Additive
*IF _Memb_Record
	Set Relation To r_id Into cln_tmp23 ADDITIVE &&Lihong 2021.12.15 ·|­û®ø¶O°O¿ý
*ENDIF 
&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
Set Relation To r_id Into cln_tmp24 ADDITIVE
Set Relation To r_id Into cln_tmp25 ADDITIVE

Do Case

	Case  "redant"$Lower(__special_customer) OR LOWER(__special_customer)=="red_ant2022"

		tmpfrx = "report\clean_redant"


	Case "shirokiya"$Lower(__special_customer)

		tmpfrx = "report\clean_shirokiya"




	Case "kamloi"$Lower(__special_customer)

		tmpfrx = "report\clean_kamloi"

	CASE  LOWER(__special_customer)="good"

		tmpfrx = "report\clean_good"
	
	CASE  LOWER(__special_customer)=="ms"
	&&Lihong 2022.02.25 *­«¦L/¤éµ²³£¬O_dayend_report=.T¡A¦¹®É_cln_Id>0¼Ð°O¬O­«¦L¥BµL½×reprint/report©l²×»Ý­ncln_crasher_tmp1¡A_dayend_report=.F.¼Ð°O¬O²M¾÷
		tmpfrx = "report\clean_ms"
		IF VARTYPE(_MS_reprint_report)#"U" AND _MS_reprint_report=.T.
			tmpfrx = "report\clean_ms_report"
		ENDIF 
		_cln_no_ms_caption=getmessage("_cln_no")+":"
		_cReportName = "©¹¤éÀç·~³øªí" + " [All]" + "(" + _Cashier + ")"
		_cbusiness_day = "Àç·~¤é´Á:"
		SELECT MIN(belongdate) as days, MAX(belongdate) as daye FROM cun_tmp11 INTO CURSOR cun_tmp_tmp &&¤£¤Àcln  &&¤K¹F³qvoid ³æcun_tmp13 ?
		_business_days = TTOD(cun_tmp_tmp.days)
		_business_daye = TTOD(cun_tmp_tmp.daye)
		lncrasher_len = LEN(cln_tmp4.crasher)
		IF _clean_reprint AND VARTYPE(_MS_dayend_ms_split)#"U" AND _MS_dayend_ms_split=.T.
			SELECT CAST(0 as int) as r_id, cln, CAST(adduser as c(lncrasher_len)) as crasher, MIN(paidtime) as dtmin, MAX(paidtime) as dtmax FROM cun_tmp_befor_delete_0pay GROUP BY cln, adduser INTO CURSOR cun_tmp_tmp READWRITE 
		ELSE 
			SELECT CAST(0 as int) as r_id, CAST(0 as int) as cln, CAST(adduser as c(lncrasher_len)) as crasher, MIN(paidtime) as dtmin, MAX(paidtime) as dtmax FROM cun_tmp_befor_delete_0pay GROUP BY adduser INTO CURSOR cun_tmp_tmp READWRITE 
		ENDIF 
		_ctime = "¦C¦L¤é´Á:"
		_cDesc = "¶µ¥Ø¦WºÙ"
		_cDesc_sum = "¼È­p"
		_camt_sales = "¼ÆÃB"
		_camt_srv = "¥[¤@"
		_cAmt_busi = "Á`µ²"
		SELECT cln_tmp4
		DELETE for ALLTRIM(crasher)==Replicate("-",50) OR istotal=.T.  OR RECNO()>_recn
		GO TOP 
		SELECT crasher,cln FROM cln_tmp4 GROUP BY crasher,cln ORDER BY crasher,cln INTO CURSOR cln_tmp4_crasher
		SELECT CAST(0 as int) as r_id, * FROM cln_tmp4_crasher INTO CURSOR cln_tmp4_crasher READWRITE 
		REPLACE ALL r_id WITH RECNO()+100 IN cln_tmp4_crasher
		UPDATE a SET a.r_id=b.r_id from cln_tmp4 a left join cln_tmp4_crasher b on a.crasher==b.crasher AND a.cln=b.cln
		UPDATE a SET a.r_id=b.r_id from cun_tmp_tmp a left join cln_tmp4_crasher b on a.crasher==b.crasher AND a.cln=b.cln
		SELECT cln_tmp
		Set Relation To
		IF _clean_reprint AND USED("cln_crasher_tmp") &&­«¦L  ªÅcrasher¤£¥¿½T¡]¨S¦³¡^?
			IF VARTYPE(_MS_reprint_report)#"U" AND _MS_reprint_report=.T. &&from ³øªí¥\¯à
				*Create Cursor cln_tmp4(r_id Int,cln int,crasher c(50),payway c(30),paytimes N(6,0),tips N(12,2),amt N(12,2),Changes N(12,2),tamt N(12,2),netamt N(12,2),adduser c(20),istotal L,islocal L,pay_id Int)
				*SELECT crasher, cln FROM cln_tmp4 GROUP BY crasher, cln INTO CURSOR cln_tmp4_total
				*IF RECCOUNT("cln_tmp4_total")>1
				SELECT cln_crasher_tmp
				GO TOP 
				IF choose=.T.
					SELECT CAST(16 as int) as r_id, Replicate("-",50) as crasher, pay_id, payway, SUM(paytimes) as paytimes, SUM(tips) as tips, SUM(amt) as amt, SUM(Changes) as Changes, SUM(tamt) as tamt, SUM(netamt) as netamt FROM cln_tmp4 ;
					GROUP BY pay_id, payway ORDER BY pay_id, payway INTO CURSOR cln_tmp4_total READWRITE 
					*REPLACE ALL r_id WITH 16
					SELECT cln_tmp4
					APPEND FROM DBF("cln_tmp4_total")
					select r_id FROM cln_tmp4_crasher WHERE crasher in (SELECT crasher FROM cln_crasher_tmp WHERE rno>1 AND choose=.T.) INTO CURSOR cln_tmp READWRITE &&UNION SELECT * FROM cln_tmp WHERE r_id=16 
					APPEND BLANK 
					REPLACE r_id WITH 16
					GO TOP 
				ELSE
					select r_id FROM cln_tmp4_crasher WHERE crasher in (SELECT crasher FROM cln_crasher_tmp WHERE rno>1 AND choose=.T.) INTO CURSOR cln_tmp READWRITE
				ENDIF 
				USE IN SELECT("cln_tmp4_total")
			ELSE &&Àç·~¸ê®Æ
*!*					SELECT cln_crasher_tmp
*!*					GO TOP 
*!*					IF choose=.T.
*!*						SELECT * FROM cln_tmp WHERE r_id=16 UNION select r_id FROM cln_tmp4_crasher WHERE crasher in (SELECT crasher FROM cln_crasher_tmp WHERE rno>1 AND choose=.T.) INTO CURSOR cln_tmp READWRITE
*!*					ELSE 
					select r_id FROM cln_tmp4_crasher WHERE crasher in (SELECT crasher FROM cln_crasher_tmp WHERE rno>1 AND choose=.T.) INTO CURSOR cln_tmp READWRITE
*!*					ENDIF 
			ENDIF 
		ELSE 
			IF _dayEnd_report &&¤éµ²
				SELECT * FROM cln_tmp WHERE r_id=16 UNION select r_id FROM cln_tmp4_crasher INTO CURSOR cln_tmp READWRITE
			ELSE &&²M¾÷
				select r_id FROM cln_tmp4_crasher INTO CURSOR cln_tmp READWRITE
			ENDIF 
		ENDIF 
		

		SELECT *, CTOT("") as pay_Times, CTOT("") as pay_Timee FROM cln_tmp INTO CURSOR cln_tmp READWRITE
		UPDATE a SET a.pay_Times=b.dtmin, a.pay_Timee=b.dtmax from cln_tmp a left join cun_tmp_tmp b on a.r_id==b.r_id WHERE a.r_id>100 
		SELECT cln_tmp
		LOCATE FOR r_id=16
		IF FOUND() &&_MS_reprint_report=.T. from ³øªí¥\¯à ¤~¨Ï¥Î³o­Ó­È
			SELECT MIN(dtmin) as dtmin, MAX(dtmax) as dtmax FROM cun_tmp_tmp INTO CURSOR cun_tmp_tmp
			SELECT cln_tmp
			REPLACE pay_Times WITH cun_tmp_tmp.dtmin, pay_Timee WITH cun_tmp_tmp.dtmax FOR r_id=16 IN cln_tmp
		ENDIF 
		USE IN SELECT("cln_tmp4_crasher")
		USE IN SELECT("cun_tmp_tmp")
		
		SELECT cln_tmp
		Set Relation To r_id Into cln_tmp4 
		Set Relation To r_id Into cln_tmp16 Additive
		GO TOP 
		_ctotal = "Á`ÃB"
		_corgamt = "¾P°âÁ`©M"
		_ctotal_tips = "¥d¤p¶O"
		_cDiscAmt = "§é¦©Á`¼Æ"
		_cinv_qty = "³æ¾Ú¼Æ¥Ø"
		_cvoid_inv_count = "¨ú®ø³æ¼Æ¥Ø"
		_cCust_qty = "¤H¼Æ"
		_cAmtPerorder = "¨C³æ¥­§¡"
		_cAmtPerhead = "¨C¤H¥­§¡"
		_cEnd = "§¹²¦"
		*¥I´Ú
		_cReportName_pay = "<¦¬»È³øªí>"
		*_cReportName_pay2 = "¦¬»È³øªí[©¹¤é](Á`µ²)"
		_cpay_day = "¤é´Á:"
		*_pay_days = _business_days
		_cpay_time = "®É¶¡½d³ò:"
		_cpay_Time_to = " ¦Ü "
		_cPayway = "¥I´Ú¤èªk"
		_cAmt = "¥I´ÚÃB"
		_ctAmt = "Á`¼Æ"
		_ctimes = "¥I´Ú¦¸¼Æ"
		_crasher = "­û¤u:"
		_cAmt2 = "¥I´Ú¼ÆÃB"
		_cTips2 = "¤p¶OÁ`¼Æ"
*!*			SELECT * FROM cln_tmp4 INTO CURSOR cln_tmp4_Repeat READWRITE 
*!*			SELECT cln_tmp 
*!*			Set Relation To r_id Into cln_tmp4_Repeat Additive

	Otherwise

		tmpfrx = "report\clean"
		
		&&Lihong 2023.01.19 cln by user
		IF _clean_reprint AND Upper(__checked_method)="USER"
			*_Cashier = cun_tmp_befor_delete_0pay.adduser
		ENDIF 
Endcase
USE IN SELECT("cun_tmp_befor_delete_0pay")

*tmpfrx="d:\clean"


*!*	If __debug_mode And _vfp.StartMode=0

*!*		xtype = "PDF"
*!*		xfile = "R_clean"  	&&+ ".pdf"

*!*		report2PDF("cln_tmp",xfile)



*!*		Report Form (tmpfrx)  To Printer Noconsole Nodialog  Preview

*!*		Return 1

*!*	Endif

	*Report Form  (tmpfrx ) NOCONSOLE  ASCII   to file "d:\clean.txt" 

	

* report2Doc("d:\clean.txt")



	Select cln_tmp
	Go Top
		
*	Erase (xfile)

*	report_main.Release

*Else

	If _do_print 							&& °õ¦æ²M¾÷

		If _dayEnd_report=.F.

			=SQLSetprop(nhand,"Transactions",2)
			
				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						

			ssql="select MAX(cln) as max_id from inv_view"
			If SQLExec(nhand,ssql,"cln_id_tmp")<0
				Aerror(err)
				SQLSetprop(nhand,"Transactions",1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1

			Endif
			_cln= NVL(cln_id_tmp.max_id,0)+1
			Select cln_id_tmp
			Use

			_clnTime=Datetime()
			_cln_no=getmessage("_cln_no")+":"+Alltrim(Str(_cln))


			Select cun_tmp
			Scan
				_id=cun_tmp.Id
				ssql="select ISNULL(MAX(updateno),0) as max_updateno from inv_view"					&&¨ú±o³Ì¤jªºupdateno
				If SQLExec(nhand,ssql,"update_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					RETURN -1

				Endif
				_updateno=update_tmp.max_updateno+1
				Use In update_tmp


				ssql="update inv set cln=?_cln,clntime=?_clntime,updateno=?_updateno where id=?_id"		&&°O¿ý¬°²M¾÷¤Î®É¶¡
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif

			ENDSCAN
			
			
			** ¬Á¼þ½¦¡A¦pªG¨S¦³¼g¤J²M¾÷ID¡A¼u¿ù»~ªð¦^
		
			IF SQLEXEC(nhand,"select id from inv_view where cln = ?_cln","cr_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1			
			
			
			ENDIF
			
			IF EOF("cr_tmp")
			
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide		
					fmessagebox("²M¾÷¥¢±Ñ¡A½Ð­«¸Õ¡A©ÎÁpµ¸ºÞ²z­û")
					RETURN -1
			
			ENDIF
			
			&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
			IF VARTYPE(__deposit_once)#"U" and __deposit_once AND USED("cun_tmp23_cln") AND !Eof("cun_tmp23_cln") &&AND _chkdeposit_detail
				Select cun_tmp23_cln
				Scan
					_id=cun_tmp23_cln.Id
					ssql="select ISNULL(MAX(updateno),0) as max_updateno from deposit"					&&¨ú±o³Ì¤jªºupdateno
					If SQLExec(nhand,ssql,"update_tmp")<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						RETURN -1

					Endif
					_updateno=update_tmp.max_updateno+1
					Use In update_tmp


					ssql="update deposit set cln=?_cln,clntime=?_clntime,updateno=?_updateno where id=?_id"		&&°O¿ý¬°²M¾÷¤Î®É¶¡
					If SQLExec(nhand,ssql)<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions",1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1

					Endif

				ENDSCAN
				*¬Á¼þ½¦¡A¦pªG¨S¦³¼g¤J²M¾÷ID¡A¼u¿ù»~ªð¦^
				IF SQLEXEC(nhand,"select id from deposit where cln = ?_cln","cr_tmp")<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions",1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						Return -1			
				ENDIF
				
				IF EOF("cr_tmp")
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions",1)
						frm_wait.Hide		
						fmessagebox("²M¾÷¥¢±Ñ¡A½Ð­«¸Õ¡A©ÎÁpµ¸ºÞ²z­û")
						RETURN -1
				ENDIF
			ENDIF 
			&&
			

			Select cun_tmp1
			Scan
				_id=cun_tmp1.Id
				ssql="select ISNULL(MAX(updateno),0) as max_updateno from inv"					&&¨ú±o³Ì¤jªºupdateno
				If SQLExec(nhand,ssql,"update_tmp")<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					RETURN -1

				Endif
				_updateno=update_tmp.max_updateno+1
				Use In update_tmp


				ssql="update inv set cln=?_cln,clntime=?_clntime,updateno=?_updateno where id=?_id"		&&¨ú®øµo²¼¤]§@²M¾÷
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif

			Endscan

			Select cun_tmp3
			Scan
				_id=cun_tmp3.Id
				ssql="update order_void set cln=?_cln where id=?_id"		&&¨ú®øµæ¦¡°O¿ý²M¾÷
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif

			Endscan


			Select cun_tmp14

			Scan
				_id=cun_tmp14.Id
				ssql="update expense set cln_id=?_cln where id=?_id"		&&¶}¤ä°O¿ý²M¾÷
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif

			Endscan


			Select cun_tmp20
			Scan
				_id=cun_tmp20.Id
				ssql="update item_move set cln=?_cln where id=?_id"		&&¦L³æ«áÂà»O
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif


			Endscan


			Select cun_tmp21
			Scan
				_id=cun_tmp21.Id
				ssql="update less_cash set cln=?_cln where id=?_id"		&&¤Ö¦¬²{ª÷
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif


			Endscan


			If Vartype(__clean_reset_askno)#"U"		&& ²M¾÷«á¬O§_´_¦ì¦Û°Ê¥s¸¹
				If __clean_reset_askno

					If SQLExec(nhand,	"update sys_options set defavalue=?__auto_askno_begin -1    where type='askno' or type='askno2' ")<0					&&¼g¤J³Ì·s¥s¸¹
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions",1)
						frm_wait.Hide
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1

					Endif

				Endif

			Endif






			If Sqlcommit(nhand)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1

			Endif
			SQLSetprop(nhand,"Transactions",1)

		Endif

	ENDIF &&Lihong 2020.09.15 ¼W¥[ENDIF¨Ïµoemail¦b_do_print¤§¥~

*!*		SELECT 0
*!*		USE report\clean.frx
*!*		REPLACE expr WITH STUFF(EXPR,AT( "DEVICE=" , EXPR) , AT( "OUTPUT=" , EXPR) - AT( "DEVICE=" , EXPR) -1 , "DEVICE="),tag WITH "",tag2 WITH "" FOR objtype=1 AND objcode=53		&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m
*!*		USE

&&Lihong 2020.09.15 µoemail§ï¨ì_do_print¤§¥~
*If   GetNetStatus()=1  and ( _email  OR _do_print   ) AND ( Empty(__email1)= .f.  OR  Empty(__email2)=.f. OR Empty(__email3)=.f.  OR Empty(__email4)=.f.   OR Empty(__email5)=.f. )

If    _email  AND  ( Empty(__email1)= .f.  OR  Empty(__email2)=.f. OR Empty(__email3)=.f.  OR Empty(__email4)=.f.   OR Empty(__email5)=.f. ) AND GetNetStatus()=1   

	_mess = getmessage("_sending_mail")

	frm_wait.Show
	frm_wait.showmessage(_mess)
	Wait "" To N Timeout 0.1

*	Do Form Form\report_main Noshow

	Select cln_tmp
	Go Top


	frm_wait.showmessage("Generating pdf....")
	Wait "" To N Timeout 0.1
	
	

	
	IF VARTYPE(__clean_email_format)#"U" AND __clean_email_format="TXT"		&&2015.12.03  

		xtype = "TXT"
		xfile = "R" + Sys(2015)+ ".txt"
		report2DOC(xfile)		&& export to text file
	
	ELSE

		&&Lihong 2022.03.02 «ì´_PDF¦Ñ¤è¦¡
		IF VARTYPE(__pdfcreator)#"U" AND __pdfcreator="old"
			xtype = "PDF"
			xfile = "R" + Sys(2015) 	&&+ ".pdf"
			report2PDF("cln_tmp",xfile)
			*2018-06-08 win10 ¥Î³Ì·s pdf_creator ¤£¥i¥H«ü©w file name, ­n§Y®É§ä³Ì·s pdf
			*		xfile = STRTRAN( xfile , ".pdf" , "") + ".pdf"
			=Adir(chris,"*.pdf")

			Create Cursor dbflist (Name c(100), size i(4) , date d(8), time c(5))
			Sele dbflist
			Append From Array chris
			Sele dbflist
			Index On DTOS(date) + time DESCENDING Tag Name
			GO top

			xfile = Sys(5) + Sys(2003) + "\" + ALLTRIM(dbflist.name)

			USE IN dbflist

		ELSE 

			export_to_pdf_creator("cln_tmp",tmpfrx)
			xfile = "R" + Sys(2015) + ".pdf"

			_pdffile = Sys(5)+Sys(2003)+"\pdf_export.pdf"
			COPY FILE (_pdffile) TO (xfile)
			
		ENDIF 
	
	ENDIF
	
	
*!*		xfile=xfile+".html"
*!*		
*!*		report2html(xfile)
	
*	SET STEP ON 

***************



	*2022-09-07 by sam email ="«O¶®³q¹D"
	IF VARTYPE(__email_send_mode)#"U" AND __email_send_mode == "_proan_smtp"

		IF nemailhand = -1
			nemailhand = connect_sql_by(1) &&connect_sql(.f., "link_email_srv.dat")

			If nemailhand <= 0				
				nemailhand = -1
				*frm_wait.hide
				*fmessagebox("_sqlserver_error") / MESSAGEBOX("Fail to Connect  Server")
				write_log(188, "connect to email(nemailhand) server error")
			ENDIF
		ENDIF
		
		IF nemailhand > 0
			_efile = STRCONV(FILETOSTR(xfile), 13)
			_xfilename = JUSTFNAME(xfile)
			
			_subject = "Dayend Report " + getmessage("_daterange") + " : " + Dtoc(sdate) + " - " + Dtoc(edate)
			_emailfrom = Allt(__email_co)
			_emailto = ""
			If !Empty(__email1)
				_emailto	= Allt(__email1)
			Endif
			If !Empty(__email2)
				_emailto = _emailto + ";" + Allt(__email2)
			Endif
			If !Empty(__email3)
				_emailto = _emailto + ";" + Allt(__email3)
			Endif
			If !Empty(__email4)
				_emailto = _emailto + ";" + Allt(__email4)
			Endif
			If !Empty(__email5)
				_emailto = _emailto + ";" + Allt(__email5)
			ENDIF
			
			
			TEXT TO cmd NOSHOW TEXTMERGE 

				DECLARE @id int
				SET @id = (select ISNULL(MAX(id+1),1) from email_alert)
							
				insert into email_alert 
					(id, start32_code, create_date, email_from, email_to, caption, message, filename1, file1) 
				values
					(@id, ?__start32_code, getdate(), ?_emailfrom, ?_emailto, ?_subject, ?_subject, ?_xfilename, ?_efile )
			ENDTEXT


			IF SQLEXEC(nemailhand, cmd) < 0
				AERROR(aa)
				_mess = "*** sendmail fail : " + ALLTRIM( aa[1,2] ) + "   " + ALLTRIM( aa[1,3] ) 
				write_log(188,  "insert data to srv200 fail!  " + _mess)
				*Aerror(err)
				frm_wait.Hide
				*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				
			ENDIF 	

			TRY
				ERASE (xfile)
			CATCH
			FINALLY
			ENDTRY

		ENDIF 
		

		
		
	ELSE  && ¤£¨««O¶®³q¹D

		Do Case

			Case  __email_method = "vfpwinsock"

				o = Createobject("VFP_Winsock_Send_Mail")
				o.SMTP_HOST 	= Allt(__email_smtp)
				o.From 			= Allt(__email_co) + " @"		&& ¤@©w­A¦³ '@' ¤~·| send ¥X¥h!!

				o.subject 		= "Dayend Report " + getmessage("_daterange") + " : " + Dtoc(sdate) + " - " + Dtoc(edate)
				o.attachment 	= (xfile)

				o.To 			= ""
				If !Empty(__email1)
					o.To	= Allt(__email1)
				Endif
				If !Empty(__email2)
					o.To	= o.To + ", " + Allt(__email2)
				Endif
				If !Empty(__email3)
					o.To	= o.To + ", " + Allt(__email3)
				Endif
				If !Empty(__email4)
					o.To	= o.To + ", " + Allt(__email4)
				Endif
				If !Empty(__email5)
					o.To 	= o.To + ", " + Allt(__email5)
				Endif

				If Not o.Send()
					fmessagebox("_email_failed")
				Else
					fmessagebox("_email_ok")
				Endif

				o = Null


			Case  __email_method = "send_email"   && OR (  VARTYPE(__clean_email_format)#"U" AND __clean_email_format="TXT" )

	*chris

				If !File("send_email.dll")
					frm_wait.Hide

					fmessagebox("send_email.dll not found !!")

					Return -1
				Endif

	*SET STEP ON &&
				gc_repoline1 =getmessage("_dayend_report")
				
				send_email(xfile ,  (  VARTYPE(__clean_email_format)#"U" AND __clean_email_format="TXT" ) )

			Otherwise



				If File("re_mail.dll")
				
				
					
					IF LOWER(JUSTEXT(xfile))#"html"  AND  LOWER(JUSTEXT(xfile))#"txt"
					
						IF LOWER(RIGHT(xfile,3))#"pdf"
						
							xfile=xfile+".pdf"
						ENDIF
						
					ENDIF
					
				
					Declare Integer "License" In re_mail.Dll Integer @lpassword

					m.q_passdate=Dtos(Date())
					m.q_password=1943
					m.q_nn=1

					a = 1		&& ¸Õ¹L©óÄ_Â×¦æ¥H¤Uªº loop ¤£¯à exit, ¥[¦h­ÓÀË¬d³Ì¦h¸Õ 1000 ¦¸
					Do While m.q_nn<=Len(m.q_passdate)
						m.q_password=m.q_password+Val(Subs(m.q_passdate,m.q_nn,1))
						m.q_nn=m.q_nn+1

						a=a+1
						If a > 1000
							m.q_nn = -1
							Exit
						Endif
					Enddo
					=license(@m.q_password)

					If m.q_nn <> -1
						Declare Integer "RESendMail" In re_mail.Dll ;
							STRING smtphost,;
							STRING emailfrom,;
							STRING emailto,;
							STRING subject,;
							STRING msg,;
							STRING attachments,;
							INTEGER hdisplay,;
							INTEGER cdisconnect

						smtpServer	= Allt(__email_smtp)
						emailfrom	= Allt(__company_name)
						subject		= "Report"
						lmessage	= ""
						
					
	*xmess + chr(10) + chr(10) + xmess1 + chr(10) + xmess2 + chr(10) + xmess3 + chr(10) + xmess4 + chr(10) + xmess5

						IF LOWER(JUSTEXT(xfile))="txt"
							lmessage=FILETOSTR(xfile)
							xfile=""
						
						ENDIF
						

						emailto = ""
						If !Empty(__email1)
							emailto	= Allt(__email1)
						Endif
						If !Empty(__email2)
							emailto = emailto + ";" + Allt(__email2)
						Endif
						If !Empty(__email3)
							emailto = emailto + ";" + Allt(__email3)
						Endif
						If !Empty(__email4)
							emailto = emailto + ";" + Allt(__email4)
						Endif
						If !Empty(__email5)
							emailto = emailto + ";" + Allt(__email5)
						Endif

						lcode = RESendMail(smtpServer, emailfrom, emailto, subject, lmessage, xfile, 0, 0)

						If lcode != 0
							fmessagebox("_email_failed")
						Else
							fmessagebox("_email_ok")
						Endif

						Clear Dlls re_mail

					Endif

				Endif

		ENDCASE
	
	ENDIF && «O¶®³q¹D



	frm_wait.Hide
	
	*SET STEP ON 
	
ENDIF
&& _email


	IF _do_print &&Lihong 2020.09.15 IF _do_print¤À¦¨2¦¸¡A¨Ïµoemail¦b_do_print¤§¥~
		write_log(105,"Do_print_start:"+TTOC(DATETIME())+",login_user_id="+TRANSFORM(__login_user_id) )
		frm_wait.Hide

		&&Lihong 2023.07.18
		_cfilename=Sys(2015)+ALLTRIM(TRANSFORM(INT(RAND()*10000000)))
		_frx_file=_cfilename+".frx"
		_frt_file=_cfilename+".frt"		
		_tmpfrxname = tmpfrx
		IF AT(".FRX",UPPER(_tmpfrxname)) > 0
			_tmpfrxname = SUBSTR(_tmpfrxname,1,LEN(ALLTRIM(_tmpfrxname))-4)
		ENDIF
		Copy File  (_tmpfrxname+".frx") To &_frx_file		&&´_¨î³øªí(
		Copy File  (_tmpfrxname+".frt") To &_frt_file
		USE IN SELECT("frx")
		Select 0
		Use &_frx_file Exclusive Alias frx
		Replace Expr With "" ,Tag With "",tag2 With "" For objtype=1 And objcode=53		&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m
		Use In frx
		
		Select cln_tmp
		Go Top
		_error=1
		
		lcError=""
		
		Try
*!*				IF LOWER(__special_customer)=="ms" AND (VARTYPE(_MS_reprint_report)="U" OR _MS_reprint_report=.F.)  &&AND _dayEnd_report=.F. &&Lihong 2022.02.25  &&and¤£¬Ofrom ³øªí¥\¯à
*!*					lcprinter_name = GETPRINTER()
*!*					IF !EMPTY(lcprinter_name)
*!*						SET PRINTER TO NAME &lcprinter_name
*!*						SCAN
*!*							_rno = TRANSFORM(RECNO())
*!*							Report Form  (tmpfrx ) RECORD &_rno TO PRINTER NOCONSOLE &&³øªí¤£­n«O¦s¥´¦L¾÷
*!*						ENDSCAN
*!*					ELSE
*!*						RETURN -1
*!*					ENDIF  
*!*				ELSE 
				&&Lihong 2022.06.27 _ask,_pay,_inv, ¼u¥X¥´¦L¾÷¦Cªí,¸ò¥I´Ú²M³æ¥´¦L¾÷(¥»¾÷),¸òµo²¼¥´¦L¾÷(¥»¾÷),
				DO CASE &&¥[¤W«h¥u²M¾÷¤~³o¼Ë _dayend_report=.F. AND 
				CASE VARTYPE(__clean_print_ask)#"U" AND LOWER(__clean_print_ask)=="_pay" AND VARTYPE(__sys_pay_printer)#"U" AND !EMPTY(__sys_pay_printer) AND VARTYPE(__pay_print_to_local)#"U" AND __pay_print_to_local ;
						AND VARTYPE(_dayend_main_print_to)="U" 
					SET PRINTER TO NAME (__sys_pay_printer)
					Report Form  (_frx_file) TO PRINTER Nodialog NOCONSOLE
				CASE VARTYPE(__clean_print_ask)#"U" AND LOWER(__clean_print_ask)=="_inv" AND VARTYPE(__sys_inv_printer)#"U" AND !EMPTY(__sys_inv_printer) AND VARTYPE(__inv_print_to_local)#"U" AND __inv_print_to_local ;
						AND VARTYPE(_dayend_main_print_to)="U" 
					Set Printer TO NAME (__sys_inv_printer)
					Report Form  (_frx_file) TO PRINTER Nodialog NOCONSOLE
				OTHERWISE 
					Report Form  (_frx_file) To Printer  Prompt  Noconsole
				ENDCASE 
*!*				ENDIF 

		Catch To oError
		

			_error=-1
			lcError=oError.message

		ENDTRY
		
		IF !EMPTY(lcError)
		
			messagebox(lcError,48,"",5000)
			write_log(105,"Do_print_err:"+TTOC(DATETIME())+",login_user_id="+TRANSFORM(__login_user_id) + ",errmsg:"+lcError )			
			RETURN -1
		
		ENDIF
		write_log(105,"Do_print_end:"+TTOC(DATETIME())+",login_user_id="+TRANSFORM(__login_user_id) )			

&& Send SMS after clean

		If Vartype(__send_sms_after_clean)#"U" And __send_sms_after_clean And _clean_reprint= .F. AND _dayEnd_report=.F.

			If Vartype(__clean_sms_tel_no)#"U" And !Empty(__clean_sms_tel_no)


				If SQLExec(nhand,"select SUM(invamt) as cln_amt  from inv where cln=?_cln","sms_tmp")<0

					Aerror(err)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1


				Endif



				_cln_amt=Alltrim(Str(sms_tmp.cln_amt,12,2))

				Use In sms_tmp

				_belongdate=getbelongdate()

				If SQLExec(nhand,"select SUM(invamt) as today_amt  from inv where belongdate=?_belongdate","sms_tmp")<0

					Aerror(err)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1

				Endif

				_today_amt=Alltrim(Str(sms_tmp.today_amt,12,2))

				Use In sms_tmp

				If 	Alines(tel,__clean_sms_tel_no,4,",")>0

					Local i

					_mess=__company_name+" "+Dtoc(Date())+" "+Left(Time(),5)+Chr(13)+;
						_login_user_name+" ¥»¦¸²M¾÷ "+_cln_amt+Chr(13)+"( clearing "+_cln_amt +")"

*						"¤µ¤éÁ`ª÷ÃB "+_today_amt +" ( today total "+_today_amt +" )"

*						_mess_cn=__company_name+" "+DTOC(DATE())+" "+LEFT(TIME(),5)+CHR(13)+;
_login_user_name+" ¥»¦¸²M¾÷ "+_cln_amt+CHR(13)+;
"¤µ¤éÁ`ª÷ÃB "+_today_amt

*						_mess_en=__company_name+" "+DTOC(DATE())+" "+TIME()+CHR(13)+;
_login_user_name+" clearing  "+_cln_amt+CHR(13)+;
"today total "+_today_amt


					For i=1 To Alen(tel)

						If send_sms( __gsm_modem_port , _mess, tel(i) )>0

							write_log(105,"Send SMS success!")

						Else

							write_log(105,"Send SMS fail!")

						Endif

*							 send_sms( __gsm_modem_port , _mess_en, tel(i) )


*							 MESSAGEBOX(send_sms( __gsm_modem_port , _mess, tel(i) ))


					Endfor

				Endif

			Endif

		Endif

		Return _error


	ELSE &&_do_print 


		frm_wait.Hide



		If  ( Vartype(__special_customer)#"U" And "redant"$__special_customer ) Or __debug_mode


			Do Form Form\report_preview With (tmpfrx ) ,"cln_tmp"


		Else

			Select cln_tmp
			Go Top

			Delete File __clean.*

			Set Library To xfrxlib.fll
			Local loxfrx
			loxfrx = XFRX("XFRX#LISTENER")
			loxfrx.DoNotOpenViewer=.T.  &&¤£Åã¥Ü¹wÄý
			loxfrx.targetType = "XFF"



			_error=.F.
			lcError=""

			loxfrx.targetFileName = "__clean.xff"
			lnRetval = loxfrx.setparams()
			If lnRetval = 0
				
			
				Try
					Report Form  (tmpfrx )   Object loxfrx Nodialog					&&¥Í¦¨ xff ¤å¥ó

				Catch To oError

					_error=.T.
					lcError=oError.message
					
				Endtry
				

				loxfrx=Null

			Endif


			If _error=.F. And File("__clean.xff")

				Do Form Form\report_preview_new With "__clean.xff"
			
			ELSE
			
				fmessagebox(lcError)

			Endif


		Endif


	ENDIF &&_do_print

*Endif  && if email

IF  LOWER(__special_customer)="taiwohou" 

	*	SET STEP ON 

	ssql="select id,desccn,descen from item"

	IF SQLEXEC(nhand,ssql,"cun_tmp12")<0
	
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))


		Return -1	
	
	ENDIF
	
						
	*			ssql=ssql+Chr(10)+"select a.id,a.uid,a.parent_id,a.item_id,a.qty,a.orgamt,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.xdisc,a.tax2,a.tax_amount,a.askdept,a.item_code,a.cate_id,b.desccn,b.descen  "+;
					"from  inv_detail a  left join cate b on a.cate_id=b.id where a.id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"		&&cun_tm8 ----inv_detail	
	
		IF _system_langue="CN"
			
			SELECT b.desccn as item_name,a.desccn as cate,SUM(qty) as qty,SUM( real_amount+xdisc+round_amount) as amt FROM cun_tmp8 a LEFT JOIN cun_tmp12 b ON a.item_id =b.id ;
			GROUP BY b.desccn,a.desccn ORDER BY a.desccn,b.desccn INTO CURSOR cln_tmp88 READWRITE 
			
		
		ELSE
		
			SELECT b.descen as item_name,a.descen as cate,SUM(qty) as qty,SUM( real_amount+xdisc+round_amount) as amt FROM cun_tmp8 a LEFT JOIN cun_tmp12 b ON a.item_id =b.id ;
			GROUP BY b.descen,a.descen ORDER BY a.descen,b.descen INTO CURSOR cln_tmp88 READWRITE 
					
		ENDIF
		
			
		
		IF __debug_mode
		
		
		
			REPORT FORM report\clean_cate_item  TO PRINTER NOCONSOLE NODIALOG   PREVIEW 

		
		ELSE 
		
		
			REPORT FORM report\clean_cate_item TO PRINTER NOCONSOLE NODIALOG 
		
		ENDIF
		
	*	USE IN cln_tmp88 

ENDIF




frm_wait.Hide

If __debug_mode

	Return 1

Endif



For i=1 To 20
	_curs="cln_tmp"+Alltrim(Str(i))

	If Used("&_curs")
		Select &_curs
		Use

	Endif

	_curs="cln_tmp"+Alltrim(Str(i))

	If Used("&_curs")
		Select &_curs
		Use

	Endif


Endfor


TRY
	ERASE (_pdffile)
	ERASE (xfile)
CATCH
FINALLY
ENDTRY


Return 1

Endfunc



******************************
Function msg_print
Lparameters Cmsg,_printer,_curorder,_tableno

If Empty(_printer)
	Return 0
Endif


*Dimension sp(1)			&&¤À¸Ñ¥´¦L¾÷
*getmstring(_printer,@sp)

If Alines(sp,_printer,4,",")=0
	Return 0

Endif

&&Lihong 2022.07.20 ÂIµæ¯¸ÂI¡A°l³æÂIµæ®É¶¡
_order_station=""
_remin_order_time=""
IF !EMPTY(FIELD("add_user_station_id", "order_itemlist_tmp")) AND NVL(order_itemlist_tmp.add_user_station_id,0)>0 AND USED("work_order_tmp_station") &&LOWER(_dataname)=="order_itemlist_tmp" AND 
	SELECT work_order_tmp_station
	LOCATE FOR id=order_itemlist_tmp.add_user_station_id
	_order_station = IIF(_system_langue="CN",work_order_tmp_station.desccn, work_order_tmp_station.descen)
ELSE 
	IF !EMPTY(FIELD("adduser", "order_itemlist_tmp")) AND LOWER(ALLTRIM(NVL(order_itemlist_tmp.adduser, "")))=="web"
		_order_station="web"
	ENDIF 
ENDIF 
*!*	IF _remin=.T. AND !EMPTY(FIELD("ordertime", "order_itemlist_tmp"))
*!*		_remin_order_time=TRANSFORM(order_itemlist_tmp.ordertime)
*!*	ENDIF 


For k=1 To Alen(sp)		&&¦V¨C¤@»O«ü©w¥´¦L¾÷µo°e¤@­Ó§@·~
	_cprinter=sp(k)
	_Pid="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"KIT"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î
	_place=""

	ssql="if not exists (select pid from order_print_main where pid=?_pid) "+;
		"insert into order_print_main (pid,order_id,place,username,tableno,printed,printer,def_printer,act_printer,sendtime,printtime,npage,pages,void_order,void_reason,langue,training,order_station,remin_order_time)"+;
		" values (?_pid,?_curorder,?_place,?_login_user_name,?_tableno,0,?_Cprinter,?_Cprinter,'',getdate(),'',1,1,0,'',?_system_langue,?GL_training, ?_order_station, '')"

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))


		Return -1
	Endif


	_spec=Cmsg
	_item=""
	_qty=0
	csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void) values (?_pid,?_qty,?_spec,?_item,?_dispord,1,0)"		&&update by david 2010.04.28
	If SQLExec(nhand,csql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif

Endfor


Return 1

Endfunc

***************
Function order_slip_print
* ²M³æ¥´¦L
Lparameters _order_id,_print_all,_voiditem,_print_barcode

Local _printer1,_printer2,_printer3
Local _Fprinter1,_Fprinter2,_Fprinter3		&&§ÖÀ\¼Ò¦¡¦¡¥´¦L¾÷

_Fprinter1=""
_Fprinter2=""
_Fprinter3=""


_printer1=Allt(__slip_printer1)			&&²M³æ¥´¦L¾÷1		³Ì¦h¤ä«ù3­Ó²M³æ¥´¦L¾÷,¥i¦P²z¤ä«ù¨ì§ó¦h
_printer2=Allt(__slip_printer2)			&&²M³æ¥´¦L¾÷2
_printer3=Allt(__slip_printer3)			&&²M³æ¥´¦L¾÷3


If Vartype(__fastfood_slip_printer1)#"U"


	_Fprinter1=Iif(Val(__fastfood_slip_printer1)=-1,_printer1,__fastfood_slip_printer1)
	_Fprinter2=Iif(Val(__fastfood_slip_printer2)=-1,_printer2,__fastfood_slip_printer2)
	_Fprinter3=Iif(Val(__fastfood_slip_printer3)=-1,_printer3,__fastfood_slip_printer3)


Endif

IF VARTYPE(__pso_print_slip)#"U"		&& 2019.11.05 &&Lihong 2020.07.06 VARTYPE(__pso_slip_print_id )#"U" §ï¬° __pso_print_slip
	_printer1= __pso_slip_print_id 
	_printer2= __pso_slip_print_id2 &&Lihong 2020.07.06
	_printer3= __pso_slip_print_id3 &&Lihong 2020.07.06

	_Fprinter1= __pso_slip_print_id &&Lihong 2020.04.10 outlet¥´¦L¾÷É¬¥ý
	_Fprinter2= __pso_slip_print_id2
	_Fprinter3= __pso_slip_print_id3
ENDIF

&&Lihong 2020.07.13 
IF VARTYPE(__android_print_slip_outlet)#"U" AND __android_print_slip_outlet &&Lihong 2020.11.13µùÄÀ±¼ÂX¤j¨ìPC  AND VARTYPE(_android_call_save_order)#"U" 
	IF SQLEXEC(nhand,"select * from outlet where id=?_outlet_id","cun_tmp")<0
		RETURN -1
	ENDIF
	IF FIELD("so_print_slip")<>"" AND FIELD("so_printerset_id")<>"" 
		IF NVL(cun_tmp.so_print_slip,.f.)= .F.
			RETURN 1 
		ENDIF 
		_outlet_slip_print_id = ""
		_outlet_slip_print_id2 = ""
		_outlet_slip_print_id3 = ""
		IF NVL(cun_tmp.so_printerset_id,0)>0
			_outlet_slip_print_id = ALLTRIM(STR(cun_tmp.so_printerset_id))		&& printer id 
		ENDIF
		IF NVL(cun_tmp.so_printerset_id2,0)>0
			_outlet_slip_print_id2 = ALLTRIM(STR(cun_tmp.so_printerset_id2))		&& printer id 
		ENDIF
		IF NVL(cun_tmp.so_printerset_id3,0)>0
			_outlet_slip_print_id3 = ALLTRIM(STR(cun_tmp.so_printerset_id3))		&& printer id 
		ENDIF
		IF !(NVL(cun_tmp.so_printerset_id,0)>0 OR NVL(cun_tmp.so_printerset_id2,0)>0 OR NVL(cun_tmp.so_printerset_id3,0)>0)
			RETURN 1
		ENDIF 
		_printer1= _outlet_slip_print_id
		_printer2= _outlet_slip_print_id2
		_printer3= _outlet_slip_print_id3

		_Fprinter1= _outlet_slip_print_id
		_Fprinter2= _outlet_slip_print_id2
		_Fprinter3= _outlet_slip_print_id3
	ENDIF
ENDIF 

&&Lihong 2023-03-23 fastfood preorder
IF VARTYPE(llfastfood_order_do_pre)#"U" AND VARTYPE(__pre_slip_print_method)#"U" AND LOWER(__pre_slip_print_method)=="pre_slip_printer"
	_Fprinter1=Allt(__pre_slip_printer1)			&&¹wÂI³æ¥´¦L¾÷1
	_Fprinter2=Allt(__pre_slip_printer2) 
	_Fprinter3=Allt(__pre_slip_printer3) 
ENDIF 

If _run_mode="fastfood"  Or ( Vartype(_outlet_id)#"U" And _outlet_id=0)		&& 2011.04.14   ¼W¥[§ÖÀ\¼Ò¦¡¥´¦L¾÷  update 2012.05.08 °ó®y¥~½æ»O
	&&Lihong 2022-09-26 fastfood preorder
*!*		IF VARTYPE(llfastfood_order_do_pre)#"U" 
*!*			LOCAL _Fprinter_pre,  lnprint_pre, lnii
*!*			_Fprinter_pre=""
*!*			IF Val(_Fprinter1)>0
*!*				_Fprinter_pre = _Fprinter1
*!*			ELSE
*!*				IF Val(_Fprinter2)>0
*!*					_Fprinter_pre = _Fprinter2
*!*				ELSE
*!*					_Fprinter_pre = _Fprinter3
*!*				ENDIF 
*!*			ENDIF 

*!*			If Val(_Fprinter_pre)>0
*!*				Select work_order_tmp12
*!*				Locate For Id=Val(_Fprinter_pre)
*!*				_printer=Trim(Printer)
*!*				
*!*				lnprint_pre = 2
*!*				IF VARTYPE(__fastfood_order_pre_slip_copys)="N" AND __fastfood_order_pre_slip_copys>=0 AND __fastfood_order_pre_slip_copys<100
*!*					lnprint_pre = __fastfood_order_pre_slip_copys
*!*				ENDIF 
*!*				
*!*				IF lnprint_pre>0
*!*					FOR lnii=1 TO lnprint_pre 
*!*						If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L
*!*							Return -1
*!*						ENDIF
*!*					ENDFOR 
*!*				ENDIF 
*!*			Endif

*!*		ELSE 

		If Val(_Fprinter1)>0
			Select work_order_tmp12
			Locate For Id=Val(_Fprinter1)
			_printer=Trim(Printer)

			If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L

				Return -1
			Endif

		Endif

		If Val(_Fprinter2)>0
			Select work_order_tmp12
			Locate For Id=Val(_Fprinter2)
			_printer=Trim(Printer)

			If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L

				Return -1
			Endif

		Endif


		If Val(_Fprinter3)>0
			Select work_order_tmp12
			Locate For Id=Val(_Fprinter3)
			_printer=Trim(Printer)

			If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L

				Return -1
			Endif

		Endif

*!*		ENDIF 
	
Else		&&°ó®y


	If Val(_printer1)>0

		Select work_order_tmp12
		Locate For Id=Val(_printer1)
		_printer=Trim(Printer)


		If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L
			Return -1
		Endif

	Endif

	If Val(_printer2)>0

		Select work_order_tmp12
		Locate For Id=Val(_printer2)
		_printer=Trim(Printer)

		If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L

			Return -1
		Endif

	Endif

	If Val(_printer3)>0

		Select work_order_tmp12
		Locate For Id=Val(_printer3)
		_printer=Trim(Printer)

		If slip_Print(_order_id,_printer,_print_all,_voiditem,_print_barcode)=-1		&&¿é¥X¥´¦L

			Return -1
		Endif

	Endif


Endif



Return 1
Endfunc


*******************************************************
*	function save_order
* «O¦s¸¨³æ
***************
Function save_order

Lparameters _tableno,_onlysave,_inv_mode,_curorder,_pplcnt,_run_mode,_isfastfood,_FastFood_info,_member_no,_mincharge_mode,_tel,_addr,_end_time,_sit_time,_no_print_slip,_must_print_slip		&&_onlysave¥u«O¦s¼Æ¾Ú,¤£§@¥´¦L,¥Î©ó¸É³æ,_Inv_mode ¬O¥´¦Lµo²¼¼Ò¦¡
&&_check_timer ¬O§_­pÄÁ
If Vartype(_member_no)#"N"

	_member_no=0

Endif

If Vartype(_mincharge_mode)#"N" 		&&³Ì§C®ø¶O¼Ò¦¡
	_mincharge_mode=0
Endif

If Vartype(_tel)#"C"
	_tel=""

Endif

If Vartype(_addr)#"C"
	_addr=""

Endif

If Vartype(_outlet_id)#"N"
	_outlet_id=1		&&¹w³]¬°°ó®y
Endif

If Vartype(_curorder)="C"
	_curorder=Val(_curorder)
Endif

_price_period_id = 0 
IF VARTYPE(lnorder_price_period_id)="N"
	_price_period_id = lnorder_price_period_id
ENDIF 

&&Lihong 2022.11.18 ­qª÷
_deposit_id = 0
IF VARTYPE(lnorder_deposit_id)="N"
	_deposit_id = lnorder_deposit_id 
ENDIF 
&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
_inv_srv_type = 0
_inv_srv_perc = 0
IF VARTYPE(lnorder_inv_srv_type)="N"
	_inv_srv_type = lnorder_inv_srv_type 
	_inv_srv_perc = lnorder_inv_srv_perc 
ELSE
	IF VARTYPE(_vs_all_style_save_order)#"U"
		*avs
	ENDIF 
ENDIF 

Local  _belongdate
_belongdate=getbelongdate()

If !Used("work_order_tmp")

	ssql="select * from item with(readpast) where active=1 order by id"		&&­«·s¸ü¤J¼Æ¾Ú
	If SQLExec(nhand,ssql,"work_order_tmp")<0
		Return -1
	Endif
	Select work_order_tmp
	Index On Id To item_id

Endif

&&Lihong 2022.09.27
If !Used("work_order_tmp0")
	ssql="select * from item with(readpast) where active=0 order by id"		&&­«·s¸ü¤J¼Æ¾Ú
	If SQLExec(nhand,ssql,"work_order_tmp0")<0
		Return -1
	Endif
Endif

Local _askno

_askno=Iif(_isfastfood,_tableno,"")
If Vartype(_order_fastfood_askno)#"U"		&&fix   2009.01.13

	_askno=_order_fastfood_askno
Endif

&&Lihong 2020.05.14 android§ÖÀ\¥Ñvs½Õ¥ÎªÌ²£¥Íaskno¡]¨ú­È¦bavs¨½¡^
If Vartype(_fast_food_save_askno)#"U" AND !EMPTY(_fast_food_save_askno)
	_askno=_fast_food_save_askno
Endif

&&Lihong 2022-09-16 fastfood hold
IF VARTYPE(_fastfood_hold_askno)="C" AND !EMPTY(_fastfood_hold_askno) &&AND EMPTY(_askno)
	_askno = _fastfood_hold_askno
ENDIF 

Local _void_id,_old_inv_id,ll_nochange ,_timer_free_hours


_void_id=0
_auto_sn =0

If _curorder>0 	

	IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split)	&& ÀË¬d¬O§_¦³·|­ûself service   &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	
		IF crm_check_self_service(_tableno, _curorder  , .t.)<0
		
			RETURN  -1
		
		ENDIF
				
	
	ENDIF
	

&&¦pªG¬O­«·s«O¦s¸¨³æ¡A­«·sÀË´ú­pÄÁ
	If SQLExec(nhand,"select begintime,void_id,inv_id,sn, price_period_id,deposit_id,inv_srv_type,inv_srv_perc from order_main where id=?_curorder","cun_tmp")<0

		Return -1
	Endif
	_void_id=cun_tmp.void_id
	_old_inv_id=cun_tmp.inv_Id
	_auto_sn = NVL(cun_tmp.sn,0)
	&&Lihong 2022-09-16 fastfood hold
	IF VARTYPE(_fastfood_hold_auto_sn)="N" AND _fastfood_hold_auto_sn>0
		_auto_sn = _fastfood_hold_auto_sn
	ENDIF 
	*_fastfood_have_order = (RECCOUNT("cun_tmp")>0)
	
	If Vartype(_sit_time)#"T"

		_sit_time=cun_tmp.begintime				&&¤J®y®É¶¡

	Endif

	_timer_begtime=_sit_time
	
	IF VARTYPE(lnorder_price_period_id)<>"N"
		_price_period_id = Nvl(cun_tmp.price_period_id, 0)
	ENDIF 
	
	&&Lihong 2022.11.18 ­qª÷
	IF VARTYPE(lnorder_deposit_id)<>"N"
		_deposit_id = Nvl(cun_tmp.deposit_id, 0)
	ENDIF 	
	&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
	IF VARTYPE(lnorder_inv_srv_type)<>"N"
		_inv_srv_type = Nvl(cun_tmp.inv_srv_type, 0)
		_inv_srv_perc = Nvl(cun_tmp.inv_srv_perc, 0)
	ENDIF 
	
	Select uid From order_itemlist_tmp Where timer_active  Into Cursor cun_tmp 	&&¬O§_¦³­p®Éªº¶µ¥Ø
	If _Tally>0

		Select ordertime From order_itemlist_tmp Where 	timer_active And timer_trigger Into Cursor  cun_tmp Order By ordertime
		If _Tally>0

			_timer_begtime=cun_tmp.ordertime

		Endif
		
		IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) 
		ELSE 
			If Vartype(_end_time)="T"
				timer_check(_timer_begtime,_end_time)		&&­pÄÁÀË´ú(«ü©w§¹µ²®É¶¡)
			Else
				timer_check(_timer_begtime,Datetime())		&&­pÄÁÀË´ú(­pºâ¨ì²{¦b)

			Endif
		ENDIF 

	Endif

Else

	If Vartype(_sit_time)#"T"
		_end_time=Datetime()

	Endif
	_old_inv_id=0
	
	_timer_begtime=_sit_time	


	Select uid From order_itemlist_tmp Where timer_active  Into Cursor cun_tmp 	&&¬O§_¦³­p®Éªº¶µ¥Ø
	If _Tally>0


		Select ordertime From order_itemlist_tmp Where 	timer_active And timer_trigger Into Cursor  cun_tmp Order By ordertime
		If _Tally>0

			_timer_begtime=cun_tmp.ordertime

			
		ENDIF
		
	ENDIF
	
	&&Lihong 2022-09-16 fastfood hold
	IF VARTYPE(_fastfood_hold_auto_sn)="N" AND _fastfood_hold_auto_sn>0
		_auto_sn = _fastfood_hold_auto_sn
	ENDIF 
	
Endif

IF VARTYPE(__pso_order_save_inv)="U" AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) 
	level_rule_check() 			&&­«·s­pºâ¯Å§O³W«h

ENDIF

&&Lihong 20201.02.01 ¤À¯Å­p®É»ù ©ñ²Õ¦X®MÀ\¤§«á checked_timer_level_price:avs¡]¦Û¤v¶}Ãö¡^ ¤À³æ
*IF thisform.table_status="P"	  AND  _order_change=.f. 
*ELSE 
llcheck_user_disc = .F.
IF VARTYPE(__timer_item)#"U" and __timer_item AND VARTYPE(checked_timer_level_price)="U" AND Upper(_run_mode)="DINE" AND !_isfastfood And Vartype(_inv_chnage_mode)="U" AND VARTYPE(_directly_order_discount)="U" 
	If _curorder>0
		If SQLExec(nhand,"select status, begindate,outlet_id from tables with (nolock)  where tableno=?_tableno and nsubtable=0","cun_tmp")<0
			Return -1
		ENDIF
	ENDIF 
	IF _curorder<=0 OR ALLTRIM(cun_tmp.status) <> "P"
		If Vartype(_sit_time)#"T"
			&&¦pªG¬O­«·s«O¦s¸¨³æ¡A­«·sÀË´ú­pÄÁ
			If SQLExec(nhand,"select begintime from order_main where id=?_curorder","cun_tmp")<0
				Return -1
			Endif
			_sit_time=cun_tmp.begintime				&&¤J®y®É¶¡
		ENDIF 
		If !Vartype(_end_time)="T"
			_end_time = Datetime()
		ENDIF 
		IF !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) 
			=check_timer_level_price(_sit_time, _end_time)
			llcheck_user_disc = .T.
		ENDIF 
	ENDIF 
ENDIF 
*ENDIF 

IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) 
ELSE 
	&&Lihong 2021.04.01 ­tª÷ÃB·í¹w¥Iª÷
	IF VARTYPE(__neg_amt_as_deposit)#"U" and __neg_amt_as_deposit AND (_inv_mode OR VARTYPE(_fastfood_inv_print_deposit)#"U") AND VARTYPE(_work_order_fastfood_slip_print)="U" &&qty=1 amount = real_amount &&Lihong 2022.09.13 ÂIµæ¯È
		Select Max(uid) As max_id From order_itemlist_tmp Into Cursor cun_tmp  &&¨ú±o¤£­«´_ªºID
		If Isnull(cun_tmp.max_id)
			_uid=1
		Else
			_uid=Int(cun_tmp.max_id)+1
		ENDIF
		*¦w¨ô§ÖÀ\real_amountµL­È
		SELECT item_id, amount, SUM(qty) as qty FROM order_itemlist_tmp WHERE item_id > 0 And sitem=.F. AND amount < 0 GROUP BY item_id, amount INTO CURSOR cun_tmp 
		SELECT a.item_id, a.amount, MAX(a.qty) as qty, SUM(NVL(b.qty, 0)) as b_qty  FROM cun_tmp a LEFT JOIN order_itemlist_tmp b ON a.item_id = b.item_id AND a.amount = -b.amount ;
		WHERE b.sitem=.F. GROUP BY a.item_id, a.amount INTO CURSOR cun_tmp 
		
		DELETE a from order_itemlist_tmp a left join cun_tmp b on a.item_id = b.item_id AND a.amount = -b.amount where a.sitem=.F. AND NOT ISNULL(b.item_id) AND b.qty<>b.b_qty
		
		SELECT a.* FROM order_itemlist_tmp a LEFT JOIN order_itemlist_tmp b ON a.item_id=b.item_id AND b.item_id > 0 And b.sitem=.F. AND b.amount = -a.amount ;
		WHERE a.item_id > 0 And a.sitem=.F. AND a.amount < 0  AND ISNULL(b.item_id) ;
		INTO CURSOR cun_tmp READWRITE 
		SCAN 
			REPLACE uid WITH _uid, price WITH -price, orgamt WITH -orgamt, amount WITH -amount, real_amount WITH -real_amount
			_uid = _uid + 1
		ENDSCAN 
		IF RECCOUNT("cun_tmp") > 0
			SELECT order_itemlist_tmp 
			APPEND FROM DBF("cun_tmp")
		ENDIF 
	ENDIF 

	_totalamt  = amount_check() &&Lihong 2021.04.23 ¼W¥[¤J°Ñfor disc_log _old_inv_id¡GÁÙ­ì¤F
ENDIF 

&&Lihong 20201.02.01 ¤À¯Å­p®É»ù«áÀË¬ddisc 
IF llcheck_user_disc AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) 
&&ÀË´ú¥Î¤á§é¦©¬O§_¦³­­¨î

LOCAL _add_user


SELECT adduser DISTINCT  FROM order_disc_tmp  INTO CURSOR cun_tmp2 READWRITE 
INSERT INTO cun_tmp2 SELECT adduser FROM order_disc_tmp WHERE  adduser NOT in (select adduser FROM order_disc_tmp)
*SET STEP ON 

SELECT cun_tmp2
SCAN

	_add_user=TRIM(cun_tmp2.adduser)


	ssql="select discper_order,discamt_order from sys_user where name=?_add_user"
	IF SQLEXEC(nhand,ssql,"cun_tmp")<0
		aerror(err)
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))

		RETURN -1
		
	ENDIF
	_user_discper=cun_tmp.discper_order		&&¥Î¤á³Ì¤j§é¦©¦Ê¤À¤ñ
	_user_discamt=cun_tmp.discamt_order		&&¥Î¤á³Ì¤j§é¦©ª÷ÃB	


	LOCAL _tm,_m1,_m2,_mess

	Select order_itemlist_tmp
	Sum amount To _tm

	Select item_disc_tmp
	Sum disc_amount To _m1 For adduser=_add_user and disc_id<>-8			&&¦pªG¸g±ÂÅv¡A«hªö¥Î±ÂÅvªÌªº§é¦©­­ÃB &&Lihong 2020.06.02 coupon : and disc_id<>-8
	Select order_disc_tmp
	Sum disc_amount To _m2 For adduser=_add_user  

	&&Lihong 2021.05.11 ¼W¥[ and _tm<>0
	IF _user_discper<100 and _tm<>0
		
		
		If (_m1+_m2)/_tm*100>_user_discper		&&¶W¥X¥Î¤á¨C³æ©^°e¦Ê¤À¤ñ­­¨î
			
			_mess=getmessage("_user_disc_limit_over")+CHR(13)+getmessage("_user")+":"+_add_user+CHR(13)+getmessage("_free_amount_by_percentage")+":"+ALLTRIM(STR(_user_discper,8,2))+"%"
			
			fmessagebox(_mess)
			
			RETURN -1

		ENDIF
		
	ENDIF


	If	(_m1+_m2)>_user_discamt				&&¶W¥X¥Î¤á¨C³æ©^°eª÷ÃB­­¨î


			_mess=getmessage("_user_disc_limit_over")+CHR(13)+getmessage("_user")+":"+_add_user+CHR(13)+getmessage("_free_amount_by_order")+":"+ALLTRIM(STR(_user_discamt,12,2))
			fmessagebox(_mess)
				
			RETURN -1

	ENDIF


ENDSCAN


ENDIF 


*------------------	&&²Î­p§KÄÁªºÁ`®É¶¡ 
	
SELECT 	SUM(free_hours) as free_hours FROM order_itemlist_tmp WHERE timer_style=2 AND timer_begtime="00:00" AND timer_endtime="23:59" INTO CURSOR cun_tmp
_timer_free_hours = NVL(cun_tmp.free_hours,0) 

 LOCAL _order_timer_endtime

_order_timer_endtime=IIF(_timer_free_hours=0,CTOT("1900-01-01"),  _timer_begtime + _timer_free_hours*3600)		

*--------------------------------------

Delete From order_disc_tmp Where autodisc And disc_amount=0		&&§R°£¦Û°Ê§é¦©¤¤ª÷ÃB¬°¹sªº¶µ¥Ø


Select order_itemlist_tmp
Sum  orgamt,amount,real_amount,modi_amount,disc_amount,srv_amount,tax_amount To _orgamt,_amount,_realAmt,_modiamt,_item_discamt,_srvamt,_taxamt For item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) &&Lihong 2020.04.20 OR INLIST &&Lihong 2020.06.02 coupon -51

Select orgamt,srv_amount From order_itemlist_tmp Where item_id=-3 Into Cursor cun_tmp
Select cun_tmp
_mincharge=cun_tmp.orgamt
_mincharge_srv=cun_tmp.srv_amount 			&&³Ì§C®ø¶O/ªA°È¶O

_orgamt=_orgamt+_mincharge


Select order_itemlist_tmp
Sum amount, xdisc To _totalamt, _discamt For disc=.T.   &&Lihong And no_Ldisc=.F.		&&¥u¹ï¤¹³\§é¦©ªº¶i¦æ¾ã³æ§é¦©­pºâ fix 2013.06.19  //2019.07.26 &&Lihong 2021.01.25 ¥h±¼no_Ldisc=.F.
Sum srv_amount  To _freeSrv_amt For srv_free=.T. &&Lihong 2021.01.25 ©l²×¬°0¡A©Ò¥H_taxamt¨S´î¤]¬O¤@¼Ëªº

_srvamt= _srvamt- _freeSrv_amt 


&&Lihong 2021.03.16 µùÄÀ±¼§ï¬°¤W­±xdisc ¦Û©w§é¥i¯à¤j©ó¥i§é
*Select order_disc_tmp
*Sum disc_amount To _discamt  For disc_type<4 	&&¾ã³æ§é¦©(¤£­p§K¶O¶µ)

If _totalamt>=0 And _discamt>_totalamt		&& ¤£¯à¤j©ó¥i§é¦©ª÷ÃBggg

	_discamt=_totalamt

Endif


_sub_amt=_amount - _discamt- _item_discamt		&&¤p­p,¤£§tªA°È¶O

_totalamt=_amount  +_srvamt+_taxamt- _discamt-_item_discamt


*SET STEP ON 

If _mincharge>0

	Select order_itemlist_tmp &&Lihong 2020.04.20 OR INLIST 2020.06.02 coupon item_id= -51
	Sum amount,srv_amount,tax_amount,disc_amount,xdisc To _amount1,_srvamt1,_taxamt1,_item_discamt1,_xdiscamt1 FOR (item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) ) And mincharge=.T.
	Sum amount,srv_amount,tax_amount,disc_amount,xdisc To _amount2,_srvamt2,_taxamt2,_item_discamt2,_xdiscamt2 FOR (item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) ) And mincharge=.F.

	_sub_amt1=_amount1 - _xdiscamt1 - _item_discamt1						&&¤p­p,¤£§tªA°È¶O(­p¤J³Ì§C®ø¶Oªº¶µ¥Ø)
	_sub_amt2=_amount2 - _xdiscamt2 - _item_discamt2+_srvamt2+_taxamt2		&&¤p­p,§tªA°È¶O(¤£­p¤J³Ì§C®ø¶Oªº¶µ¥Ø)

	If	_sub_amt1<_mincharge												&&¦pªG¤£¨¬³Ì§C®ø¶O,«ö³Ì§C®ø¶O­p(¤£­p¤J³Ì§C®ø¶Oªº°£¥~)

		_totalamt=_mincharge+_mincharge_srv+_srvamt1+_taxamt1+_sub_amt2	 		&&³Ì§C®ø¶O+ªA°È¶O+¤£­p¤J³Ì§C®ø¶Oªº¶µ¥Ø

	Endif

Endif


_totalamt0=_totalamt


IF VARTYPE(_pso_inv)="U"
	_totalamt=rounding_amount(_totalamt)
ENDIF


Select order_itemlist_tmp			&&­«·s­pºâªA°È¶O¤Î¤p­p
Sum amount,srv_amount To _amount,_srvamt

_srvamt= _srvamt- _freeSrv_amt



ssql="select id from sys_user where name=?_login_user_name"
If SQLExec(nhand,ssql,"cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

Local _user_id
_user_id=cun_tmp.Id

IF VARTYPE(_work_order_fastfood_slip_print)="U" &&Lihong 2022.09.13 ÂIµæ¯È

Select  order_itemlist_tmp							
Scan
	_item_Id=item_id
	ssql="if exists(select id from item where id=?_item_id and (used=0 or used is null)) Update item set used=1 where id=?_item_id"								&&°O¿ýitem³Q¨Ï¥Î¤F
	If SQLExec(nhand,ssql)<0
		Aerror(err)

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	ssql="if exists(select id from mitem where id=?_item_id and (used=0 or used is null)) Update mitem set used=1 where id=?_item_id"
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

Endscan

ENDIF &&Lihong 2022.09.13 ÂIµæ¯È

_invamt=_totalamt					&&À³¥Iª÷ÃB

_rndamt=_totalamt- _totalamt0			&&·L½Õ

IF VARTYPE(_pso_inv)#"U" AND VARTYPE(_pso_inv_rndamt)="N"
	_rndamt = _pso_inv_rndamt
	IF VARTYPE(_pso_inv_invamt)="N"
		_invamt = _pso_inv_invamt
	ENDIF 
ENDIF

Select order_itemlist_tmp
Sum xdisc To _total_xdisc
_xvalue=_discamt- _total_xdisc			&& §é¦©­pºâ »~®t

IF VARTYPE(_inv_only_preview)="U" AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
*ELSE 
	Select Top 1 uid  From order_itemlist_tmp Order By real_amount Desc  Into Cursor cun_tmp		&&±N·L½Õ¤Î­pºâ»~®t¤À°t¨ì ¹ê¦¬ª÷ÃB ³Ì¤jªºµæ¦¡¤¤
	_uid=cun_tmp.uid
	Update order_itemlist_tmp Set round_amount=0
	*update order_itemlist_tmp Set round_amount=_rndamt,xdisc=xdisc+_xvalue Where uid=_uid
	Update order_itemlist_tmp Set round_amount=_rndamt Where uid=_uid
ENDIF 

_begintime=Iif(_isfastfood,Datetime(),_sit_time)			&&¦pªG¬O§ÖÀ\¡A¨úªA°È¾¹®É¶¡

_item_discamt=-1*_item_discamt		&&§é¦©ªö¥Î­t¼Æ
_discamt=-1*_discamt

_cost=0								&&¦¨¥»

IF VARTYPE(_work_order_fastfood_slip_print)="U" OR VARTYPE(llfastfood_order_do_hold)#"U" &&Lihong 2022.09.13 ÂIµæ¯È  &&Lihong 2022-09-16 fastfood hold

IF VARTYPE(__vs_save_order )="U" AND VARTYPE(__sitem_repl_save_order)="U" &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´« __sitem_repl_save_order 

		=SQLSetprop(nhand,"Transactions",2)


				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
			
ENDIF
						
ENDIF &&Lihong 2022.09.13 ÂIµæ¯È


Local lcType

If Vartype(_askno_ab)="C" And _askno_ab="B"

	lcType=" 'askno2' "

Else

	lcType=" 'askno' "

Endif


If _isfastfood And _run_mode<>"barcode" And Empty(_askno) AND VARTYPE(_work_order_fastfood_slip_print)="U" &&AND VARTYPE(__fastfood_dine_settle)="U"			&&¦pªG§ÖÀ\¼Ò¦¡¤U,¥s¸¹¬°ªÅ,«hªö¥Î¦Û°Ê¥s¸¹ &&Lihong 2022.09.13 ÂIµæ¯È
	ssql="SELECT defavalue FROM sys_options WHERE type="+lcType

	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	If 	Vartype(_order_fastfood_askno)#"N"

		_auto_askno=Iif(cun_tmp.defavalue>=__auto_askno_end Or cun_tmp.defavalue<__auto_askno_begin,__auto_askno_begin,cun_tmp.defavalue+1)			&&¨ú¦Û°Ê¥s¸¹(¨Ã¦Û°Ê´`Àô)

	Else
		_auto_askno=_order_fastfood_askno		&&¦pªGµ²±b¨ú®øªð¦^,¨ú­ì¥s¸¹

	Endif
	_auto_askno=Int(_auto_askno)

*	_auto_askno=IIF(cun_tmp.defavalue>=__auto_askno_end or cun_tmp.defavalue<__auto_askno_begin,__auto_askno_begin,cun_tmp.defavalue+1)			&&¨ú¦Û°Ê¥s¸¹(¨Ã¦Û°Ê´`Àô)

	If Vartype(__askno_auto_reset)#"U" And __askno_auto_reset		&&¥s¸¹¦Û°Ê´_¦ì(¸ò SETTNG)

		TEXT TO ssql NOSHOW TEXTMERGE


		if exists (select   defavalue from sys_options where update_date = '<<_belongdate>>' and type = <<lcType>>)  update sys_options set defavalue=<<_auto_askno>> where type=<<lcType>>
			 else update sys_options set defavalue=<<__auto_askno_begin>>,update_date='<<_belongdate>>' where type=<<lcType>>

		ENDTEXT


*	_cliptext=ssql


	Else

		ssql="update sys_options set defavalue=?_auto_askno,update_date=?_belongdate where type="+lcType					&&¼g¤J³Ì·s¥s¸¹
	Endif

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif

	If SQLExec(nhand,"select defavalue from sys_options where type="+lcType ,"cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	_askno=Alltrim(Str(cun_tmp.defavalue))

	If Vartype(_askno_ab)="C"

		_askno=_askno_ab + _askno		&& A01  B01 ...

	Endif

Endif



IF __special_customer="sauna" AND VARTYPE(_work_order_fastfood_slip_print)="U" &&Lihong 2022.09.13 ÂIµæ¯È

	
	IF SQLEXEC(nhand,"select remark  from tables with (nolock)  where tableno=?_tableno and nsubtable=0","cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	ENDIF
	
	_askno =TRIM( NVL(cun_tmp.remark,""))
	


ENDIF



Local _order_id, _order_uid 
_order_id = 0
_order_uid = null &&Lihong 2023.07.19 void item show

_barcode=(_run_mode="barcode")		&&¬O§_±ø½X¼Ò¦¡


If _barcode And Empty(_tableno)		&&±ø½X¼Ò¦¡ªº§ÖÀ\,¨ú±otableno

	If SQLExec(nhand,"select  defavalue,update_date from sys_options where type='barcode_askno' ","cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	Local _update_date
	_update_date=cun_tmp.update_date

	_tableno=Iif(cun_tmp.defavalue<900 Or _update_date<>_belongdate ,999,cun_tmp.defavalue-1)

	If SQLExec(nhand,"update sys_options set defavalue=?_tableno,update_date=?_belongdate where  type='barcode_askno' ")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

	_tableno=Alltrim(Str(_tableno))		&&900-999 (
	_askno=""

	Public _barcode_fastfood_mode_tableno

	_barcode_fastfood_mode_tableno=_tableno

ENDIF

LOCAL nSplitNo
nSplitNo = 0

IF VARTYPE(_work_order_fastfood_slip_print)="U" &&Lihong 2022.09.13 ÂIµæ¯È

IF _curorder=0 AND  Vartype(_inv_chnage_mode)="U" AND !(VARTYPE(_fastfood_hold_auto_sn)="N" AND _fastfood_hold_auto_sn>0) &&Lihong 2022-09-16 fastfood hold


	If SQLExec(nhand,"select  defavalue from sys_options where type='auto_sn' ","cr_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

	ENDIF

	_auto_sn = NVL(cr_tmp.defavalue,0) + 1

	IF SQLEXEC(nhand,"update sys_options set defavalue=?_auto_sn where type='auto_sn' ")<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

	ENDIF

ENDIF


IF Vartype(_inv_chnage_mode)="U"



ENDIF



IF __special_customer="sauna"

	IF SQLEXEC(nhand,"select a.code,b.id as user_id from item a left join sys_user b on a.code=b.name  where code  in (select name from sys_user)","sauna_user_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1	
	ENDIF
	

ENDIF




&&Lihong 2020.01.17  &&Lihong 2023.07.19 void item show
If SQLExec(nhand, "if exists (select split from order_main where id<>0 and id=?_curorder) select split,order_uid,newid() as order_uid_new from order_main where id<>0 and id=?_curorder else " + ;
"if exists (select split from tables where order_id<>0 and order_id=?_curorder) select split,order_uid,newid() as order_uid_new from tables where order_id<>0 and order_id=?_curorder else select CAST(0 as int) as split,newid() as order_uid", "cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
Endif
nSplitNo=NVL(cun_tmp.split,0)
_order_uid = IIF(!ISNULL(cun_tmp.order_uid), cun_tmp.order_uid, cun_tmp.order_uid_new)
&&Lihong 2023.07.19 void item show
IF _run_mode="fastfood" AND VARTYPE(_curorder_uid)#"U" 
	*_order_uid = IIF(VARTYPE(_curorder_uid)="C", _curorder_uid, null) 
	_order_uid = _curorder_uid
ENDIF 
&&


&&Lihong 2020.01.17  
*nSplitNo=0

If Vartype(_inv_split_id)#"U"


	If 	_inv_split_id=0	&&¤À³æ¸¹

		ssql="select ISNULL(MAX(split),0) as max_split from inv "		&& 2010.09.24  his_inv

		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

		nSplitNo=cun_tmp.max_split+1

		_inv_split_id=nSplitNo

	Else
		nSplitNo=_inv_split_id

	Endif

Endif

*_save_order_action = "tableno:"+_tableno
&&ssql="select inv_id,invamt,status=(select status from tables with (nolock) where tableno=?_tableno and nsubtable=0) from order_main where id=?_curorder"+;
&&CHR(13)+"if exists (select id from order_main where id=?_curorder) delete from order_main where id=?_curorder "
If Vartype(_android_station)="C"
	_station=_android_station
Else
	_station=getcomputername()
Endif
SELECT SUM(1) FROM order_itemlist_tmp INTO ARRAY _tmp_ary_recc
_lcnow_order = ' ;now: invamt:'+TRANSFORM(_invamt)+' ,records:'+TRANSFORM(NVL(_tmp_ary_recc, 0))
TEXT TO ssql NOSHOW
select inv_id,invamt,status=(select status from tables with (nolock) where tableno=?_tableno and nsubtable=0),inv_void=(select void from inv with (nolock) where id=order_main.inv_id) from order_main where id=?_curorder
if exists (select id from order_main where id=?_curorder) 
begin 
DECLARE @action nvarchar(200) 
SET @action=(select top 1 'previously: tableno:'+rtrim(tableno)+',orderid:'+ltrim(str(id))+',askno:'+rtrim(askno)+',invamt:'+ltrim(str(invamt,12,2))+',inv_srv_type:'+ltrim(str(inv_srv_type))
+',inv_srv_perc:'+ltrim(str(inv_srv_perc,8,3))+',records:'+ltrim(str(isnull((select sum(1) from order_detail where id=?_curorder),'0')))+?_lcnow_order 
from order_main where id=?_curorder order by id)
insert into sys_log (station,adduser,datetime,log_id,action,station_time) values (?_station,?_login_user_name,getdate(),171,@action,?DATETIME() )

ENDTEXT 

IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	TEXT TO ssql ADDITIVE NOSHOW
	end
	ENDTEXT 
ELSE 
	TEXT TO ssql ADDITIVE NOSHOW
	delete from order_main where id=?_curorder
	end
	ENDTEXT 
ENDIF 

If SQLExec(nhand,ssql, "cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

&&Lihong 2022.03.25 ¦L³æ«á¦A¤J¹sª÷ÃBµæ¦¡(ª÷ÃB¥¼ÅÜ)À\Âiª¬ºA¤£ÅÜ(by setting)
IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	_dine_only_zero_amt_item_save_order = .T.
	lninv_id_zero_item = cun_tmp.inv_id 
	_dine_only_zero_amt_item = .T.
ELSE 
	_dine_only_zero_amt_item_save_order = .F.
	IF VARTYPE(_dine_only_zero_amt_item)="U" 
		_dine_only_zero_amt_item = .F.
		_dine_only_zero_amt_item_save_order = .T. &&¤W¼h¤£³B²ztables.status="T"->"P"
	ENDIF 
	If VARTYPE(__zero_item_status_unchanged)#"U" AND __zero_item_status_unchanged AND LOWER(_run_mode)="dine" AND nSplitNo=0 AND _curorder>0 AND TRIM(NVL(cun_tmp.status,""))=="P" AND cun_tmp.invamt=_invamt AND cun_tmp.inv_id>0 AND NVL(cun_tmp.inv_void,.F.)=.F. 
	&&work_order.printinv¦³ª½±µ§ïstatus="P"¦ýµLinvid
		lninv_id_zero_item = cun_tmp.inv_id 
		*§ï»ù®æ ¼Æ¶q ¶µ¥Ø§é¦© ¿n¤À´«ÁÊ 
		*modi«O¦s«á¤£¯à§ïªº¬G¤£¥Î³B²z
		TEXT TO ssql NOSHOW &&Undefine parent_id, real_amount, round_amount, modi_amount, disc_amount, srv_amount, tax_amount, xdisc, printed hhqty,hhprice 
			select uid, price, qty, hhqty, hhprice, disc_amount, srv_amount, tax_amount, real_amount from order_detail where id=?_curorder
		ENDTEXT 
		IF SQLEXEC(nhand, ssql, "cr_tmp")<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1		
		ENDIF

		*AND a.Undefine=.F. AND a.sitem_sub=.F. 
		SELECT * FROM ;
		(select a.uid as auid, a.price as aprice, a.qty as aqty, a.hhqty as ahhqty, a.hhprice as ahhprice, ;
			a.disc_amount*-1 as adisc_amount, a.srv_amount as asrv_amount, a.tax_amount as atax_amount, a.real_amount as areal_amount, ;
			b.uid as buid, b.price as bprice, b.qty as bqty, b.hhqty as bhhqty, b.hhprice as bhhprice, ;
			b.disc_amount as bdisc_amount, b.srv_amount as bsrv_amount, b.tax_amount as btax_amount, b.real_amount as breal_amount ;
			FROM order_itemlist_tmp a LEFT JOIN cr_tmp b ON a.uid=b.uid ; 
			WHERE (a.item_id>0 OR INLIST(a.item_id, -199, -111, -110, -104, -103, -102, -101, -51)) ;
		) a WHERE ISNULL(buid) = .F. AND (ROUND(adisc_amount,2)<>0 OR ROUND(bdisc_amount,2)<>0 OR ROUND(asrv_amount,2)<>0 OR ROUND(bsrv_amount,2)<>0 ;
		OR ROUND(atax_amount,2)<>0 OR ROUND(btax_amount,2)<>0 OR ROUND(areal_amount,2)<>0 OR ROUND(breal_amount,2)<>0) ;
		AND (ROUND(aprice,2)<>ROUND(bprice,2) OR ROUND(aqty,2)<>ROUND(bqty,2) OR ahhqty<>bhhqty OR ROUND(ahhprice,2)<>ROUND(bhhprice,2) ;
		OR ROUND(adisc_amount,2)<>ROUND(bdisc_amount,2) OR ROUND(asrv_amount,2)<>ROUND(bsrv_amount,2) OR ROUND(atax_amount,2)<>ROUND(btax_amount,2) ) ; 
		INTO CURSOR cr_tmp &&¤l¬d¸ßAND a.printed=.T. AND (a.just_send=.F. OR ¦w¨ôid=0)¤£»Ý­n;  AND a.Undefine=.F. ¥i¤£­n 
		
		*And Undefine=.F. 
		IF EOF("cr_tmp")
			SELECT uid FROM order_itemlist_tmp WHERE  (printed=.F. OR just_send=.T.) And (item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) ) ;
			 AND (price<>0 OR hhprice<>0 OR disc_amount<>0 OR srv_amount<>0 OR tax_amount<>0 OR amount<>0 OR real_amount<>0 OR round_amount<>0 OR modi_amount<>0 ) ;
			 INTO CURSOR cr_tmp
			IF EOF("cr_tmp")
				SELECT uid FROM order_itemlist_tmp WHERE Undefine=.T. INTO CURSOR cr_tmp
				IF EOF("cr_tmp")
					_dine_only_zero_amt_item = .T.
				ENDIF 
			ENDIF 
	  	ENDIF 
	ENDIF 
ENDIF 

ENDIF &&Lihong 2022.09.13 ÂIµæ¯È

Local _fastfood_remark,_used_station,_isForeign &&nSplitNo ¤W²¾

_fastfood_remark=Iif(Vartype(_fastfood_remark_info)="C",_fastfood_remark_info,"")

_used_station=Iif(_run_mode="barcode" or VARTYPE(llfastfood_order_do_hold)#"U" or VARTYPE(llfastfood_order_do_pre)#"U",getcomputername(),"") &&Lihong 2022-09-16 fastfood hold

_isForeign=Iif(Vartype(__order_Foreigner)="L" ,__order_Foreigner,.F.)


&&Lihong 2022.05.15 &&Lihong 2023.07.19 void item show <<IIF(	_curorder>0	 AND VARTYPE(llfastfood_order_do_hold)="U" AND VARTYPE(llfastfood_order_do_pre)="U" OR BETWEEN(_curorder, -199999, -100000), "?_order_uid","newid()")>>
TEXT TO ssql  NOSHOW TEXTMERGE

	INSERT INTO order_main
	           ([order_uid]
	           ,[id]
	           ,[inv_id]
	           ,[tableno]
	           ,[askno]
	           ,[pplcnt]
	           ,[begintime]
	           ,[orgamt]
	           ,[amount]
	           ,[modiamt]
	           ,[itemdiscamt]
	           ,[srvamt]
	           ,[taxamt]
	           ,[rndamt]
	           ,[discamt]
	           ,[invamt]
	           ,[cost]
	           ,[recused]
	           ,[printed]
	           ,[printtime]
	           ,[memberno]
	           ,[barcode]
	           ,[mincharge_mode]
	           ,[tel]
	           ,[address]
	           ,[outlet_id]
	           ,[void_id]
	           ,[remark]
	           ,[split]
	           ,[used_station]
	           ,[isForeign]
	           ,[sn]
	           ,[price_period_id]
	           ,[deposit_id]
	           ,[inv_srv_type]
	           ,[inv_srv_perc]
	)
	     VALUES
				  (?_order_uid,
				?_order_id ,
				?_old_inv_Id ,
				?_tableno,
				?_askno,
				?_pplcnt ,
				?_begintime ,
				<<_orgamt>> ,
				<<_amount>> ,
				<<_modiamt>> ,
				<<_item_discamt>> ,
				<<_srvamt>> ,
				<<_taxamt>> ,
				<<_rndamt>> ,
				<<_discamt>> ,
				<<_invamt>> ,
				<<_cost>> ,
				0 ,
				1 ,
				getdate() ,
				?_member_no,
				?_barcode ,
				?_mincharge_mode ,
				?TRIM(_tel) ,
				?ALLTRIM(_addr) ,
				?_outlet_id,
				?_void_Id ,
				?TRIM(_fastfood_remark) ,
				?nSplitNo,
				?_used_station,
				?_isForeign,
				?_auto_sn,
				?_price_period_id,
				?_deposit_id, 
	            ?_inv_srv_type,
	            ?_inv_srv_perc
				)

ENDTEXT
**TRIM(_addr)

IF VARTYPE(_work_order_fastfood_slip_print)="U" &&Lihong 2022.09.13 ÂIµæ¯È
ELSE &&Lihong 2022.09.13 ÂIµæ¯È &&Lihong 2023.07.19 void item show
	IF VARTYPE(llfastfood_order_do_hold)="U" &&Lihong 2022-09-16 fastfood hold
		If SQLExec(nhand,"select * from order_main with (nolock) where 1<>1","fastfood_slip_order_main_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide()
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1
		ENDIF
		SELECT * FROM fastfood_slip_order_main_tmp into CURSOR fastfood_slip_order_main_tmp READWRITE 
		INSERT INTO fastfood_slip_order_main_tmp ([order_uid],[id],[inv_id],[tableno],[askno],[pplcnt],[begintime],[orgamt],[amount],[modiamt],[itemdiscamt],[srvamt],[taxamt],[rndamt],[discamt],[invamt],[cost], ;
		[recused],[printed],[printtime],[memberno],[barcode],[mincharge_mode],[tel],[address],[outlet_id],[void_id],[remark],[split],[used_station],[isForeign],[sn],[price_period_id] ) ;
		VALUES (_order_uid,_order_id,_old_inv_Id,_tableno,_askno,_pplcnt,_begintime,_orgamt,_amount,_modiamt,_item_discamt,_srvamt,_taxamt,_rndamt,_discamt,_invamt,_cost, ;
		.F.,.T.,datetime(),_member_no,_barcode,_mincharge_mode,TRIM(_tel),ALLTRIM(_addr),_outlet_id,_void_Id,TRIM(_fastfood_remark),nSplitNo,_used_station,_isForeign,_auto_sn,_price_period_id ) 
		
		RETURN 1 
	ENDIF 
ENDIF 


IF _curorder>0	 AND VARTYPE(llfastfood_order_do_hold)="U" AND VARTYPE(llfastfood_order_do_pre)="U" OR BETWEEN(_curorder, -199999, -100000)  &&Lihong 2023.03.29 ¼W¥[BETWEEN			
&&barcode mode ©ÎÂÂ³æ &&Lihong 2022-09-16 fastfood hold &&Lihong 2022-09-26 fastfood preorder

	_order_id=_curorder

	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	ELSE 
		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif
	ENDIF 
	
ELSE

	Local _rand_id, _retry, rand_id_sql
	_retry = 0
	IF VARTYPE(llfastfood_order_do_hold)="U" AND VARTYPE(llfastfood_order_do_pre)="U" &&Lihong 2022-09-16 fastfood hold &&Lihong 2022-09-26 fastfood preorder
		Do Whil .T.
			_rand_id=Int(Rand(0)*9999) &&¨úÀH¾÷ID
			IF _rand_id = 0 OR _rand_id<1000 &&Lihong 2020.09.29 &&2022.02.17 >1000
				LOOP 
			ENDIF 
			rand_id_sql="select id from order_main with (nolock) where id=?_rand_id union select order_id as id from tables with (nolock)  where order_id=?_rand_id" &&Lihong 2020.07.17 union

			If SQLExec(nhand,rand_id_sql,"cun_tmp")<0

				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			If !Eof("cun_tmp")

				Loop

			Endif

			_order_id=_rand_id
			*cFastfood_remark=SUBSTR(_fastfood_remark,1,20)
			If SQLExec(nhand,ssql)<0
				Aerror(err)

				IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ENDIF

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			Exit


		ENDDO
	ELSE
		
*!*			Do Whil .T.
*!*				*_rand_id=-10000
*!*				TEXT TO rand_id_sql noshow														&& 2013.07.11
*!*					IF NOT exists (select type from sys_options where type='fastfood_hold_id'   )
*!*					begin
*!*					declare @nid int
*!*					select @nid=min(id) from order_main WHERE id>=-99999 AND id<=-10000
*!*					insert into sys_options (defavalue,type,active,disporder,update_date) values (@nid ,'fastfood_hold_id',1,0,'1900-01-01')

*!*					end

*!*				ENDTEXT

*!*				If SQLExec(nhand,rand_id_sql)<0
*!*					Aerror(err)

*!*					IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
*!*						_retry=_retry+1
*!*						LOOP
*!*					ENDIF

*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					frm_wait.Hide
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				Endif

*!*				TEXT TO rand_id_sql noshow
*!*					IF  exists (select type from sys_options where type='fastfood_hold_id' and defavalue>(select min(id) from order_main WHERE id>=-99999 AND id<=-10000 )  )
*!*					update sys_options set defavalue=(select min(id) from order_main WHERE id>=-99999 AND id<=-10000 ) where type='fastfood_hold_id'


*!*				ENDTEXT

*!*				If SQLExec(nhand,rand_id_sql)<0
*!*					Aerror(err)

*!*					IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
*!*						_retry=_retry+1
*!*						LOOP
*!*					ENDIF

*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					frm_wait.Hide
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				Endif
*!*				
*!*				rand_id_sql="select min(defavalue) as min_id from sys_options where  type='fastfood_hold_id' "

*!*				If SQLExec(nhand,rand_id_sql,"cun_tmp")<0
*!*					Aerror(err)

*!*					IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
*!*						_retry=_retry+1
*!*						LOOP
*!*					ENDIF

*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					frm_wait.Hide
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				ENDIF
*!*						
*!*						
*!*				If Eof("cun_tmp")
*!*					IF _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
*!*						_retry=_retry+1
*!*						LOOP
*!*					ELSE
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions" ,1)
*!*						frm_wait.Hide
*!*						Return -1
*!*					ENDIF
*!*				Endif

*!*				_order_id=NVL(cun_tmp.min_id,-9999)-1
*!*				IF _order_id<-99999 
*!*					_order_id = -10000
*!*				ENDIF 
*!*				
*!*				If SQLExec(nhand,"select id from order_main WHERE id=?_order_id","cun_tmp")<0
*!*					Aerror(err)

*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					frm_wait.Hide
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*					Return -1
*!*				ENDIF
*!*				
*!*				IF !Eof("cun_tmp")
*!*					IF _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
*!*						_retry=_retry+1
*!*						LOOP
*!*					ENDIF
*!*					frm_wait.Hide
*!*					Return -1
*!*				ENDIF 

*!*				If SQLExec(nhand,ssql)<0
*!*					Aerror(err)

*!*					IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
*!*						_retry=_retry+1
*!*						LOOP
*!*					ENDIF

*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				Endif

*!*				If SQLExec(nhand,"update sys_options  set defavalue=?_order_id,update_date = getdate() where type='fastfood_hold_id' ")<0		&&¥e¥Î¦¡¼g¤J
*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					frm_wait.Hide
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				Endif
*!*				
*!*				Exit

*!*			ENDDO

		IF VARTYPE(llfastfood_order_do_pre)#"U"
			_order_id_type = 'fastfood_preorder_id'
			_order_id_range = "id>=-199999 AND id<=-100000"
		ELSE
			_order_id_type = 'fastfood_hold_id'
			_order_id_range = "id>=-99999 AND id<=-10000"
		ENDIF 
		Do Whil .T.
			*_rand_id=-10000
			TEXT TO rand_id_sql TEXTMERGE NOSHOW 												&& 2013.07.11
				IF NOT exists (select type from sys_options where type=?_order_id_type )
				begin
				declare @nid int
				select @nid=min(id) from order_main WHERE <<_order_id_range>>
				insert into sys_options (defavalue,type,active,disporder,update_date) values (@nid ,?_order_id_type,1,0,'1900-01-01')

				end

			ENDTEXT

			If SQLExec(nhand,rand_id_sql)<0
				Aerror(err)

				IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ENDIF

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			TEXT TO rand_id_sql TEXTMERGE NOSHOW 
				IF  exists (select type from sys_options where type=?_order_id_type and defavalue>(select min(id) from order_main WHERE <<_order_id_range>> )  )
				update sys_options set defavalue=(select min(id) from order_main WHERE <<_order_id_range>> ) where type='fastfood_hold_id'


			ENDTEXT

			If SQLExec(nhand,rand_id_sql)<0
				Aerror(err)

				IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ENDIF

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif
			
			&&Lihong 2020.01.17 cloud_check_valid 
			rand_id_sql="select min(defavalue) as min_id from sys_options where  type=?_order_id_type "

			If SQLExec(nhand,rand_id_sql,"cun_tmp")<0
				Aerror(err)

				IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ENDIF

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			ENDIF
					
					
			If Eof("cun_tmp")
				IF _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ELSE
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					Return -1
				ENDIF
			Endif

			IF VARTYPE(llfastfood_order_do_pre)#"U"
				_order_id=NVL(cun_tmp.min_id,-99999)-1
				IF _order_id<-199999 
					_order_id = -100000
				ENDIF 
			ELSE
				_order_id=NVL(cun_tmp.min_id,-9999)-1
				IF _order_id<-99999 
					_order_id = -10000
				ENDIF 
			ENDIF 
			
			If SQLExec(nhand,"select id from order_main WHERE id=?_order_id","cun_tmp")<0
				Aerror(err)

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1
			ENDIF
			
			IF !Eof("cun_tmp")
				IF _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ENDIF
				frm_wait.Hide
				Return -1
			ENDIF 

			If SQLExec(nhand,ssql)<0
				Aerror(err)

				IF err(1)=1526 AND _retry<10		&&¥X¿ù«á­«¸Õ10¦¸  
					_retry=_retry+1
					LOOP
				ENDIF

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			If SQLExec(nhand,"update sys_options  set defavalue=?_order_id,update_date = getdate() where type=?_order_id_type ")<0		&&¥e¥Î¦¡¼g¤J
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif
			
			Exit

		ENDDO

	ENDIF 

Endif

&&Lihong 2022.05.15
*!*	TEXT TO ssql  NOSHOW TEXTMERGE

*!*		INSERT INTO order_main
*!*		           ([id]
*!*		           ,[inv_id]
*!*		           ,[tableno]
*!*		           ,[askno]
*!*		           ,[pplcnt]
*!*		           ,[begintime]
*!*		           ,[orgamt]
*!*		           ,[amount]
*!*		           ,[modiamt]
*!*		           ,[itemdiscamt]
*!*		           ,[srvamt]
*!*		           ,[taxamt]
*!*		           ,[rndamt]
*!*		           ,[discamt]
*!*		           ,[invamt]
*!*		           ,[cost]
*!*		           ,[recused]
*!*		           ,[printed]
*!*		           ,[printtime]
*!*		           ,[memberno]
*!*		           ,[barcode]
*!*		           ,[mincharge_mode]
*!*		           ,[tel]
*!*		           ,[address]
*!*		           ,[outlet_id]
*!*		           ,[void_id]
*!*		           ,[remark]
*!*		           ,[split]
*!*		           ,[used_station]
*!*		           ,[isForeign]
*!*		           ,[sn]
*!*		)
*!*		     VALUES
*!*					  (
*!*					?_order_id ,
*!*					?_old_inv_Id ,
*!*					?_tableno,
*!*					?_askno,
*!*					?_pplcnt ,
*!*					?_begintime ,
*!*					<<_orgamt>> ,
*!*					<<_amount>> ,
*!*					<<_modiamt>> ,
*!*					<<_item_discamt>> ,
*!*					<<_srvamt>> ,
*!*					<<_taxamt>> ,
*!*					<<_rndamt>> ,
*!*					<<_discamt>> ,
*!*					<<_invamt>> ,
*!*					<<_cost>> ,
*!*					0 ,
*!*					1 ,
*!*					getdate() ,
*!*					?_member_no,
*!*					?_barcode ,
*!*					?_mincharge_mode ,
*!*					?TRIM(_tel) ,
*!*					?ALLTRIM(_addr) ,
*!*					?_outlet_id,
*!*					?_void_Id ,
*!*					?TRIM(_fastfood_remark) ,
*!*					?nSplitNo,
*!*					?_used_station,
*!*					?_isForeign,
*!*					?_auto_sn
*!*					)

*!*	ENDTEXT
*!*	**TRIM(_addr)
*!*	If SQLExec(nhand,ssql)<0
*!*		Aerror(err)
*!*		Sqlrollback(nhand)
*!*		SQLSetprop(nhand,"Transactions" ,1)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		Return -1

*!*	Endif


Release __order_Foreigner


_allprinter=""
N=0
Select work_order_tmp12		&&¨C­Ó¥´¦L¾÷¤@­ÓÀH¾÷ÃÑ§O½X
Scan
	N=N+1
	Dimension prand(N,2)
	prand(N,1)=Id
*	prand(N,2)="KIT"+Alltrim(Str(Int(Rand()*99)))+Sys(2015)	&&ÀH¾÷½X,«e­±ªº"KIT"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î
	prand(N,2)="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")
	_allprinter=_allprinter+Trim(Printer)+","
Endscan
Create Cursor print_page (Printer Int(4),pid c(20))

_mprinter="0"
_dispord=1


_tableno=Iif(_isfastfood And _run_mode<>"barcode" ,_askno,_tableno)

IF VARTYPE(llfastfood_order_do_hold)="U" &&Lihong 2022-09-16 fastfood hold
	&&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ
	_print_to_kitchen_outlet = .T.
	IF Upper(_run_mode)=="DINE"
		ssql="select slip_print, inv_print, paylist_print,kit_print from outlet where id=?_outlet_id"	
		If SQLExec(nhand,ssql, "cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1
		ENDIF
		_print_to_kitchen_outlet = NVL(cun_tmp.kit_print, .F.)
	ENDIF 
ELSE
	_print_to_kitchen_outlet = .F.
ENDIF 


If __print_to_kitchen AND (!Upper(_run_mode)=="DINE" OR _print_to_kitchen_outlet=.T.) AND VARTYPE(llfastfood_order_do_hold)="U" &&Lihong 2022-09-16 fastfood hold

	Select  order_itemlist_tmp			&&¥ý±N«H®§¿é¥X¥´¦L	(¦pªG«ü©wsprinter,«h¦V«ü©wªºprinterµo°e)
	Scan For printed=.F. And item_id=-1 And _onlysave=.F. &&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯Èbug ¡G  printed=.F.»Ý­n¥[ ( or just_send=.T.) ?

		&&¦pªG¦³¦b«H®§¿é¤J®É«ü©w¦Lªí¾÷«h¨ú«ü©wªº¦Lªí¾÷¿é¥X By Waston 12/06/2023
		*!*			_msg_printer=Iif(Empty(sprinter),_allprinter,Trim(sprinter))
		_msg_printer=Iif(Empty(sprinter), TRIM(printer), Trim(sprinter))

		&&	Cmsg,_printer,_curorder,_tableno
		If msg_print(Trim(order_itemlist_tmp.descdisp),_msg_printer,_curorder,_tableno)=-1		&&¦pªG¨S¦³«ü©w,«h¦V¥þ³¡¥´¦L¾÷µo°e
			Return -1
		Endif
		Select  order_itemlist_tmp
	Endscan

Endif


&&Lihong 2020.10.26 §ó§ï»ù¿ú¡B§é¦©®É¦Û°Ê¥X¤Wµæ¯È
*ROUND¡G¤p¼Æ¦ì¼Æ¤º¦sªí»P¼Æ¾Ú®w¤£¤@¦Ü¨ú¤pªÌ
IF _curorder > 0 AND VARTYPE(__reprint_Slip_edit_item_disc)#"U" AND __reprint_Slip_edit_item_disc AND VARTYPE(llfastfood_order_do_hold)="U" AND !(VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) 
&&Lihong 2022-09-16 fastfood hold &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	TEXT TO ssql NOSHOW &&member_id, disc_qty autodisc	 points disc_qtyÅÜ°Ê·|¶Ç»¼¨ìdisc_amount
		select disc_id, disc_type, disc_per, disc_amount, disc_qty, points from order_disc where id=?_curorder
	ENDTEXT 
	*disc_amount¡G¦Û©w§é¦©edit¥i¥Î³y¦¨disc_idµ¥¬Û¦P¦ýdisc_amount¤£¦P¡A¦ý¬Oitem­×§ï¤]·|³y¦¨¦¹disc_amountÅÜ¤Æ¥BµLªk°Ï¤À
	IF SQLEXEC(nhand, ssql, "cr_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1		
	ENDIF
	SELECT * FROM ( ;
	select a.disc_id as adisc_id, b.disc_id as bdisc_id FROM order_disc_tmp a FULL OUTER JOIN cr_tmp b ;
	ON a.disc_id=b.disc_id AND a.disc_type=b.disc_type AND ROUND(a.disc_per,2)=ROUND(b.disc_per,2) AND IIF(a.disc_type=3, ROUND(a.disc_amount,2)=ROUND(b.disc_amount,2), .T.) AND a.disc_qty=b.disc_qty AND ROUND(a.points,2)=ROUND(b.points,2)) a ;
	WHERE ISNULL(a.adisc_id) = .T. OR ISNULL(a.bdisc_id) = .T. INTO CURSOR cr_tmp1 
	llfound_disc_change = !EOF("cr_tmp1")
	USE IN SELECT("cr_tmp1")
	IF llfound_disc_change 
		*¾ã³æ§é
		__order_item_delete = .T. &&¥u¬O§Q¥Î¦¹ÅÜ¶q¥þ³¡¥´¦L
		_void_item_slip_print_all = .T. &&¥u¬O§Q¥Î¦¹ÅÜ¶q¥þ³¡¥´¦L
	ELSE
		 *§ï»ù®æ ¼Æ¶q ¶µ¥Ø§é¦© ¿n¤À´«ÁÊ 
		 *modi«O¦s«á¤£¯à§ïªº¬G¤£¥Î³B²z
		TEXT TO ssql NOSHOW &&Undefine parent_id, real_amount, round_amount, modi_amount, disc_amount, srv_amount, tax_amount, xdisc, printed hhqty,hhprice 
			select uid, price, qty, hhqty, hhprice, disc_amount, srv_amount, tax_amount from order_detail where id=?_curorder
		ENDTEXT 
		IF SQLEXEC(nhand, ssql, "cr_tmp")<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1		
		ENDIF
		SELECT * FROM ;
		(select a.uid as auid, a.price as aprice, a.qty as aqty, a.hhqty as ahhqty, a.hhprice as ahhprice, ;
			a.disc_amount*-1 as adisc_amount, a.srv_amount as asrv_amount, a.tax_amount as atax_amount, ;
			b.uid as buid, b.price as bprice, b.qty as bqty, b.hhqty as bhhqty, b.hhprice as bhhprice, ;
			b.disc_amount as bdisc_amount, b.srv_amount as bsrv_amount, b.tax_amount as btax_amount ;
			FROM order_itemlist_tmp a LEFT JOIN cr_tmp b ON a.uid=b.uid ; 
			WHERE (a.item_id>0 OR INLIST(a.item_id, -199, -111, -110, -104, -103, -102, -101, -51)) AND a.Undefine=.F. AND a.sitem_sub=.F. ;
		) a WHERE ISNULL(buid) = .F. ;
		AND (ROUND(aprice,2)<>ROUND(bprice,2) OR ROUND(aqty,2)<>ROUND(bqty,2) OR ahhqty<>bhhqty OR ROUND(ahhprice,2)<>ROUND(bhhprice,2) ;
		OR ROUND(adisc_amount,2)<>ROUND(bdisc_amount,2) OR ROUND(asrv_amount,2)<>ROUND(bsrv_amount,2) OR ROUND(atax_amount,2)<>ROUND(btax_amount,2) ) ; 
		INTO CURSOR cr_tmp &&¤l¬d¸ßAND a.printed=.T. AND (a.just_send=.F. OR ¦w¨ôid=0)¤£»Ý­n;  AND a.Undefine=.F. ¥i¤£­n
		IF !EOF("cr_tmp")
			*SELECT cr_tmp
			*SCAN 
			*	UPDATE order_itemlist_tmp  SET just_send=.T. WHERE uid=cr_tmp.auid AND printed=.T.
			*ENDSCAN 
			__order_item_delete = .T.
			_void_item_slip_print_all = .T.
	  	ENDIF 
	ENDIF 
	*UPDATE order_itemlist_tmp  SET just_send=.T. WHERE uid=this.Parent.id AND printed=.T.
ENDIF 

&&Lihong 2023-06-02 ¼pÅã 
If __print_to_kitchen And Vartype(_fastfood_save_only)="U" And _onlysave=.F. AND (!Upper(_run_mode)=="DINE" OR _print_to_kitchen_outlet=.T.) AND VARTYPE(llfastfood_order_do_hold)="U" && ¬O§_¦C¦L¼p©Ð³æ ¸ò ³]©w	&&§ÖÀ\¼Ò¦¡¸É³æ¤]¤£¦L &&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ
*If __print_to_kitchen And Vartype(_fastfood_save_only)="U" And _onlysave=.F. AND (Upper(_run_mode)=="DINE" AND _print_to_kitchen_outlet=.T.) AND VARTYPE(llfastfood_order_do_hold)="U" && ¬O§_¦C¦L¼p©Ð³æ ¸ò ³]©w	&&§ÖÀ\¼Ò¦¡¸É³æ¤]¤£¦L &&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ
	Select a.*, IIF(ISNULL(b.id),NVL(bb.local_print_kit, .F.),NVL(b.local_print_kit, .F.)) as local_print_kit FROM order_itemlist_tmp a LEFT JOIN work_order_tmp b ON a.item_id=b.id LEFT JOIN work_order_tmp0 bb ON a.item_id=bb.id ;
	WHERE a.sitem=.F. AND printed=.F. And onlysave=.F. And Undefine=.F.  And  item_id>=0 INTO CURSOR order_itemlist_to_printer READWRITE 
	*LcFastFood_info=""
	SCAN 
		If order_item_print("order_itemlist_to_printer",_order_id,.F.,'',.F.,.F.,.F.,(_outlet_id=0),"",_tableno)=-1			&&Àò¨ú¿é¥X¥´¦L¾÷
			SQLSetprop(nhand,"Transactions",1)
			Return  -1
		Endif
	ENDSCAN 
ENDIF 

IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
ELSE 
	ssql="if exists (select id from order_detail where id=?_order_id) delete from order_detail where id=?_order_id"		&&¥ý§R°£,¦A­«·s²K¥[
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif
ENDIF 

_remark2=""
ssql_batch = "DECLARE @max_id int"
Select  order_itemlist_tmp								&&¥´¦L¼p©Ð³æ
Scan 		&&¥¼©wµæ¦¡¤£³B²z
	&&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split 
		IF RECNO("order_itemlist_tmp")<=lnvs_so_add_pre_recno
			LOOP 
		ENDIF 
	ENDIF 
	Select  order_itemlist_tmp
	
	*_Printed=(Undefine=.F.)
	_Printed=Iif(order_itemlist_tmp.printed,.T., (Undefine=.F.) AND VARTYPE(llfastfood_order_do_hold)="U") &&Lihong 2022-09-16 fastfood hold
	_printtime=Iif(order_itemlist_tmp.printed,order_itemlist_tmp.printtime,Datetime())
	&&·|­û´«ÁÊ®É,¦pªGorder_itemlist_tmp.printed = .t.®É,printtime·|¨ú­È'    /  /      ',·|¥X¿ù,­n¨údatetime() By Waston 20/06/2023
	IF EMPTY(_printtime)
		_printtime = DATETIME()
	ENDIF 
	_xdisc=-1*order_itemlist_tmp.xdisc
	_orgamt=qty*price		&&­ì©lª÷ÃB
	_qty=order_itemlist_tmp.qty
	_item_Id=order_itemlist_tmp.item_id
	
	_qty_entity=order_itemlist_tmp.qty_entity

	
	&&Lihong 2020.06.01 coupon cloud_coupon_id, web_coupon_id, web_coupon_code
	&&Lihong 2022.03.17 ¨Ò®uorgqty_case_mat
	&&Lihong 2023-06-02 ¼pÅã kit_disp_uid 
*!*		TEXT TO ssql NOSHOW TEXTMERGE

*!*		INSERT INTO  order_detail (id,uid,parent_id,cate_id,item_Id,item_code,descdisp,qty,price,
*!*			orgamt,amount,real_amount,round_amount,sitem,sitem_sub,mitem,mustmodi,hold,printed,printtime,adduser,modi_list,
*!*			modi_amount,disc_amount,srv_amount,srv_per,tax_amount,tax_per,level_disc,level_id,drink_qty,recused,
*!*			sprinter,remin_times,xdisc,onlysave,handwriting,hhqty,hhprice,undefine,mitem_id,
*!*			timer_active,timer_style ,free_hours ,free_style ,timer_begtime ,timer_endtime ,timer_mincharge,timer_disc,printer,material,orgsrv,price0,tax2,points,pointed,askdept,
*!*			item_warning,warning_begtime,warning_endtime,warning_inMinute,pre_price,sub_amt,org_price,gift,giftred,transnumber,tel,member_number,ordertime,ecoupon,price_mc,
*!*			modi_need,modi_must,modi_def,amtinv,save_type,delay_minute,disc,fix_price, 
*!*			coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code, print_single, same_tableno, orgqty_case_mat, price_type, qty_entity, add_user_id, add_user_station_id,srv_per_org )
*!*			 values (?_order_id,?order_itemlist_tmp.uid,?order_itemlist_tmp.parent_id,?order_itemlist_tmp.cate_id,?order_itemlist_tmp.item_id,?order_itemlist_tmp.item_code,
*!*			?order_itemlist_tmp.descdisp,?order_itemlist_tmp.qty,<<order_itemlist_tmp.price>>,<<_orgamt>>,<<order_itemlist_tmp.amount>>,<<order_itemlist_tmp.real_amount>>,<<order_itemlist_tmp.round_amount>>,
*!*			?order_itemlist_tmp.sitem,?order_itemlist_tmp.sitem_sub,?order_itemlist_tmp.mitem,?order_itemlist_tmp.mustmodi,
*!*			?order_itemlist_tmp.hold,?_printed,?_printtime,?order_itemlist_tmp.adduser,
*!*			?order_itemlist_tmp.modi_list,<<order_itemlist_tmp.modi_amount>>,
*!*			<<order_itemlist_tmp.disc_amount*-1>>,<<order_itemlist_tmp.srv_amount>>,<<order_itemlist_tmp.srv_per>>,
*!*			<<order_itemlist_tmp.tax_amount>>,<<order_itemlist_tmp.tax_per>>,?order_itemlist_tmp.level_disc,
*!*			?order_itemlist_tmp.level_id,?order_itemlist_tmp.drink_qty,0,
*!*			?order_itemlist_tmp.sprinter,?order_itemlist_tmp.remin_times,?_xdisc,?order_itemlist_tmp.onlysave,
*!*			?order_itemlist_tmp.handwriting,?order_itemlist_tmp.hhqty,?order_itemlist_tmp.hhprice,?order_itemlist_tmp.undefine,?order_itemlist_tmp.mitem_id,
*!*			?order_Itemlist_tmp.timer_active,?order_Itemlist_tmp.timer_style,?order_Itemlist_tmp.free_hours,?order_Itemlist_tmp.free_style,
*!*			?order_Itemlist_tmp.timer_begtime,?order_Itemlist_tmp.timer_endtime,?order_itemlist_tmp.timer_mincharge,?order_Itemlist_tmp.timer_disc,
*!*			?order_Itemlist_tmp.printer,?order_itemlist_tmp.material,?order_itemlist_tmp.orgsrv,?order_itemlist_tmp.price0,?order_itemlist_tmp.tax2,
*!*			?order_itemlist_tmp.points,?order_itemlist_tmp.pointed,?order_itemlist_tmp.askdept,
*!*			?order_itemlist_tmp.item_warning,?order_itemlist_tmp.warning_begtime,?order_itemlist_tmp.warning_endtime,?order_itemlist_tmp.warning_inMinute,
*!*			<<order_itemlist_tmp.pre_price>>,<<order_itemlist_tmp.sub_amt>>,<<order_itemlist_tmp.org_price>>,
*!*			?order_itemlist_tmp.gift,?order_itemlist_tmp.giftred,?order_itemlist_tmp.transnumber,?order_itemlist_tmp.tel,?order_itemlist_tmp.member_number,
*!*			?order_itemlist_tmp.ordertime,?order_itemlist_tmp.ecoupon,?order_itemlist_tmp.price_mc,?order_itemlist_tmp.modi_need,?order_itemlist_tmp.modi_must,?order_itemlist_tmp.modi_def,
*!*			?order_itemlist_tmp.amtinv,?order_itemlist_tmp.save_type,?order_itemlist_tmp.delay_minute,?order_itemlist_tmp.disc,?order_itemlist_tmp.fix_price, 
*!*			?IIF(EMPTY(order_itemlist_tmp.coupon_lock_valid),null,order_itemlist_tmp.coupon_lock_valid), ?order_itemlist_tmp.cloud_coupon_id, ?IIF(EMPTY(order_itemlist_tmp.web_coupon_id),null,order_itemlist_tmp.web_coupon_id), 
*!*			?order_itemlist_tmp.web_coupon_code, ?order_itemlist_tmp.print_single, ?order_itemlist_tmp.same_tableno, ?order_itemlist_tmp.orgqty_case_mat, ?order_itemlist_tmp.price_type, ?order_itemlist_tmp.qty_entity, 
*!*			?order_itemlist_tmp.add_user_id, ?order_itemlist_tmp.add_user_station_id,?order_itemlist_tmp.srv_per_org )


*!*		ENDTEXT
	ssql = ""
	TEXT TO ssql TEXTMERGE NOSHOW 

	INSERT INTO  order_detail (id,uid,parent_id,cate_id,item_Id,item_code,descdisp,qty,price,
		orgamt,amount,real_amount,round_amount,sitem,sitem_sub,mitem,mustmodi,hold,printed,printtime,adduser,modi_list,
		modi_amount,disc_amount,srv_amount,srv_per,tax_amount,tax_per,level_disc,level_id,drink_qty,recused,
		sprinter,remin_times,xdisc,onlysave,handwriting,hhqty,hhprice,undefine,mitem_id,
		timer_active,timer_style ,free_hours ,free_style ,timer_begtime ,timer_endtime ,timer_mincharge,timer_disc,printer,material,orgsrv,price0,tax2,points,pointed,askdept,
		item_warning,warning_begtime,warning_endtime,warning_inMinute,pre_price,sub_amt,org_price,gift,giftred,transnumber,tel,member_number,ordertime,ecoupon,price_mc,
		modi_need,modi_must,modi_def,amtinv,save_type,delay_minute,disc,fix_price, 
		coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code, print_single, same_tableno, orgqty_case_mat, price_type, qty_entity, add_user_id, add_user_station_id,srv_per_org, 
		kit_disp_uid, to_printer, has_hold )
		 values (?_order_id,<<order_itemlist_tmp.uid>>,<<order_itemlist_tmp.parent_id>>,<<order_itemlist_tmp.cate_id>>,<<order_itemlist_tmp.item_id>>,'<<STRTRAN(TRIM(order_itemlist_tmp.item_code), "'", "''")>>',
		'<<STRTRAN(TRIM(order_itemlist_tmp.descdisp), "'", "''")>>',<<order_itemlist_tmp.qty>>,<<order_itemlist_tmp.price>>,<<_orgamt>>,<<order_itemlist_tmp.amount>>,<<order_itemlist_tmp.real_amount>>,<<order_itemlist_tmp.round_amount>>,
		<<IIF(order_itemlist_tmp.sitem,1,0)>>,<<IIF(order_itemlist_tmp.sitem_sub,1,0)>>,<<IIF(order_itemlist_tmp.mitem,1,0)>>,<<IIF(order_itemlist_tmp.mustmodi,1,0)>>,
		<<order_itemlist_tmp.hold>>,<<IIF(_printed,1,0)>>,'<<TTOC(_printtime)>>','<<TRIM(order_itemlist_tmp.adduser)>>',
		'<<STRTRAN(TRIM(order_itemlist_tmp.modi_list), "'", "''")>>',<<order_itemlist_tmp.modi_amount>>,
		<<order_itemlist_tmp.disc_amount*-1>>,<<order_itemlist_tmp.srv_amount>>,<<order_itemlist_tmp.srv_per>>,
		<<order_itemlist_tmp.tax_amount>>,<<order_itemlist_tmp.tax_per>>,<<IIF(order_itemlist_tmp.level_disc,1,0)>>,
		<<order_itemlist_tmp.level_id>>,<<order_itemlist_tmp.drink_qty>>,<<0>>,
		'<<TRIM(order_itemlist_tmp.sprinter)>>',<<order_itemlist_tmp.remin_times>>,<<_xdisc>>,<<IIF(order_itemlist_tmp.onlysave,1,0)>>,
		<<IIF(order_itemlist_tmp.handwriting,1,0)>>,<<order_itemlist_tmp.hhqty>>,<<order_itemlist_tmp.hhprice>>,<<IIF(order_itemlist_tmp.undefine,1,0)>>,<<order_itemlist_tmp.mitem_id>>,
		<<IIF(order_Itemlist_tmp.timer_active,1,0)>>,<<order_Itemlist_tmp.timer_style>>,<<order_Itemlist_tmp.free_hours>>,<<order_Itemlist_tmp.free_style>>,
		'<<order_Itemlist_tmp.timer_begtime>>','<<order_Itemlist_tmp.timer_endtime>>',<<order_itemlist_tmp.timer_mincharge>>,<<IIF(order_Itemlist_tmp.timer_disc,1,0)>>,
		'<<TRIM(order_Itemlist_tmp.printer)>>',<<IIF(order_itemlist_tmp.material,1,0)>>,<<IIF(order_itemlist_tmp.orgsrv,1,0)>>,<<order_itemlist_tmp.price0>>,<<order_itemlist_tmp.tax2>>,
		<<order_itemlist_tmp.points>>,<<IIF(order_itemlist_tmp.pointed,1,0)>>,<<IIF(order_itemlist_tmp.askdept,1,0)>>,
		<<IIF(order_itemlist_tmp.item_warning,1,0)>>,'<<order_itemlist_tmp.warning_begtime>>','<<order_itemlist_tmp.warning_endtime>>',<<order_itemlist_tmp.warning_inMinute>>,
		<<order_itemlist_tmp.pre_price>>,<<order_itemlist_tmp.sub_amt>>,<<order_itemlist_tmp.org_price>>,
		<<IIF(order_itemlist_tmp.gift,1,0)>>,<<IIF(order_itemlist_tmp.giftred,1,0)>>,'<<TRIM(order_itemlist_tmp.transnumber)>>','<<TRIM(order_itemlist_tmp.tel)>>','<<TRIM(order_itemlist_tmp.member_number)>>',
		<<IIF(ISNULL(order_itemlist_tmp.ordertime) or EMPTY(order_itemlist_tmp.ordertime),"''","'"+TTOC(order_itemlist_tmp.ordertime)+"'")>>,<<IIF(order_itemlist_tmp.ecoupon,1,0)>>,<<order_itemlist_tmp.price_mc>>,
		'<<TRIM(order_itemlist_tmp.modi_need)>>','<<TRIM(order_itemlist_tmp.modi_must)>>','<<TRIM(order_itemlist_tmp.modi_def)>>',
		<<IIF(order_itemlist_tmp.amtinv,1,0)>>,'<<TRIM(order_itemlist_tmp.save_type)>>',<<order_itemlist_tmp.delay_minute>>,<<IIF(order_itemlist_tmp.disc,1,0)>>,<<IIF(order_itemlist_tmp.fix_price,1,0)>>, 
		<<IIF(EMPTY(NVL(order_itemlist_tmp.coupon_lock_valid,"")),"null","'"+TRIM(order_itemlist_tmp.coupon_lock_valid)+"'")>>, <<order_itemlist_tmp.cloud_coupon_id>>, <<IIF(EMPTY(NVL(order_itemlist_tmp.web_coupon_id,"")),"null","'"+TRIM(order_itemlist_tmp.web_coupon_id)+"'")>>, 
		'<<TRIM(order_itemlist_tmp.web_coupon_code)>>', <<IIF(order_itemlist_tmp.print_single,1,0)>>, '<<TRIM(order_itemlist_tmp.same_tableno)>>', <<order_itemlist_tmp.orgqty_case_mat>>, <<order_itemlist_tmp.price_type>>, <<order_itemlist_tmp.qty_entity>>, 
		<<order_itemlist_tmp.add_user_id>>, <<order_itemlist_tmp.add_user_station_id>>,<<IIF(ISNULL(order_itemlist_tmp.srv_per_org),"null",order_itemlist_tmp.srv_per_org)>>, 
		<<IIF(EMPTY(NVL(order_itemlist_tmp.kit_disp_uid,"")),"NEWID()","'"+TRIM(order_itemlist_tmp.kit_disp_uid)+"'")>>, '<<TRIM(order_itemlist_tmp.to_printer)>>', <<IIF(order_itemlist_tmp.has_hold=.T.,"1",IIF(order_itemlist_tmp.hold>0,"1","0"))>> )


	ENDTEXT
*!*	TRY
*!*		STRTOFILE("_qty_entity:"+TRANSFORM(_qty_entity)+CHR(13)+CHR(10)+ssql, "d:\x\save_order.txt",1 )
*!*	CATCH
*!*	ENDTRY
	lcvs_so_add_split_ssql = STRTRAN(ssql, "?_order_id,", "?lnvs_so_add_split_order_id,",1,1,1)
	
	IF VARTYPE(llfastfood_order_do_hold)="U" &&Lihong 2022-09-16 fastfood hold

		If printed=.F. And limitqty And _run_mode<>"fastfood"																	&&¥¼¥´¦L¤Î¦Û°Ê­pºâ¼Æ¶qªº¶µ¥Ø,§ó·s®w¦s¼Æ¶q
			*ssql=ssql+Chr(10)+"update item set qtyremain=qtyremain-?_qty where id=?_item_id"
			ssql=ssql+Chr(13)+Chr(10)+"update item set qtyremain=qtyremain-"+TRANSFORM(_qty)+" where id="+TRANSFORM(_item_id)
		ENDIF
		
		&&Lihong 2022.02.17 soldout_qty¤è¦¡ ¥¼¥´¦L§ó·s®w¦s¼Æ¶q
		If printed=.F. And _run_mode<>"fastfood" OR printed=.F. AND _run_mode="fastfood" AND (VARTYPE(work_cashier_Takeaway_soldout_qty)#"U" OR VARTYPE(llfastfood_order_do_pre)#"U") OR  printed=.F.  AND VARTYPE(__pso_order_save_inv)#"U" &&Lihong 2022.04.25 ¥~½æ¤]­pºâ
			_qty_or_entity = IIF(NVL(_qty_entity, 0)>0, _qty_entity, _qty)
*!*				TEXT TO ssql ADDITIVE NOSHOW TEXTMERGE
*!*				
*!*				update item set soldout=case when soldout=0 and isnull(soldout_qty,0) - ?_qty_or_entity<=0 then 1 else soldout end, 
*!*				soldout_qty=case when soldout=0 and isnull(soldout_qty,0) - ?_qty_or_entity>0 then isnull(soldout_qty,0) - ?_qty_or_entity else 0 end where id=?_item_id and ISNULL(soldout_qty,0)<>0 
*!*				ENDTEXT 
			TEXT TO ssql ADDITIVE NOSHOW TEXTMERGE
			
			update item set soldout=case when soldout=0 and isnull(soldout_qty,0) - <<_qty_or_entity>> <=0 then 1 else soldout end, 
			soldout_qty=case when soldout=0 and isnull(soldout_qty,0) - <<_qty_or_entity>> >0 then isnull(soldout_qty,0) - <<_qty_or_entity>> else 0 end where id=<<_item_id>> and ISNULL(soldout_qty,0)<>0 
			ENDTEXT 
		ENDIF 
	ENDIF 
		
*!*		If SQLExec(nhand,ssql)<0

*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions" ,1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1

*!*		ENDIF
	
	&&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split AND VARTYPE(llvs_so_add_order_split_have_sub)#"U" AND llvs_so_add_order_split_have_sub=.T.
*!*			If SQLExec(nhand, lcvs_so_add_split_ssql)<0

*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return -1

*!*			ENDIF

		ssql=ssql+Chr(13)+Chr(10)+lcvs_so_add_split_ssql
	ENDIF 
	
*---------------->>>>>>>>> material ¦¨¥÷ &&Lihong 2022-09-16 fastfood hold
	ssql_material = ""
	If printed=.F. And material and (mitem_id<>-1 or undefine=.F.) And (_run_mode<>"fastfood" Or (_run_mode="fastfood" And (Vartype(_no_commit_this_time)#"U" OR VARTYPE(llfastfood_order_do_pre)#"U") )) AND VARTYPE(llfastfood_order_do_hold)="U" &&¦pªG¥¼¥´¦L¤Î±Ò¥Î¦¨¥÷ªº¶µ¥Ø,§ó·s¬ÛÃö¦¨¥÷ªº®w¦s
	&&Lihong 2023.04.20 custom for sitem_sub : and (mitem_id<>-1 or undefine=.F.)

		If SQLExec(nhand,"select * from item_material where item_id=?_item_id","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

		Select cun_tmp
		Scan

			_material_id=cun_tmp.material_id
			_qty1=_qty*cun_tmp.qty1			&&¼Æ¶q
			_qty2=_qty*cun_tmp.qty2
			_qty3=_qty*cun_tmp.qty3

			_u1_u2=Iif(cun_tmp.u1_u2=0 Or _qty1=0,1,cun_tmp.u1_u2)
			_u2_u3=Iif(cun_tmp.u2_u3=0 Or _qty2=0,1,cun_tmp.u2_u3)

			_mqty=_qty1*_u1_u2*_u2_u3+_qty2*_u2_u3+_qty3		&&¼Æ¶q(material)

			If _qty3>0 And _qty3>=cun_tmp.u2_u3			&&³æ¦ìÂà´«

				_qty3=0
				_qty2=_qty2+1

			Endif

			If _qty2>0 And _qty2>=cun_tmp.u1_u2

				_qty2=0
				_qty1=_qty1+1

			Endif

*!*				TEXT TO ssql noshow

*!*					DECLARE @max_id int
*!*					SELECT @max_id=ISNULL(MAX(id),0)+1 FROM material_out

*!*						INSERT INTO [material_out]
*!*						           ([id]
*!*						           ,[date]
*!*						           ,[item_id]
*!*						           ,[material_id]
*!*						           ,[unit_id]
*!*						           ,[QTY1]
*!*						           ,[QTY2]
*!*						           ,[QTY3]
*!*						           ,[adduser])
*!*						     VALUES
*!*						           (@max_id
*!*						           ,?DATETIME()
*!*						           ,?_item_id
*!*						           ,?_material_id
*!*						           ,?cun_tmp.unit_id
*!*						           ,?_qty1
*!*						           ,?_qty2
*!*						           ,?_qty3
*!*						           ,?_login_user_name
*!*						           )



*!*				ENDTEXT

*!*				If SQLExec(nhand,ssql)<0

*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				Endif

			TEXT TO ssql_material ADDITIVE TEXTMERGE NOSHOW 


				SELECT @max_id=ISNULL(MAX(id),0)+1 FROM material_out

					INSERT INTO [material_out]
					           ([id]
					           ,[date]
					           ,[item_id]
					           ,[material_id]
					           ,[unit_id]
					           ,[QTY1]
					           ,[QTY2]
					           ,[QTY3]
					           ,[adduser])
					     VALUES
					           (@max_id
					           ,'<<TTOC(DATETIME())>>'
					           ,<<_item_id>>
					           ,<<_material_id>>
					           ,<<IIF(ISNULL(cun_tmp.unit_id),"null",cun_tmp.unit_id)>>
					           ,<<_qty1>>
					           ,<<_qty2>>
					           ,<<_qty3>>
					           ,'<<_login_user_name>>'
					           )



			ENDTEXT

			_mqty =Round(_mqty,4)

*!*				If SQLExec(nhand,"update material set qty=qty-?_mqty where id=?_material_id")<0		&&§ó·s¦¨¥÷®w¦s¼Æ¶q
*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1
*!*				Endif

			TEXT TO ssql_material ADDITIVE TEXTMERGE NOSHOW 
			
				update material set qty=qty-<<_mqty>> where id=<<_material_id>>
			ENDTEXT

		Endscan


	Endif


	ssql_batch = ssql_batch + CHR(13)+CHR(10) + ssql + CHR(13)+CHR(10) + ssql_material 
 
	**  2020.03.28  david    sauna  ----------------
	IF __special_customer="sauna"
	
*!*			&&±N§Þ®v±q¶¤¦C¤¤³]¬°¤£¥Í®Ä

*!*			
*!*			TEXT TO ssql noshow
*!*			
*!*				IF exists( select user_id from sauna_index  where is_active=1 AND  user_id in (select id from sys_user where name=?order_itemlist_tmp.item_code) )
*!*					UPDATE sauna_index SET is_active=0,mark_time=null,marker='',tel='',remark='' WHERE user_id in (select id from sys_user where name=?order_itemlist_tmp.item_code)
*!*			
*!*			ENDTEXT 
*!*			
*!*			
*!*			IF SQLEXEC(nhand, ssql)<0
*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1		
*!*			
*!*			
*!*			ENDIF
*!*			
		
		_remark2 =  _remark2 +TRIM(order_itemlist_tmp.item_code)+","
	
	ENDIF
	*--------------------------




ENDSCAN


If !EMPTY(ssql_batch) AND SQLExec(nhand,ssql_batch)<0

	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

ENDIF


_remark2 = TRIM(_remark2,",")


*!*	&&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ
*!*	ssql="select slip_print, kit_print, inv_print, paylist_print from outlet where id=?_outlet_id"		&&¥ý§R°£,¦A­«·s²K¥[
*!*	If SQLExec(nhand,ssql, "cun_tmp")<0
*!*		Aerror(err)
*!*		Sqlrollback(nhand)
*!*		SQLSetprop(nhand,"Transactions",1)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		Return -1
*!*	ENDIF
*AND NVL(cun_tmp.kit_print, .F.)=.T. 

&&Lihong 2022-09-16 fastfood hold
If __print_to_kitchen And Vartype(_fastfood_save_only)="U" And _onlysave=.F. AND (!Upper(_run_mode)=="DINE" OR _print_to_kitchen_outlet=.T.) AND VARTYPE(llfastfood_order_do_hold)="U" && ¬O§_¦C¦L¼p©Ð³æ ¸ò ³]©w	&&§ÖÀ\¼Ò¦¡¸É³æ¤]¤£¦L &&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ

	If Vartype(__special_customer)#"U" And "goncha"$__special_customer		&& °^¯ù¡ALABEL¤è¦¡¦C¦L¡A¤@©w«ö¤J³æ¦¸§Ç¡A¤£§@¥ô¦ó¦X¨Ã


		Select * From order_itemlist_tmp Into Cursor order_itemprint_tmp Where printed=.F. And onlysave=.F. Order By uid Readwrite

	Else



		Select uid  From order_itemlist_tmp Where  printed=.F. And onlysave=.F. And   item_id=0  Into Cursor  cun_tmp

		If _Tally>0

			Select *,.F. As nogroup From order_itemlist_tmp  Where  printed=.F. And onlysave=.F. And Undefine=.F.  And  item_id>=0   Into Cursor order_itemprint_tmp Readwrite


		Else



*--------------------update by david 2010.05.13   µL½×®MÀ\ÁÙ¬O´²¥sITEM¡A¦Û°Êgroup by


			Select *,.F. As nogroup From order_itemlist_tmp  Where  printed=.F. And onlysave=.F. And Undefine=.F.  And  item_id>=0 Into Cursor order_itemprint_tmp Readwrite 			&&¦pªG¦³¤£¦Pªº¯S§O³B²z¤Î§é¦©,¤£°Ñ»P¥[Á`
*				Select *,.F. As nogroup  From order_itemlist_tmp  Where  printed=.F. And onlysave=.F.   And  item_id>=0     Into Cursor order_itemprint_tmp Readwrite 			&&¦pªG¦³¤£¦Pªº¯S§O³B²z¤Î§é¦©,¤£°Ñ»P¥[Á`

			&&Lihong 2021.04.09 ¼p©Ð³æ¸òÀ\»ù
			REPLACE ALL price WITH level_price FOR item_id>0 AND sitem_sub=.F. AND level_disc=.T. IN order_itemprint_tmp
			
			
			Select order_itemprint_tmp

			Go Top
			Do Whil !Eof()
				Select order_itemprint_tmp

				If  Deleted()

					Skip

					Loop

				Endif

				&&Lihong 2021.05.07 BarCode ¤£¦X¨Ö
				IF print_single = .T.
					SKIP
					LOOP 
				ENDIF 
				
				&&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö
				IF orgqty_case_mat > 0 
					SKIP
					LOOP 
				ENDIF 
				IF qty_entity > 0 
					SKIP
					LOOP 
				ENDIF 

				&&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À
				IF Nvl(kilo,.F.) or Nvl(kilo2,.F.)
					SKIP 
					LOOP 
				ENDIF 
				
				_recn=Recno()
				_parent_id=parent_id
				_item_Id=item_id
				_modi_list=Trim(modi_list)
				_item_price=price
				_printer=Trim(Printer)
				_sprinter=Trim(sprinter)
				_descdisp=Trim(descdisp)

				_hold =hold

				&&Lihong 2021.05.07 BarCode ¤£¦X¨Ö AND print_single=.F.
				Select uid From order_itemprint_tmp Where  item_id=_item_Id  And Trim(descdisp)==_descdisp And parent_id=_parent_id And Trim(modi_list)==_modi_list ;
					AND handwriting=.F. And price=_item_price And Trim(Printer)=_printer And Trim(sprinter)=_sprinter And hold=_hold AND print_single=.F. AND orgqty_case_mat=0 AND qty_entity=0 Into Cursor cr_tmp

				If _Tally>0
					
					&&Lihong 2021.05.07 BarCode ¤£¦X¨Ö AND print_single=.F. &&Lihong 2022.03.17 ¨Ò®u ¼W¥[orgqty_case_mat
					Select Sum(qty) As qty,SUM(orgqty_case_mat) as orgqty_case_mat,SUM(qty_entity) as qty_entity,Sum(amount) As amount,Sum(real_amount) As real_amount,;
						SUM(round_amount) As round_amount,Sum(modi_amount) As modi_amount,Sum(srv_amount) As srv_amount  ;
						FROM order_itemprint_tmp Where  Deleted()=.F.  And  item_id=_item_Id  And Trim(descdisp)==_descdisp  And parent_id=_parent_id And Trim(modi_list)==_modi_list  And handwriting=.F.  And price=_item_price  ;
						And Trim(Printer)=_printer And Trim(sprinter)=_sprinter And hold=_hold AND print_single=.F. AND orgqty_case_mat=0 AND qty_entity=0 ;
						INTO Cursor cun_tmp


					Select order_itemprint_tmp		&& ®MÀ\­Ó´ß¤£¥i¥H§R°£
					
					&&Lihong 2021.05.07 BarCode ¤£¦X¨Ö AND print_single=.F.
					Delete For Recno()<>_recn And sitem=.F. And item_id=_item_Id  And Trim(descdisp)==_descdisp And parent_id=_parent_id And Trim(modi_list)==_modi_list And handwriting=.F.  And price=_item_price ;
						And Trim(Printer)=_printer And Trim(sprinter)=_sprinter And hold=_hold AND print_single=.F. AND orgqty_case_mat=0 AND qty_entity=0 

					Select order_itemprint_tmp

					&&Lihong 2022.03.17 ¨Ò®u ¼W¥[orgqty_case_mat
					Go _recn 
					Replace qty With cun_tmp.qty,orgqty_case_mat WITH cun_tmp.orgqty_case_mat,qty_entity WITH cun_tmp.qty_entity,amount With cun_tmp.amount,real_amount With cun_tmp.real_amount ,round_amount With cun_tmp.round_amount ,;
						modi_amount With cun_tmp.modi_amount,srv_amount With cun_tmp.srv_amount,parent_id With _parent_id

				Endif


				Select order_itemprint_tmp
				Go _recn

				Skip

			Enddo

			If Used("cr_tmp")

				Use In cr_tmp

			Endif




		Endif





		&&Lihong 2022.06.14
		SELECT * FROM order_itemlist_tmp WHERE sitem AND uid NOT in (SELECT uid FROM order_itemprint_tmp) AND uid in (SELECT INT(uid) FROM order_itemprint_tmp) INTO CURSOR cun_tmp000
		SELECT order_itemprint_tmp 
		APPEND FROM DBF("cun_tmp000")
		Use In SELECT("cun_tmp000")

*------------------------------------------------------------------------  UPDATE  2010.12.20   ¥[¤J¥´¦L¦¸§Ç

		If Vartype(__kit_print_order)#"U" And Upper(__kit_print_order)#"INPUT"

			Do Case

				Case Upper(__kit_print_order)="AMT"			&&½s¸¹¥[Á`¦A«öª÷ÃB±Æ§Ç(¥Ñ¤j¨ì¤p) 

					&&Lihong 2022.06.14 
					*Select * From order_itemprint_tmp Order By amount Desc   Into  Cursor cun_tmp000 
					Select amount as amount_sort, * From order_itemprint_tmp Into  Cursor order_itemprint_tmp READWRITE 
					UPDATE a SET a.amount_sort=NVL(b.amount,0) from order_itemprint_tmp a left join (select uid, amount from order_itemprint_tmp WHERE sitem_sub=.F. AND item_id<>0) b on INT(a.uid)=b.uid 
					Select * From order_itemprint_tmp Order By amount_sort Desc, uid  Into  Cursor cun_tmp000 

				Case Upper(__kit_print_order)="QTY"			&&½s¸¹¥[Á`¦A«ö¼Æ¶q±Æ§Ç(¥Ñ¤j¨ì¤p)

					&&Lihong 2022.06.14 
					*Select * From order_itemprint_tmp Order By qty Desc Into  Cursor cun_tmp000
					Select qty as qty_sort, * From order_itemprint_tmp Into  Cursor order_itemprint_tmp READWRITE 
					UPDATE a SET a.qty_sort=NVL(b.qty,0) from order_itemprint_tmp a left join (select uid, qty from order_itemprint_tmp WHERE sitem_sub=.F. AND item_id<>0) b on INT(a.uid)=b.uid 
					Select * From order_itemprint_tmp Order By qty_sort Desc, uid  Into  Cursor cun_tmp000 

				Otherwise									&&½s¸¹¥[Á`¦A«ö½s¸¹±Æ§Ç(¥Ñ¤j¨ì¤p)

					&&Lihong 2022.06.14 
					*Select * From order_itemprint_tmp  Order By item_code Desc Into Cursor cun_tmp000 
					Select item_code as item_code_sort, * From order_itemprint_tmp Into  Cursor order_itemprint_tmp READWRITE 
					UPDATE a SET a.item_code_sort=NVL(b.item_code,"") from order_itemprint_tmp a left join (select uid, item_code from order_itemprint_tmp WHERE sitem_sub=.F. AND item_id<>0 ) b on INT(a.uid)=b.uid 
					Select * From order_itemprint_tmp Order By item_code_sort Desc, uid  Into  Cursor cun_tmp000 

			Endcase


			Select * From cun_tmp000 Into Cursor order_itemprint_tmp Readwrite

			Use In cun_tmp000


		Endif


	Endif


*-----------------------------------------------------------
	_member_name=""
	_member_cardno=""

	If Vartype(__kit_order_print_member_code)="L" And Vartype(__kit_order_print_member_name)="L"			&&¼p©Ð³æ¬O§_¦C¦L·|­û½s¸¹

		If _member_no>0
			If __kit_order_print_member_name
				_member_name=Trim(work_order_tmp17.name_cn)
			Endif

			If __kit_order_print_member_code

				_member_cardno=Trim(work_order_tmp17.cardno)
			Endif


		Endif


	Endif


	If Vartype(__special_customer)#"U" And __special_customer="paisanos" And _run_mode="fastfood"

		Public _paisanos_remark

		_paisanos_remark=_tel+Chr(13)+_addr


	Endif


	Local LcFastFood_info
	LcFastFood_info=_FastFood_info

	If Vartype(__kit_order_print_outlet)#"U" And __kit_order_print_outlet		&&

		Select  work_order_tmp9
		Locate For Id=_outlet_id

		If Found()
			LcFastFood_info ="("+ Iif(_system_langue="CN",Trim(desccn),Trim(Descen)) +")" + _FastFood_info

		Endif

	Endif


	_login_user_name_bak = _login_user_name
	
	
	If Vartype(__special_customer)#"U" And UPPER(ALLT(__special_customer))="BBB"
	
	
		group_print_data()

	
	
	ENDIF
		
*!*		&&Lihong 2022.06.28 ¥»¾÷¥´¦L¼p©Ð³æ
*!*		IF VARTYPE(__local_printer_for_kit)="U"
*!*			PUBLIC __local_printer_for_kit
*!*			__local_printer_for_kit = 0

*!*			*_computer=getcomputername()
*!*			IF VARTYPE(__sys_pay_printer)#"U" AND !EMPTY(__sys_pay_printer) AND VARTYPE(__pay_print_to_local)#"U" AND __pay_print_to_local 
*!*				select work_order_tmp12
*!*				LOCATE FOR TRIM(printer)==__sys_pay_printer AND station_id=__station_id 
*!*				__local_printer_for_kit = work_order_tmp12.id
*!*			ENDIF 
*!*			IF __local_printer_for_kit = 0 AND VARTYPE(__sys_inv_printer)#"U" AND !EMPTY(__sys_inv_printer) AND VARTYPE(__inv_print_to_local)#"U" AND __inv_print_to_local 
*!*				select work_order_tmp12
*!*				LOCATE FOR TRIM(printer)==__sys_inv_printer AND station_id=__station_id 
*!*				__local_printer_for_kit = work_order_tmp12.id
*!*			ENDIF 

*!*	*!*			TEXT TO ssql noshow
*!*	*!*				select id from printerset  where printer=?__sys_pay_printer and station_id=(select id from station where computer=?_computer)
*!*	*!*				union select id  from printerset  where printer=?__sys_inv_printer and station_id=(select id from station where computer=?_computer)

*!*	*!*			ENDTEXT
*!*	*!*			If SQLExec(nhand,ssql,"cun_tmp")<0
*!*	*!*				Aerror(err)
*!*	*!*				Sqlrollback(nhand)
*!*	*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*	*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*	*!*				Return -1
*!*	*!*			ENDIF
*!*			
*!*	*!*			__local_printer_for_kit=Trim(cun_tmp.Printer)
*!*		ENDIF 
*!*		*

*!*		&&Lihong 2023-06-02 ¼pÅã 
*!*		Select a.*, IIF(ISNULL(b.id),NVL(bb.local_print_kit, .F.),NVL(b.local_print_kit, .F.)) as local_print_kit FROM order_itemlist_tmp a LEFT JOIN work_order_tmp b ON a.item_id=b.id LEFT JOIN work_order_tmp0 bb ON a.item_id=bb.id ;
*!*		WHERE a.sitem=.F. AND EMPTY(NVL(a.kit_disp_uid,"")) INTO CURSOR order_itemlist_to_printer READWRITE 
*!*		SCAN 
*!*			If order_item_print("order_itemlist_to_printer",_order_id,.F.,'',.F.,.F.,.F.,(_outlet_id=0),LcFastFood_info,_tableno)=-1			&&Àò¨ú¿é¥X¥´¦L¾÷
*!*				Return  -1
*!*			Endif
*!*		ENDSCAN 


	&&Lihong 2022.09.27 bb
	Select a.*, IIF(ISNULL(b.id),NVL(bb.local_print_kit, .F.),NVL(b.local_print_kit, .F.)) as local_print_kit FROM order_itemprint_tmp a LEFT JOIN work_order_tmp b ON a.item_id=b.id LEFT JOIN work_order_tmp0 bb ON a.item_id=bb.id INTO CURSOR order_itemprint_tmp READWRITE &&Lihong 2022.06.28 ¥»¾÷¥´¦L¼p©Ð³æ
	Scan

		_login_user_name =order_itemprint_tmp.adduser


		If order_item_print("order_itemprint_tmp",_order_id,.F.,'',.F.,.F.,.F.,(_outlet_id=0),LcFastFood_info,_tableno)=-1			&&¿é¥X¥´¦L

			_login_user_name = _login_user_name_bak

			Release _paisanos_remark
			Return  -1

		Endif

		_dispord=_dispord+1



	ENDSCAN


	

	LOCAL nSplit , nRecStar ,nRecEnd,nTotalRec
	nRecStar =1
	nTotalRec=RECCOUNT("order_itemlist_tmp")



	SELECT RECNO()  as rec  FROM order_itemlist_tmp WHERE item_id= -10 INTO  CURSOR  split_tmp READWRITE 		&&¦pªG¦³¤À³æ¦C¦L¤è¦¡¡A

	IF _tally>0   AND __inv_print_to_local
		

		SELECT split_tmp
		GO BOTTOM 
		
		IF rec<>nTotalRec
		
			APPEND BLANK 
			REPLACE rec WITH nTotalRec
			
		ENDIF
		

		nSplit = RECCOUNT("split_tmp")
		
		
		LOCAL nStar
		
		
		FOR nStar=1 TO nSplit 
		
				IF nSplit>1
				
					
					SELECT split_tmp
					
					GO nStar
					
					nRecEnd=split_tmp.rec
				
				
					nSplit_print_mode=1
					
			
					
					SELECT * FROM order_itemlist_tmp WHERE RECNO()>=nRecStar  AND RECNO()<=nRecEnd AND item_id>0 ;
						INTO CURSOR order_itemprint_tmp READWRITE 
					
					nRecStar  =nRecEnd 
					
					UPDATE  order_itemprint_tmp  SET PRINTER= __INV_PRINTER
					
				
				
				ENDIF
		

				_split_Pid="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")	
					

				Select order_itemprint_tmp
				Scan

					_login_user_name =order_itemprint_tmp.adduser


					If order_item_print("order_itemprint_tmp",_order_id,.F.,'',.F.,.F.,.F.,(_outlet_id=0),LcFastFood_info,_tableno)=-1			&&¿é¥X¥´¦L

						_login_user_name = _login_user_name_bak

						Release _paisanos_remark
						Return  -1

					Endif

					_dispord=_dispord+1



				ENDSCAN
		
		
			ENDFOR
			
	ENDIF

		
	

	Release _paisanos_remark

	_login_user_name = _login_user_name_bak


	If Used("order_itemprint_tmp")

		Use In order_itemprint_tmp

	ENDIF
	
	

Endif


&&Lihong 2022.04.15 ¯ùªã¤£§@¬°¤Wµæ¯È§P©w
lccup_item_ids = ""
IF VARTYPE(__cup)#"U" AND __cup 
*!*	IF Used("work_order_tmp9")=.F. Or Get_table_updateno("outlet")<0
*!*		ssql="select * from outlet"
*!*		If SQLExec(nhand,ssql,"work_order_tmp9")<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions" ,1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1
*!*		Endif
*!*	Endif
	lccup_item_ids = ""
	SELECT work_order_tmp9 &&Àç·~°Ï°ì
	LOCATE FOR id = _outlet_id
	IF FOUND() AND !EMPTY(NVL(item_id_cup_list,""))
		lccup_item_ids = "," + ALLTRIM(work_order_tmp9.item_id_cup_list)
	ENDIF 
ENDIF 
*

&&Lihong 2022.04.15 ³o­ÓN¦bLOWER(_run_mode)="dine" AND nSplitNo=0³Q­«¸m
Select order_itemlist_tmp &&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯Èbug: ¼W¥[or just_send=.T.
Count To N FOR (printed=.F. OR just_send=.T.) And Undefine=.F. And (item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) ) And slip_Print AND (EMPTY(lccup_item_ids) OR sitem_sub =.T. OR sitem_sub =.f. AND !("," + TRANSFORM(item_id) + "," $ lccup_item_ids) )
&&Lihong 2020.04.20 OR INLIST 2020.06.02 coupon item_id= -51  &&Lihong 2022.04.15 ¯ùªã¤£§@¬°¤Wµæ¯È§P©w


Local ll_print_slip

If _run_mode<>"fastfood"  And Vartype(__dine_fastfood_print_slip)#"U" And _outlet_id=0		&&°ó®y¼Ò¦¡¥~½æ³æ


	Do Case

		Case  Upper(__dine_fastfood_print_slip)="DISABLE"

			ll_print_slip=.F.

		Case Upper(__dine_fastfood_print_slip)="ENABLE"

			ll_print_slip=.T.

		Otherwise


			ll_print_slip=__print_slip

	Endcase

*!*		IF VARTYPE(_work_order_send_print_slip)#"U" AND _work_order_send_print_slip
*!*			ll_print_slip=.T.
*!*		ENDIF 

Else


	ll_print_slip=__print_slip

*!*		IF VARTYPE(_work_order_send_print_slip)#"U" AND _work_order_send_print_slip
*!*			ll_print_slip=.T.
*!*		ENDIF 

ENDIF

&&Lihong 2021.10.08 &&Àç·~°Ï°ì¬O§_¦C¦L¤Wµæ¯È/µo²¼/¥I´Ú²M³æ
ssql="select slip_print, inv_print, paylist_print from outlet where id=?_outlet_id"		&&¥ý§R°£,¦A­«·s²K¥[
If SQLExec(nhand,ssql, "cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
ENDIF
ll_print_slip = (ll_print_slip AND NVL(cun_tmp.slip_print, .F.) )


&&Lihong 2020.04.08 ¦Û§U¤U³æ(¦b©±¦Y ±a¨« °eÀ\)¤£¨ü__print_slip¡]¥]¬A__dine_fastfood_print_slip¡^±±¨î
&&Lihong 2020.07.06 VARTYPE(__pso_slip_print_id )#"U" §ï¬° __pso_print_slip 
IF VARTYPE(__pso_order)#"U" AND VARTYPE(__pso_print_slip)#"U" 
	ll_print_slip = .T.
ENDIF 
&&Lihong 2020.11.05 ¼W¥[__proan_web_so_print_slip
IF VARTYPE(__pso_order)#"U" AND VARTYPE(__proan_web_so_print_slip)#"U" AND __proan_web_so_print_slip=.F.
	ll_print_slip = .F.
ENDIF 

IF _onlysave  

	ll_print_slip = .f.

	IF VARTYPE(__slip_print_patch)#"U" AND __slip_print_patch   AND VARTYPE(_resave_order)="U"
	
		ll_print_slip = .T.
	
	ENDIF

ENDIF



*----------------
ssql_batch = ""
&&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split
ELSE 
*!*		ssql="if exists (select id from order_modi where id=?_order_id) delete from order_modi where id=?_order_id"		&&¥ý§R°£,¦A­«·s²K¥[
*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1

*!*		Endif
	ssql_batch = "if exists (select id from order_modi where id="+TRANSFORM(_order_id)+") delete from order_modi where id="+TRANSFORM(_order_id) 
ENDIF 


Select order_itemlist_tmp
Scan
	&&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split 
		IF RECNO("order_itemlist_tmp")<=lnvs_so_add_pre_recno
			LOOP 
		ENDIF 
	ENDIF 
	Select  order_itemlist_tmp

	Select * From  item_modi_tmp Where item_id=order_itemlist_tmp.uid Order By modi_idx Into Cursor cun_tmp 	&&«O¦s¯S§O³B²z
	Select cun_tmp
	Scan
*!*			ssql="insert into order_modi (id,item_id,modi_id,descdisp,modi_qty,modi_price,modi_per,modi_amount,dispord,multqty,def_id,open_modi,modi_need,modi_must,modi_idx,def_idx)"+;
*!*				" values (?_order_id,?cun_tmp.item_id,?cun_tmp.modi_id,?cun_tmp.descdisp,?cun_tmp.modi_qty,"+;
*!*				"?cun_tmp.modi_price,?cun_tmp.modi_per,?cun_tmp.modi_amount,?RECNO(),?cun_tmp.multqty,?cun_tmp.def_id,?cun_tmp.open_modi,"+;
*!*				"?cun_tmp.modi_need,?cun_tmp.modi_must,?cun_tmp.modi_idx,?cun_tmp.def_idx)"

		TEXT TO ssql TEXTMERGE NOSHOW 
		insert into order_modi (id,item_id,modi_id,descdisp,modi_qty,modi_price,modi_per,modi_amount,dispord,multqty,def_id,open_modi,modi_need,modi_must,modi_idx,def_idx)
			 values (?_order_id,<<cun_tmp.item_id>>,<<cun_tmp.modi_id>>,'<<STRTRAN(TRIM(cun_tmp.descdisp), "'", "''")>>',<<cun_tmp.modi_qty>>,
			<<cun_tmp.modi_price>>,<<cun_tmp.modi_per>>,<<cun_tmp.modi_amount>>,<<RECNO()>>,<<IIF(cun_tmp.multqty,1,0)>>,<<cun_tmp.def_id>>,<<IIF(cun_tmp.open_modi,1,0)>>,
			<<IIF(cun_tmp.modi_need,1,0)>>,<<IIF(cun_tmp.modi_must,1,0)>>,<<cun_tmp.modi_idx>>,'<<TRIM(cun_tmp.def_idx)>>')
		ENDTEXT 
		
		lcvs_so_add_split_ssql = STRTRAN(ssql, "?_order_id,", "?lnvs_so_add_split_order_id,",1,1,1)
		
*!*			If SQLExec(nhand,ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return -1

*!*			Endif

		&&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
		IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split AND VARTYPE(llvs_so_add_order_split_have_sub)#"U" AND llvs_so_add_order_split_have_sub=.T.
*!*				If SQLExec(nhand,lcvs_so_add_split_ssql)<0
*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions" ,1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*					Return -1

*!*				Endif
			ssql = ssql  + CHR(13)+CHR(10) + lcvs_so_add_split_ssql
		ENDIF 
		
		ssql_batch = ssql_batch + CHR(13)+CHR(10) + ssql 
	Endscan


Endscan
If !EMPTY(ssql_batch) AND SQLExec(nhand,ssql_batch)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif
*---------

IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
ELSE 
	ssql="if exists (select id from order_itemdisc where id=?_order_id )delete from order_itemdisc where id=?_order_id"		&&¥ý§R°£,¦A­«·s²K¥[
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	Select 	item_disc_tmp &&save item disc   «O¦s¶µ¥Ø§é¦© &&Lihong 2020.06.02 coupon   coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code
	Scan
		ssql="insert into order_itemdisc (id,item_id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_remark,disc_qty,minamt,dedu_srv, coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code,after_inv) values ("+;
			"?_order_id,?item_disc_tmp.item_id,?item_disc_tmp.member_id,?item_disc_tmp.disc_id,?item_disc_tmp.disc_type,?item_disc_tmp.disc_per,"+;
			"?item_disc_tmp.disc_amount,?RECNO(),?item_disc_tmp.adduser,?item_disc_tmp.disc_reason,?item_disc_tmp.disc_remark,?item_disc_tmp.disc_qty,?item_disc_tmp.minamt,?item_disc_tmp.dedu_srv, " +;
			"?IIF(EMPTY(item_disc_tmp.coupon_lock_valid),null,item_disc_tmp.coupon_lock_valid), ?item_disc_tmp.cloud_coupon_id, ?IIF(EMPTY(item_disc_tmp.web_coupon_id),null,item_disc_tmp.web_coupon_id), ?item_disc_tmp.web_coupon_code, ?item_disc_tmp.after_inv )"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif
	Endscan
ENDIF 

*------------------

IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
ELSE 
	ssql="if exists (select id from order_disc where id=?_order_id) delete from order_disc where id=?_order_id"		&&¥ý§R°£,¦A­«·s²K¥[
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	Select order_disc_tmp  &&save order disc   «O¦s¾ã³æ§é¦©
	Scan
		ssql="insert into order_disc (id,member_id,disc_id,disc_type,disc_per,disc_amount,dispord,adduser,disc_reason,disc_remark,disc_qty,autodisc,points,member_number,member_name,minamt,dedu_srv,after_inv) values ("+;
			"?_order_id,?order_disc_tmp.member_id,?order_disc_tmp.disc_id,?order_disc_tmp.disc_type,?order_disc_tmp.disc_per,"+;
			"?order_disc_tmp.disc_amount,?RECNO(),?order_disc_tmp.adduser,?order_disc_tmp.disc_reason,?order_disc_tmp.disc_remark,?order_disc_tmp.disc_qty,"+;
			"?order_disc_tmp.autodisc,?order_disc_tmp.points,?order_disc_tmp.member_number,?order_disc_tmp.member_name,?order_disc_tmp.minamt,?order_disc_tmp.dedu_srv,?order_disc_tmp.after_inv)"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

	Endscan
ENDIF 

*------------------		2009.12.10  ³¡ªù¤À±b kkk
IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
ELSE 
*!*		ssql="if exists (select order_id from order_itemdept where order_id=?_order_id) delete from order_itemdept where order_id=?_order_id"
*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1
*!*		Endif
	ssql_batch = "if exists (select order_id from order_itemdept where order_id="+TRANSFORM(_order_id)+") delete from order_itemdept where order_id="+TRANSFORM(_order_id) + CHR(13)+CHR(10)

	Select order_dept_tmp
	Scan

*!*			ssql="insert into order_itemdept (order_id,parent_id,item_id,dept_id,amount,srvamt) values (?_order_id,?order_dept_tmp.parent_id,?order_dept_tmp.item_id,?order_dept_tmp.dept_id,?order_dept_tmp.amount,?order_dept_tmp.srvamt)"
*!*			If SQLExec(nhand,ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return -1
*!*			Endif

		TEXT TO ssql_batch ADDITIVE TEXTMERGE NOSHOW 
		
		insert into order_itemdept (order_id,parent_id,item_id,dept_id,amount,srvamt) values (?_order_id,<<order_dept_tmp.parent_id>>,<<order_dept_tmp.item_id>>,<<order_dept_tmp.dept_id>>,<<order_dept_tmp.amount>>,<<order_dept_tmp.srvamt>>)
		ENDTEXT 
	ENDSCAN
	
	If SQLExec(nhand,ssql_batch)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif
ENDIF 

*-----------------------		&&µ|¶µ
IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
ELSE 
	ssql="if exists (select id from order_tax where id=?_order_id) delete from order_tax where id=?_order_id"

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	Select order_tax_tmp
	Scan

		ssql="insert into order_tax (id,item_id,tax_id,tax_per,tax_amount) values (?_order_id,?order_tax_tmp.parent_id,?order_tax_tmp.tax_id,?order_tax_tmp.tax_per,?order_tax_tmp.amount)"
		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif


	Endscan
ENDIF 

*--------->Âà»ù

If Vartype(_cp_log_Id)#"U"			&&¦pªG¦³¥¼«O¦sorder_idªºcp_log

	If SQLExec(nhand,"update cp_log set order_id=?_order_id where id=?_cp_log_id")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

Endif

*N = 0 &&Lihong 2020.04.08 
If LOWER(_run_mode)="dine" AND nSplitNo=0 OR VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split		&&·í°ó®y¼Ò¦¡®É¡AÀË¬d¬O§_¦³®É¶¡Äµ§iªº item («D¤À³æ¡^ &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode) or 

	
	lcAddParam  = ""

	IF LOWER(__special_customer)="urawa"
	
		SELECT order_itemlist_tmp 
		SUM warning_inMinute  TO _timer_minute FOR item_warning 
		
		SELECT MAX(warning_inMinute) as warning_inMinute  FROM  order_itemlist_tmp WHERE item_warning = .f. INTO CURSOR cr_tmp
		
		_timer_minute= _timer_minute + NVL(cr_tmp.warning_inMinute,0)
		
		_timer_endtime =_begintime + _timer_minute*60	&& timer_endtime
		
		lcAddParam = ",timer_minutes=?_timer_minute"
		
			
		ssql ="update tables set timer_minutes=?_timer_minute where tableno=?_tableno and nsubtable=0"
		
	
	
	ELSE
	
	
	


			Select Top 1 warning_begtime,warning_endtime,warning_inMinute From order_itemlist_tmp Where item_warning Order By warning_begtime Into Cursor cun_tmp

			If _Tally>0
			
			

					If cun_tmp.warning_inMinute>0
						
						_warning_begtime=Left(Ttoc(_begintime,2),5)		&& warning_begtime
						_warning_endtime=Left(Ttoc(_begintime+cun_tmp.warning_inMinute*60,2),5)	&& warning_endtime

						ssql="update tables set item_warning=1,warning_begtime=?_warning_begtime,warning_endtime=?_warning_endtime " +;
							" where tableno=?_tableno and nsubtable=0"


					Else

						ssql="update tables set item_warning=1,warning_begtime=?cun_tmp.warning_begtime,warning_endtime=?cun_tmp.warning_endtime "+;
							" where tableno=?_tableno and nsubtable=0"

					ENDIF
				
				

							

			Else

				TEXT TO ssql noshow
						if exists (select * from tables  with(nolock) where item_warning=1 and tableno=?_tableno and nsubtable=0)
							update tables set item_warning=0,warning_begtime='00:00',warning_endtime='00:00'
							 where tableno=?_tableno and nsubtable=0

				ENDTEXT


			ENDIF
	
	
	ENDIF
	

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	&&Lihong 2021.11.24 cut order
	IF VARTYPE(lncalc_cut_order_min) = "U" AND Vartype(_inv_chnage_mode)="U" AND Upper(_run_mode)="DINE"
		local  lnRemainQty, lncalc_cut_order_min, lncalc_sit_in_min
		lnRemainQty = 0
		lncalc_cut_order_min = 0.00
		lncalc_sit_in_min = 0.00
		IF calc_cut_order(_pplcnt, @lncalc_cut_order_min, @lncalc_sit_in_min, @lnRemainQty ) = .F.
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			RETURN -1
		ENDIF 
	ENDIF 

	Select order_itemlist_tmp
	Count To N For hold>0 Or Undefine  OR ( amtinv AND price=0)		&&¬O§_¦³¥s°_©Î¥¼©wµæ¦¡ ©Î¹sª÷ÃB¤£¤¹³\¦C¦Lªºµæ¦¡

	_have_unfinish=Iif(N>0,1,0)
 
	ssql="update tables set order_id=?_order_id,order_uid=?_order_uid,still_sitting=0,ppl=?_pplcnt  ,have_unfinish=?_have_unfinish, updateno=ISNULL(updateno,0)+1,timer_endtime=?_order_timer_endtime,remark2= ?_remark2 where tableno=?_tableno and nsubtable=0"
	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	ELSE 
		ssql=ssql+Chr(10)+"if exists (select tableno from tables with (nolock)  where status='P'  and  tableno=?_tableno   and nsubtable=0)  update tables set status='T' where tableno=?_tableno  and nsubtable=0"
	ENDIF &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	
	&&Lihong 2021.11.24 cut order
	IF VARTYPE(lncalc_cut_order_min) = "N"
		*lncalc_cut_order_min = IIF(lncalc_cut_order_min = 0, null, lncalc_cut_order_min)
		*lncalc_sit_in_min = IIF(lncalc_sit_in_min = 0, null, lncalc_sit_in_min)
		*ssql=ssql+Chr(10)+"update tables set cut_time=DATEADD(mi, ?lncalc_cut_order_min, begindate), off_time=DATEADD(mi, ?lncalc_sit_in_min, begindate) where tableno=?_tableno  and nsubtable=0 "
		IF (VARTYPE(__vs_save_order)#"U" AND __vs_save_order = .t. OR VARTYPE(_android_call_save_order)#"U" AND _android_call_save_order = .T.) AND VARTYPE(_sit_time)#"U"
			_sit_time_cut_order = TTOC(_sit_time)
			TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW 
			
			update tables set cut_time=<<IIF(lncalc_cut_order_min = 0, "null", "DATEADD(mi, ?lncalc_cut_order_min, ?_sit_time)" )>>, 
			off_time=<<IIF(lncalc_sit_in_min = 0, "null", "DATEADD(mi, ?lncalc_sit_in_min, ?_sit_time)" )>> where tableno=?_tableno  and nsubtable=0 
			ENDTEXT 
		ELSE 
			TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW 
			
			update tables set cut_time=<<IIF(lncalc_cut_order_min = 0, "null", "DATEADD(mi, ?lncalc_cut_order_min, begindate)" )>>, 
			off_time=<<IIF(lncalc_sit_in_min = 0, "null", "DATEADD(mi, ?lncalc_sit_in_min, begindate)" )>> where tableno=?_tableno  and nsubtable=0 
			ENDTEXT 
		ENDIF  
	ENDIF 
	
	IF SQLEXEC(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1	
	
	ENDIF

	&&Lihong 2022.03.25 ¦L³æ«á¦A¤J¹sª÷ÃBµæ¦¡(ª÷ÃB¥¼ÅÜ)À\Âiª¬ºA¤£ÅÜ(by setting)
	IF _dine_only_zero_amt_item_save_order = .T. AND _dine_only_zero_amt_item &&LOWER(_run_mode)="dine" AND nSplitNo=0
		DIMENSION inv_langue(1)
		inv_langue(1)=_system_langue
		IF VARTYPE(__inv_print_to_local)="U"
			__inv_print_to_local = .F.
		ENDIF 
		_prt_inv_no_p = .T.
		_lninv_no=save_to_inv(_order_id,@inv_langue,1,_tableno,.F.,lninv_id_zero_item,.T. , "DINE")			&&«O¦sµo²¼-->¤£¿é¥X¥´¦L
		IF _lninv_no<0
			*Sqlrollback(nhand)
			*SQLSetprop(nhand,"Transactions",1)							
			Return -1	
		ENDIF
	ENDIF 

	IF VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	ELSE 
		Select  order_itemlist_tmp 	&&«O¦s¸¨³æ²Ó¸`	save to order_detail   ,¥þ³¡ªºprinted ³]¬°1
		COUNT TO n FOR item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) &&Lihong 2020.04.20 OR INLIST 2020.06.02 coupon item_id= -51
		
		IF n=0
			ssql="update tables set status='S' where tableno=?_tableno  and nsubtable=0"
		ELSE
			ssql="update tables set status='U' where tableno=?_tableno  and (status='S' or status='')  and nsubtable=0"

		ENDIF
		
		IF SQLEXEC(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1	
		
		
		ENDIF
	ENDIF 
Endif


&&±N§Þ®v±q¶¤¦C¤¤³]¬°¤£¥Í®Ä

IF __special_customer="sauna" AND VARTYPE(llfastfood_order_do_hold)="U" &&Lihong 2022-09-16 fastfood hold 
	SELECT a.ordertime,b.user_id FROM order_itemlist_tmp a  LEFT JOIN  sauna_user_tmp b ON a.item_code = b.code WHERE a.item_code in (SELECT code FROM sauna_user_tmp) INTO CURSOR cr_tmp  ORDER BY ordertime DESC 
	_active_time =cr_tmp.ordertime +  90*60 &&90¤ÀÄÁ«á¦Û°Ê¥Í®Ä
	SELECT cr_tmp
	SCAN
		TEXT TO ssql noshow
			UPDATE sauna_index SET is_working=1,is_active=0,mark_time=null,marker='',tel='',remark='',createtime=?_active_time  WHERE user_id =?cr_tmp.user_id
		ENDTEXT 
		
		IF SQLEXEC(nhand, ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1		
		
		
		ENDIF
				
		
	ENDSCAN
	

ENDIF



*-----------------------------
If Vartype(_no_commit_this_time)="U"		&&  ¤£¥ß§Y´£¥æ

	If  Sqlcommit(nhand)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

	SQLSetprop(nhand,"Transactions",1)


Endif

*!*	 	Select  order_itemlist_tmp 	&&«O¦s¸¨³æ²Ó¸`	save to order_detail   ,¥þ³¡ªºprinted ³]¬°1
*!*		COUNT TO n FOR item_id>0 AND printed= .f.
 
 	IF VARTYPE(__order_item_delete)#"U"
 		_must_print_slip = .t.
 	ENDIF
 	
 	RELEASE __order_item_delete
 
&&Lihong 2022.03.25 ¦L³æ«á¦A¤J¹sª÷ÃBµæ¦¡(ª÷ÃB¥¼ÅÜ)À\Âiª¬ºA¤£ÅÜ(by setting)
IF (VARTYPE(_dine_only_zero_amt_item)#"U" AND _dine_only_zero_amt_item AND LOWER(_run_mode)="dine" AND nSplitNo=0) OR (VARTYPE(llvs_so_add_order_split)#"U" AND llvs_so_add_order_split) &&Lihong 2022.10.20 ¦L³æ«á¦A¤Jitem ¤À³æ (Qrcode)
	ll_print_slip = .F. &&¤£¥´¦L¤Wµæ¯È
ENDIF 

*!*	&&Lihong 2022.04.15 ¯ùªã¤£§@¬°¤Wµæ¯È§P©w
*!*	*!*	IF Used("work_order_tmp9")=.F. Or Get_table_updateno("outlet")<0
*!*	*!*		ssql="select * from outlet"
*!*	*!*		If SQLExec(nhand,ssql,"work_order_tmp9")<0
*!*	*!*			Aerror(err)
*!*	*!*			Sqlrollback(nhand)
*!*	*!*			SQLSetprop(nhand,"Transactions" ,1)
*!*	*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*	*!*			Return -1
*!*	*!*		Endif
*!*	*!*	Endif
*!*	lccup_item_ids = ""
*!*	SELECT work_order_tmp9 &&Àç·~°Ï°ì
*!*	LOCATE FOR id = _outlet_id
*!*	IF FOUND() AND !EMPTY(NVL(item_id_cup_list,""))
*!*		lccup_item_ids = "," + ALLTRIM(work_order_tmp9.item_id_cup_list)
*!*	ENDIF 
&&Lihong 2022.04.15 ¤W­±N¦ü¥G¨S¥Î ³o¸Ì­«ºâ
Select order_itemlist_tmp &&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯Èbug: ¼W¥[or just_send=.T.
Count To N FOR (printed=.F. OR just_send=.T.) And Undefine=.F. And (item_id>0 OR INLIST(item_id, -199, -111, -110, -104, -103, -102, -101, -51) ) And slip_Print AND (EMPTY(lccup_item_ids) OR sitem_sub =.T. OR sitem_sub =.f. AND !("," + TRANSFORM(item_id) + "," $ lccup_item_ids) )
 
IF VARTYPE(_work_order_send_print_slip)#"U" AND _work_order_send_print_slip
	ll_print_slip=.F.
ENDIF 

IF VARTYPE(llfastfood_order_do_hold)#"U" &&Lihong 2022-09-16 fastfood hold
	IF VARTYPE(__fastfood_hold_inv_print)#"U" AND __fastfood_hold_inv_print
		ll_print_slip = .T.
		__pso_order_save_inv_online=.F.
		*_no_print_slip=.F.
		_must_print_slip=.T.
	ELSE 
		ll_print_slip = .F. &&¤£¥´¦L¤Wµæ¯È
	ENDIF 
ENDIF 

&&Lihong 2022.11.17
IF VARTYPE(llfastfood_order_do_pre)#"U" AND _order_change=.T. &&Lihong 2023.03.10 _order_change=.T.
	ll_print_slip = .T.
	__pso_order_save_inv_online=.F.
	*_no_print_slip=.F.
	_must_print_slip=.T.
ENDIF 
 
&&Lihong 2020.04.14 __pso_order_save_inv_online(_run_mode="fastfood",  _isfastfood=.T.)
*If   ll_print_slip And _run_mode<>"fastfood" 	And   _no_print_slip=.F.  And (N>0 OR _must_print_slip)	 AND VARTYPE(_ORDER_SAVE_NO_P)="U"	&&--------------------------¥´¦L²M³æ (§ÖÀ\¼Ò¦¡¤£¦C¦L)
If   ll_print_slip And (_run_mode<>"fastfood" OR VARTYPE(__pso_order_save_inv_online)#"U") AND _no_print_slip=.F.  And (N>0 OR _must_print_slip) AND VARTYPE(_ORDER_SAVE_NO_P)="U"	&&--------------------------¥´¦L²M³æ (§ÖÀ\¼Ò¦¡¤£¦C¦L)
	_print_barcode=(Upper(_run_mode)="BARCODE")	&&¬O§_¦C¦L±ø½X
	_print_all=Iif(Vartype(_void_item_slip_print_all)="L",.T.,.F.)
	_voiditem  =_print_all

	IF VARTYPE(llfastfood_order_do_hold)#"U" AND VARTYPE(__fastfood_hold_inv_print)#"U" AND __fastfood_hold_inv_print OR VARTYPE(llfastfood_order_do_pre)#"U" &&Lihong 2022-09-16 fastfood hold &&Lihong 2022.11.17 do_pre
		_print_barcode = .T.	&&¬O§_¦C¦L±ø½X
		_print_all = .T.
		_voiditem  = .F.
		*_FastFood_info = _FastFood_info + "(¼È¦s)"
	ENDIF 

	Select order_itemlist_tmp		&& ---update  2009.05.12  ¥[¤J¤Wµæ¯È¤£¦C¦L·s¼Wµæ¦¡ªº¿ï¾Ü
	Count To N For printed AND !just_send And Undefine=.F. And item_id>0 And slip_Print &&Lihong 2020.07.30 °e³æ«á¤£¥´¤Wµæ¯È:AND !just_send 

	If Lower(__slip_print_mode)="first" And N>0  And _print_all=.F.

** no slip print

	Else

		_curtime=Time()

		Select id  From work_order_tmp15 Where slip_print AND (_curtime>=s_from And _curtime<=s_to) Or (s_from>s_to And (_curtime>=s_from  Or  _curtime<=s_to)) Into Array tmp_s
		If (VARTYPE(llfastfood_order_do_hold)#"U" AND VARTYPE(__fastfood_hold_inv_print)#"U" AND __fastfood_hold_inv_print) OR VARTYPE(llfastfood_order_do_pre)#"U" OR _Tally>0		&&¦pªG·í«e®É¬q¦L¤Wµæ¯È

			&&Lihing 2022.04.14 ¤Wµæ¤Wµæ¦LQrcode
			IF LOWER(_run_mode)="dine" AND VARTYPE(__order_slip_show_qrcode)#"U" AND __order_slip_show_qrcode 
				_uid= RIGHT(SYS(2015),9)
				**    if check_valid is  empty
				TEXT TO ssql noshow
					IF not exists (select check_valid from tables where tableno=?_tableno and nsubtable=0 AND ISNULL(check_valid,'')<>'' )
						UPDATE tables SET check_valid=?_uid WHERE tableno=?_tableno and nsubtable=0 

				ENDTEXT
				IF SQLEXEC(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1
				ENDIF
			ENDIF 
			*
			frm_wait.Hide
			If 	order_slip_print(_order_id, _print_all , .F.,_print_barcode)=-1			&&_print_all ¬O§_±j¨î¥þ³¡¥´¦L¤è¦¡,²Ä¤G­Ó¬O_voiditem  ¬O§_Åã¥Ü"§ó§ï"(¨ú®øitem®É)
				Return -1
			ENDIF
		
		ENDIF
		
		Release _void_item_slip_print_all

	Endif



Endif

If 	Reccount("print_page")>0		&&¦³¥´¦L¿é¥X,±N¥´¦L­¶½X¼g¤J

	Select Printer Distinct From print_page Into Cursor cun_tmp
	Select cun_tmp
	Scan
		_printer=cun_tmp.Printer
		Select print_page
		Count To _pages For Printer=_printer
		If _pages>1
			Select * From print_page Where Printer=_printer Into Cursor cun_tmp1
			Select cun_tmp1
			_npage=1
			Scan
				_Pid=Trim(cun_tmp1.pid)
				ssql="update order_print_main set  npage=?_npage,pages=?_pages where pid=?_pid"
				If SQLExec(nhand,ssql)<0
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1
				Endif
				_npage=_npage+1
			Endscan
		Endif
	Endscan

Endif


If Used("cun_tmp1")
	Select cun_tmp1
	Use

Endif





_curorder=_order_id		&&¸¨³æ¸¹

Return _order_id


Endfunc


***********************
*	FUNCTION order_item_print
*	µæ¦¡¥´¦L¿é¥X
*
***********************
Function order_item_print
Lparameters _dataname,_id,_item_cancel,_void_reason,_call,_allcall,_remin,_isfastfood,cFastFood_info,_tableno,_call_qty

&&_item_cancel	¬°¨ú®ø¶µ¥Ø,_void_reason ¨ú®ø­ì¦],_call,§Y°_, __allcall ¥þ³¡§Y°_ _remin °l³æ  _isfastfood ¬O§_§ÖÀ\ _fastfood_info §ÖÀ\«H®§,_call_qty§Y°_¼Æ¶q

If Vartype(_call_qty)<>"N"

	_call_qty=0		&&§Y°_¼Æ¶q

Endif

If _id=0 AND !_run_mode=="fastfood" AND !_item_cancel		&&¦pªGorder_id¬°0,¤£¥´¦L  &&Lihong 2022-09-26 fastfood preorder ¼W¥[AND !_item_cancel

	Return 0
Endif

_sitem=&_dataname..sitem				&&¬O§_®MÀ\
_handwriting=&_dataname..handwriting	&&¬O§_¤â¼g³æ

ll_kilo=.F.			&&¬O§_ kilo¤è¦¡­p»ù

If !Empty(&_dataname..kilo)

	ll_kilo=Nvl(&_dataname..kilo or &_dataname..kilo2,.F.)

Endif


If _sitem

	_uid=&_dataname..uid
	Select uid From &_dataname Where parent_id=_uid And Undefine Into Array tmp_s 		&&¦pªG®MÀ\¥þ³¡¬O¥¼©wµæ¦¡,¤£§@¦C¦L
	n1=_Tally
	Select uid From &_dataname Where parent_id=_uid Into Array tmp_s
	n2=_Tally
	If n1=n2 Or n2>0
		Return 0
	Endif

Endif

Local _mitem,_parent_id,lnUid

_mitem=&_dataname..sitem_sub 			&&¬O§_®MÀ\¤l¶µ

lnUid=&_dataname..uid


_delay_minute=&_dataname..delay_minute		&& ©µ®É¥´¦L


&&Lihong 2022.07.20 ÂIµæ¯¸ÂI¡A°l³æÂIµæ®É¶¡
_order_station=""
_remin_order_time=""
IF !EMPTY(FIELD("add_user_station_id", _dataname)) AND NVL(&_dataname..add_user_station_id,0)>0 AND USED("work_order_tmp_station") &&LOWER(_dataname)=="order_itemlist_tmp" AND 
	SELECT work_order_tmp_station
	LOCATE FOR id=&_dataname..add_user_station_id
	_order_station = IIF(_system_langue="CN",work_order_tmp_station.desccn, work_order_tmp_station.descen)
ELSE
	IF !EMPTY(FIELD("adduser", _dataname)) AND LOWER(ALLTRIM(NVL(&_dataname..adduser, "")))=="web"
		_order_station="web"
	ENDIF 
ENDIF 
IF _remin=.T. AND !EMPTY(FIELD("ordertime", _dataname))
	_remin_order_time=TRANSFORM(&_dataname..ordertime)
ENDIF 


IF VARTYPE(_remin_reason)#"N"

	_remin_reason=0
	
ENDIF

If Vartype(__void_item_slip_Printer)#"U"

	_printer=__void_item_slip_Printer

Else

	Do Case

		Case  !Empty(&_dataname..sprinter)						&&§Y®É«ü©wªº¥´¦L¾÷   			direct  printer 	(³ÌÀu¥ý)
			_printer=Trim(&_dataname..sprinter)

		Case !Empty(ITEM_OUTLET_PRINTER(&_dataname..item_id,_outlet_id))		&&item+outlet -->printer		(¦¸Àu¥ý)
			_printer=ITEM_OUTLET_PRINTER(&_dataname..item_id,_outlet_id)

		Otherwise
			_printer=Trim(&_dataname..Printer)					&&¹w³]¥´¦L¾÷©ÎªÌ¤£§@¥´¦L

	Endcase

Endif

&&Lihong 2022.06.28 ¥»¾÷¥´¦L¼p©Ð³æ
IF _remin=.F. OR VARTYPE(__print_remind_info_local)="U" OR __print_remind_info_local=.F. 

	_local_print_kit=.F.
	IF _remin=.T. AND !EMPTY(FIELD("local_print_kit", "work_order_tmp")) AND !EMPTY(FIELD("item_id", _dataname))
		SELECT work_order_tmp 
		LOCATE FOR id=&_dataname..item_id
		IF FOUND("work_order_tmp") &&Lihong 2022.09.27
			_local_print_kit=work_order_tmp.local_print_kit
		ELSE
			SELECT work_order_tmp0 
			LOCATE FOR id=&_dataname..item_id
			_local_print_kit=work_order_tmp0.local_print_kit
		ENDIF 
		SELECT (_dataname)
	ENDIF 

	IF Vartype(__void_item_slip_Printer)="U" AND (!EMPTY(FIELD("local_print_kit", _dataname)) AND &_dataname..local_print_kit=.T. OR _remin=.T. AND _local_print_kit=.T. OR VARTYPE(_order_item_hold_call_local_print_kit)#"U" AND _order_item_hold_call_local_print_kit )
		_local_printer_for_kit = 0
		IF VARTYPE(_vs_all_style_save_order)#"U"
			Select  work_order_tmp9
			Locate For Id=_outlet_id
			_local_printer_for_kit = NVL(work_order_tmp9.qr_android_local_kit_printer_id, 0)
		ELSE 
			IF VARTYPE(__payslip_printer)#"U" AND VAL(__payslip_printer)>0
				_local_printer_for_kit = VAL(__payslip_printer)
			ELSE
				IF VARTYPE(__inv_printer)#"U" AND VAL(__inv_printer)>0
					_local_printer_for_kit = VAL(__inv_printer)
				ENDIF 
			ENDIF 
		ENDIF 
		IF _local_printer_for_kit > 0 AND !(","+ALLTRIM(TRANSFORM(_local_printer_for_kit))+"," $ ","+_printer )
			_printer = RTRIM(_printer, ",") + IIF(EMPTY(_printer), "", ",") + ALLTRIM(TRANSFORM(_local_printer_for_kit))+","
		ENDIF 
	ENDIF 

ELSE 
*IF _remin AND VARTYPE(__print_remind_info_local)#"U" AND __print_remind_info_local &&AND VARTYPE(_style_ORDER_REMINDER)="U" AND !Empty(__local_printer)  &&Empty(_printer) AND 
	_local_printer_for_kit = 0
	IF VARTYPE(_vs_all_style_save_order)#"U"
		Select  work_order_tmp9
		Locate For Id=_outlet_id
		_local_printer_for_kit = NVL(work_order_tmp9.qr_android_local_kit_printer_id, 0)
	ELSE 
		IF !Empty(__local_printer)
			*_computer=getcomputername()
			*select id from work_order_tmp12 where TRIM(printer)==TRIM(__local_printer) AND station_id=__station_id INTO CURSOR cun_tmp
			SELECT work_order_tmp12
			LOCATE FOR TRIM(printer)==TRIM(__local_printer) AND station_id=__station_id
			_local_printer_for_kit = work_order_tmp12.id
		ENDIF
	ENDIF 
	*IF _local_printer_for_kit > 0 AND !(","+ALLTRIM(TRANSFORM(_local_printer_for_kit))+"," $ ","+_printer )
		*_printer = RTRIM(_printer, ",") + IIF(EMPTY(_printer), "", ",") + ALLTRIM(TRANSFORM(_local_printer_for_kit))+","
	*ENDIF 
	IF _local_printer_for_kit > 0 &&¦³¥»¾÷¥´¦L¾÷´N¥u¥»¾÷¥´¡AµL¥»¾÷¥´¦L¾÷´N¸òµæ¦¡¥´¦L¾÷¡]µæ¦¡¥´¦L¾÷¦³«h¥´µL«h¤£ºÞ¡^
		_printer=ALLTRIM(TRANSFORM(_local_printer_for_kit))+","
	ENDIF 
*ENDIF 
ENDIF 

If !Empty(_printer)	And Alines(sp2,_printer,4,",")>0			&&¦³«ü©w¥´¦L¾÷,«h¿é¥X¥´¦L

*	Dimension sp(1)			&&¤À¸Ñ¥´¦L¾÷
*	getMstring(_Printer,@sp)
*	ALINES(sp,_printer,4,",")

	Local k

	k=Alen(sp2)

	Dimension sp(k,7)

	For k=1 To Alen(sp2)


		_printer=Val(sp2(k))

		_printer1=outlet_printer(_outlet_id,_printer)


		If !Empty(_printer1)	&&¦pªG¦boutlet ¤¤¸Ó¥´¦L¾÷¦³«ü©wªº¥´¦L¾÷,«hÂà¦V (¤ñ¹w³]Àu¥ý)

			_printer=Val(_printer1)

		Endif

		_printer1=direct_printer(_printer)

		If !Empty(_printer1)

			_printer=Val(_printer1)

		Endif

		Select work_order_tmp12	&&¬O§_«ü©w¨ä¥¦»y¨¥¦C¦L
		Locate For Id=_printer

		sp(k,1)=TRANSFORM(_printer) &&Lihong 2023.08.04 All Items On 1 Slip sp2(k)													&& printer  id
		sp(k,2)=Trim(Printer)											&& printer  name

		sp(k,3)=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))		&& place
		&&Lihong other_langue ¤£§ï¬°­^»y
		*sp(k,4)=Iif(other_langue,"EN",_system_langue)			&& print langue
		sp(k,4)=_system_langue			&& print langue

		_print_label=("LABEL"$Upper(work_order_tmp12.Printer))		
		
		
		Select work_order_tmp11	&&°Ï°ì¥´¦L¤è¦¡(¦b¤£¦P°Ï°ì¸¨³æµo°e¨ì¬ÛÀ³¥´¦L¾÷ªº¦C¦L¤è¦¡)
		Locate For printer_id=_printer And outlet_Id=_outlet_id

		If Found()


			sp(k,5) = print_mode		&& print mode
			sp(k,6) = sitem				&& ¬O§_®MÀ\¤è¦¡(¦L³æ¤@±i³æ)
			sp(k,7) = Nvl(Split,.F.)			&& ¬O§_¤À©î¼Æ¶q(¦L³æ¤@±i³æ)
			

*	write_log(0,"printer_id="+ALLTRIM(STR(_printer)) +"_outlet_id="+ALLTRIM(STR(_outlet_id)) +" print_mode="+ALLTRIM(STR(sp(k,5))))

			If _print_label And ll_kilo=.F.	 &&¦pªG¬Olabel printer¡A±j¨î¨C¥óµæ¦¡¤@±i³æ
			
				sp(k,5) = 3  
			
			ENDIF
			
			&&Lihong 2021.05.07 BarCode ¤£¦X¨Ö
			IF !EMPTY(FIELD("print_single", _dataname)) AND &_dataname..print_single = .T. OR !EMPTY(FIELD("orgqty_case_mat", _dataname)) AND &_dataname..orgqty_case_mat>0 ;
			OR !EMPTY(FIELD("qty_entity", _dataname)) AND &_dataname..qty_entity>0 OR ll_kilo=.T.   &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö &&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À
				sp(k,7) = .F.
				IF sp(k,5) = 3  
					sp(k,5) = 2  
				ENDIF 
			ENDIF 


		Else

			sp(k,5) = -1					&& print mode
			sp(k,6) = .F.				&& ¬O§_®MÀ\¤è¦¡(¦L³æ¤@±i³æ)
			sp(k,7) = .F.				&& ¬O§_¤À©î¼Æ¶q(¦L³æ¤@±i³æ)

		Endif


	Endfor



	If  Vartype(__kit_order_print_to_inv)#"U" And __kit_order_print_to_inv  And !Empty(__sys_inv_printer) 		&&¥[¤J inv_printer  2012.03.17



		lnSP=Alen(sp)/7

		Dimension sp(lnSP +1 ,7)


		For k= lnSP +1 To Alen(sp)/7

			sp(k,1)=__inv_printer								&& printer  cid
			sp(k,2)=__sys_inv_printer							&& printer  name
			sp(k,3)= sp(k - Alen(sp)/14 , 3)					&& print  place

			sp(k,4)= sp(k - Alen(sp)/14 , 4)					&& print langue

			sp(k,5)= sp(k - Alen(sp)/14 , 5)					&& print mode

			sp(k,6)= sp(k - Alen(sp)/14 , 6)					&& print mode -sitem

			sp(k,7)= sp(k - Alen(sp)/14 , 7)					&& print mode -split


*!*				Select work_order_tmp12	&&¬O§_«ü©w¨ä¥¦»y¨¥¦C¦L
*!*				Locate For Id=VAL(__inv_printer)
*!*
*!*				sp(k,4)=Iif(other_langue,"EN",_system_langue)			&& print langue



		Endfor




	Endif

	&&Lihong 2023-06-02 ¼pÅã 
	lladd_to_kit_disp = .F.
	_to_printer = ""
	IF LOWER(_dataname)=="order_itemlist_to_printer" &&Upper(_run_mode)=="DINE" AND  &&AND NVL(work_order_tmp12.kit_disp_station_id, 0)>0 &&AND EMPTY(NVL(&_dataname..kit_disp_uid,""))
		For k=1 To Alen(sp)/7
			_printer=Val(sp(k,1))	
			Select work_order_tmp12
			Locate For Id=_printer
			IF NVL(work_order_tmp12.kit_disp_station_id, 0)>0 
				_to_printer = _to_printer + TRANSFORM(_printer) + "," &&IIF(EMPTY(_to_printer), "", ",") 
			ENDIF 
		ENDFOR 
		SELECT order_itemlist_tmp
		LOCATE FOR uid=order_itemlist_to_printer.uid
		IF FOUND() &&AND EMPTY(NVL(kit_disp_uid, ""))
			REPLACE to_printer WITH _to_printer IN order_itemlist_tmp
		ENDIF 
		RETURN 1
	ENDIF 

	For k=1 To Alen(sp)/7		&&¦V¨C¤@»O«ü©w¥´¦L¾÷µo°e¤@­Ó§@·~


		_printer=Val(sp(k,1))		&& printer id

*!*			_printer1=outlet_printer(_outlet_id,_printer)

*!*			If !Empty(_printer1)	&&¦pªG¦boutlet ¤¤¸Ó¥´¦L¾÷¦³«ü©wªº¥´¦L¾÷,«hÂà¦V (¤ñ¹w³]Àu¥ý)

*!*				_printer=Val(_printer1)

*!*			ENDIF
*!*
*!*
*!*			_printer1=direct_printer(_printer)
*!*
*!*			IF !EMPTY(_printer1)
*!*
*!*				_printer=Val(_printer1)
*!*
*!*			ENDIF
*!*
		&&Lihong 2023-06-02 ¼pÅã 
		_printed = 0
		IF Upper(_run_mode)=="DINE" OR BETWEEN(_id, -199999, -100000)
			Select work_order_tmp12
			Locate For Id=_printer
			IF NVL(work_order_tmp12.kit_disp_station_id, 0)>0 AND NVL(work_order_tmp12.kit_disp_also_print, .F.)=.F.
				_printed = 1
			ENDIF 
			
			*ll_inv_change_mode=.F. "item_cancel_tmp"¤W¼h¤w±±¨î 
			IF LOWER(_dataname) == "item_cancel_tmp" AND (!EMPTY(NVL(item_cancel_tmp.to_printer,"")) OR NVL(work_order_tmp12.kit_disp_station_id, 0)>0 AND !EMPTY(NVL(&_dataname..kit_disp_uid,"")) ) AND lladd_to_kit_disp=.F. 
				_to_printer = TRIM(NVL(item_cancel_tmp.to_printer, ""))
				llempty_to_printer = EMPTY(_to_printer)
				For kk=1 To Alen(sp)/7
					_printer=Val(sp(kk,1))	
					Select work_order_tmp12
					Locate For Id=_printer
					IF NVL(work_order_tmp12.kit_disp_station_id, 0)>0 AND !(","+TRANSFORM(_printer)+"," $ ","+_to_printer)
						_to_printer = _to_printer + TRANSFORM(_printer) + "," &&IIF(EMPTY(_to_printer), "", ",") 
					ENDIF 
				ENDFOR 
				
				TEXT TO ssql TEXTMERGE NOSHOW 
				SELECT SUM(qty) as qty FROM order_detail WHERE kit_disp_uid=?<<_dataname>>.kit_disp_uid
				ENDTEXT 
				If SQLExec(nhand,ssql, "kit_disp_uid_qty_tmp")<0
					Aerror(err)

					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				ENDIF

				IF NVL(kit_disp_uid_qty_tmp.qty, 0)=0
				
				lladd_to_kit_disp = .T.
				_kit_print_type = (BETWEEN(_id, -199999, -100000))
				
				TEXT TO ssql TEXTMERGE NOSHOW 
				DECLARE @status int 
				SET @status=ISNULL((select status from order_kit_print where kit_disp_uid=?<<_dataname>>.kit_disp_uid),0)
				IF @status<=0
					INSERT INTO [order_kit_print]
					([kit_disp_uid]
					,[order_id]
					,[tableno]
					,[descdisp]
					,[modi_list]
					,[status]
					,[void_time]
					,[void_reason]
					,[to_printer]
					,[type] )
					VALUES
					(?<<_dataname>>.kit_disp_uid
					,?_id
					,?_tableno
					,?<<_dataname>>.descdisp
					,?<<_dataname>>.modi_list
					,2
					,getdate()
					,?_void_reason 
					,?_to_printer
					,?_kit_print_type)
				ELSE 
				begin
					IF @status<>999
						UPDATE order_kit_print SET status=2, void_time=getdate(), void_reason=?_void_reason, to_printer=?_to_printer where kit_disp_uid=?<<_dataname>>.kit_disp_uid
					
				END
				ENDTEXT 
				If SQLExec(nhand,ssql)<0
					Aerror(err)

					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				ENDIF
				ENDIF &&NVL(kit_disp_uid_qty_tmp.qty, 0)=0
			ENDIF 
		ENDIF &&Upper(_run_mode)=="DINE"

*-----------------------------
		Local _print_langue,_print_other_langue

*!*			Select work_order_tmp12	&&¬O§_«ü©w¨ä¥¦»y¨¥¦C¦L
*!*			Locate For Id=_printer
*!*			_print_other_langue=other_langue
*!*			_print_langue=Iif(_print_other_langue,"EN",_system_langue)		&&¦L³æ»y¨¥¡A¦pªG¨ä¥¦»y¨¥¡A«h¦L³æªö¥Î­^¤å¡Aitem¥Î¨ä¥¦»y¨¥


*!*			If Isnull(report_form)
*!*				_print_label=.F.
*!*			Else
*!*				_print_label=(Lower(Justext(report_form))="fxp")	&&¬O§_¥´¦L¼ÐÃ±¤è¦¡
*!*			Endif

		_print_langue=sp(k,4)		&& print langue





*--------------------------		&& bug fix 2009.07.04
		If (_run_mode="fastfood" Or _run_mode="barcode")  And  Vartype(_print_inv_within_order)="U"

			_table_info=_tableno

		Else

			ssql="select name from tables with (nolock) where tableno=?_tableno"
			If SQLExec(nhand,ssql,"cun_tmp")<0
				Aerror(err)

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1

			Endif


			_table_info=_tableno+Iif(!Empty(Trim(cun_tmp.Name)),"<"+Trim(cun_tmp.Name)+">","")		&&À\Âi+»¡©ú

		Endif


		If Vartype(__kit_order_print_ppl)="L"

			If __kit_order_print_ppl 			&&¼p©Ð³æ¬O§_¦C¦L¤H¼Æ


				_table_info=_table_info+"/"+Alltrim(Str(_pplcnt))+" "+getmessage("_cover")



			Endif

		Endif

*----------------------------------------------------------

		If _allcall And __no_print_item_when_all_call=.F.		&&¦pªG ¥þ³¡§Y°_ ¥B¬ÛÃö³]©w¦³®Ä®É,¥uµo°eÂ²¤Æªº«H®§

*!*				Select work_order_tmp12		&&IDÂà¬°¦WºÙ
*!*				Locate For Id=_printer
*!*				_cprinter=Trim(Printer)

			_cprinter=sp(k,2)		&& printer name

			_Pid="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"KIT"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î
*			_place=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

			_place=sp(k,3)


			ssql="select printed from order_print_main where order_id=?_id and allcall=1 and printer=?_Cprinter and printed=0"
			If SQLExec(nhand,ssql,"cun_tmp")<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1

			Endif
			If !Eof("cun_tmp")		&&¨C­Ó¥´¦L¾÷¥u¦L¤@±i

				Return 1

			Endif

*	_label_print=("LABLE"$UPPER(_cPrinter) and VARTYPE(__direct_print_label)#"U" and __direct_print_label)
			&&Lihong 2023-06-02 ¼pÅã
			ssql="if not exists (select pid from order_print_main where pid=?_pid) "+;
				"insert into order_print_main (pid,order_id,place,username,tableno,printed,printer,def_printer,act_printer,sendtime,printtime,npage,pages,void_order,void_reason,allcall,langue,training,member_name,member_no, order_station, remin_order_time)"+;
				" values (?_pid,?_id,?_place,?_login_user_name,?_table_info,?_printed,?_Cprinter,?_Cprinter,'',getdate(),'',1,1,?_item_cancel,?_void_reason,1,?_print_langue,?GL_training,?_member_name,?_member_cardno,?_order_station,?_remin_order_time)"

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1
			Endif

			Loop

		Endif

*----------------------------------------------------------------

*!*			Select work_order_tmp11	&&°Ï°ì¥´¦L¤è¦¡(¦b¤£¦P°Ï°ì¸¨³æµo°e¨ì¬ÛÀ³¥´¦L¾÷ªº¦C¦L¤è¦¡)
*!*			Locate For printer_id=_printer And outlet_Id=_outlet_id


*!*		If Found()

		If sp(k,5)>0

			_print_mode=sp(k,5)
			_print_sitem=sp(k,6)			&&¬O§_®MÀ\¤è¦¡(¦L³æ¤@±i³æ)
			_print_slipt = sp(k,7)			&&¬O§_¤À©î¼Æ¶q

			Do Case
				Case _print_mode=1 Or _print_mode=2   &&1 --©Ò¦³µæ¦¡¦L¤@±i³æ   2--¨C´Úµæ¦¡¤@±i³æ  3--¨C¥óµæ¦¡¤@±i³æ
					_qty=Iif(_call_qty>0,_call_qty,&_dataname..qty)
					
					&&Lihong 2022.03.17 ¨Ò®u
					IF &_dataname..orgqty_case_mat>0
						_qty=Iif(_call_qty>0,_call_qty,&_dataname..orgqty_case_mat)
					ENDIF 
					
					IF &_dataname..qty_entity>0 
						IF &_dataname..qty_entity>0
							IF &_dataname..orgqty_case_mat>0
								_qty=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..orgqty_case_mat,&_dataname..qty_entity)
							ELSE 
								_qty=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..qty,&_dataname..qty_entity)
							ENDIF 
						ENDIF 
					ELSE 
						&&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À
						IF ll_kilo=.T. 
							&&REPLACE qty_entity WITH 1 IN (_dataname)
							_qty=1
						ENDIF 
					ENDIF 
					
					pn=1
				Case _print_mode=3
					_qty=1
					pn=Iif(_call_qty>0,_call_qty,&_dataname..qty)
					&&Lihong 2022.03.17 ¨Ò®u
					IF &_dataname..orgqty_case_mat>0
						pn=Iif(_call_qty>0,_call_qty,&_dataname..orgqty_case_mat)
					ENDIF 
					IF &_dataname..qty_entity>0
						IF &_dataname..orgqty_case_mat>0
							pn=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..orgqty_case_mat,&_dataname..qty_entity)
						ELSE 
							pn=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..qty,&_dataname..qty_entity)
						ENDIF 
					ENDIF 
					

				Otherwise

					_qty=Iif(_call_qty>0,_call_qty,&_dataname..qty)
					&&Lihong 2022.03.17 ¨Ò®u
					IF &_dataname..orgqty_case_mat>0
						_qty=Iif(_call_qty>0,_call_qty,&_dataname..orgqty_case_mat)
					ENDIF 
					IF &_dataname..qty_entity>0
						IF &_dataname..orgqty_case_mat>0
							_qty=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..orgqty_case_mat,&_dataname..qty_entity)
						ELSE 
							_qty=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..qty,&_dataname..qty_entity)
						ENDIF 
					ELSE
						&&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À
						IF ll_kilo=.T. 
							&&REPLACE qty_entity WITH 1 IN (_dataname)
							_qty=1
						ENDIF 
					ENDIF 
					
					pn=1

			Endcase



		Else

			_print_mode=2	&&2--¨C´Úµæ¦¡¤@±i³æ
			_print_sitem=.F.
			_print_slipt =.F.

			_qty=Iif(_call_qty>0,_call_qty,&_dataname..qty)
			
			&&Lihong 2022.03.17 ¨Ò®u
			IF &_dataname..orgqty_case_mat>0
				_qty=Iif(_call_qty>0,_call_qty,&_dataname..orgqty_case_mat)
			ENDIF 
			
			IF &_dataname..qty_entity>0 
				IF &_dataname..qty_entity>0
					IF &_dataname..orgqty_case_mat>0
						_qty=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..orgqty_case_mat,&_dataname..qty_entity)
					ELSE 
						_qty=Iif(_call_qty>0,&_dataname..qty_entity*_call_qty/&_dataname..qty,&_dataname..qty_entity)
					ENDIF 
				ENDIF 
			ELSE
				&&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À
				IF ll_kilo=.T. 
					&&REPLACE qty_entity WITH 1 IN (_dataname)
					_qty=1
				ENDIF 
			ENDIF 
			

			pn=1

		Endif



*	write_log(0,"print_mode="+ALLTRIM(STR(_print_mode)) )




*!*		*	If _print_label And ll_kilo=.F.		&&¦pªG¬O¥´¦L¼ÐÃ±(¥B¤£¬°¤ç¨â¤è¦¡¡^¡A±j¨î¬°¨C¥óµæ¦¡¤@±i³æ  update by david  2009.04.17

*!*				_print_mode=3
*!*				_qty=1
*!*				pn=Iif(_call_qty>0,_call_qty,&_dataname..qty)


*!*		*	Else

			If Vartype(__void_item_all_in_one)#"U" And __void_item_all_in_one And _item_cancel		&&¦pªG¨ú®øµæ¦¡¡A©Ò¦³µæ¦¡¤@±i³æ  Ú»setting 2011.10.19

				_print_mode=1

				pn=1


			Endif


	*!*	Endif
		
		
		IF  VARTYPE(nSplit_print_mode)="N"		&&§ÖÀ\¤À³æ¥´¦L¡A©Ò¦³µæ¦¡¤@±i³æ
		
			
			_print_mode= nSplit_print_mode

			
		
		ENDIF
		
		IF pn=0
		
			pn=1
		ENDIF
		
		

		Dimension spn(pn)


		Local i,kn

		Local nSplit , nItem_Qty

		nItem_Qty =_qty
		nSplit  =1

		If  _print_slipt And (_item_cancel=.F. OR _item_cancel=.T. AND (VARTYPE(__void_item_follow_split_qty)="U" OR __void_item_follow_split_qty=.T.) ) &&Lihong 2023.08.01

			nSplit  = _qty
			nItem_Qty =1
			
			&&Lihong 2022.10.12 &&©Ò¦³µæ¦¡¤@±i³æ©î¤À¼Æ¶q¤]¦C¦L¶¡½u
			IF _print_mode=1 AND nSplit=0
				nSplit = 1
			ENDIF 
		Endif



		For i=1 To pn		&&pn>1®É¬°¨C¥ó¦L¤@±i³æ (½sµ{«ä¸ô,¥ÎPID¨Ó±±¨î¥´¦Lªº±i¼Æ)



			For kn   =1 To nSplit    && 2013.03.15  ¼W¥[¼Æ¶q©î¤À



				If ((_print_mode=2 Or _print_mode=3 ) And  _print_sitem=.F.) Or ((_print_mode=2 Or _print_mode=3 ) And _print_sitem=.T. And _mitem=.F. ) 				&&  2--¨C´Úµæ¦¡¤@±i³æ  3--¨C¥óµæ¦¡¤@±i³æ


					If  kn=1

						_Pid="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")				&&ÀH¾÷½X,«e­±ªº"KIT"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î

					Endif




					Select print_page
					Append Blank
					Replace Printer With _printer,pid With _Pid

					If _mitem	And  __sitem_print_shell         					&&®MÀ\®É,­n¦bµæ¦¡«e¥[¤J®MÀ\¦WºÙ


						_parent_id=&_dataname..parent_id
						Select * From order_itemlist_tmp Where uid=_parent_id Into Cursor cun_tmp
						If _Tally>0
							_uid=cun_tmp.uid

							If	MULT_ORDER_ITEM(_Pid,0,"cun_tmp",.F.,.F.,.F.,_item_cancel,_handwriting)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥	2009.04.20  ®MÀ\´ß¤£¦L¼Æ¶q
*						If	MULT_ORDER_ITEM(_Pid,_qty,"cun_tmp",.F.,.F.,.f.,_item_cancel,_handwriting)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥

								Return -1
							Endif

							_dispord=_dispord+1

							&&Lihong 2022.03.17 ¨Ò®u ®MÀ\´ß¦C¦Lmodi
							If print_item_modifier("cun_tmp",_item_cancel)<0
								Return -1
							Endif

						Endif

						If __sitem_print_add_line       		&&®MÀ\¬O§_¦C¦L¶¡½u

							_spec=Replicate("=",30)
							csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,1,0,0,'')"

							If SQLExec(nhand,csql)<0
								Aerror(err)

								Sqlrollback(nhand)
								SQLSetprop(nhand,"Transactions" ,1)
								error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

								Return -1
							Endif

							_dispord=_dispord+1

						Endif


					Endif


				Else												&&©Ò¦³µæ¦¡¤@±i³æ,©Î®MÀ\µæ¦¡¤@±i³æ


					&&Lihong 2022.08.23
					IF TYPE("prand[1]")="U"
						Return 1
					ENDIF 

					If Ascan(prand,_printer)=0						&&¥²¶·¬O¦³®Äªº¥´¦L¾÷  2013.01.21


						Return 1

					Endif


					IF  VARTYPE(_split_Pid)="C"		&&§ÖÀ\¤À³æ¥´¦L¡A©Ò¦³µæ¦¡¤@±i³æ(¤À¶}¡^
	
						
						_pid=_split_Pid


					ELSE
					
						_Pid=prand(Int(Ascan(prand,_printer)+1)/2,2)		&&«ü©w¥´¦L¾÷ªºÃÑ§O½X
						
					ENDIF
					




					If   _mitem Or  !Inlist(_printer,&_mprinter) 			&&¥u¦b²Ä¤@­Ó®MÀ\µæ¦¡¤§«e¥´¦L®MÀ\¦WºÙ


						_parent_id=&_dataname..parent_id

						If _parent_id>0 And _print_sitem
							_Pid=prand(Int(Ascan(prand,_printer)+1)/2,2)+Alltrim(Str(Int(_parent_id)))		&&«ü©w¥´¦L¾÷ªºÃÑ§O½X  fix  2011.06.09 ¨C­Ó®MÀ\¤@±i³æ¡]¤À¶}¦L¡^
						Endif


						_cp=","+Alltrim(Str(_printer))+","

						If Empty(&_dataname..sprinter)
							Select Top 1 uid From &_dataname Where parent_id=_parent_id And (_cp$(Printer) Or Val(Printer)=_printer) Order By uid Into Cursor cun_tmp
						Else
							Select Top 1 uid From &_dataname Where parent_id=_parent_id And Val(sprinter)=_printer Order By uid Into Cursor cun_tmp

						Endif


						If cun_tmp.uid=lnUid And _mitem And __sitem_print_shell        		&&¬O§_¦C¦L®MÀ\ªº´ß¸òsetting

							_spec=Replicate(" ",30)
							csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,1,0,0,'')"

							If SQLExec(nhand,csql)<0
								Aerror(err)

								Sqlrollback(nhand)
								SQLSetprop(nhand,"Transactions" ,1)
								error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

								Return -1
							Endif

							_dispord=_dispord+1

*-----------------------------
							Select * From &_dataname Where uid=_parent_id Into Cursor cun_tmp

							If _Tally>0

&&									Lparameters _Pid,_qty,cdbf,_ismitem,_modi,_slip,_void,_must_printAmt,_other_langue

								If MULT_ORDER_ITEM(_Pid,0,"cun_tmp",.F.,.F.,.F.,_item_cancel,_handwriting)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥ (®MÀ\)
*									If MULT_ORDER_ITEM(_Pid,cun_tmp.qty,"cun_tmp",.F.,.F.,.F.,_item_cancel,_handwriting)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥ (®MÀ\) 2009.04.20 ®MÀ\´ß¤£¦L¼Æ¶q
									Return -1
								Endif

								_dispord=_dispord+1

								&&Lihong 2022.03.17 ¨Ò®u ®MÀ\´ß¦C¦Lmodi
								If print_item_modifier("cun_tmp",_item_cancel)<0
									Return -1
								Endif

							Endif


							If __sitem_print_add_line       		&&®MÀ\¬O§_¦C¦L¶¡½u

								_spec=Replicate("=",30)
								csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,1,0,0,'')"

								If SQLExec(nhand,csql)<0
									Aerror(err)

									Sqlrollback(nhand)
									SQLSetprop(nhand,"Transactions" ,1)
									error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

									Return -1
								Endif

								_dispord=_dispord+1

							Endif

*						Endif

							_dispord=_dispord+1

							_mprinter=_mprinter+","+Alltrim(Str(_printer))

							If Len(_mprinter)>20		&&¹Lªø®É¡A¥h­«´_
								Local sn

								sn=Alines(s,_mprinter,4,",")
								If sn=0
									RETURN 0
								Endif

								If sn>1		&&¨¾¤î­«´_
									Local ii
									Create Cursor ss_tmp (ctmp  c(30))
									For ii=1 To sn
										Insert Into ss_tmp (ctmp) Values (s(i))
									Endfor

									Select ctmp Distinct From ss_tmp  Into Cursor ss_tmp1
									_mprinter=""
									Select ss_tmp1
									Scan
										_mprinter=_mprinter+","+Trim(ss_tmp1.ctmp)

									Endscan
									Use In ss_tmp
									Use In ss_tmp1

									_mprinter=Ltrim(_mprinter,",")

								Endif


							Endif



						Endif

					Endif


				Endif


				If &_dataname..item_id=0 And _print_mode=1		&&©Ò¦³µæ¦¡¤@±i³æ®É¤~¦C¦L¶¡½u
			
&&¶¡¹j½u
					_spec=Replicate("-",30)
					csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,0,0,0,'')"

					If SQLExec(nhand,csql)<0
						Aerror(err)

						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1
					Endif

				Else
					
					If MULT_ORDER_ITEM(_Pid,nItem_Qty ,"&_dataname",_mitem,.F.,.F.,_item_cancel,_handwriting)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥	***µæ¦¡¦C¦L
						Return -1
					Endif


				Endif

				_dispord=_dispord+1


&&------------------------------------------------------->>  ¯S§O³B²z

*			If _item_cancel=.F.				&&¨ú®ø³æ

				If print_item_modifier(_dataname,_item_cancel)<0

					Return -1

				Endif


*			Endif


				If &_dataname..hold>0 And 	_call=.F.									&&¥s°_
					_item=getmessage("_waitcall")
					_dispord=_dispord+1
					ssql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,'**',?_item,?_dispord,1,0,0,'')"
					If SQLExec(nhand,ssql)<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1
					Endif


				Endif

				_dispord=_dispord+1


*---------------------- fff
*	SET STEP ON 
				If _handwriting And  __handwriting_print_shape	And _print_mode>1		&&¦pªG¤â¼g³æ,¦C¦L¤@­Ó¤j¤è®Ø(¸òsetting)

					_spec=Replicate("-",40)
					ssql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,1,0,0,'')"
					If SQLExec(nhand,ssql)<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1
					Endif

					_dispord=_dispord+1


					For ii=1 To 5
						_spec="|"+Space(41)+"|"
						ssql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,1,0,0,'')"
						If SQLExec(nhand,ssql)<0
							Aerror(err)
							Sqlrollback(nhand)
							SQLSetprop(nhand,"Transactions" ,1)
							error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

							Return -1
						Endif

						_dispord=_dispord+1

					Endfor

					_spec=Replicate("-",40)
					ssql="insert into order_print_detail (pid,qty,spec,item,dispord,modi,void,item_id,item_unicode) values (?_pid,0,?_spec,'',?_dispord,1,0,0,'')"
					If SQLExec(nhand,ssql)<0
						Aerror(err)
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1
					Endif

					_dispord=_dispord+1



				Endif


*!*				Select work_order_tmp12		&&IDÂà¬°¦WºÙ
*!*				Locate For Id=_printer
*!*				_cprinter=Trim(Printer)

*!*				_place=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

				_cprinter=sp(k,2)
				_place=sp(k,3)



				If _print_mode=2 Or _print_mode=3

				Else
					_pages=1
					_npage=1
				Endif

				If _remin
					cReminOrderTime=getmessage("_order_time") &&ÂIµæ®É¶¡
					_order_time = order_itemlist_tmp.ordertime 
					
					_remin_times=order_itemlist_tmp.remin_times+1				&&°l³æ®É¶¡
					_time=getservertime()-order_itemlist_tmp.printtime			&&®É¶¡®t(¬í)
					_hour=Int(_time/3600)
					_minute=Int(Mod(_time,3600)/60)
					_hour=Iif(_hour>9,Alltrim(Str(_hour)),"0"+Alltrim(Str(_hour)))
					_minute=Iif(_minute>9,Alltrim(Str(_minute)),"0"+Alltrim(Str(_minute)))		&&Âà¬°®É¤À

					_remin_difftime=_hour+":"+_minute 							&&¦L³æ¦Ü¥Ø«e®É¶¡

				Else
					_remin_times=0
					_remin_difftime=""
				Endif
 
				If 	&_dataname..item_id>0 Or (&_dataname..item_id=0 And _print_mode=1)

					If (_handwriting And  __handwriting_print_to_Local OR _remin AND VARTYPE(__print_remind_info_local)#"U" AND __print_remind_info_local AND VARTYPE(_style_ORDER_REMINDER)="U")  And !Empty(__local_printer) &&Lihong 2022.05.17 or _remin
						
						_cprinter=__local_printer	&&¦pªG¤â¼g³æ,¦³¥»¦a¥´¦L¾÷,´N°e¨ì¥»¦a¥´¦L¾÷

					Endif

					Local _inv_remark
					If Vartype(_fastfood_remark_info)="C"
						_inv_remark=_fastfood_remark_info
					Else
						_inv_remark=""
					Endif

					If Vartype(_paisanos_remark)#"U"

						_inv_remark=_paisanos_remark

					Endif

*---------------------------2008.12.12 ¥[¤Jprint_no

					_belongdate=getbelongdate()

					If Vartype(__kit_order_print_no)#"U" And __kit_order_print_no		&& 2011.03.21


						If Vartype(spn(i))#"N"

							If Vartype(__kit_order_print_to_inv)#"U" And __kit_order_print_to_inv  And !Empty(__sys_inv_printer) 	&&d¤j®a¼Ö¼Ò¦¡

*								ssql="select MAX(print_no) as max_no from order_print_Main where  sendtime>?_belongdate"

								TEXT TO ssql noshow
									 select MAX(print_no) as max_no from order_print_main where  CONVERT(VARCHAR(5), sendtime,108)>(select top 1 s_from from system_Period order by id) 
									and  sendtime>?_belongdate

								ENDTEXT
								

							Else

								*ssql="select MAX(print_no) as max_no from order_print_Main where printer=?_Cprinter and  sendtime>?_belongdate"
								TEXT TO ssql noshow
									 select MAX(print_no) as max_no from order_print_main where printer=?_Cprinter
									 and   CONVERT(VARCHAR(5), sendtime,108)>(select top 1 s_from from system_Period order by id) 
									and  sendtime>?_belongdate

								ENDTEXT


							Endif


							If SQLExec(nhand,ssql,"cun_tmp")<0
								Aerror(err)

								Sqlrollback(nhand)
								SQLSetprop(nhand,"Transactions" ,1)
								error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

								Return -1

							Endif

							_print_no=Iif(Isnull(cun_tmp.max_no),1,cun_tmp.max_no+1)

							spn(i)=_print_no

						Else

							_print_no=spn(i)

						Endif




					Else

						_print_no=0

					Endif
					&&Lihong 2023-06-02 ¼pÅã 
					ssql="if not exists (select pid from order_print_main where pid=?_pid) "+;
						"insert into order_print_main (pid,order_id,place,username,tableno,printed,printer,def_printer,act_printer,sendtime,printtime,npage,pages,void_order,void_reason,remin_times,remin_difftime,call,langue,training,fastfood,fastfood_info,remark,"+;
						"member_name,member_no,print_no,delay_minute,remin_reason,order_station,remin_order_time)"+;
						" values (?_pid,?_id,?_place,?_login_user_name,?_table_info,?_printed,?_Cprinter,?_Cprinter,'',getdate(),'',1,1,?_item_cancel,?_void_reason,?_remin_times,?_remin_difftime,?_call,?_print_langue,?GL_training,?_isfastfood,?cfastfood_info,?_inv_remark,"+;
						"?_member_name,?_member_cardno,?_print_no,?_delay_minute,?_remin_reason,?_order_station,?_remin_order_time)"

					If SQLExec(nhand,ssql)<0
						Aerror(err)

						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions" ,1)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

						Return -1
					Endif

*				_order_change=.T.

				Endif

				_dispord=_dispord+1


			Endfor


		Endfor

	Endfor

Endif

If Used("cun_modi_tmp")
	Select cun_modi_tmp
	Use
Endif



Return 1

Endfunc



********************************************

Function  crstr
Lpara mstr , mpassword
* °õ¦æ¤@¦¸·|¥[±K, ¦A±N¥[±KªºÀÉ®×¨Ó°õ¦æ¤@¦¸·|¸Ñ±K
Local i, mret, mpos
Dime apassword[ len(mpassword)*2 ]
For i=1 To Len(mpassword)
	apassword[ i*2-1 ] = Int(Asc( Subs( mpassword,i,1))/16)
	apassword[ i*2 ] = Asc( Subs( mpassword,i,1)) - apassword[ i*2-1 ]*16
Next

mret = ''
For i=1 To Len( mstr )
	mpos = Mod( i , Alen( apassword ) )+1
	mret = mret + bytexor( Subs( mstr, i,1) , apassword[ mpos ] )
Next
Return mret


Endfunc

Func bytexor &&--¥i¥Î©ó¥[±K
Lpara mbyte, mbit
* ¨Ò: ? bytexor('A', 15 ) &&-- show chr(190)
* ? bytexor( chr(190) , 15 ) &&-- show 'A'
* mbyte = ¤@­Ó­^¤å¦r
* mbit = ¤@­Ó16¶i¦ìªº¼Æ¦r 0 ¨ì 15
Local mbit1,mbit2
mbit1 = Int( Asc( mbyte )/16)
mbit2 = Asc( mbyte ) - mbit1*16
Return Chr( Bitxor( mbit1, mbit ) * 16 + Bitxor( mbit2,mbit ) )

Endfunc

*****

Function load_order_express

Lparameters _order_id

If create_order_database()=-1
	Return -1
Endif


If load_order(_order_id)=-1			&&¸ü¤J¸¨³æ,¥Í¦¨¦³Ãö¼Æ¾ÚÀô¹Ò

	Select order_itemlist_tmp
	Use
	Select item_modi_tmp
	Use
	Select item_disc_tmp
	Use
	Select order_disc_tmp
	Use

	Return -1

Endif
level_rule_check() 			&&­«·s­pºâ¯Å§O³W«h

*!*	&&Lihong 2021.04.23 ¼W¥[¤J°Ñfor disc_log  _item_resave_order_inv_id 
*!*	IF VARTYPE(_item_resave_order_inv_id)="U"
*!*		_item_resave_order_inv_id = -1
*!*	ENDIF 

amount_check() &&_item_resave_order_inv_id¡GÁÙ­ì¤F

Return 1

Endfunc


**********************************
*	«Ø¥ß¼Æ¾ÚÀô¹Ò
*
Function create_order_database

*---------------------------------------------
*	¸ü¤J¥²¶·ªº¼Æ¾Ú
*
*----------------------------------------------
*work_order_tmp0		µæ¦¡ active=0
*work_order_tmp			µæ¦¡
*work_order_tmp1		µæ¦¡ºØÃþ
*work_order_tmp2		¥\¯à«ö¶s
*work_order_tmp3 		®MÀ\
*work_order_tmp4		¯S§O³B²z
*work_order_tmp5 		§é¦©Àu´f
*work_order_tmp6		µæ¦¡¯Å§O³W«h
*work_order_tmp7		ªA°È¶O
*work_order_tmp8 		µ|¶µ
*work_order_tmp9 		Àç·~°Ï°ì
*work_order_tmp10		¦h¿ïµæ¦¡(¦Û©wµæ¦¡)
*work_order_tmp11		°Ï°ì¥´¦L¼Ò¦¡
*work_order_tmp12		¥´¦L¾÷
*work_order_tmp13		®É¬q°â»ù
*work_order_tmp14		¤½²³°²´Á
*work_order_tmp15	 	Àç·~®É¬q
*work_order_tmp16		itemªº¦¸§Ç,ÃC¦â
*work_order_tmp17		·|­û
*work_order_tmp18		Âà»ù
*work_order_tmp19		µæ¦¡³¡ªù
*work_order_tmp20		°Ý°Ê§@¯S§O³B²z
*work_order_tmp21		¯S§O³B²zsoldout
*work_order_tmp0		
*work_order_tmp22		&&Lihong 2022.03.23 ÂàªA°È¶O²v
*work_order_tmp24		&&Lihong 2022.05.06 festival 
*work_order_tmp_station		&&Lihong 2022.07.19 station
************************          work_table  ¥²¶·¦P¨B§ó·s¥H¤U¥N½X		****************


*!*	If Used("work_order_tmp")
*!*		Select work_order_tmp
*!*		Use

*!*	Endif


*!*	For i=1 To 20
*!*		_curs="work_order_tmp"+Alltrim(Str(i))

*!*		If Used("&_curs")
*!*			Select &_curs
*!*			Use
*!*		Endif

*!*	Endfor

create_order_cursor()		&&«Ø¥ßÁ{®Éªí

&&Lihong 2023.04.19 ¦X¨Ösql
lnorder_tmp = 0
lcorder_tmp_cmd=""
RELEASE aorder_tmp_name


If Used("work_order_tmp0")=.F. 

	If Used("work_order_tmp0")

		Use In work_order_tmp0

	Endif

	ssql="select * from item with(readpast) where active=0 order by id"
*!*		If SQLExec(nhand,ssql,"work_order_tmp0")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp0"
ENDIF


If Used("work_order_tmp")=.F. Or  Get_table_updateno("item")<0

	If Used("work_order_tmp")

		Use In work_order_tmp

	Endif

	ssql="select * from item with(readpast) where active=1 order by id"
*!*		If SQLExec(nhand,ssql,"work_order_tmp")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp"
Endif

If Used("work_order_tmp1")=.F. Or Get_table_updateno("cate")<0

	If Used("work_order_tmp1")
		Use In work_order_tmp1 

	Endif

	ssql="select * from cate with(readpast) where active=1 or blank=1 order by dispord"
*!*		If SQLExec(nhand,ssql,"work_order_tmp1")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp1"
Endif

If  Used("work_order_tmp2")=.F. Or Get_table_updateno("order_function")<0

	ssql="select * from order_function with(readpast) order by dispord"

*!*		If SQLExec(nhand,ssql,"work_order_tmp2")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp2"
Endif

If  Used("work_order_tmp3")=.F. Or Get_table_updateno("setitem")<0

	ssql="select * from setitem  with(readpast) where item_id=0 or item_id in (select id from item with(readpast) where active=1)"
*!*		If SQLExec(nhand,ssql,"work_order_tmp3")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp3"
Endif

If   Used("work_order_tmp4")=.F. Or Get_table_updateno("modifier")<0

	ssql="select * from modifier with(readpast) where active=1 or blank=1"  &&update by david 2009.05.25

*!*		If SQLExec(nhand,ssql,"work_order_tmp4")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp4"
Endif

If   Used("work_order_tmp5")=.F. Or Get_table_updateno("disc")<0

	ssql="select * from disc with(readpast) where active=1 order by dispord"	&&work_order_tmp5		§é¦©Àu´f
*!*		If SQLExec(nhand,ssql,"work_order_tmp5")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif
*!*		IF VARTYPE(__storellet)#"U" AND __storellet
*!*			UPDATE work_order_tmp5 SET disclevel ="all"
*!*			GO TOP IN work_order_tmp5
*!*		ENDIF 

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp5"
Endif

If   Used("work_order_tmp6")=.F. Or Get_table_updateno("itemlevel_rule")<0

	ssql="select * from itemlevel_rule with(readpast) where active=1"
*!*		If SQLExec(nhand,ssql,"work_order_tmp6")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp6"
Endif

If   Used("work_order_tmp7")=.F. Or Get_table_updateno("srv")<0

	ssql="select * from srv with(readpast) where active=1"
*!*		If SQLExec(nhand,ssql,"work_order_tmp7")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp7"
Endif


If   Used("work_order_tmp8")=.F. Or Get_table_updateno("tax")<0

	ssql="select * from tax with(readpast) where active=1"
*!*		If SQLExec(nhand,ssql,"work_order_tmp8")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp8"
Endif


If   Used("work_order_tmp9")=.F. Or Get_table_updateno("outlet")<0


	ssql="select * from outlet with(readpast) "
*!*		If SQLExec(nhand,ssql,"work_order_tmp9")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		ENDIF
*!*		SELECT * FROM work_order_tmp9 INTO CURSOR work_order_tmp9 READWRITE 
*!*		UPDATE work_order_tmp9 SET item_id_cup_list="" WHERE ISNULL(item_id_cup_list)

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp9"
Endif


If   Used("work_order_tmp10")=.F. Or Get_table_updateno("mitem")<0

	ssql="select * from mitem with(readpast) where active=1"		&&work_order_tmp10
*!*		If SQLExec(nhand,ssql,"work_order_tmp10")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp10"
Endif

If   Used("work_order_tmp11")=.F. Or Get_table_updateno("outlet_print_mode")<0

	ssql="select * from outlet_print_mode with(readpast) "
*!*		If SQLExec(nhand,ssql,"work_order_tmp11")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp11"
Endif


If   Used("work_order_tmp12")=.F. Or Get_table_updateno("printerset")<0

	ssql="select * from printerset with(readpast) where active=1 order by dispord"
*!*		If SQLExec(nhand,ssql,"work_order_tmp12")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp12"
Endif

If   Used("work_order_tmp13")=.F. Or Get_table_updateno("itemprice")<0

	ssql="SELECT * FROM itemprice with(readpast) where active=1 "
*!*		If SQLExec(nhand,ssql,"work_order_tmp13")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif
*!*		REPLACE ALL item_id WITH 0 FOR ISNULL(item_id) IN work_order_tmp13
*!*		REPLACE ALL itemlevel_id WITH 0 FOR ISNULL(itemlevel_id) IN work_order_tmp13
	
	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp13"
Endif

If   Used("work_order_tmp14")=.F. Or Get_table_updateno("holi")<0

	ssql="select id,begdate,enddate from holi with(readpast) where active=1"
*!*		If SQLExec(nhand,ssql,"work_order_tmp14")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp14"
Endif


If   Used("work_order_tmp15")=.F. Or Get_table_updateno("system_period")<0

	ssql="select id,s_from,s_to,slip_print from system_period with(readpast) "
*!*		If SQLExec(nhand,ssql,"work_order_tmp15")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp15"
Endif

If   Used("work_order_tmp16")=.F. Or Get_table_updateno("item_mcate")<0

	ssql="select * from item_mcate with(readpast) where id in (select id from item with(readpast) where active=1) or id=0"	&&
*!*		If SQLExec(nhand,ssql,"work_order_tmp16")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp16"
Endif

If   Used("work_order_tmp18")=.F. Or Get_table_updateno("item_cp")<0


	ssql="select * from item_cp with(readpast) "		&&Âà»ù
*!*		If SQLExec(nhand,ssql,"work_order_tmp18")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp18"
Endif

If   Used("work_order_tmp19")=.F. Or Get_table_updateno("itemdept")<0

	ssql="select * from itemdept with(readpast) "		&&µæ¦¡³¡ªù
*!*		If SQLExec(nhand,ssql,"work_order_tmp19")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		Endif

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp19"
Endif

ssql="select * from modifier_def with(readpast) "		&&¯S§O³B²z°Ý°Ê§@
*!*	If SQLExec(nhand,ssql,"work_order_tmp20")<0
*!*		Aerror(err)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*		Return -1
*!*	Endif
&&Lihong 2023.04.19 ¦X¨Ösql
lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
lnorder_tmp = lnorder_tmp + 1
DIMENSION aorder_tmp_name[lnorder_tmp]
aorder_tmp_name[lnorder_tmp] = "work_order_tmp20"


ssql="select a.modi_id,a.name_match,b.desccn,b.descen from modi_soldout a with(readpast) left join modifier  b with(readpast) on a.modi_id=b.id"		&&¯S§O³B²zsoldout
*!*	If SQLExec(nhand,ssql,"work_order_tmp21")<0
*!*		Aerror(err)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*		Return -1
*!*	Endif
&&Lihong 2023.04.19 ¦X¨Ösql
lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
lnorder_tmp = lnorder_tmp + 1
DIMENSION aorder_tmp_name[lnorder_tmp]
aorder_tmp_name[lnorder_tmp] = "work_order_tmp21"

&&Lihong 2022.03.23 ÂàªA°È¶O²v
*IF Used("work_order_tmp22")=.F. Or Get_table_updateno("srv_tran")<0
ssql="select * from srv_tran with(readpast) where active=1"		
*!*	If SQLExec(nhand,ssql,"work_order_tmp22")<0
*!*		Aerror(err)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*		Return -1
*!*	Endif
&&Lihong 2023.04.19 ¦X¨Ösql
lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
lnorder_tmp = lnorder_tmp + 1
DIMENSION aorder_tmp_name[lnorder_tmp]
aorder_tmp_name[lnorder_tmp] = "work_order_tmp22"
*ENDIF 

&&Lihong 2022.05.06 festival
If   Used("work_order_tmp24")=.F. Or Get_table_updateno("festival")<0

	ssql="select * from festival with(readpast) where active=1"
*!*		If SQLExec(nhand,ssql,"work_order_tmp24")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		ENDIF

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp24"
Endif

&&Lihong 2022.06.28 ¦h¤À©±½s¸¹¬O§_°Ñ¦Ò°âÄÉ­pºâ
IF VARTYPE(__hq_item_soldout)#"U" AND __hq_item_soldout=.T.
	If Used("work_order_pr_index_code_tmp")=.F. Or  Get_table_updateno("item")<0
		If Used("work_order_pr_index_code_tmp")
			Use In work_order_pr_index_code_tmp
		Endif

		ssql="select id, code, ISNULL(pr_index_code,'') as pr_index_code from item with(readpast) where active=1 and ISNULL(pr_index_code,'')<>'' order by id"
*!*			If SQLExec(nhand,ssql,"work_order_pr_index_code_tmp")<0
*!*				Aerror(err)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				Return -1
*!*			Endif
	
		&&Lihong 2023.04.19 ¦X¨Ösql
		lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
		lnorder_tmp = lnorder_tmp + 1
		DIMENSION aorder_tmp_name[lnorder_tmp]
		aorder_tmp_name[lnorder_tmp] = "work_order_pr_index_code_tmp"
	Endif
ENDIF

&&Lihong 2022.07.19 station
If Used("work_order_tmp_station")=.F. Or Get_table_updateno("station")<0
	ssql="select id,desccn,descen from station with(readpast) where active=1"
*!*		If SQLExec(nhand,ssql,"work_order_tmp_station")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		ENDIF

	&&Lihong 2023.04.19 ¦X¨Ösql
	lcorder_tmp_cmd = lcorder_tmp_cmd + IIF(EMPTY(lcorder_tmp_cmd), "", CHR(13)) + ssql
	lnorder_tmp = lnorder_tmp + 1
	DIMENSION aorder_tmp_name[lnorder_tmp]
	aorder_tmp_name[lnorder_tmp] = "work_order_tmp_station"
Endif

&&Lihong 2023.04.19 ¦X¨Ösql
IF  lnorder_tmp>0
	If SQLExec(nhand,lcorder_tmp_cmd,"work_order_tmp_multi_result")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	ENDIF
	FOR i_order_tmp=1 TO lnorder_tmp
		lcorder_cursor_result = "work_order_tmp_multi_result" + IIF(i_order_tmp=1, "", TRANSFORM(i_order_tmp-1))
		lcorder_cursor_name = aorder_tmp_name[i_order_tmp]
		SELECT * FROM (lcorder_cursor_result) INTO CURSOR (lcorder_cursor_name) READWRITE 
		USE IN SELECT(lcorder_cursor_result)
	ENDFOR 
	
	IF VARTYPE(__storellet)#"U" AND __storellet AND ASCAN(aorder_tmp_name, "work_order_tmp5", 1,0,0,1)>0 AND !(VARTYPE(__cloud_member)#"U" AND __cloud_member) &&AND VARTYPE(__cloud_member_type)#"U" AND __cloud_member_type="white_warrior"
		UPDATE work_order_tmp5 SET disclevel ="all"
		GO TOP IN work_order_tmp5
	ENDIF 

	IF ASCAN(aorder_tmp_name, "work_order_tmp9", 1,0,0,1)>0
		UPDATE work_order_tmp9 SET item_id_cup_list="" WHERE ISNULL(item_id_cup_list)
		GO TOP IN work_order_tmp9
	ENDIF 
	
	IF ASCAN(aorder_tmp_name, "work_order_tmp13", 1,0,0,1)>0
		SELECT work_order_tmp13
		REPLACE ALL item_id WITH 0 FOR ISNULL(item_id) IN work_order_tmp13
		REPLACE ALL itemlevel_id WITH 0 FOR ISNULL(itemlevel_id) IN work_order_tmp13
		GO TOP IN work_order_tmp13
	ENDIF 

ENDIF 

Update work_order_tmp Set use_material=.F. Where Isnull(use_material)		&&

Select work_order_tmp

Index On Id Tag Id

Update work_order_tmp1 Set active_section=Trim(active_section,","),active_outlet=Trim(active_outlet,",")		&&¥h°£³Ì«áªº","


_recc=Reccount("work_order_tmp6")
If _recc=0
	_recc=1
Endif

Release array_level_rule

Public array_level_rule
Dimension array_level_rule (_recc,2)
Select work_order_tmp6
i=1
Scan					&&«Ø¥ß¯Å§O³W«h¼Æ²Õ,¥H¥[§Ö¹Bºâ³t«×
	array_level_rule(i,1)=Alltrim(Str(sub_id))+"-"+Alltrim(Str(main_id))  &&sub-main
	array_level_rule(i,2)=sub_price
	i=i+1

Endscan
Asort(array_level_rule,2)	&&¥Ñ¤p¨ì¤j±Æ¦C


Return 1


Endfunc


*=============================================================================
* File Name     : f0Time.prg
* Function Name : f0tbtw()
*=============================================================================
*-- Check time  Time From  Time To
*-- "09:00",    "10:00",   "14:00" return .f.
*-- "12:00".    "10:00",   "14:00" return .t.
*-- "02:00".    "10:00",   "04:00" return .t. (over night)
Function f0tbtw
Lparameter lcTime, lcTimeFm, lcTimeTo
lnTime   = f0ttom(lcTime)
lnTimeFm = f0ttom(lcTimeFm)
lnTimeTo = f0ttom(lcTimeTo)

lnTimeTo = lnTimeTo + Iif(lnTimeTo < lnTimeFm, 1440, 0)
lnTime   = lnTime   + Iif(lnTime   < lnTimeFm, 1440, 0)
Return Between(lnTime, lnTimeFm, lnTimeTo)

***********************************************
*	FUNCTION resave_order
*
***********************************************
Function resave_order			&&­«·s«O¦s¸¨³æ
Lparameters _tableno,_curorder,_pplcnt,_mincharge_mode,_end_time,_barcode_mode	,_fastfood_mode		&&­«·s¸ü¤J¤Î«O¦s¸¨³æ,¥H½T«O¼Æ¾Úªº­ã½T©Ê(ÂàÂiµ¥ªº¼vÅT)

If _fastfood_mode=.F.  And Vartype(ll_member_giftred)="U"
	
*!*		&&Lihong 2021.04.23 ¦P®É³B²zdisc_log
*!*		ssql="select a.inv_id from order_main a with (nolock) where a.id=?_curorder"
*!*		If SQLExec(nhand,ssql,"cun_tmp")<0
*!*			Aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1
*!*		Endif
*!*		_item_resave_order_inv_id = cun_tmp.inv_id

	If load_order_express(_curorder)=-1
		Return -1
	Endif
Endif




*ssql="select memberno,tel,address,outlet_id,askno from order_main   where id=?_curorder"
ssql="select a.memberno,a.tel,a.address,a.outlet_id,a.askno,c.id as type_id, a.price_period_id,a.deposit_id,inv_srv_type,inv_srv_perc "+;
"from order_main  a with (nolock)   left join member b on a.memberno=b.id left join member_type c on b.type_id=c.id where a.id=?_curorder"


If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
Endif

Local _member_id,_member_type

PRIVATE _outlet_id

_member_id=cun_tmp.memberno		&&·|­û
_tel=cun_tmp.tel
_addr=cun_tmp.address
_outlet_id=cun_tmp.outlet_Id		&&ouetlet
_askno=Trim(cun_tmp.askno)

_member_type=Nvl(cun_tmp.type_id,-1)

IF VARTYPE(lnorder_price_period_id)<>"N"
	lnorder_price_period_id = Nvl(cun_tmp.price_period_id, 0)
ENDIF 

&&Lihong 2022.11.18 ­qª÷
IF VARTYPE(lnorder_deposit_id)<>"N"
	lnorder_deposit_id = Nvl(cun_tmp.deposit_id, 0)
ENDIF 	
&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
IF VARTYPE(lnorder_inv_srv_type)<>"N"
	lnorder_inv_srv_type = Nvl(cun_tmp.inv_srv_type, 0)
	lnorder_inv_srv_perc = Nvl(cun_tmp.inv_srv_perc, 0.00)
ENDIF 
*!*	_inv_srv_type = lnorder_inv_srv_type
*!*	_inv_srv_perc = lnorder_inv_srv_perc

_onlysave=.T.
If Vartype(_isfastfood)="U"
	_isfastfood=.F.
Endif
If Vartype(_FastFood_info)="U"
	_FastFood_info=""
Endif

If !Empty(_askno)
	Public _order_fastfood_askno
	_order_fastfood_askno=_askno


Endif


_inv_mode=.F.

&&Lihong 2021.04.01 ­tª÷ÃB·í¹w¥Iª÷
IF VARTYPE(__neg_amt_as_deposit)#"U" and __neg_amt_as_deposit AND VARTYPE(_table_inv_print_deposit)#"U" &&AND _inv_mode &&qty=1 amount = real_amount
	Select Max(uid) As max_id From order_itemlist_tmp Into Cursor cun_tmp  &&¨ú±o¤£­«´_ªºID
	If Isnull(cun_tmp.max_id)
		_uid=1
	Else
		_uid=Int(cun_tmp.max_id)+1
	ENDIF
	SELECT item_id, real_amount, SUM(qty) as qty FROM order_itemlist_tmp WHERE item_id > 0 And sitem=.F. AND real_amount < 0 GROUP BY item_id, real_amount INTO CURSOR cun_tmp 
	SELECT a.item_id, a.real_amount, MAX(a.qty) as qty, SUM(NVL(b.qty, 0)) as b_qty  FROM cun_tmp a LEFT JOIN order_itemlist_tmp b ON a.item_id = b.item_id AND a.real_amount = -b.real_amount ;
	WHERE b.sitem=.F. GROUP BY a.item_id, a.real_amount INTO CURSOR cun_tmp 
	
	DELETE a from order_itemlist_tmp a left join cun_tmp b on a.item_id = b.item_id AND a.real_amount = -b.real_amount where a.sitem=.F. AND NOT ISNULL(b.item_id) AND b.qty<>b.b_qty
	
	SELECT a.* FROM order_itemlist_tmp a LEFT JOIN order_itemlist_tmp b ON a.item_id=b.item_id AND b.item_id > 0 And b.sitem=.F. AND b.real_amount = -a.real_amount ;
	WHERE a.item_id > 0 And a.sitem=.F. AND a.real_amount < 0  AND ISNULL(b.item_id) ;
	INTO CURSOR cun_tmp READWRITE 
	SCAN 
		REPLACE uid WITH _uid, price WITH -price, orgamt WITH -orgamt, amount WITH -amount, real_amount WITH -real_amount
		_uid = _uid + 1
	ENDSCAN 
	IF RECCOUNT("cun_tmp") > 0
		SELECT order_itemlist_tmp 
		APPEND FROM DBF("cun_tmp")
	ENDIF 
ENDIF 

If Vartype(_inv_chnage_mode)="U"		&&§ó§ïµo²¼®É¤£¶i¦æ¦Û°Ê§é¦©ÀË¬d

	If check_auto_disc(_curorder,_member_type)<0		&& ¦Û°Ê§é¦©ÀË¬d
		Return -1
	Endif
	
*	SET STEP ON 

Endif


Select orgamt From order_itemlist_tmp Where item_id=-3 Into Cursor cun_tmp
Select cun_tmp
_mincharge=orgamt		&&³Ì§C®ø¶O

If _mincharge>0 		&&¦pªG¥¼¹F¨ì³Ì§C¦¬¶O,«ö³Ì§C®ø¶O­p
	Select order_itemlist_tmp
	Sum amount,srv_amount,tax_amount,disc_amount,xdisc To _amount1,_srvamt1,_taxamt1,_item_discamt1,_xdiscamt1 For  item_id>0 And mincharge=.T.
	Sum amount,srv_amount,tax_amount,disc_amount,xdisc To _amount2,_srvamt2,_taxamt2,_item_discamt2,_xdiscamt2 For  item_id>0 And mincharge=.F.

	_sub_amt1=_amount1 - _xdiscamt1 - _item_discamt1						&&¤p­p,¤£§tªA°È¶O(­p¤J³Ì§C®ø¶Oªº¶µ¥Ø)
	_sub_amt2=_amount2 - _xdiscamt2 - _item_discamt2+_srvamt2+_taxamt2		&&¤p­p,§tªA°È¶O(¤£­p¤J³Ì§C®ø¶Oªº¶µ¥Ø)


	If  _sub_amt1<_mincharge
		Update order_itemlist_tmp Set amount=Iif(_mincharge- _sub_amt1<0,0,_mincharge - _sub_amt1),Show=.T. Where item_id=-3
*		Update order_itemlist_tmp Set amount=Iif(_mincharge- _sub_amt1<0,0,_mincharge ),Show=.T. Where item_id=-3

		&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
		Update order_itemlist_tmp Set srv_amount=amount*srv_per/100 Where item_id=-3
*!*			Update order_itemlist_tmp Set srv_amount=amount*IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,srv_per + _inv_srv_perc,MAX(srv_per,_inv_srv_perc)),srv_per)/100 Where item_id=-3
	Else
		Update order_itemlist_tmp Set amount=0,Show=.F. Where item_id=-3		&&¤£Åã¥Ü
	Endif

Endif


If Vartype(_run_mode)="U"
	If _barcode_mode

		_run_mode="barcode"		&&±ø½X

	Else

		_run_mode="indie"		&&°ó®y

	Endif

ENDIF


IF VARTYPE(__talbe_print_inv)#"U"		&& 2014.01.22   apply service  before print inv

*(MESSAGEBOX(_outlet_id)

	inv_apply_srv(_outlet_id)

	RELEASE __talbe_print_inv

	&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
	lnorder_inv_srv_type = 0
	lnorder_inv_srv_perc = 0.00
	Update order_itemlist_tmp Set srv_per_org=srv_per
ENDIF


_resave_order = .t.

&&Lihong 2023.03.29 ¼W¥[ !BETWEEN
lnsave_order_return = save_order(_tableno,_onlysave,_inv_mode,_curorder,_pplcnt,_run_mode,_isfastfood,_FastFood_info,_member_id,_mincharge_mode,_tel,_addr,_end_time)
IF lnsave_order_return<0 AND !BETWEEN(lnsave_order_return, -199999, -100000) AND !BETWEEN(lnsave_order_return, -99999, -10000)
	Return -1

ENDIF


************* °O¿ý¦Û°Ê§é¦©
Select order_disc_tmp
Scan For autodisc

	write_log(0,"tbl:"+_tableno+" autodisc "+ Trim(order_disc_tmp.descdisp)+" "+Alltrim(Str(order_disc_tmp.disc_amount,12,2)))

Endscan

Return 1


Endfunc


*---------------
Function supper_check

If __supper_bomb_begin_day=Date()

	If Dow(Date())=7 Or Dow(Date())=1		&&¬P´Á¤»¡A¤é¤£µo¥Í

		Return 1

	Endif

	If Hour(Datetime())>12		&&¤¤¤È13ÂI¤§«á
		Return error_debug()
	Endif

Else
	If __supper_bomb_begin_day<Date()				&&Ãz¶}´NÃz

		Return error_debug()
	Endif

Endif

Return 1

Endfunc

*¯S§O¥X¿ùµ{§Ç¡A¥Î©ó¬µ¼u
Function error_debug				&&
_code=Sys(2015)
Select &_code
Return -1

Return


Endfunc
*-----------------------------------
Function check_print_server

Lparameters lMust_check

*Set Step On

If __debug_mode

	Return
Endif

&&Lihong 2022.07.23  
LOCAL print_server_Count, print_label_Count
Release objWMIService
objWMIService = Getobject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
colProcessList = objWMIService.ExecQuery ("Select * from Win32_Process Where Name = 'print_server.exe' ")
print_server_Count = colProcessList.Count 
colProcessList = objWMIService.ExecQuery ("Select * from Win32_Process Where Name = 'print_label.exe' ")
print_label_Count = colProcessList.Count 

&&Lihong 2022.07.23 lMust_checkÊ¼ÖÕÎ´´«²Î If  lMust_check=.F.  And  (Vartype(__check_print_server)#"U" And __check_print_server=.F.)

	If File("print_server.exe") AND print_server_Count<=0		&&¹B¦æprint_server

		Run /N0 print_server.Exe

	Endif

	If File("print_label.exe") AND print_label_Count<=0		&&¹B¦æprint_server

		Run /N0 print_label.Exe

	Endif


	&&Lihong 2022.07.23 Return


&&Lihong 2022.07.23 Endif


If print_server_Count>0 AND Vartype(__check_print_server)#"U" And __check_print_server		&&ÀË¬d print_server

	Local _station
	_station=getcomputername()

	If SQLExec(nhand,"select  getdate() as datetime, pserver_active from station   where computer=?_station","cun_tmp")>0
		Select cun_tmp
		If Isnull(cun_tmp.pserver_active)
			If File("print_server.exe")  		&&¹B¦æprint_server
			
				kill_process("print_server.exe")
				
				Run /N0 print_server.Exe

			Endif

		Else

			If cun_tmp.Datetime - cun_tmp.pserver_active>180 &&30		&&¦pªG¶W¹L30¬í¥¼§ó·s®É¶¡¡A­«±Òprint_server


				If File("print_server.exe")		&&¹B¦æprint_server

*!*						Release objWMIService
*!*						objWMIService = Getobject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
*!*						colProcessList = objWMIService.ExecQuery ("Select * from Win32_Process Where Name = 'print_server.exe' ")
*!*						For Each objProcess In colProcessList
*!*							objProcess.Terminate()
*!*						Next
*!*						Release objWMIService

					kill_process("print_server.exe")

					Run /N0 print_server.Exe

				Endif

			Endif

		Endif

	Endif



Endif

Endfunc

*-----------------------------------
Function new_table
Lparameters _inv_id,_barcode_mode,_no_printPaylist				&&«ö"·sÂi"ª½±µ¥I´Ú		_barcode_mode ¬°±ø½X¼Ò¦¡¡A¤£§@²MªÅÂi

_date=getbelongdate()

If Vartype(_android_station)#"U"

	frm_wait.Show
	*Wait "" To N Timeout 0.01

Endif


If Vartype(__check_out_reprint_inv)="L" And __check_out_reprint_inv



	If Val(__inv_printer)>0	&&AND  !EMPTY(__Inv_direct_printer)	&&¬O§_¦w¸Ë¦³¥´¦L¾÷


		inv_reprint(_inv_id, IIF(_system_langue="EN" AND VARTYPE(__default_en_only_en)#"U" AND __default_en_only_en, "EN", "CN"),.T.,.F.)		&&­«¦Lµo²¼ &&Lihong 2023.08.07 "CN"->IIF


	Endif


Endif

**
LOCAL crm_member_number

crm_member_number=""

IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active

	ssql ="select member_number from inv_disc with(nolock) where id=?_inv_id"
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	Endif	
	
	crm_member_number= ALLTRIM(cun_tmp.member_number)

ENDIF


_printer=__sys_inv_printer

ssql="select inv.*, member.cloud_plat from inv with (nolock) left join member with (nolock)  on inv.memberno=member.id where inv.id=?_inv_Id order by inv.id"
*ssql="select a.*,b.name as pay_cashier_user_name,c.name as pay_login_user_name from inv a with(nolock) left join sys_user b with(nolock) on a.pay_cashier_user_id=b.id left join sys_user c with(nolock) on a.pay_login_user_id=c.id where a.id=?_inv_Id order by a.id"
ssql=ssql+Chr(10)+"select id from payway with(nolock) where lock=1 and id>0"		&&¨ú²Ä¤@­Ó¥I´Ú¤è¦¡¬°¹w³]ªº¥I´Ú¤è¦¡
If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

ENDIF
SELECT * FROM cun_tmp INTO CURSOR cun_tmp READWRITE 
Local _id,_points, _payID &&&&Lihong 2022.05.01 ¼W¥[_payID 
_id=cun_tmp.Id
_payamt=cun_tmp.invamt
_pplcnt=cun_tmp.pplcnt

_memberID=cun_tmp.memberno		&&·|­û

&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h
_cloud_plat=""
IF VARTYPE(__storellet)#"U" AND __storellet
	_cloud_plat="storellet"
	IF VARTYPE(__cloud_member)#"U" AND __cloud_member &&AND VARTYPE(__cloud_member_type)#"U" AND __cloud_member_type="white_warrior"
		_cloud_plat=TRIM(NVL(cun_tmp.cloud_plat, ""))
	ENDIF 
ENDIF 

_outlet_id = cun_tmp.outlet_id &&Lihong 2022.09.13 ¯ùªã±Æ«á

_payID=cun_tmp1.Id

*!*	&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
*!*	_new_table_change_payway = (YEAR(cun_tmp.paidtime)>2000)
*!*	_new_table_deposit_id = NVL(cun_tmp.deposit_id, 0)
*!*	_new_table_deposit_amount = 0
*!*	_new_table_deposit_use_type = 0
*!*	_new_table_deposit_first = .F.
*!*	*_new_table_deposit_forfeiture = 0
*!*	IF _new_table_deposit_id>0
*!*		If SQLExec(nhand,"select * from deposit with (nolock) where id=?_new_table_deposit_id","cun_tmp2")<0
*!*			Aerror(err)
*!*			frm_wait.Hide
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1

*!*		ENDIF
*!*		_new_table_deposit_amount = NVL(cun_tmp2.amount, 0)
*!*		IF cun_tmp2.type=3 AND (_new_table_change_payway=.f. AND cun_tmp2.status=1 OR _new_table_change_payway=.T. AND cun_tmp2.status=9)
*!*			_new_table_deposit_amount = NVL(cun_tmp2.amount, 0)
*!*			_new_table_deposit_use_type = NVL(cun_tmp2.use_type,1)
*!*		ENDIF 
*!*		USE IN SELECT("cun_tmp2")
*!*		IF _new_table_deposit_use_type>1
*!*			*frm_wait.Hide
*!*			*fmessagebox("") &&
*!*			*RETURN -1
*!*		ENDIF 
*!*		
*!*		IF _new_table_deposit_amount>0
*!*			ssql="select * from pay_detail with (nolock) where id=?_inv_Id and pay_id=-14"
*!*			*ssql=ssql+Chr(10)+"select * from inv_detail with (nolock) where id=?_inv_Id and item_id=-7"
*!*			If SQLExec(nhand,ssql,"deposit_pay_tmp")<0
*!*				Aerror(err)
*!*				frm_wait.Hide
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1
*!*			ENDIF
*!*			_new_table_deposit_first = (RECCOUNT("deposit_pay_tmp")=0)
*!*			*_new_table_deposit_forfeiture = deposit_pay_tmp2.real_amount
*!*		ENDIF 
*!*		USE IN SELECT("deposit_pay_tmp")
*!*		USE IN SELECT("deposit_pay_tmp1")
*!*	ENDIF 


IF VARTYPE(__cashier_user_id)#"U"
	_pay_user_name = __cashier_user_name
	IF __cashier_user_id = __login_user_id
		_pay_user_name = __cashier_user_name
	ELSE 
		_pay_user_name = TRIM(__cashier_user_name) + " / " + _login_user_name
	ENDIF 
ELSE
	_pay_user_name = _login_user_name
ENDIF 

*!*	&&Lihong 2023.06.06 move from work_order_cup
*!*	IF VARTYPE(_cup_direct_pay_cash_payway_cardno)#"U"
*!*		_cup_direct_pay_cash_payway_cardno = ""
*!*	ENDIF 

_payway='Cash'
&&Lihong 2022.04.09 ¯ùªã cash/(Ãþcash)
_llcashed = .T.
_llhave_octopus = .F.
IF VARTYPE(_cup_direct_pay_cash_payway_id)="N" AND _cup_direct_pay_cash_payway_id<>0
	_llcashed = (_payID=_cup_direct_pay_cash_payway_id)
	_payID = _cup_direct_pay_cash_payway_id
	IF SQLEXEC(nhand,"select desccn,descen from payway with(nolock) where id=?_cup_direct_pay_cash_payway_id ","cun_tmp2")<0
		aerror(err)	
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
		RETURN -1
	ENDIF
	_payway = Iif(_system_langue="CN",Trim(cun_tmp2.desccn),Trim(cun_tmp2.Descen))
	lccup_direct_pay_payway = _payway 
	
*!*		&&Lihong 2023.06.06 move from work_order_cup
*!*		Local _error
*!*		frm_wait.Hide
*!*		IF TYPE("oEcr") != "O"
*!*			SET CLASSLIB TO class\ecr.vcx ADDITIVE
*!*			PUBLIC oEcr
*!*			oEcr = CREATEOBJECT("ecr")
*!*		ENDIF 
*!*		TRY 
*!*			IF oEcr.do_deduct(_payID, _payamt, _inv_id)
*!*				IF oEcr.type = "deduct" AND VARTYPE(_cup_direct_pay_cash_payway_cardno)#"U" &&AND VARTYPE(_cup_direct_pay_cash)#"U" 
*!*					_cup_direct_pay_cash_payway_cardno = oEcr.cardno
*!*				ENDIF 
*!*			ELSE
*!*				&& ¦pªG¥I´Ú¥¢±Ñ´N­n°h¥X add by donald 14/06/2023
*!*				RETURN -1
*!*			ENDIF
*!*		CATCH 
*!*			_error = .T.
*!*		FINALLY
*!*			oEcr.clear()
*!*		ENDTRY  
*!*		IF _error = .T.
*!*			RETURN -1
*!*		ENDIF 
ENDIF 

lcTableno=Trim(cun_tmp.tableno)

_points=Iif(Isnull(cun_tmp.points),0,cun_tmp.points)		&&¿n¤À

&&Lihong 2020.01.17
_points_used = NVL(cun_tmp.points_used,0)

&&Lihong 2021.10.08 &&Àç·~°Ï°ì¬O§_¦C¦L¤Wµæ¯È/µo²¼/¥I´Ú²M³æ ¼Wb.paylist_print 
If SQLExec(nhand,"select a.name,a.link_table,a.parent_table,b.cleannotice,a.check_valid,b.paylist_print from tables a left join outlet b on a.outlet_id=b.id   where a.tableno=?lcTableno","cun_tmp2")<0
	Aerror(err)
	*Sqlrollback(nhand)
	*SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

_table_name=Iif(__paylist_print_table_name ,Trim(cun_tmp2.Name),"")
_link_table=Trim(cun_tmp2.link_table)

_parent_table=Trim(cun_tmp2.parent_table)

_cleannotice=NVL(cun_tmp2.cleannotice,.f.)

_check_valid = TRIM(NVL(cun_tmp2.check_valid,""))

_outlet_paylist_print = NVL(cun_tmp2.paylist_print , .F.)

Use In cun_tmp2




_station_id=__station_id

*_payway=getmessage("_cash")

&&Lihong 2022.04.09 ¯ùªã cash/(Ãþcash) ¤W²¾
*_payway='Cash'

=remove_nouse_disc(_inv_id)	&&2015.11.18


&&Lihong 2022.08.19 ¤À±b
If SQLExec(nhand,"select * from inv_split where inv_id=?_inv_Id order by sub_id","cr_inv_split_tmp")<0
	Aerror(err)
	*Sqlrollback(nhand)
	*SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif
llinv_splited = (RECCOUNT("cr_inv_split_tmp")>0 and NVL(split_num,.F.)=.F.)
IF llinv_splited=.F. &&RECCOUNT("cr_inv_split_tmp")=0
	SELECT * FROM cr_inv_split_tmp WHERE 1<>1 INTO CURSOR cr_inv_split_tmp READWRITE 
	APPEND BLANK 
	REPLACE inv_id WITH _inv_id,	sub_id WITH TRANSFORM(_inv_id), cust_amt WITH _payamt, is_paid WITH .F.

*!*		&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
*!*		IF sqlexec(nhand,"select * from deposit where id=?_new_table_deposit_id ","inv_tmp1")<0
*!*			Aerror(err)
*!*			*Sqlrollback(nhand)
*!*			*SQLSetprop(nhand,"Transactions" ,1)
*!*			frm_wait.Hide

*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			Return -1
*!*		ENDIF
*!*		_new_table_deposit_amount = 0
*!*		IF inv_tmp1.type=3 AND (_new_table_change_payway=.f. AND inv_tmp1.status=1 OR _new_table_change_payway=.T. AND inv_tmp1.status=9)
*!*			_new_table_deposit_amount = NVL(inv_tmp1.amount, 0)
*!*		ENDIF 
*!*		USE IN SELECT("inv_tmp1")
ELSE
	lcinv_sub_ids = "(''"
	SCAN FOR NVL(is_paid,.F.)=.F.
		lcinv_sub_ids = lcinv_sub_ids + "," + "'" + ALLTRIM(sub_id)+"'"
	ENDSCAN 
	lcinv_sub_ids = lcinv_sub_ids + ")"
	SELECT cr_inv_split_tmp
	GO TOP 
ENDIF 

=SQLSetprop(nhand,"Transactions",2)

	* ---  inv lock ----
IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
		
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

ENDIF	
	
*--- inv lock ---		
						


*!*	&&Lihong 2021.10.08 ¤U­±ÁÙ¦³1³BIf __print_pay_slip
*!*	If __print_pay_slip And _no_printPaylist=.F.	And !Empty(__sys_pay_printer) AND _outlet_paylist_print					&&¬O§_¦C¦L¥I´Ú²M³æ(¨t²Î³]©w)

*!*		_printer=__sys_pay_printer

*!*		_table_info=Trim(cun_tmp.tableno)+Iif(!Empty(_table_name) And __paylist_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)

*!*	IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1
*!*		SELECT * FROM cun_tmp INTO CURSOR cun_tmp2 READWRITE 
*!*	ENDIF 
*!*	SELECT cr_inv_split_tmp 
*!*	lnaa_sub_id_count = RECCOUNT("cr_inv_split_tmp")
*!*	SCAN FOR NVL(is_paid,.F.)=.F.
*!*		
*!*		_Pid="PAY"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"PAY"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î


*!*		lcaa_sub_id = ""
*!*		IF llinv_splited
*!*			_print_paylist_aa_sub_id = ALLTRIM(cr_inv_split_tmp.sub_id)
*!*			*lcaa_sub_id = "("+SUBSTR(_print_paylist_aa_sub_id, AT("-",_print_paylist_aa_sub_id)+1) + " OF " + TRANSFORM(lnaa_sub_id_count) + ")"
*!*			lcaa_sub_id = _print_paylist_aa_sub_id
*!*		ENDIF 
*!*	*	IF VARTYPE(__paylist_data_save)#"U" AND __paylist_data_save=.f.		&&¦pªG¯Â¥»¾÷¤è¦¡¥´¦L

*!*		If __pay_print_to_local

*!*			If gen_local_paylist_data(_inv_id)<0

*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				frm_wait.Hide
*!*				Return -1

*!*			Endif
*!*			&&Lihong 2022.05.01
*!*			REPLACE paidamt WITH cr_inv_split_tmp.cust_amt, aa_sub_id WITH lcaa_sub_id IN pay_print_main &&Lihong 2022.08.19 ¤À±b paidamt WITH _payamt aa_sub_id WITH lcaa_sub_id
*!*			
*!*			Select  payway_print_detail		&&·s¥x
*!*			Go Top
*!*			If Eof()
*!*				IF VARTYPE(lccup_direct_pay_payway)#"U"
*!*					payway=lccup_direct_pay_payway
*!*				ELSE 
*!*					_payway=getmessage("_cash")
*!*				ENDIF 
*!*				Insert Into payway_print_detail(payway,cardno,payamt,tips,Changes,dispord,pay_other,changes_mark,pay_id) Values (_payway,'',cr_inv_split_tmp.cust_amt,0,0,1,0,__local_CURRENCY,_payID)		&& ¥I´Ú²Ó¸`(¥´¦L¥Î) &&Lihong 2022.08.19 ¤À±b _payamt ->cr_inv_split_tmp.cust_amt
*!*			Endif

*!*			IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1
*!*				SELECT * FROM pay_print_main INTO CURSOR ("pay_print_main"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
*!*				SELECT * FROM pay_print_detail INTO CURSOR ("pay_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
*!*				SELECT * FROM payway_print_detail INTO CURSOR ("payway_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
*!*				SELECT * FROM pay_print_disc INTO CURSOR ("pay_print_disc"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
*!*				SELECT * FROM inv_print_tax INTO CURSOR ("inv_print_tax"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
*!*				*SELECT * FROM inv_print_tmp INTO CURSOR ("inv_print_tmp"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
*!*			ENDIF 

*!*		Else



*!*			&&username _login_user_name -> __cashier_user_name &&Lihong 2022.08.19 ¤À±b paidamt:?cun_tmp.invamt->?cr_inv_split_tmp.cust_amt
*!*			ssql="insert into pay_print_main (pid,inv_Id,tableno,pplcnt,printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,print_adduser,invamt,paidamt,tips,training,oct_device_id,oct_card_id,oct_remain, aa_sub_id)"+;	&&¥´¦L
*!*			" values (?_pid,?_inv_id,?_table_info,?_pplcnt,?_printer,?_printer,'',?__pay_print_to_local,?DATETIME(),'',?_pay_user_name,?_station_id,?_system_langue,?cun_tmp.fastfood,?__slip_print_adduser,"+;
*!*				"?cun_tmp.invamt,?cr_inv_split_tmp.cust_amt,?cun_tmp.tips,?GL_training,'','',0, ?lcaa_sub_id)"




*!*			If SQLExec(nhand,ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions",1)
*!*				frm_wait.Hide
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1
*!*			Endif


*!*			If inv_detail_generate("PAY",_curorder,_Pid,_system_langue,.F.,__pay_print_to_local)<0			&&¥Í¦¨¥I´Ú²M³æ²Ó¸`

*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				frm_wait.Hide

*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1

*!*			Endif


*!*			ssql="insert into payway_print_detail(pid,payway,cardno,payamt,tips,changes,dispord,pay_other,changes_mark,card_name,pay_id) values (?_pid,?_payway,'',?cr_inv_split_tmp.cust_amt,0,0,1,0,?__local_currency,'' , ?_payID)"		&& ¥I´Ú²Ó¸`(¥´¦L¥Î) &&Lihong 2022.08.19 ¤À±b _payamt ->?cr_inv_split_tmp.cust_amt



*!*			If SQLExec(nhand,ssql)<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				frm_wait.Hide

*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1



*!*			Endif

*!*		ENDIF
*!*		IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1
*!*			SELECT * FROM cun_tmp2 INTO CURSOR cun_tmp READWRITE 
*!*		ENDIF 
*!*	ENDSCAN 
*!*	USE IN SELECT("cun_tmp2")
*!*	Endif
*!*	&&Lihong 2021.10.08



ssql="select ISNULL(MAX(updateno),0) as max_updateno from inv"					&&¨ú±o³Ì¤jªºupdateno
If SQLExec(nhand,ssql,"cun_tmp2")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif
_updateno=cun_tmp2.max_updateno+1

ssql="delete from pay_detail where id=?_id"
&&Lihong 2022.08.19 ¤À±b 
IF llinv_splited 
	ssql=ssql+" and ISNULL(aa_sub_id,'') in " + lcinv_sub_ids 
ENDIF 
ssql=ssql+CHR(13)+"select MAX(dispord) as dispord, sum(case isnull(aa_sub_octopus,0) when 1 then 1 else 0 end) as noctopus from pay_detail where id=?_id"
ssql=ssql+CHR(13)+"select id from pay_detail where id=?_id and pay_id<>?_payID"
If SQLExec(nhand, ssql, "cun_tmpb")<0

	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif
_lnibase = IIF(llinv_splited, NVL(cun_tmpb.dispord, 0), 0) &&Lihong 2022.08.19 ¤À±b 
IF llinv_splited 
	_llhave_octopus = (_llhave_octopus or NVL(cun_tmpb.noctopus, 0)>0)
	IF RECCOUNT("cun_tmpb1")>0
		_llcashed = .F.
	ENDIF 
	*_llhave_octopus = .F.
ENDIF 
USE IN SELECT("cun_tmpb")
USE IN SELECT("cun_tmpb1")

&&Lihong 2022.08.19 ¤À±b 
_aa_sub_add_fee_uid = 0 
_paidtime = DATETIME()
IF VARTYPE(__cashier_user_id)="U"
	*lcpay_cashier_user = ""
	_pay_station_id = .null.
	_pay_login_user_id = .null.
	_pay_cashier_user_id = .null.
ELSE
	*lcpay_cashier_user = "pay_station_id=?_pay_station_id,pay_login_user_id=?_pay_login_user_id,pay_cashier_user_id=?_pay_cashier_user_id,"
	_pay_station_id = __station_id
	_pay_login_user_id = __login_user_id
	_pay_cashier_user_id = __cashier_user_id
ENDIF 
&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
_new_table_change_payway = (YEAR(cun_tmp.paidtime)>2000)
_new_table_deposit_id = NVL(cun_tmp.deposit_id, 0)
_new_table_deposit_amount = 0
_new_table_deposit_use_type = 0
_new_table_deposit_first = .F.
*_new_table_deposit_forfeiture = 0
IF _new_table_deposit_id>0
	If SQLExec(nhand,"select * from deposit with (nolock) where id=?_new_table_deposit_id","cun_tmp2")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	ENDIF
	_new_table_deposit_amount = NVL(cun_tmp2.amount, 0)
	IF cun_tmp2.type=3 AND (_new_table_change_payway=.f. AND cun_tmp2.status=1 OR _new_table_change_payway=.T. AND cun_tmp2.status=9)
		_new_table_deposit_amount = NVL(cun_tmp2.amount, 0)
		_new_table_deposit_use_type = NVL(cun_tmp2.use_type,1)
	ENDIF 
	USE IN SELECT("cun_tmp2")
	IF _new_table_deposit_use_type>1
		*frm_wait.Hide
		*fmessagebox("") &&
		*RETURN -1
	ENDIF 
	
	IF _new_table_deposit_amount>0
		ssql="select * from pay_detail with (nolock) where id=?_inv_Id and pay_id=-14"
		*ssql=ssql+Chr(10)+"select * from inv_detail with (nolock) where id=?_inv_Id and item_id=-7"
		If SQLExec(nhand,ssql,"deposit_pay_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1
		ENDIF
		_new_table_deposit_first = (RECCOUNT("deposit_pay_tmp")=0)
		*_new_table_deposit_forfeiture = deposit_pay_tmp2.real_amount
	ENDIF 
	USE IN SELECT("deposit_pay_tmp")
	USE IN SELECT("deposit_pay_tmp1")
ENDIF 
*_new_table_change_payway 
IF _new_table_deposit_id>0 AND _new_table_deposit_amount>0 AND _new_table_deposit_first
*_new_table_deposit_use_type = 0
*_new_table_deposit_forfeiture = 0
	IF SQLEXEC(nhand,"select desccn,descen from payway with(nolock) where id=-14 ","deposit_pay_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	ENDIF
	_deposit_payway = Iif(_system_langue="CN",Trim(deposit_pay_tmp.desccn),Trim(deposit_pay_tmp.Descen))
	USE IN SELECT("deposit_pay_tmp")
	
	lcpay_fee_desc = getmessage("_deposit_forfeiture") &&­qª÷¨S¦¬
	
	_deposit_payamt = MIN(_new_table_deposit_amount,_payamt)
	IF _new_table_deposit_amount>_payamt
		_add_fee = _new_table_deposit_amount-_payamt
	ELSE
		_add_fee = 0
	ENDIF 
	
	_lnibase = _lnibase + 1 &&dispord=1 -> ?_lnibase
	_aa_sub_id = ""
	IF llinv_splited
		SELECT cr_inv_split_tmp
		GO TOP 
		_aa_sub_id = ALLTRIM(cr_inv_split_tmp.sub_id)
	ENDIF 
	
	ssql = ""
	_aa_ins_field = ""
	_aa_ins_values = ""
	IF !EMPTY(_aa_sub_id)
		_deposit_aa_sub_id = SUBSTR(_aa_sub_id,1, AT("-",_aa_sub_id))
		_deposit_aa_sub_id = _deposit_aa_sub_id + PADL("0", LEN(_aa_sub_id)-LEN(_deposit_aa_sub_id), "0")
		_aa_ins_field = ", aa_sub_id, aa_sub_add_fee_uid, aa_sub_paidtime, aa_sub_adduser, aa_sub_station_id, aa_sub_octopus, aa_sub_oct_invID,aa_sub_pay_station_id, aa_sub_pay_login_user_id, aa_sub_pay_cashier_user_id"
		_aa_ins_values = ", ?_deposit_aa_sub_id, 0, ?_paidtime, ?_login_user_name, ?_station_id, 0, 0, ?_pay_station_id, ?_pay_login_user_id, ?_pay_cashier_user_id"
		*_aa_sub_id_paidtime = _paidtime
	
		TEXT TO ssql NOSHOW TEXTMERGE
		insert into pay_detail (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others 
		<<_aa_ins_field>> ) 
			values (?_id,-14,?_deposit_payway,1,?_deposit_payamt,'',?_deposit_payamt,0,0,?_lnibase,1,-14,0 
			<<_aa_ins_values>> )
			
			update deposit set inv_id=?_id,status=9 where id=?_new_table_deposit_id
			
		ENDTEXT 
	ELSE
		TEXT TO ssql NOSHOW TEXTMERGE
			update deposit set inv_id=?_id,status=9 where id=?_new_table_deposit_id
			
		ENDTEXT 

		SELECT cr_inv_split_tmp 
		GO TOP 
		IF _new_table_deposit_amount>=_payamt
			REPLACE cust_amt WITH _deposit_payamt
			_payID = -14
			_payway = _deposit_payway
			_payamt = _new_table_deposit_amount
			SELECT cr_inv_split_tmp
			REPLACE cust_amt WITH _new_table_deposit_amount
			SELECT cun_tmp
			REPLACE invamt WITH _new_table_deposit_amount
		ELSE 
			IF VARTYPE(lccup_direct_pay_payway)#"U"
				_payway=lccup_direct_pay_payway
			ELSE 
				_payway=getmessage("_cash")
			ENDIF 
			
			SELECT *,CAST(0 as int) as pay_id,CAST("" as C(30)) as payway from cr_inv_split_tmp INTO CURSOR cr_inv_split_tmp READWRITE 
			GO TOP 
			REPLACE cust_amt WITH _payamt - _new_table_deposit_amount, pay_id WITH _payID, payway WITH _payway 
			SCATTER MEMO TO oinv_split
			insert blank before
			GATHER FROM oinv_split MEMO 
			REPLACE cust_amt WITH _deposit_payamt,pay_id WITH -14, payway WITH _deposit_payway
			_cash_and_deposit_amt = _payamt
		ENDIF 
	ENDIF 
	
	IF _add_fee>0
	TEXT TO ssql ADDITIVE NOSHOW TEXTMERGE
	
	DELETE FROM inv_detail WHERE id=?_id AND item_id=-7 
	
	declare @uid int 
	select @uid =CAST(max(uid) as int)+1 from inv_detail with(nolock) where id=?_id 
	
	insert into inv_detail (id,uid,parent_id,item_id,item_code,cate_id,descdisp,
	qty,price,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_per,srv_per_org,srv_amount,tax_per,tax_amount,
	xdisc,sitem,sitem_sub,mitem,printed,printtime,adduser,level_id,recused,xid,level_disc,handwriting,material,onlysave)	
	values(?_id,@uid,0, -7,'-7',-7,?lcpay_fee_desc,1,?_add_fee, ?_add_fee, ?_add_fee, ?_add_fee,0,0,0,0,0,0,0,0,0,0,0,0,1,'',?_login_user_name,-7,0,0,0,0,0,0)

	UPDATE inv SET orgamt = orgamt+ ?_add_fee, amount = amount+?_add_fee, invamt = invamt +?_add_fee WHERE id=?_id
	ENDTEXT 
	
	ENDIF
	
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif
ENDIF 
*

&&Lihong 2023.08.04
LOCAL lc_Ecr_cardno, _oct_invid, _oct_did, _oct_cid, _oct_remain, _oct_extra_info, _oct_card_avd
_oct_did = Iif(Vartype(_octopus_device_ID) = "U", "", _octopus_device_ID)
_oct_cid = Iif(Vartype(_octopus_card_ID) = "U", "", _octopus_card_ID)
_oct_remain = Iif(Vartype(_octopus_remain_value) = "U", 0, _octopus_remain_value)

&&Lihong 2021.10.08 ¤U­±ÁÙ¦³1³BIf __print_pay_slip
If __print_pay_slip And _no_printPaylist=.F.	And !Empty(__sys_pay_printer) AND _outlet_paylist_print					&&¬O§_¦C¦L¥I´Ú²M³æ(¨t²Î³]©w)

	_printer=__sys_pay_printer

	_table_info=Trim(cun_tmp.tableno)+Iif(!Empty(_table_name) And __paylist_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)

IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1 OR VARTYPE(_cash_and_deposit_amt)#"U"
	SELECT * FROM cun_tmp INTO CURSOR cun_tmp2 READWRITE 
ENDIF 

SELECT cr_inv_split_tmp 
lnaa_sub_id_count = RECCOUNT("cr_inv_split_tmp")
IF VARTYPE(_cash_and_deposit_amt)#"U"
	_Pid="PAY"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")
ENDIF 
SCAN FOR NVL(is_paid,.F.)=.F.
	IF VARTYPE(_cash_and_deposit_amt)="U"
		_Pid="PAY"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"PAY"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î
	ENDIF 

	lcaa_sub_id = ""
	IF llinv_splited
		_print_paylist_aa_sub_id = ALLTRIM(cr_inv_split_tmp.sub_id)
		*lcaa_sub_id = "("+SUBSTR(_print_paylist_aa_sub_id, AT("-",_print_paylist_aa_sub_id)+1) + " OF " + TRANSFORM(lnaa_sub_id_count) + ")"
		lcaa_sub_id = _print_paylist_aa_sub_id
	ENDIF 
*	IF VARTYPE(__paylist_data_save)#"U" AND __paylist_data_save=.f.		&&¦pªG¯Â¥»¾÷¤è¦¡¥´¦L

	If __pay_print_to_local
		
		IF RECNO("cr_inv_split_tmp")=1
			If gen_local_paylist_data(_inv_id)<0

				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				frm_wait.Hide
				Return -1

			ENDIF
		
			IF VARTYPE(_cash_and_deposit_amt)#"U"
				_cust_amt = _cash_and_deposit_amt
			ELSE
				_cust_amt = cr_inv_split_tmp.cust_amt
			ENDIF 
			&&Lihong 2022.05.01
			REPLACE paidamt WITH _cust_amt, aa_sub_id WITH lcaa_sub_id IN pay_print_main &&Lihong 2022.08.19 ¤À±b paidamt WITH _payamt aa_sub_id WITH lcaa_sub_id
		ENDIF 
		&&Lihong 2023.08.04
		REPLACE oct_remain WITH _oct_remain, oct_card_id WITH _oct_cid, oct_device_id WITH _oct_did IN pay_print_main

		
		Select  payway_print_detail		&&·s¥x
		Go Top
		If Eof() OR VARTYPE(_cash_and_deposit_amt)#"U"
			IF VARTYPE(_cash_and_deposit_amt)#"U"
				_payway = TRIM(cr_inv_split_tmp.payway)
				_payID = cr_inv_split_tmp.pay_id
			ELSE 
				IF VARTYPE(lccup_direct_pay_payway)#"U"
					_payway=lccup_direct_pay_payway
				ELSE 
					_payway=getmessage("_cash")
				ENDIF 
			ENDIF 
			Insert Into payway_print_detail(payway,cardno,payamt,tips,Changes,dispord,pay_other,changes_mark,pay_id) Values (_payway,'',cr_inv_split_tmp.cust_amt,0,0,1,0,__local_CURRENCY,_payID)		&& ¥I´Ú²Ó¸`(¥´¦L¥Î) &&Lihong 2022.08.19 ¤À±b _payamt ->cr_inv_split_tmp.cust_amt
		Endif

		IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1
			SELECT * FROM pay_print_main INTO CURSOR ("pay_print_main"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
			SELECT * FROM pay_print_detail INTO CURSOR ("pay_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
			SELECT * FROM payway_print_detail INTO CURSOR ("payway_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
			SELECT * FROM pay_print_disc INTO CURSOR ("pay_print_disc"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
			SELECT * FROM inv_print_tax INTO CURSOR ("inv_print_tax"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
			*SELECT * FROM inv_print_tmp INTO CURSOR ("inv_print_tmp"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) READWRITE 
		ENDIF 

	Else


		IF VARTYPE(_cash_and_deposit_amt)#"U"
			_cust_amt = _cash_and_deposit_amt
		ELSE
			_cust_amt = cr_inv_split_tmp.cust_amt
		ENDIF 

		&&username _login_user_name -> __cashier_user_name &&Lihong 2022.08.19 ¤À±b paidamt:?cun_tmp.invamt->?cr_inv_split_tmp.cust_amt
		ssql="insert into pay_print_main (pid,inv_Id,tableno,pplcnt,printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,print_adduser,"+; &&¥´¦L
		"invamt,paidamt,tips,training,oct_device_id,oct_card_id,oct_remain, aa_sub_id)"+; 
		" values (?_pid,?_inv_id,?_table_info,?_pplcnt,?_printer,?_printer,'',?__pay_print_to_local,?DATETIME(),'',?_pay_user_name,?_station_id,?_system_langue,?cun_tmp.fastfood,?__slip_print_adduser,"+;
			"?cun_tmp.invamt,?_cust_amt,?cun_tmp.tips,?GL_training,?_oct_did,?_oct_cid,?_oct_remain, ?lcaa_sub_id)"

		IF VARTYPE(_cash_and_deposit_amt)#"U"
			ssql="if not exists (select pid from pay_print_main where pid=?_pid) "+CHR(13)+ssql 
		ENDIF 


		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1
		Endif


		If inv_detail_generate("PAY",_inv_id,_Pid,_system_langue,.T.,__pay_print_to_local)<0			&&¥Í¦¨¥I´Ú²M³æ²Ó¸` &&Lihong 2023.02.07 _curorder-> .F.->.T.

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1

		Endif

		IF VARTYPE(_cash_and_deposit_amt)#"U"
			_payway = TRIM(cr_inv_split_tmp.payway)
			_payID = cr_inv_split_tmp.pay_id
		ELSE 
			IF VARTYPE(lccup_direct_pay_payway)#"U"
				_payway=lccup_direct_pay_payway
			ELSE 
				_payway=getmessage("_cash")
			ENDIF 
		ENDIF 

		ssql="insert into payway_print_detail(pid,payway,cardno,payamt,tips,changes,dispord,pay_other,changes_mark,card_name,pay_id) values (?_pid,?_payway,'',?cr_inv_split_tmp.cust_amt,0,0,1,0,?__local_currency,'' , ?_payID)"		&& ¥I´Ú²Ó¸`(¥´¦L¥Î) &&Lihong 2022.08.19 ¤À±b _payamt ->?cr_inv_split_tmp.cust_amt



		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1



		Endif

	ENDIF
	IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1 OR VARTYPE(_cash_and_deposit_amt)#"U"
		SELECT * FROM cun_tmp2 INTO CURSOR cun_tmp READWRITE 
	ENDIF 
ENDSCAN 
USE IN SELECT("cun_tmp2")
Endif
&&Lihong 2021.10.08


SELECT cr_inv_split_tmp
SCAN FOR NVL(is_paid,.F.)=.F. &&Lihong 2022.08.19 ¤À±b _payamt -> 
	_lnibase = _lnibase + 1 &&dispord=1 -> ?_lnibase
	_aa_sub_id = ""
	IF llinv_splited
	_aa_sub_id = ALLTRIM(sub_id)
	ENDIF 
	
	&&Lihong 2022.08.19 ¤À±b 
	_aa_ins_field = ""
	_aa_ins_values = ""
	IF !EMPTY(_aa_sub_id)
		_aa_ins_field = ", aa_sub_id, aa_sub_add_fee_uid, aa_sub_paidtime, aa_sub_adduser, aa_sub_station_id, aa_sub_octopus, aa_sub_oct_invID,aa_sub_pay_station_id, aa_sub_pay_login_user_id, aa_sub_pay_cashier_user_id"
		_aa_ins_values = ", ?_aa_sub_id, ?_aa_sub_add_fee_uid, ?_paidtime, ?_login_user_name, ?_station_id, 0, 0, ?_pay_station_id, ?_pay_login_user_id, ?_pay_cashier_user_id"
		_aa_sub_id_paidtime = _paidtime
	ENDIF 

	IF VARTYPE(_cash_and_deposit_amt)#"U"
		_payway = TRIM(cr_inv_split_tmp.payway)
		_payID = cr_inv_split_tmp.pay_id
	ELSE 
		IF VARTYPE(lccup_direct_pay_payway)#"U"
			_payway=lccup_direct_pay_payway
		ELSE 
			_payway=getmessage("_cash")
		ENDIF 
	ENDIF 
	
	&&Lihong 2023.04.11 
	&&Lihong 2023.08.04 LOCAL lc_Ecr_cardno, _oct_invid
	lc_Ecr_cardno = ""
	_oct_invid = 0
	IF VARTYPE(_cup_direct_pay_cash_payway_cardno)#"U" &&VARTYPE(oEcr) # "U" and oEcr.type = "deduct"     
		lc_Ecr_cardno = _cup_direct_pay_cash_payway_cardno &&oEcr.cardno
	ENDIF 
	IF VARTYPE(_cup_direct_pay_cash_oct_invid)#"U"
		_oct_invid = _cup_direct_pay_cash_oct_invid
	ENDIF 
	
	&&Lihong 2023.08.04 LOCAL _oct_did, _oct_cid, _oct_remain, _oct_extra_info, _oct_card_avd
	
	_oct_did = Iif(Vartype(_octopus_device_ID) = "U", "", _octopus_device_ID)
	_oct_cid = Iif(Vartype(_octopus_card_ID) = "U", "", _octopus_card_ID)
	_oct_remain = Iif(Vartype(_octopus_remain_value) = "U", 0, _octopus_remain_value)
	_oct_extra_info = Iif(Vartype(_octopus_extra_info) = "U", "", _octopus_extra_info)
	_oct_card_avd = Iif(Vartype(_octopus_card_avd) = "U", "", _octopus_card_avd)

	_octopus = (_oct_invid>0 and !Empty(_oct_did) ) 
	 
	TEXT TO ssql NOSHOW TEXTMERGE
	insert into pay_detail (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others, oct_device_id,oct_card_id,oct_remain, oct_extra_info, oct_card_avd 
	<<_aa_ins_field>> ) 
		values (?_id,?_payID,?_payway,1,?cr_inv_split_tmp.cust_amt,?lc_Ecr_cardno,?cr_inv_split_tmp.cust_amt,0,0,?_lnibase,1,?_payID,0, ?_oct_did,?_oct_cid,?_oct_remain, ?_oct_extra_info, ?_oct_card_avd 
		<<_aa_ins_values>> )
	ENDTEXT 
	
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	ENDIF
	
	&&Lihong 2023.08.04 Release _octopus_device_ID,_octopus_card_ID,_octopus_remain_value,_octopus_invID, _octopus_extra_info, _octopus_card_avd
ENDSCAN 
Release _octopus_device_ID,_octopus_card_ID,_octopus_remain_value,_octopus_invID, _octopus_extra_info, _octopus_card_avd

&&Lihong 2022.08.19 ¤À±b
If SQLExec(nhand,"DELETE inv_split WHERE inv_id = ?_inv_id")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1


Endif


&&Lihong 2022.04.14 cup qty as ppl
lccup_qty_as_ppl = ""
IF _barcode_mode=.F. AND VARTYPE(__cup_count_as_tn_ppls)#"U" AND __cup_count_as_tn_ppls
	If SQLExec(nhand, "select a.tableno, a.askno, b.item_id_cup_list from inv a with (nolock) left join outlet b with (nolock) on a.outlet_id=b.id where a.id=?_inv_id ", "cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		RETURN -1
	Endif
	IF !EMPTY(cun_tmp.tableno) AND !EMPTY(NVL(cun_tmp.item_id_cup_list, ""))
		If SQLExec(nhand,"select sum(qty) as qty from inv_detail with (nolock) where id=?_inv_id and item_id>0 and item_id in ("+TRIM(TRIM(cun_tmp.item_id_cup_list),",")+")", "cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			RETURN -1
		Endif
		IF NVL(cun_tmp.qty, 0) > 0
			lccup_qty_as_ppl = "pplcnt="+TRANSFORM(cun_tmp.qty)+", "
		ENDIF  
	ENDIF 
ENDIF 

IF VARTYPE(__cashier_user_id)="U"
	lcpay_cashier_user = ""
	_pay_station_id = .null.
	_pay_login_user_id = .null.
	_pay_cashier_user_id = .null.
ELSE
	lcpay_cashier_user = "pay_station_id=?_pay_station_id,pay_login_user_id=?_pay_login_user_id,pay_cashier_user_id=?_pay_cashier_user_id,"
	_pay_station_id = __station_id
	_pay_login_user_id = __login_user_id
	_pay_cashier_user_id = __cashier_user_id
ENDIF 

_llhave_octopus = (_llhave_octopus or _octopus) 
&&Lihong 2022.08.19 ¤À±b cashed=1 -> cashed=?_llcashed ¼W¥[octopus=?_llhave_octopus
ssql="update inv set  "+lccup_qty_as_ppl+"paidamt=invamt,cashed=?_llcashed,paidtime=?_paidtime,"+lcpay_cashier_user+;
"belongdate=?_date,adduser=?_login_user_name,station_id=?_station_id, octopus=?_llhave_octopus, updateno=?_updateno, oct_invid=?_oct_invid where id=?_inv_id"			&&¥H²{ª÷µ²±b .
*ssql="update inv set  paidamt=invamt,cashed=1,paidtime=?DATETIME(),belongdate=?_date,station_id=?_station_id,updateno=?_updateno where id=?_inv_id"			&&¥H²{ª÷µ²±b .


If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1


Endif

&&Lihong 2022.10.10 Àq»{¤À±b
*If _inv_is_last_pay = .T. 
	*_default_itemdept_id=-888
*!*		If SQLExec(nhand,"select * from department where id=-888", "cun_tmp")<0
*!*			Aerror(err)
*!*			frm_wait.Hide
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			RETURN -1
*!*		ENDIF
	IF VARTYPE(__unsplit_amt_to_defaut_dept)#"U" AND __unsplit_amt_to_defaut_dept &&RECCOUNT("cun_tmp")>0
		_default_itemdept_id = -888 &&cun_tmp.id
		TEXT TO ssql TEXTMERGE NOSHOW 
			select a.id,a.uid,a.item_id,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.tax_amount,a.xdisc from inv_detail a with (nolock) 
			left join item with (nolock) on a.item_id=item.id 
			where a.id=?_inv_id and a.sitem_sub=0 and (a.askdept=1 or item.modi_dept_after_inv=1) and not exists (select id from inv_itemdept where id=?_inv_id and Parent_id=a.uid ) --and dept_id<>?_default_itemdept_id
		ENDTEXT 
		If SQLExec(nhand,ssql, "cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			RETURN -1
		Endif
		
		SELECT cun_tmp
		SCAN 
			TEXT TO ssql TEXTMERGE NOSHOW 
				INSERT INTO inv_itemdept (id,parent_id,item_id,dept_id,amount,srvamt) VALUES (?_inv_id,?cun_tmp.uid,?cun_tmp.item_id,?_default_itemdept_id,?cun_tmp.real_amount-?cun_tmp.srv_amount,?cun_tmp.srv_amount)
			ENDTEXT 
			IF RECNO("cun_tmp")=1
				*ssql = "delete from inv_itemdept where id=?_inv_id" + CHR(13) + ssql 
			ENDIF 
			If SQLExec(nhand,ssql)<0
				Aerror(err)
				frm_wait.Hide
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				RETURN -1
			Endif
		ENDSCAN 
	ENDIF 
*ENDIF &&Àq»{¤À±b

&&Lihong 2023.08.02 «D°Ý³¡ªù¤À±b
IF add_non_ask_itemdept(_inv_id)<0
	RETURN -1
ENDIF 

If _memberID>0
&&¦pªG¦³·|­û ,«h°O¿ý·|­û®ø¶Oª÷ÃB¤Î¦¸¼Æ



	If _points >0 And  Vartype(__shop_id)#"U" And __shop_id>0		&& 2011.07.14


		If SQLExec(nhand,"select MAX(updateno) as updateno from member_log","cun_tmp")<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

		_updateno=Nvl(cun_tmp.updateno,0)+1

		_uid=Val(Padl(__shop_id,3,"100")+Padl(_updateno,10,"0"))

		If SQLExec(nhand,"insert into member_log (id,inv_id,member_id,amount,times,point,updateno,datetime) values (?_uid,?_inv_id,?_memberID,?_payamt,1,?_points ,?_updateno,getdate())")<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif


		
			ssql="update member set amount=ISNULL(amount,0)+?_payamt,times=ISNULL(times,0) +1,points=ISNULL(points,0)+?_points where id=?_memberID"
		
		

	Else


		If SQLExec(nhand,"select MAX(updateno) as updateno from member","cun_tmp")<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

		_updateno=Nvl(cun_tmp.updateno,0)+1

		&&Lihong 2020.01.17 
		ssql="update member set amount=ISNULL(amount,0)+?_payamt,times=ISNULL(times,0) +1,points=ISNULL(points,0)+?_points,updateno=?_updateno where id=?_memberID"


	ENDIF
	
	&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h ±Æ°£storellet³æ
	*IF VARTYPE(__storellet)#"U" AND __storellet
	IF _cloud_plat=="storellet"
	ELSE 
		&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î 
		IF  VARTYPE(__cloud_member_type)#"U" AND !__cloud_member_type=='proan'  &&§Y®É¤è¦¡
			If _points<>0 &&OR _points_used<>0 ¥u»Ý¶Ç¿nªº¤À : _points_used§ï¬°0
				IF VARTYPE(__cloud_member)#"U" AND __cloud_member And  Vartype(__member_point_enabled)#"U" And __member_point_enabled &&AND _memberID>0 
					IF upload_points("Add_cust_points_20210604", _inv_id, _points, 0, _date, _memberID, _payamt)=.F. &&, lcaction, lninvid, lnpoints, lnpoints_used, _belongdate,_memberno, _invamt
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions",1)
						frm_wait.Hide
						RETURN 
					ENDIF 
				ENDIF 
			ENDIF 
		ELSE &&¦Ñ¤è¦¡
			&&Lihong 2020.01.17
			If _points<>0 OR _points_used<>0 
				IF VARTYPE(__cloud_member)#"U" AND __cloud_member And  Vartype(__member_point_enabled)#"U" And __member_point_enabled &&AND _memberID>0 
					IF upload_points("add_cust_points", _inv_id, _points, _points_used, _date, _memberID, _payamt)=.F. &&, lcaction, lninvid, lnpoints, lnpoints_used, _belongdate,_memberno, _invamt
						Sqlrollback(nhand)
						SQLSetprop(nhand,"Transactions",1)
						frm_wait.Hide
						RETURN 
					ENDIF 
				ENDIF 
			ENDIF
		ENDIF
	ENDIF 
	
	IF !EMPTY(ssql)

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1

		Endif
	ENDIF
	

ENDIF

&&&&Lihong 2022.04.19 ¤W¶Çinv¨ìstorellet 
IF VARTYPE(__storellet)#"U" AND __storellet 
	IF upload_storellet("Add_inv_storellet", _inv_id )=.F. 
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		frm_wait.Hide
		RETURN -1
	ENDIF
ENDIF  

IF VARTYPE(__storellet)#"U" AND __storellet  &&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h¤]¤£¥Î§ï
ELSE 
	&&Lihong 2020.12.11 coupon AND (Thisform.run_mode="fastfood" OR out_let=0) 
	IF VARTYPE(__cloud_member_coupon)#"U" AND __cloud_member_coupon 
	*AND thisform.change_payway=.F. AND VARTYPE(_inv_change_mode)="U"
	*LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lccloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
	IF upload_coupon("sell_coupon", 0, null, 0, _inv_id)=.F. 
		*Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		frm_wait.Hide
		*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		fmessagebox("_set_coupon_sold_fail") &&Â§¨é ³]¬°¤w¾P°â¥¢±Ñ¡A½Ðµy«á¦A¸Õ!
		RETURN -1
	ENDIF
	ENDIF  
ENDIF 

&&Lihong 2020.12.11 µùÄÀ±¼¡]¹êª«¨éorder¨½§Y®É³]¬°¤w§I´«¡^
*!*		&&Lihong 2020.12.11 coupon AND (Thisform.run_mode="fastfood" OR out_let=0) 
*!*		IF VARTYPE(__cloud_member_coupon)#"U" AND __cloud_member_coupon 
*!*		*LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lccloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
*!*		IF upload_coupon("redeem_coupon", 2, null, 0, _inv_id)=.F. &&1:²{ª÷¨é 2:§I´«¨é
*!*			*Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			frm_wait.Hide
*!*			*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			fmessagebox("¹êª«Â§¨é ³]¬°¤w§I´«¥¢±Ñ¡A½Ðµy«á¦A¸Õ!")
*!*			RETURN -1
*!*		ENDIF
*!*		ENDIF  


			
*** -------------- 2020.03.29   sauna   by david

IF __special_customer = "sauna"		&&¦L³æ®É¡A§Þ®v­«·s¶i¤J±Æ¶¤

			TEXT TO ssql noshow
				
				UPDATE  sauna_index set is_active=1,createtime=getdate(),is_working=0 where is_active=0 and  user_id in (select id from sys_user WHERE name in (select item_code from inv_detail WHERE id=?_inv_id))
			
			ENDTEXT
			
			IF SQLEXEC(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				frm_wait.Hide

				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return			
			
			ENDIF
			


*!*		IF SQLEXEC(nhand,"select  item_code from  inv_detail where id = ?_inv_id","cun_tmp")<0
*!*		
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				frm_wait.Hide

*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1	
*!*		
*!*		
*!*		ENDIF
*!*		

*!*		SELECT cun_tmp
*!*		SCAN
*!*			IF SQLEXEC(nhand,"update sauna_index set is_active=1,createtime=getdate(),is_working=0 where  is_active=0 and user_id in (select  id from sys_user where name=?cun_tmp.item_code)")<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions" ,1)
*!*				frm_wait.Hide
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*				RETURN 
*!*			
*!*			ENDIF
*!*			
*!*		
*!*		ENDSCAN


ENDIF


&&Lihong 2023-06-02 ¼pÅã
*ssql="-- delete from order_kit_print where ISNULL(type,0)=0 AND kit_disp_uid in (select kit_disp_uid from order_detail with(nolock) where id=?_curorder and kit_disp_uid is not null)"
*-- and kit_disp_uid not in (select kit_disp_uid from order_detail with(nolock) where kit_disp_uid is not null)
ssql="delete from order_kit_print where ISNULL(type,0)=0 AND tableno=?lcTableno " 
ssql=ssql+Chr(13)+"delete from order_kit_print where ISNULL(type,0)<>0 AND (datediff(hh, complete_time, getdate())>24 OR datediff(hh, void_time, getdate())>24 OR datediff(hh, add_time, getdate())>24 )" 

ssql=ssql+Chr(13)+"delete from order_main where id=?_curorder"		&&§R°£ order ¼Æ¾Ú
ssql=ssql+Chr(13)+"delete from order_detail where id=?_curorder"
ssql=ssql+Chr(13)+"delete from order_modi where id=?_curorder"
ssql=ssql+Chr(13)+"delete from order_disc where id=?_curorder"
ssql=ssql+Chr(13)+"delete from order_itemdisc where id=?_curorder"
ssql=ssql+Chr(13)+"delete from order_itemdept where order_id=?_curorder" &&Lihong 2022.11.04 ¼W¥[order_itemdept


If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1


Endif



If SQLExec(nhand,"update tables set inv_id=0 where order_id=0")<0		&&²M²z©U§£

	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1


Endif


&&-->>µ²±b
&&Âà¬°"²M²z¤¤..."
If _barcode_mode=.F.

*!*		If _cleannotice 

*!*			ssql = "update  tables set status='C',begindate=getdate(),order_id=0,ppl=0,nshare_order=1,inv_id=0,have_unfinish=0,link_table='',split=0,item_warning=0,updateno=ISNULL(updateno,0)+1,ready_pay=0,crm_member=0,check_valid=null where tableno=?lcTableno and nsubtable=0"

*!*		
*!*		ELSE
*!*		

	&&Lihong 2021.12.29 ¦PÂi &&Lihong 2023.07.19 void item show
	*-- delete from order_kit_print where ISNULL(type,0)=0 AND kit_disp_uid in (select kit_disp_uid from order_detail with(nolock) WHERE kit_disp_uid is not null 
	*-- and id in (select order_id from tables where tableno in (SELECT tableno FROM same_table_detail WITH (nolock) WHERE tableno<>?lcTableno and same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?lcTableno ) ) and nsubtable=0) )
	*-- AND kit_disp_uid not in (select kit_disp_uid from order_detail with(nolock) where kit_disp_uid is not null) 
	lcupdate_same_table = ""
	IF VARTYPE(__same_tables)#"U" and __same_tables
		TEXT TO lcupdate_same_table noshow
			delete from order_kit_print where ISNULL(type,0)=0 AND tableno in (SELECT tableno FROM same_table_detail WITH (nolock) WHERE tableno<>?lcTableno and same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?lcTableno) ) 

			update  tables set status='',begindate=getdate(),order_id=0,order_uid=null,ppl=0,nshare_order=1,inv_id=0,have_unfinish=0,link_table='',split=0,item_warning=0,updateno=ISNULL(updateno,0)+1,ready_pay=0,crm_member=0,check_valid=null,remark='',remark2='' 
			where tableno in (SELECT tableno FROM same_table_detail WITH (nolock) WHERE tableno<>?lcTableno and same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?lcTableno) ) and nsubtable=0 

			update a set a.ppl=(select SUM(ppl) from tables where parent_table=a.tableno) from tables a where page_no>0 and tableno in 
			(select parent_table from tables where parent_table<>'' and nsubtable=0 and tableno in 
				(SELECT tableno FROM same_table_detail WITH (nolock) WHERE tableno<>?lcTableno and same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?lcTableno ) ) 
			)
			--§ó·s¥DÂi¤H¼Æ
			
			DELETE same_table WHERE id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?lcTableno)
			DELETE same_table_detail WHERE same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno=?lcTableno)
			
		ENDTEXT 
	ENDIF 

	_still_sitting = (VARTYPE(__pay_finish_still_sitting)#"U" and __pay_finish_still_sitting)
	TEXT TO ssql TEXTMERGE NOSHOW 
		
		IF exists (select tableno from tables where nshare_order>1 AND tableno=?lcTableno and nsubtable=0)
			UPDATE tables SET nshare_order=nshare_order-1 WHERE tableno=?lcTableno and nsubtable=0
		ELSE
			update  tables set status='',still_sitting=?_still_sitting,begindate=getdate(),order_id=0,order_uid=null,ppl=0,nshare_order=1,inv_id=0,have_unfinish=0,link_table='',split=0,item_warning=0,updateno=ISNULL(updateno,0)+1,ready_pay=0,crm_member=0,check_valid=null,remark='',remark2='' where tableno=?lcTableno and nsubtable=0
			
			<<lcupdate_same_table>>
	ENDTEXT
	

*	ssql = "update  tables set status='',begindate=getdate(),order_id=0,ppl=0,nshare_order=1,inv_id=0,have_unfinish=0,link_table='',split=0,item_warning=0,updateno=ISNULL(updateno,0)+1,ready_pay=0,crm_member=0,check_valid=null where tableno=?lcTableno and nsubtable=0"
		

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1


	ENDIF
	
	IF 	_cleannotice 


		ssql = "update  tables set status='C'  where tableno=?lcTableno and nsubtable=0"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1
		ENDIF
		

	ENDIF
		

	IF LOWER(__special_customer)="club_busa"		&&¿é¤J©m¦W
	
		
		ssql="update tables set name='' where  tableno=?lcTableno and nsubtable=0"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1


		ENDIF
	
	ENDIF
	


ENDIF


If !Empty(_parent_table)


	ssql =" update tables set ppl =(select sum(ppl) as ppl from tables where  parent_table=?_parent_table ) where tableno=?_parent_table and nsubtable>0"


	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1


	Endif




Endif





If _barcode_mode=.F. And !Empty(_link_table)		&&ÃöÁpÀ\Âiª¬ºA

	Local ms,lk
	Dimension ms(1)
	getmstring(_link_table,@ms)
	For lk=1 To Alen(ms)
		_link_table=ms(lk)
		If __table_add_cleaning_status
			ssql="update  tables set status='C',begindate=getdate(),order_id=0,order_uid=null,ppl=0,nshare_order=1,inv_id=0,have_unfinish=0,link_table='',split=0,item_warning=0 where tableno=?_link_table and nsubtable=0"
		Else
			ssql="update  tables set status='',begindate=getdate(),order_id=0,order_uid=null,ppl=0,nshare_order=1,inv_id=0,have_unfinish=0,link_table='',split=0,item_warning=0 where tableno=?_link_table and nsubtable=0"
		Endif


		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1


		Endif

	Endfor


Endif




If Sqlcommit(nhand)<0

	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	frm_wait.Hide

	Return -1


Endif

SQLSetprop(nhand,"Transactions" ,1)



&&Lihong 2021.10.08 AND _outlet_paylist_print
If  __print_pay_slip And __pay_print_to_local  And _no_printPaylist=.F. AND _outlet_paylist_print

	write_log(184)

	Public  nPrint_time		&&®I¸}¯È¥´¦L¼Æ¶q

	nPrint_time=Iif(Vartype(__paylist_print_ntime)="N",__paylist_print_ntime,1)

	&&Lihong 2022.08.19 ¤À±b
	SELECT cr_inv_split_tmp
	SCAN FOR NVL(is_paid,.F.)=.F.
		IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1
			SELECT * FROM ("pay_print_main"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) INTO CURSOR pay_print_main READWRITE 
			SELECT * FROM ("pay_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) INTO CURSOR pay_print_detail READWRITE 
			SELECT * FROM ("payway_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) INTO CURSOR payway_print_detail READWRITE 
			SELECT * FROM ("pay_print_disc"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) INTO CURSOR pay_print_disc READWRITE 
			SELECT * FROM ("inv_print_tax"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) INTO CURSOR inv_print_tax READWRITE 
			*SELECT * FROM ("inv_print_tmp"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) INTO CURSOR inv_print_tmp READWRITE 
		ENDIF 

		paylist_local_print(_Pid,_printer)
	ENDSCAN 

	Release nPrint_time

	If Vartype(__paylist_print_coupon)#"U" And 	__paylist_print_coupon		&&2010.12.07

		print_coupon(_inv_id)

	Endif



Endif

&&Lihong 2022.08.19 ¤À±b
SELECT cr_inv_split_tmp
SCAN FOR NVL(is_paid,.F.)=.F.
	IF llinv_splited AND OCCURS(",",lcinv_sub_ids)>1
		USE IN SELECT("pay_print_main"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_"))
		USE IN SELECT("pay_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_"))
		USE IN SELECT("payway_print_detail"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_")) 
		USE IN SELECT("pay_print_disc"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_"))
		USE IN SELECT("inv_print_tax"+CHRTRAN(ALLTRIM(cr_inv_split_tmp.sub_id),"-","_"))
	ENDIF
ENDSCAN  
USE IN SELECT("cr_inv_split_tmp")

=CHECK_PAY_DETAIL(_inv_id)
IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active AND !EMPTY(crm_member_number)


	crm_inv_add_points( _inv_id , 0)	&& add crm member points

	crm_finish(_check_valid )	&& crm finish

ENDIF

*=fix_paydetail_error("pay_detail" )

&&Lihong 2021.10.18 ¹q¤l¼ÐÃ±
IF VARTYPE(__esl) # "U" AND __esl 
	=update_esl(lcTableno, .T., _barcode_mode) &&.T.¨ê·s®ÕÅç­È
ENDIF 

&&&&Lihong 2022.04.19 ¤W¶Çinv¨ìstorellet 
IF VARTYPE(__storellet)#"U" AND __storellet  &&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h¤]¤£¥Î§ï
	upload_storellet("up", _inv_id )
ELSE 
	&&Lihong 2020.12.11 coupon
	*!*	_cloud_coupon_id = 0
	*!*	_web_coupon_id = ""
	IF VARTYPE(__cloud_member_coupon)#"U" AND __cloud_member_coupon  
		upload_coupon("up") &&, member_id
		*Sqlrollback(nhand)
		*SQLSetprop(nhand,"Transactions",1)
		*RETURN 
	ENDIF 
ENDIF  
&&Lihong 2020.01.17 upload points to cloud  AND Thisform.member_id>0 *¦Ò¼{¦³¥¼¤W¶Çªº
IF VARTYPE(__cloud_member)#"U" AND __cloud_member And  Vartype(__member_point_enabled)#"U" And __member_point_enabled 
	upload_points("up", _inv_id) &&, member_id
	*Sqlrollback(nhand)
	*SQLSetprop(nhand,"Transactions",1)
	*RETURN 
ENDIF 

check_octopus_xfile()

frm_wait.Hide




Return 1

Endfunc


**************************
*µo²¼¶µ¥Ø¼Æ¾Ú¥Í¦¨
*
**************************
Function inv_detail_generate
Lparameters Cprint_type	,_Nid,_Pid,_langue,_reprint,_print_to_local,_Lreprint,_Nvoid_Id	&&cPrint_type ="INV"¬°µo²¼,	"PAY"¬°µ²±b ,_print_to_local ª½±µ¥»¦a¥´¦L¾÷

If Vartype(_Nvoid_Id)#"N"		&&¨ú®øµæ¦¡  void_id
	_Nvoid_Id=0

Endif
If Vartype(_langue)#"C"

	_langue=_system_langue
Endif


If !Used("work_order_tmp19")

	If create_order_database()=-1		&&¦pªGwork_order_tmp¤£¦s¦b¡A­«¸ü¼Æ¾ÚÀô¹Ò

		Return -1
	Endif

Endif

&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
Create Cursor inv_print_tmp (r_id Int,same_tableno C(8),Item c(120),qty c(10),amt N(12,2),Free L,item_unicode c(200),printtime c(20),adduser c(20),points N(12,2),price N(8,2),srv_per n(6,2),srv_amount n(12,2),item_id int)		&&µo²¼¶µ¥ØÁ{®Éªí

&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ ¨útableno
If _reprint

	If Vartype(_data_hIstory)#"U"

		&&Lihong 2023.05.05 alway_print_0_amt  ¥hand ( (isnull(b.invlst_zeronoprint,0)= 0 ) or (isnull(b.invlst_zeronoprint,0)= 1 and a.real_amount>0) )  ¥[alway_print_0_amt
		ssql="select a.*,b.invlst_noprint,b.custom,b.invlst_zeronoprint,b.alway_print_0_amt,c.tableno,c.outlet_id from "+view_inv_detail +" a left join item b on a.item_id=b.id left join "+view_inv+" c on a.id=c.id ";
		+" where a.id=?_Nid order by a.uid "				&&µo²¼ªº²Ó¸`   inv_item_tmp  (¶¡½u¤Î«H®§¤£¥´¦L)
		ssql=ssql+Chr(10)+"select * from "+view_inv_modi+"    where id=?_Nid order by dispord"
		ssql=ssql+Chr(10)+"select * from "+view_inv_itemdisc +"   where id=?_Nid order by dispord"
		&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
*!*			ssql=ssql+Chr(10)+"select inv_srv_type,inv_srv_perc from "+view_inv +" where id=?_Nid"

	Else

		&&Lihong 2023.05.05 alway_print_0_amt ¥hand ( (isnull(b.invlst_zeronoprint,0)= 0 ) or (isnull(b.invlst_zeronoprint,0)= 1 and a.real_amount>0) )  ¥[alway_print_0_amt
		ssql="select a.*,b.invlst_noprint,b.custom,b.invlst_zeronoprint,b.alway_print_0_amt,c.tableno,c.outlet_id from  inv_detail a with (nolock) left join item b with (nolock) on a.item_id=b.id left join inv c with (nolock) on a.id=c.id ";
		+" where a.id=?_Nid order by a.uid "				&&µo²¼ªº²Ó¸`   inv_item_tmp  (¶¡½u¤Î«H®§¤£¥´¦L)
		ssql=ssql+Chr(10)+"select * from inv_modi    where id=?_Nid order by dispord"
		ssql=ssql+Chr(10)+"select * from inv_itemdisc    where id=?_Nid order by dispord"
		&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
*!*			ssql=ssql+Chr(10)+"select inv_srv_type,inv_srv_perc from inv where id=?_Nid"

	Endif


Else


	
	&&Lihong 2020.04.20  or item_id= -199 111 110 or -104 and -101 2020.06.02 coupon or item_id= -51
	&&Lihong 2023.05.05 alway_print_0_amt ¥hand ( (isnull(b.invlst_zeronoprint,0)= 0 ) or (isnull(b.invlst_zeronoprint,0)= 1 and a.real_amount>0) )   ¥[alway_print_0_amt
	ssql="select a.*,b.invlst_noprint,a.disc_amount as discamt,b.custom,b.invlst_zeronoprint,b.alway_print_0_amt,c.tableno,c.outlet_id from  order_detail a with (nolock) left join item b with (nolock) on a.item_id=b.id"+;
	" left join order_main c with (nolock) on a.id=c.id"+;
		" where a.id=?_Nid and (a.item_id>0 or a.item_Id=-3 or a.item_id= -199 or a.item_id= -111 or a.item_id= -110 or a.item_id between -104 and -101 or item_id= -51 ) "+;
		" order by a.uid "				&&µo²¼ªº²Ó¸`   inv_item_tmp  (¶¡½u¤Î«H®§¤£¥´¦L)
	ssql=ssql+Chr(10)+"select * from  order_modi   where id=?_Nid order by dispord"
	ssql=ssql+Chr(10)+"select * from  order_itemdisc    where id=?_Nid order by dispord"
	&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
*!*		ssql=ssql+Chr(10)+"select inv_srv_type,inv_srv_perc from order_main where id=?_Nid"

Endif

If SQLExec(nhand,ssql,"inv_detail_tmp")<0
	Aerror(err)

	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif
SELECT * FROM inv_detail_tmp1 INTO CURSOR inv_detail_tmp1 READWRITE 

_outlet_id=inv_detail_tmp.outlet_id &&Lihong 2022.09.13 ¯ùªã±Æ«á

&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
REPLACE ALL same_tableno WITH tableno FOR EMPTY(NVL(same_tableno,"")) IN inv_detail_tmp 

*!*	&&Lihong 2022.04.27 ¨Ò®u ¥I´Ú­«¦LµLmodi
*!*	IF _reprint AND Cprint_type="PAY"
*!*		UPDATE inv_detail_tmp SET orgqty_case_mat=0
*!*	ENDIF 

&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
*!*	IF VARTYPE(lnorder_inv_srv_type)="N"
*!*		IF VARTYPE(_inv_srv_type)#"N"
*!*			_inv_srv_type = lnorder_inv_srv_type 
*!*			_inv_srv_perc = lnorder_inv_srv_perc 
*!*		ENDIF 
*!*	ELSE
*!*		_inv_srv_type = NVL(inv_detail_tmp3.inv_srv_type, 0)
*!*		_inv_srv_perc = NVL(inv_detail_tmp3.inv_srv_perc, 0.00) 
*!*	ENDIF 


If _reprint

	ssql="select a.*,b.desccn,b.descen  from inv_tax a left join tax b  on a.tax_id=b.id  where a.id=?_Nid"

Else
	ssql="select a.*,b.desccn,b.descen  from order_tax a left join tax b  on a.tax_id=b.id  where a.id=?_Nid"


Endif


If SQLExec(nhand,ssql,"inv_tax_tmp")<0		&&2010.04.26  ¦hµ|¶µ

	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

&&Lihong 2022.08.19 ¤À±b
USE IN SELECT("inv_split_tmp")
USE IN SELECT("inv_split_tmp1")
IF VARTYPE(_inv_print_attach_split)#"U" AND _inv_print_attach_split
	ssql="select sub_id,cust_amt,paid_amt,is_paid from INV_SPLIT where inv_id=?_Nid order by sub_id"
	IF VARTYPE(_data_history)#"U"
		ssql=ssql + CHR(13) + "select aa_sub_id as sub_id,SUM(netamt) as cust_amt,SUM(payamt) as paid_amt, CAST(1 as bit) as is_paid from "+view_inv_pay+" where id=?_Nid group by aa_sub_id order by aa_sub_id"
	ELSE
		ssql=ssql + CHR(13) + "select aa_sub_id as sub_id,SUM(netamt) as cust_amt,SUM(payamt) as paid_amt, CAST(1 as bit) as is_paid from pay_detail where id=?_Nid group by aa_sub_id order by aa_sub_id"
	ENDIF
	If SQLExec(nhand,ssql,"inv_split_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	ENDIF
	
	*¼g¦º _inv_split_msg = getmessage("_split_amt")
	_inv_split_msg = Iif(_langue="CN","«È¤H", "Guest")	
	IF RECCOUNT("inv_split_tmp")>0
		SELECT CAST(5 as int) as r_id, *, CAST(_inv_split_msg + " " + TRIM(SUBSTR(sub_id, AT("-",sub_id)+1)) as C(20)) as split_desc FROM inv_split_tmp INTO CURSOR inv_split_tmp READWRITE 
	ELSE 
		SELECT CAST(5 as int) as r_id, *, CAST(_inv_split_msg + " " + TRIM(SUBSTR(sub_id, AT("-",sub_id)+1)) as C(20)) as split_desc FROM inv_split_tmp1 INTO CURSOR inv_split_tmp READWRITE 
	ENDIF 
	*Index On r_id Tag split
	
*ELSE
	*CREATE CURSOR inv_split_tmp (r_id I, split_desc C(1), cust_amt N(10,2) )
	*Index On r_id Tag split
ENDIF 

USE IN SELECT("inv_item_tmp_deposit")
If  Upper(__inv_print_order)="INPUT" 	&&OR Cprint_type="PAY"		&&«ö¿é¤J¦¸§Ç
	
	IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
		Select * From inv_detail_tmp Into Cursor inv_item_tmp Order By same_tableno, uid	Readwrite
	ELSE 
		Select * From inv_detail_tmp Into Cursor inv_item_tmp Order By uid	Readwrite
	ENDIF 

Else

	Select *,.F. As nogroup From inv_detail_tmp Into Cursor inv_detail_tmp0 Readwrite 			&&¦pªG¦³¯S§O³B²z¤Î§é¦©,¤£°Ñ»P¥[Á`fff

	Update inv_detail_tmp0 Set nogroup=.T. Where sitem Or sitem_sub OR item_id=-7
	Select inv_detail_tmp0
	Scan For sitem_sub=.F.	 And sitem=.F. 																											&& ®MÀ\¤£°Ñ»P¥[Á`
		_uid=uid

		&&Lihong 2021.05.07 BarCode
		IF NVL(print_single,.F.) = .T.
			Replace nogroup With .T.
		ENDIF 

		&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö µùÄÀ±¼«h¦³¨Ò®u¤]¥i¦X¨Ö ª`·N«á­±²M±¼¤Forgqty_case_mat qty_entity
*!*			&&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö
*!*			IF orgqty_case_mat > 0 
*!*				Replace nogroup With .T.
*!*			ENDIF 
*!*			IF qty_entity > 0 
*!*				Replace nogroup With .T.
*!*			ENDIF 

		If Vartype(__level_disc_item_in_groups)#"U" And __level_disc_item_in_groups=.F. And inv_detail_tmp0.level_disc		&&¯Å§OÀu´f¬O§_°Ñ»P¥[Á`¸òsetting  2009.07.28
			Select inv_detail_tmp0
			Replace nogroup With .T.
			Loop

		Endif

		If inv_detail_tmp0.handwriting Or Nvl(inv_detail_tmp0.Custom,.F.)
			Select inv_detail_tmp0
			Replace nogroup With .T.
			Loop
		Endif

		&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö µùÄÀ±¼«h¦³¨Ò®u¤]¥i¦X¨Ö ¦ý«á­±²M±¼¤Forgqty_case_mat qty_entity
*!*			&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö ¥h±¼¡G__INV_PRINT_NOFREE_MODIFIER OR 
*!*			Select item_id From inv_detail_tmp1 Where item_id=_uid And  modi_amount>0 Into Array tmp_s				&&¦pªG¦³¯S§O³B²z,ª÷ÃB¤j©ó¹s,¦pªG³]©w¦C¦L,¤£°Ñ»P¥[Á`
*!*			If _Tally>0 And (inv_detail_tmp0.orgqty_case_mat>0 OR inv_detail_tmp0.qty_entity>0) &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö  
*!*				Select inv_detail_tmp0
*!*				Replace nogroup With .T.
*!*				Loop
*!*			Endif
*!*			&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö ¥h±¼¡G__inv_print_free_modifier OR 
*!*			Select item_id From inv_detail_tmp1 Where item_id=_uid And modi_amount=0 Into Array tmp_s				&&¦pªG¦³¯S§O³B²z,ª÷ÃBµ¥©ó¹s,¦pªG³]©w¦C¦L,¤£°Ñ»P¥[Á`
*!*			If _Tally>0 And (inv_detail_tmp0.orgqty_case_mat>0 OR inv_detail_tmp0.qty_entity>0) &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö
*!*				Select inv_detail_tmp0
*!*				Replace nogroup With .T.
*!*				Loop
*!*			Endif



		Select item_id From inv_detail_tmp2 Where item_id=_uid Into Array tmp_s
		If _Tally>0
			Select inv_detail_tmp0
			Replace nogroup With .T.
		Endif
		
	Endscan

	Select *, CAST("" as C(254)) as modi_same From inv_detail_tmp0 Where nogroup  Into Cursor nogroup_tmp				&&¥ý´_¨î¤£°Ñ»P¥[Á`ªºitem


	Select inv_detail_tmp0
	Delete For nogroup=.T.			&&§R°£¤£°Ñ»P¥[Á`ªºitem

	&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
	Select *, CAST("" as C(254)) as modi_same FROM inv_detail_tmp0 INTO CURSOR inv_detail_tmp0 READWRITE 
	Scan
		Select modi_id, open_modi, descdisp, dispord, modi_amount From inv_detail_tmp1 Where  Id=inv_detail_tmp0.Id And item_id=inv_detail_tmp0.uid ORDER BY dispord Into Cursor cun_tmp
		_modi_same =""
		SCAN 
			_modi_amount = IIF(inv_detail_tmp0.qty=0, cun_tmp.modi_amount, ROUND(cun_tmp.modi_amount / inv_detail_tmp0.qty,4) )
			_modi_same = _modi_same + IIF(EMPTY(_modi_same), "", CHR(13)) + TRANSFORM(cun_tmp.modi_id)+CHR(9)+IIF(cun_tmp.open_modi, SYS(2007, TRIM(cun_tmp.descdisp), -1, 0),"")+CHR(9)+TRANSFORM(dispord)+CHR(9)+TRANSFORM(_modi_amount)
		ENDSCAN 
		Select inv_detail_tmp0
		Replace modi_same With _modi_same 
	Endscan

	Select inv_detail_tmp0
	Go Top
	Do Whil !Eof()
		Select inv_detail_tmp0
		If sitem_sub=.F. And sitem=.F.
			IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
				_recn=Recno()
				_item_code=item_code
				_same_tableno = same_tableno
				_modi_same = modi_same &&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
				&&Lihong 2022.03.17 ¨Ò®u ¼W¥[orgqty_case_mat  
				&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
				SELECT uid FROM inv_detail_tmp0 WHERE Recno()<>_recn AND same_tableno=_same_tableno AND item_code=_item_code  And sitem_sub=.F. and modi_same=_modi_same INTO CURSOR cun_tmp
				Select inv_detail_tmp0
				Sum qty,orgqty_case_mat,qty_entity,amount,real_amount,round_amount,modi_amount,srv_amount To _qty,_orgqty_case_mat,_qty_entity,_amt,_realAmt,_rndamt,_modiamt,_srvamt For same_tableno=_same_tableno AND item_code=_item_code  And sitem_sub=.F. and modi_same=_modi_same 
				Delete For Recno()<>_recn And same_tableno=_same_tableno AND item_code=_item_code and modi_same=_modi_same 
				Go _recn
				Replace qty With _qty,orgqty_case_mat WITH _orgqty_case_mat,qty_entity WITH _qty_entity,amount With _amt,real_amount With _realAmt,round_amount With _rndamt,modi_amount With _modiamt,srv_amount With _srvamt
			ELSE 
				_recn=Recno()
				_item_code=item_code
				_modi_same = modi_same &&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
				&&Lihong 2022.03.17 ¨Ò®u ¼W¥[orgqty_case_mat
				&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
				SELECT uid FROM inv_detail_tmp0 WHERE Recno()<>_recn AND item_code=_item_code  And sitem_sub=.F. and modi_same=_modi_same INTO CURSOR cun_tmp
				Select inv_detail_tmp0
				Sum qty,orgqty_case_mat,qty_entity,amount,real_amount,round_amount,modi_amount,srv_amount To _qty,_orgqty_case_mat,_qty_entity,_amt,_realAmt,_rndamt,_modiamt,_srvamt For item_code=_item_code  And sitem_sub=.F. and modi_same=_modi_same 
				Delete For Recno()<>_recn And item_code=_item_code and modi_same=_modi_same 
				Go _recn
				Replace qty With _qty,orgqty_case_mat WITH _orgqty_case_mat,qty_entity WITH _qty_entity,amount With _amt,real_amount With _realAmt,round_amount With _rndamt,modi_amount With _modiamt,srv_amount With _srvamt
			ENDIF
		ENDIF 
		&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
		Select id, modi_id, dispord,SUM(modi_amount) as modi_amount From inv_detail_tmp1 Where  Id=inv_detail_tmp0.Id And item_id in (SELECT uid FROM cun_tmp) GROUP BY id, modi_id, dispord INTO CURSOR cun_tmp1
		&&Select SUM(modi_amount) From cun_tmp1 INTO ARRAY ary_modi_amt
		DELETE from inv_detail_tmp1 Where  Id=inv_detail_tmp0.Id And item_id in (SELECT uid FROM cun_tmp) 
		UPDATE a SET a.modi_amount =a.modi_amount + NVL(b.modi_amount, 0) from inv_detail_tmp1 a left join cun_tmp1 b on a.id=b.id AND a.modi_id=b.modi_id AND a.dispord=b.dispord WHERE a.Id=inv_detail_tmp0.Id AND a.item_id=inv_detail_tmp0.uid &&AND a.item_id=inv_detail_tmp0.uid 
		Select inv_detail_tmp0
		&&REPLACE modi_amount WITH modi_amount + NVL(ary_modi_amt, 0) 
		
		Skip

	ENDDO
	
	&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ ¼W¥[sitem_first
	&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö µùÄÀ±¼«h¦³¨Ò®u¤]¥i¦X¨Ö «h³o¸Ì¤£²M°£ UPDATE inv_detail_tmp0 SET orgqty_case_mat=0, qty_entity=0
	Select  0 as sitem_first, * From inv_detail_tmp0 Where 2=1  Into Cursor inv_item_tmp Readwrite
	
	Insert Into inv_item_tmp Select 1, * From nogroup_tmp Where 		sitem  Or  sitem_sub		&& ¥ý¥[¤J®MÀ\
	Select * From nogroup_tmp WHERE item_id=-7 INTO CURSOR inv_item_tmp_deposit
	Insert Into inv_detail_tmp0 Select * From nogroup_tmp Where  sitem=.F. And sitem_sub=.F.	AND item_id<>-7	&& ¦A¥[¤J¤£°Ñ»P¥[Á`ªº¶µ¥Ø
	

	Do Case

		Case Upper(__inv_print_order)="AMT"			&&½s¸¹¥[Á`¦A«öª÷ÃB±Æ§Ç(¥Ñ¤j¨ì¤p)
			IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
				Select * From inv_detail_tmp0 Order By same_tableno, amount Desc  Into Cursor cun_tmp000
			ELSE 
				Select * From inv_detail_tmp0 Order By amount Desc  Into Cursor cun_tmp000
			ENDIF 

		Case Upper(__inv_print_order)="QTY"			&&½s¸¹¥[Á`¦A«ö¼Æ¶q±Æ§Ç(¥Ñ¤j¨ì¤p)
			IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
				Select * From inv_detail_tmp0 Order By same_tableno, qty Desc Into  Cursor cun_tmp000
			ELSE 
				Select * From inv_detail_tmp0 Order By qty Desc Into  Cursor cun_tmp000
			ENDIF 

		Otherwise									&&½s¸¹¥[Á`¦A«ö½s¸¹±Æ§Ç(¥Ñ¤j¨ì¤p)
			IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
				Select * From inv_detail_tmp0 Order By same_tableno, item_code Desc Into Cursor cun_tmp000
			ELSE 
				Select * From inv_detail_tmp0 Order By item_code Desc Into Cursor cun_tmp000
			ENDIF 

	Endcase

	If _Tally>0

		Insert Into inv_item_tmp Select 2, * From cun_tmp000

	Endif

	&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ 
	IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" 
		SELECT * FROM inv_item_tmp Order By same_tableno, sitem_first INTO CURSOR inv_item_tmp READWRITE 
	ENDIF 
	
*!*		IF USED("inv_item_tmp_deposit") AND RECCOUNT("inv_item_tmp_deposit")>0
*!*			Insert Into inv_item_tmp Select 2, *,.F. As has_itemdisc From inv_item_tmp_deposit
*!*		ENDIF 
*!*		USE IN SELECT("inv_item_tmp_deposit")
	 
	Use In cun_tmp000

	Use In  inv_detail_tmp0

ENDIF

Select *,.F. As has_itemdisc From inv_item_tmp Into Cursor inv_item_tmp Readwrite

&&Lihong 2021.04.01 ­tª÷ÃB·í¹w¥Iª÷ &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ ¥¼³B²z
IF Vartype(__neg_amt_as_deposit)#"U" And __neg_amt_as_deposit AND Cprint_type="INV"
	SELECT item_id, real_amount, SUM(qty) as qty FROM inv_item_tmp WHERE item_id>0 AND sitem=.F. AND real_amount< 0 GROUP BY item_id, real_amount INTO CURSOR cun_tmp 
	SELECT a.item_id, a.real_amount, MAX(a.qty) as qty, SUM(NVL(b.qty, "")) as b_qty  FROM cun_tmp a LEFT JOIN inv_item_tmp b ON a.item_id = b.item_id AND a.real_amount = -b.real_amount ;
	WHERE b.sitem=.F. GROUP BY a.item_id, a.real_amount INTO CURSOR cun_tmp 
	
	SELECT SUM(-a.real_amount) as amt from inv_item_tmp a left join cun_tmp b on a.item_id = b.item_id AND a.real_amount = -b.real_amount where a.sitem=.F. AND NOT ISNULL(b.item_id) AND b.qty = b.b_qty INTO CURSOR cun_tmp1 
	IF cun_tmp1. amt <> 0
		*À³¼g¤Jinv_print_main : _totalAmt_depoist = cun_tmp. amt 
		DELETE a from inv_item_tmp a left join cun_tmp b on a.item_id = b.item_id AND a.real_amount = -b.real_amount where a.sitem=.F. AND NOT ISNULL(b.item_id) AND b.qty = b.b_qty 
	ENDIF 
	USE IN SELECT("cun_tmp1")
ENDIF 


Select inv_item_tmp		&&ÀË´ú¬O§_¦³¶µ¥Ø§é¦©
Scan

	Select Id From inv_detail_tmp2 Where  Id=inv_item_tmp.Id And item_id=inv_item_tmp.uid Into Cursor cun_tmp
	If _Tally>0

		Select inv_item_tmp
		Replace has_itemdisc With .T.

	Endif

Endscan

&&Lihong 2022.09.13 ¯ùªã±Æ«á
IF VARTYPE(__cup)#"U" AND __cup AND VARTYPE(_vs_all_style_save_order)="U"
	lccup_item_ids = ""
	*!*	_outlet_id=cun_tmp.outlet_id
	*!*	IF Used("work_order_tmp9")=.F. Or Get_table_updateno("outlet")<0
	*!*		ssql="select * from outlet with (nolock)"
	*!*		If SQLExec(nhand,ssql,"work_order_tmp9")<0
	*!*			Aerror(err)
	*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	*!*			Return .F.
	*!*		Endif
	*!*		SELECT * FROM work_order_tmp9 INTO CURSOR work_order_tmp9 READWRITE 
	*!*		UPDATE work_order_tmp9 SET item_id_cup_list="" WHERE ISNULL(item_id_cup_list)
	*!*	Endif
	SELECT work_order_tmp9 &&Àç·~°Ï°ì
	LOCATE FOR id = _outlet_id
	IF FOUND() AND !EMPTY(NVL(item_id_cup_list,"")) 
		lccup_item_ids = "," + ALLTRIM(work_order_tmp9.item_id_cup_list)
	ENDIF 
	SELECT uid, item_id FROM inv_item_tmp WHERE "," + TRANSFORM(item_id) + "," $ lccup_item_ids AND sitem_sub =.f. INTO CURSOR inv_detail_tmp0 READWRITE  
	SELECT uid, item_id FROM inv_item_tmp WHERE sitem_sub =.T. AND parent_id in (SELECT uid FROM inv_detail_tmp0) INTO CURSOR inv_detail_tmp2
	SELECT id FROM work_order_tmp WHERE NVL(show_in_cup_mode,.F.)=.T. UNION ALL SELECT id FROM work_order_tmp0 WHERE NVL(show_in_cup_mode,.F.)=.T. INTO CURSOR work_order_tmp_cup_slip &&Lihong 2022.09.27 UNION 
	SELECT uid FROM inv_item_tmp WHERE item_id>0 AND sitem=.F. AND sitem_sub =.f. AND item_id NOT in (SELECT item_id FROM inv_detail_tmp0) ;
		AND  item_id in (SELECT id FROM work_order_tmp_cup_slip) INTO CURSOR inv_detail_tmp 
	USE IN SELECT("work_order_tmp_cup_slip")

	SELECT inv_detail_tmp0 
	APPEND FROM DBF("inv_detail_tmp2")

	SELECT * FROM inv_item_tmp WHERE uid in (SELECT uid FROM inv_detail_tmp0) ORDER BY item_code INTO CURSOR inv_detail_tmp2
	SELECT * FROM inv_item_tmp WHERE uid in (SELECT uid FROM inv_detail_tmp) ORDER BY item_code INTO CURSOR inv_detail_tmp3
	SELECT * FROM inv_item_tmp WHERE uid NOT in (SELECT uid FROM inv_detail_tmp0) AND uid NOT in (SELECT uid FROM inv_detail_tmp) INTO CURSOR inv_item_tmp READWRITE  
	APPEND FROM DBF("inv_detail_tmp2")
	APPEND FROM DBF("inv_detail_tmp3")
ENDIF 
&&
IF USED("inv_item_tmp_deposit") AND RECCOUNT("inv_item_tmp_deposit")>0
	Insert Into inv_item_tmp Select 2, *,.F. As has_itemdisc From inv_item_tmp_deposit
ENDIF 
USE IN SELECT("inv_item_tmp_deposit")


Use In SELECT("inv_detail_tmp")
Use In SELECT("inv_detail_tmp0")
Use In SELECT("inv_detail_tmp2")
Use In SELECT("inv_detail_tmp3")


_last_same_tableno = "" &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
Select inv_item_tmp
Scan

	_have_pointed_item=.F.
	
	
	IF  Nvl(invlst_noprint,.F.) and (inv_item_tmp.amount<>0 or !(VARTYPE(__inv_print_0_amt_item) <> "U" AND __inv_print_0_amt_item) AND nvl(inv_item_tmp.alway_print_0_amt,.F.)=.F. )		&&¤@©w¤£¦C¦L &&Lihong 2023.05.05 alway_print_0_amt 
	
		LOOP 
	
	ENDIF
	
	
	IF VARTYPE(__inv_print_0_amt_item) <> "U" AND __inv_print_0_amt_item AND NVL(invlst_zeroNoprint,.f.) AND  inv_item_tmp.amount=0 		&&¹sª÷ÃB¬O§_¦C¦L 2023.05.05 alway_print_0_amt 
	
		LOOP 
	
	ENDIF
*---	
	


	If Empty(Field("points"))=.F. And Empty(Field("pointed"))=.F.		&&¦pªG¦³¿n¤À´«ÁÊ¶µ¥Ø,¤@©w¦C


		If pointed And points>0

			_have_pointed_item=.T.

		Endif

	Endif

&&¬O§_¤@©w¦C¦L¡A¸òÀHitemªº³]©w,update 2010.07.14  &&Lihong 2023.05.05 alway_print_0_amt 
	If Nvl(invlst_noprint,.F.)=.F. And _have_pointed_item=.F. And inv_item_tmp.amount=0 And (__inv_print_0_amt_item =.F. AND nvl(inv_item_tmp.alway_print_0_amt,.F.)=.F. OR inv_item_tmp.item_id=-3) AND inv_item_tmp.has_itemdisc=.F. 	
	&&ª÷ÃB¬°¹s,¤£§@¦C¦L(®Ú¾Ú³]©w)	³Ì§C®ø¶O®tÃB¬°¹s¤£§@¦C¦L** &&Lihong 2022.06.24 ¼W¥[inv_item_tmp.has_itemdisc=.F. 
		LOOP
	Endif


&&¬O§_¤@©w¦C¦L¡A¸òÀHitemªº³]©w,update 2010.07.14

	If Nvl(invlst_noprint,.F.)=.F.  And  inv_item_tmp.sitem_sub=.T.   And  __inv_print_sitem_detail=.F. And inv_item_tmp.amount=0 And inv_item_tmp.modi_amount=0 ;
			and inv_item_tmp.has_itemdisc=.F. 		&&®MÀ\¶µ¥Ø¤£§@¦C¦L(®Ú¾Ú³]©w)	**¯S§O³B²zª÷ÃB¬°¹s®É


		Select inv_item_tmp
		Loop

	Endif

	_id=inv_item_tmp.Id
	_uid=inv_item_tmp.uid
	_item_Id=inv_item_tmp.item_id
	_item_code = TRIM(inv_item_tmp.item_code)
	
	&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
	IF !(_last_same_tableno == TRIM(inv_item_tmp.same_tableno))
		_last_same_tableno = TRIM(inv_item_tmp.same_tableno)
		_same_tableno = TRIM(inv_item_tmp.same_tableno)
	ELSE
		_same_tableno = ""
	ENDIF 
	
	_qty=Iif(Mod(inv_item_tmp.qty,1)>0,Alltrim(Str(inv_item_tmp.qty,10,2)),Alltrim(Str(inv_item_tmp.qty,10,0)))
	&&Lihong 2022.03.17 ¨Ò®u
	IF inv_item_tmp.orgqty_case_mat>0
		_qty=Iif(Mod(inv_item_tmp.orgqty_case_mat,1)>0,Alltrim(Str(inv_item_tmp.orgqty_case_mat,10,2)),Alltrim(Str(inv_item_tmp.orgqty_case_mat,10,0)))
	ENDIF 
	IF inv_item_tmp.qty_entity>0
		_qty=Iif(Mod(inv_item_tmp.qty_entity,1)>0,Alltrim(Str(inv_item_tmp.qty_entity,10,2)),Alltrim(Str(inv_item_tmp.qty_entity,10,0)))
	ENDIF 
	_amount= inv_item_tmp.amount
	
	&&Lihong 2021.12.14 µo²¼¯S§O³B²z¬O§_¦C¦Lª÷ÃB(¯S§O³B²z¥[»ù®É¬O§_¦C¦L)
	IF Cprint_type="INV" AND Vartype(__inv_print_modi_amount)#"U" AND __inv_print_modi_amount AND (Vartype(__INV_PRINT_NOFREE_MODIFIER)#"U" AND __INV_PRINT_NOFREE_MODIFIER ) ;
	AND inv_item_tmp.modi_amount<>0 &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö OR inv_item_tmp.orgqty_case_mat>0 
		_amount = _amount - inv_item_tmp.modi_amount
	ENDIF 
	
	_price =inv_item_tmp.price
	
	&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
	_srv_per=inv_item_tmp.srv_per
*!*		_srv_per=IIF(VARTYPE(_inv_srv_type)="N",IIF(_inv_srv_type=0,inv_item_tmp.srv_per + _inv_srv_perc,MAX(inv_item_tmp.srv_per,_inv_srv_perc)),inv_item_tmp.srv_per)
	
	_srv_amount=inv_item_tmp.srv_amount

	Do Case
	
		Case inv_item_tmp.handwriting	 Or Nvl(inv_item_tmp.Custom,.F.)	&&¤â¼g¶µ¥Ø ©Î¦Û¿ï¶µ¥Ø

			_item=Trim(inv_item_tmp.descdisp)
*!*					IF Cprint_type="PAY" AND __slip_print_adduser 		&&¥I´Ú²M³æ¥[¤JÂIµæªÌ¦W¦r(¸òsetting)
*!*						_item=_item+" ("+TRIM(inv_item_tmp.adduser)+")"
*!*					ENDIF

			Select	inv_print_tmp
			Append Blank
			Replace same_tableno WITH _same_tableno, Item With _item,qty With _qty,amt With _amount,r_id With Iif(Cprint_type="PAY",2,1), item_id WITH _item_id

			Replace price With _price,srv_per WITH _srv_per,srv_amount WITH _srv_amount

		Case  inv_item_tmp.item_id<0	 AND !INLIST(inv_item_tmp.item_id,  -199, -111, -110, -104, -103, -102, -101, -51 )		&&³Ì§C®ø¶O®tÃB¤Î¤K¹F³q &&lihong 2020.04.20 !INLIST 2020.06.02 coupon item_id= -51
			_item=Trim(inv_item_tmp.descdisp)

			Select	inv_print_tmp
			Append Blank
			Replace same_tableno WITH _same_tableno, Item With _item,qty With _qty,amt With _amount,r_id With Iif(Cprint_type="PAY",2,1), item_id WITH _item_id
			
			Replace price With _price,srv_per WITH _srv_per,srv_amount WITH _srv_amount

		Otherwise

			_subitem=( inv_item_tmp.sitem_sub)
			inv_mult_item(_langue,_item_Id,_qty,_amount,Cprint_type,_subitem)						&&¦h»y¨¥¦C¦Lµæ¦¡


	Endcase




	If _have_pointed_item

		Select inv_print_tmp
		Replace points With Iif(Isnull(inv_item_tmp.points) Or inv_item_tmp.pointed=.F. ,0, inv_item_tmp.points*-1)

	Endif



	If Cprint_type ="INV" And Vartype(__inv_print_adduser_time)="L"		&&µo²¼¬O§_¦C¦L¸¨³æ¤H,®É¶¡

		If __inv_print_adduser_time OR VARTYPE(_cup_inv_print_adduser_time)#"U" &&Lihong 2022.05.16 or
			Select	inv_print_tmp
			Replace printtime With Ttoc(inv_item_tmp.printtime),adduser With Trim(inv_item_tmp.adduser)
		Endif

	Endif

	If Cprint_type ="PAY" And Vartype(__slip_print_adduser)="L"		&&¥I´Ú²M³æ¬O§_¦C¦L¸¨³æ¤H,®É¶¡

		If __slip_print_adduser

			Select	inv_print_tmp
			Replace printtime With Ttoc(inv_item_tmp.printtime),adduser With Trim(inv_item_tmp.adduser)
		Endif

	Endif


	Select inv_print_tmp
	_recno=Recno()

	If _reprint


		If Vartype(_data_hIstory)#"U"


			ssql="select * from "+view_inv_modi  +"  where id=?_id and item_id=?_uid order by dispord"
			ssql=ssql+Chr(10)+"select * from "+view_inv_itemdisc +"   where id=?_id and item_id=?_uid order by dispord"
			&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
			ssql="select * from "+view_inv_itemdisc +"   where id=?_id and item_id=?_uid order by dispord"
		Else


			ssql="select * from inv_modi    where id=?_id and item_id=?_uid order by dispord"
			ssql=ssql+Chr(10)+"select * from inv_itemdisc    where id=?_id and item_id=?_uid order by dispord"
			&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
			ssql="select * from inv_itemdisc    where id=?_id and item_id=?_uid order by dispord"
		Endif


	Else

		ssql="select * from order_modi    where id=?_id and item_id=?_uid order by dispord"
		ssql=ssql+Chr(10)+"select * from order_itemdisc    where id=?_id and item_id=?_uid order by dispord"
		&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
		ssql="select * from order_itemdisc    where id=?_id and item_id=?_uid order by dispord"
	Endif


	If SQLExec(nhand,ssql,"invdetail_tmp1")<0 &&&&Lihong 2023.06.29 invdetail_tmp -> invdetail_tmp1
		Aerror(err)

		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
	&&Lihong 2023.06.29 modi¬Û¦P¦X¨Ö
	SELECT * FROM inv_detail_tmp1 WHERE id=_id and item_id=_uid order by dispord INTO CURSOR invdetail_tmp
	
	If !Eof("invdetail_tmp")		&&¯S§O³B²z
		Select invdetail_tmp
		Scan  For modi_id>0		&&¶¡½u¤Î«H®§¤£¦C¦L

			If  Vartype(__INV_PRINT_NOFREE_MODIFIER)#"U" And  invdetail_tmp.modi_amount<>0 And __INV_PRINT_NOFREE_MODIFIER=.F. AND  inv_item_tmp.orgqty_case_mat=0			&&¯S§O³B²z¥[»ù¬O§_¦C¦L &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö
				Loop
			Endif

			If invdetail_tmp.modi_amount=0 And  __inv_print_free_modifier=.F. AND  inv_item_tmp.orgqty_case_mat=0 	&&¦pªG³]©w¯S§O³B²z¤£¥[»ù(ª÷ÃB¬°¹s)®É¤£§@¦C¦L,«h¤£§@¦C¦L	**  &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö
				Loop
			Endif

			_def_id=invdetail_tmp.def_id
			_modi_id=invdetail_tmp.modi_id
			_amount=0			&&invdetail_tmp.modi_amount ª÷ÃB¤£§@¦C¦L
			_modi_qty=invdetail_tmp.modi_qty

			&&Lihong 2021.12.14 µo²¼¯S§O³B²z¬O§_¦C¦Lª÷ÃB(¯S§O³B²z¥[»ù®É¬O§_¦C¦L)
			IF Cprint_type="INV" AND Vartype(__inv_print_modi_amount)#"U" AND __inv_print_modi_amount AND (Vartype(__INV_PRINT_NOFREE_MODIFIER)#"U" AND __INV_PRINT_NOFREE_MODIFIER OR  inv_item_tmp.orgqty_case_mat>0) ;
			AND invdetail_tmp.modi_amount<>0 &&Lihong 2022.04.27 ¨Ò®u¤£¦X¨Ö
				_amount = invdetail_tmp.modi_amount
			ENDIF 

			If invdetail_tmp.open_Modi		&&¤â¤u¯S§O³B²z

				_item=Trim(invdetail_tmp.descdisp)
				_cqty=Iif(Mod(invdetail_tmp.modi_qty,1)>0,Alltrim(Str(invdetail_tmp.modi_qty,10,2)),Alltrim(Str(invdetail_tmp.modi_qty,10,0)))	&& FIX 2010.12.17

				Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,1)
			Else
				IF VARTYPE(__pso_order)#"U"
				
					_item=Trim(invdetail_tmp.descdisp)
					_cqty=Iif(Mod(invdetail_tmp.modi_qty,1)>0,Alltrim(Str(invdetail_tmp.modi_qty,10,2)),Alltrim(Str(invdetail_tmp.modi_qty,10,0)))	&& FIX 2010.12.17			
				
					Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,1)
				
				ELSE
				
					inv_mult_modi(_langue,_modi_id,_def_id,_amount,Cprint_type)		&&¦h»y¨¥¦C¦L¯S§O³B²z
					
				ENDIF
				
			Endif

		Endscan

	Endif
	
	If !Eof("invdetail_tmp1")		&&¶µ¥Ø§é¦©

		Select invdetail_tmp1
		Scan
			_id=invdetail_tmp1.disc_id
			Select work_order_tmp5
			Locate For Id=_id

			_item="*"+Space(4)+Iif(_langue="CN",Trim(desccn),Trim(Descen))		&&  ®Ú¾Ú»y¨¥³]©w¿é¥X¤¤/­^¤å

			Select	inv_print_tmp
			Append Blank
			Replace r_id With Iif(Cprint_type="PAY",2,1),Item With _item,amt With -1* invdetail_tmp1.disc_amount			&&§é¦© Åã¥Ü¬°­t¼Æ

		Endscan

	Endif





Endscan
USE IN SELECT("inv_detail_tmp1")

*IF Cprint_type="INV"	&&µo²¼	¾ã³æ§é¦©

If _reprint

	If Vartype(_data_hIstory)#"U"

		ssql="select inv_disc.*,ISNULL(disc.desccn,'') as desccn, ISNULL(disc.descen,'') as descen from "+view_inv_disc+" inv_disc  left join disc on inv_disc.disc_id=disc.id where inv_disc.id=?_Nid"

	Else

		ssql="select inv_disc.*,ISNULL(disc.desccn,'') as desccn, ISNULL(disc.descen,'') as descen from inv_disc    left join disc on inv_disc.disc_id=disc.id where inv_disc.id=?_Nid"

	Endif



Else

	ssql="select order_disc.*,ISNULL(disc.desccn,'') as desccn, ISNULL(disc.descen,'') as descen from order_disc    left join disc on order_disc.disc_id=disc.id where order_disc.id=?_Nid"
Endif

If SQLExec(nhand,ssql,"invdetail_tmp2")<0
	Aerror(err)
	frm_wait.Hide

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

If !Eof("invdetail_tmp2")


	Local _descdisp
	Select invdetail_tmp2

	Scan

		_descdisp=Iif(disc_qty>1,Alltrim(Str(disc_qty))+"x ","")+Iif(_langue="CN",Trim(Nvl(invdetail_tmp2.desccn,"")),Trim(Nvl(invdetail_tmp2.Descen,"")))		&&update 2009.03.26
*		_amt=Iif(invdetail_tmp2.disc_type=3,invdetail_tmp2.disc_amount,0)
		_amt=invdetail_tmp2.disc_amount

		If Empty(_descdisp)

			Loop

		Endif


		ssql=""

		If Cprint_type="INV"	&&µo²¼	¾ã³æ§é¦©

			If __inv_print_to_local

				Insert Into inv_print_disc (descdisp,amt,points) Values (_descdisp,_amt,invdetail_tmp2.points)

			Else

				ssql="insert into inv_print_disc (pid,descdisp,amt,points) values (?_pid,?_descdisp,?_amt,?invdetail_tmp2.points)"

			Endif

		Else


			If Vartype(__pay_slip_print_disc)="L" And __pay_slip_print_disc				&&

				If __pay_print_to_local

					Insert Into pay_print_disc (descdisp,amt) Values (_descdisp,_amt)


				Else
					ssql="insert into pay_print_disc (pid,descdisp,amt) values (?_pid,?_descdisp,?_amt)"

				Endif

			Endif

		Endif

*!*				IF VARTYPE(__pay_slip_print_disc)="L" AND __pay_slip_print_disc			&&®I¸}¯È¬O§_¦L§é¦©¸ò³]©w
*!*
*!*					ssql=ssql+CHR(10)+"insert into inv_print_disc (pid,descdisp,amt) values (?_pid,?_descdisp,?_amt)"
*!*
*!*				ENDIF

*!*			IF __inv_print_to_local=.f.


				If _Lreprint  and vartype(__inv_reprint_save)#"U" and __inv_reprint_save

					ssql=ssql+Chr(10)+"insert into inv_reprint_disc (pid,descdisp,amt,points) values (?_pid,?_descdisp,?_amt,?invdetail_tmp2.points)"

				Endif


		If SQLExec(nhand,ssql)<0
			Aerror(err)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1
		Endif

*!*
*!*
*!*			ENDIF
*!*

	Endscan

Endif

&&¨ú®øµæ¦¡



If (_Nid>0     And    _reprint    )  Or  _Nvoid_Id>0		&& 2012.12.19


*	SET STEP ON 

	If _Nvoid_Id>0

		
		TEXT TO ssql noshow
		
			select a.*,b.desccn,b.descen,c.desccn as name_cn,c.descen as name_en  from order_void a 
			left join void_reason b on a.void_reason=b.id
			left join item c on a.item_id =c.id 
			where isnull(c.invlst_noprint,0)=0  and  void_Id=?_Nvoid_id
			
		
		
		ENDTEXT
		

*		ssql= "select * from order_void where void_Id=?_Nvoid_id"

	Else

		TEXT TO ssql noshow
		
			select a.*,b.desccn,b.descen ,c.desccn as name_cn,c.descen as name_en  from order_void a 
			left join void_reason b on a.void_reason=b.id
			left join item c on a.item_id =c.id 
			where isnull(c.invlst_noprint,0)=0  and  inv_Id=?_Nid
		
		
		ENDTEXT


*		ssql= "select * from order_void where inv_Id=?_Nid"

	Endif


	If SQLExec(nhand,ssql,"invdetail_tmp3")<0
		Aerror(err)
		frm_wait.Hide

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif

	If !Eof("invdetail_tmp3")
		Select invdetail_tmp3
		SCAN
			
		
			_descdisp = IIF(_langue="CN",TRIM(invdetail_tmp3.name_cn),TRIM(invdetail_tmp3.name_en))	&& modi by david 2018.09.04
			
			 _descdisp = _descdisp +IIF(EMPTY(NVL(invdetail_tmp3.desccn,"")) ,"","("+IIF(_langue="CN",TRIM(invdetail_tmp3.desccn),TRIM(invdetail_tmp3.descen)) +")")
			_qty=invdetail_tmp3.qty
			&&Lihong 2022.03.17 ¨Ò®u
*!*				IF invdetail_tmp3.orgqty_case_mat>0
*!*					_qty=invdetail_tmp3.orgqty_case_mat
*!*				ENDIF 
			_amt=invdetail_tmp3.amount

			If __inv_print_to_local

				&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ µLinvdetail_tmp3.same_tableno
				Insert Into inv_print_void (same_tableno,descdisp,qty,amt) Values ("",_descdisp,_qty,_amt)


			Else

				&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ µL?invdetail_tmp3.same_tableno
				ssql="insert into inv_print_void (pid,same_tableno,descdisp,qty,amt) values (?_pid,'',?_descdisp,?_qty,?_amt)"
				
					If _Lreprint and vartype(__inv_reprint_save)#"U"  and __inv_reprint_save
						ssql=ssql+Chr(10)+"insert into inv_reprint_void (pid,same_tableno,descdisp,qty,amt) values (?_pid,'',?_descdisp,?_qty,?_amt)"
					Endif

				If SQLExec(nhand,ssql)<0
					Aerror(err)
					frm_wait.Hide

					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

					Return -1
				Endif


			Endif


		Endscan

	Endif



Endif

*------------- add by david 2009.01.02  holland tax

Update inv_item_tmp Set tax2=0 Where Isnull(tax2)
*********TAX2  ADD BY DAVID  2009.01.02
Select tax2,Sum((real_amount+round_amount+xdisc)-(real_amount+round_amount+xdisc)/(1+tax2/100)) As amt  From inv_item_tmp Group By tax2 Where tax2>0 Into Cursor tax2_tmp		&&¬O§_¦³²üÄõµ|
If _Tally>0

	Select tax2_tmp
	Scan
		_desc=Alltrim(Str(tax2,10,2))+"%"

		If __inv_print_to_local


			Insert Into inv_print_tax (descdisp,amt) Values (_desc,tax2_tmp.amt)

		Else


			ssql="insert into inv_print_tax (pid,descdisp,amt) values (?_Pid,?_desc,?tax2_tmp.amt)"
			
			If _Lreprint and vartype(__inv_reprint_save)#"U"  and __inv_reprint_save
				ssql=ssql+Chr(10)+"insert into inv_reprint_tax (pid,descdisp,amt) values (?_Pid,?_desc,?tax2_tmp.amt)"

			Endif

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1
			Endif

		Endif


	Endscan


Else		&& µ|¶µ


	Select tax_id,Sum(tax_amount) As amt From inv_tax_tmp Group By tax_id Into Cursor tax2_tmp


	Select tax2_tmp
	Scan

		Select desccn,Descen From inv_tax_tmp Where tax_id=tax2_tmp.tax_id Into Cursor cun_tmp

		&&Lihong 2020.05.19
		*_desc=Iif(_system_langue="CN",Trim(cun_tmp.desccn),Trim(cun_tmp.Descen))
		_desc=Iif(_system_langue="CN",NVL(Trim(cun_tmp.desccn),""),NVL(Trim(cun_tmp.Descen),"") )

		If __inv_print_to_local

			Insert Into inv_print_tax (descdisp,amt) Values (_desc,tax2_tmp.amt)

		Else


			ssql="insert into inv_print_tax (pid,descdisp,amt) values (?_Pid,?_desc,?tax2_tmp.amt)"

			If _Lreprint and vartype(__inv_reprint_save)#"U"  and __inv_reprint_save
				ssql=ssql+Chr(10)+"insert into inv_reprint_tax (pid,descdisp,amt) values (?_Pid,?_desc,?tax2_tmp.amt)"

			Endif

			If SQLExec(nhand,ssql)<0
				Aerror(err)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1
			Endif


		Endif



	Endscan


Endif

*Use In tax2_tmp

&&Lihong 2022.08.19 ¤À±b
IF __inv_print_to_local=.F. AND VARTYPE(_inv_print_attach_split)#"U" AND _inv_print_attach_split AND USED("inv_split_tmp")
	SELECT inv_split_tmp 
	SCAN 
		ssql="insert into inv_print_split (pid,split_desc,cust_amt) values (?_Pid,?inv_split_tmp.split_desc,?inv_split_tmp.cust_amt)"
		If SQLExec(nhand,ssql)<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1
		Endif
	ENDSCAN 
	USE IN SELECT("inv_split_tmp")
ENDIF 

*SET STEP ON 
Local _points

Select inv_print_tmp		&&save to
Scan


	If _print_to_local

		&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
		If Cprint_type="PAY"
			Insert Into pay_print_detail (same_tableno,Item,qty,amt,Free,printtime,adduser,item_unicode,price,item_id) Values ;
				(inv_print_tmp.same_tableno,inv_print_tmp.Item,inv_print_tmp.qty,inv_print_tmp.amt,inv_print_tmp.Free,;
				inv_print_tmp.printtime,inv_print_tmp.adduser,inv_print_tmp.item_unicode,inv_print_tmp.price,inv_print_tmp.item_id)


		Else
			Insert Into inv_print_detail (same_tableno,Item,qty,amt,Free,item_unicode,printtime,adduser,points,item_id) Values;
				(inv_print_tmp.same_tableno,inv_print_tmp.Item,inv_print_tmp.qty,inv_print_tmp.amt,inv_print_tmp.Free,;
				inv_print_tmp.item_unicode,inv_print_tmp.printtime,inv_print_tmp.adduser,inv_print_tmp.points,inv_print_tmp.item_id)



				If _Lreprint and vartype(__inv_reprint_save)#"U"  and __inv_reprint_save
					ssql=ssql+Chr(10)+"insert into inv_reprint_detail (pid,same_tableno,item,qty,amt,free,item_unicode,printtime,adduser,points) values "+;
						" (?_pid,?inv_print_tmp.same_tableno,?inv_print_tmp.item,?inv_print_tmp.qty,?inv_print_tmp.amt,?inv_print_tmp.free,"+;
						"?inv_print_tmp.item_unicode,?inv_print_tmp.printtime,?inv_print_tmp.adduser,?inv_print_tmp.points)"


				Endif

				If SQLExec(nhand,ssql)<0
					Aerror(err)
					frm_wait.Hide

					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))


					Return -1
				Endif


		Endif




	Else

		&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
		If Cprint_type="PAY"
			ssql="insert into pay_print_detail (pid,same_tableno,item,qty,amt,free,printtime,adduser,item_unicode,price) values "+;
				"(?_pid,?inv_print_tmp.same_tableno,?inv_print_tmp.item,?inv_print_tmp.qty,?inv_print_tmp.amt,?inv_print_tmp.free,"+;
				"?inv_print_tmp.printtime,?inv_print_tmp.adduser,?inv_print_tmp.item_unicode,?inv_print_tmp.price)"

		Else
			ssql="insert into inv_print_detail (pid,same_tableno,item,qty,amt,free,item_unicode,printtime,adduser,points) values"+;
				" (?_pid,?inv_print_tmp.same_tableno,?inv_print_tmp.item,?inv_print_tmp.qty,?inv_print_tmp.amt,?inv_print_tmp.free,"+;
				"?inv_Print_tmp.item_unicode,?inv_print_tmp.printtime,?inv_print_tmp.adduser,?inv_print_tmp.points)"

				If _Lreprint and vartype(__inv_reprint_save)#"U"  and __inv_reprint_save
					ssql=ssql+Chr(10)+"insert into inv_reprint_detail (pid,same_tableno,item,qty,amt,free,item_unicode,printtime,adduser,points) values "+;
						" (?_pid,?inv_print_tmp.same_tableno,?inv_print_tmp.item,?inv_print_tmp.qty,?inv_print_tmp.amt,?inv_print_tmp.free,"+;
						"?inv_print_tmp.item_unicode,?inv_print_tmp.printtime,?inv_print_tmp.adduser,?inv_print_tmp.points)"


				Endif


		Endif

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			frm_wait.Hide

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))


			Return -1
		Endif

	Endif


Endscan



If Used("inv_print_tmp")
	Select inv_print_tmp
	Use
Endif


If Used("invdetail_tmp")
	Select invdetail_tmp
	Use
Endif
If Used("invdetail_tmp1")
	Select invdetail_tmp1
	Use
Endif
If Used("invdetail_tmp2")
	Select invdetail_tmp2
	Use
Endif



Return 1

Endfunc


***************************************

*µo²¼¦h»y¨¥³B²z
**************************************
Function inv_mult_item

Lparameters _langue,_item_Id,_qty,_amount,Cprint_type,_subitem

Local _inv,_rid,_space,lcQty

_space=Space(5)
If Cprint_type="PAY"
	_inv=Iif(_langue="CN","__chinese_pay_slip_itemlist","__english_pay_slip_itemlist")	&&µ²±bªºµo²¼¶µ¥Ø
	_rid=2
Else
	_inv=Iif(_langue="CN","__chinese_invoice","__english_invoice")	&&¤¤¤å/­^¤åµo²¼
	_rid=1
Endif

lcQty=_qty

Local lnPrice


lnPrice = Iif(Vartype(_price)="N" ,_price ,0)

lnSrv_per= Iif(Vartype(_srv_per)="N" ,_srv_per,0)
lnSrv_amount= Iif(Vartype(_srv_amount)="N" ,_srv_amount,0)


IF VARTYPE(__pso_order)#"U"
	

	Select descinvcn,descinven,desckit,desc_other,kilo,kilo2,descpole,Code From work_order_tmp Where code=_item_code Into Cursor cun_tmp
	&&Lihong 2022.09.27
	IF RECCOUNT("cun_tmp")=0
		Select descinvcn,descinven,desckit,desc_other,kilo,kilo2,descpole,Code From work_order_tmp0 Where code=_item_code Into Cursor cun_tmp
	ENDIF 


ELSE

	Select descinvcn,descinven,desckit,desc_other,kilo,kilo2,descpole,Code From work_order_tmp Where Id=_item_Id Into Cursor cun_tmp
	&&Lihong 2022.09.27
	IF RECCOUNT("cun_tmp")=0
		Select descinvcn,descinven,desckit,desc_other,kilo,kilo2,descpole,Code From work_order_tmp0 Where Id=_item_Id Into Cursor cun_tmp
	ENDIF 

ENDIF


_ckilo=""
If (cun_tmp.kilo	 OR cun_tmp.kilo2) AND (EMPTY(FIELD("qty_entity", "inv_item_tmp")) OR inv_item_tmp.qty_entity=0) 	&&¦pªG±Ä¥Î¤ç¨â­pºâ  &&Lihong 2022.04.27 qty_entity

	Local lnQty

	lnQty=Val(lcQty)

	If Vartype( __kilo_unit)#"U" And __kilo_unit="K10"		&&¤Q¶i¨î
		IF 	cun_tmp.kilo	&&Lihong 2023.03.20 ¼W¥[«ö¤ç­p
			lcQty	=Iif(Int(lnQty)>0 ,Alltrim(Str(Int(lnQty)))+getmessage("_kilo"),"")+;
				IIF(Mod(lnQty,1)>0,ALLTRIM(STR(MOD(lnQty,1)*10,2,0))+getmessage("_kilo2"),"")
		
		ELSE &&Lihong 2023.03.20 &&«ö¨â­p(­ì¨Ó¤è¦¡©l²×«ö¨â)
			lcQty	=Iif(Int(lnQty/10)>0 ,Alltrim(Str(Int(lnQty/10)))+getmessage("_kilo"),"")+;
				IIF(Mod(lnQty,10)>0,Alltrim(Str(Mod(lnQty,10)))+getmessage("_kilo2"),"")
		ENDIF 


	Else		&&¹w³]¬°¤Q¤»¶i¨î
	
		
		
		IF 	cun_tmp.kilo	&& «ö¤ç­p
		
			lcQty	=Iif(Int(lnQty)>0 ,Alltrim(Str(Int(lnQty)))+getmessage("_kilo"),"")+;
				IIF(Mod(lnQty,1)>0,ALLTRIM(STR(MOD(lnQty,1)*16,2,0))+getmessage("_kilo2"),"")
	

		ELSE
		

			lcQty	=Iif(Int(lnQty/16)>0 ,Alltrim(Str(Int(lnQty/16)))+getmessage("_kilo"),"")+;
				IIF(Mod(lnQty,16)>0,Alltrim(Str(Mod(lnQty,16)))+getmessage("_kilo2"),"")
	
		ENDIF
		

	Endif


Endif

Local _code

_code=""
If (Vartype(__inv_print_itemcode)#"U" And __inv_print_itemcode And Cprint_type="INV") Or (Vartype(__paylist_print_itemcode)#"U" And __paylist_print_itemcode And Cprint_type="PAY")


	_code=Alltrim(cun_tmp.Code)+" "

Endif


Local _other
_other=""

&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
lcsame_tableno = ""
IF VARTYPE(_same_tableno)#"U"
	lcsame_tableno = _same_tableno 
	*_same_tableno = ""
ENDIF 

Do Case


	Case &_inv="cn"	&&¤¤¤å³øªí¦WºÙ

		_item=Trim(cun_tmp.descinvcn)

		_item=_code+_item

		If _subitem
			_item=_space+_item
		Endif

*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF
		
		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount ,item_id ) Values (lcsame_tableno,_item,lcQty,_amount,_rid , lnPrice ,lnSrv_per,lnSrv_amount,_item_Id)
		
		
	Case &_inv="en"	&&­^¤å³øªí¦WºÙ

		If Vartype(pb_print_other_inv)#"U"		&&¶V«nµo²¼

			_item=Trim(cun_tmp.descpole)

		Else

			_item=Trim(cun_tmp.descinven)
		Endif

		_item=_code+_item


		If Cprint_type="PAY" And __slip_print_adduser
			_item=_item+"("+Trim(inv_item_tmp.adduser)+")"
		Endif

		If _subitem
			_item=_space+_item
		Endif

*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price ,srv_per ,srv_amount,item_id ) Values (lcsame_tableno,_item,lcQty,_amount,_rid ,lnPrice ,lnSrv_per,lnSrv_amount,_item_Id)


	Case &_inv="kit"		&&¼p©Ð³æ¦WºÙ

		_item=Trim(cun_tmp.desckit)
		_item=_code+_item

		If _subitem
			_item=_space+_item
		Endif

*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF


		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount ,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid ,lnPrice  ,lnSrv_per,lnSrv_amount,_item_Id)

	Case &_inv="cn_en"

		_item=Trim(cun_tmp.descinvcn)
		_item1=Trim(cun_tmp.descinven)

		_item=_code+_item

		If _subitem
			_item=_space+_item
			_item1=_space+_item1
		Endif

*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount,item_id ) Values (lcsame_tableno,_item,lcQty,_amount,_rid ,lnPrice  ,lnSrv_per,lnSrv_amount,_item_Id)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)

	Case &_inv="cn_kit"

		_item=Trim(cun_tmp.descinvcn)
		_item1=Trim(cun_tmp.desckit)

		_item=_code+_item

		If _subitem
			_item=_space+_item
			_item1=_space+_item1
		Endif

*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount ,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid ,lnPrice  ,lnSrv_per,lnSrv_amount,_item_Id)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)


	Case &_inv="en_kit"

		_item=Trim(cun_tmp.descinven)
		_item1=Trim(cun_tmp.desckit)

		_item=_code+_item

		If _subitem
			_item=_space+_item
			_item1=_space+_item1
		Endif
*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount ,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid ,lnPrice  ,lnSrv_per,lnSrv_amount,_item_Id)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)



	Case &_inv="cn_en_kit"

		_item=Trim(cun_tmp.descinvcn)
		_item1=Trim(cun_tmp.descinven)
		_item2=Trim(cun_tmp.desckit)

		_item=_code+_item


		If _subitem
			_item=_space+_item
			_item1=_space+_item1
			_item2=_space+_item2

		Endif

*!*			IF !EMPTY(_ckilo)
*!*				_item=_item+CHR(13)+_ckilo
*!*
*!*			ENDIF

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount ,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid ,lnPrice  ,lnSrv_per,lnSrv_amount,_item_Id)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)
		Insert Into inv_print_tmp(Item,r_id) Values (_item2,_rid)


	Case 	 &_inv="other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other=Trim(Nvl(cun_tmp.desc_other,""))

		_other=_code+_other


		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id,item_unicode,price,srv_per ,srv_amount ,item_id) Values (lcsame_tableno,_other,lcQty,_amount,_rid,_other ,lnPrice ,lnSrv_per,lnSrv_amount , _item_Id)


	Case 	 &_inv="cn_other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

		_item=Trim(cun_tmp.descinvcn)

		_item=_code+_item

		If _subitem
			_item=_space+_item
		Endif

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,lcQty,_amount,_rid)

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other=Trim(Nvl(cun_tmp.desc_other,""))

		Insert Into inv_print_tmp (r_id,same_tableno,item_unicode,price,srv_per ,srv_amount ,item_id) Values (_rid,lcsame_tableno,_other ,lnPrice,lnSrv_per,lnSrv_amount,_item_Id)


	Case 	 &_inv="en_other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

		_item=Trim(cun_tmp.descinven)

		_item=_code+_item

		If _subitem
			_item=_space+_item
		Endif

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id,price,srv_per ,srv_amount,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid,lnPrice,lnSrv_per,lnSrv_amount,_item_Id)

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS
		_other=Trim(Nvl(cun_tmp.desc_other,""))

		Insert Into inv_print_tmp (r_id,item_unicode) Values (_rid,_other)


	Case 	 &_inv="kit_other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

		_item=Trim(cun_tmp.descinvkit)

		_item=_code+_item


		If _subitem
			_item=_space+_item
		Endif

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id ,price,srv_per ,srv_amount,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid,lnPrice,lnSrv_per,lnSrv_amount,_item_Id)

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other=Trim(Nvl(cun_tmp.desc_other,""))

		Insert Into inv_print_tmp (r_id,item_unicode) Values (_rid,_other)


	Otherwise			&&cn

		_item=Trim(cun_tmp.descinvcn)

		_item=_code+_item


		If _subitem
			_item=_space+_item
		Endif
*!*					IF !EMPTY(_ckilo)
*!*						_item=_item+CHR(13)+_ckilo
*!*
*!*					ENDIF

		Insert Into inv_print_tmp (same_tableno,Item,qty,amt,r_id,price,srv_per ,srv_amount,item_id) Values (lcsame_tableno,_item,lcQty,_amount,_rid,lnPrice,lnSrv_per,lnSrv_amount,_item_Id)

Endcase


Endfunc
***********************************
*µo²¼¯S§O³B²z¦h»y¨¥³B²z
*
***************************************
Function inv_mult_modi

Lparameters _langue,_modi_id,_def_id,_amount,Cprint_type		&&¦h»y¨¥¦C¦Lµo²¼ µæ¦¡¯S§O³B²z

Local _inv,_rid
If Cprint_type="PAY"
	_inv=Iif(_langue="CN","__chinese_pay_slip_itemlist","__english_pay_slip_itemlist")	&&µ²±bªºµo²¼¶µ¥Ø
	_rid=2
Else
	_inv=Iif(_langue="CN","__chinese_invoice","__english_invoice")	&&¤¤¤å/­^¤åµo²¼
	_rid=1
Endif

If Cprint_type="INV"


	Select descinvcn,descinven,desckit,open_Modi,desc_other From work_order_tmp4 Where Id=_modi_id And ppl>0 And parent_id In (Select Id From work_order_tmp4  Where Nvl(linkppl,.F.) ) Into Cursor cun_tmp

	If _Tally>0


		Return

	Endif

Endif


Select descinvcn,descinven,desckit,open_Modi,desc_other From work_order_tmp4 Where Id=_modi_id Into Cursor cun_tmp





Local _other,_cqty

_other=""
_cqty=""

*---------------------------------------------------------		&&add by david  18/03/2008  ggg
If Vartype(__inv_print_modi_when_qty_1)="U" Or  _modi_qty>1 &&Val(_qty)>1

	_cqty=Iif(Mod(_modi_qty,1)>0,Alltrim(Str(_modi_qty,10,2)),Alltrim(Str(_modi_qty,10,0)))		&& 2010.08.27

Endif


Do Case


	Case &_inv="cn"	&&¤¤¤å³øªí¦WºÙ
		_item=Trim(cun_tmp.descinvcn)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)


	Case &_inv="en"	&&­^¤å³øªí¦WºÙ
		_item=Trim(cun_tmp.descinven)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(Descen)+Space(1)+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)



	Case &_inv="kit"		&&¼p©Ð³æ¦WºÙ
		_item=Trim(cun_tmp.desckit)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Iif(_langue="CN",Trim(desccn),Trim(Descen)+Space(1))+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)


	Case &_inv="cn_en"

		_item=Trim(cun_tmp.descinvcn)
		_item1=Trim(cun_tmp.descinven)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
			_item1=Trim(Descen)+Space(1)+_item1
		Endif
		_item="*"+Space(4)+_item
		_item1=Space(5)+_item1

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)


	Case &_inv="cn_kit"
		_item=Trim(cun_tmp.descinvcn)
		_item1=Trim(cun_tmp.desckit)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
			_item1=Iif(_langue="CN",Trim(desccn),Trim(Descen)+Space(1))+_item1
		Endif
		_item="*"+Space(4)+_item
		_item1=Space(5)+_item1

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)


	Case &_inv="en_kit"
		_item=Trim(cun_tmp.descinven)
		_item1=Trim(cun_tmp.desckit)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(Descen)+Space(1)+_item
			_item1=Iif(_langue="CN",Trim(desccn),Trim(Descen)+Space(1))+_item1
		Endif
		_item="*"+Space(4)+_item
		_item1=Space(5)+_item1

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)


	Case &_inv="cn_en_kit"
		_item=Trim(cun_tmp.descinvcn)
		_item1=Trim(cun_tmp.descinven)
		_item2=Trim(cun_tmp.desckit)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
			_item1=Trim(Descen)+Space(1)+_item1
			_item2=Iif(_langue="CN",Trim(desccn),Trim(Descen)+Space(1))+_item2

		Endif
		_item="*"+Space(4)+_item
		_item1=Space(5)+_item1
		_item2=Space(5)+_item2

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)
		Insert Into inv_print_tmp(Item,r_id) Values (_item1,_rid)
		Insert Into inv_print_tmp(Item,r_id) Values (_item2,_rid)


	Case 	 &_inv="other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other=Trim(Nvl(cun_tmp.desc_other,""))

		_item=Trim(cun_tmp.desc_other)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id,item_unicode) Values (_item,_cqty,_amount,_rid,_other)


	Case 	 &_inv="cn_other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS

		_other=Trim(Nvl(cun_tmp.desc_other,""))

		_item=Trim(cun_tmp.descinvcn)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)
		Insert Into inv_print_tmp(item_unicode,r_id) Values (_other,_rid)


	Case 	 &_inv="en_other" And Val(__mult_langue_code)>0 And !Empty(Trim(cun_tmp.desc_other))

*		_other=Strconv(Strconv(Trim(cun_tmp.desc_other),14),11,Val(__mult_langue_code),1)	&&Âà¬°DBCS
		_other=Trim(Nvl(cun_tmp.desc_other,""))

		_item=Trim(cun_tmp.descinven)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)
		Insert Into inv_print_tmp(item_unicode,r_id) Values (_other,_rid)



	Otherwise

		_item=Trim(cun_tmp.descinvcn)
		If _def_id>0
			Select work_order_tmp20
			Locate For Id=_def_id
			_item=Trim(desccn)+_item
		Endif
		_item="*"+Space(4)+_item

		Insert Into inv_print_tmp (Item,qty,amt,r_id) Values (_item,_cqty,_amount,_rid)

Endcase

Endfunc


**********************
*µo²¼­«¦L 
*
Function inv_reprint
Lparameters _invID,_clangue,_Lreprint_noPay,_Lfastfood,_inv_reprint


If Vartype(_android_station)="U"

	frm_wait.Show
	Wait "" To N Timeout 0.01

Endif


If !Used("work_order_tmp")

	If create_order_database()=-1		&&¦pªGwork_order_tmp¤£¦s¦b¡A­«¸ü¼Æ¾ÚÀô¹Ò
		frm_wait.Hide
		Return -1
	Endif

Endif


If Vartype(_data_hIstory)#"U"

*	csql="select inv.*,isnull(member.cardno,'') as member_id,isnull(member.name_cn,'') as member_name from "+view_inv+" inv with (nolock)    left join member on inv.memberno=member.id where  inv.id=?_invID"

	TEXT TO csql NOSHOW TEXTMERGE
		select inv.*,isnull(member.cardno,'') as member_id,isnull(member.name_cn,'') as member_name ,
		c.desccn as fast_info_cn,c.descen as fast_info_en
		from <<view_inv>>  inv with (nolock)
		left join member on inv.memberno=member.id
		left join fastfood_info c on inv.fastfood_info_id=c.id
		where  inv.id=?_invID

	ENDTEXT


Else

	TEXT TO csql noshow
		select inv.*,isnull(member.cardno,'') as member_id,isnull(member.name_cn,'') as member_name,
		c.desccn as fast_info_cn,c.descen as fast_info_en
		from inv with (nolock)
		left join member on inv.memberno=member.id
		left join fastfood_info c on inv.fastfood_info_id=c.id
		where  inv.id=?_invID

	ENDTEXT

*	csql="select inv.*,isnull(member.cardno,'') as member_id,isnull(member.name_cn,'') as member_name from inv with (nolock)   left join member on inv.memberno=member.id where  inv.id=?_invID"

Endif


If SQLExec(nhand,csql,"cun_tmp2")<0
	Aerror(err)

	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif
*PRIVATE _tableno
_tableno=Trim(cun_tmp2.tableno)
_station_id=cun_tmp2.station_id

_void_id=cun_tmp2.void_id

_inv_amt=cun_tmp2.invamt
_tel=cun_tmp2.tel
_mem_remark=Trim(cun_tmp2.remark)

_inv_remark =Trim(Nvl(cun_tmp2.inv_remark,""))	&&2013.12.19
_inv_remark2 =Trim(Nvl(cun_tmp2.inv_remark2,""))	&&2013.12.19







_inv_points=Iif(Isnull(cun_tmp2.points),0,cun_tmp2.points)
_inv_points_used=Iif(Isnull(cun_tmp2.points_used),0,cun_tmp2.points_used)
_inv_points_remain=Iif(Isnull(cun_tmp2.points_remain),0,cun_tmp2.points_remain)




If cun_tmp2.fastfood_info_id>0

	Public _pub_fastfood_info

	_pub_fastfood_info=Iif(_system_langue="CN",Trim(cun_tmp2.fast_info_cn) ,Trim(cun_tmp2.fast_info_en))


Endif



If !Empty(_tel)

	_addr=getaddress(_tel)

Else

	_addr=""

Endif


_pplcnt=cun_tmp2.pplcnt
_isfastfood=cun_tmp2.fastfood
_ISvoid=cun_tmp2.void		&&¬O§_void³æ
_link_table=Trim(Trim(cun_tmp2.link_table),",")

_clink_table=Iif(Empty(_link_table),"","("+_tableno+"-"+Strtran(_link_table,',','/')+")")

csql="select outlet_id,name from tables    where tableno=?_tableno"
If SQLExec(nhand,csql,"cun_tmp1")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif

_outlet_id=cun_tmp1.outlet_Id
_table_name=Trim(cun_tmp1.Name)

*If Empty(__Inv_direct_printer)	Or Isnull(__Inv_direct_printer)	&&¬O§_ªö¥Îµo²¼ª½¦L¥´¦L¾÷(¤£¸gprint_server)


_printer=__sys_inv_printer
*	_inv_print_to_local=__inv_print_to_local

*!*	Else

*!*		_inv_print_to_local=.T.
*!*		_printer=Trim(__Inv_direct_printer)


*!*	Endif

If Vartype(_preview_invoice)#"U"

	_printer=""

Endif


Local inv_pn	&&¥´¦L¥÷¼Æ
*---------->>>>µo²¼¥´¦L¼Æ¾Ú

=SQLSetprop(nhand,"Transactions",2)

				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						

_table_info=Iif(!Empty(cun_tmp2.askno),Trim(cun_tmp2.askno),_tableno)+Iif(!Empty(_table_name) And __inv_print_table_name,"<"+_table_name+">","")		&&À\Âi+»¡©ú(¬O§_¦C¦L¬Ýsetting)

_Pid="INV"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"INV"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î


If __inv_print_to_local

	Create_inv_print_cursor()		&&¥Í¦¨©Ò»ÝÁ{®Éªí



	Insert Into inv_print_main (inv_Id,tableno,pplcnt,Printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,training,tel,address,;
		amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,reprint,link_table,remark,points,points_used,points_remain,inv_remark,inv_remark2);
		values (_invID, _table_info, cun_tmp2.pplcnt, _printer, _printer,'', __inv_print_to_local, Datetime(),Datetime(), _login_user_name, _station_id, _clangue, cun_tmp2.fastfood, GL_training, cun_tmp2.tel, _addr,;
		cun_tmp2.amount, cun_tmp2.discamt, cun_tmp2.itemdiscamt, cun_tmp2.srvamt, cun_tmp2.taxamt, cun_tmp2.rndamt, cun_tmp2.invamt,;
		cun_tmp2.begintime, cun_tmp2.paidtime, cun_tmp2.member_name, cun_tmp2.member_id, cun_tmp2.void, _Lreprint_noPay, _link_table,;
		_mem_remark, _inv_points, _inv_points_used, _inv_points_remain,_inv_remark,_inv_remark2)


Else
	&&Lihong 2023.03.08 printed=?__inv_print_to_local -> ?_llprinted
	_llprinted = __inv_print_to_local
	IF VARTYPE(_show_inv_problem)#"U"
		_llprinted = .T.
	ENDIF 

	ssql="insert into inv_print_main (pid,inv_Id,tableno,pplcnt,printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,training,tel,address,"+;
		"amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,reprint,link_table,remark,points,points_used,points_remain,inv_remark,inv_remark2)"+;
		" values (?_pid,?_invID,?_table_info,?cun_tmp2.pplcnt,?_printer,?_printer,'',?_llprinted,?DATETIME(),'',?_login_user_name,?_station_id,?_clangue,?cun_tmp2.fastfood,?GL_training,?cun_tmp2.tel,?_addr,"+;
		"?cun_tmp2.amount,?cun_tmp2.discamt,?cun_tmp2.itemdiscamt,?cun_tmp2.srvamt,?cun_tmp2.taxamt,?cun_tmp2.rndamt,?cun_tmp2.invamt,"+;
		"?cun_tmp2.begintime,?cun_tmp2.paidtime,?cun_tmp2.member_name,?cun_tmp2.member_id,?cun_tmp2.void,?_Lreprint_noPay,?_link_table,"+;
		"?_mem_remark,?_inv_points,?_inv_Points_used,?_inv_points_remain,?_inv_remark,?_inv_remark2)"



	If _Lfastfood=.F. And _Lreprint_noPay=.F.	AND VARTYPE(_show_inv_problem)="U" &&¦pªG­«¦L³æ¡A¤£§ó§ïª¬ºA &&Lihong 2023.02.28 ¼W¥[AND ¡§U¡¨
		ssql=ssql+Chr(10)+"Update tables set status='P' where tableno=?_tableno and nsubtable=0"		&&ª¬ºAÅÜ¬°¤w¦L³æ(¤ÀÂi)
	Endif

&&¼Ð°O¬°°ÝÃDµo²¼

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	Endif

Endif


IF VARTYPE(_show_inv_problem)="U" AND VARTYPE(_preview_invoice)="U"	AND _Lreprint_noPay =.f. &&¦pªG¬OÅã¥Ü°ÝÃDµo²¼©Î¹wÄýµo²¼¡A¤£¶i¦æ°O¿ý

	ssql="insert into inv_reprint(inv_id,invamt,datetime,adduser,station) values (?_invID,?cun_tmp2.invamt,getdate(),?_login_user_name,?getcomputername())"	&& 2011 .04.11

	If _inv_reprint	 and vartype(__inv_reprint_save)#"U"  and __inv_reprint_save	&&­«¦Lµo²¼	

		ssql=ssql+Chr(10)+"insert into inv_reprint_main (pid,inv_Id,tableno,pplcnt,sendtime,username,station_id,langue,fastfood,training,tel,address,"+;
			"amount,discamt,itemdiscamt,srvamt,taxamt,rndamt,invamt,begintime,paidtime,member_name,member_no,void,reprint,link_table,remark,points,points_used,points_remain,inv_remark,inv_remark2)"+;
			" values (?_pid,?_invID,?_table_info,?cun_tmp2.pplcnt,?DATETIME(),?_login_user_name,?_station_id,?_clangue,?cun_tmp2.fastfood,?GL_training,?cun_tmp2.tel,?_addr,"+;
			"?cun_tmp2.amount,?cun_tmp2.discamt,?cun_tmp2.itemdiscamt,?cun_tmp2.srvamt,?cun_tmp2.taxamt,?cun_tmp2.rndamt,?cun_tmp2.invamt,"+;
			"?cun_tmp2.begintime,?cun_tmp2.paidtime,?cun_tmp2.member_name,?cun_tmp2.member_id,?cun_tmp2.void,?_Lreprint_noPay,?_link_table,"+;
			"?_inv_remark,?_inv_points,?_inv_Points_used,?_inv_points_remain,?_inv_remark,?_inv_remark2)"

	Endif

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	IF  vartype(__inv_reprint_save)#"U"   and __inv_reprint_save		&& 2016.02.26

		ssql="if exists (select inv_id from inv_problem where inv_id=?_invID) update inv_problem set reprint_times=reprint_times+1 where inv_id=?_invID "+;
			" else insert into inv_problem (inv_id,reprint_times) values (?_invID,1)"


		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1

		Endif

	ENDIF


ENDIF



If inv_detail_generate("INV",_invID,_Pid,_clangue,.T.,__inv_print_to_local,_inv_reprint,_void_id)<0			&&¥Í¦¨µo²¼²Ó¸`
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	Return -1

Endif


If Sqlcommit(nhand)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

SQLSetprop(nhand,"Transactions" ,1)

*	write_log(58,"tbl:"+_tableno+" inv:"+ALLTRIM(STR(_invID))+" Amt:"+ALLTRIM(STR(_inv_amt,10,2)))		&&°O¿ý¾Þ§@

If __inv_print_to_local		&&¦pªG¥»¦a¥´¦L¡Aª½°e

	IF __debug_mode
	
		frm_wait.Hide

	
	ENDIF
	


	IF  ALLTRIM(LOWER(__special_customer)) = "amuse"   AND VARTYPE(oMember_info)="U"
	
		
		_print_invoice2=.t.
		
	
	ENDIF
	
	IF VARTYPE(__print_invoice2)#"U" AND __print_invoice2
		_print_invoice2=.t.
	
	ENDIF
	
	inv_Local_print(_Pid,_printer,_clangue,(Vartype(_preview_invoice)#"U"),_inv_reprint )		&&ª½¦L¥»¦a¥´¦L¾÷

	Release _pub_fastfood_info, _print_invoice2

Endif

frm_wait.Hide

Return 1


Endfunc
******************************
*
Function inv_Local_print
*µo²¼¥»¦a¥´¦L

Parameters _cfilename,cprinter,clangue,_export_xff,lReprint,_export_xff2

If Vartype(clangue)#"C"
	clangue=_system_langue
Endif

IF LOWER(__special_customer)="bespoke"

	clangue="EN"

ENDIF

If __inv_print_to_local  &&AND lReprint=.f.		&&¥»¦a¦C¦L

	Select  * From  inv_print_main Into Cursor cun_tmp2

Else
	
	IF lReprint		&&Åã¥Ü­«¦L³æ ¤è¦¡ 2016.02.27

		ssql="select  * from  inv_reprint_main    where pid=?_cfilename"
	
	ELSE
	
		ssql="select  * from  inv_print_main    where pid=?_cfilename"
		
	ENDIF
	
	If SQLExec(nhand,ssql,"cun_tmp2")<0

		Aerror(err)

		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"sql error")

		_gbk_langue=.F.

		Return -1
	Endif




Endif

If Reccount("cun_tmp2")=0 AND VARTYPE(__inv_reprint_save)#"U" AND __inv_reprint_save
	write_log(57,"sql data error")

	_gbk_langue=.F.
	Return -1

Endif

Create Cursor print_job_tmp (r_id Int)
Append Blank
Replace r_id With 1		&&-->¥Î©óµo²¼
Append Blank
Replace r_id With 5	&&¤À±b
Append Blank
Replace r_id With 2		&&¥Î©ó§é¦©Åã¥Ü
Append Blank
Replace r_id With 3		&&-->¥Î©ó¨ú®øµæ¦¡
Append Blank
Replace r_id With 4		&&-->¥Î©óTAX2


Select cun_tmp2
PRIVATE _tableno
_tableno=Trim(cun_tmp2.tableno)			&&Âi¸¹/¥s¸¹
_inv_id=cun_tmp2.inv_Id												&&µo²¼¸¹½X
_printtime=cun_tmp2.sendtime		&&DATETIME()
_report_Training=GL_training										&&¬O§_°V½m¼Ò¦¡
cnotice=Iif(GL_training,getmessage("_training",clangue),"")
_link_table=Trim(Trim(cun_tmp2.link_table),",")							&&ÃöÁpÂi

_clink_table=Iif(Empty(_link_table),"","("+_tableno+"-"+Strtran(_link_table,',','/')+")")

_inv_remark=Iif(Isnull(cun_tmp2.remark),"",Trim(cun_tmp2.remark))

_inv_remark2= Trim(Nvl(cun_tmp2.inv_remark,""))
_inv_remark3= Trim(Nvl(cun_tmp2.inv_remark2,""))

*MESSAGEBOX(_inv_remark2)

_askno=""
IF __special_customer="sauna"

	IF SQLEXEC(nhand,"select askno,tableno from inv where id=?_inv_id","cun_tmp")<0
	
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		_gbk_langue=.F.

		Return -1	
	
	ENDIF
	_tableno = TRIM(cun_tmp.tableno)
	_askno = TRIM(NVL(cun_tmp.askno,""))		&& 2020.04.13 david  sauna ÃD¸¹

ENDIF


If Vartype(__member_point_enabled)#"U" And __member_point_enabled

	_inv_points=Iif(Isnull(cun_tmp2.points),0,cun_tmp2.points)
	_inv_points_used=Iif(Isnull(cun_tmp2.points_used),0,cun_tmp2.points_used*-1)

	_member_points_remain=Iif(Isnull(cun_tmp2.points_remain),0,cun_tmp2.points_remain)

Else
	_inv_points=0
	_inv_points_used=0

	_member_points_remain=0

Endif



If SQLExec(nhand,"select member_number from inv_disc with (nolock) where id=?_inv_id  and member_number<>'' ","cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif


If !Eof("cun_tmp")

	_memb_disc_info=getmessage("_cardno",clangue)+":"+Trim(cun_tmp.member_number )				&&·|­û

Else

	If !Empty(cun_tmp2.member_name)
		_memb_disc_info=getmessage("_member",clangue)+":"+Trim(cun_tmp2.member_name)	+" / " +getmessage("_cardno",clangue)+":"+Trim(cun_tmp2.member_no)				&&·|­û

	Else


		_memb_disc_info=""

	Endif


Endif


IF  (VARTYPE(__crm_app_active)#"U" AND __crm_app_active)  OR  (VARTYPE(__pso_web_so)#"U" AND __pso_web_so)
	_tableno_tmp = _tableno 
	IF "<" $ _tableno AND ">" $ _tableno
		_tableno_tmp = LEFT(_tableno, AT("<", _tableno)-1)
	ENDIF 
	IF SQLEXEC(nhand,"select order_id,check_valid  from tables with(nolock)  where tableno=?_tableno_tmp and nsubtable=0","cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1	
	
	
	ENDIF
	
	_order_id=cun_tmp.order_id
	_check_valid=TRIM(NVL(cun_tmp.check_valid,""))

ENDIF



IF __member_printer_installed AND VARTYPE(oMember_info)="U" AND !EMPTY(TRIM(cun_tmp.member_number))		&& ¥ý¹F·|­û¥d


	oMember_info=get_membercard_info(TRIM(cun_tmp.member_number))


ENDIF


IF VARTYPE(oMember_info)="O"

	_inv_points=oMember_info.EarnPoint
	_inv_points_used=oMember_info.EarnPoint
	_member_points_remain=oMember_info.bonus
	
	_member_value = oMember_info.value
	_member_remark =oMember_info.remark
	
	_member_name = oMember_info.name_cn
	
	_memb_disc_info=getmessage("_member",clangue)+":" +oMember_info.member_number
	

ELSE



	_member_remark =""
	_member_name =""
	_member_value =""

ENDIF

RELEASE oMember_info


Local _isfastfood

_isfastfood=cun_tmp2.fastfood

_fastfood_tel=Trim(cun_tmp2.tel)							&&¥~½æ¼Ò¦¡¤Uªº¹q¸Ü/¦a§}
_fastfood_addr=Trim(cun_tmp2.address)



_belongdate=getbelongdate()

ssql="select * from holi where pbegdate<=?_belongdate and penddate>=?_belongdate"
If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@

	write_log(57,"sql error")

	Return -1

Endif


If Eof("cun_tmp")
	_holidaymsg1=""							&&¤½²³°²´Á«H®§
	_holidaymsg2=""
	_holidaymsg3=""

Else
	If (_isfastfood And __inv_fastfood_print_holi_rem) Or (_isfastfood=.F. And __inv_dine_print_holi_remark )	&&§ÖÀ\/°ó®y¬O§_¦C¦L¤½²³°²´Á«H®§

		_holidaymsg1=Iif(clangue="CN",Trim(chi_mess1),Trim(en_mess1))	&&¤½²³°²´Á«H®§
		_holidaymsg2=Iif(clangue="CN",Trim(chi_mess2),Trim(en_mess2))
		_holidaymsg3=Iif(clangue="CN",Trim(chi_mess3),Trim(en_mess3))

	Else
		_holidaymsg1=""							&&¤½²³°²´Á«H®§
		_holidaymsg2=""
		_holidaymsg3=""
	Endif

Endif

_nprint=0




*!*	IF VARTYPE(_saichuen_add_times) = "U"
*!*		PUBLIC _saichuen_add_times
*!*		_saichuen_add_times = .f.
*!*	ENDIF 

*!*	OR _saichuen_add_times = .t. &&µo²¼¥´¦L¦¸¼Æ
	

*chris2

*SET STEP ON 
*If ! (cun_tmp2.reprint	Or _isfastfood ) &&µo²¼¥´¦L¦¸¼Æ

	ssql="select COUNT(inv_id) as nprint  from inv_reprint   where inv_id=?_inv_id"

	If SQLExec(nhand,ssql,"inv_cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@

		Return -1

	Endif

	_nprint=inv_cun_tmp.nprint					&&¥´¦L¦¸¼Æ


*Endif


_cusername=_login_user_name					&&Àç·~­û

_lbtableNo_ppl=Iif(_isfastfood,getmessage("_askno_ppl",clangue),getmessage("_table_no_ppl",clangue))	&&Âi¸¹(¥s¸¹) /¤H¼Æ

_lbinvno=getmessage("_invno",clangue)			&&µo²¼¸¹½X

_lbusername=getmessage("_user_name",clangue)		&&Àç·~­û

_lbseattime=getmessage("_seattime",clangue)		&&¤J®y®É¶¡
_lbprinttime=getmessage("_printtime",clangue)		&&µ²±b®É¶¡

_lbitem=getmessage("_invitem",clangue)
_lbqty=getmessage("_qty",clangue)
_lbamt=getmessage("_amount",clangue)

_lbsubtotalamt=getmessage("_subtotalamt",clangue)	&&¤p­p
_lbdiscount=getmessage("_discount",clangue)		&&§é¦©
_lbServiceFee=getmessage("_svr_charge",clangue)	&&ªA°È¶O

_lbtaxfee=getmessage("_taxfee",clangue)		&&µ|¶µ


_lbxdisc=getmessage("_xdisc",clangue)		&&²Õ¦XÀu´f
_lbadjust=getmessage("_rounding",clangue)		&&·L½Õ
_lbtotalamt=getmessage("_totalamt",clangue)	&&Á`ª÷ÃB
_lbamtperhead=Iif(__print_perhead,getmessage("_amtperhead",clangue),"")		&&¤H§¡®ø¶O

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
_lbpayments=getmessage("_payments",clangue) &&À³¥I´Ú Payments
_lbdeposit_apply=getmessage("_deposit_apply",clangue) &&­qª÷©è¥I Deposit Apply
_lbremaining_balance=getmessage("_deposit_remain",clangue) &&³Ñ¾lÀ³¥I Remaining Balance


_lbSubscriber=getmessage("_scriber",clangue)	&&Ã±¸p

_lbdepartment=getmessage("_department",clangue)		&&³¡ªù

_lbTotal=getmessage("_total",clangue)					&&¦X­p	_cfilename=Upper(Trim(inv_print_tmp1.pid))						&&¥´¦LÃÑ§O¦WºÙ

_lbvoiditem=getmessage("_void_item",clangue)			&&¨ú®øµæ¦¡

_lbTaxList=getmessage("_tax_list",clangue)

_def_printer=cprinter							&&¥´¦L§@·~ªº­ì©w¥´¦L¾÷
_change_station=.F.

_from_printer=""



_lbpoints=getmessage("_points",clangue)		&&¿n¤À
_lbpoints_pay=getmessage("_point_used",clangue)	&&¿n¤À´«ÁÊ
_lbpoints_remain=getmessage("_points_remain",clangue)	&&¿n¤Àµ²¦s

*--------------------- octopus   update  2009.04.29
*_lbOctpayment=getmessage("_octopus_payment")		&&¤K¹F³q¥I´Ú
_lbOctremain=getmessage("_octopus_remain_value",clangue)			&&¤K¹F³q§EÃB
_lbOctCardID=getmessage("_octopus_card_id",clangue)		&&¤K¹F³q¥d¸¹
_lbOctDviceID=getmessage("_octopus_device_id",clangue)		&&¤K¹F³q¦¬¶O¾¹½s¸¹

_lbmember_name= getmessage("_member_name") &&·|­û¦WºÙ
_lbCard_remain =getmessage("_membercard_remin")	&&·|­û¥d§EÃB
_lbmember_remark=getmessage("_remark")	&&³Æª`


If _isfastfood

	_octremain=Iif(Vartype(_oct_remain)="U",0,_oct_remain)
	_octpayamt=Iif(Vartype(_octpayamt)="U",0,_octpayamt)

	_octCid=Iif(Vartype(_oct_cid)="U","",_oct_cid)
	_octDID=Iif(Vartype(_oct_did)="U","",_oct_did)

ELSE

	_octpayamt=0
	_octremain=0
	_octCid=""
	_octDID=""

Endif

*----------------------<<<



&&¥H¤U±q¨t²Î³]©w¤¤¨ú¼Æ¾Ú,¤£¦P¤u§@¥i¥H¦³¤£¦Pªº³]©w


_cRePrnInvDontPay=Iif(cun_tmp2.reprint,getmessage("_reprint_inv_dntpay",clangue),"")		&&­«¦L³æ,½Ð¤Å¥I´Ú(«H®§)

_inv_header=__company_name


_inv_header1=Iif(clangue="CN",__inv_header1_cn,__inv_header1_en)		&&µo²¼ÀY  1--4
_inv_header2=Iif(clangue="CN",__inv_header2_cn,__inv_header2_en)
_inv_header3=Iif(clangue="CN",__inv_header3_cn,__inv_header3_en)
_inv_header4=Iif(clangue="CN",__inv_header4_cn,__inv_header4_en)



If _isfastfood And __inv_fastfood_print_remark=.F.					&&§ÖÀ\¼Ò¦¡¬O§_¦C¦L³Æª`
	_invtail1=""
	_invtail2=""
	_invtail3=""
	_invtail4=""

Else

	_invtail1=Iif(clangue="CN",__Inv_footer1_cn,__Inv_footer1_en)		&&µo²¼³Æª`«H®§ 1-4
	_invtail2=Iif(clangue="CN",__Inv_footer2_cn,__Inv_footer2_en)
	_invtail3=Iif(clangue="CN",__Inv_footer3_cn,__Inv_footer3_en)
	_invtail4=Iif(clangue="CN",__Inv_footer4_cn,__Inv_footer4_en)

Endif


If _gbk_langue		&&Â²Åé

	_inv_header=getGBKtxt(_inv_header)
	_inv_header1=getGBKtxt(_inv_header1)
	_inv_header2=getGBKtxt(_inv_header2)
	_inv_header3=getGBKtxt(_inv_header3)
	_inv_header4=getGBKtxt(_inv_header4)

	_invtail1=getGBKtxt(_invtail1)
	_invtail2=getGBKtxt(_invtail2)
	_invtail3=getGBKtxt(_invtail3)
	_invtail4=getGBKtxt(_invtail4)



Endif


If Vartype(_pub_fastfood_info)="C"

	_ctableno_ppl=Alltrim(cun_tmp2.tableno)+" / "+Iif(_gbk_langue,getGBKtxt(_pub_fastfood_info),_pub_fastfood_info)

Else

	_ctableno_ppl=Alltrim(cun_tmp2.tableno)+" / "+Alltrim(Str(cun_tmp2.pplcnt))+" "+getmessage("_Cover",clangue)				&&À\Âi(¥s¸¹)/¤H¼Æ (¦ì)

Endif

_cpplcnt=Alltrim(Str(cun_tmp2.pplcnt))



IF UPPER(__special_customer)="LUBUDS"

_cinvno=Iif(_inv_id<=9999999999,Replicate("0",10-Len(Alltrim(Str(_inv_id))))+Alltrim(Str(_inv_id)),Alltrim(Str(_inv_id)))

ELSE


_cinvno=Iif(_inv_id<=9999999999,Replicate("0",10-Len(Alltrim(Str(_inv_id))))+Alltrim(Str(_inv_id)),Alltrim(Str(_inv_id))) + ;
	Iif(_nprint<1,""," /"+Alltrim(Str(_nprint)))	&&µo²¼¸¹½X(¤Î¥´¦L¦¸¼Æ)

ENDIF



_subtotalamt=cun_tmp2.amount+cun_tmp2.itemdiscamt		&&¤p­p
_discount=  cun_tmp2.discamt							&&¾ã³æ§é¦©


_cseattime=cun_tmp2.begintime						&&¤J®y®É¶¡
_cprinttime=Iif(Year(cun_tmp2.paidtime)>2000,cun_tmp2.paidtime,Datetime())						&&µ²±b®É¶¡
_servicefee=cun_tmp2.srvamt							&&ªA°È¶O


_taxfee=cun_tmp2.taxamt								&&µ|¶µ

_xdisc=0											&&²Õ¦XÀu´f									**(unfinish)
_adjust=cun_tmp2.rndamt								&&¹sÀY

_totalamt=cun_tmp2.invamt							&&¦X­pª÷ÃB

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
IF SQLEXEC(nhand,"select deposit.amount,inv.invamt,inv.paidtime from deposit with (nolock) right join inv (nolock) on deposit.id=inv.deposit_id where inv.id=?_inv_id","deposit_tmp")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	_gbk_langue=.F.

	Return -1	
ENDIF
*IF !EMPTY(FIELD("deposit_amt","cun_tmp2"))
	_deposit_apply = NVL(deposit_tmp.amount,0)
	_remaining_balance = _totalamt - _deposit_apply
	_inv_forfeiture = (_totalamt=NVL(deposit_tmp.invamt,0) and YEAR(deposit_tmp.paidtime)>2000)
	IF _deposit_apply<>0 and _remaining_balance<0 AND _inv_forfeiture=.F.
		_totalamt = _totalamt + ABS(_remaining_balance)
		_subTotalAmt = _subTotalAmt + ABS(_remaining_balance)
	ENDIF 
*ENDIF 
USE IN SELECT("deposit_tmp")


_amtperhead=Iif(__print_perhead,Alltrim(Str(_totalamt/cun_tmp2.pplcnt,10,2)),"")	&&¤H§¡®ø¶O


_deleted_invoice=Iif(cun_tmp2.void,getmessage("_deleted_invoice",clangue),"")				&&¤w§R°£µo²¼


_cardno=Trim(cun_tmp2.member_no)

_discdesc=""



If __inv_print_to_local 


	Select *,0 As rid From  inv_print_detail Into Cursor inv_cun_tmp Readwrite

Else
	
	IF lReprint AND __inv_reprint_save
		ssql="select *,0 as rid from  inv_reprint_detail where pid=?_cfilename order by id"
	
	ELSE
	

		ssql="select *,0 as rid from  inv_print_detail where pid=?_cfilename order by id"
		
	ENDIF
	
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@
		Return -1

	Endif

	Select * From cun_tmp Into Cursor inv_cun_tmp Readwrite

Endif


If _gbk_langue And Used("message_gb_tmp")			&&Âà´«¬°GBK½X

	Select inv_cun_tmp
	Scan
		cstr=Trim(inv_cun_tmp.Item)
		Big5ToGB(@cstr)
		Select inv_cun_tmp
		Replace Item With cstr

	Endscan


Endif

*----------------------------------------------------
If Vartype(__inv_print_to_a4inv)#"U" And __inv_print_to_a4inv

	Create Cursor cr_A4inv (Id i,Date T,net_amt N(12,2),cardno c(50),company c(50),name_cn c(50), name_en c(50),tel c(50),add1 c(100),add2 c(100),add3 c(100),rem c(250))
	Create Cursor cr_A4inv_detail (Code c(10),desccn c(50),qty N(12,2),price N(12,2),weight c(50),net_amt N(12,2))

	If SQLExec(nhand,"select pay_id,payway,payamt,netamt,changes,tips,dispord from pay_detail where id=?_inv_id order by dispord","cr_A4inv_payway")<0

		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@
		Return -1


	Endif

	If SQLExec(nhand,"select a.same_tableno,a.item_code,a.descdisp,a.qty,a.price,a.real_amount,b.kilo,b.kilo2  from inv_detail a left join item b on a.item_code=b.code  where a.id=?_inv_Id order by a.uid","inv_cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@
		Return -1


	Endif

	Select inv_cun_tmp		&&¥Í¦¨ITEM²Ó¸`
	Scan


		If inv_cun_tmp.kilo And inv_cun_tmp.qty>0

			Local lnQty
			lnQty=inv_cun_tmp.qty

			If Vartype( __kilo_unit)#"U" And __kilo_unit="K10"		&&¤Q¶i¨î

				cKilo	=Iif(Int(lnQty/10)>0 ,Alltrim(Str(Int(lnQty/10)))+getmessage("_kilo"),"")+;
					IIF(Mod(lnQty,10)>0,Alltrim(Str(Mod(lnQty,10)))+getmessage("_kilo2"),"")


			Else		&&¹w³]¬°¤Q¤»¶i¨î
			
				
			

				cKilo	=Iif(Int(lnQty/16)>0 ,Alltrim(Str(Int(lnQty/16)))+getmessage("_kilo"),"")+;
					IIF(Mod(lnQty,16)>0,Alltrim(Str(Mod(lnQty,16)))+getmessage("_kilo2"),"")

			Endif


		Else
			cKilo=""
		Endif


		Insert Into cr_A4inv_detail (Code,desccn,qty,price,weight,net_amt) ;
			VALUES (inv_cun_tmp.item_code,inv_cun_tmp.descdisp,Iif(inv_cun_tmp.kilo,0,inv_cun_tmp.qty),inv_cun_tmp.price,cKilo,inv_cun_tmp.real_amount)


	Endscan



	If Empty(_cardno)

		_member_name_cn=""
		_member_name_en=""
		_member_tel=""
		_member_add1=""
		_member_add2=""
		_member_add3=""
		_member_rem=""
		_member_company=""

	Else

		If SQLExec(nhand,"select * from member where cardno=?_cardno","inv_cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@
			Return -1

		Endif

		_member_name_cn=Nvl(inv_cun_tmp.name_cn,"")
		_member_name_en=Nvl(inv_cun_tmp.name_en,"")
		_member_tel=Nvl(inv_cun_tmp.tel,"")
		_member_add1=Nvl(inv_cun_tmp.add1,"")
		_member_add2=Nvl(inv_cun_tmp.add2,"")
		_member_add3=Nvl(inv_cun_tmp.add3,"")
		_member_rem=Nvl(inv_cun_tmp.rem,"")
		_member_company=Nvl(inv_cun_tmp.company,"")


	Endif


	Insert Into cr_A4inv(;
		id,;
		date,;
		net_amt,;
		cardno,;
		company,;
		name_cn,;
		name_en,;
		tel,;
		add1,;
		add2,;
		add3,;
		rem;
		) Values (;
		_inv_id,;
		_cprinttime,;
		_totalamt,;
		_cardno,;
		_member_company,;
		_member_name_cn,;
		_member_name_en,;
		_member_tel,;
		_member_add1,;
		_member_add2,;
		_member_add3,;
		_member_rem;
		)


	inv_Print_to_a4()

	Return


Endif

*----------------------------------------------------
&&Lihong 2021.04.01 ­tª÷ÃB·í¹w¥Iª÷
*!*	IF Vartype(__neg_amt_as_deposit)#"U" And __neg_amt_as_deposit
*!*		SELECT item, amt, SUM(VAL(qty)) as qty FROM inv_cun_tmp WHERE amt < 0 GROUP BY item,amt INTO CURSOR cun_tmp 
*!*		SELECT a.item, a.amt, MAX(a.qty) as qty, SUM(VAL(NVL(b.qty, ""))) as b_qty  FROM cun_tmp a LEFT JOIN inv_cun_tmp b ON a.item == b.item AND a.amt = -b.amt ;
*!*		GROUP BY a.item, a.amt INTO CURSOR cun_tmp 
*!*		*WHERE b.sitem=.F. 
*!*		
*!*		*a.sitem=.F. AND a.sitem=.F. AND 
*!*		SELECT SUM(-a.amt) as amt from inv_cun_tmp a left join cun_tmp b on a.item == b.item AND a.amt = -b.amt where NOT ISNULL(b.item) AND b.qty = b.b_qty INTO CURSOR cun_tmp1 
*!*		IF cun_tmp1. amt <> 0
*!*			_totalAmt_depoist = cun_tmp1. amt + _totalAmt
*!*			DELETE a from inv_cun_tmp a left join cun_tmp b on a.item == b.item AND a.amt = -b.amt where NOT ISNULL(b.item) AND b.qty = b.b_qty 
*!*		ENDIF 
*!*		USE IN SELECT("cun_tmp1")
*!*	ENDIF 
IF Vartype(__neg_amt_as_deposit)#"U" And __neg_amt_as_deposit 
	SELECT SUM(amt) as amt FROM inv_cun_tmp WHERE amt < 0 INTO CURSOR cun_tmp 
	IF cun_tmp. amt<>0
		SELECT SUM(amt) as amt FROM inv_cun_tmp INTO CURSOR cun_tmp 
		_totalAmt_depoist = cun_tmp. amt - cun_tmp2.amount + _totalamt 
	ENDIF 
ENDIF

Select * From inv_cun_tmp Into  Cursor inv_detail_tmp

Create Cursor inv_print_tmp (r_id Int,same_tableno C(8),Item c(120),qty c(10),amt N(12,2),Free L,item_unicode c(100),printtime c(20),adduser c(20),points c(50),price N(8,2),srv_per n(6,2),srv_amount n(12,2) )		&&µo²¼¶µ¥ØÁ{®Éªí
Index On r_id Tag inv

*SET STEP ON 

Local cpoints

cpoints=getmessage("_point_used",clangue)+":"

Select inv_detail_tmp
Scan
	Insert Into inv_print_tmp (r_id,same_tableno,Item,qty,amt,Free,item_unicode,printtime,adduser,points);
		VALUES (1,NVL(inv_detail_tmp.same_tableno,""),inv_detail_tmp.Item,inv_detail_tmp.qty,inv_detail_tmp.amt,inv_detail_tmp.Free,inv_detail_tmp.item_unicode,;
		IIF(Isnull(inv_detail_tmp.printtime),"",inv_detail_tmp.printtime),Iif(Isnull(inv_detail_tmp.adduser),"",inv_detail_tmp.adduser),;
		IIF(Isnull(inv_detail_tmp.points) Or inv_detail_tmp.points=0 ,"",cpoints+Alltrim(Str(inv_detail_tmp.points))) )

Endscan

IF _deposit_apply<>0 and _remaining_balance<0 AND _inv_forfeiture=.F.
	*inv_mult_item(clangue,-7,1,ABS(_remaining_balance),"INV",.F.) &&inv_print_tmp
	SELECT work_order_tmp0 
	LOCATE FOR Id=-7
	IF clangue="CN"
		_lcdeposit_desc = TRIM(work_order_tmp0.descinvcn)
	ELSE
		_lcdeposit_desc = TRIM(work_order_tmp0.descinven)
	ENDIF 
	&&Iif(Mod(inv_item_tmp.qty,1)>0,Alltrim(Str(inv_item_tmp.qty,10,2)),Alltrim(Str(inv_item_tmp.qty,10,0)))
	Insert Into inv_print_tmp (r_id,same_tableno,Item,qty,amt,Free,item_unicode,printtime,adduser,points);
		VALUES (1,"",_lcdeposit_desc,Alltrim(Str(1,10,0)),ABS(_remaining_balance),.F.,"","","","" )
		_remaining_balance = 0
ENDIF 

IF VAL(__mult_langue_code)<1000

	Update inv_print_tmp Set  item_unicode= Strconv(Strconv(Trim(item_unicode),14),11,Val(__mult_langue_code),1)	Where !Empty(item_unicode) &&Âà¬°DBCS
ENDIF


cItem=getmessage("_invitem")				&&¶µ¥Ø
ctotal=getmessage("_total")		

_total_item=ctotal+" "+Alltrim(Str( RECCOUNT("inv_print_tmp")))+" "+cItem		&&¦@:N¶µ¥Ø



_lbTotal=""
_total_qty=0.00
_total_amt=0.00

Create Cursor inv_disc_tmp (r_id Int,descdisp c(100),amt N(12,2),points c(50))			&&¾ã³æ§é¦©
Index On r_id Tag xdisc

If __inv_print_to_local  &&AND lReprint=.f.

	Select * From inv_print_disc Into Cursor inv_cun_tmp

Else

	IF lReprint AND __inv_reprint_save

		ssql="select * from inv_reprint_disc    where pid=?_cfilename"

	ELSE
	
		ssql="select * from inv_print_disc    where pid=?_cfilename"
	ENDIF
	

	If SQLExec(nhand,ssql,"inv_cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@

		Return -1
	Endif


Endif


If !Eof("inv_cun_tmp")

	Select inv_cun_tmp
	Scan

		Insert Into inv_disc_tmp (r_id,descdisp,amt,points) Values ;
			(2,Iif(_gbk_langue,getGBKtxt(Trim(inv_cun_tmp.descdisp)),Trim(inv_cun_tmp.descdisp)),inv_cun_tmp.amt,;
			IIF(Isnull(inv_cun_tmp.points) Or inv_cun_tmp.points=0,"",cpoints+Alltrim(Str(inv_cun_tmp.points*-1))) )

	Endscan

Endif

Update inv_disc_tmp Set amt=amt*-1


Create Cursor inv_void_tmp (r_id Int,same_tableno C(8),descdisp c(150),qty c(10), amt N(12,2))			&&¨ú®øµæ¦¡
Index On r_id Tag void

Local _inv_Print_void_item

If Vartype(__inv_print_void_item)="U"			&&µo²¼¬O§_¦C¦L¨ú®øµæ¦¡

	_inv_Print_void_item=.T.
Else
	_inv_Print_void_item=__inv_print_void_item

Endif

If _inv_Print_void_item

	If __inv_print_to_local  &&AND lReprint=.f.

		Select * From inv_print_void  Into Cursor inv_cun_tmp


	Else

		IF lReprint AND __inv_reprint_save
		
			ssql="select * from inv_reprint_void    where pid=?_cfilename"
		
		ELSE
		
			ssql="select * from inv_print_void    where pid=?_cfilename"
		ENDIF
		

		If SQLExec(nhand,ssql,"inv_cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@

			Return -1
		Endif

	Endif


	Local _cqty

	If !Eof("inv_cun_tmp")
		Select inv_cun_tmp
		Scan
			_cqty=Iif(Mod(inv_cun_tmp.qty,1)>0,Alltrim(Str(inv_cun_tmp.qty,10,2)),Alltrim(Str(inv_cun_tmp.qty,10,0)))
			Insert Into inv_void_tmp (r_id,same_tableno,descdisp,qty,amt) Values (3,NVL(inv_cun_tmp.same_tableno,""),Iif(_gbk_langue,getGBKtxt(Trim(inv_cun_tmp.descdisp)),Trim(inv_cun_tmp.descdisp)),_cqty,inv_cun_tmp.amt)

		Endscan

	Endif

Endif

*-----------tax2

Create Cursor inv_tax_tmp (r_id Int,descdisp c(100), amt N(12,2))			&&  TAX2 for  HOLLAND TAX
Index On r_id Tag tax


If __inv_print_to_local  &&AND lReprint=.f.

	Select * From inv_print_tax Into Cursor inv_cun_tmp


Else

	IF lReprint AND __inv_reprint_save
		ssql="select * from inv_reprint_tax    where pid=?_cfilename"

	ELSE
	
		ssql="select * from inv_print_tax    where pid=?_cfilename"
	ENDIF
	

	If SQLExec(nhand,ssql,"inv_cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->sql error")		&&°O¿ý¾Þ§@

		Return -1
	Endif

Endif

_taxTotalAmt=0.00

If !Eof("inv_cun_tmp")
	Select inv_cun_tmp
	Scan
		Insert Into inv_tax_tmp (r_id,descdisp,amt) Values (4,Iif(_gbk_langue,getGBKtxt(Trim(inv_cun_tmp.descdisp)),Trim(inv_cun_tmp.descdisp)),inv_cun_tmp.amt)


	Endscan
	Select inv_tax_tmp
	Sum amt  To _taxTotalAmt
Endif


* tax2010
If Vartype(__canada_tax_print)#"U" And __canada_tax_print

	_lbtaxfee=""
	_taxfee=""
	Select inv_tax_tmp
	Go Top

	Scan
		_lbtaxfee=_lbtaxfee+Alltrim(inv_tax_tmp.descdisp)+Chr(13)
		_taxfee=_taxfee+Alltrim(Str(inv_tax_tmp.amt,12,2))+Chr(13)

	Endscan



Else
*	_taxfee=IIF(_taxfee=0,"",tran(_taxfee,"99,999,999.99")


Endif


*************************
qrcode_file=""

IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active	&&¥Í¦¨QRCODE 


		lcQRcode = getQrcode_string(_tableno)

*!*		lcQRcode = "rms#"+allt(STR(__crm_shop_id))+"#"+_tableno+"#"+ALLTRIM(STR(_Inv_id))+"#"+ALLTRIM(STR(_order_id))+"#"+DTOS(DATETIME())
*!*		lcQRcode = Encrypt_string(lcQRcode)
	*_cliptext=lcQrcode
	
*!*		SET CLASSLIB TO "class\qrcode.vcx" ADDITIVE
*!*		oQRcode=CREATEOBJECT("qrcode")	
*!*		oQRcode.data =lcQRcode
*!*		QRcode_file= FULLPATH(SYS(2015)+".bmp")
*!*		oQRcode.buildqrcode(QRcode_file)	&&¥Í¦¨QRCODE IMAGE

	QRcode_file= FULLPATH(SYS(2015)+".bmp")
		
	 Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
				STRING code,;
				STRING sFileName,;
				INTEGER width, ;
				INTEGER height	
	

	IF GetQrCode_rms(lcQRcode , QRcode_file, 300, 300)<>1
	
		QRcode_file=""
	
	ENDIF
	

ENDIF

&&Lihong 2023.05.23 QRcode_file_inv
QRcode_file_inv = ""
IF VARTYPE(__inv_prt_qrcode_format)#"U" AND !EMPTY(__inv_prt_qrcode_format)	&&¥Í¦¨QRCODE 
	lcQRcode = __inv_prt_qrcode_format

	*{inv_no}{inv_qty}{inv_amt}{inv_paidtime}{inv_belongdate}
	TEXT TO ssql TEXTMERGE NOSHOW 
	select invamt,qty=(select SUM(qty) as qty from inv_detail where id=?_inv_id and item_id<>-3 and item_id<>0),belongdate as belongdate_org,paidtime as paidtime_org,
	<<IIF(VARTYPE(__inv_prt_qrcode_date_format)#"U" AND !EMPTY(__inv_prt_qrcode_date_format), "format(belongdate, ?__inv_prt_qrcode_date_format) as belongdate","belongdate")>>,
	<<IIF(VARTYPE(__inv_prt_qrcode_datetime_format)#"U" AND !EMPTY(__inv_prt_qrcode_datetime_format), "format(paidtime, ?__inv_prt_qrcode_datetime_format) as paidtime","paidtime")>>,
	begintime as begintime_org, <<IIF(VARTYPE(__inv_prt_qrcode_datetime_format)#"U" AND !EMPTY(__inv_prt_qrcode_datetime_format), "format(begintime, ?__inv_prt_qrcode_datetime_format) as begintime","begintime")>>,
	<<IIF(VARTYPE(__inv_prt_qrcode_datetime_format)#"U" AND !EMPTY(__inv_prt_qrcode_datetime_format), "format(getdate(), ?__inv_prt_qrcode_datetime_format) as printtime","getdate() as printtime")>>,
	<<IIF(VARTYPE(__inv_prt_qrcode_date_format)#"U" AND !EMPTY(__inv_prt_qrcode_date_format), "format(getdate(), ?__inv_prt_qrcode_date_format) as printdate","getdate() as printdate")>> 
	 from inv where id=?_inv_id
	ENDTEXT 
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->inv_prt_qrcode_date_format sql error")		&&°O¿ý¾Þ§@
		Return -1
	ENDIF
	IF RECCOUNT("cun_tmp")=0
		TEXT TO ssql TEXTMERGE NOSHOW 
		select invamt,qty=(select SUM(qty) as qty from inv_detail_view where id=?_inv_id and item_id<>-3 and item_id<>0),belongdate as belongdate_org,paidtime as paidtime_org,
		<<IIF(VARTYPE(__inv_prt_qrcode_date_format)#"U" AND !EMPTY(__inv_prt_qrcode_date_format), "format(belongdate, ?__inv_prt_qrcode_date_format) as belongdate","belongdate")>>,
		<<IIF(VARTYPE(__inv_prt_qrcode_datetime_format)#"U" AND !EMPTY(__inv_prt_qrcode_datetime_format), "format(paidtime, ?__inv_prt_qrcode_datetime_format) as paidtime","paidtime")>>,
		begintime as begintime_org, <<IIF(VARTYPE(__inv_prt_qrcode_datetime_format)#"U" AND !EMPTY(__inv_prt_qrcode_datetime_format), "format(begintime, ?__inv_prt_qrcode_datetime_format) as begintime","begintime")>>,
		<<IIF(VARTYPE(__inv_prt_qrcode_datetime_format)#"U" AND !EMPTY(__inv_prt_qrcode_datetime_format), "format(getdate(), ?__inv_prt_qrcode_datetime_format) as printtime","getdate() as printtime")>>,
		<<IIF(VARTYPE(__inv_prt_qrcode_date_format)#"U" AND !EMPTY(__inv_prt_qrcode_date_format), "format(getdate(), ?__inv_prt_qrcode_date_format) as printdate","getdate() as printdate")>> 
		 from inv_view where id=?_inv_id
		ENDTEXT 
		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->inv_prt_qrcode_date_format sql error")		&&°O¿ý¾Þ§@
			Return -1
		ENDIF
	ENDIF 
 
	PRIVATE inv_no, inv_qty, inv_amt, inv_paidtime, inv_belongdate, inv_begintime, inv_printtime
	inv_no = TRANSFORM(_inv_id)
	inv_qty = TRANSFORM(NVL(cun_tmp.qty,0))
	inv_amt = IIF(VARTYPE(__inv_prt_qrcode_amt_x100)#"U" and __inv_prt_qrcode_amt_x100, TRANSFORM(FLOOR(NVL(cun_tmp.invamt,0)*100)), allt(TRANSFORM(NVL(cun_tmp.invamt,0),"999,999,999.99")) ) 
	inv_belongdate=Iif(Year(cun_tmp.belongdate_org)>2000, IIF(VARTYPE(__inv_prt_qrcode_date_format)="U" OR EMPTY(__inv_prt_qrcode_date_format), DTOC(cun_tmp.belongdate_org), TRIM(STRCONV(cun_tmp.belongdate, 6))), "")  
	inv_paidtime=Iif(Year(cun_tmp.paidtime_org)>2000, IIF(VARTYPE(__inv_prt_qrcode_datetime_format)="U" OR EMPTY(__inv_prt_qrcode_datetime_format), TTOC(cun_tmp.paidtime_org), TRIM(STRCONV(cun_tmp.paidtime, 6))), "") 
	inv_begintime=Iif(Year(cun_tmp.begintime_org)>2000, IIF(VARTYPE(__inv_prt_qrcode_datetime_format)="U" OR EMPTY(__inv_prt_qrcode_datetime_format), TTOC(cun_tmp.begintime_org), TRIM(STRCONV(cun_tmp.begintime, 6))), "") 
	inv_printtime=IIF(VARTYPE(__inv_prt_qrcode_datetime_format)="U" OR EMPTY(__inv_prt_qrcode_datetime_format), TTOC(cun_tmp.printtime), TRIM(STRCONV(cun_tmp.printtime, 6)))
	IF Year(cun_tmp.belongdate_org)<=2000
		inv_belongdate=IIF(VARTYPE(__inv_prt_qrcode_date_format)="U" OR EMPTY(__inv_prt_qrcode_date_format), DTOC(cun_tmp.printdate), TRIM(STRCONV(cun_tmp.printdate, 6)))
	ENDIF 
	
	TRY 
		lcQRcode = TEXTMERGE(lcQRcode, .F., "{", "}")
	CATCH 
		lcQRcode = ""
	ENDTRY 

	IF !EMPTY(lcQRcode)
		QRcode_file_inv= FULLPATH(SYS(2015)+".bmp")
			
		 Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
					STRING code,;
					STRING sFileName,;
					INTEGER width, ;
					INTEGER height	
		
		IF GetQrCode_rms(lcQRcode , QRcode_file_inv, 300, 300)<>1 
			QRcode_file_inv=""
		ENDIF
*!*			IF !FILE(QRcode_file_inv)
*!*				QRcode_file_inv=""
*!*			ENDIF 
	ENDIF 
ENDIF


_image=Sys(5)+Sys(2003)+"\ico\invlogo.bmp"
If !File(_image)
	_image=""
Endif

_cfilename=Sys(2015)+ALLTRIM(TRANSFORM(INT(RAND()*10000000)))
_frx_file=_cfilename+".frx"
_frt_file=_cfilename+".frt"


Do Case

	
	CASE LOWER(__special_customer) = "bespoke"		&& special customer = 
	
		Copy File Report\invoice_bespoke.frx To &_frx_file		&&´_¨î³øªí(
		Copy File Report\invoice_bespoke.frt To &_frt_file

	Case Vartype(pb_print_other_inv)#"U" And File("report\invoice_other.frx")


		Copy File Report\invoice_other.frx To &_frx_file		&&´_¨î³øªí(
		Copy File Report\invoice_other.frt To &_frt_file


	Case Vartype(__canada_tax_print)#"U" And __canada_tax_print And File("report\invoice_canada.frx")		&&¥[®³¤j³øªí

		Copy File Report\invoice_canada.frx To &_frx_file		&&´_¨î³øªí(
		Copy File Report\invoice_canada.frt To &_frt_file


	Otherwise

		Copy File Report\invoice.frx To &_frx_file		&&´_¨î³øªí
		Copy File Report\invoice.frt To &_frt_file

		&&Lihong 2021.04.01 ­tª÷ÃB·í¹w¥Iª÷
		IF Vartype(__neg_amt_as_deposit)#"U" And __neg_amt_as_deposit AND VARTYPE(_totalAmt_depoist)#"U"
			Copy File Report\invoice_depoist.frx To &_frx_file		
			Copy File Report\invoice_depoist.frt To &_frt_file
			_lbtotalamt=getmessage("_total_consumption",clangue) &&Á`®ø¶O Total Consumption
			IF _totalAmt_depoist < 0 
				_totalAmt_depoist = -_totalAmt_depoist
				_lbTotalAmt_depoist = getmessage("_refundable_deposit", clangue) &&À³°h­qª÷ Refundable Deposit
			ELSE
				_lbTotalAmt_depoist = getmessage("_receivable", clangue) &&À³¦¬ Receivable
			ENDIF 
		ENDIF 
Endcase

** debug

*!*	IF __debug_mode AND FILE("d:\invoice.frx")

*!*		Copy File d:\invoice.frx To &_frx_file		&&´_¨î³øªí
*!*		Copy File d:\invoice.frt To &_frt_file

*!*	ENDIF


_keep_printer_info=.F.

*SET STEP ON 
If Vartype(__invoice_frx)#"U" And !Empty(__invoice_frx)

	cFrx="report\"+Juststem(__invoice_frx)+".frx"
	cFrt ="report\"+Juststem(__invoice_frx)+".frt"

	If File(cFrx)

		Copy File  (cFrx) To &_frx_file		&&´_¨î³øªí
		Copy File  (cFrt) To &_frt_file

		_keep_printer_info=.T.

	Endif



Endif


Select 0
Use &_frx_file Exclusive Alias frx

If _keep_printer_info=.F.		&&¬O§_«O¯d¥´¦L¾÷ªº³]¸m

	Replace Expr With "" ,Tag With "",tag2 With "" For objtype=1 And objcode=53		&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m

Endif



If _gbk_langue

	Update frx Set  fontface = "SimSun",resoid = 134		&&GBK FONT

Endif

Use In frx


*----------
&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" 
	SELECT same_tableno FROM inv_print_tmp WHERE !EMPTY(same_tableno ) GROUP BY same_tableno INTO ARRAY tmp_s
	IF _tally<2
		REPLACE ALL same_tableno WITH "" IN inv_print_tmp
	ENDIF 
ELSE 
	REPLACE ALL same_tableno WITH "" IN inv_print_tmp
ENDIF 


&&Lihong 2022.08.19 ¤À±b
IF VARTYPE(_inv_print_attach_split)#"U" AND _inv_print_attach_split AND USED("inv_split_tmp")
*!*		ssql="select sub_id,cust_amt,paid_amt,is_paid from INV_SPLIT where inv_id=?_inv_id order by sub_id"
*!*		IF VARTYPE(_data_history)#"U"
*!*			ssql=ssql + CHR(13) + "select aa_sub_id as sub_id,SUM(netamt) as cust_amt,SUM(payamt) as paid_amt, CAST(1 as bit) as is_paid from "+view_inv_pay+" where id=?_inv_id group by aa_sub_id order by aa_sub_id"
*!*		ELSE
*!*			ssql=ssql + CHR(13) + "select aa_sub_id as sub_id,SUM(netamt) as cust_amt,SUM(payamt) as paid_amt, CAST(1 as bit) as is_paid from pay_detail where id=?_inv_id group by aa_sub_id order by aa_sub_id"
*!*		ENDIF
*!*		If SQLExec(nhand,ssql,"inv_split_tmp")<0
*!*			Aerror(err)
*!*			frm_wait.Hide
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			Return -1
*!*		ENDIF
*!*		
*!*		_inv_split_msg = getmessage("_split_amt")
*!*		IF RECCOUNT("inv_split_tmp")>0
*!*			SELECT CAST(5 as int) as r_id, *, CAST(_inv_split_msg + " " + TRIM(SUBSTR(sub_id, AT("-",sub_id)+1)) as C(20)) as split_desc FROM inv_split_tmp INTO CURSOR inv_split_tmp READWRITE 
*!*		ELSE 
*!*			SELECT CAST(5 as int) as r_id, *, CAST(_inv_split_msg + " " + TRIM(SUBSTR(sub_id, AT("-",sub_id)+1)) as C(20)) as split_desc FROM inv_split_tmp1 INTO CURSOR inv_split_tmp READWRITE 
*!*		ENDIF 

	SELECT inv_split_tmp 
	Index On r_id Tag split
	
ELSE
	CREATE CURSOR inv_split_tmp (r_id I, split_desc C(1), cust_amt N(10,2) )
	Index On r_id Tag split
ENDIF 

Select print_job_tmp 						&&«Ø¥ßÃöÁp,¦hDETAIL³øªí¥²¶·
Set Relation To r_id Into inv_print_tmp
Set Relation To r_id Into inv_disc_tmp Additive
Set Relation To r_id Into inv_void_tmp Additive		&&¨ú®øµæ¦¡
Set Relation To r_id Into inv_tax_tmp Additive		&&TAX2

Set Relation To r_id Into inv_split_tmp ADDITIVE &&¤À±b

Select print_job_tmp
Go Top

If !File("&_frx_file" )
	Return 0
Endif

Local _error

&&Lihong 2020.05.29 __TMP_INV_ORG_AMTµL·|³ø¿ù
__TMP_INV_ORG_AMT = _totalAmt

If _export_xff Or Vartype(_html_fileName)="C"  OR  VARTYPE(_show_inv_problem)#"U"
*----------------------------------------------->>>	&&¿é¥X¨ì XFF,html ¤å¥ó

	Set Library To xfrxlib.fll
	
*!*		SET STEP ON 
*!*	LOCAL m.loSession, m.lnRetVal
*!*	m.loSession= xfrx("XFRX#INIT")
*!*	*
*!*	* nothing is sent as the file name, so only a memory cursor is created
*!*	*
*!*	m.lnRetVal =m.loSession.SetParams(,,,,,,"XFF")                          
*!*	IF m.lnRetVal = 0
*!*	   m.loSession.ProcessReport(_frx_file)                  
*!*	   local m.loXFF, m.lnI, m.lnJpegQuality
*!*	   *
*!*	   * the finalize method returns a XFRX#DRAW object reference,
*!*	   * which will be used to save the pictures
*!*	   *
*!*	   m.loXFF = loSession.finalize()
*!*	   m.lnJpegQuality = 80
*!*	   *
*!*	   * loXFF.pagecount contains the number of pages of the
*!*	   * report that
*!*	   * was just generated
*!*	   *
*!*	   * we are now going to save all pages one by one as
*!*	   * separate jpeg pictures
*!*	   *
*!*	   FOR m.lnI = 1 TO m.loXFF.pagecount
*!*	       m.loXFF.savePicture("p"+ALLTRIM(STR(m.lnI))+".jpg", ;
*!*	                           "jpg",m.lnI,m.lnI,12,m.lnJpegQuality)
*!*	   ENDFOR
*!*	   =MESSAGEBOX("Pictures saved.")
*!*	ENDIF	
*!*		
	
		
	Local loxfrx
	loxfrx = XFRX("XFRX#LISTENER")
	loxfrx.DoNotOpenViewer=.T.  &&¤£Åã¥Ü¹wÄý

	loxfrx.targetType =Iif(_export_xff or VARTYPE(_show_inv_problem)#"U" , "XFF" ,"HTML")
	
	 IF Vartype(_html_fileName)="C"
	 
	 	loxfrx.targetType="HTML"
	 	
	 ENDIF
	 
	
	_outfile=Iif(Vartype(_html_fileName)="C", Fullpath(_html_fileName) , IIF(_export_xff2,"__tmp2.xff", "__tmp.xff"))


	loxfrx.targetFileName =_outfile
	lnRetval = loxfrx.setparams()

*	write_log(0,_html_fileName)

*!*		Set Library To xfrxlib.fll
*!*		Local loxfrx
*!*		loxfrx = XFRX("XFRX#LISTENER")
*!*		loxfrx.DoNotOpenViewer=.T.  &&¤£Åã¥Ü¹wÄý
*!*		loxfrx.targetType = "HTML"
*!*		_outfile=IIF(_export_html2 ,"__tmp1.html","__tmp.html")
*!*		loxfrx.targetFileName =_outfile
*!*		lnRetval = loxfrx.SetParams()

   * loXFF.pagecount contains the number of pages of the
   * report that
   * was just generated
   *
   * we are now going to save all pages one by one as
   * separate jpeg pictures
   *






	If lnRetval = 0
		Try
			Report Form  "&_frx_file"   Object loxfrx Nodialog	&&¥Í¦¨html¤å¥ó

		Catch To oError

*			SET STEP ON
			_error=.T.
		Endtry


		Release loxfrx
	Endif

	_filename=_cfilename+".*"
	Delete File  &_filename   &&§R°£¬ÛÃöªºÁ{®É¤å¥ó



Else


	If (__print_inv_after_discount=.T.  Or    Vartype(_discount_when_settle)="U")		&& 18/04/2008

		If Vartype(__inv_print_addition_header)#"U" And __inv_print_addition_header

			Select print_job_tmp
			Go Top
			Try
				Set Printer To Name (cprinter)
				Report Form  Report\invoice_header To Printer Nodialog Noconsole Nowait

			Catch To oError

			Endtry

		Endif

		Select print_job_tmp
		Go Top
		cError=""
*!*			Try
			Set Printer To Name (cprinter)
			If __debug_mode &&OR  _vfp.StartMode=0
			
				frm_wait.hide
				
			**	MESSAGEBOX(__debug_mode)

				Report Form (_frx_file) To Printer  Nodialog 	 Preview	 &&kkk
				
				IF VARTYPE(_print_invoice2)#"U" AND FILE("report\invoice2.frx")
				
					Report Form  report\invoice2.frx To Printer  Nodialog 	Noconsole Preview &&kkk
					
				
				ENDIF
				

			Else

*				Report Form (_frx_file) To Printer  Nodialog Noconsole	 &&PREVIEW &&kkk

				
				f0Sleep(100)
				
				
				REPORT FORM  (_frx_file) TO PRINTER NODIALOG  Noconsole	 


				IF VARTYPE(_print_invoice2)#"U" AND FILE("report\invoice2.frx")
				
					Report Form  report\invoice2.frx To Printer  Nodialog Noconsole	 
					
				
				ENDIF
				
				
			Endif


*!*			Catch To oError

*!*				_error=.T.
*!*				cError=oError.Message


*!*			ENDTRY
		
		RELEASE _print_invoice2

		If _error

			write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->print error"+cError)

			If __debug_mode &&OR  _vfp.StartMode=0

				Messagebox(cError)

			Endif

		Endif


		_filename=_cfilename+".*"
		Delete File  &_filename   &&§R°£¬ÛÃöªºÁ{®É¤å¥ó
		_filename=_cfilename+"_files\*.*"
		Delete File  &_filename   &&§R°£¬ÛÃöªºÁ{®É¤å¥ó
		_folder=_cfilename+"_files"
		
		IF !EMPTY(QRcode_file)
			
			DELETE FILE &QRcode_file
		
		ENDIF
		IF !EMPTY(QRcode_file_inv)
			DELETE FILE &QRcode_file_inv
		ENDIF

		
		If Directory("&_folder")			&&§R°£Á{®É¥Ø¿ý
			Rd &_folder
		Endif

	Endif

Endif


If Used("inv_print_tmp")
	Select inv_print_tmp
	Use

Endif

If Used("inv_print_tmp1")
	Select inv_print_tmp1
	Use

Endif

If Used("print_Job_tmp")

*	USE IN print_job_tmp
Endif

If Used("invdetail_tmp2")
	Select invdetail_tmp2
	Use

Endif


If _error

	write_log(57,"tbl:"+_tableno+" inv:"++Alltrim(Str(_inv_id))+"-->print error")		&&°O¿ý¾Þ§@

	Return -1

Else


	write_log(58,"tbl:"+_tableno+" inv:"+Alltrim(Str(_inv_id))+" Amt:"+Alltrim(Str(_totalamt,10,2)))		&&°O¿ý¾Þ§@

Endif





Return 1




Endfunc




************************
Function paylist_local_print
*¥I´Ú²M³æ¥»¦a¥´¦L
Lparameters _cfilename,cprinter,cLange

If Empty(cprinter)

	Return

Endif



Local cPrint_lange


If Vartype(cLange)#"C"

	cPrint_lange=_system_langue

Else

	cPrint_lange=cLange

Endif


_station=getcomputername()	&&¥u¨ú·í«estation©ÒºÞ²zªºprinterªº¥´¦L¾÷


*IF VARTYPE(__paylist_data_save)#"U" AND __paylist_data_save=.f.		&&¦pªG¯Â¥»¾÷¤è¦¡¥´¦L

If __pay_print_to_local

	ssql="select  *  from  payway with (nolock) "

	If SQLExec(nhand,ssql,"payway_list_tmp")<0
		Aerror(err)

		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif


	Select  * From  pay_print_main Into Cursor pay_print_tmp1

Else


	ssql="select  * from  pay_print_main   where pid=?_cfilename"

	If SQLExec(nhand,ssql,"pay_print_tmp1")<0
		Aerror(err)

		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif

Endif


If Eof("pay_print_tmp1")

	write_log(184,"pay_print_main data not found!")

	Return -1

Endif



Create Cursor print_job_tmp (r_id Int)
Append Blank
Replace r_id With 1
Append Blank
Replace r_id With 2

Append Blank
Replace r_id With 3

Append Blank

Replace r_id With 4	&&2009.06.03


Create Cursor inv_disc_tmp (r_id Int,descdisp c(100),amt N(12,2))			&&¾ã³æ§é¦©
Index On r_id Tag xdisc

Create Cursor inv_dept_tmp (r_id Int,descdisp c(50),qty N(12,2),amt N(18,4),dept_amt N(18,4),Id Int,srv N(18,4))		&&³¡ªù¤ÀªR
Index On r_id Tag dept

Select pay_print_tmp1

&&Lihong 2022.08.19 ¤À±b
_aa_sub_id = ""
IF !EMPTY(FIELD("aa_sub_id", "pay_print_tmp1"))
	_aa_sub_id = ALLTRIM(NVL(pay_print_tmp1.aa_sub_id,""))
ENDIF 

&&¤K¹F³q
_octDID=Iif(Isnull(pay_print_tmp1.oct_device_id),"",Trim(pay_print_tmp1.oct_device_id))
_octCid=Iif(Isnull(pay_print_tmp1.oct_card_id),"",Trim(pay_print_tmp1.oct_card_id))
_octremain=Iif(Isnull(pay_print_tmp1.oct_remain),0,pay_print_tmp1.oct_remain)

_kisstxid=NVL(pay_print_tmp1.kisstxid,"")
_kiss_dollor=NVL(pay_print_tmp1.kiss_dollor,0.00) 
_kiss_rrd =NVL(pay_print_tmp1.kiss_rrd ,0.00) 
_kiss_payamt=NVL(pay_print_tmp1.kiss_payamt,0.00)

_deposit_pay_print=(!EMPTY(FIELD("deposit_msg","pay_print_tmp1")) and !EMPTY(NVL(pay_print_tmp1.deposit_msg,""))) &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷

Private _inv_id
_inv_id=pay_print_tmp1.inv_Id									&&µo²¼¸¹½X

_member_name=""
_member_cardno=""
_member_tel=""


QRcode_file = ""

IF VARTYPE(__proan_web_order_call)#"U" AND __proan_web_order_call AND pay_print_tmp1.fastfood AND _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷

	IF VARTYPE(__proan_web_so_area)#"U" AND lower(__proan_web_so_area)="macau"		
		lcUrl = "https://www.proan-macau.com"	
	ELSE		
		lcUrl = "https://www.proan-order.com"	
	ENDIF

	IF VARTYPE(__proan_web_wechat_domain)#"U" AND !EMPTY(__proan_web_wechat_domain)
		
		lcUrl  =  TRIM(ALLTRIM(__proan_web_wechat_domain),"/")
		
	ENDIF

	IF SQLEXEC(nhand,"select * from inv where id=?_inv_id","cr_tmp")<0
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1	
	
	ENDIF
	
	_check_valid = TRIM(cr_tmp.check_valid)
	

	LOCAL lcUrl_detail, lcUrl_tableno
	lcUrl_tableno = ALLTRIM(cr_tmp.askno)
	TEXT TO lcUrl_detail NOSHOW TEXTMERGE 
       <<lcUrl>>/ProanOrder/oqc?t=oqc&m=<<ALLTRIM(__proan_web_so_merchant_id)>>&s=<<ALLTRIM(__proan_web_so_sub_merchant_id)>>&n=<<ALLTRIM(lcUrl_tableno)>>&v=<<_check_valid>>
	ENDTEXT 
	
	&& lcQRcode = lcUrl +"ProanOrder/oqc?t=oqc&m="+ALLTRIM(__proan_web_so_merchant_id)+"&s="+ALLTRIM(__proan_web_so_sub_merchant_id)+"&n="+TRIM(pay_print_tmp1.tableno)+"&v="+RIGHT(SYS(2015),9)
	lcQRcode =  TRIM(ALLTRIM(lcUrl_detail), " ", "	")


**	lcQRcode = lcUrl +"ProanOrder/oqc?t=oqc&m="+ALLTRIM(__proan_web_so_merchant_id)+"&s="+ALLTRIM(__proan_web_so_sub_merchant_id)+"&n="+TRIM(pay_print_tmp1.tableno)+"&v="+RIGHT(SYS(2015),9)
	
	 Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
				STRING code,;
				STRING sFileName,;
				INTEGER width, ;
				INTEGER height	
	
	QRcode_file= FULLPATH(SYS(2015)+".bmp")
	
	IF GetQrCode_rms(lcQRcode , QRcode_file, 300, 300)<>1
	
		RETURN 
	
	ENDIF
	
ENDIF


tmpMacauPass  = .f.

prt_macau_pass_discount_type = ""
prt_macau_pass_coupon_type = ""

IF pay_print_tmp1.void
	ssql = "select * from inv_macau_pass where inv_id=?_inv_id and  type = 'sale_void' "

ELSE
	ssql = "select * from inv_macau_pass where inv_id=?_inv_id"
ENDIF

IF SQLEXEC(nhand,ssql,"prt_inv_macau_pass")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

ENDIF

IF _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷

	IF !EOF("prt_inv_macau_pass")
			
			SELECT *,CTOT(SUBSTR(txndate,1,4) + "/"+SUBSTR(txndate,5,2)+"/"+SUBSTR(txndate,7,2) + " "+ SUBSTR(txntime,1,2)+":" +SUBSTR(txntime,3,2) +":"+SUBSTR(txntime,5,2)) as txndt FROM prt_inv_macau_pass INTO CURSOR prt_inv_macau_pass READWRITE 
			tmpMacauPass  = .t.

			DO CASE 	
				CASE prt_inv_macau_pass.discount_type = "01"
					prt_macau_pass_discount_type = "º¡ÃB§é¦©"
				CASE prt_inv_macau_pass.discount_type = "02"
					prt_macau_pass_discount_type = "º¡ÃB¥ß´î"
				CASE prt_inv_macau_pass.discount_type = "03"
					prt_macau_pass_discount_type = "ÀH¾÷¥ß´î"
				CASE prt_inv_macau_pass.discount_type = "04"
					prt_macau_pass_discount_type = "ÃØ°e"
				CASE prt_inv_macau_pass.discount_type = "05"
					prt_macau_pass_discount_type = "ÀH¾÷§é¦©"
				CASE prt_inv_macau_pass.discount_type = "06"
					prt_macau_pass_discount_type = "ÀH¾÷ÃØ°e"			
			ENDCASE 
			
			DO CASE
				CASE prt_inv_macau_pass.coupon_type = "01"
					prt_macau_pass_coupon_type = "º¡´î¨é"
				CASE prt_inv_macau_pass.coupon_type = "02"
					prt_macau_pass_coupon_type = "§é¦©¨é"
				CASE prt_inv_macau_pass.coupon_type = "03"
					prt_macau_pass_coupon_type = "¥Nª÷¨é"
			ENDCASE 

	ELSE

		SELECT *,CTOT("1900-01-01 00:00") as txndt FROM prt_inv_macau_pass INTO CURSOR prt_inv_macau_pass READWRITE 


	ENDIF

ELSE &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	SELECT *,CTOT("1900-01-01 00:00") as txndt FROM prt_inv_macau_pass WHERE 1<>1 INTO CURSOR prt_inv_macau_pass READWRITE 
ENDIF 
*SET STEP ON 
IF _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	&&Lihong 2023.04.06 ¥ý¬dinv ¥B¦P®É¬d¥X«á­±ªº,b.name_cn,b.cardno,b.tel
	If SQLExec(nhand,"select a.*,b.member_number,member.name_cn,member.cardno,member.tel as memb_tel,member.cloud_plat,member_type.desccn as member_vip from inv a left join inv_disc b on a.id=b.id left join member with (nolock) on a.memberno=member.id "+;
	"left join member_type with (nolock) on member.type_id=member_type.id where a.id=?_inv_id","pay_cun_tmp")<0

		Aerror(err)

		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1
	Endif
	IF RECCOUNT("pay_cun_tmp")=0
		If SQLExec(nhand,"select a.*,b.member_number,member.name_cn,member.cardno,member.tel as memb_tel,member.cloud_plat,member_type.desccn as member_vip from inv_view a left join inv_disc_view b on a.id=b.id left join member with (nolock) on a.memberno=member.id "+;
		"left join member_type with (nolock) on member.type_id=member_type.id where a.id=?_inv_id","pay_cun_tmp")<0

			Aerror(err)

			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1
		Endif
	ENDIF 

	&&Lihong 2023.06.06
	_storellet_memb_vip="VIP"
	IF VARTYPE(__storellet_cust_type)#"U" AND !EMPTY(__storellet_cust_type)
		_storellet_memb_vip = UPPER(__storellet_cust_type)
	ENDIF 

	_pplcnt=pay_cun_tmp.pplcnt
	_llstorellet_qrcode = (NVL(pay_cun_tmp.memberno,0)<=0 or (IIF(VARTYPE(__cloud_member)#"U" AND __cloud_member, TRIM(NVL(pay_cun_tmp.cloud_plat, ""))=="storellet", .T.) and !UPPER(ALLTRIM(NVL(pay_cun_tmp.member_vip,"")))==_storellet_memb_vip) )  
	&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h  

	If Vartype(_pub_fastfood_info)="C"		&& update  by david 2015.04.22

		_ctableno_ppl=Alltrim(pay_cun_tmp.tableno)+" / "+Iif(_gbk_langue,getGBKtxt(_pub_fastfood_info),_pub_fastfood_info)

	Else

		_ctableno_ppl=Alltrim(pay_cun_tmp.tableno)+" / "+Alltrim(Str(pay_cun_tmp.pplcnt))+" "+getmessage("_Cover")				&&À\Âi(¥s¸¹)/¤H¼Æ (¦ì)

	ENDIF

ELSE
	If SQLExec(nhand,"select * from deposit with (nolock) where id=?_inv_id","pay_cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
	_pplcnt=0
	_llstorellet_qrcode=.F.
	_ctableno_ppl=""
ENDIF 

IF _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	IF __member_printer_installed AND VARTYPE(oMember_info)="U" AND !EMPTY(TRIM(pay_cun_tmp.member_number))		&& ¥ý¹F·|­û¥d


		oMember_info=get_membercard_info(TRIM(pay_cun_tmp.member_number))


	ENDIF


	If !Empty(Trim(Nvl(pay_cun_tmp.member_number,"")))

		_member_cardno = getmessage("_cardno")+":" + Trim(pay_cun_tmp.member_number)

	Else

		&&Lihong 2023.04.06 ¥ý¬dinv Àu¤Æ¬°¤W­±¦P®É¬d¥X
*!*			If SQLExec(nhand,"select a.*,b.name_cn,b.cardno,b.tel from inv a left join member b on a.memberno=b.id where a.id=?_inv_id","pay_cun_tmp")<0

*!*				Aerror(err)
*!*				frm_wait.Hide
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1
*!*			Endif
*!*			IF RECCOUNT("pay_cun_tmp")=0
*!*				If SQLExec(nhand,"select a.*,b.name_cn,b.cardno,b.tel from inv_view a left join member b on a.memberno=b.id where a.id=?_inv_id","pay_cun_tmp")<0

*!*					Aerror(err)
*!*					frm_wait.Hide
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*					Return -1
*!*				Endif
*!*			ENDIF 

		_member_name=Iif(Isnull(pay_cun_tmp.name_cn),"", getmessage("_member")+":"+Trim(pay_cun_tmp.name_cn) )
		_member_cardno=Iif( Isnull(pay_cun_tmp.cardno),"",  getmessage("_cardno")+":"+Trim(pay_cun_tmp.cardno) )
		*&&Lihong 2023.04.06 _member_tel= Iif(Isnull(pay_cun_tmp.tel) Or Empty(pay_cun_tmp.tel),"",getmessage("_tel")+Trim(pay_cun_tmp.tel))				&&·|­û¹q¸Ü
		_member_tel= Iif(Isnull(pay_cun_tmp.memb_tel) Or Empty(pay_cun_tmp.memb_tel),"",getmessage("_tel")+Trim(pay_cun_tmp.memb_tel))

	ENDIF

ELSE &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	_member_name=""
	_member_cardno=""
	_member_tel=""
ENDIF 


IF VARTYPE(oMember_info)="O"	&& 

	_inv_points=oMember_info.EarnPoint
	_inv_points_used=0
	_member_points_remain=oMember_info.bonus
	
	_member_value = oMember_info.value
	_member_remark =oMember_info.remark
	
	_lms_member_name = oMember_info.name_cn

ELSE
	_member_remark =""
	_lms_member_name =""
	_member_value =""

ENDIF

*MESSAGEBOX(_lms_member_name )
RELEASE oMember_info




IF _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	_paidtime=pay_cun_tmp.paidtime				&&µ²±b®É¶¡
	_srvamt=pay_cun_tmp.srvamt					&&ªA°È¶O
ELSE
	_paidtime=pay_cun_tmp.paidtime
	_srvamt=0.00 
	
	_deposit_booking_time = IIF(ISNULL(pay_cun_tmp.booking_time),"",IIF(pay_cun_tmp.booking_time=CTOT("1900-01-01"),"",TTOC(pay_cun_tmp.booking_time)))
	_deposit_booking_time = LEFT(_deposit_booking_time,16)
	_deposit_remark1 = NVL(pay_cun_tmp.remark1,"")
	
	IF VARTYPE(_deposit_call_cashier_status) # "U" AND _deposit_call_cashier_status = 2  &&¤@¦¸©Ê­qª÷°h´Ú By Waston 31/08/2023
		_paidtime = IIF(ISNULL(pay_cun_tmp.add_time),"",IIF(pay_cun_tmp.add_time=CTOT("1900-01-01"),"",TTOC(pay_cun_tmp.add_time)))
		_paidtime = CTOT(LEFT(_paidtime,16))
		_deposit_booking_time = ""
	ENDIF 
ENDIF 

_report_Training=pay_print_tmp1.training						&&¬O§_°V½m¼Ò¦¡

cnotice=Iif(_report_Training,getmessage("_training"),"")


IF VARTYPE(_invinfo_reprint_paylist)#"U"		&&Àç·~¸ê®Æ¤¤­«¦L¥I´Ú²M³æ

	cNotice = "****" + getmessage("_reprint") +" ****"
	_report_Training = .t. 


ENDIF	


IF VARTYPE(_deposit_call_cashier_status)#"U" AND _deposit_call_cashier_status = 2		&&¤@¦¸©Ê­qª÷°h´Ú &&¤@¦¸©Ê­qª÷°h´Ú By Waston 31/08/2023

	cNotice = "****" + getmessage("_deposit_refund") +" ****"
	_report_Training = .t. 


ENDIF	


_deleted_paylist=Iif(pay_print_tmp1.void,getmessage("_deleted_paylist"),"")				&&¤w§R°£¥I´Ú²M³æ

_invamt=pay_print_tmp1.invamt										&&µo²¼ª÷ÃB
_paidamt=pay_print_tmp1.paidamt									&&¥I´Úª÷ÃB
_tipsamt=pay_print_tmp1.tips										&&¤p±b

_station_id=pay_print_tmp1.station_id							&&¤u§@¯¸ÂIID
_cusername=Trim(pay_print_tmp1.username)						&&Àç·~­û
_langue=Trim(pay_print_tmp1.langue)								&&¦L³æ»y¨¥

_lbpaylist=getmessage("_payment_slip")
_lbtableNo=Iif(pay_print_tmp1.fastfood,getmessage("_askno"),getmessage("_tableno"))		&&Âi¸¹ /¥s¸¹(§ÖÀ\)
_lbinvno=getmessage("_invno")			&&µo²¼¸¹½X
IF _deposit_pay_print=.T. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	_lbpaylist=getmessage("_deposit_slip") &&­qª÷³æ Deposit Slip &&_lbpaylist+"("+getmessage("_deposit")+")"
	_lbtableNo=getmessage("lbl_contact")
	_lbinvno=getmessage("lbl_deposit_no") 
	_barcodetxt  = "DET"+Iif(_inv_id<=9999999,Replicate("0",7-Len(Alltrim(Str(_inv_id))))+Alltrim(Str(_inv_id)),Alltrim(Str(_inv_id))) &&_cinvno
	_barcode = "*"+_barcodetxt+"*"
	_barcodetxt = Alltrim(Str(_inv_id))
	*_barcodetxt=Padl(Alltrim(Str(ABS(_inv_id))),6,"0")
	_cusername = _deposit_booking_time
	_member_name = _deposit_remark1
	
	IF VARTYPE(_deposit_call_cashier_status) # "U" AND _deposit_call_cashier_status = 2 &&¤@¦¸©Ê­qª÷°h´Ú By Waston 31/08/2023
		_lbpaylist=getmessage("_refund_slip")
		_lbinvno=getmessage("_deposit_refund") + getmessage("_order_no")
	ENDIF 

	
ENDIF 
_lbusername=getmessage("_cashier")	&&Àç·~­û
_lbpayway=getmessage("_payway")			&&¥I´Ú¤è¦¡
_lbamt=getmessage("_amount")+Iif(!Empty( __local_CURRENCY),"("+Trim(__local_CURRENCY) +")","")			&&ª÷ÃB(HKD)
_lbTips=getmessage("_tips")				&&¤p±b

&&Lihong 2021.07.07 ¥I´Ú²M³æ¼W¥[ªA°È¶Oµ¥
_lbsubtotalamt=getmessage("_subtotalamt")	&&¤p­p
_lbdiscount=getmessage("_discount")		&&§é¦©
_lbServiceFee=getmessage("_svr_charge")	&&ªA°È¶O
_lbtaxfee=getmessage("_taxfee")		&&µ|¶µ
_lbxdisc=getmessage("_xdisc")		&&²Õ¦XÀu´f
_lbadjust=getmessage("_rounding")		&&·L½Õ
_lbtotalamt=getmessage("_totalamt")	&&Á`ª÷ÃB


_lbInvAmt=getmessage("_inv_amt")+Iif(!Empty( __local_CURRENCY),"("+Trim(__local_CURRENCY) +")","")		&&µo²¼ª÷ÃB
IF _deposit_pay_print=.T. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	_lbInvAmt=getmessage("_deposit_amt") &&­qª÷ª÷ÃB Deposit Amount
	_lbusername = getmessage("lbl_deposit_datetime") &&¹w­q¤é´Á
	
*!*		IF VARTYPE(_deposit_call_cashier_status) # "U" AND _deposit_call_cashier_status = 2  &&­qª÷°h´Ú  By Waston 31/08/2023
*!*			_lbInvAmt=getmessage("_refund_amt") &&°h´Úª÷ÃB Deposit Refund Amount
*!*		ENDIF 
	
ENDIF 

*_lbpayamt=getmessage("_paid_amt")+"("+TRIM(__local_currency) +")"		&&¥I´Úª÷ÃB
_lbchange=getmessage("_changes")			&&§ä¦^

**¤K¹F³q

_lbpayamt=Iif(Empty(_octCid) Or Isnull(_octCid),getmessage("_paid_amt"),getmessage("_octopus_payment"))+"("+Trim(__local_CURRENCY) +")"		&&¥I´Úª÷ÃB
_lbOctremain=getmessage("_octopus_remain_value")			&&¤K¹F³q§EÃB
*_lbOctpayment=getmessage("_octopus_payment")	

_lbOctCardID=getmessage("_octopus_card_id")		&&¤K¹F³q¥d¸¹
_lbOctDviceID=getmessage("_octopus_device_id")		&&¤K¹F³q¦¬¶O¾¹½s¸¹

_lbitemlist=getmessage("_itemlist")		&&¶µ¥Ø²M³æ

_lbitem=getmessage("_invitem")			&&¶µ¥Ø
_lbqty=getmessage("_qty")				&&¼Æ¶q

_change_station=.F.
_change_printer=.F.
_from_printer=""


_cDeptAnalyse=getmessage("_dept_analyse")		&&³¡ªù¤ÀªR		2009.06.03

_lbsrvamt=getmessage("_svr_charge")				&&ªA°È¶O		2010.09.14


_lbmember_name= getmessage("_member_name") &&·|­û¦WºÙ
_lbCard_remain =getmessage("_membercard_remin")	&&·|­û¥d§EÃB
_lbmember_remark=getmessage("_remark")	&&³Æª`


*------------------------------

&&¥H¤U±q¨t²Î³]©w¤¤¨ú¼Æ¾Ú,¤£¦P¤u§@¥i¥H¦³¤£¦Pªº³]©w

*SET STEP ON 
&&Lihong 2022.08.09§ï¬°¦Pµo²¼¤@­P _inv_header=Iif(cPrint_lange="CN",__inv_header1_cn,__inv_header1_en)			&&µo²¼ÀY
_inv_header=__company_name


If Vartype(__paylist_print_inv_header)#"U" And __paylist_print_inv_header		&& 2009.06.03  ¥[¤Jinv header
	_inv_header1=Iif(cPrint_lange="CN",__inv_header1_cn,__inv_header1_en) &&Lihong 2022.08.09§ï¬°¦Pµo²¼¤@­P
	_inv_header2=Iif(cPrint_lange="CN",__inv_header2_cn,__inv_header2_en)
	_inv_header3=Iif(cPrint_lange="CN",__inv_header3_cn,__inv_header3_en)
	_inv_header4=Iif(cPrint_lange="CN",__inv_header4_cn,__inv_header4_en)

Else
	_inv_header1=""
	_inv_header2=""
	_inv_header3=""
	_inv_header4=""

Endif


Local _tableno
_cprinttime=Ttoc(Datetime(),2)
_tableno=Trim(pay_print_tmp1.tableno)
_ctableno=Trim(pay_print_tmp1.tableno)+Space(4) +"("+_cprinttime+")"		&&À\Âi(¥s¸¹)/¦L³æ®É¶¡
_cinvno=Iif(_inv_id<=9999999999,Replicate("0",10-Len(Alltrim(Str(_inv_id))))+Alltrim(Str(_inv_id)),Alltrim(Str(_inv_id)))	&&µo²¼¸¹½X
_lbdepositNO = ""
_lbdeposittime = ""
_depositNO = ""
IF _deposit_pay_print=.T. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	_lbdepositNO = getmessage("lbl_deposit_no")
	_lbdeposittime = getmessage("_deposit_time") &&¸¨­q®É¶¡ Deposit Time
	_lbusername = getmessage("_deposit_booking_time") &&¹w­q®É¶¡ Booking Time
	_depositNO = LTRIM(_cinvno,"0")
	_cinvno = ""
	_lbinvno = ""
	
	IF VARTYPE(_deposit_call_cashier_status) # "U" AND _deposit_call_cashier_status = 2  &&¤@¦¸©Ê­qª÷°h´Ú  By Waston 31/08/2023
		_lbdeposittime = getmessage("_refund_time") &&°h´Ú®É¶¡ Refund Time
		_lbdepositNO = getmessage("_deposit_refund") + getmessage("_order_no")
		_lbusername = ""
	ENDIF 
	
ENDIF 

&&Lihong 2022.08.19 ¤À±b
_inv_split_msg = ""
_lbsub_invAmt = ""
_sub_invAmt = 0.00
*_aa_sub_id = ""
IF !EMPTY(_aa_sub_id)
	*_cinvno = _cinvno + SPACE(4) + _aa_sub_id
*!*		IF VARTYPE(_aa_sub_id_paidtime)#"U"
*!*			_paidtime = _aa_sub_id_paidtime
*!*		ELSE
*!*			IF SQLEXEC(nhand,"select aa_sub_paidtime from pay_detail where id=?_inv_id and aa_sub_id=?_print_paylist_aa_sub_id","cun_tmp2")<0
*!*				aerror(err)
*!*				frm_wait.hide
*!*				error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
*!*				Return -1	
*!*			ENDIF
*!*			IF RECCOUNT("cun_tmp2")>0
*!*				_paidtime = cun_tmp2.aa_sub_paidtime
*!*			ENDIF 
*!*			
*!*		ENDIF 
	*USE IN SELECT("inv_split_info_tmp1")
	ssql="select netamt,aa_sub_id, aa_sub_paidtime from inv_pay_view where id=?_inv_id"
	ssql=ssql + CHR(13) + "select sub_id from INV_SPLIT where inv_id=?_inv_id "
	IF SQLEXEC(nhand,ssql,"inv_split_info_tmp")<0
		aerror(err)
		frm_wait.hide
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
		Return -1	
	ENDIF
	*IF RECCOUNT("inv_split_info_tmp")>0
		SELECT inv_split_info_tmp
		LOCATE FOR ALLTRIM(aa_sub_id)==_aa_sub_id
		_paidtime = inv_split_info_tmp.aa_sub_paidtime
		SELECT SUM(netamt) FROM inv_split_info_tmp WHERE ALLTRIM(aa_sub_id)==_aa_sub_id INTO ARRAY tmp_s
		_sub_invAmt = NVL(tmp_s, 0.00)
		IF VARTYPE(_aa_sub_id_paidtime)#"U"
			_paidtime = _aa_sub_id_paidtime
		ENDIF 
		
	IF RECCOUNT("inv_split_info_tmp1")>0
		lnaa_sub_id_count = RECCOUNT("inv_split_info_tmp1")
	ELSE
		SELECT aa_sub_id FROM inv_split_info_tmp GROUP BY aa_sub_id INTO CURSOR inv_split_info_tmp 
		lnaa_sub_id_count = RECCOUNT("inv_split_info_tmp")
	ENDIF 
	USE IN SELECT("inv_split_info_tmp")
	USE IN SELECT("inv_split_info_tmp1")

	*¼g¦º _inv_split_msg = getmessage("_split_amt")
	_inv_split_msg = Iif(cPrint_lange="CN","«È¤H", "Guest")
	_inv_split_msg = _inv_split_msg + "("+SUBSTR(_aa_sub_id, AT("-",_aa_sub_id)+1) + " / " + TRANSFORM(lnaa_sub_id_count) + ")"
	_lbsub_invAmt = _inv_split_msg + IIF(cPrint_lange="CN",""," ") + getmessage("_amount", cPrint_lange)

ENDIF 

Create Cursor inv_print_tmp (r_id Int,same_tableno C(8),Item c(120),qty c(10),amt N(12,2),printtime  c(20),adduser c(20),item_unicode c(200),price N(8,2),srv_per n(6,2),srv_amount n(12,2))
Index On r_id Tag inv


Private  nRid_item,nRid_pay

nRid_pay=1
nRid_item=2


&&Lihong 2022.04.18
*PUBLIC QRcode_file_for_storellet
QRcode_file_for_storellet = ""
******storellet print qrcode add by donald 10/01/2022
IF VARTYPE(__storellet)#"U" AND __storellet AND !EMPTY(__storellet_key_qrcode) AND _llstorellet_qrcode AND _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	LOCAL lcQRcode_storellet, lc_storellet_info

	lcQRcode_storellet = IIF(RIGHT(ALLTRIM(__storellet_link), 1) <> "/", ALLTRIM(__storellet_link) + "/", ALLTRIM(__storellet_link))
	lcQRcode_storellet = lcQRcode_storellet + "a/qrCode/s="
	 
	lc_storellet_info = ALLTRIM(__storellet_brand_id) + ";" + ALLTRIM(__storellet_shop_code) + ";" + Alltrim(Str(_inv_id)) + ";" + ;
	ALLTRIM(STR(YEAR(_paidtime))) + ALLTRIM(PADL(MONTH(_paidtime), 2, "0")) + ALLTRIM(PADL(DAY(_paidtime), 2, "0")) + ;
	ALLTRIM(PADL(HOUR(_paidtime), 2, "0")) + ALLTRIM(PADL(MINUTE(_paidtime), 2, "0"))
	 
	lc_storellet_info = Encrypt_with_AES128(lc_storellet_info, ALLTRIM(__storellet_key_qrcode))
	&&lc_storellet_info = URLencode(lc_storellet_info)
	lcQRcode_storellet = lcQRcode_storellet + lc_storellet_info+"&"+"pos="+ALLTRIM(__storellet_pos_id)
	
	Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
	    STRING code,;
	    STRING sFileName,;
	    INTEGER width, ;
	    INTEGER height 
	 
	QRcode_file_for_storellet =  FULLPATH(SYS(2015)+".bmp")
	 
	IF GetQrCode_rms(lcQRcode_storellet, QRcode_file_for_storellet, 300, 300) <> 1
		QRcode_file_for_storellet = ""
	ENDIF
ENDIF 

&&Lihong 2023.03.24
QRcode_file_for_MobileCard = ""
IF VARTYPE(__mobilecard)#"U" AND __mobilecard AND _deposit_pay_print=.F. 
	QRcode_file_for_storellet = ""
	IF !EMPTY(__mobilecard_url) AND _deposit_pay_print=.F. 
		lcmobilecard_url = RTRIM(__mobilecard_url,"/")
		lcmobilecard_url = RTRIM(lcmobilecard_url,"\")
		
		lcmobilecard_url = lcmobilecard_url + "/" + __mobilecard_vendor_id
		
		lntimestamp = _paidtime - datetime(1970,1,1,0,0,0)
		lcstr_info = __mobilecard_shop_id + "|" + __mobilecard_branch_id + "|" + Alltrim(Str(_inv_id)) + "|" + TRANSFORM(_invamt)  + "|" + TRANSFORM(lntimestamp)

		lchash = STRCONV(lcstr_info, 13)
		
		lcMD5_checksum = __mobilecard_secret_key + "|" + lcstr_info
		Set Library To vfpencryption71.fll Additive
		lcMD5_checksum = hash(lcMD5_checksum, 5)
		lcMD5_checksum = STRCONV(lcMD5_checksum, 15)
		lcMD5_checksum = LOWER(LEFT(lcMD5_checksum, 3))
		
		lcmobilecard_url = lcmobilecard_url + "/" + lchash + "/" + lcMD5_checksum 

		Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
		    STRING code,;
		    STRING sFileName,;
		    INTEGER width, ;
		    INTEGER height 
		 
		QRcode_file_for_MobileCard =  FULLPATH(SYS(2015)+".bmp")
		 
		IF GetQrCode_rms(lcmobilecard_url, QRcode_file_for_MobileCard, 300, 300) <> 1
			QRcode_file_for_MobileCard= ""
		ENDIF

	ENDIF 
ENDIF 

&&Lihong 2023.05.23 QRcode_file_inv
QRcode_file_pay = ""
IF VARTYPE(__pay_slip_prt_qrcode_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_format) AND _deposit_pay_print=.F. 	&&¥Í¦¨QRCODE 
	lcQRcode = __pay_slip_prt_qrcode_format

	*{inv_no}{inv_qty}{inv_amt}{inv_paidtime}{inv_belongdate}
	TEXT TO ssql TEXTMERGE NOSHOW 
	select invamt,qty=(select SUM(qty) as qty from inv_detail where id=?_inv_id and item_id<>-3 and item_id<>0),belongdate as belongdate_org,paidtime as paidtime_org,
	<<IIF(VARTYPE(__pay_slip_prt_qrcode_date_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_date_format), "format(belongdate, ?__pay_slip_prt_qrcode_date_format) as belongdate","belongdate")>>,
	<<IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_datetime_format), "format(paidtime, ?__pay_slip_prt_qrcode_datetime_format) as paidtime","paidtime")>>,
	begintime as begintime_org, <<IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_datetime_format), "format(begintime, ?__pay_slip_prt_qrcode_datetime_format) as begintime","begintime")>>,
	<<IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_datetime_format), "format(getdate(), ?__pay_slip_prt_qrcode_datetime_format) as printtime","getdate() as printtime")>>,
	<<IIF(VARTYPE(__pay_slip_prt_qrcode_date_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_date_format), "format(getdate(), ?__pay_slip_prt_qrcode_date_format) as printdate","getdate() as printdate")>> 
	from inv where id=?_inv_id
	ENDTEXT 
	If SQLExec(nhand,ssql,"cun_tmp")<0
		aerror(err)
		frm_wait.hide
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
		Return -1	
	ENDIF
	IF RECCOUNT("cun_tmp")=0
		TEXT TO ssql TEXTMERGE NOSHOW 
		select invamt,qty=(select SUM(qty) as qty from inv_detail_view where id=?_inv_id and item_id<>-3 and item_id<>0),belongdate as belongdate_org,paidtime as paidtime_org,
		<<IIF(VARTYPE(__pay_slip_prt_qrcode_date_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_date_format), "format(belongdate, ?__pay_slip_prt_qrcode_date_format) as belongdate","belongdate")>>,
		<<IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_datetime_format), "format(paidtime, ?__pay_slip_prt_qrcode_datetime_format) as paidtime","paidtime")>>,
		begintime as begintime_org, <<IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_datetime_format), "format(begintime, ?__pay_slip_prt_qrcode_datetime_format) as begintime","begintime")>>,
		<<IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_datetime_format), "format(getdate(), ?__pay_slip_prt_qrcode_datetime_format) as printtime","getdate() as printtime")>>,
		<<IIF(VARTYPE(__pay_slip_prt_qrcode_date_format)#"U" AND !EMPTY(__pay_slip_prt_qrcode_date_format), "format(getdate(), ?__pay_slip_prt_qrcode_date_format) as printdate","getdate() as printdate")>> 
		from inv_view where id=?_inv_id
		ENDTEXT 
		If SQLExec(nhand,ssql,"cun_tmp")<0
			aerror(err)
			frm_wait.hide
			error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
			Return -1	
		ENDIF
	ENDIF 
	PRIVATE inv_no, inv_qty, inv_amt, inv_paidtime, inv_belongdate, inv_begintime, inv_printtime
	inv_no = TRANSFORM(_inv_id)
	inv_qty = TRANSFORM(NVL(cun_tmp.qty,0))
	inv_amt = IIF(VARTYPE(__pay_slip_prt_qrcode_amt_x100)#"U" and __pay_slip_prt_qrcode_amt_x100, TRANSFORM(FLOOR(NVL(cun_tmp.invamt,0)*100)), allt(TRANSFORM(NVL(cun_tmp.invamt,0),"999,999,999.99")) ) 	
	inv_belongdate=Iif(Year(cun_tmp.belongdate_org)>2000, IIF(VARTYPE(__pay_slip_prt_qrcode_date_format)="U" OR EMPTY(__pay_slip_prt_qrcode_date_format), DTOC(cun_tmp.belongdate_org), TRIM(STRCONV(cun_tmp.belongdate, 6))), "")  
	inv_paidtime=Iif(Year(cun_tmp.paidtime_org)>2000, IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)="U" OR EMPTY(__pay_slip_prt_qrcode_datetime_format), TTOC(cun_tmp.paidtime_org), TRIM(STRCONV(cun_tmp.paidtime, 6))), "") 
	inv_begintime=Iif(Year(cun_tmp.begintime_org)>2000, IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)="U" OR EMPTY(__pay_slip_prt_qrcode_datetime_format), TTOC(cun_tmp.begintime_org), TRIM(STRCONV(cun_tmp.begintime, 6))), "") 
	inv_printtime=IIF(VARTYPE(__pay_slip_prt_qrcode_datetime_format)="U" OR EMPTY(__pay_slip_prt_qrcode_datetime_format), TTOC(cun_tmp.printtime), TRIM(STRCONV(cun_tmp.printtime, 6)))
	IF Year(cun_tmp.belongdate_org)<=2000
		inv_belongdate=IIF(VARTYPE(__pay_slip_prt_qrcode_date_format)="U" OR EMPTY(__pay_slip_prt_qrcode_date_format), DTOC(cun_tmp.printdate), TRIM(STRCONV(cun_tmp.printdate, 6)))
	ENDIF 

	TRY 
		lcQRcode = TEXTMERGE(lcQRcode, .F., "{", "}")
	CATCH 
		lcQRcode = ""
	ENDTRY 
	
	IF !EMPTY(lcQRcode)
		QRcode_file_pay = FULLPATH(SYS(2015)+".bmp")
			
		 Declare INTEGER "GetQrCode_rms" IN send_email.dll ;
					STRING code,;
					STRING sFileName,;
					INTEGER width, ;
					INTEGER height	
		
		IF GetQrCode_rms(lcQRcode , QRcode_file_pay, 300, 300)<>1
			QRcode_file_pay=""
		ENDIF
*!*			IF !FILE(QRcode_file_pay)
*!*				QRcode_file_pay=""
*!*			ENDIF 
	ENDIF 
ENDIF


&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
_subtotalamt=0		&&¤p­p
_discount=0							&&¾ã³æ§é¦©
_servicefee=0						&&ªA°È¶O
_taxfee=0							&&µ|¶µ
_xdisc=0							&&²Õ¦XÀu´f	
_adjust=0							&&¹sÀY
_totalamt=0							&&¦X­pª÷ÃB

If __print_itemlist_in_pay_slip AND _deposit_pay_print=.F.	&&¬O§_¦C¦Lµo²¼¶µ¥Ø &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷


*	IF VARTYPE(__paylist_data_save)#"U" AND __paylist_data_save=.f.		&&¦pªG¯Â¥»¾÷¤è¦¡¥´¦L

	If __pay_print_to_local

		Select * From pay_print_detail  Into Cursor pay_cun_tmp


	Else

		ssql="select * from pay_print_detail  where pid=?_cfilename order by id"
		If SQLExec(nhand,ssql,"pay_cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

	Endif


	Select pay_cun_tmp
	Scan

		Insert Into inv_print_tmp (r_id,same_tableno,Item,qty,amt,printtime,adduser,item_unicode,price) Values ;
			(nRid_item,NVL(pay_cun_tmp.same_tableno,""),pay_cun_tmp.Item,pay_cun_tmp.qty,pay_cun_tmp.amt,Nvl(pay_cun_tmp.printtime,""),Nvl(pay_cun_tmp.adduser,""),;
			nvl(pay_cun_tmp.item_unicode,"") ,Nvl(pay_cun_tmp.price,0))

	Endscan

	IF VAL(__mult_langue_code)<1000

		Update inv_print_tmp Set  item_unicode= Strconv(Strconv(Trim(item_unicode),14),11,Val(__mult_langue_code),1)	Where !Empty(item_unicode) &&Âà¬°DBCS

	ENDIF
	
	&&Lihong 2021.07.07 ¥I´Ú²M³æ¼W¥[ªA°È¶Oµ¥
	If SQLExec(nhand,"select * from inv with (nolock) where id=?_inv_id","cun_tmp2")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
	_subtotalamt=cun_tmp2.amount+cun_tmp2.itemdiscamt		&&¤p­p
	_discount=cun_tmp2.discamt							&&¾ã³æ§é¦©
	_servicefee=cun_tmp2.srvamt							&&ªA°È¶O
	_taxfee=cun_tmp2.taxamt								&&µ|¶µ
	_xdisc=0											&&²Õ¦XÀu´f	
	_adjust=cun_tmp2.rndamt								&&¹sÀY
	_totalamt=cun_tmp2.invamt							&&¦X­pª÷ÃB
	USE IN SELECT("cun_tmp2")
	
Endif

Select 0
Create Cursor paylist_tmp (r_id Int,payway c(30),cardno c(50),payamt c(50),tips N(12,2),Changes N(12,2), card_name c(30) )
Index On r_id Tag pay

*IF VARTYPE(__paylist_data_save)#"U" AND __paylist_data_save=.f.		&&¦pªG¯Â¥»¾÷¤è¦¡¥´¦L

If __pay_print_to_local


	Select a.*,b.desccn,b.descen From payway_print_detail a LEFT JOIN payway_list_tmp b ON a.pay_id =b.id  Into Cursor pay_cun_tmp
	
	

Else


	ssql="select a.*,b.desccn,b.descen from payway_print_detail a left join payway b  on a.pay_id=b.id  where a.pid=?_cfilename order by a.dispord"
	If SQLExec(nhand,ssql,"pay_cun_tmp")<0

		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	Endif

Endif


_changes_mark=""
Select pay_cun_tmp
Scan
	_changes_mark=Trim(pay_cun_tmp.changes_mark)
	_payamt=Iif(pay_cun_tmp.pay_other>0,"("+Alltrim(Str(pay_cun_tmp.pay_other,12,2))+Trim(pay_cun_tmp.changes_mark)+")"+Alltrim(Str(pay_cun_tmp.payamt,12,2)) ,Alltrim(Str(pay_cun_tmp.payamt,12,2)))
	
	_payway=IIF(cPrint_lange="CN",NVL(pay_cun_tmp.desccn,""),NVL(pay_cun_tmp.descen,""))
	
	&&Lihong 2022.08.19 ¤À±b
	IF EMPTY(pay_cun_tmp.payway)
		_payway = SPACE(6)+TRIM(_payway)
	ENDIF 
	
	Insert Into paylist_tmp (r_id,payway,cardno,payamt,tips,Changes,card_name) Values (nRid_pay,Trim(_payway),Trim(pay_cun_tmp.cardno), _payamt,pay_cun_tmp.tips,pay_cun_tmp.Changes,NVL(pay_cun_tmp.card_name,""))

*		INSERT INTO paylist_tmp (r_id,payway,cardno,payamt,tips,changes) VALUES (1,TRIM(pay_cun_tmp.payway),TRIM(pay_cun_tmp.cardno),pay_cun_tmp.payamt,pay_cun_tmp.tips,pay_cun_tmp.changes)

Endscan

*!*	_octpayamt=0

*!*	SELECT payamt FROM paylist_tmp  WHERE LOWER(payway)="octopus" INTO ARRAY tmp_s	 &&¤K¹F³q¥I´Úª÷ÃB
*!*	IF _tally>0


*!*		_octpayamt =VAL(tmp_s(1))

*!*	ENDIF



Select payway Distinct From paylist_tmp Into Array tmp_s
If _Tally>1

	_lbpayamt=getmessage("_paid_amt")+"("+Trim(__local_CURRENCY) +")"		&&¥I´Úª÷ÃB
	IF VARTYPE(_deposit_call_cashier_status) # "U" AND _deposit_call_cashier_status = 2  &&¤@¦¸©Ê­qª÷°h´Ú  By Waston 31/08/2023
		_lbpayamt=getmessage("_refund_amt")+"("+Trim(__local_CURRENCY) +")"		&&°h´Úª÷ÃB
	ENDIF 
ELSE 
	IF VARTYPE(_deposit_call_cashier_status) # "U" AND _deposit_call_cashier_status = 2  &&¤@¦¸©Ê­qª÷°h´Ú  By Waston 31/08/2023
		_lbpayamt=getmessage("_refund_amt") 		&&°h´Úª÷ÃB
	ENDIF 	
ENDIF



If Vartype(__pay_slip_print_disc)="L" And __pay_slip_print_disc	AND _deposit_pay_print=.F.	&&¬O§_¦L§é¦©¸ò³]©w &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷

*	IF VARTYPE(__paylist_data_save)#"U" AND __paylist_data_save=.f.		&&¦pªG¯Â¥»¾÷¤è¦¡¥´¦L

	If __pay_print_to_local

		Select * From pay_print_disc Into Cursor pay_cun_tmp

	Else

		ssql="select * from pay_print_disc  where pid=?_cfilename "
		If SQLExec(nhand,ssql,"pay_cun_tmp")<0
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

	Endif


	Select pay_cun_tmp
	Scan

		Insert Into inv_disc_tmp (r_id,descdisp,amt) Values (3,pay_cun_tmp.descdisp,pay_cun_tmp.amt)

	Endscan

Endif


Update inv_disc_tmp Set amt =amt * -1

Select inv_disc_tmp

Sum amt To _total_disc_amt


*------------------------------
_print_dept_analyse=.F.
_total_dept_qty=0
_total_dept_amt=0
_total_dept_real_amt=0
If Vartype(__paylist_print_dept_amt)#"U" And __paylist_print_dept_amt AND _deposit_pay_print=.F. &&2009.06.03 ¬O§_¦L³¡ªù¤À±b¸ò³]©w &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷

	If SQLExec(nhand,"select * from inv_detail where id=?_inv_id","cun_tmp8")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

	If SQLExec(nhand,"select * from itemdept","pay_cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

	If SQLExec(nhand,"select id,desccn,descen from department order by disporder","cun_tmp7")<0			&&cun_tmp7  ----department
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

	_print_dept_analyse=.T.
	Select cun_tmp7					&&department
	Scan
		Select inv_dept_tmp
		Append Blank
		Replace r_id  With 4,descdisp With Iif(_system_langue="CN",Trim(cun_tmp7.desccn),Trim(cun_tmp7.Descen)),Id With cun_tmp7.Id
	Endscan

	Use In cun_tmp7

	Select cun_tmp8
	Scan
		_item_Id=item_id

		Select dept_id,price_per From pay_cun_tmp Where item_id=_item_Id Into Cursor cun_tmp25
		Select cun_tmp25
		Scan			&&¼Æ¶q¤Îª÷ÃB§¡¤À±b

			Update inv_dept_tmp Set qty=qty+NVL(cun_tmp8.qty,1)*cun_tmp25.price_per/100 ,amt=amt+(cun_tmp8.real_amount+cun_tmp8.round_amount+cun_tmp8.xdisc)*cun_tmp25.price_per/100, ;
				dept_amt=dept_amt+(cun_tmp8.real_amount+cun_tmp8.round_amount+cun_tmp8.xdisc-cun_tmp8.srv_amount)*cun_tmp25.price_per/100, ;
				srv=srv+(cun_tmp8.srv_amount)*cun_tmp25.price_per/100 ;
				WHERE Id=cun_tmp25.dept_id


		Endscan

	Endscan

	If Used("cun_tmp25")

		Use In cun_tmp25
	Endif




	Delete From  inv_dept_tmp Where  qty=0		&&¼Æ¶q¬°¹s¤£²Î­p¡A¦ýª÷ÃB¬°¹s²Î­p

	Select inv_dept_tmp
	Sum qty,amt,srv,dept_amt To  _total_dept_qty, _total_dept_amt, _total_dept_srv_amt, _total_dept_real_amt

	Update inv_dept_tmp Set qty=Round(qty,1),amt=Round(amt,1),dept_amt=Round(dept_amt,1)



Endif

*-------------------------------------



If Isnull(_changes_mark)
	_changes_mark=__local_CURRENCY
Endif

_lbchange=_lbchange+ Iif(!Empty(_changes_mark),"("+_changes_mark+")","")


Select paylist_tmp
Sum Changes To 	_changeamt									&&§ä¦^

*		IF  !EMPTY(_octCid)

*			_changeamt=_octRemain		&&¤K¹F³q§EÃB

*		ENDIF

&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
IF VARTYPE(__same_table_print_mode)#"U" AND __same_table_print_mode="_split_table" AND _deposit_pay_print=.F. &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
	SELECT same_tableno FROM inv_print_tmp WHERE !EMPTY(same_tableno ) GROUP BY same_tableno INTO ARRAY tmp_s
	IF _tally<2
		REPLACE ALL same_tableno WITH "" IN inv_print_tmp
	ENDIF 
ELSE 
	REPLACE ALL same_tableno WITH "" IN inv_print_tmp
ENDIF 

Select	paylist_tmp
Index On r_id Tag pay

Select print_job_tmp
Set Relation To r_id Into paylist_tmp Additive
Set Relation To r_id Into inv_print_tmp Additive
Set Relation To r_id Into inv_disc_tmp Additive
Set Relation To r_id Into inv_dept_tmp Additive

_filename=Sys(2015)+ALLTRIM(TRANSFORM(INT(RAND()*10000000)))
_frx_file=_filename+".frx"
_frt_file=_filename+".frt"

IF  EMPTY(_kisstxid)=.f.  AND File("Report\paylist_kiss.frx")

		Copy File Report\paylist_kiss.frx To &_frx_file		&&´_¨î³øªí
		Copy File Report\paylist_kiss.frt To &_frt_file

ELSE


	If cPrint_lange="EN" And File("Report\paylist_en.frx")

		Copy File Report\paylist_en.frx To &_frx_file		&&´_¨î³øªí
		Copy File Report\paylist_en.frt To &_frt_file

	Else

		Copy File Report\paylist.frx To &_frx_file		&&´_¨î³øªí
		Copy File Report\paylist.frt To &_frt_file

	Endif

ENDIF


*!*	Copy File d:\paylist.frx To &_frx_file		&&´_¨î³øªí
*!*	Copy File d:\paylist.frt To &_frt_file


*----------
Select 0
Use &_frx_file
Replace Expr With "" ,Tag With "",tag2 With "" For objtype=1 And objcode=53		&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m
Use

*----------

Local nprint,k
nprint=1
If Vartype(nPrint_time)="N"

	nprint=nPrint_time
Endif

For k=1 To nprint

	Select	print_job_tmp
	Go Top
	_error=0
*!*		TRY
	Set Printer To Name &cprinter

	If __debug_mode  &&OR  _vfp.StartMode=0

		Report Form "&_frx_file" To Printer  Nodialog  Preview	&& 23456

	Else

		Report Form "&_frx_file" To Printer  Nodialog Noconsole  && preview	&& 23456

	Endif

*!*		CATCH TO Oerror
*!*			 _error=-1
*!*		ENDTRY

	If _error=-1
		write_log(184,"Fail to Print PayList!")
		*Return -1
	Endif

Endfor



write_log(184,"Success to Print PayList!")


*!*			TEXT TO ssql noshow		&&§Y®É§R°£
*!*				delete from inv_print_main where pid=?_cfilename
*!*				delete from inv_print_detail where pid=?_cfilename
*!*				DELETE FROM inv_Print_disc WHERE  pid=?_cfilename
*!*
*!*			ENDTEXT
*!*			=SQLEXEC(nhand,ssql)

_filename=_filename+".*"
Delete File  &_filename   &&§R°£¬ÛÃöªºÁ{®É¤å¥ó
TRY 
	IF !EMPTY(QRcode_file)
		DELETE FILE &QRcode_file
	ENDIF
	IF !EMPTY(QRcode_file_for_storellet)
		DELETE FILE &QRcode_file_for_storellet
	ENDIF
	IF !EMPTY(QRcode_file_for_MobileCard)
		DELETE FILE &QRcode_file_for_MobileCard
	ENDIF
	IF !EMPTY(QRcode_file_pay)
		DELETE FILE &QRcode_file_pay
	ENDIF
CATCH
ENDTRY 

Select pay_print_tmp1

Return 1

Endfunc


*************************************
*²Õ¦XÀu´f §Ö³t­pºâ

Function level_rule_check		&&

If Vartype(__Level_check_disable)="U"

	On Error Return
	level_rule_check_express()

	On Error error_catch(getmessage("_proc_error"),Error(),Message(),Program(),Lineno(1))



Endif



Return


Endfunc


***********************
*	FUNCTION check_booking
*	¹w­qÀË¬d
*********************

Function check_booking

Lparameters  _ctableno

If Vartype(_ctableno)="C"
	ssql="select tableno from tables where tableno=?_ctableno"
Else

	ssql="select tableno from tables where booking_list<>'' "

Endif

If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

Select cun_tmp
Scan

	_ctableno=Trim(cun_tmp.tableno)

	ssql="select id from table_booking where tableno=?_ctableno and datediff(minute,book_time,getdate())<?__table_booking_disable_time  and void=0 and used=0"

	If SQLExec(nhand,ssql,"cun_tmp1")<0

		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	Local _booking_list
	_booking_list=""

	Select cun_tmp1
	Scan

		_booking_list = _booking_list +Alltrim(Str(cun_tmp1.Id))+","

	Endscan

	If SQLExec(nhand,"update  tables set booking_list=?_booking_list where tableno=?_ctableno")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

Endscan


Return 1

*********************
* Function slip_local_Print
*¤Wµæ¯È¥»¦a¥´¦L
*
***********************
Function slip_local_print
Lparameters _cfilename,cprinter

_station=getcomputername()	&&¥u¨ú·í«estation©ÒºÞ²zªºprinterªº¥´¦L¾÷

If _slip_print_to_local		&&¥»¦a¦C¦L¤è¦¡

	Select  * From  slip_print_main  Into Cursor slip_print_tmp1

Else

	ssql="select  * from  slip_print_main   where pid=?_cfilename"

	If SQLExec(nhand,ssql,"slip_print_tmp1")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif

Endif


If Reccount("slip_print_tmp1")=0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

ENDIF

_report_Training=slip_print_tmp1.training		&&¬O§_°V½m¼Ò¦¡

cnotice=Iif(_report_Training,getmessage("_training"),"")

cqty=getmessage("_qty")						&&¼Æ¶q
cItem=getmessage("_invitem")				&&¶µ¥Ø
camt=getmessage("_amount")						&&ª÷ÃB
ctotal=getmessage("_total")			&&¦@
ctotalamt=getmessage("_slip_total_amount")	&&¦@ª÷ÃB

_printtime=Datetime()
_username=Trim(slip_print_tmp1.username)

_sittime = TTOC(slip_print_tmp1.sittime)


_total_item = Iif(slip_print_tmp1.nitem>0,ctotal+" "+Alltrim(Str(slip_print_tmp1.nitem))+" "+cItem,"")		&&¦@:N¶µ¥Ø

_total_item_qty  = Iif( VARTYPE(_nitem2)#"U" AND _nitem2>0,ctotal+" "+Alltrim(Str(_nitem2))+" "+cItem,"")


_cPplCnt=Alltrim(Str(slip_print_tmp1.pplcnt))				&&¤H¼Æ
_ctableno_ppl=Alltrim(slip_print_tmp1.tableno)+" / "+Alltrim(Str(slip_print_tmp1.pplcnt))+" "+getmessage("_Cover")				&&À\Âi(¥s¸¹)/¤H¼Æ (¦ì)



_lbsubtotalamt=getmessage("_subtotalamt")	&&¤p­p
_lbdiscount=getmessage("_discount")		&&§é¦©
_lbServiceFee=getmessage("_svr_charge")	&&ªA°È¶O

_lbtaxfee=getmessage("_taxfee")		&&µ|¶µ			*2010.03.27
_lbxdisc=getmessage("_xdisc")		&&²Õ¦XÀu´f
_lbadjust=getmessage("_rounding")		&&·L½Õ
_lbtotalamt=getmessage("_totalamt")	&&Á`ª÷ÃB

_lbseattime=getmessage("_seattime")		&&¤J®y®É¶¡
_lbprinttime=getmessage("_printtime")		&&µ²±b®É¶¡


_tel=Iif(Isnull(slip_print_tmp1.tel),"",Alltrim(slip_print_tmp1.tel))			&&¹q¸Ü
_addr=Iif(Isnull(slip_print_tmp1.address),"",Alltrim(slip_print_tmp1.address))		&&¦a§}

Private  _tableno,_tableno1
_tableno=Trim(slip_print_tmp1.tableno)+Space(1)+Trim(slip_print_tmp1.rem)
_tableno1=Trim(slip_print_tmp1.tableno)


*	_barcodetxt=IIF(slip_print_tmp1.barcode,REPLICATE("0",8-LEN(ALLTRIM(STR(slip_print_tmp1.order_id))))+ALLTRIM(STR(slip_print_tmp1.order_id)),"")	&&±ø½Xcode
*	_barcode=IIF(slip_print_tmp1.barcode,"*"+_barcodetxt+"*","")	&&±ø½X
_barcodetxt=Padl(Alltrim(Str(ABS(slip_print_tmp1.order_id))),6,"0")
_barcode="*"+_barcodetxt+"*"	&&±ø½X(¤@©w¦L)

_def_printer=cprinter	&&¥´¦L§@·~ªº­ì©w¥´¦L¾÷
_change_station=.F.		&&¬O§_¦s¦bstation¤§¶¡ªºÂà¦V


If slip_print_tmp1.discamt<>0
	_disc_amount=getmessage("_discount")+":"+Alltrim(Str(slip_print_tmp1.discamt,10,2))		&&§é¦©ª÷ÃB
Else
	_disc_amount=""
Endif

*_subtotalamt=slip_print_tmp1.amount	+slip_print_tmp1.itemdiscamt		&&¤p­p ------------2010.03.27

*SET STEP ON 

_subtotalamt=slip_print_tmp1.amount  &&+ slip_print_tmp1.itemdiscamt  + slip_print_tmp1.discamt		&&¤p­p ------------2011.06.14

_discount= (slip_print_tmp1.discamt +	slip_print_tmp1.itemdiscamt	) &&* -1					&&§é¦©

*MESSAGEBOX(_discount)

_servicefee=slip_print_tmp1.srvamt							&&ªA°È¶O
_taxfee=slip_print_tmp1.taxamt								&&µ|¶µ

_xdisc=0													&&²Õ¦XÀu´f									**(unfinish)
_adjust=slip_print_tmp1.rndamt								&&¹sÀY

&&Lihong 2020.11.20 ¤Wµæ¯È«ösetting¤£¥´ª÷ÃB §ï¬°¤U¦æ _totalamt=slip_print_tmp1.invamt							&&¦X­pª÷ÃB
_totalamt = IIF(vartype(__slip_print_Item_amount)="U" or __slip_print_Item_amount or VARTYPE(llfastfood_order_do_pre)#"U", slip_print_tmp1.invamt, null)

cFastFood_info=Trim(Nvl(slip_print_tmp1.fastfood_info,""))		&&§ÖÀ\«H®§		2010.03.29

&&Lihong 2022.01.10 PSO_ORDER_SAVE_INV_ONLINE¤Wµæ¯È¥´¦L¥I´Ú«H®§
_PSO_ORDER_SAVE_INV_payway = ""
IF VARTYPE(_vs_payway) = "C" AND !EMPTY(_vs_payway)
	_lbpayway=getmessage("_payway")			&&¥I´Ú¤è¦¡
	_PSO_ORDER_SAVE_INV_payway = _lbpayway + " : " + _vs_payway
ENDIF 


If !Empty(slip_print_tmp1.member_name)
	_memb_info=getmessage("_member")+":"+Trim(slip_print_tmp1.member_name) + " / " +getmessage("_cardno")+":"+Trim(slip_print_tmp1.member_no)				&&·|­û

Else

	_memb_info=""

Endif



Select * From slip_print_detail Into Cursor slip_print_tmp Readwrite


IF VAL(__mult_langue_code)<1000

Update slip_print_tmp Set  item_unicode= Strconv(Strconv(Trim(item_unicode),14),11,Val(__mult_langue_code),1)	Where !Empty(item_unicode) &&Âà¬°DBCS

ENDIF


_image=Fullpath("ico\invlogo.bmp")

If !File(_image)
	_image=""
Endif


_from_printer=""

_frx_file=Upper(_cfilename+".frx")
_frt_file=Upper(_cfilename+".frt")
Copy File Report\orderlist.frx To &_frx_file		&&´_¨î³øªí
Copy File Report\orderlist.frt To &_frt_file

*!*	Copy File d:\orderlist.frx To &_frx_file		&&´_¨î³øªí
*!*	Copy File d:\orderlist.frt To &_frt_file




*----------
Select 0
Use &_frx_file 
Replace Expr With "" ,Tag With "",tag2 With "" For objtype=1 And objcode=53		&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m
Use

Local _print_error,_error_msg

Select slip_print_tmp
Go Top

IF VARTYPE(QRcode_file)="U" 
	QRcode_file ="" 	&&Lihong 2023.06.09
ENDIF 
If Vartype(_preview_slip_html)#"U"	 Or Vartype(_html_fileName)="C" 		&& ¥Í¦¨HTML

	If File("__slip_tmp.html")
		Delete File __slip_tmp.html
	Endif

	Set Library To xfrxlib.fll
	Local loxfrx
	loxfrx = XFRX("XFRX#LISTENER")
	loxfrx.DoNotOpenViewer=.T.  &&¤£Åã¥Ü¹wÄý
	
	loxfrx.targetType =IIF(Vartype(_html_fileName)="C", "HTML", "XFF")
	
	_outfile= Iif(Vartype(_html_fileName)="C", Fullpath(_html_fileName) , "__slip_tmp.xff")
	
	loxfrx.targetFileName =_outfile
	lnRetval = loxfrx.setparams()
	If lnRetval = 0
		Try
			Report Form  "&_frx_file"   Object loxfrx Nodialog					&&¥Í¦¨html¤å¥ó --->2010.07.05  §ó§ï¬°¿é¥Xxff¤å¥ó

		Catch To oError


		Endtry


		Release loxfrx
	Endif

	_filename=_cfilename+".*"
	Delete File  &_filename   &&§R°£¬ÛÃöªºÁ{®É¤å¥ó

Else

	Release poFbc
	poFbc = Createobject("FoxBarcode")

	poFbc.cImageType = "JPG"
	poFbc.nBarcodeType = 121

*	poFBC.nImageHeight=203
	poFbc.nResolution = 203

*	poFbc.nFactor = 1
*	poFbc.nmargin = 1

*	pofbc.nbaRCODETYPE=121	&& code 39

*	poFBC.nResolution = 203

*	pofbc.nFactor = 1
*	pofbc.nMARGIN=1
*	pofbc.nImageHeight = 80
	lcError=""
	Try
		Set Printer To Name (cprinter)					&&¿é¥X¥´¦L
		If __debug_mode &&OR  _vfp.StartMode=0

			Report Form (_frx_file) To Printer Nodialog Noconsole Preview   && 123321
		Else

			Report Form (_frx_file) To Printer Nodialog Noconsole

		Endif


	Catch To oError
		_print_error=.T.

			lcError=oError.message

	ENDTRY
	
	If !EMPTY(lcError)
		
		messagebox(lcError,48,"",5000)
		
		
		Return -1
	Endif

Endif

_filename=_cfilename+".*"
Delete File  &_filename   &&§R°£¬ÛÃöªºÁ{®É¤å¥ó

If Used("slip_print_tmp")
	Use In slip_print_tmp

Endif

If Used("slip_print_tmp1")
	Use In slip_print_tmp1

Endif


Return 1

Endfunc
******************************
*	¤K¹F³q¼W­È
*
Function octopus_add_value

nAddvalue=0
nPayamt=0
Do Form Form\work_cashier_octopus_addvalue With nAddvalue
If nAddvalue=0
	Return

Endif
nPayamt=nAddvalue		&&Â²³æ¤èªk,¼W­Èª÷ÃB=¥I´Úª÷ÃB (update in 1/2/2008)

Local nchanges
nchanges=nPayamt-nAddvalue

Local _Coctopus
_Coctopus=getmessage("_octopus")

*_computer=getcomputername()

If SQLExec(nhand,"select id,desccn,descen from payway  where dispord=1","cun_tmp")<0		&&¨ú²Ä¤@­Ó¥I´Ú¤è¦¡¬°¹w³]ªº¥I´Ú¤è¦¡
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return

Endif

Local _def_pay_id,_def_payway
_def_pay_id=cun_tmp.Id
_def_payway=Iif(_system_langue="CN",Trim(cun_tmp.desccn),Trim(Descen))

*!*	csql="select printer from printerset  where id=?__payslip_printer "		&&¨ú±o®I¸}¯Èªº¥´¦L¾÷
*!*	If SQLExec(nhand,csql,"cun_tmp1")<0
*!*		Aerror(err)
*!*		Sqlrollback(nhand)
*!*		SQLSetprop(nhand,"Transactions" ,1)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		Return

*!*	ENDIF

Local cprinter
*cprinter=Trim(cun_tmp1.Printer)

cprinter=__sys_pay_printer

*_pay_print_to_local=check_local_printer(cprinter)

*!*	Aprinters(prn)					&&¥´¦L¾÷¬O§_¥»¾÷¦L¾÷
*!*	If Vartype(prn)#"U"

*!*		_pay_print_to_local=((Ascan(prn,cprinter)>0 Or  Ascan(prn,Lower(cprinter))>0)  And __inv_local_print)		&&¬O§_ªö¥Îª½±µ¤è¦¡¥´¦L
*!*	Else
*!*		_pay_print_to_local=.F.
*!*	ENDIF



*!*	IF SQLEXEC(nhand,"select id from station where computer=?_computer","cun_tmp")<0
*!*			aerror(err)
*!*			error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))

*!*		RETURN
*!*	ENDIF

_station_id=__station_id

_belongdate=getbelongdate()

ssql="select ISNULL(MAX(id),0)  as max_inv_id  from inv"
If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif
_invID=cun_tmp.max_inv_id+1		&&¨ú±o³Ì¤jªºµo²¼¸¹

ssql="select MAX(updateno) as max_updateno from  inv"					&&
If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif
_updateno=Iif(Isnull(cun_tmp.max_updateno),1,cun_tmp.max_updateno+1)


=SQLSetprop(nhand,"Transactions",2)

				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						

_inv_prt_time = DATETIME()
TEXT TO ssql noshow
INSERT INTO [inv]
           ([id]
           ,[tableno]
           ,[askno]
           ,[pplcnt]
           ,[begintime]
           ,[orgamt]
           ,[amount]
           ,[modiamt]
           ,[itemdiscamt]
           ,[srvamt]
           ,[taxamt]
           ,[rndamt]
           ,[discamt]
           ,[invamt]
           ,[tips]
           ,[paidamt]
           ,[cashed]
           ,[autocash]
           ,[memberno]
           ,[cln]
           ,[clntime]
           ,[void]
           ,[voidreason]
           ,[voidtime]
           ,[voiduser]
           ,[xid]
           ,[paidtime]
           ,[belongdate]
           ,[fastfood]
           ,[adduser]
           ,[station_id]
           ,[outlet_id]
           ,[tel]
           ,[endtime]
           ,[link_table]
           ,[void_id]
           ,[octopus]
           ,[updateno]
           ,inv_prt_time
           ,inv_prt_station_id
           ,inv_prt_login_user_id
           ,inv_prt_cashier_user_id)
     VALUES
           (?_invID
           ,''
           ,''
           ,1
           ,getdate()
           ,?naddvalue
           ,?naddvalue
           ,0
           ,0
           ,0
           ,0
           ,0
           ,0
           ,?naddvalue
           ,0
           ,?npayamt
           ,1
           ,1
           ,0
           ,0
           ,''
           ,0
           ,''
           ,''
           ,''
           ,0
           ,?DATETIME()
           ,?_belongdate
           ,0
           ,?_login_user_name
           ,?_station_id
           ,0
           ,''
           ,?DATETIME()
           ,''
           ,0
           ,1
           ,?_updateno
           ,?_inv_prt_time
           ,?__station_id
           ,?__login_user_id
           ,?__cashier_user_id)


ENDTEXT


If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

&& -8 ¬°¤K¹F³q ªºitem_id
Local _descdisp
_descdisp=getmessage("_octopus_add_value")

ssql="insert into inv_detail (id,uid,parent_id,item_id,item_code,cate_id,descdisp,"+;
	"qty,price,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_per,srv_per_org,srv_amount,tax_per,tax_amount,"+;
	"xdisc,sitem,sitem_sub,mitem,printed,printtime,adduser,level_id,recused,xid,level_disc,handwriting)  "+;
	" values (?_invID,1,0,-8,'',0,?_descdisp,"+;
	"1,?nAddvalue,?nAddvalue,?nAddvalue,?nAddvalue,0,0,0,0,0,0,0,0,"+;
	"0,0,0,0,0,'',?_login_user_name,0,0,0,0,0)"

If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif


TEXT TO ssql noshow			&&¥I´Ú¤è¦¡(²{ª÷)

	INSERT INTO [pay_detail]
	           ([Id]
	           ,[pay_id]
	           ,[payway]
	           ,[qty]
	           ,[cardno]
	           ,[payamt]
	           ,[netamt]
	           ,[changes]
	           ,[tips]
	           ,[dispord]
	           ,[rate]
	           ,[changes_id]
	           ,[pay_others]
	           ,[oct_device_id]
	           ,[oct_card_id]
	           ,[oct_remain])
	     VALUES
	           (?_invID
	           ,?_def_pay_id
	           ,?_def_payway
	           ,1
	           ,''
	           ,?npayamt
	           ,?npayamt
	           ,?nchanges
	           ,0
	           ,1
	           ,1
	           ,?_def_pay_id
	           ,0
	           ,''
	           ,''
	           ,0)

ENDTEXT

If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif


If Sqlcommit(nhand)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

SQLSetprop(nhand,"Transactions",1)

Release _octopus_device_ID,_octopus_card_ID,_octopus_remain_value

Do Form Form\work_cashier_octopus.scx With "add_value",nAddvalue,_invID To lreturn

If Vartype(lreturn)#"C"
	lreturn="cancel"
Endif

If lreturn="cancel"		&&¦pªG¼W­È¤£¦¨¥\,void inv

	ssql="select MAX(updateno) as max_updateno from  inv"					&&
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)

		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return

	Endif
	_updateno=Iif(Isnull(cun_tmp.max_updateno),1,cun_tmp.max_updateno+1)

	ssql="select MAX(void_id) as max_id from order_void"
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return

	Endif

	_void_id=Iif(Isnull(cun_tmp.max_id	),1,cun_tmp.max_id+1)
	_void_reason=''

	ssql="update inv set void=1,void_id=?_void_id,voidreason=?_void_reason,voidtime=getdate(),voiduser=?_login_user_name,updateno=?_updateno where Id=?_invId"		&&¨ú®øµo²¼
	ssql=ssql+Chr(10)+"insert into order_void select '',id,item_id,descdisp,qty,price,amount,adduser,?_void_reason,printtime,getdate(),?_belongdate,modi_amount,disc_amount,srv_amount,sitem,sitem_sub,handwriting,0,?_station_id,?_void_id"+;
		",(select order_uid from inv where id=?_invID),uid,item_code,0,'' from inv_detail where id=?_invID"

*	ssql=ssql+Chr(10)+"update updateno set max_updateno=max_updateno+1 where table_name='order_void'  "

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return

	Endif

Else		&&¼W­È¦¨¥\,¥I´Ú²M³æ

	_pay_user_name = __cashier_user_name
	IF __cashier_user_id = __login_user_id
		_pay_user_name = __cashier_user_name
	ELSE 
		_pay_user_name = TRIM(__cashier_user_name) + " / " + _login_user_name
	ENDIF 

	_Pid="PAY"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")					&&ÀH¾÷½X,«e­±ªº"PAY"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î

	If __inv_print_to_local



		If SQLExec(nhand,"select * from inv where id=?_invID","cun_tmp")<0

			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return

		Endif

		_table_info=''
		_printer=cprinter
		_pplcnt=1
*		_inv_print_to_local=.T.

		If gen_local_paylist_data(_invID)<0

			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			Return

		Endif

		Select  payway_print_detail		&&·s¥x
		Go Top
		If Eof()

			Insert Into payway_print_detail(payway,cardno,payamt,tips,Changes,dispord,pay_other,changes_mark) Values (_def_payway,'',nPayamt,0,nchanges,1,0,__local_CURRENCY)	&& ¥I´Ú²Ó¸`(¥´¦L¥Î)


		Endif

	Else


		&&&&username _login_user_name -> __cashier_user_name
		ssql="insert into pay_print_main (pid,inv_Id,tableno,pplcnt,printer,def_printer,act_printer,printed,sendtime,printtime,username,station_id,langue,fastfood,print_adduser,invamt,paidamt,tips,training,oct_device_id,oct_card_id,oct_remain)"+;	&&¥´¦L
		" values (?_pid,?_invID,'',1,?cprinter,?cprinter,'',?__pay_print_to_local,getdate(),'',?_pay_user_name,?_station_id,?_system_langue,"+;
			"0,?__slip_print_adduser,?naddvalue,?npayamt,0,?GL_training,?_octopus_device_ID,?_octopus_card_ID,?_octopus_remain_value)"
		ssql=ssql+Chr(10)+"update pay_detail set oct_device_id=?_octopus_device_ID,oct_card_id=?_octopus_card_ID,oct_remain=?_octopus_remain_value where id=?_invID"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return
		Endif

		ssql="insert into pay_print_detail (pid,same_tableno,item,qty,amt,free) values (?_pid,'',?_descdisp,1,?naddvalue,0)"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return
		Endif


		ssql="insert into payway_print_detail(pid,payway,cardno,payamt,tips,changes,dispord,pay_other,changes_mark) values (?_pid,?_def_payway,'',?npayamt,0,?nchanges,1,0,?__local_currency)"		&& ¥I´Ú²Ó¸`(¥´¦L¥Î)

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return
		Endif

	Endif


	If  __pay_print_to_local					&&¦L¥I´Ú²M³æ(¨t²Î³]©w) ¤K¹F³q¤@©w¦L

*	If __print_pay_slip	And _pay_print_to_local=.T.						&&¦L¥I´Ú²M³æ(¨t²Î³]©w)
&&¦pªGª½¦L¡Aµo°e¦Ü¥»¦a¥´¦L

		write_log(184)
		paylist_local_print(_Pid,cprinter)

	Endif


Endif



Endfunc


*******************
*	FUNCTION OPEN_DRAWER
*
*	¼u¿ú½c
********************
Function open_drawer
Lparameters cprinter

Local _printer_model

If Vartype(__drawer_printer_style)="U"

	_printer_model="TM88"						&&¹w³]¬°TM-88

Else
	_printer_model=__drawer_printer_style

Endif

Set Printer To
Set Printer To Name (cprinter)

If _printer_model="TSP700"

	HY_SendStringPrint(cprinter,Chr(27)+Chr(7)+Chr(11)+Chr(55)+Chr(7))

Else

	=HY_SendStringPrint(cprinter,Chr(27) + Chr(112) + Chr(0) + Chr(50) + Chr(100))

Endif


Set Printer To


Return


*!*	Do Case

*!*		Case  _printer_model="TM88"					&&EPSON TM-88
*!*


*!*			???Chr(27)+Chr(112)+"0,4"
*!*


*!*		Case  _printer_model="TSP700"

*!*	*		???Chr(27)+Chr(7)+Chr(11)+Chr(55)+Chr(7)		&&STAR TSP700

*!*		=HY_SendStringPrint(cprinter,CHR(27) + CHR(112) + CHR(0) + CHR(50) + CHR(100))


*!*	Endcase

*!*	Set Printer To




Endfunc


Function HY_SendStringPrint( tcPrintName, tcSendString )
Local lcPrintName, lcSendString, IsOK
Local lnPrinter, lcStr, lnLen, lnMem

* get printer
If Type("m.tcPrintName")="C" And !Empty(m.tcPrintName)
	m.lcPrintName = m.tcPrintName
Else
	m.lcPrintName = Set([Printer],2)
Endif

* command
If Type("m.tcSendString")="C" And !Empty(m.tcSendString)
	m.lcSendString = m.tcSendString
Else
	m.lcSendString = Chr(27)+Chr(112)+Chr(0)+Chr(1)+Chr(2)
Endif

* declare dll
Declare Integer LocalAlloc In win32api Integer,Integer
Declare Integer LocalFree In win32api Integer
Declare Integer memcpy In msvcr71 As CopyMemo Integer Dest,String Source,Integer Length

Declare Integer OpenPrinter In Winspool.drv String pPrinterName, Integer @phPrinter, Integer pDefault
Declare Integer ClosePrinter In Winspool.drv Integer hPrinter
Declare Integer WritePrinter In Winspool.drv Integer hPrinter, String pBuf, Integer cdBuf, Integer @pcWritten
Declare Integer StartDocPrinter In Winspool.drv Integer hPrinter, Integer nLevel, String cDocInfo
Declare Integer EndDocPrinter In Winspool.drv Integer hPrinter

* send ccm
m.IsOK = .F.
m.lnPrinter = 0
If OpenPrinter(m.lcPrintName, @lnPrinter, 0) <> 0
*
	m.lcStr = "rms6"
	m.lcStr = Strconv(m.lcStr,5)
	m.lnLen = Len(m.lcStr)
	m.lnMem = LocalAlloc(0,m.lnLen)
	= CopyMemo(m.lnMem, m.lcStr, m.lnLen)
	m.lcStr = BinToC(m.lnMem,"4rs")+BinToC(0,"4rs")+BinToC(0,"4rs")
	m.lnLen = Len(m.lcStr)
	If StartDocPrinter(m.lnPrinter,1,m.lcStr) <> 0
*
		If WritePrinter(m.lnPrinter, m.lcSendString, Len(m.lcSendString), 0) <> 0
			m.IsOK = .T.
		Endif
	Endif
*
	= EndDocPrinter(m.lnPrinter)
	= ClosePrinter(m.lnPrinter)
	= LocalFree(m.lnMem)
Endif

Clear Dlls "LocalAlloc","LocalFree","CopyMemo","OpenPrinter","ClosePrinter","WritePrinter","StartDocPrinter"
Return m.IsOK
Endfunc






***************************
* FUNCTION GetNetStatus
*	 §PÂ_ºôµ¸¬O§_¥¿±`
*
***************************
Function GetNetStatus

Declare Long InternetGetConnectedStateEx In "wininet.dll" Long @, String@, Long, Long

Install = 0
nName = Space(513)
Local nReturn
nReturn= InternetGetConnectedStateEx(@Install, @nName, 512, 0)

Clear Dlls InternetGetConnectedStateEx

Return nReturn


Endfunc

*-----------------------------------------------------
Function  check_server_running
If Vartype(_Screen.chkdog)#"U"

	Set Library To dog.Dll
	If chkdog()<0
		
		fmessagebox("_netware_error_no_use")		&&°h¥X«e´£¥Ü ¡A2014.
	
		Clear Events
		Quit

	Endif
	Release Library dog.Dll


Endif

Return

If Vartype(__server_canuse_on_netError)="U"
	Return
Endif

If __ismain_server  And __server_canuse_on_netError =.F.  		&&¦pªG¬O¥DªA°È¾¹,ºôµ¸¤¤Â_(¦pÂ_½u),¤£¤¹³\¨Ï¥Îrms6

	If GetNetStatus()<=0

		fmessagebox("_netware_error_no_use")

		Clear Events
		Quit


	Endif


Endif


Endfunc

*******************************************************************************************
*!* Åª¨ú¦Û©w¸qINI¤å¥ó¡C¨C­Ó¦r²Å¦ê¦Z¥²¶·¦³¤@­ÓªÅ¦r²ÅCHR(0).
*!* lcReturned«eªº"@"¤£¯à¬Ù¡A§_«h¥X¿ù
*!* lcSection - INI¤å¥óªº¶µ¦W
*!* lcKey - INI¤å¥óªºÁä­È
*!* lcDefault - ¾Þ§@¥¢±Ñªð¦^«H®§
*!* lcReturned - ªð¦^¦r²Å¦ê¤º¦sÅÜ¶qªº¥y¬`
*!* liSize - lcReturned¥e¤º¦sªº¤j¤p
*!* lcFile - INI¤å¥óªº¸ô®|©M¤å¥ó¦W
*!* lnSize - ªð¦^¦r²Å¦êªº¦r¸`¼Æ
*******************************************************************************************
Function ReadINI
Lparameter lcFile, lcSection, lcKey

Local lcDefault, lcReturned, liSize, lnSize
If Type("lcSection") # "C" Or Type("lcKey") # "C" Or Type("lcFile") # "C"
	Return ""
Endif
lcSection = lcSection + Iif(Right(lcSection,1) = Chr(0),"",Chr(0))
lcKey = lcKey + Iif(Right(lcKey,1) = Chr(0),"",Chr(0))
lcDefault = "" + Chr(0)
lcReturned = Space(2048) + Chr(0)
liSize = 2048
lcFile = lcFile + Iif(Right(lcFile,1) = Chr(0),"",Chr(0))
Declare Integer GetPrivateProfileString In WIN32API As GetPrivStr String, String, String, String@, Integer, String
lnSize = GetPrivStr(lcSection,lcKey,lcDefault,@lcReturned,liSize,lcFile)
lcReturned = Left(lcReturned,lnSize)
Clear Dlls GetPrivStr
Return lcReturned

Endfunc


***********************************************************************************************
*!* ¼g¦Û©w¸qINI¤å¥ó¡C¥\¯à¡G¦V«ü©wªºSection©M Key¼g¤JKeyValue¡C¨C­Ó¦r²Å¦ê¦Z¥²¶·¦³¤@­ÓªÅ¦r²ÅCHR(0).
*!* lcReturned«eªº"@"¤£¯à¬Ù¡A§_«h¥X¿ù
*!* lcFile - INI¤å¥ó¦W
*!* lcSection - INI¤å¥óªº¶µ
*!* lcKey - INI¤å¥óªºÁä
*!* lcString - Áäªº½á­È
*!* ¦pªGlcString¬°NULL¡A«h§R°£·í«elcKey
*!* ¦pªGlcKeyÉOlcString¨âªÌªº­È³£¬°NULL¡A«h§R°£·í«eSection¥H¤Î¨ä¤Uªº©Ò¦³Key
*!* ¦pªGSection©ÎªÌKey¤£¦s¦b¡A«h³Ð«Ø¡F¦s¦b«hÂÐ»\
*!* ¼g¦¨¥\«hªð¦^¯u¡].T.¡^¡A«h§_ªð¦^°²¡].F.¡^
*******************************************************************************************
Function WriteINI
Lparameter lcFile, lcSection, lcKey, lcString

Local lnResult
If Type("lcFile") # "C" Or Type("lcSection") # "C"	&& TYPE("lcKey") # "C" OR TYPE("lcString") # "C"
	Return .F.
Endif

lcFile = lcFile + Iif(Right(lcFile,1) = Chr(0),"",Chr(0))
lcSection = lcSection + Iif(Right(lcSection,1) = Chr(0),"",Chr(0))

If Not Isnull(lcKey)
	lcKey = lcKey + Iif(Right(lcKey,1) = Chr(0),"",Chr(0))
Endif
If Not Isnull(lcString)
	lcString = lcString + Iif(Right(lcString,1) = Chr(0),"",Chr(0))
Endif


Declare Integer WritePrivateProfileString In WIN32API As WritePrivStr String, String, String, String
lnResult = WritePrivStr(lcSection,lcKey,lcString,lcFile)
Clear Dlls WritePrivStr
Return (lnResult=1)

Endfunc


**************************************************************************
*!* ³Ð«Ø¤@­Ó¥]§t¸ô®|ªºINI¤å¥ó¡A¸Ó¤å¥óªº¤º®e¬°ªÅ¡F
*!* ³Ð«Ø¦¨¥\«hªð¦^¯u¡].T.¡^¡A§_«hªð¦^°²¡].F.¡^
*!* lcFile - INI¤å¥óªº¸ô®|©M¤å¥ó¦W
*************************************************************************
Function CreateINI
Lparameters lcFile

Private lcSafety,lnHandle
Local lcSafety,lnHandle
If Upper(Justext(lcFile)) <> "INI"
	lcFile = Addbs(Justpath(lcFile)) + Juststem(lcFile) + ".INI"
Endif
lcSafety = Set("Safety")
llSuccess = .F.
Set Safety Off
If File(Trim(lcFile)) = .T.
	lnHandle = Fopen(Trim(lcFile))
	If lnHandle < 0
		Return .F.
	Else
		= Fclose(lnHandle)
	Endif
Endif
= Strtofile("",lcFile)
If Upper(lcSafety) == "ON"
	Set Safety On
Endif
Return .T.

Endfunc


*************************************
*M ¿ï N
*
***********************************
Function all_group
Lparameters sn,dn,IsCreate

Local i,k,cItem

Dimension s(sn)
For i=1 To sn
	s(i)=Alltrim(Str(i))+"M"
Endfor

Dimension d(dn)

For i=1 To dn
	d(i)=Alltrim(Str(i))+"N"

Endfor

Create Cursor  g_tmp  ( Item c(20))

m=0
For i=1 To sn

	For k=1 To dn
		cItem=s(i)+"-"+d(k)


		Insert Into  g_tmp (Item) Values (cItem)

	Endfor

Endfor

Dimension tc(Reccount("g_tmp"))
i=1
Select g_tmp
Scan
	tc(i)=Trim(Item)
	i=i+1
Endscan



pn=Min(sn,dn)		&& ²Õ¦Xªº¤è¦¡(¨C¦¸²Õ¦Xªº¹ï¼Æ)

GetCombinations(pn,@tc)

Use In g_tmp
Use In g_tmp2

Select g_tmp1

If IsCreate		&&«Ø¥ß¤½¦¡¤å¥ó
	Local _xml_file
	_xml_file="rule\"+Alltrim(Str(sn))+"_"+Alltrim(Str(dn))+".xml"
	Cursortoxml("g_tmp1",_xml_file,3,512)

Endif


Endfunc


Function  GetCombinations(tcSize, tcSet)
Create Cursor g_tmp1 (items c(254))
Create Cursor g_tmp2 (item1 c(10),item2 c(10))

Local lnMembers, lnCounter, lnTemp
lnMembers = Alen(tcSet)
Dimension aryIndice(lnMembers)
aryIndice = 0
Do While .T.
	If aryIndice(1) < 1
		lnCounter = 1
		For lnCounter = 1 To tcSize
			aryIndice(lnCounter) = lnCounter
		Endfor

		CreateString(lnMembers, @tcSet, @aryIndice)


		Loop
	Else
		lnCounter = tcSize &&- 1
		Do While lnCounter >= 1 And aryIndice(lnCounter) >= (lnMembers - tcSize + lnCounter)
			lnCounter = lnCounter - 1
		Enddo
		If(lnCounter >= 1)
			aryIndice(lnCounter) = aryIndice(lnCounter) + 1
			lnTemp = lnCounter
			Do While lnTemp < tcSize
				lnTemp = lnTemp + 1
				aryIndice(lnTemp) = aryIndice(lnTemp-1) + 1
			Enddo
			CreateString(lnMembers, @tcSet, @aryIndice)


			Loop
		Else
			Exit
		Endif
	Endif
Enddo

Endfunc

Function CreateString(tcMembers, tcSet, tcIndice)

Select g_tmp2
Zap

Local lnCounter, lcString,lcString2,_rec1,_rec2
lcString = []
For lnCounter = 1 To tcMembers
	If tcIndice(lnCounter) != 0
		lcString2=Transform(tcSet(tcIndice(lnCounter)))

		Alines(ss,lcString2,"-")

		Insert Into  g_tmp2 (item1,item2) Values (ss(1),ss(2))

		lcString = lcString +lcString2+","


	Endif
Endfor

Select item1 Distinct From g_tmp2 Into Cursor cun_tmp
_rec1=Reccount("cun_tmp")
Select item2 Distinct From g_tmp2 Into Cursor cun_tmp
_rec2=Reccount("cun_tmp")


If _rec1=Reccount("g_tmp2") And _rec2=Reccount("g_tmp2")

	Insert Into g_tmp1 (items ) Values (lcString)

Endif

Return
Endfunc




************************************************
*
*
******************************
Function modi_mark_create
Lparameters _modi_need,_modi_must,_qty		&&¯S§O³B²z
Local j,k,_need,_must,Md
_need=""
_must=""

*IF __join_qty_when_same_item
If  __item_qty_with_modi =.F. 	&&¬O§_¸ò¸ò¼Æ¶q¬Ýsetting

	_qty=1

Endif

If !Empty(_modi_need)				&&¦pªG»Ý­n¯S§O³B²z,¼Æ¶q¤j©ó1,«h­n¨D«ö¼Æ¶q¿é¤J¯S§O³B²z,³W«h: 2­Ó AB -->ABAB
	Dimension Md(1)
	getmstring(_modi_need,@Md)
	For k=1 To _qty
		For j=1 To Alen(Md)
			_need=_need+Alltrim(Str(Val(Md(j))+k*0.001,12,3))+","	&&¼W¥[ÃÑ§O½X

		Endfor
		If _qty>1
			_need=_need+"0,"		&&¦pªG¯S§O³B²z¼Æ¶q¤j©ó1,¦Û°Ê´¡¤J¶¡¹j½u¼Ð°O
		Endif
	Endfor
	If Right(_need,3)=",0,"
		_need=Trim(_need,"0,")			&&§R°£³Ì«áªº0,
	Endif

Endif

If !Empty(_modi_must)				&&¦pªG¥²¶·¯S§O³B²z,¼Æ¶q¤j©ó1,«h­n¨D«ö¼Æ¶q¿é¤J¯S§O³B²z,³W«h: 2­Ó AB -->AA BB
	Dimension Md(1)
	getmstring(_modi_must,@Md)
	For k=1 To _qty
		For j=1 To Alen(Md)
			_must=_must+Alltrim(Str(Val(Md(j))+k*0.001,12,3))+","

		Endfor

	Endfor


Endif

_modi_need=_need			&&retu value
_modi_must=_must

Return


Endfunc


**************************************
*	¦Û°Ê§é¦© ÀË¬d
*
Function  check_auto_disc

Lparameters nOrderId,nMemberType
***
LOCAL lc_run_mode

*SET STEP ON 

If Vartype(_run_mode)="U"

	lc_run_mode="dine"

ELSE

	lc_run_mode = _run_mode
	
Endif

If Vartype(nMemberType)#"N"

	nMemberType=-1

ENDIF

IF VARTYPE(nOrderId)#"N"

	nOrderId=0

ENDIF



IF VARTYPE(_outlet_id)#"U" AND _outlet_id=0

	lc_run_mode ="fastfood"

ENDIF


Local  _curdatetime,_curtime,_curweekday,_curweekday,_belongdate,_isholiday

_curdatetime=Datetime()								&&¨ú·í«e®É¶¡



Delete From order_disc_tmp Where autodisc			&&¥ý§R°£©Ò¦³¦Û°Ê§é¦©,¥H¨¾¤î­«½Æ¥[¤J

&&&&Lihong 2021.04.23 ¦P®É³B²zdisc_log ¼W¥[inv_id ¡G¤wÁÙ­ì
If SQLExec(nhand,"select begintime,noautodisc,inv_srv_type,inv_srv_perc from  order_main where id=?nOrderId","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1


ENDIF
*!*	lndisc_log_inv_id = cun_tmp.inv_id

If Nvl(cun_tmp.noautodisc,.F.) 

	Return  1

ENDIF



If  nOrderId>0 AND Vartype(__autodisc_by_sittime)#"U" And __autodisc_by_sittime


	_curdatetime=cun_tmp.begintime							&&¨ú¤J®y®É¶¡


Endif

_curtime=Left(Ttoc(_curdatetime,2),5)
_curweekday=Dow(_curdatetime)
_curweekday=Iif(_curweekday=1,7,_curweekday-1)		&&Âà¬°"¤¤°ê¦¡"ªº¬P´Á­pºâ¤èªk,©P¤@¬°²Ä¤@¤Ñ)
_day="day"+Alltrim(Str(_curweekday))

&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
IF VARTYPE(_inv_srv_type)#"N"
	_inv_srv_type = NVL(cun_tmp.inv_srv_type, 0)
	_inv_srv_perc = NVL(cun_tmp.inv_srv_perc, 0.00)
ENDIF 

If SQLExec(nhand,"select autodisc from outlet where id=?_outlet_id","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1


Endif
If Isnull(cun_tmp.autodisc) Or cun_tmp.autodisc=.F.			&& °Ï°ì¬O§_¤¹³\¦Û°Ê§é¦©¸òOUTLETªº³]©w

	Return 1

Endif

Local _order_amount
_order_amount=amount_check() &&Lihong 2021.04.23 ¼W¥[¤J°Ñfor disc_log  lndisc_log_inv_id ¡G¤wÁÙ­ì

&&Lihong 2021.04.16 ¼W¥[:
Local _srvamt, _taxamt	
SELECT order_itemlist_tmp
SUM srv_amount,tax_amount TO _srvamt,_taxamt				&&ªA°È¶O	
_order_amount = _order_amount - _srvamt

If !Used("work_order_tmp14")

	If SQLExec(nhand,"select id,begdate,enddate from holi where active=1","work_order_tmp14")<0

		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

Endif
&&Lihong 2022.05.06 festival 
IF !Used("work_order_tmp24")
	If SQLExec(nhand,"select * from festival WITH (nolock) where active=1","work_order_tmp24")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
ENDIF 


_belongdate=getbelongdate()			&&¨ú·í«eªºbelongdate

Select Id From work_order_tmp14 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
_isholiday=(_Tally>0)			&&¬O§_¤½²³°²´Á

&&Lihong 2022.05.06 festival 
*Select Id From work_order_tmp24 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
Select Id From work_order_tmp24 Where CTOT(STUFF(TTOC(begdate),12,5,date_start_time))<=_curdatetime And CTOT(STUFF(TTOC(enddate),12,5,date_end_time))>=_curdatetime ;
AND ((_curtime>=start_time And _curtime<=end_time) Or (start_time>end_time And (_curtime>=start_time Or  _curtime<=end_time))) Into Array tmp_s
_isfestival=(_Tally>0)

&&Lihong 2021.04.16 ¼W¥[a.id ( for ª÷ÃBº¡­pºâ¤è¦¡ ) 
&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î ¸T¥Î¦³¿n¤À¶µ¥Ø&&§Y®É¤è¦¡¤~³o¼Ë
ssql="select a.id as uid,a.dine_active,a.barcode_active,a.fastfood_active,a.begdate,a.enddate,a.begtime ,a.endtime,a.day1,a.day2,a.day3,a.day4,a.day5,a.day6,a.day7,a.holiday,a.ex_holiday, a.festival, a.ex_festival, a.minamt,a.member_type,b.*  "+;
	"	from autodisc a left join disc b on a.disc_id =b.id  where a.active=1 and b.active=1 ";
	 +IIF(Vartype(__cloud_member)#"U" and __cloud_member=.T. and VARTYPE(__cloud_member_type)#"U" AND !__cloud_member_type=='proan' or VARTYPE(__storellet)#"U" AND __storellet, "and b.points=0", "") + " order by a.dispord"


If SQLExec(nhand,ssql,"autodisc_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

ENDIF
REPLACE ALL begdate WITH CTOT("1900-01-01") FOR ISNULL(begdate) IN autodisc_tmp
REPLACE ALL enddate WITH CTOT("2099-12-31") FOR ISNULL(enddate) IN autodisc_tmp

&&Lihong 2021.04.16 ¼W¥[ª÷ÃBº¡­pºâ¤è¦¡ b.sitem_sub=.F. AND 
IF VARTYPE(__disc_sum_amt_by)#"U" AND __disc_sum_amt_by=="2"
	SELECT a.*, b.amount as order_amount FROM autodisc_tmp a LEFT JOIN ( ;
	select a.uid, SUM(b.amount) as amount FROM autodisc_tmp a LEFT JOIN order_itemlist_tmp b ON .T.;
	WHERE b.item_id>0 AND (TRIM(a.disclevel)=="all" OR ","+TRANSFORM(b.level_id)+"," $ ","+a.disclevel) ;
	GROUP BY a.uid ) b ON a.uid=b.uid ;
	INTO CURSOR autodisc_tmp READWRITE 
	*WHERE EMPTY(a.disclevel) OR a.minamt<=b.amount 
	REPLACE ALL order_amount WITH 0 FOR ISNULL(order_amount) 
ELSE
	SELECT *, CAST(_order_amount as N(12,2)) as order_amount FROM autodisc_tmp INTO CURSOR autodisc_tmp READWRITE 
ENDIF 


Select autodisc_tmp &&Lihong 2022.08.10 (Trim(begtime)<=_curtime Or Trim(endtime)<=_curtime) -> (Trim(begtime)<=_curtime Or Trim(endtime)>=_curtime)
Scan For ( ( begtime<=endtime And  Trim(begtime)<=_curtime And Trim(endtime)>=_curtime) Or (begtime > endtime And  (Trim(begtime)<=_curtime Or Trim(endtime)>=_curtime) ));
		And begdate<=_belongdate And enddate>=_belongdate	And order_amount>=minamt			&&¹LÂo¦³®Ä¤é´Á &&Lihong 2021.04.16 _order_amount>=minamt§ï¬°order_amount>=minamt	

	If Nvl(member_type,0)<>0 And Nvl(member_type,0)<>nMemberType		&&·|­ûºØÃþ

		Loop

	Endif


	If ( lc_run_mode="dine" And dine_active=.F.) Or (lc_run_mode="barcode" And barcode_active=.F.) Or ( lc_run_mode="fastfood"    And fastfood_active=.F.)
		Loop

	Endif

	If _isholiday And ex_holiday		&&¦pªG·í¤Ñ¬O¤½²³°²´Á,¤S«ü©w¤F"¤½²³°²´Á°£¥~"®É,¤£§@³B²z
		Loop
	Endif

	&&Lihong 2022.05.06 festival
	If _isfestival And NVL(ex_festival,.F.) 
		Loop
	Endif

	If _isholiday  And holiday=.F. AND &_day=.F. AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.)	&&¦pªG¬O¤½±q°²´Á, «ü©w¤é¤l¤£¥Í®Ä,¤S¥¼«ü©w"¤½²³°²´Á¦³®Ä",¤]¤£§@³B²z &&Lihong 2022.05.06 festival ¼W¥[ AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.)
		Loop

	Endif

	&&Lihong 2022.05.06 festival
	If _isfestival And NVL(festival,.F.)=.F. AND &_day=.F. AND (_isholiday=.F. OR ex_holiday=.T.)
		Loop
	ENDIF


	If _isholiday=.F. And &_day=.F. AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.) &&¦pªG«D¤½²³°²´Á,¤S«D«ü©w¤é¤l,¤£§@³B²z 2022.05.06 festival ¼W¥[ AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.)

		Loop

	Endif

	&&Lihong 2022.05.06 festival
	If _isfestival=.F. And &_day=.F. AND (_isholiday=.F. OR ex_holiday=.T.)
		Loop
	Endif


	_disc_type=autodisc_tmp.disc_type

	Do Case


		Case _disc_type=4				&&§KªA°È¶O

			Select uid From order_disc_tmp Where disc_type=4 Into Array tmp_s
			If _Tally>0

				Loop

			Endif

			Update order_itemlist_tmp Set srv_free=.T.


		Case _disc_type=5			&&§Kµ|¶µ

			Select uid From order_disc_tmp Where disc_type=5 Into Array tmp_s
			If _Tally>0
				Loop

			Endif

			Update order_itemlist_tmp Set tax_free=.T.


		Otherwise				&&¥¿±`§é¦©


	Endcase

	_cDesc=Iif(_system_langue="CN",Trim(autodisc_tmp.desccn),Trim(autodisc_tmp.Descen))


&&¥[¤J¾ã³æ§é¦© &&Lihong 2021.04.16 ¼W¥[,minamt
	Insert Into order_disc_tmp (uid,disc_id,disc_type,descdisp,disc_per,disc_amount,adduser,member_id,disc_reason,disc_level,disc_remark,disc_qty,autodisc,minamt,after_inv) ;
		VALUES (Sys(2015),autodisc_tmp.Id,autodisc_tmp.disc_type,_cDesc,autodisc_tmp.discper,autodisc_tmp.discamt,_login_user_name,0,0,autodisc_tmp.disclevel,"",1,.T., ;
		Nvl(autodisc_tmp.minamt,0), .F. )


Endscan

Use In autodisc_tmp

Return 1



Endfunc






**********************************
Function send_sms
*µoµu®§
Lparameters nPort,cMessage,cTel

If Vartype(__GSM_MODEM_INSTALL)="U" Or __GSM_MODEM_INSTALL=.F.		&&¦pªG¨S¦³¦w¸ËGSM MODEM,ªð¦^-1
	Return -1
Endif


If Parameters()<>3
	Return -1
Endif


If !File("mysms.dll")			&&¦pªG¨S¦³§ä¨ì¬ÛÃöªºDLL,ªð¦^-1

	fmessagebox("mysms.dll not found!!")
	Return -1

Endif


&&©w¸q¦³ÃöªºAPI
Declare Integer  InitModem In  "Mysms.dll" Integer  comport, Integer  Baud
Declare Integer  SendSms In "Mysms.dll" Integer   comport , Integer   Baud, String sMessage , String sTo , Integer bEnglish , Integer bAlert , Integer bSr

Local nBaud
nBaud=19200

If InitModem(nPort,nBaud)<>1

	Return 0

Endif

If SendSms(nPort,nBaud,cMessage,cTel,0,0,0)=1

	Return 1

Endif

Return SendSms(nPort,9600,cMessage,cTel,0,0,0)		&&¦¨¥\ªð¦^ 1, §_«hªð¦^ 0


Endfunc


************************************
Function SET_PDFCreator
Lparameters cDirectory,cFilename,AutoRunAfterSave


If Vartype(cDirectory)#"C" Or Vartype(cFilename)#"C"

	Return .F.

Endif


Local cKey,cKeyDirectory,cKeyFilename,cKeyAutoRun,cKeyAutoSave

cKey="HKEY_CURRENT_USER\Software\PDFCreator\Program\"

cKeyDirectory =cKey+"AutosaveDirectory"
cKeyFilename  =cKey+"AutosaveFilename"
cKeyAutoRun   =cKey+"AutosaveStartStandardProgram"
cKeyAutoSave  =cKey+"UseAutosave"
ckeyAutoPro   =cKey+"RunProgramAfterSaving"

oshell = Createobject("wscript.shell")
If Vartype(oshell) <> "O"
	Return -1
Endif

oshell.regwrite(cKeyDirectory , cDirectory)
oshell.regwrite(cKeyFilename  , cFilename)
oshell.regwrite(cKeyAutoSave, "1")		&&³]©w¦Û°Ê«O¦s
oshell.regwrite(ckeyAutoPro , "1")		&&³]©w¦Û°Ê¹B¦æ

oshell.regwrite(cKeyAutoRun  , Iif(AutoRunAfterSave,"1","0"))

Release oshell

Return 1


Endfunc


***************
Function Reset_PDFCreator		&&¦^´_PDFCreator¬°¤H¤u¿é¥X

Local cKey

cKey="HKEY_CURRENT_USER\Software\PDFCreator\Program\UseAutosave"

oshell = Createobject("wscript.shell")
If Vartype(oshell) <> "O"
	Return
Endif

oshell.regwrite(cKey, "0")		&&³]©w¦Û°Ê«O¦s¤£¥Í®Ä

Release oshell


Endfunc

****************************
*
* Function Load_inv_to_order  µo²¼¸ü¤JÂà¬°¸¨³æ
*
*************************

Function load_inv_to_order
Parameters  nInvID
Local ssql



*create_order_cursor()


If create_order_database()=-1		&&¥[¸ü¼Æ¾ÚÀô¹Ò

	Return -1
Endif



ssql="select * from inv  where id=?nInvID"
ssql=ssql+Chr(10)+"SELECT a.*,b.printer FROM inv_detail a left join item b on a.item_id=b.id where a.id=?nInvID order by a.uid"
ssql=ssql+Chr(10)+"select * from inv_modi  where id=?nInvID order by dispord"
ssql=ssql+Chr(10)+"select * from inv_itemdisc  where id=?nInvID order by dispord"
ssql=ssql+Chr(10)+"select * from inv_disc  where id=?nInvID order by dispord"
ssql=ssql+Chr(10)+"select * from inv_itemdept  where id=?nInvID "



If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

Select cun_tmp
If Eof()
	Return -1

Endif

Local _invamt
_invamt=cun_tmp.invamt

If Nvl(cun_tmp.fastfood_info_id,0)>0
	Public _fastfood_info_id
	_fastfood_info_id =cun_tmp.fastfood_info_id

Endif






*!*	_mincharge_mode=cun_tmp.mincharge_mode	&&³Ì§C®ø¶O¼Ò¦¡
*!*	_pplcnt=cun_tmp.pplcnt					&&¤H¼Æ

Local _printer,_invdesccn,_invdescen,_desckit,_id,_spndesc,_undefine,_slip_print

Select cun_tmp1		&& order_detail  ¸¨³æ²Ó¸`
SCAN FOR item_id<> - 6 AND item_id<> - 7 &&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ -7

	_printer=Trim(NVL(cun_tmp1.Printer,""))
	_invdesccn=""
	_invdescen=""
	_desckit=""
	_sprinter=""
	_id=Val(_sprinter)			&&«ü©wprinter
	_spndesc=""
	_handwriting=cun_tmp1.handwriting		&&¤â¼g³æ
	If _handwriting
		_hand_desc=Trim(cun_tmp1.descdisp)
	Endif

	_itemID=cun_tmp1.item_id
	Select work_order_tmp
	Seek _itemID
	&&Lihong 2022.09.27
	IF !FOUND("work_order_tmp")
		Select work_order_tmp0
		LOCATE FOR id=_itemID
	ENDIF 

	_descen=Trim(Descen)		&& 2011.04.15
	_desccn=Trim(desccn)		&& 2011.06.01

*	_Printer=Printer
	_invdesccn=Trim(descinvcn)
	_invdescen=Trim(descinven)
	_desckit=Trim(desckit)
	_desc_other=Iif(Isnull(desc_other),'',Trim(desc_other))
	_allowdisc=disc
	_slip_print=NVL(slip_Print,.F.)				&&¬O§_¦C¦L²M³æ(¤Wµæ¯È)
	_mincharge=NVL(mincharge,.F.)				&&¬O§_­p¤J³Ì§C®ø¶O
	_turnup=Iif(Isnull(turnup),.F.,turnup)		&& ¬O§_¤¹³\Âà»ù		&&2008.11.27

	_drink_qty=drink_qty


	If _handwriting						&&¤â¼g³æ
		_invdesccn=_hand_desc
		_invdescen=_hand_desc
		_desckit=_hand_desc
		_desccn = _hand_desc
		_descen = _hand_desc
	Endif

	_spndesc=""
*	_printer=""




*		_undefine=(EMPTY(cun_tmp1.item_code) AND cun_tmp1.printed=.f.)		&&¥¼©wµæ¦¡

	&&Lihong 2020.06.01 coupon cloud_coupon_id, web_coupon_id, web_coupon_code
	&&Lihong 2022.03.17 ¨Ò®uorgqty_case_mat
	&&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹
	&&Lihong 2023-06-02 ¼pÅã kit_disp_uid 
	Insert Into  order_itemlist_tmp	 (;
		uid,parent_id,cate_id,item_id,item_code,;
		descdisp,qty,price,orgamt,amount,;
		sitem,sitem_sub,mitem,mustmodi,hold,printed,;
		printtime,adduser,modi_list,modi_amount,disc_amount,;
		srv_per,srv_amount,tax_per,tax_amount,level_id,drink_qty,Show,;
		sprinter,spn_desc,Printer,descinvcn,descinven,desckit,;
		remin_times,Undefine,onlysave,disc,hhqty,hhprice,handwriting,;
		mitem_id,slip_Print,mincharge,;
		desc_other,material,orgsrv,;
		price0,turnup,org_price,askdept,gift,giftred,transnumber,desccn,Descen, ;
		coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code, print_single, points, pointed, same_tableno, orgqty_case_mat, ;
		price_type, qty_entity, add_user_id, add_user_station_id,srv_per_org, kit_disp_uid, to_printer, has_hold );
		values (;
		cun_tmp1.uid,cun_tmp1.parent_id,cun_tmp1.cate_id,cun_tmp1.item_id,cun_tmp1.item_code,;
		cun_tmp1.descdisp,cun_tmp1.qty,cun_tmp1.price,cun_tmp1.orgamt,cun_tmp1.amount,;
		cun_tmp1.sitem,cun_tmp1.sitem_sub,cun_tmp1.mitem,.F.,0,.T.,;
		cun_tmp1.printtime,cun_tmp1.adduser,"",cun_tmp1.modi_amount,cun_tmp1.disc_amount*-1,;
		cun_tmp1.srv_per,cun_tmp1.srv_amount,cun_tmp1.tax_per,cun_tmp1.tax_amount,cun_tmp1.level_id,_drink_qty,.T.,;
		_sprinter,_spndesc,_printer,_invdesccn,_invdescen,_desckit,;
		0,.F.,.F.,_allowdisc,0,0,_handwriting,;
		0,_slip_print,_mincharge,;
		_desc_other,Iif(Isnull(cun_tmp1.material),.F.,cun_tmp1.material),.F.,;
		cun_tmp1.price,.F.,cun_tmp1.price,Nvl(cun_tmp1.askdept,.F.),;
		Nvl(cun_tmp1.gift,.F.),Nvl(cun_tmp1.giftred,.F.),Nvl(cun_tmp1.transnumber,''),_desccn,_descen, ;
		null, Nvl(cun_tmp1.cloud_coupon_id,0), cun_tmp1.web_coupon_id, Nvl(cun_tmp1.web_coupon_code,""), NVL(cun_tmp1.print_single, .F.), NVL(cun_tmp1.points, 0), ;
		NVL(cun_tmp1.pointed, .F.), NVL(cun_tmp1.same_tableno, ""), NVL(cun_tmp1.orgqty_case_mat, 0), NVL(cun_tmp1.price_type, 0), NVL(cun_tmp1.qty_entity, 0), ;
		NVL(cun_tmp1.add_user_id,0), NVL(cun_tmp1.add_user_station_id,0),cun_tmp1.srv_per_org, cun_tmp1.kit_disp_uid, NVL(cun_tmp1.to_printer,""), .F. )
		
		&&NVL(cun_tmp1.srv_per_org,0)

Endscan
Select cun_tmp1
Use

Update order_itemlist_tmp Set descinvcn=descdisp,descinven=descdisp,desckit=descdisp  Where item_id=-3		&&³Ì§C®ø¶O

Local  _def_id,_modi_id,_def
Select cun_tmp2	&& order_modi  ¶µ¥Ø¯S§O³B²z
Scan
	_modi_id=cun_tmp2.modi_id
	_def_id=cun_tmp2.def_id
	_open_modi=cun_tmp2.open_Modi		&&¬O§_¦Û©w¯S§O³B²z

	Select work_order_tmp20
	Locate For Id=_def_id

	If Found()

		_def=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

	Else

		_def=""

	Endif


	Select * From work_order_tmp4 Where Id=_modi_id Into Cursor cun_tmp21
	_invdesccn=Iif(_open_modi,Trim(cun_tmp2.descdisp),_def+Trim(cun_tmp21.descinvcn))
	_invdescen=Iif(_open_modi,Trim(cun_tmp2.descdisp),_def+" "+Trim(cun_tmp21.descinven))
	_desckit=Iif(_open_modi,Trim(cun_tmp2.descdisp),_def+Trim(cun_tmp21.desckit))
	_desc_other=Iif(_open_modi ,Trim(cun_tmp2.descdisp),Iif(Isnull(cun_tmp21.desc_other),'',_def+Trim(cun_tmp21.desc_other)))
	_modi_per=Iif(Isnull(cun_tmp2.modi_per),0,cun_tmp2.modi_per)

	Insert Into  item_modi_tmp (uid,item_id,modi_id,modi_qty,modi_price,descdisp,modi_amount,modi_per,def_id,descinvcn ,descinven ,desckit,multqty,modi_idx,open_Modi,desc_other) Values ;
		(Sys(2015),cun_tmp2.item_id,cun_tmp2.modi_id,cun_tmp2.modi_qty,cun_tmp2.modi_price,cun_tmp2.descdisp,cun_tmp2.modi_amount,_modi_per,;
		cun_tmp2.def_id,_invdesccn,_invdescen,_desckit,cun_tmp2.multqty,cun_tmp2.dispord,_open_modi,_desc_other)


Endscan
Select cun_tmp2
Use

If !Eof("item_modi_tmp")
	Select order_itemlist_tmp		&&¥Í¦¨modi_list  fix 2009.01.16
	Scan
		Select descdisp From item_modi_tmp Where item_id=order_itemlist_tmp.uid And modi_id>0 Into Cursor cun_tmp21
		If _Tally>0
			_modi_list=""
			Select cun_tmp21
			Scan

				_modi_list=_modi_list+Trim(cun_tmp21.descdisp)+" \"

			Endscan

			Select order_itemlist_tmp
			Replace modi_list With Trim(_modi_list,"\")

		Endif


	Endscan

Endif
If Used("cun_tmp21")
	Select cun_tmp21
	Use

Endif


Select cun_tmp3		&&order_itemdisc   ¶µ¥Ø§é¦©
Scan

	Select  Iif(_system_langue="CN",desccn,Descen) As descdisp From work_order_tmp5 Where Id=cun_tmp3.disc_id Into Array tmp_s
	If _Tally>0
		_desc=tmp_s(1)
		&&Lihong 2020.06.02 coupon coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code
		Insert Into item_disc_tmp (uid,item_id,disc_id,disc_type,descdisp,disc_per,disc_amount,member_id,adduser,disc_reason,disc_remark,disc_qty, ;
		coupon_lock_valid, cloud_coupon_id, web_coupon_id, web_coupon_code,after_inv) Values ;
			(Sys(2015),cun_tmp3.item_id,cun_tmp3.disc_id,cun_tmp3.disc_type,_desc,cun_tmp3.disc_per,cun_tmp3.disc_amount,cun_tmp3.member_id,cun_tmp3.adduser,nvl(cun_tmp3.disc_reason,0),nvl(cun_tmp3.disc_remark,""),cun_tmp3.disc_qty, ;
			null, NVL(cun_tmp3.cloud_coupon_id,0), cun_tmp3.web_coupon_id, NVL(cun_tmp3.web_coupon_code,""), NVL(cun_tmp3.after_inv,.F.) )

	Endif

Endscan
Select cun_tmp3
Use


Select cun_tmp4		&&order_disc            ¾ã³æ§é¦©
Scan

	If member_id>0 Or !Empty(member_number)		&&¦pªG¬O·|­û§é¦©  &&Lihong 2023-08-10 ¼W¥[Or !Empty(member_number)

		_desc=getmessage("_member_disc")

	Else

		Select  Iif(_system_langue="CN",desccn,Descen) As descdisp From work_order_tmp5 Where Id=cun_tmp4.disc_id Into Array tmp_s

		If _Tally>0
			_desc=tmp_s(1)
		Else
			Loop

		Endif
	Endif

	Select disclevel From work_order_tmp5 Where Id=cun_tmp4.disc_id Into  Array tmp_s
	If _Tally>0

		_disc_level=Trim(tmp_s(1))
	Else
		&&Lihong 2023-08-10 _disc_level=""
		_disc_level=Iif(cun_tmp4.disc_id= -99,"all", "") 
	Endif


	Insert Into order_disc_tmp (uid,disc_id,disc_type,descdisp,disc_per,disc_amount,member_id,adduser,disc_level,disc_reason,disc_remark,disc_qty,autodisc,points,member_number,member_name,minamt,dedu_srv,after_inv) Values ;
		(Sys(2015),cun_tmp4.disc_id,cun_tmp4.disc_type,_desc,cun_tmp4.disc_per,cun_tmp4.disc_amount,cun_tmp4.member_id,;
		cun_tmp4.adduser,_disc_level,NVL(cun_tmp4.disc_reason,0),NVL(cun_tmp4.disc_remark,""),cun_tmp4.disc_qty,Iif(Isnull(cun_tmp4.autodisc),.F.,.F.),;
		nvl(cun_tmp4.points,0),Nvl(cun_tmp4.member_number,""),"",0,Nvl(cun_tmp4.dedu_srv,.F.),NVL(cun_tmp4.after_inv,.F.))		&&©Ò¦³ªº¦Û°Ê§é¦©³£Âà¬°´¶³q§é¦©


Endscan
Select cun_tmp4
Use


*----------------------	&&2009.12.12 ³¡ªù¤À±b
Select cun_tmp5
Scan
	

	Insert Into order_dept_tmp (parent_id,item_id,dept_id,amount,srvamt) Values (cun_tmp5.parent_id,cun_tmp5.item_id,cun_tmp5.dept_id,cun_tmp5.amount,cun_tmp5.srvamt)


Endscan


Return _invamt

Endfunc

*****
Function GetItemString

Lparameters cItem,cdbf,_must_printAmt

Local cItemString,_cItem_amt,mp

cItemString=Trim(cItem)

&&Lihong 2022.11.17
IF &cdbf..item_id=0
	Return cItemString
ENDIF 

IF VARTYPE(ll_kilo)="U"
	ll_kilo = .F.
ENDIF 

If __kit_print_item_amount Or _must_printAmt


	Select &cdbf


	If !Empty(Field("amount")) And !Empty(Field("qty"))		&&­pºâ©Ò¥e¤ñ¨Ò,¥H­Ý®e§Y°_¼Æ¶qª÷ÃB

		If Vartype(__kit_item_amt_showtype)="U"

			_cItem_amt=Alltrim(Str(&cdbf..price,12,2))

		Else

			Do Case

				Case __kit_item_amt_showtype="PM"	And !Empty(Field("modi_amount"))	&&PRICE+MODIFIER
					&&Lihong 2022.04.27 ¨Ò®u
					*_cItem_amt=Alltrim(Str(&cdbf..price+&cdbf..modi_amount/&cdbf..qty,12,2))
					&&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À _cItem_amt=Alltrim(Str(&cdbf..price+&cdbf..modi_amount/IIF(orgqty_case_mat>0,&cdbf..orgqty_case_mat,IIF(qty_entity>0, qty_entity, &cdbf..qty) ),12,2))
					
					&&Lihong 2023.06.25 
					&& _cdbf_qty_entity=IIF(qty_entity=0 and ll_kilo=.T., 1, qty_entity)
					&& _cItem_amt=Alltrim(Str(&cdbf..price+&cdbf..modi_amount/IIF(orgqty_case_mat>0,&cdbf..orgqty_case_mat,IIF(_cdbf_qty_entity>0, _cdbf_qty_entity, &cdbf..qty) ),12,2))
					IF qty_entity=0 and ll_kilo=.T.
						_cdbf_qty_entity=1
						_cItem_amt=Alltrim(Str(&cdbf..price+&cdbf..modi_amount,12,2))
					ELSE 
						_cdbf_qty_entity=qty_entity
						_cItem_amt=Alltrim(Str(&cdbf..price+&cdbf..modi_amount/IIF(_cdbf_qty_entity>0, _cdbf_qty_entity, IIF(orgqty_case_mat>0,&cdbf..orgqty_case_mat,&cdbf..qty) ),12,2))
					ENDIF 
					

				Case __kit_item_amt_showtype="TM"	&&TOTAL AMOUNT
					&&Lihong 2022.04.27 ¨Ò®u
					*_cItem_amt=Alltrim(Str(&cdbf..amount*_qty/&cdbf..qty,12,2))
					&&Lihong 2022.08.17 kilo¤£¦X¨Ö¤£©î¤À _cItem_amt=Alltrim(Str(&cdbf..amount*_qty/IIF(orgqty_case_mat>0,&cdbf..orgqty_case_mat,IIF(qty_entity>0, qty_entity, &cdbf..qty) ),12,2))
					
					&&Lihong 2023.06.25 
					&& _cdbf_qty_entity=IIF(qty_entity=0 and ll_kilo=.T., 1, qty_entity)
					&& _cItem_amt=Alltrim(Str(&cdbf..amount*_qty/IIF(orgqty_case_mat>0,&cdbf..orgqty_case_mat,IIF(_cdbf_qty_entity>0, _cdbf_qty_entity, &cdbf..qty) ),12,2))
					IF qty_entity=0 and ll_kilo=.T.
						_cdbf_qty_entity=1
						_cItem_amt=Alltrim(Str(&cdbf..amount,12,2))
					ELSE 
						_cdbf_qty_entity=qty_entity
						_cItem_amt=Alltrim(Str(&cdbf..amount*_qty/IIF(_cdbf_qty_entity>0, _cdbf_qty_entity, IIF(orgqty_case_mat>0,&cdbf..orgqty_case_mat,&cdbf..qty) ),12,2))
					ENDIF 
					
					&&Lihong 2022.07.13
					IF !Empty(Field("sitem", cdbf)) AND &cdbf..sitem=.T.
						_cItem_amt=Alltrim(STR(&cdbf..amount,12,2))
					ENDIF 

				Otherwise

					_cItem_amt=Alltrim(Str(&cdbf..price,12,2))

			Endcase

		Endif


		If  !Empty(Field("handwriting"))  And __kit_print_handwriting_amount=.F.
			If 	handwriting=.F.
				cItemString=cItemString+" $"+_cItem_amt

			Endif

		Else

			cItemString=cItemString+" $"+_cItem_amt
		Endif


		mp=.T.

	Endif

Endif


If !Empty(Field("modi_amount")) And  mp=.F.
	If &cdbf..modi_amount<>0 And __kit_print_modi_amount
		cItemString=cItemString	+" $"+Alltrim(Str(&cdbf..modi_amount,10,2))
	Endif

Endif

Select (cdbf)

*!*	IF !EMPTY(field("vm"))  AND &cdbf..vm>0
*!*
*!*			cItemString=cItemString + "("+ALLTRIM(STR(vm))+getmessage("_cover")+")"

*!*	ENDIF


Return cItemString

Endfunc

*******************
Function check_local_printer
Lparameters cprinter

If Vartype(cprinter)#"C"
	Return .F.

Endif
If Aprinters(prn)>0

*!*					FOR i=1 TO ALEN(prn)/2		&&Âà¬°¤j¼g
*!*						prn(i,1)=ALLTRIM(UPPER(prn(i,1)))
*!*						prn(i,2)=ALLTRIM(UPPER(prn(i,2)))
*!*
*!*					ENDFOR


	If Ascan(prn,Alltrim(cprinter),1,0,0,1)=0

		Return .F.

	Endif


Else
	Return .F.

Endif


Return .T.


Endfunc

**********************
*Âà¬°Â²Åé¤¤¤å¤º½X

Function getGBKtxt
Lparameters cTxt
Local cstr,_error
cstr=Trim(cTxt)

If File("mchset.dll")

	Declare Integer Big5ToGB In mchset.Dll String @GB5

	Big5ToGB(@cstr)


Endif


Return cstr


************************
Function  check_member_point

Lparameters nMember_id,nInvAmount	&&nMember_id ·|­ûID¡AnINV_iD µo²¼ID¡@¡AnInvAmountµo²¼ª÷ÃB

*IF VARTYPE(__member_points_as_money)#"U" AND __member_points_as_money
	
	&&Lihong 2020.07.31 ¨ú®ø¡Gitem.code.left(5)="ecash"«h¥R­È¿n¤À 
*!*		&&Lihong 2020.01.17 ¦]¬°_tally©l²×·|>0
*!*		SELECT order_itemlist_tmp 
*!*		LOCATE FOR UPPER(LEFT(item_code,5))="ECASH"
*!*		IF FOUND()
*!*		&&
*!*			SELECT SUM(points) as points FROM order_itemlist_tmp WHERE UPPER(LEFT(item_code,5))="ECASH" INTO curs cr_tmp
*!*			IF _tally>0
*!*				
*!*				_add_point= NVL(cr_tmp.points,0)
*!*				
*!*				RETURN _add_point
*!*			
*!*			ENDIF
*!*		ENDIF 

*ENDIF

If Vartype(_run_mode)="U"

	_run_mode="dine"
Endif


Local  _curdatetime,_curtime,_curweekday,_curweekday,_belongdate,_isholiday

_curdatetime=Datetime()								&&¨ú·í«e®É¶¡
_curtime=Left(Time(),5)
_curweekday=Dow(_curdatetime)
_curweekday=Iif(_curweekday=1,7,_curweekday-1)		&&Âà¬°"¤¤°ê¦¡"ªº¬P´Á­pºâ¤èªk,©P¤@¬°²Ä¤@¤Ñ)
_day="day"+Alltrim(Str(_curweekday))

&&Lihong 2020.05.15 ·|­û¦³®Ä´Á  begdate, enddate ¼È¤£¥Î
If SQLExec(nhand,"select type_id from member where id=?nMember_id","cun_tmp")<0

	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1


Endif

If Eof("cun_tmp")

	Return -1
Endif


Local nType_id

nType_id=cun_tmp.type_id


If !Used("work_order_tmp14 ")

	If SQLExec(nhand,"select id,begdate,enddate from holi where active=1","work_order_tmp14")<0

		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif

Endif
&&Lihong 2022.05.06 festival 
IF !Used("work_order_tmp24")
	If SQLExec(nhand,"select * from festival WITH (nolock) where active=1","work_order_tmp24")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
ENDIF 

_belongdate=getbelongdate()			&&¨ú·í«eªºbelongdate

&&Lihong 2020.05.15 ·|­û¦³®Ä´Á  begdate, enddate ¼È¤£¥Î
*!*	IF !BETWEEN(_belongdate,TTOD(NVL(cun_tmp.begdate, CTOT("1900.01.01"))), TTOD(NVL(cun_tmp.enddate, CTOT("1900.01.01"))))
*!*		RETURN 0 
*!*	ENDIF 

Select Id From work_order_tmp14 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
_isholiday=(_Tally>0)			&&¬O§_¤½²³°²´Á

&&Lihong 2022.05.06 festival 
*Select Id From work_order_tmp24 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
Select Id From work_order_tmp24 Where CTOT(STUFF(TTOC(begdate),12,5,date_start_time))<=_curdatetime And CTOT(STUFF(TTOC(enddate),12,5,date_end_time))>=_curdatetime ;
AND ((_curtime>=start_time And _curtime<=end_time) Or (start_time>end_time And (_curtime>=start_time Or  _curtime<=end_time))) Into Array tmp_s
_isfestival=(_Tally>0)

Local _add_point,_sub_point

_add_point=0


ssql="select * from member_point where active=1 order by dispord"

If SQLExec(nhand,ssql,"member_point_tmp")<0

	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif


Select member_point_tmp

Scan For   Trim(begtime)<=_curtime And Trim(endtime)>=_curtime And begdate<=_belongdate And enddate>=_belongdate And minamt<=nInvAmount			&&¹LÂo¦³®Ä¤é´Á


	If member_type=-1 And member_id<>nMember_id		&&¦pªG«ü©w·|­ûID¡A«h¶i¦æIDÀË¬d

		Loop

	Endif

	If member_type>0 And member_type<>nType_id		&&¦pªG«ü©w¤F·|­ûÃþ§O¡A­nÀË¬d·|­ûÃþ§O

		Loop

	Endif


	If ( _run_mode="dine" And dine_active=.F.) Or (_run_mode="barcode" And barcode_active=.F.) Or (_run_mode="fastfood" And fastfood_active=.F.)	&&¼Ò¦¡ÀË¬d
		Loop

	Endif
	
	If _isholiday And ex_holiday		&&¦pªG·í¤Ñ¬O¤½²³°²´Á,¤S«ü©w¤F"¤½²³°²´Á°£¥~"®É,¤£§@³B²z
		Loop
	Endif

	&&Lihong 2022.05.06 festival
	If _isfestival And NVL(ex_festival,.F.) 
		Loop
	Endif

	If _isholiday  And holiday=.F. AND &_day=.F. AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.) &&¦pªG¬O¤½±q°²´Á, «ü©w¤é¤l¤£¥Í®Ä,¤S¥¼«ü©w"¤½²³°²´Á¦³®Ä",¤]¤£§@³B²z &&Lihong 2022.05.06 festival ¼W¥[ AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.)
		Loop

	ENDIF
	
	&&Lihong 2022.05.06 festival
	If _isfestival And NVL(festival,.F.)=.F. AND &_day=.F. AND (_isholiday=.F. OR ex_holiday=.T.)
		Loop
	ENDIF

	If _isholiday=.F. And &_day=.F. AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.) &&¦pªG«D¤½²³°²´Á,¤S«D«ü©w¤é¤l,¤£§@³B²z 2022.05.06 festival ¼W¥[ AND (_isfestival=.F. OR NVL(ex_festival,.F.)=.T.)

		Loop

	Endif

	&&Lihong 2022.05.06 festival
	If _isfestival=.F. And &_day=.F. AND (_isholiday=.F. OR ex_holiday=.T.)
		Loop
	Endif

	&&Lihong 2020.07.07
*!*		If Vartype(__points_rounding)#"U" And __points_rounding="DN"

*!*			_add_point=Int(nInvAmount*member_point_tmp.points/member_point_tmp.per_amt)

*!*		Else

*!*			_add_point=Ceiling(nInvAmount*member_point_tmp.points/member_point_tmp.per_amt)
*!*		Endif
	_add_point=IIF(member_point_tmp.per_amt=0, 0.00, nInvAmount*member_point_tmp.points/member_point_tmp.per_amt)


	If _add_point>0


		Exit

	Endif


Endscan

*!*	ssql="update inv set points=?_add_point,points_used=?_points_used where id=?nInv_ID"

*!*	IF SQLEXEC(nhand,ssql)<0
*!*			aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
*!*			RETURN -1

*!*	ENDIF

Use In member_point_tmp
*----------------------

&&Lihong 2020.07.07 ÃB¥~¿n¤À
TEXT TO ssql TEXTMERGE NOSHOW 
	select a.*, b.pointrate, b.pointfix from order_detail a LEFT JOIN item b ON a.item_id=b.id 
	where a.id=?LNorder_ID and a.item_id>0 and ISNULL(a.sitem_sub,0)=0 and ISNULL(b.pointrate,0)+ISNULL(b.pointfix,0)>0 
ENDTEXT 
_inv_points_extra = 0
If SQLExec(nhand, ssql, "cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
Endif
SCAN 
	IF NVL(cun_tmp.pointrate, 0) > 0 &&°â»ù * ­¿¼Æ
		_inv_points_extra = _inv_points_extra +  cun_tmp.pointrate*cun_tmp.amount 
	ELSE &&©T©w¿n¤À
		_inv_points_extra = _inv_points_extra + cun_tmp.pointfix*cun_tmp.qty
	ENDIF 
ENDSCAN 
If Vartype(__points_rounding)#"U" And __points_rounding="DN"
	_add_point=Int(_add_point + _inv_points_extra )
Else
	_add_point=Ceiling(_add_point + _inv_points_extra )
Endif


Return  _add_point

Endfunc
*********************************

*********************************
*À\¥x¬É­±¥\¯à²K¥[
*
*-----------------------------
Function add_table_function
Lparameters cMcode,cPcode

*cMcode  ´£¥Ü«H®§¥N½X
*cPcode  µ{§Ç¤º½X
If Vartype(cMcode)#"C"
	Return

Endif


If Vartype(cPcode)#"C"
	cPcode=cMcode
Endif


If SQLExec(nhand,"select id from table_function where pcode=?cPcode","cun_tmp")>0

	If Eof("cun_tmp")
		If SQLExec(nhand,"select MAX(id) as max_id,MAX(dispord) as max_dispord from table_function","cun_tmp")>0

			Local lnID,lcDesccn,lcDescen,lnDispord

			lnID=Iif(Isnull(cun_tmp.max_id),1,cun_tmp.max_id+1)
			lnDispord=Iif(Isnull(cun_tmp.max_dispord ),1,cun_tmp.max_dispord +1)

			lcDesccn=getmessage(cMcode,"CN")
			lcDescen=getmessage(cMcode,"EN")

			TEXT TO ssql noshow
				INSERT INTO table_function
				           ([active]
				           ,[id]
				           ,[dispord]
				           ,[desccn]
				           ,[descen]
				           ,[forecolor]
				           ,[backcolor]
				           ,[pcode])
				     VALUES
				           (1
				           ,?lnID
				           ,?lnDispord
				           ,?lcDesccn
				           ,?lcDescen
				           ,0
				           ,14215660
				           ,?cPcode)


			ENDTEXT

			=SQLExec(nhand,ssql)


		Endif

	Endif

Endif

Endfunc




*****************************

Function fmessagebox_unicode

Lparameters cCode, nCmdType, cFormCaption    &&cCode ¬°½s½sµ{¥N½X¡A¦p§ä¤£¨ì¡AÅã¥Ü¸Ó¥N½X
Local _code
_code=Lower(cCode)
Select  *  From message_tmp Where m_code=_code Into Cursor mess_tmp
Select * From message_tmp Where  m_code='_ok'  Or m_code='_cancel'  Or m_code='_retry'  Or m_code='_ignore'  Or m_code='_yes'  Or m_code='_no' Into Cursor mess_tmp1

Select mess_tmp
If  Eof()
	If __debug_mode And Left(_code,1)="_"

		_m_code=_code
		_mess_cn=""
		_mess_en=""

		Do Form Form\mess_fly_edit With _m_code,_mess_cn,_mess_en

		If !Empty(_mess_cn) And !Empty(_mess_en)
			Local csql
			=SQLExec(nhand, "select MAX(id) as maxid from message","cr9")

			If Isnull(cr9.maxid)
				_id = 1
			Else
				_id = cr9.maxid + 1
			Endif
			Use In cr9

			csql="insert into MESSAGE (id, m_code,message_cn,message_en) values (?_id, ?_m_code,?_mess_cn,?_mess_en)"
			If SQLExec(nhand,csql)<0
				Aerror(err)

				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return _code

			Endif

			If	SQLExec(nhand,"select * from message","message_tmp")<0
				Return _code
			Endif

			cMessage=Iif(clangue="CN",Trim(_mess_cn),Trim(_mess_en))
		Else
			Return _code

		Endif

	Else

		cMessage=_code&&	¦pªG¨S§ä¨ì,Åã¥Ücode
	Endif

Else
	_public_message_id = mess_tmp.Id
	cMessage=Iif(_system_langue="CN",Trim(message_cn),Trim(message_en))
Endif

beep()
Local nRetVal

Do Case
	Case Pcount() = 1

		Do Form Form\Messagebox_unicode With cMessage To nRetVal


	Case Pcount() = 2


		Do Form Form\Messagebox_unicode With cMessage,nCmdType To nRetVal


	Case Pcount() = 3
		Do Form Form\Messagebox_unicode With cMessage,nCmdType, cFormCaption To nRetVal


Endcase

If Used("mess_tmp")
	Select mess_tmp
	Use
Endif
If Used("mess_tmp1")
	Select mess_tmp1
	Use
Endif



Return (nRetVal)

Endfunc



FUNCTION delete_print_log

_date = Datetime() - 3600 * 24 * 3


=SQLExec(nhand, "delete from print_log where datetime < ?_date")

_date2 = Datetime() - 3600 * 24*14
=SQLExec(nhand, "delete from print_log2 where datetime < ?_date2")


ENDFUNC





***************************************
*2010-3-12
*­ì¥»©ó backup ®É°õ¦æ¥H¤U code ²M°£µL¥Î log
*¦ý«È¤á¥¼¥²°µ backup, ¤Î³]©w®É¶¡¦Û°Ê backup ¤£¯à¥Î©ó win7
*§ï¬°²M¾÷®É¥²©w backup

Function remove_print_log


frm_wait.showmessage("remove old xff....")

Create Cursor FileList	(Fname c(30))
lFNo	= Adir(laFList, "xff\_tmp*.*")
If lFNo > 0
	Select FileList
	Append From Array laFList
	Go Top
	Do While !Eof()
		lefile = "xff\" + Alltrim(FileList.Fname)
		Try
			Erase &lefile
		Catch
		Finally
		Endtry

		Skip
	Enddo
Endif
Use In FileList


frm_wait.showmessage("remove old frx....")

=del_frx("pay*.fr?")
=del_frx("lst*.fr?")
=del_frx("kit*.fr?")
=del_frx("inv*.fr?")


frm_wait.showmessage("remove oct log....")

_date = Datetime() - 3600 * 24 * 30


*2009-10-31
*!*	c=SQLEXEC(nhand, "CREATE INDEX [ix_action] ON [dbo].[oct_log] ([action])")
*!*	c=SQLEXEC(nhand, "CREATE INDEX [ix_date] ON [dbo].[oct_log] ([date])")
*!*	IF SQLEXEC(nhand, "delete from oct_log where action = 'initcomm()'")<0
*!*				aerror(err)
*!*				error_catch(getmessage("_sqlserver_error")+chr(13)+"table:oct_log",ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
*!*				RETURN


*!*	ENDIF

*!*	IF SQLEXEC(nhand, "delete from oct_log where date < ?_date")<0

*!*				aerror(err)
*!*				error_catch(getmessage("_sqlserver_error")+chr(13)+"table:oct_log",ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
*!*				RETURN

*!*	ENDIF



* 2009-4-20
* la bons deaclock
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[pay_print_main] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[pay_print_detail] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[pay_print_disc] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[pay_print_job] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_inv_id] ON [dbo].[pay_print_job] ([inv_id])")

*2009-3-21
*¦P®É¦L³æ¥i¯à deadlock
c=SQLExec(nhand, 'CREATE INDEX [ix_id] ON [dbo].[inv_disc] ([id])')
c=SQLExec(nhand, 'CREATE INDEX [ix_id] ON [dbo].[inv_itemdisc] ([id])')

*2009-3-12
*¥[§Ö delete inv_print_???
c=SQLExec( nhand , "CREATE INDEX [ix_pid] ON [inv_print_detail] ([pid])")
c=SQLExec( nhand , "CREATE INDEX [ix_pid] ON [inv_print_main] ([pid])")
c=SQLExec( nhand , "CREATE INDEX [ix_pid] ON [inv_print_disc] ([pid])")
c=SQLExec( nhand , "CREATE INDEX [ix_pid] ON [inv_print_void] ([pid])")

*2009-2-3
*v6.9.190 ¦¿«n¬ü¼p ¸Õ¹L INVINFO.GRID_INV.AFTERROWCOLCHANGE ®É timeout
c=SQLExec( nhand , "CREATE INDEX [ix_item_id] ON [inv_detail] ([item_id]) ")
c=SQLExec( nhand , "CREATE INDEX [ix_logid] ON [sys_log] ([log_id]) ")
c=SQLExec( nhand , "CREATE INDEX [ix_date] ON [sys_log] ([datetime]) ")


*2008-11-04
*¤s¥Ð­n©ó dayend report show §ï³æ»ù record
*sys_log.log_id = 95
c=SQLExec(nhand, "CREATE INDEX [ix_logid] ON [dbo].[sys_log] ([log_id])")


*2008-10-23
*©ó¬õ¨ë¨­µo²{ÂÂ exe ·í item.use_material = NULL ®É, ÂI¤¤¸Ó item ·|¥X¿ù
If SQLExec(nhand, "update item set use_material = 0 where use_material is null")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:item",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif


* 2008-10-21
* add index ¹Á¸Õ¸Ñ¨M deadlock
c=SQLExec(nhand, "CREATE INDEX [ix_updateno] ON [dbo].[inv] ([UpdateNo]) ON [PRIMARY]")
c=SQLExec(nhand, "CREATE INDEX [ix_tableno] ON [dbo].[tables] ([tableno])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[order_main] ([id])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[order_detail] ([id])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[order_modi] ([id])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[order_itemdisc] ([id])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[order_disc] ([id])")




* 2008-10-08
* ¦³ item ½æ¹L update ­ø¨ì item.used ¤Þ­P¥i¥H delete item, report ®É desc cannot accept null value
* «Y¼wºaµo²{

TEXT TO cmd noshow
	CREATE INDEX [ix_item_id] ON [dbo].[inv_detail] ([item_id])
ENDTEXT
c=SQLExec(nhand, cmd)


* 2010-3-12
* ¥H«á§ï¬°½æ¹L³£¥i¥H delete, ¤U­±´N­ø¦æ

*TEXT TO cmd noshow
*	UPDATE item SET used = 0
*	update item set used = 1 where id in (select item_id from inv_detail)
*endtext
*c=SQLEXEC(nhand, cmd)



* 2008-06-27 remove get updateno trigger from all tables
If SQLTables(nhand,"table","tables_tmp")>0
	Select tables_tmp
	Scan
		_cname=Trim(tables_tmp.table_name)
		If _cname#"updateno"
			ssql="DROP TRIGGER [dbo]."+_cname+"_tig"
			=SQLExec(nhand,ssql)
		Endif
	Endscan
	Use In tables_tmp
Endif



frm_wait.showmessage("remove old order....")

** 2007-08-30
TEXT TO cmd NOSHOW &&Lihong 2022.11.04 ¼W¥[order_itemdept
	delete from order_main where id not in (select id from order_detail)
	delete from order_main WHERE begintime < '1901-01-01'
	delete from order_main where  barcode=0 and askno='' and tableno in (select tableno from tables where status='')
	delete from order_main where  barcode=0 and askno='' and tableno not in (select tableno from tables )
	delete from order_detail where id not in (select id from order_main)
	delete from order_modi where id not in (select id from order_main)
	delete from order_itemdisc where id not in (select id from order_main)
	delete from order_disc where id not in (select id from order_main)
	delete from order_itemdept where order_id not in (select id from order_main) 
ENDTEXT
If SQLExec(nhand, cmd)<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:order_main/order_detail/modi/item_disc/disc",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif


* 2008-10-20
* [Microsoft][ODBC SQL Server Driver][SQL Server]¥æ©ö (³B²z§ÇÃÑ§O½X 54) ¦b lock ¸ê·½¤W¤w¸g³Q¥t¤@­Ó³B²z§ÇÂê¦º¨Ã³y¦¨¦ºµ²¡C½Ð­«·s°õ¦æ¸Ó¥æ©ö¡C ³s±µ¿ù»~¡C
c=SQLExec(nhand, "CREATE INDEX [ix_updateno] ON [dbo].[inv] ([UpdateNo]) ON [PRIMARY]")

** 2007-08-27

frm_wait.showmessage("remove old sys_log....")

*** log keep 7 days
_date = Ttoc(Datetime() - 3600 * 24 * 7)


TEXT TO ssql noshow		&& backup sys log to xml

	SELECT a.id
	      ,a.station
	      ,a.adduser
	      ,a.datetime
	      ,a.log_id
	      ,a.action
	      ,a.station_time
	      ,b.desccn
	  FROM [sys_log] a left join message_log b
	  on a.log_id=b.id
	where a.datetime<?_date

ENDTEXT


IF SQLEXEC(nhand,ssql,"cr_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:sys_log",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return


ENDIF

IF !EOF("cr_tmp")

	LOCAL lclogFile
	lclogFile= FULLPATH("log\syslog" + TTOC(DATETIME(),1 ) + ".xml")

	TRY 	
			MKDIR log
	CATCH
	FINALLY 
	ENDTRY 	
	
	CURSORTOXML("cr_tmp",lclogFile,3,512+16,0,"1")
	

ENDIF

USE IN cr_tmp



If SQLExec(nhand, "delete from sys_log where datetime < ?_date and log_id <> 95")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:sys_log",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif
***

frm_wait.showmessage("remove old print_server_log....")

*new add 2007-12-14
*print_server_log keep last 7 days
c=SQLExec(nhand, "CREATE INDEX [ix_date] ON [dbo].[print_server_log] ([errer_date])")
If SQLExec(nhand, "delete from print_server_log where errer_date < ?_date")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:print_server_log",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

frm_wait.showmessage("remove old order_print_main....")

*** delete kitchen print log & print job
_date = Datetime() - 3600 * 24
*** keep last 24 hours

If SQLExec(nhand, "delete from order_print_detail where pid in ( select pid from order_print_main where sendtime < ?_date)")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:order_print_detail",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif
If SQLExec(nhand, "delete from order_print_main where sendtime < ?_date")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:order_print_main",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

c=SQLExec(nhand, "CREATE INDEX [ix_pid] ON [dbo].[print_finish] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_date] ON [dbo].[print_finish] ([datetime])")
If SQLExec(nhand, "delete from print_finish where datetime < ?_date")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:print_finish",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif



frm_wait.showmessage("remove old slip_print_main....")


If SQLExec(nhand, "delete from slip_print_detail where pid in (select pid from slip_print_main where sendtime < ?_date)")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:slip_print_detail",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif
If SQLExec(nhand, "delete from slip_print_main where sendtime < ?_date")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:slip_print_main",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif



frm_wait.showmessage("remove old inv_print_main....")

*c=SQLEXEC(nhand, "delete from inv_print_job where (printed=1 and sendtime<getdate()-3) or printer=''")
If SQLExec(nhand, "delete from inv_print_detail where pid in (select pid from inv_print_main where sendtime < ?_date )")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_print_detail",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

If SQLExec(nhand,"delete from payway_print_detail where pid in (select pid from inv_print_main where sendtime < ?_date )")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:payway_print_detail",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

If SQLExec(nhand,"delete from inv_print_main where sendtime < ?_date")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_print_main",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

*2009-3-12 ´I¥Ð
If SQLExec(nhand,"delete from inv_print_disc where pid not in (select pid from inv_print_main)")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_print_disc",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

If SQLExec(nhand,"delete from inv_print_void where pid not in (select pid from inv_print_main)")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_print_void",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

&&Lihong 2022.08.19 ¤À±b
If SQLExec(nhand,"delete from inv_print_split where pid not in (select pid from inv_print_main)")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_print_void",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return
Endif
If SQLExec(nhand,"delete from inv_split where inv_id not in (select inv_id from order_main)")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_print_void",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return
ENDIF


frm_wait.showmessage("remove old pay_print_main....")

c=SQLExec(nhand, "CREATE INDEX [ix_sendtime] ON [dbo].[pay_print_main] ([sendtime])")
c=SQLExec(nhand, "CREATE INDEX [ix_id] ON [dbo].[payway_print_detail] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_datetime] ON [dbo].[print_log] ([datetime])")
*c=SQLExec(nhand, "CREATE INDEX [ix_printtime] ON [dbo].[pay_html] ([printtime])")
*c=SQLExec(nhand, "CREATE INDEX [ix_printtime] ON [dbo].[inv_html] ([printtime])")


*c=SQLEXEC(nhand, "delete from pay_print_job where (printed=1 and sendtime<getdate()-3) or printer=''")
=SQLExec(nhand,"delete from pay_print_detail where pid in (select pid from pay_print_main where sendtime < ?_date)")

=SQLExec(nhand,"delete from pay_print_main where sendtime < ?_date")

=SQLExec(nhand,"delete from payway_print_detail where pid not in (select pid from pay_print_detail)")		&&  11/9/2007  add by david

=SQLExec(nhand, "delete from print_log where datetime < ?_date")

_date2 = Datetime() - 3600 * 24*14
=SQLExec(nhand, "delete from print_log2 where datetime < ?_date2")

*!*	If SQLExec(nhand, "delete from pay_html where printtime < ?_date")<0
*!*		Aerror(err)
*!*		error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:pay_html",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		Return

*!*	Endif
*!*	If SQLExec(nhand, "delete from inv_html where printtime < ?_date and inv_id not in (select inv_id from inv_problem)")<0
*!*		Aerror(err)
*!*		error_catch(getmessage("_sqlserver_error")+Chr(13)+"table:inv_html",Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*		Return

*!*	Endif

frm_wait.showmessage("remove old inv_reprint_main....")

c=SQLExec(nhand, "CREATE INDEX [ix_pid] ON [dbo].[inv_reprint_disc] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_pid] ON [dbo].[inv_reprint_detail] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_pid] ON [dbo].[inv_reprint_main] ([pid])")
c=SQLExec(nhand, "CREATE INDEX [ix_invid] ON [dbo].[inv_reprint_main] ([inv_id])")
c=SQLExec(nhand, "CREATE INDEX [ix_sendtime] ON [dbo].[inv_reprint_main] ([sendtime])")

** new add 2007-08-20
= SQLExec(nhand, "delete from inv_reprint_main where inv_id in (select inv_Id from inv_reprint_main where sendtime<getdate()-3 group by inv_id having count(*)=1)")

= SQLExec(nhand, "delete from inv_reprint_detail where pid not in (select pid from inv_reprint_main)")
=SQLExec(nhand, "delete from inv_reprint_disc where pid not in (select pid from inv_reprint_main)")

*= SQLExec(nhand, "delete from inv_reprint where  datetime<getdate()-7 ")		&& 2011.04.12
&&«e­±¤w«ö®É¬q§R°£¼Æ¾Ú¡A¦¹³BµL»Ý¦A²MªÅ By Waston 29/09/2022            
*!*	=SQLExec(nhand, "truncate table print_log")
*!*	=SQLExec(nhand, "truncate table slip_print_main")
*!*	=SQLExec(nhand, "truncate table slip_print_detail")
*!*	=SQLExec(nhand, "truncate table pay_print_main")
*!*	=SQLExec(nhand, "truncate table pay_print_detail")
*!*	=SQLExec(nhand, "truncate table pay_print_disc")
*!*	=SQLExec(nhand, "truncate table inv_print_main")
*!*	=SQLExec(nhand, "truncate table inv_print_detail")
*!*	=SQLExec(nhand, "truncate table inv_print_disc")
*!*	=SQLExec(nhand, "truncate table payway_print_detail")

TRY 
	DELETE FILE  R_*.pdf
	
CATCH TO oErr

ENDTRY


Return


Endfunc




*******************************
* 2010-3-12
* call from remove_print_log

Function del_frx
Lparameters t_type

c=Adir(chris,t_type)
If c > 0

	Create Cursor dbflist (Name c(60))
	Sele dbflist
	Append From Array chris
	Sele dbflist
	Index On Name Tag Name

	Go Top
	Do While .Not. Eof()
		t_name	= Upper(Alltrim(dbflist.Name))

		_error=0
		Try
			Erase (t_name)
		Catch To error_exp
			_error=1
		Finally
		Endtry

		Sele dbflist
		Skip
	Enddo
	Use In dbflist
Endif

Endfunc

*-------------------------------------------
*¨ú®øµo²¼

Function void_inv

Lparameters nInvID,lnoCommit


If lnoCommit=.F.

	SQLSetprop(nhand,"Transactions",2)
				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---			

Endif


If SQLExec(nhand,"select * from inv where id=?nInvID","cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)

	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

Local _invamt,_tableno,_void_id,_memberID,_computer,_station_id,_void_reason,_belongdate,_vdate

_invamt=cun_tmp.invamt
_tableno=cun_tmp.tableno
_void_id=cun_tmp.void_id
_memberID=Nvl(cun_tmp.memberno,0)		&&·|­û



If  Isnull(_void_id) Or _void_id=0			&&void_id¥Í¦¨

	ssql="select MAX(void_id) as max_id from order_void"
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1


	Endif

	_void_id=Iif(Isnull(cun_tmp.max_id	),1,cun_tmp.max_id+1)

Else
	_void_id= cun_tmp.void_id

Endif


_computer=getcomputername()

If SQLExec(nhand,"select id from station where computer=?_computer","cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1
Endif


_station_id=cun_tmp.Id
_void_reason="-1"

If SQLExec(nhand,"select id from inv where id=?nInvID","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return


Endif



ssql="select MAX(updateno) as max_updateno  from  inv"					&& inv

If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif
_updateno=Iif(Isnull(cun_tmp.max_updateno),1,cun_tmp.max_updateno+1)

_vdate = Datetime()


_belongdate=getbelongdate()

ssql="update inv set void=1,voidreason=?_void_reason,voidtime=?_vdate ,voiduser=?_login_user_name,updateno=?_updateno,belongdate=?_belongdate where id=?nInvID"		&&¨ú®øµo²¼


If _memberID>0
&&¦pªG¦³·|­û ,«h°O¿ý·|­û®ø¶Oª÷ÃB¤Î¦¸¼Æ(´î¥h)

	ssql=ssql+Chr(10)+"update member set amount=amount-?_invamt,times=times-1 where id=?_memberID"


Endif


If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

_belongdate=getbelongdate()


&&°O¿ývoid_item
&&Lihong 2023.06.27 ¤£°O¿ý
*!*	ssql="insert into order_void select ?_tableno,id,item_id,descdisp,qty,price,amount,?_login_user_name,?_void_reason,printtime,?_vdate ,?_belongdate,modi_amount,disc_amount,srv_amount,sitem,sitem_sub,handwriting,0,?_station_id,?_void_id"+;
*!*		" from inv_detail where id=?nInvID"
*!*	If SQLExec(nhand,ssql)<0
*!*		Aerror(err)
*!*		Sqlrollback(nhand)
*!*		SQLSetprop(nhand,"Transactions",1)
*!*		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*		Return  -1
*!*	Endif


**---------------->>¦¨¥÷


ssql="select * from inv_detail where id=?nInvID and material=1"


If SQLExec(nhand,ssql,"inv_material_tmp")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return  -1


Endif

If !Eof("inv_material_tmp")		&&¬O§_¦s¦bÀ³¥Î¦¨¥÷ªº¶µ¥Ø


	If SQLExec(nhand,"SELECT ISNULL(MAX(id),0)+1 as m_id FROM material_in_main","cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif

	_m_id=cun_tmp.m_id

	TEXT TO ssql noshow

					INSERT INTO [material_in_main]
					           ([id]
					           ,[vendor_id]
					           ,[date]
					           ,[rem]
					           ,[adduser]
					           ,[inv_id]
					           )
					     VALUES
					           (?_m_id
					           ,0
					           ,getdate()
					           ,'void'
					           ,?_login_user_name
					           ,?nInvID
					           )

	ENDTEXT


	If SQLExec(nhand,ssql)<0

		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1

	Endif


	Select inv_material_tmp
	Scan
		_item_Id=inv_material_tmp.item_id
		_qty=inv_material_tmp.qty

		If SQLExec(nhand,"select * from item_material where item_id=?_item_id","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif


		Select cun_tmp
		Scan
			_material_id=cun_tmp.material_id
			_unit_id=cun_tmp.unit_id

			_qty1=_qty*cun_tmp.qty1			&&¼Æ¶q
			_qty2=_qty*cun_tmp.qty2
			_qty3=_qty*cun_tmp.qty3

			_u1_u2=Iif(cun_tmp.u1_u2=0 Or _qty1=0,1,cun_tmp.u1_u2)
			_u2_u3=Iif(cun_tmp.u2_u3=0 Or _qty2=0,1,cun_tmp.u2_u3)

			_mqty=_qty1*_u1_u2*_u2_u3+_qty2*_u2_u3+_qty3		&&¼Æ¶q(material)

			If _qty3>0 And _qty3>=cun_tmp.u2_u3			&&³æ¦ìÂà´«

				_qty3=0
				_qty2=_qty2+1

			Endif

			If _qty2>0 And _qty2>=cun_tmp.u1_u2

				_qty2=0
				_qty1=_qty1+1

			Endif

			TEXT TO ssql noshow

							INSERT INTO material_in_detail
							           ([id]
							           ,[material_id]
							           ,[unit_id]
							           ,[QTY1]
							           ,[QTY2]
							           ,[QTY3]
							           ,[amount])
							     VALUES
							           (?_m_id
							           ,?_material_id
							           ,?_unit_id
							           ,?_qty1
							           ,?_qty2
							           ,?_qty3
							           ,0
							           )


			ENDTEXT

			If SQLExec(nhand,ssql)<0

				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif

			If SQLExec(nhand,"update material set qty=qty+?_mqty where id=?_material_id")<0		&&§ó·s¦¨¥÷®w¦s¼Æ¶q
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1


			Endif


		Endscan


	Endscan




Endif

Use In inv_material_tmp


If Vartype(__member_printer_installed)#"U" And __member_printer_installed

	Local lcTran

	If Vartype(__member_card_mark)#"U"

		lcTran=Left(Alltrim(__member_card_mark),3)+Alltrim(Str(nInvID))		&&¥[¤J½s½X

	Else

		lcTran=Alltrim(Str(nInvID))


	Endif


	If SQLExec(nhand,"delete  from lms_log where  inv_no=?lcTran")<0		&&§R°£¦³Ãöªº¸É³æ¤Î¿n¤ÀLOG
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions" ,1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif


Endif

If lnoCommit=.F.

	If Sqlcommit(nhand)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1

	Endif


	SQLSetprop(nhand,"Transactions",1)


Endif

Return 1



Endfunc

*------------------------------------------------
*¤å¥óÂà¬°hex½s½X¤è¦¡

Function FiletoHex
Lparameters lcFileName
* create temporary buffer table

Local lcTemp,lmData,ll

lcTemp="c:\"+Sys(2015)+".dbf"

Select 0
Create Table (lcTemp) Free (mData m)
* take binary data from file into memo
Use (lcTemp)
Append Blank
Append Memo mData From (lcFileName) Overwrite
Use
* change memo field type to general to match to image type on SQL Server
ll = Fopen(lcTemp,12)
Fseek(ll,43)
Fwrite(ll,'G')
Fclose(ll)
* write data to SQL Server
Use (lcTemp)

lmData=mData

Use In (lcTemp)

Delete File (lcTemp)

lcTemp=Strtran(lcTemp,".dbf",".fpt")

Delete File (lcTemp)

Return lmData

Endfunc

*-------------------------------------
*imageÃþ«¬¼g¤J¥»¦a¤å¥ó

Function HextoFile

Lparameters cData,lcField,lcFileName


*** here we have general field in 'TT' cursor because image type on SQL Server mapped to general
*** field in VFP.
* save data to temporary table
Select &lcField As mData From (cData) Into Cursor hex_tmp

Local lcTemp,ll

lcTemp="c:\"+Sys(2015)+".dbf"

Select hex_tmp
Copy To (lcTemp)

Use In hex_tmp


* change general field type to memo
ll = Fopen(lcTemp,12)
Fseek(ll,43)
Fwrite(ll,'M')
Fclose(ll)

* save data from memo field into file
Use (lcTemp) Alias TT

If File(lcFileName)
	Erase (lcFileName)
Endif
* following commands you can replace also by STRtoFile function
Local lH
lH = Fcreate(lcFileName)
Fwrite(lH,TT.mData)
Fclose(lH)
Use In TT

Delete File (lcTemp)
lcTemp=Strtran(lcTemp,".dbf",".fpt")

Delete File (lcTemp)

Return

Endfunc

*---------------------
* backup order data
Function order_backup
Lparameters nOrderId

If Vartype(__order_data_backup)="U" Or ( Vartype(__order_data_backup)#"U" And __order_data_backup=.F.)

	Return

Endif


SQLSetprop(nhand,"Transactions",2)

				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1), .T.)
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						


TEXT TO ssql noshow

DELETE FROM order_main_bak WHERE id=?nOrderID
DELETE FROM order_detail_bak  WHERE id=?nOrderID
DELETE FROM order_modi_bak WHERE id=?nOrderID
DELETE FROM order_disc_bak WHERE id=?nOrderID
DELETE FROM order_itemdisc_bak WHERE id=?nOrderID
DELETE FROM order_tax_bak WHERE id=?nOrderID
DELETE FROM order_itemdept_bak  WHERE order_id=?nOrderID

ENDTEXT

If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1), .T.)
	Return

Endif

IF SQLCOLUMNS(nhand, 'order_main', 'FOXPRO', 'cun_tmp')<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1), .T.)
	Return
ENDIF 
_ins_order_main_bak_fields=""
SELECT cun_tmp
SCAN 
	_ins_order_main_bak_fields = _ins_order_main_bak_fields + IIF(EMPTY(_ins_order_main_bak_fields),"",",") + TRIM(cun_tmp.Field_name)
ENDSCAN 

TEXT TO ssql TEXTMERGE NOSHOW 
	INSERT INTO  order_main_bak (<<_ins_order_main_bak_fields>>) 
	SELECT <<_ins_order_main_bak_fields>> FROM order_main WHERE id=?nOrderID 
	
	INSERT INTO  order_detail_bak  SELECT * FROM order_detail WHERE id=?nOrderID
	INSERT INTO  order_modi_bak SELECT * FROM order_modi WHERE id=?nOrderID
	INSERT INTO  order_disc_bak SELECT * FROM order_disc WHERE id=?nOrderID
	INSERT INTO  order_itemdisc_bak SELECT * FROM order_itemdisc WHERE id=?nOrderID
	INSERT INTO  order_tax_bak SELECT * FROM order_tax WHERE id=?nOrderID
	INSERT INTO  order_itemdept_bak  SELECT * FROM order_itemdept WHERE order_id=?nOrderID

ENDTEXT

If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1), .T.)
	Return

Endif

TEXT TO ssql  noshow		&& °O¿ý¨ì order_update
	declare @qty  int
	set @qty=(select count(0) from order_detail where id=?nOrderID)

	delete from order_update where id=?nOrderID
	insert into order_update(id,item_qty,last_update)
	values(?nOrderID,@qty,getdate())

ENDTEXT
If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1), .T.)
	Return

Endif


Sqlcommit(nhand)
SQLSetprop(nhand,"Transactions" ,1)


Endfunc

*-------------------------
Function order_backup_clear

If Vartype(__order_data_backup)="U" Or ( Vartype(__order_data_backup)#"U" And __order_data_backup=.F.)

	Return

Endif


TEXT TO ssql noshow

delete from order_main_bak where id not in (select id from order_main)
delete from order_detail_bak where id not in (select id from order_main)
delete from order_modi_bak where id not in (select id from order_main)
delete from order_disc_bak where id not in (select id from order_main)
delete from order_itemdisc_bak where id not in (select id from order_main)
delete from order_tax_bak where id not in (select id from order_main)
delete from order_itemdept_bak where order_id not in (select id from order_main)
DELETE FROM order_update WHERE id not in (select id from order_main)

ENDTEXT

If SQLExec(nhand,ssql)<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return  -1

Endif
Return 1

Endfunc



*---------------------------
*restore data from order backup
Function order_restore
Lparameters nOrderId

If Vartype(__order_data_backup)="U" Or ( Vartype(__order_data_backup)#"U" And __order_data_backup=.F.)

	Return

Endif


SQLSetprop(nhand,"Transactions",2)

				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						


TEXT TO ssql noshow

DELETE FROM order_main WHERE id=?nOrderID
DELETE FROM order_detail  WHERE id=?nOrderID
DELETE FROM order_modi WHERE id=?nOrderID
DELETE FROM order_disc WHERE id=?nOrderID
DELETE FROM order_itemdisc WHERE id=?nOrderID
DELETE FROM order_tax WHERE id=?nOrderID
DELETE FROM order_itemdept  WHERE order_id=?nOrderID

ENDTEXT

If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

IF SQLCOLUMNS(nhand, 'order_main', 'FOXPRO', 'cun_tmp')<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return
ENDIF 
_ins_order_main_bak_fields=""
SELECT cun_tmp
SCAN 
	_ins_order_main_bak_fields = _ins_order_main_bak_fields + IIF(EMPTY(_ins_order_main_bak_fields),"",",") + TRIM(cun_tmp.Field_name)
ENDSCAN 

TEXT TO ssql TEXTMERGE NOSHOW 
	INSERT INTO  order_main (<<_ins_order_main_bak_fields>>) 
	SELECT <<_ins_order_main_bak_fields>> FROM order_main_bak WHERE id=?nOrderID 
	
	INSERT INTO  order_detail  SELECT * FROM order_detail_bak WHERE id=?nOrderID
	INSERT INTO  order_modi	 SELECT * FROM order_modi_bak WHERE id=?nOrderID
	INSERT INTO  order_disc SELECT * FROM order_disc_bak WHERE id=?nOrderID
	INSERT INTO  order_itemdisc SELECT * FROM order_itemdisc_bak WHERE id=?nOrderID
	INSERT INTO  order_tax_bak SELECT * FROM order_tax_bak WHERE id=?nOrderID
	INSERT INTO  order_itemdept  SELECT * FROM order_itemdept_bak WHERE order_id=?nOrderID

ENDTEXT

If SQLExec(nhand,ssql)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return

Endif

Sqlcommit(nhand)
SQLSetprop(nhand,"Transactions" ,1)


Endfunc


*---------------------------
Function  order_error_check		&&ÀË¬d
* return n Error   -1=SQL Error  0 =no Error  or  no backup  ; 1=has Error
Lparameters nOrderId

If Vartype(__order_data_backup)="U" Or ( Vartype(__order_data_backup)#"U" And __order_data_backup=.F.)

	Return 0

Endif

Local lnQty

If SQLExec(nhand,"select item_qty from order_update where id=?nOrderID","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

If Eof("cun_tmp")

	Return 0

Endif
lnQty=cun_tmp.item_qty

If SQLExec(nhand,"select id from order_main where id=?nOrderID","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

If Eof("cun_tmp")

	Return 1

Endif

If SQLExec(nhand,"select COUNT(0) as qty from order_detail where id=?nOrderID","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

If cun_tmp.qty<lnQty

	Return 1

Endif


Return 0


Endfunc



*----------------------------------------
Function move_inv_to_standard
Lparameters inv_Belongdate,nInvID


Local lcInv,lcInv_detail,lcInv_modi,lcInv_disc,lcInv_itemDisc,lcInv_pay

lcInv="hinv_"+Left(Ttoc(inv_Belongdate,1),6)
lcInv_detail="hinv_detail_"+Left(Ttoc(inv_Belongdate,1),6)
lcInv_modi="hinv_modi_"+Left(Ttoc(inv_Belongdate,1),6)
lcInv_disc="hinv_disc_"+Left(Ttoc(inv_Belongdate,1),6)
lcInv_itemDisc="hinv_itemdisc_"+Left(Ttoc(inv_Belongdate,1),6)
lcInv_pay="hinv_pay_"+Left(Ttoc(inv_Belongdate,1),6)


TEXT TO csql NOSHOW TEXTMERGE

	INSERT INTO inv SELECT * FROM <<lcInv>> where id=?nInvID
	INSERT INTO inv_detail SELECT * FROM <<lcInv_detail>> where id=?nInvID
	INSERT INTO inv_modi SELECT * FROM <<lcInv_modi>> where id=?nInvID
	INSERT INTO inv_disc SELECT * FROM <<lcInv_disc>> where id=?nInvID
	INSERT INTO inv_itemdisc SELECT * FROM <<lcInv_itemdisc>> where id=?nInvID
	INSERT INTO pay_detail  SELECT * FROM <<lcInv_pay>> where id=?nInvID

	DELETE from <<lcInv>> WHERE id=?nInvID
	DELETE from <<lcInv_detail>> WHERE id=?nInvID
	DELETE from <<lcInv_modi>> WHERE id=?nInvID
	DELETE from <<lcInv_disc>> WHERE id=?nInvID
	DELETE from <<lcInv_itemdisc>> WHERE id=?nInvID
	DELETE from <<lcInv_pay>> WHERE id=?nInvID

ENDTEXT

If SQLExec(nhand,csql)<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

Return 1

Endfunc


*------------------------
Function get_his_table_name
Lparameters inv_Belongdate,cType

Do Case

	Case cType="inv_detail"

		Return "hinv_detail_"+Left(Ttoc(inv_Belongdate,1),6)

	Case cType="inv_modi"

		Return "hinv_modi_"+Left(Ttoc(inv_Belongdate,1),6)

	Case cType="inv_disc"

		Return "hinv_disc_"+Left(Ttoc(inv_Belongdate,1),6)

	Case cType="inv_itemdisc"

		Return "hinv_itemdisc_"+Left(Ttoc(inv_Belongdate,1),6)

	Case cType="inv_pay"

		Return "hinv_pay_"+Left(Ttoc(inv_Belongdate,1),6)



	Otherwise

		Return "hinv_"+Left(Ttoc(inv_Belongdate,1),6)

Endcase


Endfunc



*-------------------------
*
*§R°£µæ¦¡
Function order_item_delete

Lparameters  lcTableno,lnMember_id,LcFastFood_info,ll_inv_change_mode,cTranNumber

Local lcTranNumber


lcTranNumber=Iif(Vartype(cTranNumber)="C",Trim(cTranNumber),"")

&&By Waston 29/06/2023 °h¦^¿n¤À,¥ý¨ú·|­û¸¹
PRIVATE _member_number
_member_number = "" 
IF !EMPTY(lcTranNumber)
	lcSql = "select member_number from order_disc (nolock) where id in (select id from order_detail (nolock) where transnumber = '" + lcTranNumber + "')"

	If SQLExec(nhand,lcSql,"cr_member_number") < 0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1)) 
		Return -1
	Endif

	IF RECCOUNT("cr_member_number") > 0
		_member_number = RTRIM(cr_member_number.member_number)
	ENDIF 

	
	IF USED("cr_member_number")
		USE IN "cr_member_number"	
	ENDIF 	
ELSE 
	_member_number = ""
ENDIF 	
*****************************************

*-------------------
*!*	SELECT uid FROM order_itemlist_tmp WHERE selected AND gift AND giftred INTO CURSOR cun_tmp
*!*	IF _tally>0

*!*		IF VARTYPE(__member_printer_installed)="U"  OR __member_printer_installed =.f.


*!*			RETURN -1

*!*		ENDIF


*!*	ENDIF

*----------------------

If ll_inv_change_mode

	_inv_id = _inv_change_inv_id
	_tableno = _inv_change_tableno
	_outlet_id = _inv_change_outlet_id
	_pplcnt =_Inv_change_pplcnt


Else


	If _run_mode ="barcode"

		ssql="select inv_id,id as order_id,outlet_id,pplcnt as ppl  from order_main  where id=?_curorder"


	Else

		ssql="select inv_id,order_id,outlet_id,ppl from tables  where tableno=?lcTableno and nsubtable=0"

	Endif



	If SQLExec(nhand,ssql,"cun_tmp")<0

		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1


	Endif
	
	_curorder_fastfood = _curorder &&Lihong 2023.07.19 void item show
	
	Private  _inv_id,_curorder,_outlet_id,_pplcnt,_FastFood_info,_belongdate,_station_id,_member_id,_tableno


	_tableno=lcTableno
	_inv_id=Nvl(cun_tmp.inv_Id,0)
	_curorder=cun_tmp.order_id
	_outlet_id=cun_tmp.outlet_Id
	_pplcnt=cun_tmp.ppl

	&&Lihong 2022-09-26 fastfood preorder
	IF _run_mode="fastfood"
		_pplcnt = 1
		_curorder  = _curorder_fastfood &&Lihong 2023.07.19 void item show
	ENDIF 

Endif


_member_id=lnMember_id

_FastFood_info=Iif(_run_mode="fastfood",LcFastFood_info,"")

_belongdate=getbelongdate()
_station_id=__station_id

If SQLExec(nhand,"select void_id,order_uid from order_main where id=?_curorder","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

ENDIF

&&Lihong 2023.07.19 void item show
IF _run_mode="fastfood"
	_order_uid = IIF(VARTYPE(_curorder_uid)="C", _curorder_uid, null) 
ELSE
	_order_uid = IIF(VARTYPE(_curorder_uid)="C", _curorder_uid, cun_tmp.order_uid)
ENDIF 
If  Isnull(cun_tmp.void_id) Or cun_tmp.void_id=0			&&void_id¥Í¦¨

	ssql="select MAX(void_id) as max_id from order_void"
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1


	Endif

	_void_id=Iif(Isnull(cun_tmp.max_id),1,cun_tmp.max_id+1)

Else
	_void_id= cun_tmp.void_id

Endif

&&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ
_print_to_kitchen_outlet = .T.
IF Upper(_run_mode)=="DINE"
	ssql="select slip_print, inv_print, paylist_print,kit_print from outlet where id=?_outlet_id"	
	If SQLExec(nhand,ssql, "cun_tmp")<0
		Aerror(err)
		*Sqlrollback(nhand)
		*SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	ENDIF
	_print_to_kitchen_outlet = NVL(cun_tmp.kit_print, .F.)
ENDIF 

&&Lihong 2020.06.02 coupon OR  item_id = -51
Select uid From  order_itemlist_tmp Where Selected And printed And (item_id>0 OR  item_id = -51) And Undefine=.F. And sitem=.F. Into Cursor cun_tmp

&&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´« 
IF VARTYPE(__sitem_repl_save_order )#"U"
	=SQLSetprop(nhand,"Transactions",2)
ENDIF 

If _Tally>0

	IF VARTYPE(__sitem_repl_save_order )="U" &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´« 
		=SQLSetprop(nhand,"Transactions",2)
	ENDIF 
	
				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
							
	

	If .T. &&Lihong 2022.07.05©l²×°O¿ý __mark_void_item_before_inv  Or __void_item_ask_reason	&&¦pªG¤w¦L³æ,¬O§_°Ý°O¿ývoid item ,¸òsetting

		Local ctableno,lnrecno,_sitem_dele,_parent_uid
		ctableno=lcTableno
		Select order_itemlist_tmp
		Scan For Selected And printed And item_id<>0 And Undefine=.F.
			
			&&Lihong 2023.07.19 void item show
			IF VARTYPE(_order_item_delete_repl)#"U"
				_sitem_dele=.F.
			ELSE 
				_sitem_dele = sitem
				IF _sitem_dele=.F. AND sitem_sub=.T.
					_parent_id = parent_id
					SELECT Selected from order_itemlist_tmp WHERE uid = _parent_id INTO CURSOR cun_tmp
					_sitem_dele = (RECCOUNT("cun_tmp")>0 and cun_tmp.Selected=.T.)
				ENDIF 
			ENDIF 
			
			_uid=order_itemlist_tmp.uid
			_item_code=order_itemlist_tmp.item_code
			_modi_list=order_itemlist_tmp.modi_list
			
			TEXT TO ssql NOSHOW

				INSERT INTO [order_void]
				           ([tableno]
				           ,[inv_Id]
				           ,[item_id]
				           ,[descdisp]
				           ,[qty]
				           ,[price]
				           ,[amount]
				           ,[void_user]
				           ,[void_reason]
				           ,[printtime]
				           ,[void_time]
				           ,[belongdate]
				           ,[modi_amount]
				           ,[disc_amount]
				           ,[srv_amount]
				           ,[sitem]
				           ,[sitem_sub]
				           ,[handwriting]
				           ,[cln]
				           ,[station_id]
				           ,[void_id]
				           ,[order_uid]
				           ,[uid]
				           ,[item_code]
				           ,[sitem_dele]
				           ,[modi_list])
				     VALUES
				           (?cTableno
				           ,?_inv_id
				           ,?order_itemlist_tmp.item_id
				           ,?order_itemlist_tmp.descdisp
				           ,?order_itemlist_tmp.qty
				           ,?order_itemlist_tmp.price
				           ,?order_itemlist_tmp.amount
				           ,?_void_user
				           ,?_void_reason
				           ,?order_itemlist_tmp.printtime
				           ,getdate()
				           ,?_belongdate
				           ,?order_itemlist_tmp.modi_amount
				           ,?order_itemlist_tmp.disc_amount
				           ,?order_itemlist_tmp.srv_amount
				           ,?order_itemlist_tmp.sitem
				           ,?order_itemlist_tmp.sitem_sub
				           ,?order_itemlist_tmp.handwriting
				           ,0
				           ,?_station_id
				           ,?_void_id
				           ,?_order_uid
				           ,?_uid
				           ,?_item_code
				           ,?_sitem_dele
				           ,?_modi_list
				           )



			ENDTEXT



			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				write_log(78,"tbl:"+ctableno+" item:"+Trim(order_itemlist_tmp.item_code)+" "+Trim(order_itemlist_tmp.descdisp)+" qty:"+Alltrim(Str(order_itemlist_tmp.qty,10,2))+" amt:"+Alltrim(Str(order_itemlist_tmp.amount,10,2)))

				Return -1
			Endif
&&°O¿ý¾Þ§@
			ssql=""
			If  order_itemlist_tmp.limitqty And _run_mode<>"fastfood"		&&¤w¥´¦L¤Î¦Û°Ê­pºâ¼Æ¶qªº¶µ¥Ø,§ó·s®w¦s¼Æ¶q   update 2014.05.13
				ssql="update item set qtyremain=qtyremain + ?order_itemlist_tmp.qty where id=?order_itemlist_tmp.item_id"
			ENDIF

			&&Lihong 2022.02.17 soldout_qty¤è¦¡ ¥¼¥´¦L§ó·s®w¦s¼Æ¶q
*!*				IF _run_mode<>"fastfood"
*!*					TEXT TO ssql ADDITIVE NOSHOW TEXTMERGE
*!*					
*!*					update item set soldout=case when soldout=1 and isnull(soldout_qty,0) + ?order_itemlist_tmp.qty>0 then 0 else soldout end, 
*!*					soldout_qty=isnull(soldout_qty,0) + ?order_itemlist_tmp.qty where id=?order_itemlist_tmp.item_id and (ISNULL(soldout_qty,0)<>0 or soldout<>0)
*!*					ENDTEXT 
*!*				ENDIF 
			
			If !EMPTY(ssql) AND SQLExec(nhand,ssql)<0

				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			ENDIF


		Endscan

		If SQLExec(nhand,"update order_main set void_id=?_void_id where id=?_curorder")<0		&&°O¿ývoid_Id
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1

		Endif

	Endif



***  2020.03.28  david  sauna  , void³æªº³B²z

IF __special_customer="sauna" 

	Select order_itemlist_tmp
	Scan For Selected And printed And item_id<>0 And Undefine=.F.
		
		IF _inv_id>0 &&¦pªG¤w¦L³æ¡A­«·s±Æ¶¤
		
			ssql = "update sauna_index set is_active=1,createtime=getdate(),is_working=0 where user_id in (select id from sys_user where name=?order_itemlist_tmp.item_code)"
		
		ELSE	&&·½¬¡¡A¦^¨ì­ì¨Óªº¦ì¸m
			ssql = "update sauna_index set is_active=1,is_working=0 where user_id in (select id from sys_user where name=?order_itemlist_tmp.item_code)"

		ENDIF
		
		 
		
		IF SQLEXEC(nhand,ssql)<0
		
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1		
		
		ENDIF
	
	
	ENDSCAN
	
	&&²M²z«ù®vÅã¥Ü

	IF SQLEXEC(nhand,"update tables set remark2='' where tableno = ?lcTableno and nsubtable=0")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1		
			
	
	ENDIF
	


ENDIF

	
	

*----------------------------------------&&¦¨¥÷
	Select  * From order_itemlist_tmp Where printed And material And Selected Into Cursor item_material_tmp						&&¦pªG¤w¥´¦L¤Î±Ò¥Î¦¨¥÷ªº¶µ¥Ø,¬ÛÃö¦¨¥÷ªº®w¦s¼W¥[

	If _Tally>0

		If SQLExec(nhand,"SELECT ISNULL(MAX(id),0)+1 as m_id FROM material_in_main","cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1


		Endif

		_m_id=cun_tmp.m_id

		TEXT TO ssql noshow

					INSERT INTO [material_in_main]
					           ([id]
					           ,[vendor_id]
					           ,[date]
					           ,[rem]
					           ,[adduser]
					           ,[inv_id]
					           ,[in_id]
					           )
					     VALUES
					           (?_m_id
					           ,0
					           ,getdate()
					           ,'void'
					           ,?_login_user_name
					           ,0
					           ,''
					           )

		ENDTEXT


		If SQLExec(nhand,ssql)<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

		Select item_material_tmp
		Scan
			_item_Id=item_material_tmp.item_id
			_qty=item_material_tmp.qty

			If SQLExec(nhand,"select * from item_material where item_id=?_item_id","cun_tmp")<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1

			Endif


			Select cun_tmp
			Scan
				_material_id=cun_tmp.material_id
				_unit_id=cun_tmp.unit_id

				_qty1=_qty*cun_tmp.qty1			&&¼Æ¶q
				_qty2=_qty*cun_tmp.qty2
				_qty3=_qty*cun_tmp.qty3

				_u1_u2=Iif(cun_tmp.u1_u2=0 Or _qty1=0,1,cun_tmp.u1_u2)
				_u2_u3=Iif(cun_tmp.u2_u3=0 Or _qty2=0,1,cun_tmp.u2_u3)

				_mqty=_qty1*_u1_u2*_u2_u3+_qty2*_u2_u3+_qty3		&&¼Æ¶q(material)

				If _qty3>0 And _qty3>=cun_tmp.u2_u3			&&³æ¦ìÂà´«

					_qty3=0
					_qty2=_qty2+1

				Endif

				If _qty2>0 And _qty2>=cun_tmp.u1_u2

					_qty2=0
					_qty1=_qty1+1

				Endif

				TEXT TO ssql noshow

							INSERT INTO material_in_detail
							           ([id]
							           ,[material_id]
							           ,[unit_id]
							           ,[QTY1]
							           ,[QTY2]
							           ,[QTY3]
							           ,[amount])
							     VALUES
							           (?_m_id
							           ,?_material_id
							           ,?_unit_id
							           ,?_qty1
							           ,?_qty2
							           ,?_qty3
							           ,0
							           )


				ENDTEXT

				If SQLExec(nhand,ssql)<0

					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif

				If SQLExec(nhand,"update material set qty=qty+?_mqty where id=?_material_id")<0		&&§ó·s¦¨¥÷®w¦s¼Æ¶q
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1


				Endif


			Endscan


		Endscan

		ssql="update updateno set max_updateno=max_updateno+1 where table_name='material_in_detail' or table_name='material_in_main' or table_name='material'  "

		If SQLExec(nhand,ssql)<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif


	Endif

	Use In item_material_tmp


	N=0
	Select work_order_tmp12		&&¨C­Ó¥´¦L¾÷¤@­ÓÀH¾÷ÃÑ§O½X
	Scan
		N=N+1
		Dimension prand(N,2)
		prand(N,1)=Id
&&ÀH¾÷½X,«e­±ªº"KIT"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î
		prand(N,2)="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")

	Endscan


	Create Cursor print_page (Printer Int(4),pid c(20))			&&¥²­n­nÁ{®Éªí

	_is_sitem = .F.
	_mprinter="0"
	_dispord=1

	_isfastfood=Iif(_run_mode="fastfood",1,0)

	IF VARTYPE(__sitem_unrepl_save_order) = "U" &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´« ÁÙ­ì
		Select *  From order_itemlist_tmp Where Selected And printed And item_id>0 And Undefine=.F.  Into Cursor item_select_tmp
		Select item_select_tmp
		Scan For item_id>0	And  onlysave=.F. 	&&«H®§¤£§@¥´¦L  !(sitem_sub=.t.  AND mitem=.f.)

			ssql="delete from order_detail where id=?_curorder and ( uid=?item_select_tmp.uid or parent_id=?item_select_tmp.uid)"


			If SQLExec(nhand,ssql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				write_log(78,"tbl:"+_tableno+" item:"+Trim(item_select_tmp.descdisp)+" qty:"+Alltrim(Str(item_select_tmp.qty,10,2))+" amt:"+Alltrim(Str(item_select_tmp.amount,10,2)))

				Return -1

			Endif

		Endscan
	ENDIF 

	If (__notify_kit_when_void_item And __print_to_kitchen)  And ll_inv_change_mode=.F. AND (!Upper(_run_mode)=="DINE" OR _print_to_kitchen_outlet=.T.) &&void item¬O§_³qª¾¼p©Ð &&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ


		print_void_item()

		&&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´«
		IF VARTYPE(__sitem_repl_save_order )#"U"
			__sitem_repl_save_order = .T.
		ENDIF 

	Endif

	If  Vartype(__void_item_kit_to_slipprinter)#"U" And __void_item_kit_to_slipprinter AND (!Upper(_run_mode)=="DINE" OR _print_to_kitchen_outlet=.T.)  	&&¼p©Ð³æ¥´¦L¨ì¤Wµæ¯ÈPrinter &&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ


		If Val(__slip_printer1)>0

			Public   __void_item_slip_Printer

			__void_item_slip_Printer=__slip_printer1+","

			print_void_item()

			Release __void_item_slip_Printer

		Endif



	Endif



&&----¥ý¶i¦æ³Æ¥÷
	Select * From order_itemlist_tmp  Into Cursor order_itemlist_bak
	Select * From item_modi_tmp Into Cursor item_modi_bak
	Select * From item_disc_tmp Into Cursor item_disc_bak

	_order_change=.T.

*--------------------

Endif

Local _mitem_desccn,_mitem_descen,_mitem_desc,_mitem_id


&&Lihong 2020.06.22 §ï¨ìDo Whil «e¡]¦]·|§R°£¡^
*!*	If ll_inv_change_mode=.F.


*!*		Select Sum(points ) As sum_points From order_itemlist_tmp Where Selected And pointed 	Into Cursor cun_tmp			&&¤w¿n¤À´«ÁÊªº°h¦^¿n¤À

*!*		If cun_tmp.sum_points>0


*!*			If SQLExec(nhand,"update member set points=points+?cun_tmp.sum_points where id=(select memberno from order_main where id=?_curorder)")<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions",1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1


*!*			Endif


*!*		Endif


*!*	Endif
Select Sum(points ) As sum_points From order_itemlist_tmp Where Selected And pointed AND (item_id= -51 OR ll_inv_change_mode=.F. ;
OR VARTYPE(__cloud_member)#"U" AND __cloud_member) Into Cursor cun_tmp			&&¤w¿n¤À´«ÁÊªº°h¦^¿n¤À
IF cun_tmp.sum_points > 0 AND lnMember_id > 0
	If SQLExec(nhand,"update member set points=points+?cun_tmp.sum_points where id=?lnMember_id")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
	&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î §R°£µæ¦¡¡]¥]¬AÂ§¨é¾P°â¡^°h¦^¿n¤À
	IF VARTYPE(__cloud_member)#"U" AND __cloud_member And  Vartype(__member_point_enabled)#"U" And __member_point_enabled 
	IF  VARTYPE(__cloud_member_type)#"U" AND !__cloud_member_type=='proan'  &&§Y®É¤è¦¡¤~³o¼Ë
		errmsg_upload_points = ""
		IF upload_points("Add_cust_points_20210604", _inv_id, cun_tmp.sum_points, 0, _order_sit_time, lnMember_id, 0) = .F. && lcaction, lninvid, lnpoints, lnpoints_used, _belongdate,_memberid, _invamt
			*Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			fmessagebox(errmsg_upload_points)
			Return -1
		ENDIF 
	ENDIF 
	ENDIF 
ENDIF 

Select order_itemlist_tmp

Go Top
Do Whil !Eof()
	_uid=uid
	_mitem_id=mitem_id

	_recn=Recno()
	If Selected
		
*!*				&&Lihong 2021.04.23 §R°£µæ¦¡¦P®É³B²zdisc_log
*!*				IF VARTYPE(_item_del_inv_id)="U" 
*!*					_item_del_inv_id = _inv_id
*!*				ENDIF 
*!*				*IF _itemdel_inv_id>0 &&¦pªG¤w¦L³æ
*!*					Select * From item_disc_tmp Where item_id = order_itemlist_tmp.uid INTO CURSOR item_deledisc_tmp
*!*					SCAN 
*!*						ssql =" update disc_log set void = 1 ,datetime= getdate() where disc_type='1' and id = (select MAX(id) from disc_log where disc_type='1' and inv_no=?_item_del_inv_id and disc_id=?item_deledisc_tmp.disc_id and disc_amount = ?item_deledisc_tmp.disc_amount) "
*!*						If SQLExec(nhand, ssql)<0
*!*							Aerror(err)
*!*							Sqlrollback(nhand)
*!*							SQLSetprop(nhand,"Transactions",1)
*!*							error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*							Return -1
*!*						ENDIF 
*!*					ENDSCAN 
*!*					USE IN SELECT("item_deledisc_tmp")
*!*				*ENDIF 
*!*				Select order_itemlist_tmp
*!*				Go _recn

		&&Lihong 2023.08.14 
		&&Lihong 2020.06.02 coupon AND (Thisform.run_mode="fastfood" OR ) 
		*LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lccloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
		IF .T. &&ll_inv_change_mode &&Lihong &&Lihong 2020.12.11 §ï¬°.T.¡]¹êª«¨éorder¨½§Y®É³]¬°¤w§I´«¡^
			Select * From item_disc_tmp Where disc_id=-8 AND item_id = order_itemlist_tmp.uid INTO CURSOR item_coupondisc_tmp
			IF !EOF("item_coupondisc_tmp")
			SCAN 
			IF VARTYPE(__storellet)#"U" AND __storellet &&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h¤]¤£¥Î§ï
				_disc_remark = "," + ALLTRIM(disc_remark) + ","
				_coupon_member_code = STREXTRACT(_disc_remark, ",", ",",1)
				_web_coupon_id = STREXTRACT(_disc_remark, ",", ",",2)
				llupload_coupon = upload_storellet("unredeem", -1, _coupon_member_code, _web_coupon_id) &&lcaction, lninvid, lnmember_id, lccoupon_id
			ELSE 
				llupload_coupon = upload_coupon("revoke_redeemed_coupon_one", 2, null, 0, _inv_no, cloud_coupon_id, web_coupon_id, web_coupon_code) &&1:²{ª÷¨é 2:§I´«¨é
			ENDIF 
			IF llupload_coupon = .F.
				*Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				fmessagebox("_coupon_redeem_dele_fail") &&Â§¨é§I´« ºM¾P§I´«¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ!
				RETURN -1 
				*Exit
			ENDIF
			ENDSCAN 
			ENDIF 
			USE IN SELECT("item_coupondisc_tmp")
		ELSE 
			Select * From item_disc_tmp Where disc_id=-8 AND item_id = order_itemlist_tmp.uid INTO CURSOR item_coupondisc_tmp
			IF !EOF("item_coupondisc_tmp")
			SCAN 
			IF upload_coupon("unlock_coupon", 2, coupon_lock_valid, _curorder, _inv_id, cloud_coupon_id, web_coupon_id, web_coupon_code)=.F. 
				*Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				fmessagebox("Â§¨é§I´« ¸ÑÂê¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ!")
				Return -1 
				*Exit
			ENDIF
			ENDSCAN 
			ENDIF 
			USE IN SELECT("item_coupondisc_tmp")
		ENDIF 
		Select order_itemlist_tmp
		Go _recn
		&&	
		
		If sitem Or sitem_sub  &&®MÀ\¤Î¨ä¤lµæ¦¡
			
			Select  uid,descdisp,qty,amount,printed From order_itemlist_tmp Where parent_id=_uid Into Cursor cun_tmp
			Select cun_tmp
			Scan
				If printed		&&°O¿ý¾Þ§@
					write_log(72,"tbl:"+_tableno+" item:"+Trim(cun_tmp.descdisp)+" qty:"+Alltrim(Str(cun_tmp.qty,10,2))+" amt:"+Alltrim(Str(cun_tmp.amount,10,2)) + IIF(VARTYPE(__sitem_repl_save_order )#"U"," ®MÀ\¤l¶µ´À´«","") )
				Else
					write_log(71,"tbl:"+_tableno+" item:"+Trim(cun_tmp.descdisp)+" qty:"+Alltrim(Str(cun_tmp.qty,10,2))+" amt:"+Alltrim(Str(cun_tmp.amount,10,2)))
				Endif

				Delete From  item_modi_tmp  Where item_id=cun_tmp.uid			&&§R°£¬ÛÀ³ªº¯S§O³B²z
				Delete From  item_disc_tmp  Where item_id=cun_tmp.uid			&&§R°£¬ÛÀ³ªº¶µ¥Ø§é¦©
				Delete From  order_dept_tmp Where  parent_id=cun_tmp.uid			&& §R°£³¡ªù¤À±b


			Endscan


			Select order_itemlist_tmp

			If sitem	&&¦pªG¿ï¤¤®MÀ\¶µ¥Ø,«h¸Ó®MÀ\¥þ³¡§R°£


				Delete From  item_disc_tmp  Where item_id=_uid						&&§R°£¬ÛÀ³ªº¶µ¥Ø§é¦©(´ß)
				Delete From  item_modi_tmp  Where item_id=_uid				&&§R°£¬ÛÀ³ªº¯S§O³B²z
				Delete From order_itemlist_tmp Where  uid=_uid Or parent_id=_uid
				Delete From  order_dept_tmp Where  parent_id=_uid			&& §R°£³¡ªù¤À±b


			Else

				If sitem_sub And mitem						&&¥¼©wµæ¦¡§R°£«áÅÜ¬°"¥¼©wµæ¦¡",¯S§O³B²z²MªÅ			****  ¥¼©wµæ¦¡  ********

					IF _mitem_id=-1 &&order_itemlist_tmp.mitem_id=-1 &&Lihong 2023.04.20 custom for sitem_sub
						Select * From work_order_tmp Where Id=order_itemlist_tmp.item_id Into Cursor cun_tmp10
						_mitem_desccn=getmessage("_uncustom_item","CN")+"("+Trim(cun_tmp10.desccn)+")"
						_mitem_descen=getmessage("_uncustom_item","EN")+"("+Trim(cun_tmp10.Descen)+")"
					ELSE 
						Select * From work_order_tmp10 Where Id=_mitem_id Into Cursor cun_tmp10
						_mitem_desccn=getmessage("_undefine_item","CN")+"("+Trim(cun_tmp10.desccn)+")"
						_mitem_descen=getmessage("_undefine_item","EN")+"("+Trim(cun_tmp10.Descen)+")"
					ENDIF 
					_mitem_desc=Iif(_system_langue="CN",_mitem_desccn,_mitem_descen)
					
					Use In cun_tmp10
					IF order_itemlist_tmp.mitem_id=-1 &&Lihong 2023.04.20 custom for sitem_sub
						UPDATE order_itemlist_tmp Set descdisp=_mitem_desc,descinvcn=_mitem_desccn,descinven=_mitem_descen,desckit=_mitem_desccn, ;
						Undefine=.T.,modi_list="",modi_need="",modi_must="",modi_def="",printed=.F.,hhqty=0,hhprice=0,price =0,to_printer="" Where uid=_uid
					ELSE 
					
						Update order_itemlist_tmp Set item_id=mitem_id,item_code="",descdisp=_mitem_desc,descinvcn= _mitem_desccn,descinven=_mitem_descen,desckit=_mitem_desccn, ;
							Undefine=.T.,handwriting=.F.,modi_list="",modi_need="",modi_must="",modi_def="",printed=.F.,hhqty=0,hhprice=0,price =0,to_printer="" Where uid=_uid
					
					ENDIF 
					
					&&Lihong 2022.04.27 ¨Ò®u
					SELECT order_itemlist_tmp 
					LOCATE FOR uid=_uid
					IF orgqty_case_mat>0
						REPLACE qty WITH orgqty_case_mat, orgqty_case_mat WITH 0, qty_entity WITH 0, printtime WITH CTOT('{}'), just_send WITH .F., onlysave WITH  .f. 
					ENDIF 

*					Delete From  item_modi_tmp  Where item_id=_uid			&&§R°£¬ÛÀ³ªº¯S§O³B²z
*					Delete From  item_disc_tmp  Where item_id=_uid			&&§R°£¬ÛÀ³ªº¶µ¥Ø§é¦©

				Endif
			Endif
			
		Else

			Select order_itemlist_tmp
			Go _recn

			&&Lihong 2020.06.02 --------------------------------------- ¸ÑÂêcoupon 
			*Select order_itemlist_tmp
			*Scan For Selected AND item_id = -51 
				IF item_id = -51 &&VARTYPE(__cloud_member_coupon)#"U" AND __cloud_member_coupon  AND 
					*LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lccloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
					IF ll_inv_change_mode
						IF upload_coupon("revoke_selled_coupon_one", 0, null, _curorder, _inv_id, cloud_coupon_id, web_coupon_id, web_coupon_code)=.F. 
							*Aerror(err)
							Sqlrollback(nhand)
							SQLSetprop(nhand,"Transactions",1)
							*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
							fmessagebox("_coupon_sale_undo_fail2") &&Â§¨é¾P°â ºM¾P¾P°â¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ! Coupon sale undo failed, unable to delete, please try again later!
							Return -1 
						ENDIF
					ELSE
						IF upload_coupon("unlock_coupon", 1, coupon_lock_valid, _curorder, _inv_id, cloud_coupon_id, web_coupon_id, web_coupon_code)=.F. 
							*Aerror(err)
							Sqlrollback(nhand)
							SQLSetprop(nhand,"Transactions",1)
							*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
							fmessagebox("_unlock_coupon_sales_fail") &&Â§¨é¾P°â ¸ÑÂê¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ! Failed to unlock coupon sales, unable to delete, please try again later!
							Return -1 
							*Exit
						ENDIF 
					ENDIF 
&&¤W­±¤wªð
*!*						IF NVL(order_itemlist_tmp.points,0) > 0 AND order_itemlist_tmp.pointed = .T. &&°h¦^¿n¤À ?and ll_inv_change_mode=.F.
*!*							*¥¼¥[¤J©ú²Óªí
*!*							IF SQLEXEC(nhand,"update member set points=points + ?order_itemlist_tmp.points where id=?lnMember_id ")<0
*!*								*Aerror(err)
*!*								Sqlrollback(nhand)
*!*								SQLSetprop(nhand,"Transactions",1)
*!*								*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*								fmessagebox("Â§¨é¾P°â ¥»¦a°h¦^¿n¤À¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ!")
*!*								Return -1 
*!*								*Exit
*!*							ENDIF
*!*						ENDIF 
				ENDIF 
			*ENDSCAN

&&Lihong 2023.08.14 
*!*				&&Lihong 2020.06.02 coupon AND (Thisform.run_mode="fastfood" OR ) 
*!*				*LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lccloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
*!*				IF .T. &&ll_inv_change_mode &&Lihong &&Lihong 2020.12.11 §ï¬°.T.¡]¹êª«¨éorder¨½§Y®É³]¬°¤w§I´«¡^
*!*					Select * From item_disc_tmp Where disc_id=-8 AND item_id = order_itemlist_tmp.uid INTO CURSOR item_coupondisc_tmp
*!*					IF !EOF("item_coupondisc_tmp")
*!*					SCAN 
*!*					IF VARTYPE(__storellet)#"U" AND __storellet &&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h¤]¤£¥Î§ï
*!*						_disc_remark = "," + ALLTRIM(disc_remark) + ","
*!*						_coupon_member_code = STREXTRACT(_disc_remark, ",", ",",1)
*!*						_web_coupon_id = STREXTRACT(_disc_remark, ",", ",",2)
*!*						llupload_coupon = upload_storellet("unredeem", -1, _coupon_member_code, _web_coupon_id) &&lcaction, lninvid, lnmember_id, lccoupon_id
*!*					ELSE 
*!*						llupload_coupon = upload_coupon("revoke_redeemed_coupon_one", 2, null, 0, _inv_no, cloud_coupon_id, web_coupon_id, web_coupon_code) &&1:²{ª÷¨é 2:§I´«¨é
*!*					ENDIF 
*!*					IF llupload_coupon = .F.
*!*						*Aerror(err)
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions",1)
*!*						*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*						fmessagebox("_coupon_redeem_dele_fail") &&Â§¨é§I´« ºM¾P§I´«¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ!
*!*						RETURN -1 
*!*						*Exit
*!*					ENDIF
*!*					ENDSCAN 
*!*					ENDIF 
*!*					USE IN SELECT("item_coupondisc_tmp")
*!*				ELSE 
*!*					Select * From item_disc_tmp Where disc_id=-8 AND item_id = order_itemlist_tmp.uid INTO CURSOR item_coupondisc_tmp
*!*					IF !EOF("item_coupondisc_tmp")
*!*					SCAN 
*!*					IF upload_coupon("unlock_coupon", 2, coupon_lock_valid, _curorder, _inv_id, cloud_coupon_id, web_coupon_id, web_coupon_code)=.F. 
*!*						*Aerror(err)
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions",1)
*!*						*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*						fmessagebox("Â§¨é§I´« ¸ÑÂê¥¢±Ñ¡AµLªk§R°£¡A½Ðµy«á¦A¸Õ!")
*!*						Return -1 
*!*						*Exit
*!*					ENDIF
*!*					ENDSCAN 
*!*					ENDIF 
*!*					USE IN SELECT("item_coupondisc_tmp")
*!*				ENDIF 
*!*				Select order_itemlist_tmp
*!*				Go _recn
*!*				&&

			If item_id<>-3		&&³Ì§C®ø¶O¤£¥i§R°£
				Delete
				If printed		&&°O¿ý¾Þ§@
					write_log(72,"tbl:"+_tableno+" item:"+Trim(order_itemlist_tmp.descdisp)+" qty:"+Alltrim(Str(order_itemlist_tmp.qty,10,2))+" amt:"+Alltrim(Str(order_itemlist_tmp.amount,10,2)) + IIF(VARTYPE(__sitem_repl_save_order )#"U"," ®MÀ\¤l¶µ´À´«","") )
				Else
					write_log(71,"tbl:"+_tableno+" item:"+Trim(order_itemlist_tmp.descdisp)+" qty:"+Alltrim(Str(order_itemlist_tmp.qty,10,2))+" amt:"+Alltrim(Str(order_itemlist_tmp.amount,10,2)))
				Endif

				Delete From  item_modi_tmp  Where item_id=_uid			&&§R°£¬ÛÀ³ªº¯S§O³B²z
				Delete From  item_disc_tmp  Where item_id=_uid			&&§R°£¬ÛÀ³ªº¶µ¥Ø§é¦©
				Delete From  order_dept_tmp Where  parent_id=_uid			&& §R°£³¡ªù¤À±b

			Endif

		ENDIF &&®MÀ\¤Î¨ä¤lµæ¦¡

	Endif
	Select order_itemlist_tmp
	Go _recn
	Skip
	If Eof()
		Exit

	Endif

Enddo


&&Lihong 2020.06.22 §ï¨ìDo Whil «e¡]¦]·|§R°£¡^
*!*	If ll_inv_change_mode=.F.


*!*		Select Sum(points ) As sum_points From order_itemlist_tmp Where Selected And pointed 	Into Cursor cun_tmp			&&¤w¿n¤À´«ÁÊªº°h¦^¿n¤À

*!*		If cun_tmp.sum_points>0


*!*			If SQLExec(nhand,"update member set points=points+?cun_tmp.sum_points where id=(select memberno from order_main where id=?_curorder)")<0
*!*				Aerror(err)
*!*				Sqlrollback(nhand)
*!*				SQLSetprop(nhand,"Transactions",1)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*				Return -1


*!*			Endif


*!*		Endif


*!*	Endif

*---------------------------------------&&°h¦^·|­û¿n¤À
If !Empty(lcTranNumber)

	IF VARTYPE(__crm_app_active)#"U" AND __crm_app_active
	
	*SET STEP ON 
	
		*------------------------- &crm api
		LOCAL oCrm
		oCrm = CREATEOBJECT("crm")

		oCrm.server_url = __crm_server_url

		_error = .f.
		
		&&¦h­Ó§R°£®É,°Ñ¼Æ·|¶Ç¤J¦h­Ótransnumber,¼È¨ú²Ä¤@­Ó.By Waston 31/07/2023
		
		IF GETWORDCOUNT(lcTranNumber, ",") > 1 
			lcTranNumber = GETWORDNUM(lcTranNumber, 1, ",")
		ENDIF 	
		
		TRY 
			oCrm.redeem_back(lcTranNumber)
			
		CATCH TO oErr
				
			_error  = .t.

		ENDTRY

		IF _error
			
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			fmessagebox("_member_points_process_fail") &&·|­û¿n¤À¥¼¯à³B²z¦¨¥\¡A½ÐÁpµ¸ºÞ²z­û¡I Member points processed fail, please contact administrator!
			Return -1
			
		ENDIF

		IF oCrm.status="00"
		
		
		
		ENDIF
		
	
	
	ELSE	&&¥ý¹F·|­û¥d
	
		Private  olms
		_error=.F.

		Try
			If !Empty(ReadINI("c:\lms\lms.ini","CRW","starPrinterName"))

				olms = Createobject("LMSV3Star.LMSControlV3Star")
			Else
				olms = Createobject("LMSV3.LMSControlV3")
			Endif
			olms.storeNumber=__member_card_mark			&& shop code (must)

		Catch To oErr
			_error=.T.
		Endtry

		If _error
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			fmessagebox("_cardrw_error_need_to_restart")
			Return -1
		Endif
		lcTranNumbers = lcTranNumber	
		lnTransnumber = GETWORDCOUNT(lcTranNumbers,",")

		&&¦pªG¬O§R°£¦h­Ó´N­n³v­ÓVoid By Waston 31/07/2023
		FOR i = 1 TO lnTransnumber

			lcTranNumber = GETWORDNUM(lcTranNumbers,i,",")
			lcTran=Ltrim(Sys(2015),"_")

			&&°h¦^¥æ©ö¿n¤À,0¬°¦¨¥\ By Waston 25/07/2023
			ret = olms.LmsVoidPurchaseFoxPro(__member_card_mark + lcTranNumber,lcTran)
			
			IF VAL(ret) <> 0
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				olms.DisconnectPrinter
				olms=Null
				Release olms
				fmessagebox("_member_points_process_fail") &&·|­û¿n¤À¥¼¯à³B²z¦¨¥\¡A½ÐÁpµ¸ºÞ²z­û¡I
				_order_change=.F.
				Return -1
			ENDIF 
	 	ENDFOR 
		
	ENDIF
	

Endif


*******************************


If Used("order_Itemlist_bak")		&&void itemµo¥Í¤~¿é¥X²M³æ(¤Wµæ¯È)		&& 2019.07.08    void item  no slip print

*!*		If  ( (__print_slip	  And  Lower(__slip_print_mode_void_item)="one") ;
*!*				OR (_run_mode<>"fastfood"  And  _outlet_id>0 ))	 And ll_inv_change_mode=.F. &&¬O§_¦L²M³æ¸ò³]©w  &&     


*!*	*!*				Select order_itemlist_tmp
*!*	*!*				Count To N For !printed And !Undefine
*!*	*!*				If N>0


*!*			SET STEP ON 


*!*			If order_slip_print(_curorder,.T.,.T.,(_run_mode="barcode"))=-1			&&¿é¥X²M³æ,¦pªG¤£¯à¦¨¥\¿é¥X,«hÁÙ­ì¼Æ¾Ú

*!*	*LPARAMETERS _order_Id,_print_all,_voiditem,_print_barcode,_member_ID,_tel,_addr,_tableno


*!*				Select order_itemlist_tmp
*!*				Zap
*!*				Select * From order_itemlist_bak Into Array tmp_s
*!*				If _Tally>0
*!*					Select order_itemlist_tmp
*!*					Append From Array tmp_s		&&¿é¥X¥¢±Ñ,¦^´_¼Æ¾Ú
*!*				Endif

*!*				Select order_itemlist_bak
*!*				Use

*!*				Select item_modi_tmp
*!*				Zap
*!*				Select * From item_modi_bak Into Array tmp_s
*!*				If _Tally>0
*!*					Select item_modi_tmp
*!*					Append From Array tmp_s
*!*				Endif

*!*				Select item_modi_bak
*!*				Use

*!*				Select item_disc_tmp
*!*				Zap
*!*				Select * From item_disc_bak Into Array tmp_s
*!*				If _Tally>0
*!*					Select item_disc_tmp
*!*					Append From Array tmp_s
*!*				Endif
*!*				Select item_disc_bak
*!*				Use

*!*				_order_change=.F.
*!*				write_log(78,"tbl:"+_tableno)

*!*				Return -1

*!*			Endif
*!*	*			Endif

*!*		Endif

	If  Lower(__slip_print_mode_void_item)="all"
		Public 	_void_item_slip_print_all
	Endif


	Select order_itemlist_tmp
	Count To N For item_id>0 OR  item_id = -51 &&Lihong 2020.06.02 coupon OR  item_id = -51

	If N=0 And _void_printed And  _inv_id>0	 And ll_inv_change_mode=.F. 	&&¦pªG¤w¦L³æ,«hvoid inv

*!*			&&Lihong 2021.04.23 §R°£µæ¦¡¦P®É³B²zdisc_log
*!*			IF VARTYPE(_item_del_inv_id)="U"
*!*				_item_del_inv_id = _inv_id
*!*			ENDIF 
*!*			*IF _item_del_inv_id>0
*!*				Select order_disc_tmp
*!*				SCAN For member_id=0 AND disc_id>0 
*!*					ssql =" update disc_log set void = 1 ,datetime= getdate() where disc_type='0' and id = (select MAX(id) from disc_log where disc_type='0' and inv_no =?_item_del_inv_id and disc_id=?order_disc_tmp.disc_id and disc_amount = ?order_disc_tmp.disc_amount) "
*!*					If SQLExec(nhand, ssql)<0
*!*						Aerror(err)
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions",1)
*!*						frm_wait.Hide
*!*						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*						Return -1
*!*					ENDIF 
*!*				ENDSCAN 
*!*				SCAN For member_id<>0 AND disc_id<0 
*!*					ssql =" update disc_log set disc_amount = 0 where disc_type='0' and id = (select MAX(id) from disc_log where disc_type='0' and inv_no =?_item_del_inv_id and disc_id=?order_disc_tmp.disc_id and disc_amount = ?order_disc_tmp.disc_amount) "
*!*					If SQLExec(nhand, ssql)<0
*!*						Aerror(err)
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions",1)
*!*						frm_wait.Hide
*!*						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*						Return -1
*!*					ENDIF 
*!*				ENDSCAN 
*!*			*ENDIF 
		
		ssql="select id from payway   where lock=1 and id>0"					&&
		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

		_payID = cun_tmp.Id

		ssql="select invamt from inv where id =?_inv_id"					&&
		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

		_payamt=cun_tmp.invamt

		ssql="select MAX(updateno) as max_updateno from  inv"					&&
		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions" ,1)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif
		_updateno=Iif(Isnull(cun_tmp.max_updateno),1,cun_tmp.max_updateno+1)


		_belongdate=getbelongdate()
		ssql="update inv set paidtime=?DATETIME(),void=1,voidreason=?_void_reason,voidtime=?DATETIME(),voiduser=?_void_user,belongdate=?_belongdate,void_id=?_void_id,"+;
			"updateno=?_updateno where Id=?_inv_id"		&&¨ú®øµo²¼
		ssql=ssql+Chr(10)+"update tables set inv_id=0 where tableno=?_tableno and nsubtable=0"		&&²MªÅ
		ssql=ssql+Chr(10)+"update order_main set inv_id=0 where id=?_curorder"			&&´_¦ìorder_main ªºinv_id
		ssql=ssql+Chr(10)+"insert into pay_detail (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others) "+;
			"values (?_inv_id,?_payID,'Cash',1,?_payamt,'',?_payamt,0,0,1,1,?_payID,0)"

		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1

		Endif
		_inv_no=""
		_order_change=.T.
		
*!*			IF VARTYPE(_item_del_inv_id)="N" &&&&Lihong 2021.04.23 work_order§Ritem
*!*				_item_del_inv_id = -1
*!*			ENDIF 

	Endif


*------------------------------------------

*!*		ssql="update tables set updateno=ISNULL(updateno,0)+1 where tableno=?_tableno and nsubtable=0"		&& updateno
*!*
*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			RETURN -1

*!*		Endif


	
	IF VARTYPE(__sitem_repl_save_order )#"U" &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´« save_order¤~´£¥æ
	ELSE 
	If Sqlcommit(nhand)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Select order_itemlist_bak
		Use
		Select item_modi_bak
		Use
		Select item_disc_bak
		Use

		If !Empty(lcTranNumber)

			olms.DisconnectPrinter
			olms=Null
			Release olms


		Endif

		Return -1

	Endif
	ENDIF 
	
	Select order_itemlist_bak
	Use
	Select item_modi_bak
	Use
	Select item_disc_bak
	Use

Endif

IF VARTYPE(__sitem_repl_save_order )#"U" &&Lihong 2022-01-12 ®MÀ\¤l¶µ´À´« save_order¤~´£¥æ
ELSE 
SQLSetprop(nhand,"Transactions",1)
ENDIF

If !Empty(lcTranNumber)  

	IF VARTYPE(olms)="O"

		olms.DisconnectPrinter
		olms=Null
		Release olms
	
	ENDIF
	


Endif



Return 1

Endfunc


*------------------------- **¥´¦L¨ú®øµæ¦¡
Function print_void_item

Private _member_name,_member_cardno

_member_name=""
_member_cardno=""
If Vartype(__kit_order_print_member_code)="L" And Vartype(__kit_order_print_member_name)="L"			&&¼p©Ð³æ¬O§_¦C¦L·|­û½s¸¹

	If _member_id >0

		ssql="select member.*,member_type.default_disc from member join member_type on member.type_id=member_type.id where member.id=?_member_Id order by member.id"
		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1

		Endif

		If __kit_order_print_member_name
			_member_name=Trim(cun_tmp.name_cn)
		Endif

		If __kit_order_print_member_code

			_member_cardno=Trim(cun_tmp.cardno)
		Endif


	Endif


Endif


&&Lihong 2020.06.02 coupon and item_id<>-51 &&Lihong 2022.06.14 ¼W¥[order by uid ?
Select a.*, IIF(ISNULL(b.id),NVL(bb.local_print_kit, .F.),NVL(b.local_print_kit, .F.)) as local_print_kit  From order_itemlist_tmp a LEFT JOIN work_order_tmp b ON a.item_id=b.id ;
LEFT JOIN work_order_tmp0 bb ON a.item_id=bb.id Where a.Selected AND a.item_id<>-51 Into Cursor item_cancel_tmp READWRITE &&Lihong 2022.06.28 ¥»¾÷¥´¦L¼p©Ð³æ &&Lihong 2022.09.27 bb

Select item_cancel_tmp
Do Whil !Eof()
	_uid=item_cancel_tmp.uid
	_itemID=item_cancel_tmp.item_id
	_recno=Recno()

	Select work_order_tmp
	Seek _itemID												&&¬d§ä¬Û²Å¦X°O¿ý,¨ú´y­z¤º®e
	IF FOUND("work_order_tmp")
		_work_order_tmp_name = "work_order_tmp"
	ELSE 
		Select work_order_tmp0
		LOCATE FOR id=_itemID												
		_work_order_tmp_name = "work_order_tmp0"
	ENDIF 
	
	If item_cancel_tmp.handwriting OR NVL(&_work_order_tmp_name..custom,.F.)=.T.
		
		&&Lihong 2022.09.27		
*!*			Select work_order_tmp
*!*			Seek _itemID												&&¬d§ä¬Û²Å¦X°O¿ý,¨ú´y­z¤º®e
*!*			IF FOUND("work_order_tmp")
*!*				_work_order_tmp_name = "work_order_tmp"
*!*			ELSE 
*!*				Select work_order_tmp0
*!*				LOCATE FOR id=_itemID												
*!*				_work_order_tmp_name = "work_order_tmp0"
*!*			ENDIF 
		
		Update item_cancel_tmp Set Undefine=.F. ,Printer=&_work_order_tmp_name..Printer,descinvcn=descdisp,descinven=descdisp,desckit=descdisp Where uid=_uid

	Else

*!*			Select work_order_tmp
*!*			Seek _itemID												&&¬d§ä¬Û²Å¦X°O¿ý,¨ú´y­z¤º®e
*!*			IF FOUND("work_order_tmp")
*!*				_work_order_tmp_name = "work_order_tmp"
*!*			ELSE 
*!*				Select work_order_tmp0
*!*				LOCATE FOR id=_itemID												
*!*				_work_order_tmp_name = "work_order_tmp0"
*!*			ENDIF 

		Update item_cancel_tmp Set descdisp=Iif(_system_langue="CN",&_work_order_tmp_name..desccn,&_work_order_tmp_name..Descen),;
			item_code=&_work_order_tmp_name..Code,Undefine=.F. ,Printer=&_work_order_tmp_name..Printer,descinvcn=&_work_order_tmp_name..descinvcn,descinven=&_work_order_tmp_name..descinven,desckit=&_work_order_tmp_name..desckit;
			WHERE uid=_uid

	Endif
	Select item_cancel_tmp
	Go _recno
	Skip
Enddo



Select item_cancel_tmp
Scan For printed And Undefine=.F.		&&FIX¡@2009.06.16    sitem  print error

	If order_item_print("item_cancel_tmp",_curorder,.T.,_void_reason,.F.,.F.,.F.,(_outlet_id=0),_FastFood_info,_tableno)=-1		&&¿é¥X¥´¦L

		Return

	Endif

Endscan

Endfunc


*------------------
*¦C¦Lµæ¦¡¯S§O³B²z
Function print_item_modifier

Lparameters cCursorName,ll_item_cancel

Select * From item_modi_tmp Where item_id=&cCursorName..uid  Order By modi_idx Into Cursor cun_modi_tmp
If _Tally>0

	Select cun_modi_tmp
	Scan
		_qty=modi_qty
		If 	modi_id<=0															&&¶¡¹j½u

			If Vartype(__kit_modi_print_add_line)#"U" And __kit_modi_print_add_line=.F.		&&¥i³]¸m¤£¦C¦L¶¡½u 2011.03.26

				Loop

			Endif

			_spec=Iif(modi_id=0,Replicate("-",30),'')
			_item=Iif(modi_id=0,'',Space(2)+Trim(cun_modi_tmp.descdisp))					&&message
			_qty=0

			csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi) values (?_pid,?_qty,?_spec,?_item,?_dispord,1)"

			If SQLExec(nhand,csql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions" ,1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				Return -1
			Endif

		Else

*	Lparameters _Pid,_qty,cdbf,_ismitem,_modi,_slip,_void,_must_printAmt,_other_langue

&&Lihong 2021.09.13 §ï¬°qrcode¤U³æ¦P¼Ë¥´¦L¦h»y¨¥
*!*				IF VARTYPE(__pso_order)#"U"
*!*				
*!*		
*!*					_spec="**"
*!*					_item=Iif(modi_id=0,'',Space(2)+Trim(cun_modi_tmp.descdisp))					&&message
*!*					_qty=0

*!*					csql="insert into order_print_detail (pid,qty,spec,item,dispord,modi) values (?_pid,?_qty,?_spec,?_item,?_dispord,1)"

*!*					If SQLExec(nhand,csql)<0
*!*						Aerror(err)
*!*						Sqlrollback(nhand)
*!*						SQLSetprop(nhand,"Transactions" ,1)
*!*						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*						Return -1
*!*					Endif		
*!*					
*!*				
*!*				ELSE
			

				If MULT_ORDER_ITEM(_Pid,_qty,"cun_modi_tmp",.F.,.T.,.F.,ll_item_cancel,.F.,.F.)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥(¯S§O³B²z)
					If Used("cun_modi_tmp")
						Select cun_modi_tmp
						Use
					Endif
					Return -1
				ENDIF
			
*!*				ENDIF
			
			
			
		Endif

		_dispord=_dispord+1

	Endscan

Endif

Use In cun_modi_tmp

Return 1

Endfunc


*--------------------------
*¶µ¥ØÂàÂi
*
Function order_item_move

Lparameters cSorceTableno,cTargetTableno,nInv_ID,ll_for_android


If Vartype(_android_return_message)="U"		&& FOR android rms6

	_android_return_message=""

Endif


_tableno=cSorceTableno


If Vartype(nInv_ID)#"N"


	nInv_ID=0

Endif

***************************************
If _run_mode="barcode"		&&----------------------±ø½X¼Ò¦¡-------------------------

	If Len(cTargetTableno)>4
		Local _Nid
		_Nid=Val(cTargetTableno)
		ssql="select  id,tableno,pplcnt,used_station,mincharge_mode from order_main where id=?_Nid and barcode=1"
	Else

		ssql="select  id,tableno,pplcnt,used_station,mincharge_mode from order_main where tableno=?cTargetTableno and barcode=1"

	Endif


	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Select item_move_tmp
		Use
		write_log(164,"tbl:"+_tableno+" sql error")
		_android_return_message="sql error1"

		Return	-1

	Endif

	If  Eof("cun_tmp")
		Select item_move_tmp
		Use
		If ll_for_android=.F.
			fmessagebox("_table_notfound")			&&Âi»O¤£¦s¦b!
		Endif

		write_log(164,"tbl:"+_tableno+" target table not exists")
		_android_return_message=getmessage("_table_notfound")

		Return -1

	Endif

	If Isnull(cun_tmp.used_station)=.F. And Empty(cun_tmp.used_station)=.F.
		Select item_move_tmp
		Use

		If ll_for_android=.F.

			fmessagebox("_table_inuse_by_others")				&&¥Ø¼Ð¦b¨Ï¥Î¤¤,¤£¤¹³\ÂàÂi
		Endif

		write_log(164,"tbl:"+_tableno+" target table in use")

		_android_return_message=getmessage("_table_inuse_by_others")

		Return -1
	Endif

	If Reccount("cun_tmp")>1 		&&¦p¦³¬Û¦PªºÀ\Âi¡A¤£¤¹³\ÂàÂi
		Select item_move_tmp
		Use

		If ll_for_android=.F.

			fmessagebox("_tableno_more_than_one")				&&¬Û¦PÂi¸¹¦h©ó¤@­Ó

		Endif

		write_log(164,"tbl:"+_tableno+" target table in use")

		_android_return_message=getmessage("_tableno_more_than_one")

		Return -1

	Endif

	_target_mincharge_mode=cun_tmp.mincharge_mode 									&&¥Ø¼ÐÂi³Ì§C®ø¶O¼Ò¦¡( 1-¨CÂi,2,¨C¤H ,0 µL) ­n¸òoutlet¬O§_¦¬³Ì§C®ø¶O

	_order_id=cun_tmp.Id
	_pplcnt=cun_tmp.pplcnt															&&¥Ø¼ÐÂi¤H¼Æ

	ssql="select MAX(uid) as max_uid from order_detail where id=?_order_id"
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		write_log(164,"tbl:"+_tableno+" sql error")

		_android_return_message="sql error2"

		Return -1
	Endif

	_max_uid=Iif(Isnull(cun_tmp.max_uid),1,cun_tmp.max_uid+1)

	_source_tablenmae= cSorceTableno
	_target_tablenmae=cTargetTableno 
	
	
	_belongdate=getbelongdate()


Else	&&--------------------------- °ó®y¼Ò¦¡  --------------------------------
*SET STEP ON 
	&&Lihong 2022.04.22 ¤lÂi¥¼¿é¤J"-"¸¹
	lctableno_as_sub = "" 
	IF LEN(cTargetTableno) > 1 AND ISALPHA(RIGHT(cTargetTableno, 1)) 
		lctableno_as_sub = LEFT(cTargetTableno, LEN(cTargetTableno)-1) + "-" + RIGHT(cTargetTableno, 1)
	ENDIF 

	ssql="select * from tables where tableno=?_tableno and nsubtable=0" 			&&¨ú·½Âi«H®§(¦Ò¼{¤ÀÂiª¬ºA)
	ssql=ssql+Chr(10)+"select * from tables where "+IIF(EMPTY(lctableno_as_sub),"tableno=?cTargetTableno","(tableno=?cTargetTableno or tableno=?lctableno_as_sub)")+" and nsubtable=0" &&¨ú¥Ø¼ÐÂi«H®§(¦Ò¼{¤ÀÂiª¬ºA)
	ssql=ssql+Chr(10)+"select  mincharge from outlet where id=?_outlet_id "		&&oulet ªº³Ì§C®ø¶O

	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Select item_move_tmp
		Use
		write_log(164,"tbl:"+_tableno+" sql error")

		_android_return_message="sql error3"

		Return -1

	ENDIF
	
	&&Lihong 2022.04.22 ¤lÂi¥¼¿é¤J"-"¸¹
	SELECT cun_tmp1
	LOCATE FOR UPPER(ALLTRIM(tableno)) == UPPER(ALLTRIM(cTargetTableno))
	IF !FOUND()
		LOCATE FOR UPPER(ALLTRIM(tableno)) == UPPER(ALLTRIM(lctableno_as_sub))
		cTargetTableno = lctableno_as_sub
		_target_tablenmae=cTargetTableno 
	ENDIF 
	
	If Eof("cun_tmp1")
		Select item_move_tmp
		Use

		If ll_for_android=.F.

			fmessagebox("_table_notfound")			&&Âi»O¤£¦s¦b!

		Endif

		write_log(164,"tbl:"+cTargetTableno+" target table not exists")
		_android_return_message=cTargetTableno + " " + getmessage("_table_notfound")

		Return -1

	Endif

	&&Lihong 2022.12.15
	IF TRIM(cun_tmp1.Status)="P" 
		IF (NVL(cun_tmp1.nshare_order,0)>1 OR NVL(cun_tmp1.split,0)>0)
			USE IN SELECT("item_move_tmp")
			If ll_for_android=.F.
				lcmsg=cTargetTableno + " " + getmessage("_order_split_no_move") &&Âi»O¤£¦s¦b!
				fmessagebox(lcmsg)			
			Endif

			write_log(164,"tbl:"+cTargetTableno+" target table order split")
			_android_return_message=cTargetTableno + " " + getmessage("_order_split_no_move")
			Return -1
		ELSE
			IF SQLEXEC(nhand,"select top 1 id from inv_split with (nolock) where inv_id in ;
			(select ISNULL(b.inv_id,0) from tables a with (nolock) left join order_main b with (nolock) on a.order_id=b.id where a.tableno=?cTargetTableno)","cun_tmp_target")<0		&&
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				USE IN SELECT("item_move_tmp")

				write_log(164,"tbl:"+cTargetTableno+" sql error : inv_split")
				_android_return_message="sql error: inv_split"
				Return -1
			ENDIF
			IF RECCOUNT("cun_tmp_target")>0
				USE IN SELECT("item_move_tmp")
				USE IN SELECT("cun_tmp_target")
				If ll_for_android=.F.
					lcmsg=cTargetTableno + " " + getmessage("_inv_split_no_move") &&µo²¼¦³¤À±b,¤£¤¹³\ÂàÂi¡I
					fmessagebox(lcmsg) 	
				ENDIF 
				
				write_log(164,"tbl:"+cTargetTableno+" target table inv split")
				_android_return_message=cTargetTableno + " " + getmessage("_inv_split_no_move")
				Return -1
			ENDIF 
			USE IN SELECT("cun_tmp_target")
		ENDIF 
	Endif
	
	
	*
	&&Lihong 2021.12.29 ¦PÂi 
	LOCAL llis_same_table1
	IF VARTYPE(__same_tables)#"U" and __same_tables 
		TEXT TO ssql NOSHOW  
			SELECT b.*, a.tableno, c.status, c.inv_lock, c.order_id, c.inv_id, c.ppl, c.have_unfinish, c.begindate as begintime, c.minamtmethod, c.remark, c.remark2 FROM same_table_detail a WITH (nolock) LEFT JOIN same_table b WITH (nolock) ON a.same_table_id = b.id 
			left join tables c WITH (nolock) on a.tableno=c.tableno and c.nsubtable=0 
			WHERE a.same_table_id in (SELECT same_table_id FROM same_table_detail WITH (nolock) WHERE tableno = ?cTargetTableno)
			order by a.tableno 
		ENDTEXT 
		IF SQLEXEC(nhand, ssql, "same_table_tmp1")<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Select item_move_tmp
			Use
			write_log(164,"tbl:"+cTargetTableno+" sql error : same_tables")
			_android_return_message="sql error4"
			Return -1
		ENDIF
		llis_same_table1 = (RECCOUNT("same_table_tmp1")>1)

		IF llis_same_table1 = .T.
			SELECT same_table_tmp1
			LOCATE FOR !EMPTY(NVL(merge_to_tableno, "")) &&(ALLTRIM(status)=="M" OR ALLTRIM(status)=="P" OR ALLTRIM(status)=="T") AND order_id>0 &&"M" "P" OR "T" ¤w¦X¨Ö«h©l²×¾Þ§@¦X¨ÖÂi³æ
			IF FOUND("same_table_tmp1") AND !ALLTRIM(same_table_tmp1.merge_to_tableno)==TRIM(cTargetTableno)
				*§ï¬°ÂIÀ»¦X¨ÖÂi?
				lcmsg = getmessage("_same_table_merged") + " " &&¦PÂiµæ¦¡¤w¦X¨Ö,½ÐÂIÀ» The item of same table have merged, please click
				lcmsg = lcmsg + TRIM(same_table_tmp1.merge_to_tableno) &&+ " " + getmessage("_same_table_merged2") &&Âi¾Þ§@  operation
				If ll_for_android=.F.
					fmessagebox(lcmsg)
				ENDIF 

				Select item_move_tmp
				Use
				write_log(164,"tbl:"+lcmsg )
				_android_return_message=lcmsg
				
				USE IN SELECT("same_table_tmp1")
				Return -1
			ENDIF 
		ENDIF
		USE IN SELECT("same_table_tmp1") 
	ENDIF 
	*
	
	*
	IF VARTYPE(__storellet)#"U" AND __storellet  &&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h¤]¤£¥Î§ï
		SELECT * FROM item_move_tmp WHERE uid in (SELECT item_id FROM item_disc_tmp WHERE disc_id=-8) INTO CURSOR coupon_tmp1
		IF _Tally>0
			TEXT TO ssql TEXTMERGE NOSHOW 
			select memberno from order_main b WITH (nolock) left join tables t WITH (nolock) on b.id=t.order_id and b.tableno=t.tableno and t.nsubtable=0 
			where b.id>0 and b.tableno=?cTargetTableno and t.order_id is not null

			ENDTEXT 
			IF SQLEXEC(nhand, ssql, "coupon_tmp")<0
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Select item_move_tmp
				Use
				write_log(164,"tbl:"+_tableno+"->"+cTargetTableno+" sql error : memberno")
				_android_return_message="sql error4"
				USE IN SELECT("coupon_tmp1")
				Return -1
			ENDIF
			IF NVL(coupon_tmp.memberno, 0)<>storellet_member_id 
				lcmsg = getmessage("_item_disc_coupon_diff_member") &&§é¦©¨Ï¥Î¤FÂ§¨é¡A ¥Ø¼ÐÂi·|­û¤£¬Û¦P¡A¤£¯àÂàÂi¡I Discount uses coupon, but different member, cannot change table !
				SELECT coupon_tmp1
				SCAN 
					lcmsg = lcmsg + CHR(13) + LEFT(item_code,10) + TRIM(descdisp) 
				ENDSCAN 
				If ll_for_android=.F.
					fmessagebox(lcmsg)
				ENDIF 

				Select item_move_tmp
				Use
				write_log(164,"tbl:"+_tableno+"->"+cTargetTableno+","+lcmsg )
				_android_return_message=lcmsg
				
				USE IN SELECT("coupon_tmp1")
				USE IN SELECT("coupon_tmp")
				Return -1
			ENDIF 
			USE IN SELECT("coupon_tmp1")
			USE IN SELECT("coupon_tmp")
		ENDIF 
	ENDIF 
	*
	
	If !Empty(cun_tmp1.used_station)

		If ll_for_android=.F.

			fmessagebox("_table_inuse_by_others")				&&¥Ø¼Ð¦b¨Ï¥Î¤¤,¤£¤¹³\ÂàÂi
		Endif

		Select item_move_tmp
		Use
		write_log(164,"tbl:"+_tableno+" target table in use")

		_android_return_message=getmessage("_table_inuse_by_others")

		Return -1
	Endif

	If Upper(Trim(cun_tmp1.Status))="L"

		If ll_for_android=.F.

			fmessagebox("_table_is_locked")					&&¥Ø¼Ð³QÂê©w

		Endif

		Select item_move_tmp
		Use
		write_log(164,"tbl:"+_tableno+" target table is locked")

		_android_return_message=getmessage("_table_is_locked")


		Return -1

	Endif

	_target_outletID=cun_tmp1.outlet_Id												&&¥Ø¼ÐÂi°Ï°ìid

	If SQLExec(nhand,"select mincharge from outlet where id=?_target_outletID","cun_tmp2")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		write_log(164,"tbl:"+_tableno+" sql error")
		_android_return_message="sql error4"

		Return -1

	Endif

	_source_status=cun_tmp.Status
	_source_inv=Nvl(cun_tmp.inv_Id,0)
	_source_outlet=cun_tmp.outlet_Id		&&·½ÂiªºOUTLET_ID
	
	_source_tablenmae= cSorceTableno + IIF( EMPTY(ALLTRIM(NVL(cun_tmp.name,""))) ,"" , "<"+ TRIM(cun_tmp.name) +">")

	_status=cun_tmp1.Status				&&¥Ø¼ÐÂi
	_order_id=cun_tmp1.order_id
	_parent_table=Trim(cun_tmp1.parent_table)
	_target_inv=Nvl(cun_tmp1.inv_Id,0)
	_target_outlet=cun_tmp1.outlet_Id	&&¥Ø¼ÐÂiªºoutlet_id

	_target_pplcnt=cun_tmp1.ppl		&&¥Ø¿ý»Oªº¤H¼Æ

	_target_tablenmae= cTargetTableno + IIF( EMPTY(ALLTRIM(NVL(cun_tmp1.name,""))) ,"" , "<"+ TRIM(cun_tmp1.name) +">")


	If Vartype(__table_can_chg_diff_outlet)#"U" And __table_can_chg_diff_outlet=.F. And _source_outlet<>_target_outlet		&&¤£¦P°Ï°ì¬O§_¥iÂàÂi¸ò³]©w

		If ll_for_android=.F.

			fmessagebox("_table_nosame_outlet_nochange")

		Endif

		_android_return_message=getmessage("_table_nosame_outlet_nochange")


		Select item_move_tmp
		Use

		Return -1



	Endif


	_target_mincharge=Iif(cun_tmp2.mincharge,cun_tmp1.mincharge,0)											&&¥Ø¼ÐÂi³Ì§C®ø¶O
	_target_mincharge_mode=Iif(cun_tmp2.mincharge,cun_tmp1.minamtmethod,0)									&&¥Ø¼ÐÂi³Ì§C®ø¶O¼Ò¦¡( 1-¨CÂi,2,¨C¤H ,0 µL)
	_pplcnt=cun_tmp1.ppl															&&¥Ø¼ÐÂi¤H¼Æ


	
	

	Use In cun_tmp2

	If _status$"PT" And __tables_can_chg_after_print  =.F.					&&¦pªG¥Ø¼ÐÂi¤w¦L³æ,¬O§_¤¹³\¶µ¥ØÂàÂi­n¸ò³]©w	************

		If ll_for_android=.F.

			fmessagebox("_notallow_move_to_inv_printed")

		Endif

		_android_return_message=getmessage("_notallow_move_to_inv_printed")

		Select item_move_tmp
		Use

		Return -1

	Endif

	&&Lihong 2022.10.05
	IF _order_id>0 AND VARTYPE(lnitem_move_source_order_id)="N" AND lnitem_move_source_order_id=_order_id &&AND lnitem_move_source_order_id>0 
		If ll_for_android=.F.
			fmessagebox("_change_table_same_order_id") &&ÂàÂi¥¢±Ñ¡A·½Âi¥Ø¼ÐÂi³æ¸¹¬Û¦P Change table fail, Sorce target table same order id 
		ENDIF 
		_android_return_message = getmessage("_change_table_same_order_id")
		write_log(164,"tbl:"+cSorceTableno+"->"+cTargetTableno+" same orderid: " + TRANSFORM(lnitem_move_source_order_id))
		Return -1
	ENDIF 

	If _order_id>0											&&¥Ø¼ÐÂi¤w¦³¸¨³æ

		ssql="select MAX(uid) as max_uid from order_detail where id=?_order_id"
		If SQLExec(nhand,ssql,"cun_tmp")<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			write_log(164,"tbl:"+_tableno+" sql error")
			Return -1

		Endif

		_max_uid=Iif(Isnull(cun_tmp.max_uid),0,cun_tmp.max_uid)

	Else
		_max_uid=0

	Endif

	ssql="select MAX(updateno) as max_updateno from  inv"					&&inv updateno
	If SQLExec(nhand,ssql,"cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return  -1

	Endif
	_updateno=Iif(Isnull(cun_tmp.max_updateno),1,cun_tmp.max_updateno+1)


	Select item_move_tmp
	Count To N For  hold>0 Or Undefine		&&¬O§_¦³¥s°_©Î¥¼©wµæ¦¡

	_have_unfinish=(N>0)

	 SQLSetprop(nhand,"Transactions",2)
	
				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						
	If Empty(_status) Or _status="C"	Or _status="S"					&&¥Ø¼ÐÂi¬OªÅÂi/©Î²M²z/´N®y¤¤,«h¦border_main¥[¤J¤@­Ó·sªºorder

		Select item_move_tmp
		Sum  orgamt,amount,real_amount,modi_amount,disc_amount,srv_amount,tax_amount To _orgamt,_amount,_realAmt,_modiamt,_item_discamt,_srvamt,_taxamt

		_invamt0=_realAmt							&&À³¥Iª÷ÃB
		_invamt=rounding_amount(_invamt0)			&&¹sÀY³B²z
		_rndamt=_invamt-_invamt0					&&·L½Õ

		_item_discamt=-1*_item_discamt		&&§é¦©ªö¥Î­t¼Æ

		_cost=0		&&¦¨¥»(¥¼¥[¤J)

		&&lihong 2022.12.01
		_srv_rate=0
		
		If Empty(_status)

			Select work_order_tmp9
			Locate For Id=_target_outletID
			If Found()
				_pplcnt=pplcnt			&&¥Ø¼ÐÂi©Ò¦b°Ï°ìªº¹w³]¤H¼Æ
				_srv_rate=Iif(svccharge,__min_charge_srv_rate,0)		&&³Ì§C®ø¶O¬O§_¦¬ªA°È¶O¸ò°Ï°ì³]©w

			Else
				_pplcnt=1				&&¤H¼Æ
			Endif

		Else

			_pplcnt=_target_pplcnt

		Endif

		*
		If _order_id>0
		ELSE 
			Local _rand_id, _retry, rand_id_sql
			_retry = 0
			Do Whil .T.
				_rand_id=Int(Rand(0)*9999) &&¨úÀH¾÷ID
				IF _rand_id = 0 OR _rand_id<1000 &&Lihong 2020.09.29 &&2022.02.17 >1000
					LOOP 
				ENDIF 
				rand_id_sql="select id from order_main with (nolock) where id=?_rand_id union select order_id as id from tables with (nolock)  where order_id=?_rand_id" &&Lihong 2020.07.17 union

				If SQLExec(nhand,rand_id_sql,"cun_tmp")<0

					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif

				If !Eof("cun_tmp")

					Loop

				Endif
				_order_id=_rand_id
				EXIT 
			ENDDO 
		ENDIF 
		*

		TEXT TO ssql NOSHOW &&@max_id -> ?_order_id &&lihong 2022.12.01 ¦s¦b¤£§R°£ --delete from order_main where id=?_order_id

				-- SELECT ISNULL(MAX(id),0)+1 as max_id FROM order_main

				-- DECLARE @max_id int
				-- SELECT @max_id=ISNULL(MAX(id),0)+1 FROM order_main
				
				if NOT exists (select id from order_main where id=?_order_id) 
				INSERT INTO order_main (id,inv_id,tableno,askno,pplcnt,begintime,
					orgamt,amount,modiamt,itemdiscamt,srvamt,taxamt,discamt,
					rndamt,invamt,cost,recused,printed,printtime,mincharge_mode,outlet_id) values (
					?_order_id,0,?cTargetTableno,'',?_pplcnt,getdate(),
					?_orgamt,?_amount,?_modiamt,?_item_discamt,
					?_srvamt,?_taxamt,0,?_rndamt,?_invamt,?_cost,0,1,getdate(),?_target_mincharge_mode,?_target_outlet)
				
				update tables set status='U',order_id=?_order_id,begindate=getdate(),ppl=?_pplcnt,have_unfinish=?_have_unfinish where tableno=?cTargetTableno and nsubtable=0


		ENDTEXT


		If SQLExec(nhand,ssql)<0 &&,"cun_tmp"
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)

			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			write_log(164,"tbl:"+_tableno+" sql error")
			Return -1

		Endif

		&&_order_id=cun_tmp.max_id

		If _target_mincharge>0		&&¦pªG¥Ø¼ÐÂi¦³³Ì§C®ø¶O,«h¥[¤J³Ì§C®ø¶O

			_mincharge=Iif(_target_mincharge_mode=2,_target_mincharge*_pplcnt,_target_mincharge)
			_mincharge_per=_srv_rate 
			_desc=getmessage("_mincharge_diff")							&&³Ì§C®ø¶O®tÃB

			&&lihong 2022.12.01 ¤£¦s¦b¤~¼W¥[
			csql="if not exists (select id from order_detail where id=?_order_id and item_Id=-3) "

			csql=csql+CHR(13)+"INSERT INTO  order_detail (id,uid,parent_id,cate_id,item_Id,item_code,descdisp,qty,price,"+;
				"orgamt,amount,real_amount,round_amount,sitem,sitem_sub,mitem,mustmodi,hold,printed,printtime,adduser,modi_list,"+;
				"modi_amount,disc_amount,srv_amount,srv_per,tax_amount,tax_per,level_disc,level_id,drink_qty,recused,"+;
				"sprinter,remin_times,xdisc,onlysave,handwriting,hhqty,hhprice,undefine,mitem_id, "+;
				"timer_active,timer_style ,free_hours ,free_style ,timer_begtime ,timer_endtime ,timer_mincharge,timer_disc,printer,srv_per_org )"+;
				" values (?_order_id,0.1,0,-3,-3,'',"+;
				"?_desc,1,?_mincharge,?_mincharge,?_mincharge,?_mincharge,0,"+;
				"0,0,0,'',"+;
				"0,0,getdate(),?_login_user_name,"+;
				"'',0,"+;
				"0,0,?_mincharge_per,"+;
				"0,0,0,"+;
				"0,0,0,"+;
				"'',0,0,0,"+;
				"0,0,0,0,0,"+;
				"0,0,0,0,'','',0,0,'',?_mincharge_per)"

			If SQLExec(nhand,csql)<0
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				write_log(164,"tbl:"+_tableno+" sql error")

				Return -1

			Endif

		Endif

	Endif


*------------------------------------------------------>>>>>>>>>>¥Ø¼ÐÂiª¬ºA­×§ï
	ssql=""

	If _target_inv>0		&&¦pªG¥Ø¼ÐÂi¤w¦L³æ©Î´¿¦L³æ
		ssql="update tables set status='T',ready_pay=0 where tableno=?cTargetTableno and status='P' and nsubtable=0"				&&¦pªG¥Ø¼ÐÂi¤w¦L³æ,§ó§ï¬°´¿¦L³æ

		ssql=ssql+Chr(10)+"if not exists (select inv_id from inv_problem where inv_id=?_target_inv)  insert into inv_problem (inv_id,reprint_times) values (?_target_inv,1)"				&&°O¿ý°ÝÃDµo²¼

	Endif

	ssql=ssql+Chr(10)+"update tables set status='U',order_id=?_order_id where tableno=?cTargetTableno and inv_id=0 and nsubtable=0"	&&¦pªG¥Ø¼ÐÂi¤J®y,§ó§ï¬°´NÀ\
	

	If _have_unfinish

		ssql=ssql+Chr(10)+"update tables set have_unfinish=?_have_unfinish where tableno=?cTargetTableno and nsubtable=0"
	Endif


	_belongdate=getbelongdate()


*-----------------------------------------------------<<<<<<<<<<<<

	If _move_all	&&¬O§_¥þ³¡Âà²¾
		
		&&Lihong 2021.11.24 cut order ¼W¥[cut_time off_time
		ssql=ssql+Chr(10)+"update tables set status='S',inv_id=0,ready_pay=0, cut_time=null, off_time=null where tableno=?_tableno  and nsubtable=0"	&&¦pªG·í«eÂi¤w¦L³æ,§ó§ï¬°´N®y

	Else

		ssql=ssql+Chr(10)+"update tables set status='T' ,ready_pay=0 where tableno=?_tableno and status='P' and nsubtable=0"	&&¦pªG·í«eÂi¤w¦L³æ,§ó§ï¬°´¿¦L³æ

	Endif

	If _move_all And nInv_ID>0		&&¦pªG·í«eµo²¼¤w¦L³æ,¨ú®øµo²¼
		_inv_id=nInv_ID

		_void_reason=0
		ssql=ssql+Chr(10)+"update inv set void=1,voidreason=?_void_reason,voidtime=?DATETIME(),voiduser=?_login_user_name,belongdate=?_belongdate,updateno=?_updateno where id=?_inv_id"		&&¨ú®øµo²¼

	Else

		If _source_inv>0		&&¦pªG²Ä¤@¦¸¶µ¥ØÂàÂi,°O¿ý°ÝÃDµo²¼
			ssql=ssql+Chr(10)+"if not exists (select inv_id from inv_problem where inv_id=?_source_inv)  insert into inv_problem (inv_id,reprint_times) values (?_source_inv,1)"				&&°O¿ý°ÝÃDµo²¼

		Endif

	Endif

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		Return -1

	Endif

Endif

Local lcStation

lcStation=getcomputername()



Select item_move_tmp
Scan For !Deleted()
	_uid=uid


	If Vartype(__change_table_stop_timer)#"U" And __change_table_stop_timer

		ssql="update order_detail set timer_active=0 where id=?_curorder and uid=?_uid "	&&  stop timer
		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			write_log(164,"tbl:"+_tableno+" sql error")
			IF VARTYPE(_android_return_message) <> "U"
				_android_return_message = "sql error5"
			ENDIF 
			Return -1

		Endif



	Endif

	&&Lihong 2022.11.28 ³Ì§C ¥[¦¬ªA°È¶O
	If SQLExec(nhand,"update order_detail set srv_per=srv_per_org where id=?_curorder and uid=?_uid and srv_per_org is not null")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error6"
		ENDIF 
		Return -1

	Endif

	ssql="update order_detail set parent_id=parent_id+?_max_uid where id=?_curorder and uid=?_uid and parent_id>0"							&&§ó·s®MÀ\¤l¶µ¥Ø
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error6"
		ENDIF 
		Return -1

	Endif

	TEXT TO ssql NOSHOW TEXTMERGE &&Lihong 2022.04.20 ¦PÂiµo²¼¥I´Ú³æ¤À®à¸¹ same_tableno=''


		update order_detail set id=<<_order_id>>,uid=uid+ <<_max_uid >>,qty=?item_move_tmp.qty, same_tableno='' where id=<<_curorder>> and uid=<<_uid>>
	ENDTEXT

&& 2013.09.02  ¼Æ¶q¥i¥H©î¤À qty=?item_move_tmp.qty

*_cliptext=ssql
*	ssql="update order_detail set id=?_order_id,uid=uid+?_max_uid where id=?_curorder and uid=?_uid"							&&§ó·sorder_detail¬°¥Ø¼ÐÂi
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error7"
		ENDIF 
		Return -1

	Endif



	ssql="update order_modi set id=?_order_id,item_id=item_id+?_max_uid where id=?_curorder and item_id=?_uid"		&&§ó·sorder_modi
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error5"
		ENDIF 
		Return -1

	Endif

*!*		&&Lihong 2021.04.23 ¦P®É³B²zdisc_log
*!*		If nInv_ID>0
*!*			Select item_disc_tmp
*!*			SCAN For item_id=_uid
*!*				ssql =" update disc_log set void = 1 ,datetime= getdate() where disc_type='1' and id = (select MAX(id) from disc_log where disc_type='1' and inv_no=?nInv_ID and disc_id=?item_disc_tmp.disc_id and disc_amount = ?item_disc_tmp.disc_amount) "
*!*				If SQLExec(nhand, ssql)<0
*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions",1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*					write_log(164,"tbl:"+_tableno+" sql error")
*!*					Return -1
*!*				ENDIF 
*!*			ENDSCAN 
*!*		ENDIF 
*!*		&&Lihong 2021.04.23 ¦P®É³B²zdisc_log ¥Ø¼Ð¤w¦L³æ­ì¨Ó¤£·|±a¥h§é¦©¡]À³¬Oload®É¨úinv³y¦¨¡A²K¥[?¡^
*!*		IF VARTYPE(_target_inv)="N" AND _target_inv>0
*!*			Select item_disc_tmp
*!*			LOCATE FOR  item_id=_uid
*!*			IF FOUND()
*!*				TEXT TO ssql noshow

*!*				DECLARE @max_id int
*!*				SELECT @max_id=ISNULL(MAX(id),0)+1 FROM disc_log

*!*				INSERT INTO [disc_log]
*!*				           ([id]
*!*				           ,[datetime]
*!*				           ,[disc_type]
*!*				           ,[disc_id]
*!*				           ,[descdisp]
*!*				           ,[disc_amount]
*!*				           ,[inv_no]
*!*				           ,[adduser]
*!*				           ,[void]
*!*				           ,[tableno])
*!*				     VALUES
*!*				           (@max_id
*!*				           ,getdate()
*!*				           ,'1'
*!*				           ,?item_disc_tmp.disc_id
*!*				           ,(select top 1 desccn from disc where id=?item_disc_tmp.disc_id )
*!*				           ,?item_disc_tmp.disc_amount
*!*				           ,?_target_inv
*!*				           ,?_login_user_name
*!*				           ,0
*!*				           ,?cTargetTableno)
*!*					
*!*					--update inv_itemdisc set id=?_target_inv,item_id=item_id+?_max_uid where id=?_target_inv and item_id=?_uid 
*!*				ENDTEXT
*!*				If SQLExec(nhand, ssql)<0
*!*					Aerror(err)
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions",1)
*!*					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*					write_log(164,"tbl:"+_tableno+" sql error")
*!*					Return -1
*!*				ENDIF
*!*			ENDIF  
*!*		ENDIF 

	&&Lihong 2021.04.23 ¦L³æ«á§é¦©
	_update_after_inv = ""
	IF VARTYPE(_target_inv)="N"
		_update_after_inv = ", after_inv=" + IIF(VARTYPE(_target_inv)="N" AND _target_inv>0, "1", "0")
	ENDIF 
	
	ssql="update order_itemdisc set id=?_order_id,item_id=item_id+?_max_uid" + _update_after_inv + " where id=?_curorder and item_id=?_uid"	&&§ó·sorder_itemdisc
	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error8"
		ENDIF 
		Return -1

	Endif


	ssql="update order_itemdept set order_id=?_order_id,parent_id=parent_id+?_max_uid where order_id=?_curorder and parent_id=?_uid"	&&§ó·sorder_itemdept

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error9"
		ENDIF 
		Return -1

	Endif


	If nInv_ID>0

		&&Lihong 2021.04.23 §ï¬°¦p¤U ssql=ssql+Chr(10)+"delete from inv_itemdisc where id=?nInv_Id and item_id=?_uid"				&&¦pªG´¿¦L³æ,§R°£¬ÛÀ³ªº¶µ¥Ø§é¦©
		ssql="delete from inv_itemdisc where id=?nInv_Id and item_id=?_uid"				&&¦pªG´¿¦L³æ,§R°£¬ÛÀ³ªº¶µ¥Ø§é¦©
		
		&&Lihong 2021.04.23 ±q¤U­±²¾¨Ó
		If SQLExec(nhand,ssql)<0
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			write_log(164,"tbl:"+_tableno+" sql error")
			IF VARTYPE(_android_return_message) <> "U"
				_android_return_message = "sql error10"
			ENDIF 
			Return -1

		Endif

	Endif

	&&Lihong 2021.04.23 ²¾¤J¤W­±if¤¤
*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			write_log(164,"tbl:"+_tableno+" sql error")
*!*			Return -1

*!*		Endif


	TEXT TO ssql noshow

		DECLARE @nid int
		SELECT @nid=ISNULL(MAX(id),0)+1 FROM item_move


		INSERT INTO [item_move]
		           ([id]
		           ,[datetime]
		           ,[adduser]
		           ,[station]
		           ,[table_from]
		           ,[table_to]
		           ,[item_id]
		           ,[qty]
		           ,[price]
		           ,[amount]
		           ,[inv_id]
		           ,[cln]
		           ,[belongdate]
		           ,[kit_disp_uid]
		           ,[to_printer] )
		     VALUES
		           (@nid
		           ,getdate()
		           ,?_login_user_name
		           ,?lcStation
		           ,?cSorceTableno
		           ,?cTargetTableno
		           ,?item_move_tmp.item_id
		           ,?item_move_tmp.qty
		           ,?item_move_tmp.price
		           ,?item_move_tmp.amount
		           ,?nInv_ID
		           ,0
		           ,?_belongdate
		           ,?item_move_tmp.kit_disp_uid
		           ,?item_move_tmp.to_printer )


	ENDTEXT


	If SQLExec(nhand,ssql)<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error11"
		ENDIF 
		RETURN -1

	Endif



Endscan

*-----------------------------------------------
&&Lihong 2022.03.09 &&Àç·~°Ï°ì¬O§_¦C¦L¼p©Ð³æ
_print_to_kitchen_outlet = .T.
IF Upper(_run_mode)=="DINE"
	ssql="select slip_print, inv_print, paylist_print,kit_print from outlet where id=?_source_outlet or id=?_target_outlet"	
	If SQLExec(nhand,ssql, "cun_tmp")<0
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		write_log(164,"tbl:"+_tableno+" sql error")
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error outlet"
		ENDIF 
		Return -1
	ENDIF
	SELECT cun_tmp
	GO TOP 
	_print_to_kitchen_outlet = NVL(cun_tmp.kit_print, .F.)
	LOCATE FOR RECNO()>1
	_print_to_kitchen_outlet = (_print_to_kitchen_outlet=.T. or NVL(cun_tmp.kit_print, .F.)=.T. )
ENDIF 

If  __notify_kit_when_move_table AND __print_to_kitchen AND (!Upper(_run_mode)=="DINE" OR _print_to_kitchen_outlet=.T.)	&&ÂàÂi³qª¾¼p©Ð(¸ò setting )¡A¦C¦L¦a¤è«ö­ì¨Ó­ì¦L¦a¤è

	Select item_move_tmp
	SCAN For !Deleted() AND (mitem=.F. or undefine=.F.) AND sitem=.F. &&Lihong 2023.04.27 AND (mitem=.F. or undefine=.F.) AND sitem=.F.
		_printer=Iif(Empty(sprinter),Trim(Printer),Trim(sprinter))

		Dimension sp(1)			&&¤À¸Ñ¥´¦L¾÷
		getmstring(_printer,@sp)

		For k=1 To Alen(sp)		&&¦V¨C¤@»O«ü©w¥´¦L¾÷µo°e¤@­Ó§@·~

			_printer=Val(sp(k))

			_Pid="KIT"+Alltrim(Str(__nServer))+Alltrim(Str(Int(Rand()*99)))+Ltrim(Sys(2015),"_")				&&ÀH¾÷½X,«e­±ªº"KIT"¬O¼Ð°O,¥Î©ó¥´¦L±±¨î

			Select work_order_tmp12
			Locate For Id=_printer
			_cprinter=Trim(Printer)
			_place=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))

			&&Lihong 2022.07.20 ÂIµæ¯¸ÂI¡A°l³æÂIµæ®É¶¡
			_order_station=""
			_remin_order_time=""
			IF !EMPTY(FIELD("add_user_station_id", "item_move_tmp")) AND NVL(item_move_tmp.add_user_station_id,0)>0 AND USED("work_order_tmp_station") &&LOWER(_dataname)=="order_itemlist_tmp" AND 
				SELECT work_order_tmp_station
				LOCATE FOR id=item_move_tmp.add_user_station_id
				_order_station = IIF(_system_langue="CN",work_order_tmp_station.desccn, work_order_tmp_station.descen)

			ELSE
				IF !EMPTY(FIELD("adduser", "item_move_tmp")) AND LOWER(ALLTRIM(NVL(item_move_tmp.adduser, "")))=="web"
					_order_station="web"
				ENDIF 
			ENDIF 
			*!*	IF _remin=.T. AND !EMPTY(FIELD("ordertime", "item_move_tmp"))
			*!*		_remin_order_time=TRANSFORM(item_move_tmp.ordertime)
			*!*	ENDIF 

			ssql="if not exists (select pid from order_print_main where pid=?_pid) "+;
				"insert into order_print_main (pid,order_id,place,username,tableno,printed,printer,def_printer,act_printer,sendtime,printtime,npage,pages,"+;
				"void_order,void_reason,allcall,langue,training,move,move_from,move_to, order_station, remin_order_time)"+;
				" values (?_pid,?_curorder,?_place,?_login_user_name,?_tableno,0,?_Cprinter,?_Cprinter,'',getdate(),'',1,1,0,'',0,?_system_langue,?GL_training,1,?_source_tablenmae,?_target_tablenmae, ?_order_station, '')"

			If SQLExec(nhand,ssql)<0

				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

				IF VARTYPE(_android_return_message) <> "U"
					_android_return_message = "sql error12"
				ENDIF 
				Return -1

			Endif

			_dispord=1
			Select item_move_tmp

			_dataname="item_move_tmp"
			_handwriting=item_move_tmp.handwriting
			_mitem=item_move_tmp.mitem
			_qty=item_move_tmp.qty

			&&Lihong 2023.04.20 ¨Ò®u ¤ç¨â §ï
			IF item_move_tmp.orgqty_case_mat>0
				_qty=item_move_tmp.orgqty_case_mat
			ENDIF 
			IF item_move_tmp.qty_entity>0
				_qty=item_move_tmp.qty_entity
			ELSE  
				ll_kilo=.F.			&&¬O§_ kilo¤è¦¡­p»ù
				If !Empty(NVL(item_move_tmp.kilo,.F.))
					ll_kilo=Nvl(item_move_tmp.kilo or item_move_tmp.kilo2,.F.)
				Endif
				IF ll_kilo=.T. 
					_qty=1
				ENDIF 
			ENDIF 

			If MULT_ORDER_ITEM(_Pid,_qty,"&_dataname",_mitem,.F.,.F.,.F.,_handwriting)= -1		&&µæ¦¡¦C¦L¦hºØ»y¨¥
				IF VARTYPE(_android_return_message) <> "U"
					_android_return_message = "MULT_ORDER_ITEM error"
				ENDIF 
				Return -1
			Endif

			_dispord=_dispord+1

			If print_item_modifier("item_move_tmp")<0	&&¯S§O³B²z

				IF VARTYPE(_android_return_message) <> "U"
					_android_return_message = "print_item_modifier error"
				ENDIF 
				Return -1
			Endif

		Endfor

	Endscan

Endif

&&Lihong 2022.01.14 ¤J®y®É¶¡
*!*	IF VARTYPE(__sit_time_type)#"U" AND __sit_time_type="_first_order" AND _run_mode<>"barcode"
*!*		TEXT TO ssql NOSHOW TEXTMERGE 
*!*			IF (select begindate from tables where tableno=?_tableno and nsubtable=0) <> (select min(ordertime) from order_detail where ID>0 AND id in (select order_id from tables where tableno=?_tableno and nsubtable=0) )
*!*				update tables set begindate=(select min(ordertime) from order_detail where ID>0 AND id in (select order_id from tables where tableno=?_tableno and nsubtable=0) ) where tableno=?_tableno and nsubtable=0
*!*			
*!*			IF exists (select id from order_detail where ID>0 AND id in (select order_id from tables where tableno=?_tableno and nsubtable=0))
*!*				update order_main set begintime=(select begindate from tables where tableno=?_tableno and nsubtable=0) WHERE id in (select order_id from tables where tableno=?_tableno and nsubtable=0) 

*!*			IF (select begindate from tables where tableno=?cTargetTableno and nsubtable=0) <> (select min(ordertime) from order_detail where ID>0 AND id in (select order_id from tables where tableno=?cTargetTableno and nsubtable=0) )
*!*			begin
*!*				update tables set begindate=(select min(ordertime) from order_detail where ID>0 AND id in (select order_id from tables where tableno=?cTargetTableno and nsubtable=0) ) where tableno=?cTargetTableno and nsubtable=0 
*!*				update order_main set begintime=(select begindate from tables where tableno=?cTargetTableno and nsubtable=0) WHERE id in (select order_id from tables where tableno=?cTargetTableno and nsubtable=0)
*!*			end
*!*			
*!*		ENDTEXT 
*!*		If SQLExec(nhand,ssql)<0
*!*			Aerror(err)
*!*			Sqlrollback(nhand)
*!*			SQLSetprop(nhand,"Transactions",1)
*!*			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

*!*			write_log(164,"tbl:"+_tableno+" sql error")

*!*			Return -1
*!*		Endif
*!*	ENDIF 


If Sqlcommit(nhand)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	write_log(164,"tbl:"+_tableno+" sql error")
	IF VARTYPE(_android_return_message) <> "U"
		_android_return_message = "sql error13"
	ENDIF 
	Return -1

Endif

SQLSetprop(nhand,"Transactions",1)

Select item_move_tmp
Scan For !Deleted()
	_uid=uid

	Delete From order_itemlist_tmp Where uid=_uid

	Delete From item_modi_tmp Where item_id=_uid		&& fix 2009.12.15
	Delete From item_disc_tmp Where item_id=_uid
	Delete From order_dept_tmp Where parent_id=_uid		&&



	write_log(165,"tbl:"+_tableno+" item:"+Trim(item_code)+" "+Trim(descdisp)+" qty:"+Alltrim(Str(qty,10,2))+" dtbl:"+cTargetTableno)	&&¼g¤JLOG
	write_log(165,"tbl:"+cTargetTableno+" item:"+Trim(item_code)+" "+Trim(descdisp)+" qty:"+Alltrim(Str(qty,10,2))+" from:"+_tableno)	&&¼g¤JLOG (¥Ø¼Ð¥x,¤è«K²Î­p)


Endscan
Select  item_move_tmp
Use
If _move_all And nInv_ID>0
	_inv_no=""

Endif


*----¥ý¶i¦æ³Æ¥÷

Select * From order_itemlist_tmp  Into Cursor order_itemlist_bak
Select * From item_modi_tmp Into Cursor item_modi_bak
Select * From item_disc_tmp Into Cursor item_disc_bak
Select * From order_disc_tmp Into Cursor order_disc_bak
Select * From order_dept_tmp Into Cursor order_dept_bak


&&Lihong 2020.03.24 ·½³æ  ll_for_android
_source_order = _curorder
_source_tableno = cSorceTableno
&&

If _run_mode="barcode"
	resave_order(cTargetTableno,_order_id,_pplcnt,_target_mincharge_mode,.T.,.T.)		&&­«·s«O¦s¥Ø¼ÐÂi¸¨³æ
Else

	resave_order(cTargetTableno,_order_id,_pplcnt,_target_mincharge_mode,.T.,.F.)		&&­«·s«O¦s¥Ø¼ÐÂi¸¨³æ
Endif


_tableno = cSorceTableno

order_backup(_order_id)

&&Lihong 2020.03.24 «O¦s·½³æ 
IF ll_for_android = .T.
	IF SQLEXEC(nhand,"select ppl from tables where tableno=?_tableno and nsubtable=0","cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error14"
		ENDIF 
		RETURN -1
	ENDIF
	_source_pplcnt = cun_tmp.ppl
	IF SQLEXEC(nhand,"select mincharge_mode from order_main where id=?_curorder","cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		IF VARTYPE(_android_return_message) <> "U"
			_android_return_message = "sql error15"
		ENDIF 
		RETURN -1
	ENDIF
	_source_mincharge_mode = cun_tmp.mincharge_mode
	If _run_mode="barcode"
		resave_order(_source_tableno, _source_order, _source_pplcnt, _source_mincharge_mode, .T., .T.)		&&­«·s«O¦s·½³æ
	Else
		resave_order(_source_tableno, _source_order, _source_pplcnt, _source_mincharge_mode, .T., .F.)		&&­«·s«O¦s·½³æ
	Endif
ENDIF 

&&Lihong 2021.06.07 ±ø½X¤J³æ
IF _run_mode="barcode" 
	IF VARTYPE(_android_return_order_id )#"U" &&Lihong 2021.06.07 ±ø½X¤J³æ
		_android_return_order_id =  _order_id
	ELSE 
		TEXT TO dbsql NOSHOW TEXTMERGE 
			UPDATE order_main SET used_station='' WHERE id = ?_order_id 
		ENDTEXT 
		=SQLExec(nhand, dbsql) 
	ENDIF 
ENDIF 

Return 1


Endfunc


*-----------------------
* get max updateno+1

Function getupdateno
Lparameters cTableName

If SQLExec(nhand,"select MAX(updateno) as updateno from "+cTableName,"cr_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

Local nUpdateno

nUpdateno=Nvl(cr_tmp.updateno,0)+1

Use In cr_tmp


Return nUpdateno


Endfunc


*---------------
*¦Û°Ê«Ø¥ß·s¯¸ÂI
Function create_new_station

Lparameters cName,cKey

If Vartype(cName)#"C"

	cName=getcomputername()

Endif

If Vartype(cKey)#"C"


	cKey =""


Endif


Local nID


If SQLExec(nhand,"alter table station add mainserver bit null")>0			&& 13/6/2008
	=SQLExec(nhand,"update station  set mainserver=0")

Endif

If SQLExec(nhand,"alter table station add clear_item_db bit null")>0			&& station add-->>clear_item_db

	=SQLExec(nhand,"UPDATE station SET clear_item_db=0")

Endif

If SQLExec(nhand,"alter table station add update_item_db bit")>0			&& station add-->>update_item_db

	=SQLExec(nhand,"update station set update_item_db =0")

Endif

If SQLExec(nhand,"alter table station add clear_cache bit null")>0

	=SQLExec(nhand,"update station set clear_cache =0 ")

Endif


If SQLExec(nhand,"alter table  station add android_key varchar(100) null")>0		&& 2013.03.18  ¥[¤Jandroid_key

	=SQLExec(nhand,"update station set android_key  = '' ")


Endif

=SQLExec(nhand,"alter table sys_log add station_time datetime null")


If SQLExec(nhand,"select  id from station where computer=?cName","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif



Local ll_new

ll_new =Eof("cun_tmp")




If SQLExec(nhand,"select MAX(id) as max_id from station","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

nID=Nvl(cun_tmp.max_id,0)+1

TEXT TO ssql noshow

IF NOT exists (select  id from station where computer=?cName)

INSERT INTO [dbo].[station]
           ([active]
           ,[id]
           ,[desccn]
           ,[descen]
           ,[computer]
           ,[table_page]
           ,[autobackup]
           ,[attendance]
           ,[language]
           ,[cashier]
           ,[drawer]
           ,[comdrawer]
           ,[comdrawerport]
           ,[poledisplay]
           ,[poleport]
           ,[polemessage]
           ,[linkserver]
           ,[pserver_active]
           ,[mainserver]
           ,[clear_item_db]
           ,[clear_cache]
           ,[android_key])

     VALUES
           (1
           ,?nID
           ,?cName
           ,?cName
           ,?cName
           ,1
           ,0
           ,0
           ,'CN'
           ,1
           ,0
           ,0
           ,1
           ,0
           ,1
           ,''
           ,0
           ,'2000-01-01 00:00'
           ,0
           ,0
           ,1
           ,?cKey)


ENDTEXT


If SQLExec(nhand,ssql)<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1


Endif


If !Empty(cKey)

	=SQLExec(nhand,"update station set clear_item_db = 0, update_item_db = 0, clear_cache = 0 ,android_key =?cKey,active=1 where computer = ?cName")


Endif


If  ll_new =.F.


	Return 1

Endif



If SQLExec(nhand,"select id,active_station from cate ","cun_tmp")<0

	Return -1

Endif




cid=Alltrim(Str(nID))

Select cun_tmp
Scan

	If Empty(Nvl(cun_tmp.active_station,""))

		_updateno=getupdateno("cate")

		If _updateno<0

			Return -1
		Endif



		If _updateno>0

			_active_station=cid+","

			If SQLExec(nhand,"update cate set active_station=?_active_station where id=?cun_tmp.id")<0

				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				Return -1


			Endif
			=SQLExec(nhand,"update cate set updateno=?_updateno ")


		Endif




	Else


		If Alines(cs,cun_tmp.active_station,4,",")>0

			If Ascan(cs,cid)=0


				_active_station=Trim(Trim(cun_tmp.active_station),",")+","+cid+","


				_updateno=getupdateno("cate")

				If _updateno>0

					If SQLExec(nhand,"update cate set active_station=?_active_station where id=?cun_tmp.id")<0

						Aerror(err)
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
						Return -1
					Endif

					=SQLExec(nhand,"update cate set updateno=?_updateno ")

				Endif



			Endif



		Endif



	Endif




Endscan


Return 1



Endfunc



*---- update android_page for tables  2011.08.29

Function set_tables_page_for_android


If SQLExec(nhand,"select id,tableno,row from tables","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

Select Id,Padl(Alltrim(cun_tmp.tableno),8,"0") As tableno From cun_tmp Where Row>0 Into Cursor cun_tmp1

Select * From cun_tmp1 Order By tableno Into Cursor cun_tmp Readwrite

Local p,i
p=1
i=0




=SQLSetprop(nhand,"Transactions",2)

				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					frm_wait.Hide
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
						

Select cun_tmp
Scan
	If 	i< 12

		If SQLExec(nhand,"update tables set android_page=?p where id=?cun_tmp.id")<0

			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif


	Endif

	i=i+1

	If i>=12

		p=p+1
		i=0

	Endif




Endscan

If SQLExec(nhand,"Update tables set android_page=999 where row=0")<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1



Endif

If Sqlcommit(nhand)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1



Endif

SQLSetprop(nhand,"Transactions",1)



Return 1

Endfunc




*---------------------

Function load_setting_express

Lparameters cStation


ssql="select * from system_setting with(nolock)  where active=1 and station_id in (select id from station with(nolock) where computer=?cStation) or (station_id=0 and applyall=1)"	&&«ö¹q¸£¦WºÙ¸ü¤J¨t²Î³]©w



If SQLExec(nhand,ssql,"cun_tmp")<0

	Return -1
Endif
Private _pcode
Select cun_tmp
If Eof()



	Return -1	&&¹q¸£¦WºÙ¨S¦³°O¿ý


Endif



Select cun_tmp
Scan

	_pcode=Trim(cun_tmp.pcode)


	If !Empty(_pcode)
		Public &_pcode
		Do Case

			Case cun_tmp.Type=1	&& Y/N
				&_pcode=Iif( Trim(cun_tmp.cvalue)="1",.T.,.F.)

			Case cun_tmp.Type=2	&&	¼Æ­È
				&_pcode=Iif(cun_tmp.intvalue,Int(Val(cun_tmp.cvalue)),Val(cun_tmp.cvalue))

			Case cun_tmp.Type=6	&&	color
				&_pcode=Val(cun_tmp.cvalue)

			Case cun_tmp.Type=7	&&	date
				&_pcode=Ctod(cun_tmp.cvalue)

			Otherwise
				&_pcode=Trim(cun_tmp.cvalue)



		Endcase

	Endif

Endscan

Public __local_printer		&&¥»¦a¥´¦L¾÷

__local_printer=""

TEXT TO ssql noshow

	if  exists (select printer from printerset with(nolock) where id=?__inv_printer and station_id=(select id from station with(nolock) where computer=?cStation))
		select printer from printerset with(nolock) where id=?__inv_printer and station_id=(select id from station with(nolock) where computer=?cStation)
			ELSE select printer from printerset  where  station_id=(select id from station with(nolock) where computer=?cStation)

ENDTEXT

If SQLExec(nhand,ssql,"cun_tmp")<0
	Return -1
Endif

__local_printer=Trim(cun_tmp.Printer)


Return 1


Endfunc


*---------------------------------------------------

Function getaddress

Lparameters cTel

If Empty(cTel)

	Return ""

Endif


If Vartype(_clangue)="U"

	_clangue=_system_langue

Endif


Local lcAddr



TEXT TO ssql noshow

	select a.*,b.desccn,b.descen,c.desccn as area_cn,c.descen as area_en,
	d.desccn as subarea_cn,d.descen as subarea_en,a.linkman
	from tel_order a left join address b  on a.address_id=b.id
	left join area c on b.area_id =c.id
	left join subarea d on b.subarea_id =d.id
	where a.tel=?cTel

ENDTEXT


If SQLExec(nhand,ssql,"address_tmp")<0
	Aerror(err)

	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return ""

Endif


If Isnull(address_tmp.address2) Or Empty(address_tmp.address2)

	Local _address,_tower,_floor,_room,_phase,_remark

	If  Nvl(address_tmp.address_id,0)=0


		_address=Trim(address_tmp.address)
	Else

		If  Empty(Nvl(address_tmp.subarea_cn,""))

			_address=Iif(_clangue="CN",Trim(address_tmp.area_cn)+" "+Trim(address_tmp.desccn),Trim(address_tmp.area_en)+" "+Trim(address_tmp.Descen))

		Else


			_address=Iif(_clangue="CN",Trim(address_tmp.area_cn)+" "+Trim(address_tmp.subarea_cn)+ " " + Trim(address_tmp.desccn),;
				TRIM(address_tmp.area_en)+" "+Trim(address_tmp.subarea_en)+" "+Trim(address_tmp.Descen))

		Endif





	Endif


	_tower=Trim(address_tmp.tower)
	_floor=Trim(address_tmp.Floor)
	_room=Trim(address_tmp.room)
	_phase=Trim(address_tmp.phase)
	_remark=Trim(address_tmp.remark)

	If _clangue="EN"
		_phase=Iif(Empty(_phase),"",getmessage("_phase","EN")+" "+_phase)
		_tower=Iif(Empty(_tower),"",getmessage("_tower","EN")+" "+_tower)
		_floor=Iif(Empty(_floor),"",getmessage("_floor","EN")+" "+_floor)
		_room=Iif(Empty(_room),"",getmessage("_room_no","EN")+" "+_room)
	Else
		_phase=Iif(Empty(_phase),"",_phase+getmessage("_phase","CN"))
		_tower=Iif(Empty(_tower),"",_tower+getmessage("_tower","CN"))
		_floor=Iif(Empty(_floor) ,"" ,_floor+ getmessage("_floor","CN"))
		_room=Iif(Empty(_room),"",_room+ getmessage("_room_no","CN"))
	Endif


	lcAddr=_address+" "+_phase+_tower+_floor+" "+_room+ " "+Iif(Isnull(_remark),"",Trim(_remark))	&&+IIF(EMPTY(_room),"",getmessage("_room_no"))		&&¦a§}



	If !Empty(Nvl(address_tmp.linkman,""))
		lcAddr =lcAddr + Chr(13) + Trim(address_tmp.linkman)

	Endif



Else

	lcAddr=Trim(address_tmp.address)+Iif(Empty(Nvl(address_tmp.address2,"")),"",Chr(13)+Trim(address_tmp.address2))+;
		IIF(Empty( Nvl(address_tmp.address3,"")),"",Chr(13)+Trim(address_tmp.address3))+;
		IIF(Empty( Nvl(address_tmp.address4,"")),"",Chr(13)+Trim(address_tmp.address4))+;
		IIF(Empty( Nvl(address_tmp.address5,"")),"",Chr(13)+Trim(address_tmp.address5))+;
		IIF(Empty( Nvl(address_tmp.address6,"")),"",Chr(13)+Trim(address_tmp.address6))+;
		IIF(Empty( Nvl(address_tmp.remark,"")),"",Chr(13)+Trim(address_tmp.remark))



Endif


Use In address_tmp


Return lcAddr

Endfunc


*----------------------------------
********************************
Function kill_process (tcName)

*!*	LOCAL cmd

*!*	cmd ="run /N0 Taskkill /f /im "+tcName

*!*	TRY
*!*		&CMD
*!*	CATCH TO oErr
*!*	ENDTRY

Try

	oWMI = Getobject('winmgmts://')
	cQuery = "select * from win32_process where name='" + tcName +"'"
	oResult = oWMI.ExecQuery(cQuery)
	For Each oProcess In oResult
		oProcess.Terminate(0)
	Next
Catch To oError


Endtry



*!*	LOCAL loLocator, loWMI, loProcesses, loProcess, llIsRunning

*!*	TRY


*!*		loLocator 	= CREATEOBJECT('WBEMScripting.SWBEMLocator')
*!*		loWMI		= loLocator.ConnectServer()
*!*		loWMI.Security_.ImpersonationLevel = 3  		&& Impersonate
*!*
*!*		loProcesses	= loWMI.ExecQuery([SELECT * FROM Win32_Process WHERE Name = '] + tcName + ['])
*!*		llIsRunning = .F.
*!*		IF loProcesses.Count > 0
*!*			FOR EACH loProcess in loProcesses
*!*				llIsRunning = .T.
*!*					loProcess.Terminate(0)
*!*			ENDFOR
*!*
*!*		ENDIF

*!*	CATCH TO oError


*!*	ENDTRY



*!*	RETURN llIsRunning



*!*	ENDTRY


Endfunc

*----------------
*ÀË´ú¬O§_¦³¨ä¥L¥Î¤á¨Ï¥Î(«D¥¿±`°h¥Xªº,«h±j¨î¶i¤J)
*
Function Table_used_check
Lparameters _tableno,ll_lock

Local _computer,_used_station
_computer=getcomputername()&&¨ú¥»¾÷¹q¸£¦WºÙ(¦pªG¦s¦b¥»¾÷ªº¦WºÙ,¥i¥H±j¨î¶i¤J) ±Æ°£print_serverªº¥e¥Î¦W

If ll_lock

	ssql="select used_station from tables where used_station<>?_computer and tableno=?_tableno and nsubtable=0 "

Else
	ssql="select used_station from tables with (nolock) where used_station<>?_computer and tableno=?_tableno and nsubtable=0 "
Endif

If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return 	-1


Endif

If !Eof("cun_tmp")
	_used_station=Upper(Alltrim(cun_tmp.used_station))


	Cmsg=getmessage("_table_inuse_by_others")+Chr(13)+Chr(13)+Space(2)+getmessage("_station")+":"+_used_station

	If "ANDROID"$Upper(_used_station)

		If Vartype(_android_station)="U"

			fmessagebox(Cmsg)	&&´£¥Ü

		Endif

		Return -1

	Endif


	ssql="Select hostname  From Master.dbo.sysprocesses  where hostname<>?_computer and hostprocess>0 and LOWER(program_name)<>'print_server' "
*		ssql="Select hostname  From Master.dbo.sysprocesses  where hostname<>?_computer and hostprocess>0 and LOWER(program_name)<>'print_server' and hostname in(select used_station from tables where tableno=?_tableno)"

	If SQLExec(nhand,ssql,"cun_tmp1")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))


		Return -1

	Endif

	Select * From cun_tmp1 Where Upper(Trim(HostName))==_used_station Into Cursor cun_tmp

*		SELECT * FROM cun_tmp1 WHERE  hostname  in (SELECT  used_station from cun_tmp ) INTO ARRAY tmp_s
	If _Tally>0
		write_log(40)		&&¾Þ§@°O¿ý
		fmessagebox(Cmsg)	&&´£¥Ü
		Return -1


	Endif



Endif


Return 1


Endfunc


*-----------------------------------

Function table_used_check_same_table
LPARAMETERS lcsame_table_id, ll_lock, llcopy

Local _computer,_used_station, Cmsg, llANDROID 
_computer=getcomputername()&&¨ú¥»¾÷¹q¸£¦WºÙ(¦pªG¦s¦b¥»¾÷ªº¦WºÙ,¥i¥H±j¨î¶i¤J) ±Æ°£print_serverªº¥e¥Î¦W

If ll_lock
	IF llcopy=.F.
		ssql="select tableno, used_station from tables where used_station<>?_computer and tableno in (select tableno from same_table_detail where same_table_id=?lcsame_table_id) and nsubtable=0 "
	ELSE
		ssql="select tableno, used_station from tables where used_station<>?_computer and id  in ("+lcsame_table_id+") and nsubtable=0 "
	ENDIF 
ELSE
	IF llcopy=.F.
		ssql="select tableno, used_station from tables with (nolock) where used_station<>?_computer and tableno in (select tableno from same_table_detail where same_table_id=?lcsame_table_id) and nsubtable=0 "
	ELSE 
		ssql="select tableno, used_station from tables with (nolock) where used_station<>?_computer and id in ("+lcsame_table_id+") and nsubtable=0 "
	ENDIF 
Endif

If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return 	-1


Endif

IF Eof("cun_tmp")
	RETURN 1
ENDIF 
	
Cmsg=getmessage("_table_inuse_by_others")
SCAN 
	Cmsg=Cmsg+Chr(13)+Chr(13)+Space(2)+Upper(Alltrim(cun_tmp.tableno))+" -> "+getmessage("_station")+":"+Upper(Alltrim(cun_tmp.used_station))
	If "ANDROID"$Upper(Alltrim(cun_tmp.used_station))
		If Vartype(_android_station)="U"
			llANDROID = .T.
		Endif
	ENDIF 
ENDSCAN 

IF llANDROID = .T.
	
	fmessagebox(Cmsg)	&&´£¥Ü
	Return -1
Endif


ssql="Select hostname  From Master.dbo.sysprocesses  where hostname<>?_computer and hostprocess>0 and LOWER(program_name)<>'print_server' "
*		ssql="Select hostname  From Master.dbo.sysprocesses  where hostname<>?_computer and hostprocess>0 and LOWER(program_name)<>'print_server' and hostname in(select used_station from tables where tableno=?_tableno)"

If SQLExec(nhand,ssql,"cun_tmp1")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
Endif

Select cun_tmp1.HostName From cun_tmp1 LEFT JOIN cun_tmp ON Upper(Trim(cun_tmp1.HostName)) == Upper(Alltrim(cun_tmp.used_station)) Where !ISNULL(cun_tmp.used_station) Into Cursor cun_tmp

*		SELECT * FROM cun_tmp1 WHERE  hostname  in (SELECT  used_station from cun_tmp ) INTO ARRAY tmp_s
If _Tally>0
	write_log(40)		&&¾Þ§@°O¿ý
	fmessagebox(Cmsg)	&&´£¥Ü
	Return -1
Endif

Return 1

ENDFUNC 


Function vtop_poledisp
Lparameters nAmount

Declare VFD8C_LED8C_OpenCom In VFD8C_LED8C.Dll Integer intPort
Declare VFD8C_LED8C_CloseCom In VFD8C_LED8C.Dll
Declare VFD8C_LED8C_DisplayNumChar In VFD8C_LED8C.Dll String tbuf, Integer iTransType
Declare VFD8C_LED8C_DisplayPOS In VFD8C_LED8C.Dll Integer iPOS
Declare VFD8C_LED8C_DisplayThanksLine In VFD8C_LED8C.Dll Integer iThanksType, Integer iLine
Declare VFD8C_LED8C_DisplayCurrency In VFD8C_LED8C.Dll Integer iCurrency

VFD8C_LED8C_OpenCom(__pole_port)

VFD8C_LED8C_DisplayNumChar(Alltrim(Transform(nAmount, "999999999.99")), 2)

VFD8C_LED8C_DisplayPOS(1)
VFD8C_LED8C_DisplayThanksLine(1, 1)
VFD8C_LED8C_DisplayCurrency(2)
VFD8C_LED8C_CloseCom()

Return


Endfunc



*------------------------------------------------

Function hp_poledisp
Lparameter oComm,lcCmd,lcDisp



lcCmd=Upper(lcCmd)

Local lClear,lcInit

lClear		= Chr(0x0C) 						&& Clear Display
lcInit		= Chr(0x1B)+Chr(0x40)				&& Init Display
lcSetCnBig5	=Chr(0x1F)+Chr(0x28)+Chr(0x67)+Chr(0x02)+Chr(0x01)+Chr(0x1F)+Chr(0x28)+Chr(0x67)+Chr(0x03)+Chr(0x03)		&& BIG5
lcSetCnGB   =Chr(0x1F)+Chr(0x28)+Chr(0x67)+Chr(0x02)+Chr(0x01)+Chr(0x1F)+Chr(0x28)+Chr(0x67)+Chr(0x03)+Chr(0x02)		&& GB2312
lcStart     =Chr(0x1F)+Chr(0x28)+Chr(0x65)+Chr(0x01)+Chr(0x49)+Chr(0x4E)+Chr(0x1F)+Chr(0x28)+Chr(0x65)+Chr(0x02)+Chr(0x4F)+Chr(0x55)+Chr(0x54)

If Vartype(lcDisp)#"C"
	lcDisp=""

Endif


lcDispCn=Chr(0xA1)+Chr(0x40)+lcDisp

Do Case

	Case lcCmd="START"

		pole_output(oComm,lcInit)

		pole_output(oComm,lClear)

		pole_output(oComm,lcSetCnBig5)

		pole_output(oComm,lcStart)



	Case lcCmd="DISP"

		pole_output(oComm,lClear)

		pole_output(oComm,lcSetCnBig5)

		pole_output(oComm,Chr(0xA1)+Chr(0x40)+lcDisp)



	Otherwise



Endcase




Endfunc


Function pole_output

Lparameters oComm,lcCommand


*TRY

With oComm.Object

	.CommPort	=__pole_port   		&&ºÝ¤f

	f0Sleep(10)


	.settings	="38400,N,8,1"



*-- Clear Input buffer string
	.inputLen	= 0



*-- Open com Port
	.portOpen	= .T.


	.Output		= lcCommand

	f0Sleep(10)

	.portOpen	= .F.





Endwith



*CATCH TO Oerror

*ENDTRY

Endfunc


*----------------
Function poledisplay

Lparameter oComm,lAllThings

Local lODisplay, lInit, lSDisplay, lOffCursor, lClear, lScrollMode, lOffBlink
Store "" To lODisplay, lInit, lSDisplay, lOffCursor, lScrollMode, lOffBlink
lClear		= Chr(12)							&& Clear Display
lInit		= Chr(27) + "@"						&& Init Display

Local lnDelay

If Vartype(__poledisplay_delaytime)="U"
	lnDelay=10
Else

	lnDelay=__poledisplay_delaytime

Endif




Try


	With  oComm.Object

		.CommPort	=__pole_port   		&&ºÝ¤f

		f0Sleep(lnDelay)


		.settings	="9600,N,8,1"

		f0Sleep(lnDelay)




*-- Clear Input buffer string
		.inputLen	= 0

		f0Sleep(lnDelay)


*-- Open com Port

		.portOpen	= .T.

		f0Sleep(lnDelay)


		.Output		= lInit + lODisplay + lClear + lOffBlink + lOffCursor + lScrollMode + lAllThings + lSDisplay

		f0Sleep(lnDelay)

		.portOpen	= .F.

		f0Sleep(lnDelay)






	Endwith


Catch To oError

*	fmessagebox(oError.message)


Endtry



*-------------------------------------------------------  ²Ä¤G­Ó»È½XÅã¥Ü¾¹

If Vartype(__pole_port2)#"U" And    __pole_port2>0

*	f0sleep(lnDelay)


	Try


		With  oComm.Object

			.CommPort	=__pole_port2   		&&ºÝ¤f

			f0Sleep(lnDelay)


			.settings	="9600,N,8,1"

			f0Sleep(lnDelay)




*-- Clear Input buffer string
			.inputLen	= 0

			f0Sleep(lnDelay)


*-- Open com Port

			.portOpen	= .T.

			f0Sleep(lnDelay)


			.Output		= lInit + lODisplay + lClear + lOffBlink + lOffCursor + lScrollMode + lAllThings + lSDisplay

			f0Sleep(lnDelay)

			.portOpen	= .F.

			f0Sleep(lnDelay)




		Endwith


	Catch To oError


	Endtry






Endif







Endfunc

*--------------------------

Function fix_xml

Lparameters cstr


Return Strtran(Strtran(cstr,Chr(2),""),Chr(10),"")


Endfunc


*----------------------------------

Function check_sys_printer

Public __inv_print_to_local ,__pay_print_to_local ,__sys_inv_printer,__sys_pay_printer, __seat_print_to_local, __sys_seat_printer

*!*	__local_inv_printer=""
*!*	__local_pay_printer=""

__sys_pay_printer=""
__sys_inv_printer=""
__sys_seat_printer = ""

csql="select * from printerset "		&&¥´¦L¾÷
If SQLExec(nhand,csql,"cun_tmp1")<0
	Aerror(err)

	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return  .F.

Endif

IF VARTYPE(__inv_printer)="C"

	Select Printer,station_id From cun_tmp1 Where Id=Val(__inv_printer)  Into Cursor cun_tmp		&&  ÀË¬d¬O§_¦³¥»¦aµo²¼¥´¦L¾÷

ELSE

	Select Printer,station_id From cun_tmp1 Where Id=__inv_printer  Into Cursor cun_tmp		&&  ÀË¬d¬O§_¦³¥»¦aµo²¼¥´¦L¾÷
	
ENDIF


If _Tally>0

	__sys_inv_printer=Alltrim(cun_tmp.Printer)

	If cun_tmp.station_id = __station_id

		__inv_print_to_local =check_local_printer(__sys_inv_printer)

	Endif


Endif

&&¤J®y¯È¥´¦L¾÷ By Waston 14/04/2023
IF VARTYPE(__seat_printer) # "U" 
	IF  VARTYPE(__seat_printer) = "C"
		Select Printer,station_id From cun_tmp1 Where Id = Val(__seat_printer)  Into Cursor cun_tmp		&&  ÀË¬d¬O§_¦³¥»¦a¤J®y¯È¥´¦L¾÷
	ELSE
		Select Printer,station_id From cun_tmp1 Where Id = __seat_printer  Into Cursor cun_tmp		&&  ÀË¬d¬O§_¦³¥»¦a¤J®y¯È¥´¦L¾÷
	ENDIF
	

	If _Tally > 0
		__sys_seat_printer = Alltrim(cun_tmp.Printer)
		If cun_tmp.station_id = __station_id
			__seat_print_to_local = check_local_printer(__sys_seat_printer)
		ENDIF
	ENDIF
ENDIF 
***************************************



IF rms_report OR rms_atte 

	RETURN 
	
ENDIF


Select Printer,station_id From cun_tmp1 Where Id=Val(__payslip_printer )  Into Cursor cun_tmp		&&  ÀË¬d¬O§_¦³¥»¦a®I¸}¯È¥´¦L¾÷

If _Tally>0

	__sys_pay_printer=Alltrim(cun_tmp.Printer)

	If cun_tmp.station_id = __station_id

		__pay_print_to_local =check_local_printer(__sys_pay_printer)

	Endif


Endif

Return

Endfunc

*---------------------------
Function CHECK_PAY_DETAIL

Lparameters nInv_ID,lonlyCheck


If SQLExec(nhand,"select id from payway   where lock=1 and id>0","cun_tmp")<0		&&¨ú²Ä¤@­Ó¥I´Ú¤è¦¡¬°¹w³]ªº¥I´Ú¤è¦¡

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif


Local lnPay_id,lnCount

lnCount=0


lnPay_id=cun_tmp.Id
lcPayway="Cash"


If Vartype(nInv_ID)="N"  And nInv_ID>0

	If SQLExec(nhand,"select id,invamt from inv where id=?nInv_ID AND paidtime>'2000-01-01' and  id not in (select id from pay_detail )","cun_tmp")<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1


	Endif

	If !Eof("cun_tmp")


		ssql="insert into pay_detail (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others) "+;
			"values (?cun_tmp.id,?lnPay_id,?lcPayway,1,?cun_tmp.invamt,'',?cun_tmp.invamt,0,0,1,1,?lnPay_id,0)"

		If SQLExec(nhand,ssql)<0

			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif


	Endif


	Return 1


Endif




If SQLExec(nhand,"select id,invamt from inv where  paidtime>'2000-01-01'  and id not in (select id from pay_detail)","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	Return -1

Endif

lnCount=Reccount("cun_tmp")

If lonlyCheck=.F.

	Select cun_tmp
	Scan

		ssql="insert into pay_detail (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others) "+;
			"values (?cun_tmp.id,?lnPay_id,?lcPayway,1,?cun_tmp.invamt,'',?cun_tmp.invamt,0,0,1,1,?lnPay_id,0)"

		If SQLExec(nhand,ssql)<0

			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif


	Endscan

Endif


If SQLExec(nhand,"select name from inv_divide","cun_tmp1")>0


	Local cName,cName2


	Select cun_tmp1
	Scan


		cName="hinv_"+Alltrim(cun_tmp1.Name)
		cName2="hinv_pay_"+Alltrim(cun_tmp1.Name)


		ssql="select id,invamt from "+cName+"  where id not in (select id from " +cName2  + ")"


		If SQLExec(nhand,ssql,"cun_tmp")<0

			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return -1

		Endif

		lnCount=lnCount + Reccount("cun_tmp")

		If lonlyCheck=.F.


			Select cun_tmp
			Scan

				ssql="insert into "+ cName2 +" (Id,pay_id,payway,qty,netamt,cardno,payamt,changes,tips,dispord,rate,changes_id,pay_others) "+;
					"values (?cun_tmp.id,?lnPay_id,?lcPayway,1,?cun_tmp.invamt,'',?cun_tmp.invamt,0,0,1,1,?lnPay_id,0)"

				If SQLExec(nhand,ssql)<0

					Aerror(err)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

				Endif


			Endscan

		Endif


	Endscan


Endif


Return lnCount



Endfunc




* check for octopus xfile

Function check_octopus_xfile
Lparameters lUpdateNow, pds_octopus_now

* chris 2021-02-17
* ¦³®É²M¾÷ gen ­ø¨ì mps¡A­ø¦nÚ» __octopus_xfile¡AÁ`¤§´N¬O gen mps

* chris 2021-03-22 
* ­nÁÙ­ìÚ» __octopus_xfile¡A§_«h¨C¦¸³£µL gen xfile ¦nºC

* ¦pªG updateno = .f. ´NÚ» __octopus_installed = .F. Or __octopus_xfile =.F.
* ¦pªG updateno = .t. ´N¤@®a gen xfile


* ¥[ pds_octopus_now, ·í²M¾÷ & Â÷¶} rms6 ®É = .t.


IF lUpdateNow = .f.
	If __octopus_installed = .F. Or __octopus_xfile =.F.
		Return
	Endif
ENDIF 



Local lcStation

lcStation =getcomputername()


If lUpdateNow=.F.

	If SQLExec(nhand,"select update_date from sys_options where type='octopus' and defavalue_char=?lcStation ","cun_tmp")<0

		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return

	Endif

	If Datetime() - cun_tmp.update_date > 3600  && 1 hour

		lUpdateNow=.T.

	Endif

Endif


* chris 2021-02-17
* ­ø¦nÚ» lUpdateNow¡A¦]¬° sys_options.update_date ¦n¦ü­øÃÑ update¡A¥O¨ì¦³®É­ø gen xfile

* chris 2021-03-22 
* ­nÁÙ­ìÚ» __octopus_xfile¡A§_«h¨C¦¸³£µL gen xfile ¦nºC

If lUpdateNow

	IF vartype(__octopus_pos_mode) = "U" or !__octopus_pos_mode
		Set Classlib To Class\octopus.vcx Additive

		Local oOct_local, ll_error


		oOct_local = Createobject("octopus")

		Try

			With oOct_local
				.start_octopus
				If 	.oct_init()
					.oct_xfile()		&&¼g¤Jxfile

				Endif


			Endwith

		Catch To oErr


			ll_error=.T.
		Endtry


		If ll_error

			Return

		ENDIF
		
		__octopus_xfile = .F.
	ELSE 	
		IF _octopus_active AND oOct_pos.connecting
			oOct_pos.no_service()		&& No Service
			= oOct_pos.oct_xfile()			
			
			__octopus_xfile = .F.
		ENDIF 
	ENDIF 	

	=SQLExec(nhand,"update sys_options  set update_date=getdate() where type='octopus' and defavalue_char=?lcStation ")



	Release oOct_local


	If File("ots.exe")
		Run /N0 ots.Exe
	Endif


	If File("pds_octopus.exe")
		Run /N pds_octopus.Exe
	Endif


* chris 2021-02-17
* ²M¾÷ gen octopus file ¤§«á¡A²£¥Í¤@­Ó pds_octopus.now ÀÉ®×
* ·í·sª© pds_octopus.exe ¨£¨ì¦³ pds_octopus.now ´N§Y¬O osdx

	IF pds_octopus_now
	
		TRY 
			ERASE ("pds_octopus.now")
		CATCH
		FINALLY
		ENDTRY 
			
		fn=Fcreate("pds_octopus.now")
		IF fn > 0
			Fputs(fn, "now")
			Fclose(fn)
		ENDIF 
	
	ENDIF 
	
		
	*************************************


Endif

Return

Endfunc


*----------------------
Function check_same
Lparameters cTableName,cDescCN,cDescEn,nID

*ÀË¬d¦WºÙ¬O§_­«½Æ

Local ssql,cond

cond=""
If nID>0

	cond=" and id<>?nID"

Endif

If Upper(cTableName)="MODIFIER"


	cond = cond + " and parent_id=0 "

Endif


TEXT TO ssql NOSHOW TEXTMERGE

	SELECT id FROM <<cTableName>> where (UPPER(desccn) = UPPER('<<cDescCn>>') or UPPER(descen) = UPPER('<<cDescEn>>')
	or UPPER(descen) = UPPER('<<cDescCn>>') or UPPER(descen) = UPPER('<<cDescEn>>') ) <<cond>>


ENDTEXT



If SQLExec(nhand,ssql,"cr_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return .F.


Endif

If !Eof("cr_tmp")

	fmessagebox("_name_already_exist")

	Return .F.
Endif

Return .T.

***********************************************

Function add_updateno

Lparameters _tblname

Wait Window "convert table " + _tblname + "...." Nowait
c=SQLExec(nhand, "select * from " + _tblname, "cr_nouse")

a=1
Select cr_nouse
Scan
	Replace updateno With a
	a=a+1
Endscan

&&Lihong 2021.10.22 nvarchar>254»Ý­nÂà½X §ï¬°³q¥Î¤èªk
*!*	&&Lihong 2020.12.28
*!*	IF INLIST(ALLTRIM(LOWER(_tblname)), "item", "item_backup", "chris_item")
*!*		IF !EMPTY(FIELD("small_info", "cr_nouse"))
*!*			REPLACE ALL small_info WITH STRCONV(NVL(cr_nouse.small_info, ""), 6) ;
*!*			, info WITH STRCONV(NVL(cr_nouse.info, ""), 6) ;
*!*			, small_info_en WITH STRCONV(NVL(cr_nouse.small_info_en, ""), 6) ;
*!*			, info_en WITH STRCONV(NVL(cr_nouse.info_en, ""), 6) IN cr_nouse
*!*		ENDIF 
*!*	ENDIF 
&&Lihong 2021.10.22 nvarchar>254»Ý­nÂà½X §ï¬°³q¥Î¤èªk
LOCAL lcsql_cmd, lcSQL_table_name
*lcSQL_table_name = ALLTRIM(_tblname)
TEXT TO lcsql_cmd TEXTMERGE NOSHOW 
	SELECT syscolumns.name AS field_name  FROM syscolumns INNER JOIN systypes ON systypes.xtype=syscolumns.xtype left join sysobjects on syscolumns.id=sysobjects.id  
	WHERE syscolumns.prec>254 and systypes.name='nvarchar' and sysobjects.xtype='U' and sysobjects.name=?_tblname
ENDTEXT 
IF SQLEXEC(nhand, lcsql_cmd, "table_fields_len_over254")<0
	aerror(err)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	RETURN
ENDIF
SELECT table_fields_len_over254
SCAN 
	_field_name = alltrim(table_fields_len_over254.field_name)
	REPLACE ALL &_field_name WITH STRCONV(NVL(&_field_name, ""), 6) IN cr_nouse
ENDSCAN 
USE IN SELECT("table_fields_len_over254")


TEXT TO cmd NOSHOW TEXTMERGE
	if not exists (select * from updateno where table_name = ?_tblname)
		begin
			insert into updateno (table_name, max_updateno) values ( ?_tblname, 0)
		end

	update updateno set max_updateno = ?a-1 where table_name = ?_tblname
ENDTEXT
c=SQLExec(nhand, cmd)



c=SQLExec(nhand, "truncate table " + _tblname)

=Afields(chris, "cr_nouse")

Select cr_nouse
Scan
	Scatter Memvar Memo

	cmd = "insert into " + _tblname + " values ( "

	cmd1 = ""
	For a = 1 To Alen(chris,1)
		cmd1 = cmd1 + "?m." + chris(a,1) + ", "
	Endfor

	cmd = cmd + Substr(Alltrim(cmd1), 1, Len(Alltrim(cmd1))-1) + " )"
	If SQLExec(nhand, cmd) < 0
		Set Step On
	Endif

	Select cr_nouse
Endscan
Use In cr_nouse
Wait Clear

Endfunc

*--------------------

Function convert_android

add_updateno("message")
add_updateno("item")
add_updateno("system_setting")
add_updateno("cate")
add_updateno("item_mcate")
add_updateno("system_period")
add_updateno("holi")
add_updateno("itemprice")
add_updateno("outlet")
add_updateno("modifier")
add_updateno("modifier_def")
add_updateno("printerset")
add_updateno("srv")
add_updateno("tax")
add_updateno("setitem")
add_updateno("mitem")
add_updateno("void_reason")
add_updateno("disc")
add_updateno("disc_main")
add_updateno("disc_reason")
add_updateno("order_function")
add_updateno("role")
add_updateno("roleaccess")
add_updateno("item_cp")
add_updateno("cp")


=SQLExec(nhand, "update station set clear_item_db = 1")

Endfunc

Function getReportDay

Local nnfr_day,lcUserName

nfr_day=0


lcUserName =_login_user_name

If Vartype(__access_user_name)#"U" And  !Empty(__access_user_name)

	_login_user_name=__access_user_name

Endif



If user_access("fr_report_no_limit")
	nfr_day = 0
Else
	If user_access("fr_report_90_days")
		nfr_day = 90
	Else
		If user_access("fr_report_60_days")
			nfr_day = 60
		Else
			If user_access("fr_report_30_days")
				nfr_day = 30
			Else
				If user_access("fr_report_7_days")
					nfr_day = 7
				Else
					If user_access("fr_report_2_days")
						nfr_day = 2
					Else
						nfr_day = 1
					Endif
				Endif
			Endif
		Endif
	Endif
Endif

_login_user_name =lcUserName

Return nfr_day


Return


Endfunc

****** *****

Function modi_check
Lparameters _parentid,_modi_qty

Local _modi,_qty
_modi=_parentid		&&¯S§O³B²zID
_qty=_modi_qty		&&¯S§O³B²z¼Æ¶q



Select order_itemlist_tmp				&&¯S§O³B²zÀË¬d,¤w¿ï¾Üªº¯S§O³B²z,¤£¦A´£¥Ü¿é¤J
Scan For(!Empty(modi_list) Or  !Empty(modi_need)) And Selected=.T.
	_modi_need=Alltrim(order_itemlist_tmp.modi_need)
	_uid=order_itemlist_tmp.uid

	If !Empty(_modi_need)
		Dimension need(1)
		getmstring(_modi_need,@need)
		Acopy(need,temp)
		For i=1 To Alen(temp)
			temp(i)=Int(Val(temp(i)))
		Endfor
		For i=1 To _qty
			N=Ascan(temp,_modi)
			If N>0
				Adel(temp,N)
				Adel(need,N)
			Endif
		Endfor

		_modi_need=""
		For i=1 To Alen(need)
			If Vartype(need(i))<>"L"
				If Val(need(i))>=0				&&¤£¦Ò¼{¤À¹j½u
					_modi_need=_modi_need+Trim(need(i))+","
				Endif

			Endif
		Endfor
		Release temp,need
		If Substr(_modi_need,1,2)="0,"		&&¨¾¤î¶¡½u­«´_
			_modi_need="0,"+Ltrim(_modi_need,"0,")		&&¥u«O¯d¤@±ø¶¡½u
		Endif

		If Right(_modi_need,3)=",0,"			&&¥h±¼³Ì«áªº¹s
			_modi_need=Trim(_modi_need,"0,")
		Endif

		Select order_itemlist_tmp
		Replace modi_need With _modi_need For uid=_uid


	Endif

Endscan

Endfunc

*----------

Function create_xml_from_Inv
Lparameters nInvID


If SQLExec(nhand,"select * from inv with (nolock) where id=?nInvID","cun_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1

Endif

If Eof("cun_tmp")		&& inv not found

	Return -1

Endif


Local lcpplcnt ,lcInv ,lcCashier ,lcBeginTime ,lcPaidTime ,lcsubtotal


lcpplcnt = Alltrim(Str(cun_tmp.pplcnt))
lcInv =Padl(nInvID,10,"0")
lcCashier =Trim(cun_tmp.adduser)
lcBeginTime =Ttoc(cun_tmp.begintime)
lcPaidTime =Ttoc(cun_tmp.paidtime)
lcsubtotal = Alltrim(Str(cun_tmp.amount,12,2))
lcTotal =Alltrim(Str(cun_tmp.invamt,12,2))
lcAmount_per =Alltrim(Str(cun_tmp.invamt/cun_tmp.pplcnt,12,2))


If SQLExec(nhand,"select descdisp,qty,amount from inv_detail with (nolock) where id=?nInvID","cun_tmp1")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return  -1

Endif


Local lcItem,i, lcTab2,lcTab3

lcTab2 =Chr(9)+Chr(9)
lcTab3 =Chr(9)+Chr(9)+Chr(9)

lcItem =""

i=1
Select cun_tmp1
Scan

	lcItem = lcItem + lcTab2 + "<" + Alltrim(Str(i)) + ">" + Chr(13)+;
		lcTab3 + "<name>" + Trim(cun_tmp1.descdisp) + "</name>" + Chr(13) +;
		lcTab3 + "<qty>" + Alltrim(Str(qty)) + "</qty>" +Chr(13) +;
		lcTab3 + "<amount>" + Alltrim(Str(amount,12,2)) + "</amount>" + Chr(13) +;
		lcTab2+ "</"+Alltrim(Str(i)) + ">" +Chr(13)

	i =i +1

Endscan




TEXT TO cText TEXTMERGE noshow

<receipt>
	<call><<lcpplcnt>></call>
	<receipt_no><<lcInv>></receipt_no>
	<cashier><<lcCashier>></cashier>
	<arrival_time><<lcBeginTime>></arrival_time>
	<settle_time><<lcPaidTime>><settle_time>
	<items>
<<lcItem>>
	</items>
	<subtotal><<lcsubtotal>></subtotal>
	<total><<lcTotal>></total>
	<amount_per><<lcAmount_per>></amount_per>
</receipt>

ENDTEXT

*Strtofile(ctext,"d:\test.xml")

Return 1


Endfunc

**************************
Function modi_check2
Lparameters _modi_def,_item_Id,_dele_mod		&&¯S§O³B²zÀË´ú,¦]¼Æ¶qÅÜ¤Æ¤Þ°_ªº¯S§O³B²zÅÜ¤Æ

Dimension need(1)
getmstring(_modi_def,@need)
Local _uid,_def_idx_,_isneed

Select item_modi_tmp
Scan For item_id=_item_Id And !Empty(def_idx)
	_uid=uid
	_def_idx=Trim(def_idx)
	_isneed=modi_need					&&¬O§_»Ý­n¯S§O³B²z
	If !Empty(_def_idx)
		Dimension def(1)
		getmstring(_def_idx,@def)		&&¦Ò¼{¼Æ¶q¥i¯à¤j©ó1ªº±¡ªp
		Dimension del_def(Alen(def))

		For i=1 To Alen(def)
			N=Ascan(need,def(i))		&&§â§R°£ªº¦AÅý¥Î¤á¿ï¾Ü
			If N>0

				Adel(need,N)
			Endif

		Endfor
	Endif

Endscan


_del_need=""
For i=1 To Alen(need)
	If Vartype(need(i))<>"L"
		If Val(need(i))>0
			_del_need=_del_need+need(i)+","		&&»Ý­n¯S§O³B²z
		Endif

	Endif
	If _dele_mod
		_del_need=Ltrim(_del_need,"0,")					&&§R°£«e­±ªº¹s
	Endif


	If Right(_del_need,3)=",0,"
		_de_need=Trim(_del_need,"0,")				&&§R°£³Ì«áªº¹s
	Endif

Endfor


If Left(_del_need,2)="0,"
	_del_need="0,"+Ltrim(_del_need,"0,")		&&«e­±¥u«O¯d¤@­Ó0,

Endif


Update order_itemlist_tmp Set modi_must=_del_need,modi_need=_del_need Where uid=_item_Id	&&±N§R°£ªº¯S§O³B²z(¥²¶·ªº)Åý¥Î¤á¦A¦¸¿ï¾Ü


*!*	ELSE
*!*	*	Update order_itemlist_tmp Set modi_need=_del_need Where uid=_item_id	&&±N§R°£ªº¯S§O³B²z(»Ý­nªº)Åý¥Î¤á¦A¦¸¿ï¾Ü

*!*	ENDIF

Return

Endfunc


*******************
**
Function mix_android_data
Lparameters nOrderId


Local lcExp

lcExp =""

_file1 = "proantmp" + SYS(2015) 
TEXT TO dbsql NOSHOW TEXTMERGE 
	CREATE TABLE <<_file1>> (id varchar(100))
ENDTEXT 
If SQLExec(nhand, dbsql)<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return  -1
ENDIF

TEXT TO dbsql NOSHOW TEXTMERGE 
	insert into <<_file1>> values(?lcSave_type)
ENDTEXT 

Select order_itemlist_tmp
Scan For !Empty(save_type)

	&&lcExp = lcExp +"'"+ Trim(save_type)+"',"
	lcSave_type = Trim(save_type)
	If SQLExec(nhand, dbsql)<0
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return  -1
	ENDIF
Endscan

lcExp = Trim(lcExp,",")

If Empty(lcExp)

	lcExp ="''"

Endif



Local  cmark

cmark =Sys(2015)

*write_Log(0,  cMark  +"	"+ lcExp )



TEXT TO ssql  NOSHOW  TEXTMERGE

		INSERT INTO [android_order_detail]
		([mark_id]
		      ,[id]
		      ,[uid]
		      ,[parent_id]
		      ,[item_id]
		      ,[item_code]
		      ,[cate_id]
		      ,[descdisp]
		      ,[qty]
		      ,[price]
		      ,[orgamt]
		      ,[amount]
		      ,[real_amount]
		      ,[round_amount]
		      ,[modi_amount]
		      ,[disc_amount]
		      ,[srv_per]
		      ,[srv_amount]
		      ,[tax_per]
		      ,[tax_amount]
		      ,[xdisc]
		      ,[sitem]
		      ,[sitem_sub]
		      ,[mitem]
		      ,[mustmodi]
		      ,[hold]
		      ,[printed]
		      ,[printtime]
		      ,[adduser]
		      ,[modi_list]
		      ,[level_id]
		      ,[drink_qty]
		      ,[recused]
		      ,[xid]
		      ,[sprinter]
		      ,[remin_times]
		      ,[remintime]
		      ,[level_disc]
		      ,[onlysave]
		      ,[ordertime]
		      ,[handwriting]
		      ,[hhqty]
		      ,[hhprice]
		      ,[undefine]
		      ,[srv_free]
		      ,[tax_free]
		      ,[mitem_id]
		      ,[timer_active]
		      ,[timer_style]
		      ,[free_hours]
		      ,[free_style]
		      ,[timer_begtime]
		      ,[timer_endtime]
		      ,[timer_mincharge]
		      ,[timer_disc]
		      ,[printer]
		      ,[material]
		      ,[org_price]
		      ,[turnup]
		      ,[orgsrv]
		      ,[price0]
		      ,[tax2]
		      ,[pointed]
		      ,[points]
		      ,[askdept]
		      ,[item_warning]
		      ,[warning_begtime]
		      ,[warning_endtime]
		      ,[warning_inMinute]
		      ,[pre_price]
		      ,[sub_amt]
		      ,[gift]
		      ,[giftred]
		      ,[tel]
		      ,[transNumber]
		      ,[member_number]
		      ,[price_mc]
		      ,[modi_need]
		      ,[modi_must]
		      ,[modi_def]
		      ,[amtinv]
		      ,[save_type]
		      ,[delay_minute]
		      ,[srv_per_org]

		)
		SELECT '<<cMark>>'
		      ,[id]
		      ,[uid]
		      ,[parent_id]
		      ,[item_id]
		      ,[item_code]
		      ,[cate_id]
		      ,[descdisp]
		      ,[qty]
		      ,[price]
		      ,[orgamt]
		      ,[amount]
		      ,[real_amount]
		      ,[round_amount]
		      ,[modi_amount]
		      ,[disc_amount]
		      ,[srv_per]
		      ,[srv_amount]
		      ,[tax_per]
		      ,[tax_amount]
		      ,[xdisc]
		      ,[sitem]
		      ,[sitem_sub]
		      ,[mitem]
		      ,[mustmodi]
		      ,[hold]
		      ,[printed]
		      ,[printtime]
		      ,[adduser]
		      ,[modi_list]
		      ,[level_id]
		      ,[drink_qty]
		      ,[recused]
		      ,[xid]
		      ,[sprinter]
		      ,[remin_times]
		      ,[remintime]
		      ,[level_disc]
		      ,[onlysave]
		      ,[ordertime]
		      ,[handwriting]
		      ,[hhqty]
		      ,[hhprice]
		      ,[undefine]
		      ,[srv_free]
		      ,[tax_free]
		      ,[mitem_id]
		      ,[timer_active]
		      ,[timer_style]
		      ,[free_hours]
		      ,[free_style]
		      ,[timer_begtime]
		      ,[timer_endtime]
		      ,[timer_mincharge]
		      ,[timer_disc]
		      ,[printer]
		      ,[material]
		      ,[org_price]
		      ,[turnup]
		      ,[orgsrv]
		      ,[price0]
		      ,[tax2]
		      ,[pointed]
		      ,[points]
		      ,[askdept]
		      ,[item_warning]
		      ,[warning_begtime]
		      ,[warning_endtime]
		      ,[warning_inMinute]
		      ,[pre_price]
		      ,[sub_amt]
		      ,[gift]
		      ,[giftred]
		      ,[tel]
		      ,[transNumber]
		      ,[member_number]
		      ,[price_mc]
		      ,[modi_need]
		      ,[modi_must]
		      ,[modi_def]
		      ,[amtinv]
		      ,[save_type]
		      ,[delay_minute]
		      ,[srv_per_org]
		from order_detail where id =<<nOrderID>> and save_type<>''  and  save_type  not in (select id from <<_file1>>)


ENDTEXT

*	STRTOFILE(ssql,"d:\sql.txt")

ssql=ssql+Chr(10)+"insert into android_order_modi select ?cMark ,* from order_modi where   id =?nOrderID  and  item_id in (select uid from order_detail where id =?nOrderID and save_type<>''  and  save_type  not in (select id from " + _file1 + ") )"

If SQLExec(nhand,ssql)<0
	AERROR(err)
	
	TEXT TO dbsql NOSHOW TEXTMERGE 
		drop TABLE <<_file1>> 
	ENDTEXT 
	If SQLExec(nhand, dbsql)<0
		
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return  -1
	
	ENDIF
	
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return  -1	
	

Endif

TEXT TO dbsql NOSHOW TEXTMERGE 
	drop TABLE <<_file1>> 
ENDTEXT 
If SQLExec(nhand, dbsql)<0
ENDIF

If load_order(cmark , .F. , .T., .T.)<0		&&so_add_order

	Return -1

Endif

UPDATE order_itemlist_tmp SET save_type = ""


Return 1


Endfunc


***************

Function send_email

Lparameters xfile,ltxt

Local lcXfile
lcXfile=FULLPATH(xfile)



IF ltxt

	IF !FILE(lcXfile)

		RETURN 
		
	ENDIF
		

	_message =FILETOSTR(lcXfile)		&& 2015.12.03 
	
	lcXfile=""

ELSE


	IF AT(".pdf", LOWER(lcXfile )) > 0

* 2018-06-08 ·s version pdfcreator	
*		lcXfile = Trim(xfile,".pdf")+".pdf"

		lxXfile = JUSTPATH(xfile) + "\"+ JUSTSTEM(xfile) + "." + JUSTEXT(xfile)

	ENDIF 	

	
	IF !FILE(lcXfile)

		RETURN 
		
	ENDIF
		
	_message = gc_repoline1 + "   " + getmessage("_daterange") + " : " + Dtoc(sdate) + " - " + Dtoc(edate)
	
ENDIF



_caption 	= gc_repoline1 + "   " + getmessage("_daterange") + " : " + Dtoc(sdate) + " - " + Dtoc(edate)


frm_wait.showmessage("Sending Email....")

Declare Integer "mail_to" In send_email.Dll ;
	INTEGER AMail_mode,;
	STRING ASmpt_Host,;
	INTEGER APort,;
	STRING AUser_name,;
	STRING AUser_Password,;
	STRING AFromText,;
	STRING AMailToAddress,;
	STRING ASubject,;
	STRING ABody,;
	STRING AAttachFileName



*2020-06-03
*add _opt for on-net, wharftt ¦pªG©T©w 1 ¤£¯à send email
		
LOCAL _opt
_opt = 0
		
IF !EMPTY(ALLTRIM(__email_user_name)) AND !EMPTY(ALLTRIM(__email_user_password))
	_opt = 1
ENDIF 

If !Empty(__email1)
	If mail_to( _opt ,  __email_smtp, __email_port,  __email_user_name,  __email_user_password ,  __email_co, 	__email1,  _caption, _message, lcXfile ) <> 1
		fmessagebox("Send email failed !!" + Chr(13) + Chr(13) + Alltrim(__email1) )
	Endif
Endif

If !Empty(__email2)
	If mail_to( _opt ,  __email_smtp, __email_port,  __email_user_name,  __email_user_password ,  __email_co, 	__email2,  _caption, _message, lcXfile ) <> 1
		fmessagebox("Send email failed !!" + Chr(13) + Chr(13) + Alltrim(__email2) )
	Endif
Endif

If !Empty(__email3)
	If mail_to( _opt ,  __email_smtp, __email_port,  __email_user_name,  __email_user_password , 	__email_co, 	__email3,  _caption, _message, lcXfile ) <> 1
		fmessagebox("Send email failed !!" + Chr(13) + Chr(13) + Alltrim(__email3) )
	Endif
Endif

If !Empty(__email4)
	If mail_to( _opt ,  __email_smtp, __email_port,  __email_user_name,  __email_user_password , 	__email_co, 	__email4,  _caption, _message, lcXfile ) <> 1
		fmessagebox("Send email failed !!" + Chr(13) + Chr(13) + Alltrim(__email4) )
	Endif
Endif

If !Empty(__email5)
	If mail_to(_opt ,  __email_smtp, __email_port,  __email_user_name,  __email_user_password , 	__email_co, 	__email5,  _caption, _message, lcXfile ) <> 1
		fmessagebox("Send email failed !!" + Chr(13) + Chr(13) + Alltrim(__email5) )
	Endif
Endif


frm_wait.Hide


Clear Dlls send_email
*Erase (lcXfile )


Endfunc


FUNCTION report2doc
LPARAMETERS  lxfile

			Delete File __clean.*

			Set Library To xfrxlib.fll
			Local loxfrx
			loxfrx = XFRX("XFRX#LISTENER")
			loxfrx.DoNotOpenViewer=.T.  &&¤£Åã¥Ü¹wÄý
			loxfrx.targetType = "PLAIN"



			_error=.F.
			lcError=""

			loxfrx.targetFileName = (lxfile)
			lnRetval = loxfrx.setparams()
			If lnRetval = 0
				
			
				Try
					Report Form  (tmpfrx )   Object loxfrx Nodialog					&&¥Í¦¨ xff ¤å¥ó

				Catch To oError

					_error=.T.
					lcError=oError.message
					
				Endtry
				

				loxfrx=Null
				
			ELSE
			
				_error=.T.
			
			
			ENDIF
			
			
			RETURN _error
			


ENDFUNC



*************************

Function report2PDF
Lparameters cCursor,xfile

*!*	frm_wait.showmessage("Generating pdf....")
*!*	Wait "" To N Timeout 0.1

*!*	xtype = "PDF"
*!*	xfile = "R" + Sys(2015) + ".pdf"


xpath = Sys(5) + Sys(2003)

If SET_PDFCreator(xpath,xfile, .F. ) > 0

	If Aprinters(printer_list)=0

		fmessagebox("_no_printer_found")
		Return  -1

	Endif

	If Ascan(printer_list,"PDFCreator")=0

		_mess=getmessage("_no_printer_found")+Chr(13)+Chr(13)+"PDFCreator"
		fmessagebox(_mess)


		Return -1

	Endif

	Release printer_list

	Copy File  &tmpfrx..frx To tmpx.frx
	Copy File  &tmpfrx..frt To tmpx.frt

	Select 0
	Use tmpx.frx
	Locate For objtype = 1 And objcode = 53
	Replace Tag With "",tag2 With ""  &&	, Expr With "" 	&&²M°£³øªí¤¤ªº¥´¦L¾÷³]¸m

	For i=1 To 20							&&¥´¦L¾÷§ï§ó¬° PDFCreator
		If "DEVICE="$Mline(Expr,i)
			lcOld=Mline(Expr,i)
			lcNew="DEVICE=PDFCreator"
			Replace Expr With Strtran(Expr,lcOld,lcNew)
			Exit

		Endif

	Endfor

	Use


	Select (cCursor)

	Set Printer To Name PDFCreator
	Report Form tmpx To Printer Noconsole

	Delete File tmpx.*
	Public _run_PDFCreator


	Wait Window "" To a Timeout 0.5

	objWMIService = Getobject("winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2")
	Do While .T.
		colProcessList = objWMIService.ExecQuery ("Select * from Win32_Process Where Name = 'PDFCreator.exe'")

		If colProcessList.Count = 1        && µ¥¨ì pdfcreator ¥X²{
			Exit
		Endif
	Enddo

	Wait Window "" To a Timeout 0.5

	Do While .T.
		colProcessList = objWMIService.ExecQuery ("Select * from Win32_Process Where Name = 'PDFCreator.exe'")

		If colProcessList.Count = 0        &&¦pªG¤£¦A¦s¦b..
			Exit
		Endif
	Enddo
	Release objWMIService

	Wait Window "" To a Timeout 0.5



Else  		&& SET_PDFCreator failed

	fmessagebox("SET_PDFCreator failed")
	Return  -1

Endif


Endfunc

*----------------
* ¶i­Ü³æ ¦C¦L

Function item_in_print
Lparameters nID

If SQLExec(nhand,"select * from item_in_main where id=?nID","cun_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return  -1

Endif

_Datetime =cun_tmp.Date
_username =Trim(cun_tmp.adduser)

cCode =getmessage("_code")
cName=getmessage("_name")
cqty =getmessage("_qty")
camt=getmessage("_amount")
ctotal=getmessage("_total")


If _system_langue="CN"

	ssql="select b.code,b.desccn as descdisp,a.qty,a.price,a.amount from item_in_detail a left join item b on a.item_id=b.id where a.id=?nID"
Else

	ssql="select b.code,b.descen as descdisp,a.qty,a.price,a.amount from item_in_detail a left join item b on a.item_id=b.id  where a.id=?nID"

Endif

If SQLExec(nhand, ssql ,"print_tmp")<0

	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return  -1

Endif

Select print_tmp

Set Printer To NAME (__sys_inv_printer)

If __debug_mode &&OR  _vfp.StartMode=0

	Report Form Report\item_in.frx To Printer  Nodialog Noconsole  Preview

Else

	Report Form Report\item_in.frx To Printer  Nodialog Noconsole
Endif


Return 1


Endfunc

*--------------

FUNCTION resave_inv

LPARAMETERS nID


	
	IF SQLEXEC(nhand,"select * from inv where id=?nID","cr_inv")<0
	
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		Return -1	
	
	ENDIF
	
	
	IF EOF("cr_inv")
	
	
		IF move_inv_to_standard(inv_tmp.belongdate,nID)<0		&&move to inv
		
		
			RETURN  
		
		ENDIF
		

		IF SQLEXEC(nhand,"select * from inv where id=?nID","cr_inv")<0
		
			Aerror(err)
			frm_wait.Hide
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			Return -1	
		
		ENDIF

	
	
	ENDIF
	

	_run_mode="fastfood"		&&¼ÒÀÀ§ÖÀ\¤è¦¡
	_curorder=0
	_tableno=TRIM(cr_inv.tableno)
	Nvalue=cr_inv.pplcnt
	_outlet_id=cr_inv.outlet_id
	_order_change=.f.
	_inv_no=cr_inv.id
	_pplcnt =cr_inv.pplcnt
	
	&&Lihong 2020.01.17
	_cloud_check_valid = cr_inv.cloud_check_valid

	IF load_inv_to_order(nID)<0
	
	
		RETURN 
		
	
	ENDIF
	
	PUBLIC _inv_chnage_mode	 ,_inv_resave_mode	&&  change inv 

	
	_onlysave=.t.
	_inv_mode=.t.
	
	_isfastfood=cr_inv.fastfood
	_fastfood_info =IIF(_outlet_id=0,getmessage("_fastfood"),"")
	_member_no=NVL(cr_inv.memberno,0)
	_mincharge_mode=0
	
	_tel=cr_inv.tel
	_addr=""
	
	_end_time=cr_inv.endtime
	
	_sit_time=cr_inv.begintime
	
	
	_order_id=save_order(_tableno,_onlysave,_inv_mode,_curorder,_pplcnt,_run_mode,_isfastfood,_fastfood_info,_member_no,_mincharge_mode,_tel,_addr,_end_time,_sit_time)

	
	IF   _order_id<=0
			SQLROLLBACK(nhand)									&&«O¦s¤£¦¨¥\,¦^´_¼Æ¾Ú
			SQLSETPROP(nhand,"Transactions",1)							
			RELEASE _print_inv_within_order, _inv_chnage_mode ,_inv_resave_mode	
			RETURN -1
	ENDIF


	
	DIMENSION inv_langue(1)
	
	ll_noPrint_inv=.t.

	inv_langue(1)="CN"	
	
	_invID=save_to_inv(_order_id,@inv_langue,1,_tableno,ll_noPrint_inv,nID,.f. , IIF(ll_noPrint_inv,"fastfood","DINE"))			&&«O¦sµo²¼-->¿é¥X¥´¦L

	_GBK_LANGUE=.F.

	RELEASE _order_change_and_resave_inv,_inv_chnage_mode,pb_print_other_Inv,_inv_resave_mode


	IF _invID<=0
		SQLROLLBACK(nhand)									&&¦^´_¼Æ¾Ú
		SQLSETPROP(nhand,"Transactions",1)		
		RELEASE _print_inv_within_order
		RETURN  -1
	ENDIF
		
	TEXT TO ssql NOSHOW &&Lihong 2022.11.04 ¼W¥[order_itemdept order_modi 
	
		DELETE FROM order_main WHERE id=?_order_id
		DELETE FROM order_detail WHERE id=?_order_id	
		DELETE FROM order_disc WHERE id=?_order_id	
		DELETE FROM order_itemdisc WHERE id=?_order_id			
		DELETE FROM order_itemdept WHERE order_id=?_order_id
		delete from order_modi where id=?_order_id
	ENDTEXT
	
	IF SQLEXEC(nhand,ssql)<0
		SQLROLLBACK(nhand)									&&¦^´_¼Æ¾Ú
		SQLSETPROP(nhand,"Transactions",1)		
		RELEASE _print_inv_within_order
		RETURN  -1
	
	
	ENDIF
	
			

	
	SQLCOMMIT(nhand)
	SQLSETPROP(nhand,"Transactions",1)	
	
	frm_wait.hide
		

ENDFUNC 

*****

FUNCTION  check_internet_connect

#DEFINE  FLAG_ICC_FORCE_CONNECTION 1
 
DECLARE Long InternetCheckConnection IN Wininet.dll String Url, Long dwFlags, Long Reserved
 
* Fast and reliable web site
LOCAL lcUrl 
lcUrl = "http://www.google.com"
IF InternetCheckConnection(lcUrl, FLAG_ICC_FORCE_CONNECTION, 0) = 0
	
	RETURN  .f. 
	
ENDIF

RETURN .t.


ENDFUNC






FUNCTION  update_pos_lock

#DEFINE  FLAG_ICC_FORCE_CONNECTION 1
 
DECLARE Long InternetCheckConnection IN Wininet.dll String Url, Long dwFlags, Long Reserved
 
* Fast and reliable web site
LOCAL lcUrl 
lcUrl = "http://www.poshk.com"


IF InternetCheckConnection(lcUrl, FLAG_ICC_FORCE_CONNECTION, 0) = 0
ELSE 


	=SQLSetprop(0,"displogin",3)
	=SQLSetprop(0,"DispWarnings", .F. )
	=SQLSetprop(0,"ConnectTimeOut", 1 )

	strSqlConStr = "Driver=SQL Server;SERVER=garmentexpress.poshk.com;UID=sa;PWD=proanpossapwd;DATABASE=rms6"
	__proan_hand = Sqlstringconnect(strSqlConStr)

	If __proan_hand > -1

		If Vartype(__start32_code) # "U"

			If Empty(Alltrim(__start32_code)) Or Empty(Alltrim(__start32_shop))
				fmessagebox( "set start32_code & start32_shop at rms6_tools !!" )
			Else

				_date = ALLTRIM(STR(year(DATE()))) + "/" + ALLTRIM(STR(MONTH(DATE()))) + "/" + ALLTRIM(STR(DAY(DATE())))
				
				TEXT TO cmd NOSHOW TEXTMERGE 
					if not exists (SELECT * FROM pos_lock where c_code = ?ALLTRIM(__start32_code) and shop = ?ALLTRIM(__start32_shop))
						insert into pos_lock values (?ALLTRIM(__start32_code), ?ALLTRIM(__start32_shop), ?_date, 60, getdate(), null, null, null, null)
				ENDTEXT 
				
				If SQLExec( __proan_hand, cmd) < 0
					Aerror(err)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),&__program, Lineno(1))
					Return
				Endif

				If SQLExec( __proan_hand, "SELECT * FROM pos_lock where c_code = ?ALLTRIM(__start32_code) and shop = ?ALLTRIM(__start32_shop)", "cr1") < 0
					Aerror(err)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),&__program, Lineno(1))
					Return
				Endif

				IF SQLExec( __proan_hand, "update pos_lock set spare_field_1 = 'rms6', station_last_check = getdate() where c_code = ?ALLTRIM(__start32_code) and shop = ?ALLTRIM(__start32_shop)") < 0
					Aerror(err)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),&__program, Lineno(1))
					Return
				Endif


				If Eof("cr1")
					fmessagebox("Set Start32")
				Else
					=SQLExec(nhand, "UPDATE system_setting SET cvalue = ?cr1.bomb_start_date WHERE pcode = '__bombstartdate'")
					=SQLExec(nhand, "update system_setting set cvalue = ?cr1.bomb_prompt_day where pcode = '__bombpromptday'")
				Endif

			Endif
		Endif

		=SQLIdleDisconnect(__proan_hand)
	Endif

	If Used("cr1")
		Use In cr1
	Endif


	=SQLSetprop(0,"ConnectTimeOut", 3 )
	__proan_hand = -1

ENDIF

CLEAR DLLS InternetCheckConnection

ENDFUNC


**************
*¥h±¼¨S¦³²£¥Í§@¥Îªº§é¦©

FUNCTION remove_nouse_disc
LPARAMETERS nInvID

TEXT TO ssql NOSHOW 

if exists(select id from inv where id=?nInvID and discamt=0 and id in (select id from inv_disc where id=?nInvID))
delete from inv_disc where id=?nInvID

ENDTEXT

=SQLEXEC(nhand,ssql)



ENDFUNC





**************

*­×¥¿¥I´Ú²Ó¸`¤¤¦h¦æ­«½Æªº°ÝÃD

FUNCTION fix_paydetail_error
LPARAMETERS cTableName,lLast2Day

IF VARTYPE(cTableName)#"C"
	
	cTableName="pay_detail"

ENDIF

LOCAL cCond,ldate

cCond=""
ldate=DATE()-3

IF lLast2Day
	
	cCond=" where id in (select id from inv where belongdate>?ldate) "

ENDIF



TEXT TO ssql NOSHOW TEXTMERGE 

	declare @id int
	declare @dispord int

	declare  fix_paydetail cursor for 
	select id,dispord from <<cTableName>>  <<cCond>>  group by id,dispord  having  count(0)>1
	open fix_paydetail
	fetch next from fix_paydetail 
	into @id,@dispord
	while @@fetch_status = 0
	begin						
		
		select top 1 * into ##pay_tmp123 from <<cTableName>> where id=@id and dispord=@dispord
		
		delete from  <<cTableName>> where  id=@id and dispord=@dispord
		
		insert into <<cTableName>> select * from  ##pay_tmp123
		
		drop table  ##pay_tmp123
		
		
		fetch next from fix_paydetail into @id,@dispord
	end
	close fix_paydetail

	DEALLOCATE fix_paydetail
ENDTEXT

IF  SQLEXEC(nhand,ssql)<0
	Aerror(err)
*	frm_wait.Hide
*	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	SET STEP ON 
	Return -1	
ENDIF

RETURN 1

ENDFUNC

**
FUNCTION check_kiss_connect

LOCAL cFile_rec,cFile_send

cFile_send= FULLPATH("smarttone\smart_check_send.txt")
cFile_rec= FULLPATH("smarttone\smart_check_rec.txt")

cstr="test"

STRTOFILE(cstr,cFile_send)

lSendTime=datetime()

LOCAL lError

frm_wait.showmessage("Connecting...")
frm_wait.Show
DO whil  .t.
	
	IF FILE(cFile_rec)	&& CHECK FOR CONNECT
	
		EXIT 
	ENDIF 
	 IF  DATETIME() -lSendTime>5
		 lError=.t.
	 
	 ENDIF

	f0Sleep(200)
			
ENDDO

DELETE FILE (cFile_send)
frm_wait.hide

IF lError
	
	fmessagebox("³s±µKISS¸Ë¸m¥¢±Ñ¡I")
	
	RETURN -1
	
ENDIF


cStr=FILETOSTR(cFile_rec)

IF "true"$LOWER(cStr)=.f.
	
	fmessagebox("³s±µKISS¸Ë¸m¥¢±Ñ¡I")
	RETURN  -1
	
ENDIF


RETURN 1		
			
ENDFUNC

**************
FUNCTION HEX2ASCII
PARAMETER hexin 
PRIVATE hexlist 
hexlist = "0123456789ABCDEF" 
RETURN 16 * ( AT( LEFT( hexin, 1 ), hexlist) - 1 ) + ; 
              AT( RIGHT( hexin, 1 ), hexlist ) - 1 
              
              
ENDFUNC

FUNCTION  IQCHAR
LPARAMETERS  lcMsg

IF VARTYPE(__iqchar_installed)="U" OR __iqchar_installed=.f.

	RETURN ""
	
ENDIF
LOCAL lcPort
lcPort="COM"+ALLTRIM(STR(__iqchar_port))

DECLARE String LEETEK_IQ_TFT_DLL IN LEETEK_DLL_HOMEPLUS.dll String port_msg, String num_msg

RETURN LEETEK_IQ_TFT_DLL(lcPort, ALLTRIM(lcMsg))


*FOR BBB 
FUNCTION group_print_data

SELECT *  FROM  order_itemprint_tmp WHERE sitem   INTO CURSOR cr_tmp

IF _tally=0

	RETURN 

ENDIF


LOCAL pid,sid,nqty,lcCode

SELECT cr_tmp
SCAN
	pid = cr_tmp.uid
	
	SELECT * FROM  order_itemprint_tmp WHERE parent_id=pid INTO CURSOR cr_tmp2
	
	SELECT cr_tmp2
	SCAN FOR EMPTY(modi_list)
		sid=cr_tmp2.uid
		lcCode =cr_tmp2.item_code
		
		&&Lihong 2022.03.17 ¨Ò®u orgqty_case_mat
		SELECT SUM(qty) as qty, SUM(orgqty_case_mat) as orgqty_case_mat, SUM(qty_entity) as qty_entity FROM order_itemprint_tmp  WHERE parent_id=pid AND  EMPTY(modi_list) AND item_code=lcCode INTO CURSOR cr_tmp3
		nqty = cr_tmp3.qty
		
		UPDATE  order_itemprint_tmp  SET qty =nqty, orgqty_case_mat = cr_tmp3.orgqty_case_mat, qty_entity = cr_tmp3.qty_entity WHERE uid=sid
		
		DELETE FROM order_itemprint_tmp  WHERE  parent_id=pid AND uid<>sid AND EMPTY(modi_list) AND item_code=lcCode
		
	
	ENDSCAN


ENDSCAN

IF USED("cr_tmp3")

 USE IN cr_tmp3
 
ENDIF

USE IN cr_tmp2
USE IN cr_tmp



ENDFUNC


FUNCTION RandomNumber
LPARAMETERS lnLow, lnHight
	RETURN INT((lnHight - lnLow + 1) * Rand() + lnLow)
ENDFUNC

FUNCTION RandomNumber_len_string
LPARAMETERS lnLen
	IF lnLen = 0
		RETURN ""
	ENDIF 
	lnLow = 1
	lnHigh = 10
	FOR i = 2 TO lnLen
		lnLow = lnLow * 10
		lnHigh = lnHigh * 10
	ENDFOR 
	lnHigh = lnHigh - 1
	RETURN ALLTRIM(STR(RandomNumber(lnLow, lnHigh)))
ENDFUNC  

*--------------------------------------------
FUNCTION getQrcode_string
LPARAMETERS  lcTableno,lcOutlet_id, lnppl, lcupgrade_item_id &&Lihong 2021.02.04 §ó§ïÂi¤H¼Æ«á­«¦L¤J®y¯È ¼W¥[lnppl 

	IF VARTYPE(lnppl)#"N"
		lnppl = -1
	ENDIF 

	IF VARTYPE(lcupgrade_item_id)#"C"
		lcupgrade_item_id = ""
	ENDIF 
	
	IF VARTYPE(__proan_web_so_sub_merchant_id)#"U"	

		lcSub_id =  ALLTRIM(__proan_web_so_sub_merchant_id)
		
	ELSE
	
		lcSub_id =""
		
	ENDIF


	IF VARTYPE(__proan_web_so_merchant_id)#"U"	

		lcMain_id =  ALLTRIM(__proan_web_so_merchant_id)
		
	ELSE
	
		lcMain_id =""
		
	ENDIF
	
	
	IF VARTYPE(lcOutlet_id)#"C"
	
		lcOutlet_id = ""
	
	ENDIF
	
&&Lihong 2021.03.09
*!*		IF VARTYPE(__proan_web_so_area)#"U" AND lower(__proan_web_so_area)="macau"		
*!*			lcUrl = "https://www.proan-macau.com/ProanOrder/Food?"	
*!*		ELSE		
*!*			lcUrl = "https://www.proan-order.com/ProanOrder/Food?"
*!*		ENDIF
	IF VARTYPE(__proan_web_so_area)#"U" AND lower(__proan_web_so_area)="macau"		
		lcUrl = "https://www.proan-macau.com/ProanOrder/Food?"	
	ELSE
		IF VARTYPE(__proan_web_so_area)#"U" AND LOWER(__proan_web_so_area)=="cn"	
			lcUrl = "https://www.proan.cn/ProanOrder/Food?"
		ELSE
			lcUrl = "https://www.proan-order.com/ProanOrder/Food?"
		ENDIF 
	ENDIF
	
	IF VARTYPE(__proan_web_wechat_domain)#"U" AND !EMPTY(__proan_web_wechat_domain)		
		lcUrl  =  TRIM(ALLTRIM(__proan_web_wechat_domain),"/") +"/ProanOrder/Food?"		
	ENDIF
	
	
	lcType ="so"
	IF  VARTYPE(__proan_web_so) ="U" OR  ( VARTYPE(__proan_web_so)#"U" AND __proan_web_so=.F.)
	
		lcUrl = ""
		lcType=""
	
	ENDIF
	
	
	&&Lihing 2022.04.14 ¤Wµæ¤Wµæ¦LQrcode
	IF VARTYPE(_check_valid)#"C"
		LOCAL _check_valid
		_check_valid = ""
	ENDIF 
	IF VARTYPE(__crm_shop_id)#"N"
		LOCAL __crm_shop_id
		__crm_shop_id = 0
	ENDIF 
	
	lcQRcode  = lcUrl +"type="+ lcType+"&mid="+ lcMain_id  +"&sid="+ lcSub_id +"&tn="+lcTableno +"&tcv="+_check_valid +"&crm="+allt(STR(__crm_shop_id))
	
	IF !EMPTY(lcOutlet_id)
		lcQRcode  = lcQRcode  +"&o="+lcOutlet_id 
	
	ENDIF
	
	IF VARTYPE(__proan_web_wechat_company_id) # "U" AND !EMPTY(__proan_web_wechat_company_id) 
		lcQRcode  = lcQRcode  +"&wd="+ALLTRIM(__proan_web_wechat_company_id) 
	ENDIF 
	
	&&Lihong 2021.02.04 §ó§ïÂi¤H¼Æ«á­«¦L¤J®y¯È ¼W¥[lnppl 
	IF VARTYPE(__qrcode_ppl)#"U" AND __qrcode_ppl AND lnppl > -1 
		lcQRcode  = lcQRcode  +"&ppl="+ALLTRIM(TRANSFORM(lnppl)) 
	ENDIF 

	&&Lihong 2021.11.19 §ó§ï¤É¯ÅÀ\«á­«¦L¤J®y¯È ¼W¥[ud
	IF VARTYPE(__qrcode_item_upgrade)#"U" AND __qrcode_item_upgrade
		lcupgrade_item_id = IIF(EMPTY(lcupgrade_item_id), "-1", lcupgrade_item_id) 
		lcQRcode = lcQRcode +"&ud=" + lcupgrade_item_id 
	ENDIF 
	
	*_cliptext = lcQRcode  

	RETURN lcQRcode  

ENDFUNC

* ¨úªA°È¶O
FUNCTION get_srv_fee
LPARAMETERS  nOutlet_id,cCursor

LOCAL _allow_service ,_outlet_srvper ,_srv_id,_srv_per,_curtime ,_belongdate,_isholiday,_sid,_day_section,_day

_srv_per=0.00
	
	SELECT * FROM work_order_tmp9  WHERE id=nOutlet_id INTO CURSOR cr_tmp
	
	_allow_service = NVL(cr_tmp.svccharge,.f.)
	_outlet_srvper = NVL(cr_tmp.srvper,0)

		SELECT (cCursor)
		_srv_id=Iif(_allow_service, &cCursor..srv_id,0)		&&¬O§_¦¬¨ìªA°È¶O¸ò°Ï°ì³]©w

		If Vartype(__outlet_srv)#"U" And __outlet_srv AND 	NVL(&cCursor..outletsrv,.f.)	&&¦pªGªA°È¶O¸ò°Ï°ì³]©w
		

			If  _allow_service

				_srv_per=_outlet_srvper 
				
				
			Endif


		Else
			


			If _srv_id>0

					_curdatetime=IIF(VARTYPE(_ordertime)="T", _ordertime, Datetime())								&&¨ú·í«e®É¶¡  &&Lihong 2022.03.23 _ordertime¨Ó¦Ü¤W¼h
					_curtime=Ttoc(_curdatetime, 2) &&Time()
					_curweekday=Dow(_curdatetime)
					_curweekday=Iif(_curweekday=1,7,_curweekday-1)		&&Âà¬°"¤¤°ê¦¡"ªº¬P´Á­pºâ¤èªk,©P¤@¬°²Ä¤@¤Ñ)
					_day="day"+Alltrim(Str(_curweekday))
					
				
				&&Lihong 2022.03.23 ÂàªA°È¶O²v &&_outlet_id _sit_time ¨Ó¦Û avs _cate_id¨Ó¦Û¤W¼hload_order
				_srv_id = get_tran_srv_id(_srv_id, _outlet_id, _cate_id, _curdatetime, _sit_time)
			
			
					_belongdate=getbelongdate()			&&¨ú·í«eªºbelongdate
					Select Id From work_order_tmp14 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
					_isholiday=(_Tally>0)
			
			
				Select Id From work_order_tmp15 Where (_curtime>=s_from And _curtime<=s_to) Or (s_from>s_to And (_curtime>=s_from  Or  _curtime<=s_to)) Into Array tmp_s
				If _Tally>0

					_sid=tmp_s(1)

					Select * From work_order_tmp7 Where Id=_srv_id And ( &_day Or (_isholiday And holiday)) Into Cursor cr_tmp		&&®É¬qªA°È¶O
					If _Tally>0

						If _isholiday		&& ¥ýÀË´ú°²´Á

							If !Empty(cr_tmp.holiday_section)
								_section=Trim(Trim(cr_tmp.holiday_section),',')

								If !Empty(_section)

									If Inlist(_sid,&_section)
										_srv_per=cr_tmp.srvper
									Endif
								Endif

							Endif


						Else

							If &_day
								_day_section=_day+"_section"

								If !Empty(cr_tmp.&_day_section)
									_section=Trim(Trim(cr_tmp.&_day_section),',')
									If !Empty(_section)
										If Inlist(_sid,&_section)
											_srv_per=cr_tmp.srvper

										Endif
									Endif
								Endif

							Endif

						Endif
					Endif

				Endif

			Endif


		ENDIF
		
		RETURN _srv_per

ENDFUNC

****GUID
FUNCTION gen_guid
	IF SQLEXEC(nhand, "select newid() as id", "cr_guid_tmp11") > 0
		LOCAL lcGuid_tmp
		lcGuid_tmp = ALLTRIM(cr_guid_tmp11.id)
		USE IN "cr_guid_tmp11"
		RETURN lcGuid_tmp
	ELSE 
		RETURN ""
	ENDIF 
ENDFUNC 


******* ÂêÀ\»O
FUNCTION lock_table
Lparameters lcTableno

IF table_used_check(_tableno)<0
	RETURN -1

ENDIF

LOCAL _computer
_computer=getcomputername()&&¨ú¥»¾÷¹q¸£¦WºÙ

IF SQLEXEC(nhand,"select tableno from tables where  tableno=?lcTableno and nsubtable=0","cun_tmp")<0

		aerror(err)
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
		Return	 -1

ENDIF

IF EOF("cun_tmp")

	fmessagebox("_table_notfound")

	RETURN -1
	

ENDIF


=SQLSETPROP(nhand,"Transactions",2)

				* ---  inv lock ----
			IF SQLEXEC(nhand,"update inv_lock set edit_time=getdate() ")<0
					
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions" ,1)
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					Return -1

			ENDIF	
				
			*--- inv lock ---		
		ssql="update tables set used_station=?_computer where tableno=?lcTableno and nsubtable=0"		&&°O¿ý¨Ï¥Îªºstation¦WºÙ

	If SQLExec(nhand,ssql)<0

		aerror(err)
		SQLROLLBACK(nhand)
		=SQLSETPROP(nhand,"Transactions",1)
		
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))

		Return	 -1

	Endif


IF table_used_check(lcTableno,.t.)<0
		SQLROLLBACK(nhand)
		=SQLSETPROP(nhand,"Transactions",1)

	RETURN -1

ENDIF

=SQLCOMMIT(nhand)
=SQLSETPROP(nhand,"Transactions",1)


RETURN 1

ENDFUNC

*---------------------- ¸ÑÂêÀ\»O
FUNCTION unlock_Table
LOCAL _computer,ssql
_computer=getcomputername()&&¨ú¥»¾÷¹q¸£¦WºÙ
ssql="if exists( select tableno from tables where used_station=?_computer) update tables set used_station='' where used_station=?_computer"		&&±N¦Û¤v¦btables¤Wªº¥e¥Î¥þ³¡ÄÀ©ñ

RETURN  SQLExec(nhand,ssql)

ENDFUNC

** for sys(2015)
FUNCTION FormatDatetime_second
	lnSecons = SECONDS()
	lcFormat = ALLTRIM(STR(YEAR(DATETIME()))) + ALLTRIM(PADL(MONTH(DATETIME()), 2, "0")) + ALLTRIM(PADL(DAY(DATETIME()), 2, "0")) + ;
		ALLTRIM(PADL(HOUR(DATETIME()), 2, "0")) + ALLTRIM(PADL(MINUTE(DATETIME()), 2, "0")) + ALLTRIM(PADL(ROUND((((SECONDS() % 3600) % 60) * 1000), 0), 5, "0"))			
RETURN lcFormat
ENDFUNC 


* ­pºâªþ¥[¶O
FUNCTION get_additional_fee 
	LPARAMETERS lnPayway_id, lnPayAmt

	*!*	IF !VARTYPE(lnPayway_id) = "N" OR !VARTYPE(lnPayAmt) = "N" 
	*!*		fmessagebox("°Ñ¼Æ¿ù»~")
	*!*		RETURN -1
	*!*	ENDIF

	LOCAL lnold_alias, lnAdditional_fee
	lnAdditional_fee = 0.0

	IF NVL(lnPayway_id, 0) = 1
		RETURN lnAdditional_fee
	ENDIF 

	lnold_alias = SELECT()
	IF SQLEXEC(nhand,"select id, additional_fee_type, additional_fee_rate from payway where  id=?lnPayway_id ", "additional_fee_tmp")<0
		aerror(err)
		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
		RETURN .F. &&-1 Ãþ«¬¤£¹ï¨ÏµLªkÄ~Äò
	ENDIF

	lnAdditional_fee = IIF(NVL(additional_fee_type, 0) <>1, 0.0, ROUND(NVL(additional_fee_tmp.additional_fee_rate, 0) * lnPayAmt / 100, 1))
	USE IN SELECT("additional_fee_tmp") 
	SELECT (lnold_alias)

			
	RETURN lnAdditional_fee

ENDFUNC


&&Lihong 2020.01.17
FUNCTION upload_points 
LPARAMETERS lcaction, lninvid, lnpoints, lnpoints_used, _belongdate,_memberid, _invamt, lnredeem_cust_points &&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î

&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î check_valid¤£¸òµo²¼
IF VARTYPE(lnredeem_cust_points) # "N"
	lnredeem_cust_points = 0 &&1 §Y®É¦©/°h Redeem_cust_points_20210604/Del_cust_points_20210604
ENDIF 

IF lninvid = 0
	*RETURN 
ENDIF

IF !lcaction == "up"

	nishq = IIF(Vartype(__run_hq_mode)#"U" And __run_hq_mode, 1, 0)
	TEXT TO dbsql NOSHOW TEXTMERGE 
		DECLARE @cloud_check_valid as uniqueidentifier
		DECLARE @inv_seq as int 
		DECLARE @station_id as int 
		
		DECLARE @pos_shop_id as int
		DECLARE @shop_code as nvarchar(20)
		DECLARE @shop_name as nvarchar(40)
		
	ENDTEXT 
	
	&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î
	IF VARTYPE(__cloud_member_type)#"U" AND !__cloud_member_type=='proan'  &&§Y®É¤è¦¡
		TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
		
			SET @cloud_check_valid = newid()
			SET @inv_seq = (select ISNULL(MAX(inv_seq),0)+1 from points_upload with (nolock) where inv_id=?lninvid ) 
		ENDTEXT 
		IF lnredeem_cust_points = 1 OR lninvid<=0
			TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
				SET @station_id = ?__station_id
			ENDTEXT 
		ELSE 
			TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
				SET @station_id = isnull((select ISNULL(station_id,0) as station_id from inv with (nolock) where id=?lninvid),0)
			ENDTEXT 
		ENDIF 
	ELSE 
		TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
		
			SET @cloud_check_valid = (select cloud_check_valid from inv with (nolock) where id=?lninvid)
			IF @cloud_check_valid is null 
			begin
			SET @cloud_check_valid = newid()
			UPDATE inv SET cloud_check_valid=@cloud_check_valid where id=?lninvid
			end
			SET @inv_seq = (select ISNULL(MAX(inv_seq),0)+1 from points_upload with (nolock) where inv_id=?lninvid ) 
			SET @station_id = (select station_id from inv with (nolock) where id=?lninvid)
		ENDTEXT 
	ENDIF 
	
	
*!*		IF ?lnredeem_cust_points = 1 OR 
*!*		begin
*!*		SET @cloud_check_valid = newid()
*!*		SET @inv_seq = (select ISNULL(MAX(inv_seq),0)+1 from points_upload with (nolock) where inv_id=?lninvid ) 
*!*		SET @station_id = ?__station_id
*!*		end
*!*	 	else
*!*		begin
*!*		SET @cloud_check_valid = newid()
*!*		SET @inv_seq = (select ISNULL(MAX(inv_seq),0)+1 from points_upload with (nolock) where inv_id=?lninvid ) 
*!*		SET @station_id = (select station_id from inv with (nolock) where id=?lninvid)
*!*		end

	TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	
	IF <<nishq>>=1
	begin
	SET @pos_shop_id = (select shop_id from rms8_station with (nolock) where id=@station_id)
	SET @shop_code = (select code from rms8_shop with (nolock) where id=@pos_shop_id)
	SET @shop_name = (select name from rms8_shop with (nolock) where id=@pos_shop_id)
	end
	else
	begin
	SET @pos_shop_id = -1
	SET @shop_code = ''
	SET @shop_name = ''
	end
	
	INSERT INTO points_upload (check_valid, action, station_id, pos_shop_id, shop_code, shop_name, inv_id, points, points_used, belongdate, member_id, invamt, inv_seq, create_date, redeem)  
	values (@cloud_check_valid, ?lcaction, @station_id, @pos_shop_id, @shop_code, @shop_name, ?lninvid, ?lnpoints, ?lnpoints_used, ?_belongdate, ?_memberid, ?_invamt, @inv_seq, getdate(), ?lnredeem_cust_points)
	
	--Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î
	SELECT @cloud_check_valid as cloud_check_valid
	ENDTEXT 
	
	If SQLExec(nhand, dbsql, "points_tmp")<0 
		Aerror(err)
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		IF __debug_mode 
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		ENDIF 
		IF VARTYPE(errmsg_upload_points)#"U"
			errmsg_upload_points = getmessage("_sqlserver_error")
		ENDIF 
		RETURN .F.
	ENDIF
	
	&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î
	IF lnredeem_cust_points = 1
		_points_check_valid = points_tmp.cloud_check_valid
		USE IN SELECT("points_tmp")
	ELSE 
		USE IN SELECT("points_tmp")
		RETURN 	
	ENDIF
	
ENDIF 


*	frm_wait.Hide
*!*	_shop_code = ""
*!*	_shop_name = ""
*!*	IF Vartype(__shop_id)#"U" And __shop_id>0
*!*		If SQLExec(nhand,"select code, name from shop with (nolock) where id=?__shop_id","points_tmp")<0 
*!*			IF __debug_mode 
*!*				Aerror(err)
*!*				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
*!*			ENDIF 
*!*			RETURN .F.
*!*		ENDIF
*!*		_shop_code =  ALLTRIM(NVL(points_tmp.code, ""))
*!*		_shop_name =  ALLTRIM(NVL(points_tmp.name, ""))
*!*	ENDIF 


IF lnredeem_cust_points = 1 &&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î
TEXT TO dbsql NOSHOW TEXTMERGE 
select a.check_valid, a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.inv_id, a.points, a.points_used, a.belongdate, a.invamt, a.inv_seq, a.redeem, b.bmerchant_cust_id, b.cardno,b.tel from points_upload a WITH (nolock) 
left join member b with (nolock) on a.member_id = b.id 
where a.check_valid = ?_points_check_valid and a.inv_id = ?lninvid and ISNULL(a.upcnt,0)>=0 order by  a.inv_seq 
ENDTEXT 
ELSE 
TEXT TO dbsql NOSHOW TEXTMERGE 
select a.check_valid, a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.inv_id, a.points, a.points_used, a.belongdate, a.invamt, a.inv_seq, a.redeem, b.bmerchant_cust_id, b.cardno,b.tel from points_upload a WITH (nolock) 
left join member b with (nolock) on a.member_id = b.id 
where a.inv_id = ?lninvid and ISNULL(a.upcnt,0)>=0 order by  a.inv_seq 
select a.check_valid, a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.inv_id, a.points, a.points_used, a.belongdate, a.invamt, a.inv_seq, a.redeem, b.bmerchant_cust_id, b.cardno,b.tel from points_upload a WITH (nolock) 
left join member b with (nolock) on a.member_id = b.id 
where a.inv_id in (select inv_id from points_upload WITH (nolock) where station_id=?__station_id and inv_id <>?lninvid and ISNULL(a.upcnt,0)>=0) order by a.inv_id, a.inv_seq 
ENDTEXT 
ENDIF 

If SQLExec(nhand, dbsql, "points_tmp")<0 
	IF __debug_mode 
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	ENDIF 
	IF VARTYPE(errmsg_upload_points)#"U"
		errmsg_upload_points = getmessage("_sqlserver_error")
	ENDIF 
	RETURN .F.
ENDIF

LOCAL llok, i, _inv_id, _inv_no, _belongdate 
llok = .T.
FOR i = 1 TO 2 
	&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î
	IF i = 2 AND lnredeem_cust_points = 1
		EXIT 
	ENDIF 
	
	SELECT IIF(i=1, "points_tmp", "points_tmp1")
	*IF i=1 AND EMPTY(NVL(points_tmp.cardno, "")) OR EOF("points_tmp"))
		*loop
	*ENDIF 
	SCAN 
		_check_valid = check_valid
		_action = ALLTRIM(action)
		
		_pos_shop_id = TRANSFORM(pos_shop_id)
		_shop_code = ALLTRIM(shop_code)
		_shop_name = ALLTRIM(shop_name)
		
		*lninvid = inv_id
		_inv_id = TRANSFORM(inv_id) 
		_inv_no = TRANSFORM(inv_id)
		
		_bmerchant_cust_id = TRANSFORM(NVL(bmerchant_cust_id,0)) 
		_cust_code = ALLTRIM(cardno)
		_belongdate = CHRTRAN(TRANSFORM(belongdate), "/", "-")
		*_points = TRANSFORM(NVL(points,0)) &&, "999999999.99"
		_earn_points = TRANSFORM(NVL(points,0)) 
		_redeem_points = TRANSFORM(NVL(points_used,0)) 
		_adj_points = TRANSFORM(0) 
		_inv_amount = TRANSFORM(invamt) 
		*_inv_qty = TRANSFORM(0) 
		_inv_seq = inv_seq
		
		_tel = tel
		_redeem = NVL(redeem, 0)
		
		TEXT TO lccust_points TEXTMERGE NOSHOW 
{"cust_points":[
{ "check_valid":"<<_check_valid>>", "pos_shop_id":"<<_pos_shop_id>>", "shop_code":"<<_shop_code>>", "shop_name":"<<_shop_name>>",
 "inv_id":"<<_inv_id>>", "inv_no":"<<_inv_no>>","bmerchant_cust_id":"<<_bmerchant_cust_id>>","cust_code":"<<_cust_code>>", "belongdate":"<<_belongdate>>", 
 "earn_points":<<_earn_points>>, "redeem_points":<<_redeem_points>>, 
"adj_points":<<_adj_points>>, "inv_amount":<<_inv_amount>>,"tel":"<<_tel>>"}
]}
		 ENDTEXT 
		 lccust_points = CHRTRAN(lccust_points, CHR(10)+CHR(13), "")
		 *STRTOFILE(lccust_points,"e:\x\cloudpoints.txt")
		 
		*!*	4 ¤W¶Çµo²¼, °O¿ý®ø¶O¿n¤À
		*!*	/Proan/Upload_cust_points
		*!*	°Ñ¼Æ merchant_area, bmerchant_id, merchant_id, merchant_valid_code
		*!*	¶Ç¤Jªí cust_points ¥]§tµo²¼¬ÛÃö¦r¬q«H®§¦p¤U
		*!*	pos_shop_id,
		*!*	shop_code,
		*!*	shop_name
		*!*	inv_id bitint
		*!*	inv_no int
		*!*	cust_code ·|­û¥d¸¹
		*!*	belongdate µo²¼¤é´Á
		*!*	shop_code ¤À©±½s¸¹ x
		*!*	shop_name ¤À©±¦WºÙ x
		*!*	points ¿n¤À
		*!*	earn_points 
		*!*	redeem_points
		*!*	adj_points
		*!*	inv_amount µo²¼ª÷ÃB
		*!*	inv_qty À³¸Ó¬Oµo²¼±i¼Æ x
		*!*	check_valid ­q³æÀH¾÷½X
		*!*	ªð¦^°Ñ¼Æ upload_result 1 ¤W¶Ç¦¨¥\, 0 ¤W¶Ç¥¢±Ñ

		*_run_mode = "fastfood"  AND VARTYPE(__proan_web_order_call) ¨Ï¥Î
		TEXT TO dbsql NOSHOW TEXTMERGE 
			UPDATE points_upload SET upcnt = ISNULL(upcnt,0) +1, up_date=getdate() where check_valid = ?_check_valid AND inv_seq=?_inv_seq
		ENDTEXT 
		IF sqlexec(nhand, dbsql) < 0
			IF __debug_mode 
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			IF VARTYPE(errmsg_upload_points)#"U"
				errmsg_upload_points = getmessage("_sqlserver_error")
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF
		 
		IF exec_cloud_api(_action, lccust_points, _inv_id) = .F.
			IF __debug_mode 
				*fmessagebox("¤W¶Ç¿n¤À¿ù»~¡A±N«áÄò¤W¶Ç" + CHR(13) + oCMapi.error_message)  &&getmessage()
			ENDIF 
			IF VARTYPE(errmsg_upload_points)#"U"
				IF oCMapi.status = 0 AND (LEFT(oCMapi.error_message, 14) == "Api Timeout! ["  OR LEFT(oCMapi.error_message, 19)  == "Api Error No Length") &&ºôµ¸¿ù
					errmsg_upload_points = getmessage("_network_error_try") + CHR(13) + oCMapi.error_message &&"ºôµ¸¿ù»~¡A½Ðµy«á¦A¸Õ¡G"
				ELSE
					errmsg_upload_points = getmessage("_error") + CHR(13) + oCMapi.error_message &&"¿ù»~ : "
				ENDIF 
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF 

		lcresult = oCMapi.get_value("upload_result") &&1 ¦©¤À¦¨¥\, 0 ¦©¤À¥¢±Ñ
		&&Redeem_cust_points_20210604 1 ¦©¤À¦¨¥\, 0 ¦©¤À¥¢±Ñ, -1 ¥Î¤á©Úµ´ , -2 ¦©¤À¤wºM¾P -3¦©¤À¥¢±Ñ¤£¥ÎÄ~Äò
		&&Del_cust_points_20210604 1 ¦©¤À¦¨¥\, 0 ¦©¤À¥¢±Ñ, -2  ¦©¤À¥¢±Ñ(ºôµ¸¤£³q), ¥i¥H¤£Ä~Äò½Õ¥Î -3 ¦©¤À¥¢±Ñ(¿n¤À¤£°÷)¤£¦AÄ~Äò
		IF !lcresult=="1"
			=sqlexec(nhand, "UPDATE points_upload SET upresult = LEFT(ISNULL(upresult,'') + ',' + CONVERT(varchar(10),upcnt) + ':' + ?lcresult, 250) where check_valid = ?_check_valid AND inv_seq=?_inv_seq" )
			IF __debug_mode 
				*fmessagebox("¶³ºÝ³B²z¿n¤Àªð¦^¿ù»~" )  &&getmessage()
			ENDIF 
			IF VARTYPE(errmsg_upload_points)#"U"
				errmsg_upload_points = oCMapi.get_value("error_message") &&Redeem_cust_points_20210604 Del_cust_points_20210604
*!*					DO CASE 
*!*					CASE lcresult=="0"
*!*						errmsg_upload_points = "¦©¤À¥¢±Ñ"
*!*					CASE lcresult=="-1"
*!*						errmsg_upload_points = "¥Î¤á©Úµ´¦©¤À"
*!*					CASE lcresult=="-2"
*!*						IF _action = "Redeem_cust_points_20210604"
*!*						ELSE 
*!*							errmsg_upload_points = "¦©¤À¤wºM¾P"
*!*						ENDIF 
*!*					CASE lcresult=="-3"
*!*						IF _action = "Redeem_cust_points_20210604"
*!*							errmsg_upload_points = "¦©¤À¥¢±Ñ"
*!*						ELSE 
*!*							errmsg_upload_points = "¦©¤À¥¢±Ñ(¿n¤À¤£°÷)"
*!*						ENDIF 
*!*					ENDCASE 
			ENDIF 
			
			&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î
			IF lnredeem_cust_points = 1 OR _redeem = 1 
				llok = .F.
				&&EXIT ¤£EXIT¥HÄ~Äò°õ¦æ«á­±¥N½X¼Ð°Oupcnt§¹¦¨
				IF lcresult=="0"
					EXIT 
				ENDIF 
			ELSE  
				&&LOOP ¤£LOOP¥H«OÃÒ¶¶§Ç°õ¦æ
				llok = .F.
				EXIT 
			ENDIF 
		ENDIF 

		&&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î ¦^°h(action¥i¯à»Ý­n§ï)
		dbsql = ""
		IF lcresult=="1" AND lnredeem_cust_points <> 1 AND _redeem = 1 &&INSERT¤£­nredeem¦r¬q
			TEXT TO dbsql NOSHOW TEXTMERGE 
				DECLARE @inv_seq as int
				SET @inv_seq = (select ISNULL(MAX(inv_seq),0)+1 from points_upload with (nolock) where inv_id=?lninvid )
				INSERT INTO points_upload (check_valid, action, station_id, pos_shop_id, shop_code, shop_name, inv_id, points, points_used, belongdate, member_id, invamt, inv_seq, create_date, redeem)  
				SELECT newid(), 'Add_cust_points_20210604', station_id, pos_shop_id, shop_code, shop_name, inv_id, 0, -points_used, belongdate, member_id, invamt, @inv_seq, getdate(), -1 
				from points_upload where check_valid = ?_check_valid
			ENDTEXT 
		ENDIF 

		*_run_mode = "fastfood"  AND VARTYPE(__proan_web_order_call) ¨Ï¥Î
		TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
			UPDATE points_upload SET upcnt = -ISNULL(upcnt, 1), up_date=getdate() where check_valid = ?_check_valid AND inv_seq=?_inv_seq
			/* DELETE points_upload where check_valid = ?_check_valid */ 
			 DELETE points_upload where upcnt<0 AND datediff(dd, up_date, getdate())>6 
		ENDTEXT 

		IF sqlexec(nhand, dbsql) < 0
			IF __debug_mode 
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			IF VARTYPE(errmsg_upload_points)#"U"
				errmsg_upload_points = getmessage("_sqlserver_error")
			ENDIF 
			IF lnredeem_cust_points <> 1 &&Lihong 2021.05.20 ¶³·|­û¿n¤À§Y®É¦©´î lnredeem_cust_points = 1§ó·s¼ÐÃÑ¥¢±Ñ¥i¥H¿n¤À§I´«
				llok = .F.
			ENDIF 
			EXIT 
		ENDIF


	ENDSCAN 
	IF llok = .F.
		EXIT 
	ENDIF 
ENDFOR 

RETURN llok
ENDFUNC

&&Lihong 2020.01.17
FUNCTION exec_cloud_api
LPARAMETERS lccmd, lccust_points, lcinvid

IF TYPE("oCMapi") != "O"
	SET CLASSLIB TO class\invoice_base ADDITIVE 
	PUBLIC oCMapi
	oCMapi = CREATEOBJECT("cloud_member_api")
ENDIF 

oCMapi.clear_info()
oCMapi.api_name = lccmd

*DO CASE 
*CASE lccmd == "upload_cust_points"
	oCMapi.api_remark = "invid:" + lcinvid &&¤é»x¥Î
	oCMapi.set_value("cust_points", lccust_points)
	
*ENDCASE 

oCMapi.api_run()
IF oCMapi.status <> 1 && + getmessage("_get_cust_info_error") + CHR(13)
	IF __debug_mode 
		*fmessagebox(getmessage("_require_member_no") + CHR(13) + oCMapi.error_message)
	ENDIF 
	RETURN .F.
ENDIF 
*
ENDFUNC


&&Lihong 2020.06.28
FUNCTION get_cloud_cust_mode_api
LPARAMETERS lllogin

*!*	/Proan/Get_bmerchant_cust_mode_20210604
*!*	Àò¨ú¤j°Ó¤á¼Ò¦¡©M°Ï¸¹
*!*	¶Ç¤J°ò¥»°Ñ¼Æ
*!*	ªð¦^ªí merchant ¥]§t¦r¬q
*!*	cust_mode 1 ·|­û½s¸¹¼Ò¦¡, 2 ¹q¸Ü¼Ò¦¡
*!*	tel_prefix  Àq»{°ê»Ú°Ï¸¹
 
IF VARTYPE(_screen.cloud_cust_mode)="N" AND !lllogin=.T.
	RETURN 
ENDIF 

IF TYPE("oCMapi") != "O"
	SET CLASSLIB TO class\invoice_base ADDITIVE 
	PUBLIC oCMapi
	oCMapi = CREATEOBJECT("cloud_member_api")
ENDIF 

oCMapi.clear_info()
oCMapi.api_name = "Get_bmerchant_cust_mode_20210604"
oCMapi.api_remark = "Get_bmerchant_cust_mode_20210604" &&¤é»x¥Î

oCMapi.api_run()
IF oCMapi.status <> 1 && + getmessage("_get_cust_info_error") + CHR(13)
	IF __debug_mode 
		*fmessagebox(getmessage("_require_member_no") + CHR(13) + oCMapi.error_message)
	ENDIF 
	RETURN .F.
ENDIF 

*!*	lcresult = oCMapi.get_value("upload_result") &&1 ¦©¤À¦¨¥\, 0 ¦©¤À¥¢±Ñ
*!*	IF !lcresult=="1"
*!*		IF __debug_mode 
*!*			*fmessagebox("¶³ºÝ·|­û¼Ò¦¡¼Æ¾Úªð¦^¿ù»~" )  &&getmessage()
*!*		ENDIF 
*!*		RETURN .F.
*!*	ENDIF 

lcstr_merchant = oCMapi.get_value("merchant")
IF EMPTY(lcstr_merchant) 
	*fmessagebox("·|­û¼Ò¦¡¼Æ¾Ú¿ù»~")  &&getmessage()
	RETURN .F.
ENDIF 

USE IN SELECT("cloud_membermode_tmp")	
IF oCMapi.get_valud_to_cursor("merchant", "cloud_membermode_tmp") = .F. OR !USED("cloud_membermode_tmp") 
	*fmessagebox("¶³ºÝ·|­û¼Ò¦¡¼Æ¾Ú¸ÑªR¿ù»~")  &&getmessage()
	RETURN .F.
ENDIF 

_cust_mode = VAL(cloud_membermode_tmp.cust_mode)
_tel_prefix = ALLTRIM(cloud_membermode_tmp.tel_prefix) 
_screen.AddProperty("cloud_cust_mode", _cust_mode )
_screen.AddProperty("cloud_tel_prefix", _tel_prefix )

ENDFUNC


&&Lihong 2020.06.01
FUNCTION upload_coupon 
LPARAMETERS lcaction,lnbn_type, lclock_valid, lnorderid, lninvid, lncloud_coupon_id, lcweb_coupon_id, lcweb_coupon_code
*"sell_coupon", 1, null, _curorder, _inv_no 
*"redeem_coupon", 1, null, _curorder, _inv_no
*"revoke_redeemed_coupon", 0, null, 0, _inv_no
*"revoke_selled_coupon", 0, null, 0, _inv_no
*redeem_coupon/revoke_redeemed_coupon¡Glnbn_type 1²{ª÷¨é 2§I´«¨é

*SET STEP ON 
IF !lcaction == "up"

DO CASE 
CASE lcaction == "sell_coupon" 
	*³]¬°¤w¾P°â
	*!*	/Cloudcoupon/Sell_coupon
	*!*	¤J°Ñ
	*!*	shop_id
	*!*	sell_station_id ¬O¥X°âªºstation,  »P¤W¶Çstation ¤£¦P
	*!*	web_coupon_id
	*!*	web_coupon_code
	*!*	inv_id ¹ïÀ³invªºid
	*!*	inv_no
	*!*	sell_date_time  ¥X°âªº¤é´Á, ­n¥]§t®É¶¡©M¤ÀÁé
	*!*	ªð¦^ check_result 1 ¦¨¥\, 0¥¢±Ñ

	LOCAL dbsql 
	TEXT TO dbsql NOSHOW TEXTMERGE 
		SELECT a.begintime as sell_date_time, b.cloud_coupon_id, b.web_coupon_id, b.web_coupon_code, 0.00 as redeem_amt 
		FROM inv_detail b with (nolock) left join inv a with (nolock) on b.id = a.id where a.id=?lninvid and b.item_id = -51 
	ENDTEXT 
	IF sqlexec(nhand, dbsql, "coupon_info_tmp") < 0
		*IF __debug_mode 
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		*ENDIF 
		RETURN .F.
		*llok = .F.
		*EXIT 
	ENDIF
	IF RECCOUNT("coupon_info_tmp") = 0 
		USE IN SELECT("coupon_info_tmp") 
		RETURN 
	ENDIF 
CASE lcaction == "redeem_coupon2" 
*³]¬°¤w§I´« order ¹êª«§I´«¨é
	USE IN SELECT("coupon_info_tmp") 
	Create Cursor coupon_info_tmp (idx int )
	APPEND BLANK 

CASE lcaction == "redeem_coupon"
*³]¬°¤w§I´«
*!*	/Cloudcoupon/Redeem_coupon
*!*	¤J°Ñ
*!*	shop_id
*!*	redeem_station_id ¬O§I´«ªºstation,  »P¤W¶Çstation ¤£¦P
*!*	web_coupon_id
*!*	web_coupon_code
*!*	inv_id ¹ïÀ³invªºid
*!*	inv_no
*!*	redeem_date_time  §I´«ªº¤é´Á, ­n¥]§t®É¶¡©M¤ÀÁé
*!*	redeem_amt §I´«ª÷ÃB
*!*	ªð¦^ check_result 1 ¦¨¥\, 0¥¢±Ñ
	LOCAL dbsql 
	IF lnbn_type=1 &&²{ª÷¨é else §I´«¨é
		TEXT TO dbsql NOSHOW TEXTMERGE 
			SELECT begintime FROM inv with (nolock) where id=?lninvid 
		ENDTEXT 
		IF Vartype(_inv_changepayway_coupon)#"U" AND _inv_changepayway_coupon OR Vartype(_inv_change_mode)#"U" AND VARTYPE(_inv_resave_mode)="U"
			TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
				SELECT a.begintime as sell_date_time, b.cloud_coupon_id, b.web_coupon_id, b.web_coupon_code, b.payamt as redeem_amt 
				FROM pay_detail b with (nolock) left join inv a with (nolock) on b.id = a.id where a.id=?lninvid and b.pay_id = -8 and ISNULL(coupon,0) = 0  
			ENDTEXT
		ENDIF 	
	ELSE
	TEXT TO dbsql NOSHOW TEXTMERGE 
		SELECT a.begintime as sell_date_time, b.cloud_coupon_id, b.web_coupon_id, b.web_coupon_code, b.disc_amount as redeem_amt 
		FROM inv_itemdisc b with (nolock) left join inv a with (nolock) on b.id = a.id where a.id=?lninvid and b.disc_id = -8   
	ENDTEXT
	ENDIF  
	IF sqlexec(nhand, dbsql, "coupon_info_tmp") < 0
		*IF __debug_mode 
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		*ENDIF 
		RETURN .F.
		*llok = .F.
		*EXIT 
	ENDIF
	IF lnbn_type=1 
		ldsell_date_time = coupon_info_tmp.begintime
		IF Vartype(_inv_changepayway_coupon)#"U" AND _inv_changepayway_coupon OR Vartype(_inv_change_mode)#"U" AND VARTYPE(_inv_resave_mode)="U"
			SELECT DATETIME() as sell_date_time, cloud_coupon_id, web_coupon_id, web_coupon_code, payamt as redeem_amt ;
			from payment_tmp WHERE pay_id = -8 AND web_coupon_code NOT in (SELECT web_coupon_code FROM coupon_info_tmp1)  INTO CURSOR coupon_info_tmp READWRITE 
			USE IN SELECT("coupon_info_tmp1")
		ELSE 
			SELECT DATETIME() as sell_date_time, cloud_coupon_id, web_coupon_id, web_coupon_code, payamt as redeem_amt ;
			from payment_tmp WHERE pay_id = -8 INTO CURSOR coupon_info_tmp READWRITE 
		ENDIF 
		SELECT coupon_info_tmp 
		REPLACE sell_date_time WITH ldsell_date_time IN coupon_info_tmp 
	ENDIF 
	IF RECCOUNT("coupon_info_tmp") = 0 
		USE IN SELECT("coupon_info_tmp") 
		RETURN 
	ENDIF 

*!*	CASE lcaction == "revoke_redeemed_coupon2" ->revoke_redeemed_coupon_one
*!*	*ºM¾P§I´« (order ¹êª«§I´«¨é §R°£®É)
*!*		USE IN SELECT("coupon_info_tmp") 
*!*		Create Cursor coupon_info_tmp (idx int )
*!*		APPEND BLANK 

CASE lcaction == "revoke_redeemed_coupon"
*ºM¾P§I´« (­×§ïµo²¼, ©Î§R°£µo²¼®É)
*!*	 Revoke_redeemed_coupon
*!*	¤J°Ñ
*!*	shop_id
*!*	web_coupon_id
*!*	web_coupon_code
*!*	check_result 1 ºM¾P¦¨¥\

	LOCAL dbsql 
	IF lnbn_type=1 &&²{ª÷¨é else §I´«¨é
	TEXT TO dbsql NOSHOW TEXTMERGE 
		SELECT a.voidtime as sell_date_time, b.cloud_coupon_id, b.web_coupon_id, b.web_coupon_code, b.payamt as redeem_amt 
		FROM pay_detail b with (nolock) left join inv a with (nolock) on b.id = a.id where a.id=?lninvid and b.pay_id = -8 and ISNULL(coupon,0) = 0  
	ENDTEXT 
	ELSE
	TEXT TO dbsql NOSHOW TEXTMERGE 
		SELECT a.begintime as sell_date_time, b.cloud_coupon_id, b.web_coupon_id, b.web_coupon_code, b.disc_amount as redeem_amt 
		FROM inv_itemdisc b with (nolock) left join inv a with (nolock) on b.id = a.id where a.id=?lninvid and b.disc_id = -8   
	ENDTEXT
	ENDIF 
	IF sqlexec(nhand, dbsql, "coupon_info_tmp") < 0
		*IF __debug_mode 
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		*ENDIF 
		RETURN .F.
		*llok = .F.
		*EXIT 
	ENDIF
	IF lnbn_type=1 AND (Vartype(_inv_changepayway_coupon)#"U" AND _inv_changepayway_coupon OR Vartype(_inv_change_mode)#"U" AND VARTYPE(_inv_resave_mode)="U")
		SELECT * from coupon_info_tmp WHERE web_coupon_code NOT in (SELECT web_coupon_code FROM payment_tmp WHERE pay_id = -8) INTO CURSOR coupon_info_tmp
	ENDIF 
	IF RECCOUNT("coupon_info_tmp") = 0 
		USE IN SELECT("coupon_info_tmp") 
		RETURN 
	ENDIF 

CASE lcaction == "revoke_selled_coupon"
	LOCAL dbsql 
	TEXT TO dbsql NOSHOW TEXTMERGE 
		SELECT a.begintime as sell_date_time, b.cloud_coupon_id, b.web_coupon_id, b.web_coupon_code, 0.00 as redeem_amt 
		FROM inv_detail b with (nolock) left join inv a with (nolock) on b.id = a.id where a.id=?lninvid and b.item_id = -51 
	ENDTEXT 
	IF sqlexec(nhand, dbsql, "coupon_info_tmp") < 0
		*IF __debug_mode 
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		*ENDIF 
		RETURN .F.
		*llok = .F.
		*EXIT 
	ENDIF
	IF RECCOUNT("coupon_info_tmp") = 0 
		USE IN SELECT("coupon_info_tmp") 
		RETURN 
	ENDIF 

OTHERWISE 
 *unLock_coupon ¸ÑÂê
 *revoke_selled_coupon_one ºM¾P¾P°â(1¦æ)
 *revoke_redeemed_coupon_one ºM¾P§I´«¨é(1¦æ)
IF lcaction == "unlock_coupon" AND lncloud_coupon_id = 0 
	RETURN 
ENDIF 
*¸ÑÂê
*!*		¤J°Ñ
*!*		bn_type  1 ¾P°â,  2 §I´«
*!*		shop_id
*!*		station_id
*!*		lock_valid ´N¬O check_ valid
*!*		web_coupon_id
*!*		web_coupon_code ½s¸¹
*!*		ªð¦^ check_result 1 ¦¨¥\, 0¥¢±Ñ

	USE IN SELECT("coupon_info_tmp") 
	Create Cursor coupon_info_tmp (idx int )
	APPEND BLANK 
ENDCASE  

	SELECT coupon_info_tmp
	SCAN 
		IF lcaction == "sell_coupon" OR lcaction == "redeem_coupon" OR lcaction == "revoke_redeemed_coupon" OR lcaction == "revoke_selled_coupon"
			_sell_date_time = sell_date_time
			lncloud_coupon_id = cloud_coupon_id 
			lcweb_coupon_id = web_coupon_id 
			lcweb_coupon_code = web_coupon_code 
			_redeem_amt = redeem_amt
		ELSE
			_sell_date_time = null 
			_redeem_amt = 0.00
			IF lcaction == "revoke_selled_coupon_one" OR lcaction == "revoke_redeemed_coupon_one"
				_sell_date_time = DATETIME()
			ENDIF 
			IF lcaction == "revoke_selled_coupon_one"
				lcaction = "revoke_selled_coupon"
			ENDIF 
			IF lcaction == "revoke_redeemed_coupon_one" &&¥u§I´«¨é
				lcaction = "revoke_redeemed_coupon"
			ENDIF 
			
			IF lcaction == "redeem_coupon2"  &&¥uorder§I´«¨é
				lcaction = "redeem_coupon"
				_sell_date_time = DATETIME()
				_redeem_amt = order_itemlist_tmpcou.coupon_disc_amount
			ENDIF 
			
		ENDIF 
		IF lcaction == "redeemed_coupon" OR lcaction == "revoke_redeemed_coupon"
			*lnbn_type=0 &&­É¥Î¦¹ÅÜ¶q 1²{ª÷¨é 2 §I´«¨é
		ENDIF 
		nishq = IIF(Vartype(__run_hq_mode)#"U" And __run_hq_mode, 1, 0)

		TEXT TO dbsql NOSHOW TEXTMERGE 
		DECLARE @cloud_check_valid as uniqueidentifier 
		DECLARE @coupon_seq as int 
		DECLARE @station_id as int 
		
		DECLARE @pos_shop_id as int
		DECLARE @shop_code as nvarchar(20)
		DECLARE @shop_name as nvarchar(40)

		SET @cloud_check_valid = newid()
		
		SET @coupon_seq = (select ISNULL(MAX(coupon_seq),0)+1 from coupon_upload with (nolock) where cloud_coupon_id=?lncloud_coupon_id AND web_coupon_id=?lcweb_coupon_id ) 
		SET @station_id = ?__station_id

		IF <<nishq>>=1
		begin
		SET @pos_shop_id = (select shop_id from rms8_station with (nolock) where id=@station_id)
		SET @shop_code = (select code from rms8_shop with (nolock) where id=@pos_shop_id)
		SET @shop_name = (select name from rms8_shop with (nolock) where id=@pos_shop_id)
		end
		else
		begin
		SET @pos_shop_id = -1
		SET @shop_code = ''
		SET @shop_name = ''
		end
		
		INSERT INTO coupon_upload (check_valid, action, bn_type, lock_valid, station_id, pos_shop_id, shop_code, shop_name, sell_date_time,order_id, inv_id, cloud_coupon_id, web_coupon_id, web_coupon_code, redeem_amt, coupon_seq, create_date)  
		values (@cloud_check_valid, ?lcaction, ?lnbn_type, ?lclock_valid, @station_id, @pos_shop_id, @shop_code, @shop_name, ?_sell_date_time, ?lnorderid, ?lninvid, ?lncloud_coupon_id, ?lcweb_coupon_id, ?lcweb_coupon_code, ?_redeem_amt, @coupon_seq, getdate())
		ENDTEXT 
		If SQLExec(nhand, dbsql)<0 
			Aerror(err)
			*Sqlrollback(nhand)
			*SQLSetprop(nhand,"Transactions",1)
			IF __debug_mode 
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			RETURN .F.
		ENDIF
	ENDSCAN 
	
	RETURN 
ENDIF 


*!*	TEXT TO dbsql NOSHOW TEXTMERGE 
*!*	select a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.cloud_coupon_id, a.web_coupon_id, a.web_coupon_code, a.coupon_seq, create_date from coupon_upload a WITH (nolock) 
*!*	where a.cloud_coupon_id = ?lncloud_coupon_id and a.web_coupon_id = ?lcweb_coupon_id and ISNULL(a.upcnt,0)>=0 order by  a.coupon_seq 
*!*	select a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.cloud_coupon_id, a.web_coupon_id, a.web_coupon_code, a.coupon_seq, create_date from coupon_upload a WITH (nolock) 
*!*	where a.cloud_coupon_id <> ?lncloud_coupon_id and a.web_coupon_id <> ?lcweb_coupon_id and ISNULL(a.upcnt,0)>=0 order by  a.cloud_coupon_id, a.web_coupon_id, a.coupon_seq 
*!*	ENDTEXT 
TEXT TO dbsql NOSHOW TEXTMERGE  &&a.station_id=?__station_id and 
select a.check_valid, a.action, bn_type, lock_valid, a.station_id, a.pos_shop_id, a.shop_code, a.shop_name, a.sell_date_time, a.inv_id, a.cloud_coupon_id, a.web_coupon_id, a.web_coupon_code, redeem_amt, a.coupon_seq, create_date from coupon_upload a WITH (nolock) 
where ISNULL(a.upcnt,0)>=0 order by  a.web_coupon_id, a.coupon_seq 
ENDTEXT 

If SQLExec(nhand, dbsql, "cloud_tmp")<0 
	IF __debug_mode 
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	ENDIF 
	RETURN .F.
ENDIF

llok = .T.
*!*	FOR i = 1 TO 2 
*!*		SELECT IIF(i=1, "cloud_tmp", "cloud_tmp1")
*!*		*IF i=1 AND EMPTY(NVL(points_tmp.cardno, "")) OR EOF("points_tmp"))
*!*			*loop
*!*		*ENDIF 
	SELECT cloud_tmp
	SCAN 
		_check_valid = check_valid
		_action = ALLTRIM(action)

		*IF unLock_coupon
		_bn_type = TRANSFORM(bn_type)
		_lock_valid = ALLTRIM(lock_valid)
		*
		_station_id = TRANSFORM(station_id)
		
		_pos_shop_id = TRANSFORM(pos_shop_id)
		_shop_code = ALLTRIM(shop_code)
		_shop_name = ALLTRIM(shop_name)

		*IF _action == "sell_coupon" 
		_sell_date_time = CHRTRAN(TRANSFORM(sell_date_time), "/", "-")
		_inv_id_coupon = TRANSFORM(inv_id)
		_inv_no_coupon = _inv_id_coupon 
		* 
		_cloud_coupon_id = TRANSFORM(cloud_coupon_id)
		_web_coupon_id = ALLTRIM(web_coupon_id)
		_web_coupon_code = ALLTRIM(web_coupon_code)
		
		_redeem_amt = TRANSFORM(redeem_amt)
		
		_create_date = CHRTRAN(TRANSFORM(create_date), "/", "-")
		_coupon_seq = coupon_seq
		
*!*			TEXT TO lccloud_coupon TEXTMERGE NOSHOW 
*!*	{"cloud_coupon":[
*!*	{"check_valid":"<<_check_valid>>", "station_id":"<<_station_id>>", "pos_shop_id":"<<_pos_shop_id>>", "shop_code":"<<_shop_code>>", "shop_name":"<<_shop_name>>",
*!*	"cloud_coupon_id":"<<_cloud_coupon_id>>", "web_coupon_id":"<<_web_coupon_id>>","web_coupon_code":"<<_web_coupon_code>>",
*!*	"create_date":"<<_create_date>>"}
*!*	]}
*!*			 ENDTEXT 
*!*			 lccloud_coupon = CHRTRAN(lccloud_coupon, CHR(10)+CHR(13), "")
		 *STRTOFILE(lccust_points,"e:\x\cloudpoints.txt")
		 
		*!*	¸ÑÂê
		*!*	/Cloudcoupon/UnLock_coupon
		*!*	¤J°Ñ»P¤WÂê¤@­P
		*!*	ªð¦^ check_result 1 ¦¨¥\, 0¥¢±Ñ

		TEXT TO dbsql NOSHOW TEXTMERGE 
			UPDATE coupon_upload SET upcnt = ISNULL(upcnt,0) +1, up_date=getdate() where check_valid = ?_check_valid AND coupon_seq=?_coupon_seq
		ENDTEXT 
		IF sqlexec(nhand, dbsql) < 0
			IF __debug_mode 
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF
		 
		*SET STEP ON 
		IF exec_coupon_api("cloudcoupon/" + _action) = .F.
			IF __debug_mode 
				*fmessagebox("¤W¶Ç¿n¤À¿ù»~¡A±N«áÄò¤W¶Ç" + CHR(13) + oCMapi.error_message)  &&getmessage()
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF 

		lcresult = oCMapi.get_value("check_result")
		IF !lcresult=="1"
			=sqlexec(nhand, "UPDATE coupon_upload SET upresult = LEFT(ISNULL(upresult,'') + ',' + CONVERT(varchar(10),upcnt) + ':' + ?lcresult, 250) where check_valid = ?_check_valid AND coupon_seq=?_coupon_seq" )
			IF __debug_mode 
				*fmessagebox("¶³ºÝ³B²z¿n¤Àªð¦^¿ù»~" )  &&getmessage()
			ENDIF 
			LOOP 
			*llok = .F.
			EXIT 
		ENDIF 

		*_run_mode = "fastfood"  AND VARTYPE(__proan_web_order_call) ¨Ï¥Î
		TEXT TO dbsql NOSHOW TEXTMERGE 
			UPDATE coupon_upload SET upcnt = -ISNULL(upcnt, 1), up_date=getdate() where check_valid = ?_check_valid AND coupon_seq=?_coupon_seq
			/* DELETE coupon_upload where check_valid = ?_check_valid */ 
			 DELETE coupon_upload where upcnt<0 AND datediff(dd, up_date, getdate())>6 
		ENDTEXT 

		IF sqlexec(nhand, dbsql) < 0
			IF __debug_mode 
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF


	ENDSCAN 
*!*		IF llok = .F.
*!*			EXIT 
*!*		ENDIF 
*!*	ENDFOR 

RETURN llok

ENDFUNC

&&Lihong 2020.12.14 coupon
FUNCTION allow_revoke_sell
	LPARAMETERS lc_coupon, lc_coupon_id 

	IF exec_coupon_api("cloudcoupon/judge_revoke_sell", lc_coupon, lc_coupon_id ) = .F.
		IF oCMapi.status = 0 AND (LEFT(oCMapi.error_message, 14) == "Api Timeout! ["  OR LEFT(oCMapi.error_message, 19)  == "Api Error No Length") &&ºôµ¸¿ù¡A¹êÅé¥d¥i¥»¦a 
			lcmsg = getmessage("_network_error_try")  &&ºôµ¸¿ù»~, ½Ðµy«J¦A¸Õ¡G
			fmessagebox(lcmsg + oCMapi.error_message)  &&getmessage()
			RETURN .F.
		ENDIF 
		
		lcmsg = getmessage("_error")  &&¿ù»~ ¡G
		fmessagebox(lcmsg + CHR(13) + oCMapi.error_message) 
		RETURN .F.
	ENDIF 

	lcresult = oCMapi.get_value("check_result")
	IF !lcresult=="1"
		lcstr_coupon = oCMapi.get_value("dt_coupon")
		IF EMPTY(lcstr_coupon) 
			lcmsg = getmessage("_coupon_data_error") &&Â§¨é¼Æ¾Ú¿ù»~ Coupon data error
			fmessagebox("_coupon_data_error")  &&getmessage()
			RETURN .F.
		ENDIF 

		&&
		TRY
		*STRTOFILE(lcstr_coupon,"e:\x\cloudcouponrevoke.txt")
		CATCH
		ENDTRY 

		IF oCMapi.get_valud_to_cursor("dt_coupon", "cr_coupon_info") = .F. OR !USED("cr_coupon_info")
			lcmsg = getmessage("_coupon_data_parsing_error") &&Â§¨é¼Æ¾Ú¸ÑªR¿ù»~ Coupon data parsing error 
			fmessagebox("_coupon_data_parsing_error")  &&getmessage()
			RETURN .F.
		ENDIF 
		
		
		SELECT cr_coupon_info
		lcmsg_code = getmessage("_this_code_not_found")  &&¥¼¬d¨ì³o­Ócode This code is not found
		lcmsg_dele = getmessage("_coupon_deleted")  &&Â§¨é¤w³Q§R°£ Coupon has been deleted
		lcmsg_suspend = getmessage("_coupon_suspended")  &&Â§¨é¤w³Q¼È°±¨Ï¥Î Coupon has been suspended
		lcmsg_code_dele = getmessage("_coupon_code_dele") &&Â§¨é½s¸¹¤w³Q§R°£"
		lcmsg_nosale = getmessage("_coupon_not_sold2") &&Â§¨é¥¼¾P°â Coupon not sold
		lcmsg_redeem = getmessage("_coupon_redeemed2")  &&¤wÁ`´« Coupon redeemed
		GO TOP 
		_norevoke_msg = ""
		SCAN FOR ALLTRIM(cr_coupon_info.result)<>"1" &&AND <> ALLTRIM(cr_coupon_info.result)<>"-4" &&1 ¥iºM¾P¾P°â, 0 ¥¼¬d¨ì³o­Ócode, -1 Â§¨é¤w³Q§R°£, -2 Â§¨é¤w³Q¼È°±¨Ï¥Î, -3 Â§¨é½s¸¹¤w³Q§R°£, -4 ¥¼¾P°â, -5 ¤wÁ`´«
			lcresult2 = ALLTRIM(cr_coupon_info.result)
			lcmsg = ICASE(lcresult2 == "0", lcmsg_code, lcresult2 == "-1", lcmsg_dele, lcresult2 == "-2", lcmsg_suspend, lcresult2 == "-3", lcmsg_code_dele, lcresult2 == "-4", lcmsg_nosale, lcresult2 == "-5", lcmsg_redeem)
			_norevoke_msg = _norevoke_msg + IIF(EMPTY(_norevoke_msg), "", CHR(13)) + ALLTRIM(cr_coupon_info.web_coupon_code) + "¡G" + lcmsg
		ENDSCAN 

		IF !EMPTY(_norevoke_msg)
			lcmsg = getmessage("_cannot_delete_invoice") &&¤£¯à§R°£µo²¼ Cannot delete  invoice
			fmessagebox(lcmsg + CHR(13) + _norevoke_msg)
		ENDIF 
		RETURN .F.
	ENDIF 
ENDFUNC

&&Lihong 2020.06.01 coupon
FUNCTION exec_coupon_api
LPARAMETERS lccmd, lccode, lcid
IF TYPE("oCMapi") != "O"
	SET CLASSLIB TO class\invoice_base ADDITIVE 
	PUBLIC oCMapi
	oCMapi = CREATEOBJECT("cloud_member_api")
ENDIF 

oCMapi.clear_info()
oCMapi.api_name = lccmd

*¸ÑÂê
*!*	bn_type  1 ¾P°â,  2 §I´«
*!*	shop_id
*!*	station_id
*!*	lock_valid ´N¬O check_ valid
*!*	web_coupon_id
*!*	web_coupon_code ½s¸¹

*³]¬°¤w¾P°â
*!*	shop_id
*!*	sell_station_id ¬O¥X°âªºstation,  »P¤W¶Çstation ¤£¦P
*!*	web_coupon_id
*!*	web_coupon_code
*!*	inv_id ¹ïÀ³invªºid
*!*	inv_no
*!*	sell_date_time  ¥X°âªº¤é´Á, ­n¥]§t®É¶¡©M¤ÀÁé

DO CASE 
CASE lccmd == "cloudcoupon/judge_revoke_sell"
	 IF Vartype(__run_hq_mode)#"U" And __run_hq_mode
		IF sqlexec(nhand, "select shop_id from rms8_station with (nolock) where id=?__station_id", "coupon_info_tmp") < 0
			aerror(err)
			error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
			RETURN .F.
		ENDIF 
		_shop_id = coupon_info_tmp.shop_id 
	ELSE
		_shop_id = -1
	ENDIF 

	oCMapi.api_remark = "coupon_code:" + lccode &&¤é»x¥Î
	oCMapi.set_value("web_coupon_id", lcid)
	oCMapi.set_value("shop_id", TRANSFORM(_shop_id))
OTHERWISE 
	oCMapi.api_remark = "coupon_code:" + _web_coupon_code &&¤é»x¥Î
	IF lccmd == "cloudcoupon/unlock_coupon"
		oCMapi.set_value("bn_type", _bn_type)
		oCMapi.set_value("station_id", _station_id)
		oCMapi.set_value("lock_valid", _lock_valid)
	ENDIF 
	IF lccmd == "cloudcoupon/sell_coupon"  
		oCMapi.set_value("sell_station_id", _station_id)
		oCMapi.set_value("sell_date_time", _sell_date_time)
		oCMapi.set_value("inv_id", _inv_id_coupon)
		oCMapi.set_value("inv_no", _inv_no_coupon)
	ENDIF 
	IF lccmd == "cloudcoupon/redeem_coupon"
		oCMapi.set_value("redeem_station_id", _station_id)
		oCMapi.set_value("redeem_date_time", _sell_date_time)
		oCMapi.set_value("inv_id", _inv_id_coupon)
		oCMapi.set_value("inv_no", _inv_no_coupon)
		oCMapi.set_value("redeem_amt", _redeem_amt)
	ENDIF 
	IF lccmd == "revoke_redeemed_coupon"
	ENDIF 
	IF lccmd == "revoke_selled_coupon"
	ENDIF 
	
	oCMapi.set_value("shop_id", _pos_shop_id)
	oCMapi.set_value("web_coupon_id", _web_coupon_id)
	oCMapi.set_value("web_coupon_code", _web_coupon_code)
	
ENDCASE 

oCMapi.api_run()
IF oCMapi.status <> 1 && + getmessage("_get_cust_info_error") + CHR(13)
	IF __debug_mode 
		fmessagebox(_web_coupon_code + CHR(13) + oCMapi.error_message)
	ENDIF 
	RETURN .F.
ENDIF 
*
ENDFUNC

FUNCTION check_couponcash_initem
	LPARAMETERS lnInv_id,lnOrder_id
	* ÀË¬d µo²¼©Î¸¨³æ¤¤¬O§_¦³couponcash item_id=-51 >0 ¦³  =0 µL  -1 ¥X¿ù
	IF lnInv_id>0
		IF SQLEXEC(nhand, "select id from inv_detail  where id=?lnInv_id and  item_id=-51 ","cr_tmp")<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return  -1
		ENDIF
		IF !EOF("cr_tmp")
			RETURN 1
		ENDIF
	ENDIF
	IF  lnOrder_id>0
		IF SQLEXEC(nhand, "select id from order_detail where id=?lnOrder_id and item_id=-51 ","cr_tmp")<0
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			Return  -1
		ENDIF
		IF !EOF("cr_tmp")
			RETURN 1
		ENDIF	
	ENDIF
	RETURN 0

ENDFUNC


FUNCTION FormatDatetime_second1()
	lnSecons = SECONDS()
	lcFormat = ALLTRIM(STR(YEAR(DATETIME()))) + ALLTRIM(PADL(MONTH(DATETIME()), 2, "0")) + ALLTRIM(PADL(DAY(DATETIME()), 2, "0")) + ;
		ALLTRIM(PADL(HOUR(DATETIME()), 2, "0")) + ALLTRIM(PADL(MINUTE(DATETIME()), 2, "0")) + ALLTRIM(PADL(ROUND((((SECONDS() % 3600) % 60) * 1000), 0), 5, "0"))			
RETURN lcFormat
ENDFUNC 


FUNCTION write_log_text
LPARAMETERS _id_text, _Action_text, _severe_text

DO CASE 
	CASE VARTYPE(_severe_text) = "C"
		_severe_text = VAL(_severe_text)

	CASE VARTYPE(_severe_text) = "L"
		_severe_text = 0
	
	CASE VARTYPE(_severe_text) = "N"
		_severe_text = _severe_text 
	
	OTHERWISE 
		_severe_text = 0
ENDCASE 


LOCAL gnLogFile, _logname, _mess
_logname  = "log\" + DTOS(DATE()) + ".txt"
gnLogFile = -1

IF FILE(_logname)
   gnLogFile = FOPEN(_logname, 12)
ELSE

	TRY 	
		MKDIR log
	CATCH
	FINALLY 
	ENDTRY 	

	gnLogFile = FCREATE(_logname)
ENDIF


IF gnLogFile > 0


*2020-01-16
*chris add user code

	LOCAL _tmpcode
	IF VARTYPE(_login_user_code) <> "C"
		_tmpcode = ""
	ELSE 
		_tmpcode = _login_user_code
	ENDIF 

	
	IF VARTYPE(_login_user_name) = "U"
		_mess = '"","' + TTOC(DATETIME()) + '","' + ALLTRIM(__exe_name) + '","' + ALLTRIM(STR(_id_text)) + '","'+ _action_text + '","' + ALLTRIM(STR(_severe_text)) + '"'
	ELSE 
		_mess = '"' + ALLTRIM(ALLTRIM(_tmpcode) + ' ' + ALLTRIM(_login_user_name)) + '","' + TTOC(DATETIME()) + '","' + ALLTRIM(__exe_name) + '","' + ALLTRIM(STR(_id_text)) + '","'+ _action_text + '","' + ALLTRIM(STR(_severe_text)) + '"'
	ENDIF 	
	
	FSEEK( gnLogFile , 0, 2)
	FPUTS( gnLogFile , _mess)
ENDIF

=FCLOSE(gnLogFile)

RETURN 
ENDFUNC

*****************************************************************************************
	* ¨ç¼Æ¦W¡R	GetIniValue																	*
	* ¨ç¼Æ§@¥Î¡R±q POS.INI ¤¤Åª¥X«ü©w¼Æ¾Ú													*
	* °Ñ¼Æ¤À§O¬O¡RcSection, cEntry															*
	*		cSection¡R	­n¬d§äªº¸`¦W¡Q														*
	*		cEntry¡R	­n¬d§äªº¤J¤f														*
	* ªð¦^­È¡R§ä¨ìªº POS.INI ¤¤ªº­È															*
	*																						*
	*****************************************************************************************
FUNCTION GetIniValue
	LPARAMETERS cSection, cEntry
	* cSection¡R ­n¬d§äªº¸`¦W¡QcEntry¡R­n¬d§äªº¤J¤f
	LOCAL cINIFile, cBuffer, cValue
	m.cINIFile = SYS(5)+SYS(2003)+'\POS.INI'
	DECLARE INTEGER GetPrivateProfileString IN Win32API ;
		AS GetPrivateINI STRING,STRING,STRING,STRING,INTEGER,STRING
	m.cBuffer	= SPACE(2000)
	m.nBufSize	= GetPrivateINI(m.cSection,m.cEntry,"",@cBuffer,LEN(m.cBuffer),m.cINIFile)
	m.cValue	= LEFT(m.cBuffer,m.nBufSize)
	RETURN m.cValue
ENDFUNC 

	*****************************************************************************************
	* ¨ç¼Æ¦W¡R	WriteIniValue																*
	* ¨ç¼Æ§@¥Î¡R¦V POS.INI ¤¤¼g¤J«ü©w¼Æ¾Ú													*
	* °Ñ¼Æ¤À§O¬O¡RcSection, cEntry, cValue													*
	*		cSection¡R	­n¼g¤Jªº¸`¦W¡Q														*
	*		cEntry¡R	­n¼g¤Jªº¤J¤f¡Q														*
	*		cValue¡R	­n¼g¤Jªº­È															*
	* ªð¦^­È¡RµL																			*
	*																						*
	*****************************************************************************************
FUNCTION WriteIniValue
	LPARAMETER cSection, cEntry, cValue
	* cSection¡R¸`¦W¡QcEntry¡R¤J¤f¡QcValue¡R­È
	LOCAL cINIFile, cBuffer, cValue
	m.cINIFile = SYS(5)+SYS(2003)+'\POS.INI'
	DECLARE INTEGER WritePrivateProfileString IN Win32API ;
		AS WritePrivateINI STRING,STRING,STRING,STRING
	= WritePrivateINI(m.cSection,m.cEntry,m.cValue,m.cINIFile)
ENDFUNC 

Function URLdecode
PARAMETER pcInStr
*  ' unencode EVERY %XX
*  ' (keep track of current position so you don't unencode
*  '  a percent that just came out of an URLencoded char
LOCAL I, tStr, tChr, tOut
  tStr = pcInStr
  tOut = ""
  tStr = StrTran(tStr, "+", " ")
  I = 1
  do While I <= Len(tStr)
    If (SubStr(tStr, I, 1) = "%") ;
       And SubStr(tStr, I + 1, 1) $ "0123456789ABCDEF" ;
       And SubStr(tStr, I + 2, 1) $ "0123456789ABCDEF" 
      tChr = (( At( SubStr(tStr, I + 1, 1), "0123456789ABCDEF" )-1) * 16 ) ;
           + (( At( SubStr(tStr, I + 2, 1), "0123456789ABCDEF" )-1)      ) 
      I = I + 2
*03/18/03 Zero's are now allowed.      
      if between(tChr,0,255) && 03/18/03
*      if tChr > 0 and tChr < 255
        tOut = tOut + chr( tChr )
      endif
    else
      tOut = tOut + SubStr(tStr, I, 1)
    EndIf
    I = I + 1
  EndDo
RETURN tOut
&&Lihong 2020.07.13 
ENDFUNC 

Function URLencode
  LPARAMETER pcInStr
  *  ' encode Percent signs
  *  '        Double Quotes
  *  '        CarriageReturn / LineFeeds
  
  LOCAL lcOut, lnI
    * StrTran is WAY faster than building the string in memory
    lcOut = StrTran(pcInStr, [%], '%25' )
    lcOut = StrTran(lcOut,   [+], '%2B' )
    lcOut = StrTran(lcOut,   [ ], '+'   )

    lcOut = StrTran(lcOut,   [/], '%2F' ) &&Lihong 2022.04.19
    lcOut = StrTran(lcOut,   [=], '%3D' ) &&Lihong 2022.04.19

    for lnI = 0 to 31
      lcOut = StrTran( lcOut, chr(lnI), '%' + Right( Transform(lnI,'@0'), 2 ) )
    endfor
    for lnI = 127 to 255
      lcOut = StrTran( lcOut, chr(lnI), '%' + Right( Transform(lnI,'@0'), 2 ) )
    endfor

    RETURN lcOut
ENDFUNC   
 
   
    
FUNCTION fget_split_code 
LPARAMETERS ln_pax_type &&to lcSplit_code
*do for form\fget_split_code with lnPay_type to lcSplit_code

USE IN SELECT("popup_func_tmp")
Create Cursor popup_func_tmp (desccn c(30),Descen c(30),pcode c(50),training L)

TEXT TO dbsql NOSHOW TEXTMERGE 
	select isnull(split_pay_code, '') as split_pay_code, desccn, descen from payway where pax_type = ?ln_pax_type and isnull(split_pay_code, '') <> '' order by isnull(split_pay_code, ''), dispord
ENDTEXT 

IF SQLEXEC(nhand, dbsql, "cr_tmp11") < 0 OR RECCOUNT("cr_tmp11") = 0
	RETURN ""
ENDIF 

GO TOP IN "cr_tmp11"
DO WHILE !EOF("cr_tmp11")
	Select popup_func_tmp
	Append Blank
	Replace desccn With ALLTRIM(cr_tmp11.desccn), Descen WITH ALLTRIM(cr_tmp11.descen), pcode With ALLTRIM(cr_tmp11.split_pay_code)
	SKIP IN "cr_tmp11"
ENDDO 

cfunction=""

*!*	LOCAL lcIni_name, lcCode, i, lcName

*!*	lcIni_name = SYS(5)+SYS(2003)+"\bank_machine_trade_code.ini"
*!*	IF !file(lcIni_name) OR VARTYPE(ln_payway_id)#"N" OR ln_payway_id <= 1
*!*		RETURN ""
*!*	ENDIF 

*!*	cfunction=""
*!*	lcCode = ReadINI(lcIni_name, "mode_" + ALLTRIM(STR(ln_payway_id)), "list_code1")
*!*	IF !EMPTY(lcCode)
*!*		USE IN SELECT("popup_func_tmp")
*!*		Create Cursor popup_func_tmp (desccn c(30),Descen c(30),pcode c(10),training L)
*!*		FOR i = 1 TO 100
*!*			lcCode = ALLTRIM(ReadINI(lcIni_name, "mode_" + ALLTRIM(STR(ln_payway_id)), "list_code" + ALLTRIM(STR(i))))
*!*			IF !EMPTY(lcCode)
*!*				lcName = ALLTRIM(ReadINI(lcIni_name, "mode_" + ALLTRIM(STR(ln_payway_id)), "list_name" + ALLTRIM(STR(i))))
*!*				Select popup_func_tmp
*!*				Append Blank
*!*				Replace desccn With lcName, Descen WITH lcName, pcode  With  lcCode
*!*			ENDIF
*!*		ENDFOR
*!*	ELSE
*!*		RETURN ""
*!*	ENDIF 

*
*!*	Select popup_func_tmp
*!*	DO WHILE RECCOUNT("popup_func_tmp")<30
*!*	APPEND FROM DBF("popup_func_tmp")
*!*	ENDDO  
*

nLeft=-1
nTop=-1
ctitle = getmessage("_select_customer_payment") &&½Ð¿ï¾Ü·í«e«È¤á¥I´Ú¤è¦¡ Please select the customer payment method

Do Form Form\work_popup_function With cfunction,nLeft,nTop,ctitle, .T.
USE IN SELECT("popup_func_tmp")

RETURN ALLTRIM(cfunction)
ENDFUNC 

&&Lihong 20201.02.01 ¤À¯Å­p®É»ù
FUNCTION check_timer_level_price
	LPARAMETERS ltsit_time, _end_time
	IF VARTYPE(ltsit_time)#"T"
		RETURN 
	ENDIF 
	LOCAL lnprice0, lntimer_min, lntimer_by,ltsdatetime,lntimer,i,lctimer_level,lntimer_level,lnprice
	SELECT order_itemlist_tmp
	*item_id > 0 And sitem_sub=.F.¤£»Ý­n ¡FAND (price>0 OR level_disc=.T.)
	SCAN FOR item_id > 0 And sitem_sub=.F. AND level_mainid=0 AND pointed=.F. &&level_disc=.F.  A+B¥uA 
		Seek order_itemlist_tmp.item_id IN work_order_tmp
		*If !Found("work_order_tmp") OR NVL(work_order_tmp.timer_item, .F.)=.F. &&OR ¦³coupon
		If Found("work_order_tmp") 
			IF NVL(work_order_tmp.timer_item, .F.)=.F. &&OR ¦³coupon
				LOOP 
			ELSE
				_work_order_tmp_name = "work_order_tmp"
			ENDIF 
		ELSE
			SELECT work_order_tmp0
			LOCATE FOR id=order_itemlist_tmp.item_id
			SELECT order_itemlist_tmp
			IF !Found("work_order_tmp0") OR NVL(work_order_tmp0.timer_item, .F.)=.F. 
				LOOP
			ELSE
				_work_order_tmp_name = "work_order_tmp0"
			ENDIF 
		ENDIF 

		&&¤£»Ý­n¦]¥u¹ï°ó®y¦ÓÂ§¨é¥u¹ïfastfood
*!*			SELECT item_disc_tmp
*!*			LOCATE FOR item_id=order_itemlist_tmp.uid AND disc_id=-8 &&AND disc_type=3  
*!*			IF FOUND()
*!*				lcmsg = GetMessage("_timer_item_used_coupon") &&­p®Éµæ¦¡¨Ï¥Î¤FÂ§¨é¡A½Ð¥ý§R°£Â§¨é¡A§_«h¤£·|°õ¦æ­p®É»ù®æ This timer item used coupon,Please delete coupon,Otherwise not apply the timer price
*!*				lcmsg2 = GetMessage("_item_code")
*!*				fmessagebox(lcmsg + CHR(13) + lcmsg2 + " : "+ TRIM(order_itemlist_tmp.code)) 
*!*				RETURN 
*!*			ENDIF 
		SELECT order_itemlist_tmp
 		
		lnprice0 = NVL(&_work_order_tmp_name..price0,0) &&timer_min¥[»ù
		lntimer_min = NVL(&_work_order_tmp_name..timer_min,0) &&¬qªø
		lntimer_by =  NVL(&_work_order_tmp_name..timer_by,0) &&0 «ö¤J®y®É¶¡¶}©l­pºâ,  1 «öµæ¦¡¥[¤Jªº®É¶¡¶}©l­pºâ
		IF lntimer_min <= 0
			LOOP
		ENDIF 
		ltsdatetime = IIF(lntimer_by=0, ltsit_time, order_itemlist_tmp.ordertime) &&IIF(order_itemlist_tmp.ordertime=CTOT("1900-01-01 00:00:00"), _end_time, order_itemlist_tmp.ordertime)
		lntimer = _end_time - ltsdatetime &&¬O§_«Ê³»¨ì¤ñ¦p1¤Ñ?
		IF lntimer < 0
			LOOP
		ENDIF 
		lntimer = CEILING(INT(lntimer / 60) / lntimer_min) 
		IF lntimer = 0
			lntimer = 1
		ENDIF 
		lnprice = 0.00
		FOR i=1 TO lntimer
			IF i<=10
				lctimer_level = "timer_level_" + ALLTRIM(TRANSFORM(i))
				lntimer_level = &_work_order_tmp_name..&lctimer_level
				lntimer_level = NVL(lntimer_level,0)
				lnprice = IIF(lntimer_level<>0, lntimer_level, lnprice + lnprice0)
			ELSE
				lnprice = lnprice + lnprice0 * (lntimer - 10)
				EXIT 
			ENDIF 
		ENDFOR 
		IF lnprice>0 AND lnprice<>order_itemlist_tmp.price
			SELECT order_itemlist_tmp
			REPLACE price WITH lnprice IN "order_itemlist_tmp"
			SELECT order_itemlist_tmp
		ENDIF 
	ENDSCAN 
ENDFUNC 

&&Lihong 2021.10.18 ¹q¤l¼ÐÃ± 
FUNCTION exec_api_esl
LPARAMETERS lccmd, lctableno, lcesl_id, lcuuid, lceslAP

IF VARTYPE(lcuuid) # "C"
	lcuuid = ""
ENDIF 
IF VARTYPE(lceslAP) # "C"
	lceslAP = ""
ENDIF 

IF TYPE("oCMapi") != "O"
	SET CLASSLIB TO class\invoice_base ADDITIVE 
	PUBLIC oCMapi
	oCMapi = CREATEOBJECT("cloud_member_api")
ENDIF 

oCMapi.clear_info()
oCMapi.api_name = "setup_po_data/" + lccmd 

*!*	DO CASE 
*!*	CASE lccmd == "Update_esl"
	oCMapi.api_remark = "setup_esl_data:" + lccmd &&¤é»x¥Î
	oCMapi.set_value("table_no", lctableno)
	oCMapi.set_value("esl_id", lcesl_id)
	oCMapi.set_value("tables_qrcode_info_id", lcuuid)
	oCMapi.set_value("esl_ap_sn", lceslAP)
	
*!*	ENDCASE 

oCMapi.api_run("esl")
IF oCMapi.status <> 1 && + getmessage("_get_cust_info_error") + CHR(13)
*!*		IF oCMapi.status = 0 AND (LEFT(oCMapi.error_message, 14) == "Api Timeout! ["  OR LEFT(oCMapi.error_message, 19)  == "Api Error No Length") 
*!*			thisform.lbinfo.Caption = "ºôµ¸¿ù»~, ½Ðµy«J¦A¸Õ : " + oCMapi.error_message
*!*			*messagebox(this.error_message)
*!*			fmessagebox("ºôµ¸¿ù»~, ½Ðµy«J¦A¸Õ : " + CHR(13) + oCMapi.error_message) &&getmessage("_require_member_no") + CHR(13) + 
*!*		ELSE
*!*			thisform.lbinfo.Caption = "¿ù»~ : " + oCMapi.error_message &&¤ªºÝ¿ù»~
*!*			fmessagebox("¿ù»~ : " + CHR(13) + oCMapi.error_message) &&getmessage("_require_member_no") + CHR(13) + 
*!*		ENDIF 
	RETURN .F.
ENDIF 
ENDFUNC 

FUNCTION update_esl
LPARAMETERS lctableno, recheck_valid, llbarcode_mode
IF __barcode_mode_enabled or (VARTYPE(__barcode_fastfood_mode)#"U" and __barcode_fastfood_mode)	&&±ø½X¼Ò¦¡
	RETURN 
ENDIF 

LOCAL llfail, dbsql, lccheck_valid
TEXT TO dbsql NOSHOW TEXTMERGE 
	select id from tables_qrcode_info with (nolock) where ISNULL(active, 0)=1 AND ISNULL(suspend, 0)=0 
	AND tableno=?lctableno AND ISNULL(bind_esl, 0)=1
	SELECT status,order_id,ppl,nshare_order,inv_id FROM tables with (nolock) where tableno=?lcTableno and nsubtable=0 
ENDTEXT 
IF SQLEXEC(nhand, dbsql, "tables_qrcode_elsid_tmp") < 0 
	AERROR(err)
	*=SQLROLLBACK(nhand) 
	*=SQLSETPROP(nhand,"Transactions",1)				
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),&__program, LINENO(1))
	RETURN 
ENDIF 
IF RECCOUNT("tables_qrcode_elsid_tmp") = 0 OR recheck_valid = .T. AND !llbarcode_mode AND RECCOUNT("tables_qrcode_elsid_tmp1") > 0 ;
AND !EMPTY(tables_qrcode_elsid_tmp1.status) AND !(VARTYPE(__table_add_cleaning)#"U" AND __table_add_cleaning AND TRIM(tables_qrcode_elsid_tmp1.status)='C') 
	RETURN 
ENDIF 
IF recheck_valid = .T.
	SCAN 
		IF RECNO("tables_qrcode_elsid_tmp") > 1
			WAIT WINDOW TRANSFORM(RECNO("tables_qrcode_elsid_tmp")) +" / "+ TRANSFORM(RECCOUNT("tables_qrcode_elsid_tmp")) + " Refresh check valid" timeout(RAND()/10) 
		ENDIF 
		lccheck_valid = SUBSTR(SYS(2015), 2) 
		IF SQLEXEC(nhand, "update tables_qrcode_info set check_valid=?lccheck_valid where id=?tables_qrcode_elsid_tmp.id") < 0 
			AERROR(err)
			*=SQLROLLBACK(nhand) 
			*=SQLSETPROP(nhand,"Transactions",1)				
			error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),&__program, LINENO(1))
		ENDIF
	ENDSCAN 
ENDIF 
USE IN SELECT("tables_qrcode_elsid_tmp")
USE IN SELECT("tables_qrcode_elsid_tmp1")

IF exec_api_esl("Update_esl", ALLTRIM(lctableno), "") = .F.
	IF oCMapi.status = 0 AND (LEFT(oCMapi.error_message, 14) == "Api Timeout! ["  OR LEFT(oCMapi.error_message, 19)  == "Api Error No Length") 
		*thisform.lbinfo.Caption = "ºôµ¸¿ù»~, ½Ðµy«J¦A¸Õ : " + oCMapi.error_message
		&&fmessagebox("ºôµ¸¿ù»~, ½Ðµy«J¦A¸Õ : " + CHR(13) + oCMapi.error_message) 
		*lcmsg = "ºôµ¸¿ù»~, ½Ðµy«J¦A¸Õ : " + oCMapi.error_message
	ELSE
		*thisform.lbinfo.Caption = "¿ù»~ : " + oCMapi.error_message &&¤ªºÝ¿ù»~
		&&fmessagebox("¿ù»~ : " + CHR(13) + oCMapi.error_message) 
		*lcmsg = "¿ù»~ : " + oCMapi.error_message
	ENDIF 
*!*		TRY 
*!*			STRTOFILE(lcmsg, "D:\x\eslexec.txt", 1)
*!*		CATCH
*!*		ENDTRY 

	*RETURN .F.
	llfail = .T.
ENDIF 

IF llfail = .F.
	lcok = oCMapi.get_value("result")
	IF !lcok=="1"
		*thisform.lbinfo.Caption = "¿ù»~ : " + "°õ¦æ¿ù"
		&&fmessagebox("°õ¦æ¿ù")  &&getmessage()
		*lcmsg = "¿ù»~ : " + "°õ¦æ¿ù"
*!*			TRY 
*!*				STRTOFILE(lcmsg, "D:\x\eslexec.txt", 1)
*!*			CATCH
*!*			ENDTRY 
		*RETURN .F.
	ENDIF 
ENDIF 

IF llfail = .F. AND lcok=="1"
	TEXT TO dbsql NOSHOW TEXTMERGE 
		DELETE esl_tables_wait_for_update where table_no = ?lctableno 
	ENDTEXT 
ELSE 
	TEXT TO dbsql NOSHOW TEXTMERGE 
		DECLARE @id int 
		SET @id = (select ISNULL(MAX(id), 0)+1 from esl_tables_wait_for_update )
		DELETE esl_tables_wait_for_update where table_no = ?lctableno 
		INSERT INTO esl_tables_wait_for_update (id, table_no, add_time) VALUES (@id, ?lctableno, getdate()) 
	ENDTEXT 
ENDIF 

IF SQLEXEC(nhand, dbsql) < 0 
	AERROR(err)
	*=SQLROLLBACK(nhand) 
	*=SQLSETPROP(nhand,"Transactions",1)				
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),&__program, LINENO(1))
ENDIF 

ENDFUNC 

&&Lihong 2021.11.24 cut order
FUNCTION calc_cut_order
LPARAMETERS lnppl, calc_cut_order_min, calc_sit_in_min, RemainingQty

lnppl = IIF(lnppl = 0, 1, lnppl)

LOCAL _curdatetime, _curtime, _curweekday, _day, _belongdate, _isholiday, csql 

_curdatetime=Datetime()								&&¨ú·í«e®É¶¡
_curtime=Time()
_curweekday=Dow(_curdatetime)
_curweekday=Iif(_curweekday=1,7,_curweekday-1)		&&Âà¬°"¤¤°ê¦¡"ªº¬P´Á­pºâ¤èªk,©P¤@¬°²Ä¤@¤Ñ)
_day="day"+Alltrim(Str(_curweekday))

_belongdate=getbelongdate()			&&¨ú·í«eªºbelongdate
Select Id From work_order_tmp14 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s

_isholiday=(_Tally>0)

&&Lihong 2022.05.06 festival 
*Select Id From work_order_tmp24 Where begdate<=_belongdate And enddate>=_belongdate Into Array tmp_s
Select Id From work_order_tmp24 Where CTOT(STUFF(TTOC(begdate),12,5,date_start_time))<=_curdatetime And CTOT(STUFF(TTOC(enddate),12,5,date_end_time))>=_curdatetime ;
AND ((_curtime>=start_time And _curtime<=end_time) Or (start_time>end_time And (_curtime>=start_time Or  _curtime<=end_time))) Into Array tmp_s
_isfestival=(_Tally>0)

&& update 2011.11.23  add day1--day7 ,holiday.
*!*		SELECT *,000 as disp_page FROM work_order_tmp1 WHERE (_sid$active_section AND _outlet$","+active_outlet+","  AND _station$","+active_station AND;
*!*		 ( (&_day AND !_isholiday) Or (_isholiday AND (&_day OR holiday)  And !ex_holiday)) AND  date()>=startdate  AND DATE()<=enddate ) OR blank=.t.  ;
*!*			ORDER BY dispord INTO CURSOR order_cate_tmp READWRITE 
 TEXT TO csql TEXTMERGE NOSHOW 
		SELECT * FROM item_cut_order WITH (nolock) WHERE (<<_day>>=1 AND ?_isholiday=0 AND ?_isfestival=0 Or ?_isholiday=1 AND (<<_day>>=1 OR holiday=1)  And ISNULL(ex_holiday,0)=0 AND (?_isfestival=0 OR ISNULL(ex_festival,0)=0)
		Or ?_isfestival=1 AND (<<_day>>=1 OR ISNULL(festival,0)=1)  And ISNULL(ex_festival,0)=0 AND (?_isholiday=0 OR ISNULL(ex_holiday,0)=0) ) AND  getdate()>=start_date  AND getDATE()<=end_date and suspend=0 

ENDTEXT 
If SQLExec(nhand,csql,"cut_order_tmp")<0
	Aerror(err)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return .F.
ENDIF
IF EOF("cut_order_tmp")
	RETURN 
ENDIF 
REPLACE ALL calc_mode WITH 0 FOR ISNULL(calc_mode) 

SELECT a.* FROM cut_order_tmp a LEFT JOIN (SELECT item_id, MAX(sub_id) as sub_id FROM cut_order_tmp GROUP BY item_id ) b ON a.item_id=b.item_id AND a.sub_id=b.sub_id ;
WHERE !ISNULL(b.item_id) INTO CURSOR cut_order_tmp 

*¤l¶µ¡H
*0´¶³q­p®É ¦h­Óµæªº³Ì¤jªÌ
SELECT MAX(b.cut_order_min) as cut_order_min, MAX(b.sit_in_min) as sit_in_min FROM order_itemlist_tmp a LEFT JOIN cut_order_tmp b ON a.item_id=b.item_id AND b.calc_mode=0 ;
WHERE a.item_id>0 AND !ISNULL(b.item_id) INTO CURSOR cut_order_time0

*1³æ¶µ¥[ÄÁ ¦h­Óµæsum
SELECT sum(a.qty*b.cut_order_min) as cut_order_min, sum(a.qty*b.sit_in_min) as sit_in_min FROM order_itemlist_tmp a LEFT JOIN cut_order_tmp b ON a.item_id=b.item_id AND b.calc_mode=1 ;
WHERE a.item_id>0 AND !ISNULL(b.item_id) INTO CURSOR cut_order_time1

*2»P¤H¼Æ¬ÛÃöªº¥[ÄÁ &&b.cut_order_min as sum_cut_order_min, b.sit_in_min as sum_sit_in_min 
SELECT a.item_id, a.qty, b.cut_order_min, b.sit_in_min FROM (SELECT item_id, sum(qty) as qty FROM order_itemlist_tmp GROUP BY item_id ) a ;
LEFT JOIN cut_order_tmp b ON a.item_id=b.item_id AND b.calc_mode=2 ;
WHERE a.item_id>0 AND !ISNULL(b.item_id) INTO CURSOR order_itemlist_qty READWRITE 

USE IN SELECT("cut_order_tmp")
*!*	UPDATE order_itemlist_qty SET sum_cut_order_min = 0, sum_sit_in_min = 0
*!*	UPDATE order_itemlist_qty SET qty = qty - int(qty / lnppl) * lnppl, sum_cut_order_min = sum_cut_order_min + int(qty / lnppl) * cut_order_min, sum_sit_in_min = sum_sit_in_min + int(qty / lnppl) * sit_in_min ;
*!*	WHERE qty < lnppl
*!*	SELECT item_id, sum(sum_cut_order_min) as cut_order_min, sum(sum_sit_in_min) as sit_in_min FROM order_itemlist_qty GROUP BY item_id INTO CURSOR cut_order_time2

	sum_cut_order_min3 = 0
	sum_sit_in_min3 = 0
	SELECT * FROM order_itemlist_qty WHERE qty > 0 ORDER BY cut_order_min desc INTO CURSOR order_itemlist_qty0 READWRITE 
	lnpplQty = lnppl
	SCAN 
		DO WHILE order_itemlist_qty0.qty > 0
			lnmatchQty = MIN(lnpplQty, order_itemlist_qty0.qty)
			REPLACE qty WITH qty - lnmatchQty IN order_itemlist_qty0
			lnpplQty = lnpplQty - lnmatchQty
			IF lnpplQty = 0
				sum_cut_order_min3 = sum_cut_order_min3 + order_itemlist_qty0.cut_order_min 
				lnpplQty = lnppl
				LOOP 
			ENDIF 
		ENDDO 
	ENDSCAN 
	SELECT * FROM order_itemlist_qty WHERE qty > 0 ORDER BY sit_in_min desc INTO CURSOR order_itemlist_qty0 READWRITE 
	lnpplQty = lnppl
	SCAN 
		DO WHILE order_itemlist_qty0.qty > 0
			lnmatchQty = MIN(lnpplQty, order_itemlist_qty0.qty)
			REPLACE qty WITH qty - lnmatchQty IN order_itemlist_qty0
			lnpplQty = lnpplQty - lnmatchQty
			IF lnpplQty = 0
				sum_sit_in_min3 = sum_sit_in_min3 + order_itemlist_qty0.sit_in_min 
				lnpplQty = lnppl
				LOOP 
			ENDIF 
		ENDDO 
	ENDSCAN 
	RemainingQty = IIF(lnpplQty = lnppl, 0 , lnppl - lnpplQty)
	
	USE IN SELECT("order_itemlist_qty")
	USE IN SELECT("order_itemlist_qty0")
	calc_cut_order_min = NVL(cut_order_time0.cut_order_min, 0) + NVL(cut_order_time1.cut_order_min, 0) + sum_cut_order_min3 && + cut_order_time2.cut_order_min
	IF !ISNULL(cut_order_time0.sit_in_min) and NVL(cut_order_time0.sit_in_min, 0)=0
		calc_sit_in_min = 0
	ELSE 
		calc_sit_in_min = NVL(cut_order_time0.sit_in_min, 0) + NVL(cut_order_time1.sit_in_min, 0) + sum_sit_in_min3 && + cut_order_time2.sit_in_min
		IF calc_sit_in_min<calc_cut_order_min 
			calc_sit_in_min = calc_cut_order_min 
		ENDIF 
	ENDIF 
	USE IN SELECT("cut_order_time0")
	USE IN SELECT("cut_order_time1")
	
ENDFUNC 

&&Lihong 2022.02.25 clean_report©î¥X¨Ó
FUNCTION clean_report_extend
LOCAL ssql_2
Do Case

	Case _clean_reprint			&&­«¦L²M¾÷³æ

		&&Lihong 2022.02.25
		reprint_cln_Id_filter = "=?_clnID"
		IF LOWER(__special_customer)=="ms" AND VARTYPE(_MS_reprint_report_cln_Id)#"U" AND !EMPTY(_MS_reprint_report_cln_Id)
			 reprint_cln_Id_filter = " in (" + _MS_reprint_report_cln_Id + ")"
		ENDIF

		&&Lihong 2022.07.27 
		cln_diff_cond=""
		cln_diff_and_diff=""
		IF VARTYPE(_clean_report_cln_append)#"U" AND !empty(_clean_report_cln_append)
			cln_diff_cond="id in (select id from "+_clean_report_cln_append+")"
			cln_diff_and_diff=" or "
			cln_diff_cond_leftjoin = "aa.id in (select bb.id from "+_clean_report_cln_append+" bb)"
		ENDIF 
		IF VARTYPE(_clean_report_cln_remove)#"U" AND !empty(_clean_report_cln_remove)
			cln_diff_cond="id not in (select id from "+_clean_report_cln_remove+")"
			cln_diff_and_diff=" and "
			cln_diff_cond_leftjoin = "aa.id not in (select bb.id from "+_clean_report_cln_remove+" bb)"
		ENDIF 
		
		*³¡ªù¤ÀªR load_itemdept()°Ñ¼Æ 2022-10-09 by sam 
		lcitemdept_cond = " and a.id in (select aa.id from "+view_inv+" aa where aa.void=0 and "+IIF(EMPTY(cln_diff_cond), "aa.cln"+reprint_cln_Id_filter, "(aa.cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond_leftjoin+")")+" )"
		lctblsrc = 1 
		*lcitemdept_cond = " and a.id in (select aa.id from "+view_inv+" aa where aa.void=0 and 1=1 and aa.cln " + reprint_cln_Id_filter + " and aa.belongdate = '2022-09-22')"
		
				
		&&Lihong 2022.05.10 left join sys_user
		ssql="select inv.*,sys_user.name as pay_cashier_user,"+;
			"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
			"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate ,inv.tableno "+;
			" from "+ view_inv +" inv left join "+view_inv_pay+" pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where "+;
			IIF(EMPTY(cln_diff_cond), "inv.cln"+reprint_cln_Id_filter, "(inv.cln"+reprint_cln_Id_filter+cln_diff_and_diff+"inv."+cln_diff_cond+")")+" and void=0 order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b) inv.cln"+reprint_cln_Id_filter

		ssql=ssql+Chr(10)+"select inv.id,inv.invamt,void_reason.desccn,void_reason.descen from "+view_inv+"  inv left join void_reason on inv.voidreason=void_reason.id"+;
			" where  "+IIF(EMPTY(cln_diff_cond), "inv.cln"+reprint_cln_Id_filter, "(inv.cln"+reprint_cln_Id_filter+cln_diff_and_diff+"inv."+cln_diff_cond+")")+" and inv.void=1 order by inv.id"		&&¨ú®øµo²¼(µ²±b«á¨ú®ø) inv.cln"+reprint_cln_Id_filter

		ssql=ssql+Chr(10)+"select * from payway"
		ssql=ssql+Chr(10)+"select order_void.*,void_reason.desccn,void_reason.descen from order_void left join void_reason on order_void.void_reason=void_reason.id"+;
			" where order_void.cln"+reprint_cln_Id_filter+" order by void_time"								&&¨ú®øµæ¦¡

		ssql=ssql+Chr(10)+"select * from "+view_inv_disc+ " where id in (select id from "+view_inv+"  where  void=0 and "+IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" )"		&&¾ã³æ§é¦© cln"+reprint_cln_Id_filter

		ssql=ssql+Chr(10)+"select * from "+view_inv_itemdisc+" where id in (select id from " + view_inv +" where void=0 and "+IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" )"		&&¶µ¥Ø§é¦© cln"+reprint_cln_Id_filter

		ssql=ssql+Chr(10)+"select id,disc_type,desccn,descen from disc"				&&cun_tmp6  ----discount

		ssql=ssql+Chr(10)+"select id,desccn,descen,srv_to_dept from department order by disporder" && modify by sam 2022-10-08 Iif(_system_langue="cn","desccn","descen")			&&cun_tmp7  ----department

		ssql=ssql+Chr(10)+"select a.id,a.uid,a.parent_id,a.item_id,a.qty,a.orgamt,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.xdisc,a.tax2,a.tax_amount,a.askdept,a.item_code,a.cate_id,b.desccn,b.descen  "+;
			"from "+view_inv_detail +" a  left join cate b on a.cate_id=b.id where a.id in (select id from "+view_inv+"  where void=0 and "+IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" )"		
			&&cun_tm8 ----inv_detail cln"+reprint_cln_Id_filter

	*	ssql=ssql+Chr(10)+"select id,uid,parent_id,item_id,qty,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_amount,xdisc,tax2,tax_amount,askdept,item_code "+;
	*		"from "+view_inv_detail +" where id in (select id from "+view_inv+"  where void=0 and cln=?_clnID)"		&&cun_tm8 ----inv_detail

		ssql=ssql+Chr(10)+"select * from itemdept"					&&cun_tmp9	----item-->dept
		ssql=ssql+Chr(10)+"select * from outlet"					&&cun_tmp10 --outlet
		
		&&Lihong 2022.05.10 left join sys_user 
		ssql=ssql+Chr(10)+"select inv.*,sys_user.name as pay_cashier_user from "+view_inv+" inv left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where  inv.void=0 and "+;
		IIF(EMPTY(cln_diff_cond), "inv.cln"+reprint_cln_Id_filter, "(inv.cln"+reprint_cln_Id_filter+cln_diff_and_diff+"inv."+cln_diff_cond+")")+" order by inv.id"	&&cun_tmp11 inv (¥¿±`µ²±b) inv.cln"+reprint_cln_Id_filter

		ssql=ssql+Chr(10)+"select id,desccn,descen,code from item where dayend=1 and active=1 or id=-5"				&&cun_tmp12 item(¤éµ²®É¤ÀªR)

&&¤K¹F³q(void ³æ)	cun_tmp13
		&&Lihong 2022.02.25 MS¼W¥[cln
		ssql=ssql+Chr(10)+"select inv.id,inv.cln,inv.pplcnt,inv.orgamt,inv.invamt,inv.discamt,inv.modiamt,inv.rndamt,inv.srvamt,inv.taxamt,inv.fastfood,inv.outlet_id,inv.adduser,inv.pay_cashier_user_id,sys_user.name as pay_cashier_user,pay_detail.qty as pay_qty,"+;
			"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate"+;
			" from "+view_inv+" inv left join "+view_inv_pay+"  pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where "+;
			IIF(EMPTY(cln_diff_cond), "inv.cln"+reprint_cln_Id_filter, "(inv.cln"+reprint_cln_Id_filter+cln_diff_and_diff+"inv."+cln_diff_cond+")")+" and void=1 and octopus=1 order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b) inv.cln"+reprint_cln_Id_filter


		ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen,c.desccn as cpayway from expense a left join expense_main b "+;
			"on a.exp_id=b.id  left join expense_payway c on a.payway=c.id  where a.cln_id"+reprint_cln_Id_filter+"   order by a.id"		&&cun_tmp14  ¶}¤ä¤ÀªR

		Local _date1,_date2
		_date1 =Dtot(sdate)
		_date2 =Dtot(edate +1)

*				ssql=ssql+Chr(10)+"select * from sys_log where log_Id=95 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp15   §ó§ï»ù®æ°O¿ý
		ssql=ssql+Chr(10)+"select * from change_price where belongdate between ?_date1 and ?edate" 

		ssql=ssql+Chr(10)+"select * from sys_log where log_Id=182 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp16   §ó§ïµo²¼°O¿ý 

		ssql=ssql+Chr(10)+"select * from inv_itemdept where id in (select id from "+view_inv+" where void=0 and "+IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" )"		&&cun_tmp17		itemDept cln"+reprint_cln_Id_filter

		ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen from inv_tax a left join tax b on a.tax_id=b.id where a.id in (select id from "+view_inv+" where  void=0 and "+IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" )"		
		&&cun_tmp18  ----TAX cln"+reprint_cln_Id_filter

		&&Lihong 2021.04.23 ¦L³æ«á§é¦© §ï¬°«öafter_inv ssql=ssql+Chr(10)+"select * from disc_log where inv_no>0 and void=0 and inv_no  in (select id from "+view_inv+" where   void=0 and cln=?_clnID and (discamt<>0 or itemdiscamt<>0)  )"		&&cun_tmp19  ----¦L³æ«á§é¦©
		ssql=ssql+Chr(10)+"select id as inv_no, adduser, disc_amount from inv_itemdisc_view where after_inv=1 and id in (select id from "+view_inv+" where   void=0 and "+;
		IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" and (discamt<>0 or itemdiscamt<>0)  )"		&&cun_tmp19  ----¦L³æ«á§é¦© cln"+reprint_cln_Id_filter
		ssql=ssql+Chr(10)+"union all select id as inv_no, adduser, disc_amount from inv_disc_view where after_inv=1 and id in (select id from "+view_inv+" where   void=0 and "+;
		IIF(EMPTY(cln_diff_cond), "cln"+reprint_cln_Id_filter, "(cln"+reprint_cln_Id_filter+cln_diff_and_diff+cln_diff_cond+")")+" and (discamt<>0 or itemdiscamt<>0)  )"		&&cun_tmp19  ----¦L³æ«á§é¦© cln"+reprint_cln_Id_filter
		
		ssql = ssql +Chr(10) + "select a.*,b.desccn,b.descen from item_move a left join item b on a.item_id=b.id  where a.cln"+reprint_cln_Id_filter+" order by a.datetime"		&& cun_tmp20  ¦L³æ«áÂà»O

		ssql =ssql +Chr(10) + "select * from less_cash where cln"+reprint_cln_Id_filter		&&cun_tmp21  ¤Ö¦¬²{ª÷
		
		&&Lihong 2021.12.15 
		IF _Memb_Record
			TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW  &&cun_tmp22  ·|­û®ø¶O

				select c.cardno, c.name_cn, c.name_en, c.tel, SUM(b.invamt) as invamt, SUM(b.invamt - a.recharge_amount) as invamt_noRecharge, SUM(a.recharge_amount) as recharge_amount, 
				SUM(1) as invcnt, SUM(case when a.recharge_amount>0 and a.recharge_uid=a.all_uid then 0 else 1 end) as invcnt_noRecharge, SUM(case when a.recharge_amount>0 then 1 else 0 end) as recharge_count  
				from (SELECT inv.id, SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then d.real_amount+d.round_amount+d.xdisc else 0.00 end) as recharge_amount, 
							SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then 1 else 0 end) as recharge_uid, 
							COUNT(uid) as all_uid 
					from inv_detail_view d 
					left join inv_view inv on d.id=inv.id 
					where <<IIF(EMPTY(cln_diff_cond), "inv.cln"+reprint_cln_Id_filter, "(inv.cln"+reprint_cln_Id_filter+cln_diff_and_diff+"inv."+cln_diff_cond+")")>> and ISNULL(inv.memberno,0)>0 and inv.void=0 and d.sitem_sub=0 
					group by inv.id
					) a left join inv_view b on a.id=b.id left join member c with (nolock) on b.memberno=c.id
				group by b.memberno, c.cardno, c.name_cn, c.name_en, c.tel 
				order by c.cardno 
			ENDTEXT &&YEAR(inv.paidtime)>2000 and  &&inv.cln<<reprint_cln_Id_filter>>
		ENDIF 
		
		&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ &&cun_tmp23 
		IF VARTYPE(__deposit_once)#"U" and __deposit_once
			ssql_2 = "select inv.*,sys_user.name as pay_cashier_user,"+;
				"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
				"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate ,cast(ltrim(str(inv.id)) as varchar(20)) as tableno "+;
				" from deposit inv with (nolock) left join deposit_pay_detail pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where "+;
				IIF(.T., "inv.cln"+reprint_cln_Id_filter, "(inv.cln"+reprint_cln_Id_filter+cln_diff_and_diff+"inv."+cln_diff_cond+")")+" and ISNULL(inv.void,0)=0 order by inv.id"						&&deposit²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b) inv.cln"+reprint_cln_Id_filter

			
		ENDIF &&IIF(EMPTY(cln_diff_cond) -> IIF(.T.
		
	Case  _dayEnd_report		&&¤éµ²

		Local cond
		cond=""

		If _outlet_id<>-1
			cond=" and inv.outlet_id=?_outlet_id "
		Endif
		
		*³¡ªù¤ÀªR load_itemdept()°Ñ¼Æ 2022-10-09 by sam 
		lcitemdept_cond = " and year(inv.paidtime)>2000 and inv.belongdate>=?_begdate and belongdate<=?_enddate " + cond
		lctblsrc = 1 

		_computer=getcomputername()

		&&Lihong 2022.05.10 left join sys_user
		ssql="select inv.*,sys_user.name as pay_cashier_user,"+;
			"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
			"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,inv.tableno "+;
			" from "+ view_inv+" inv  left join  "+view_inv_pay+" pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.void=0 and "+;
			"inv.belongdate>=?_begdate and inv.belongdate<=?_enddate "+ cond +"   order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b) 

		ssql=ssql+Chr(10)+"select inv.id,inv.invamt,void_reason.desccn,void_reason.descen from "+view_inv+" inv left join void_reason on inv.voidreason=void_reason.id"+;
			" where  inv.belongdate>=?_begdate and inv.belongdate<=?_enddate and inv.void=1 "+cond		&&¨ú®øµo²¼(µ²±b«á¨ú®ø)

		ssql=ssql+Chr(10)+"select * from payway"
		ssql=ssql+Chr(10)+"select order_void.*,void_reason.desccn,void_reason.descen from order_void left join void_reason on order_void.void_reason=void_reason.id"+;
			" where order_void.belongdate>=?_begdate and order_void.belongdate<=?_enddate order by void_time"								&&¨ú®øµæ¦¡

		ssql=ssql+Chr(10)+"select * from "+view_inv_disc +" where id in (select id from "+view_inv +" inv where year(inv.paidtime)>2000 and void=0 and belongdate>=?_begdate and belongdate<=?_enddate "+ cond+" )"		&&¾ã³æ§é¦©

		ssql=ssql+Chr(10)+"select * from "+view_inv_itemdisc+"  where id in (select id from "+view_inv+"  inv where year(inv.paidtime)>2000 and belongdate>=?_begdate and belongdate<=?_enddate and void=0 "+cond+" )"		&&¶µ¥Ø§é¦©

		ssql=ssql+Chr(10)+"select id,disc_type,desccn,descen from disc"				&&cun_tmp6  ----discount
		ssql=ssql+Chr(10)+"select id,desccn,descen,srv_to_dept from department with (nolock) order by disporder " && modify by sam 2022-10-08 	&&cun_tmp7  ----department

		ssql=ssql+Chr(10)+"select a.id,a.uid,a.parent_id,a.item_id,a.qty,a.orgamt,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.xdisc,a.tax2,a.tax_amount,a.askdept,a.item_code,a.cate_id,b.desccn,b.descen  "+;
			"from "+view_inv_detail +" a  left join cate b on a.cate_id=b.id where a.id in (select id from "+view_inv+" inv  where year(inv.paidtime)>2000 and belongdate>=?_begdate and belongdate<=?_enddate and void=0 "+cond+")"		&&cun_tm8 ----inv_detail

		ssql=ssql+Chr(10)+"select * from itemdept"					&&cun_tmp9	----item-->dept
		ssql=ssql+Chr(10)+"select * from outlet"					&&cun_tmp10 --outlet
		
		&&Lihong 2022.05.10 left join sys_user 
		ssql=ssql+Chr(10)+"select inv.*,sys_user.name as pay_cashier_user from "+view_inv+" inv left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where inv.belongdate>=?_begdate and inv.belongdate<=?_enddate and inv.void=0 "+cond+" order by inv.id"	 &&cun_tmp11 inv (¥¿±`µ²±b)

		ssql=ssql+Chr(10)+"select id,desccn,descen,code from item where dayend=1 and active=1 or id=-5"				&&cun_tmp12 item(¤éµ²®É¤ÀªR)

&&¤K¹F³q(void ³æ)		cun_tmp13
		ssql=ssql+Chr(10)+"select inv.id,inv.pplcnt,inv.orgamt,inv.invamt,inv.discamt,inv.modiamt,inv.rndamt,inv.srvamt,inv.taxamt,inv.fastfood,inv.outlet_id,inv.adduser,inv.pay_cashier_user_id,sys_user.name as pay_cashier_user,pay_detail.qty as pay_qty,"+;
			"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate"+;
			" from "+view_inv+" inv  left join "+view_inv_pay+"  pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.void=1 and octopus=1 and belongdate>=?_begdate and belongdate<=?_enddate "+cond &&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)


		ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen,c.desccn as cpayway from expense a left join expense_main b "+;
			"on a.exp_id=b.id  left join expense_payway c on a.payway=c.id  where a.belongdate>=?_begdate and a.belongdate<=?_enddate  order by a.id"		&&cun_tmp14  ¶}¤ä¤ÀªR


		Local _date1,_date2
		_date1 =Dtot(sdate)
		_date2 =Dtot(edate +1)

*		ssql=ssql+Chr(10)+"select * from sys_log where log_Id=95 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp15   §ó§ï»ù®æ°O¿ý
		ssql=ssql+Chr(10)+"select * from change_price where belongdate>=?_date1 and belongdate<=?edate  order by datetime"

		ssql=ssql+Chr(10)+"select * from sys_log where log_Id=182 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp16   §ó§ïµo²¼°O¿ý

		ssql=ssql+Chr(10)+"select * from inv_itemdept where id in (select id from "+view_inv+" inv where year(inv.paidtime)>2000 and void=0 and belongdate>=?_begdate and belongdate<=?_enddate "+cond +" )"	&&cun_tmp17 itemdept


		ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen from inv_tax a left join tax b on a.tax_id=b.id  where a.id in (select id from "+view_inv+" inv  where year(inv.paidtime)>2000 and void=0 and belongdate>=?_begdate and belongdate<=?_enddate "+cond+" )"	&&cun_tmp18  ----TAX

		&&Lihong 2021.04.23 ¦L³æ«á§é¦© §ï¬°«öafter_inv ssql=ssql+Chr(10)+"select * from disc_log where inv_no>0  and void=0 and inv_no in (select id from "+view_inv +" inv  where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and void=0 and belongdate>=?_begdate and belongdate<=?_enddate "+cond+")"	&&cun_tmp19  ¦L³æ«á§é¦©
		ssql=ssql+Chr(10)+"select id as inv_no, adduser, disc_amount from inv_itemdisc_view where after_inv=1 and id in (select id from "+view_inv +" inv  where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and void=0 and belongdate>=?_begdate and belongdate<=?_enddate "+cond+")"		&&cun_tmp19  ----¦L³æ«á§é¦©
		ssql=ssql+Chr(10)+"union all select id as inv_no, adduser, disc_amount from inv_disc_view where after_inv=1 and id in (select id from "+view_inv +" inv  where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and void=0 and belongdate>=?_begdate and belongdate<=?_enddate "+cond+")"		&&cun_tmp19  ----¦L³æ«á§é¦©

		ssql = ssql +Chr(10) + "select a.*,b.desccn,b.descen from item_move a left join item b on a.item_id=b.id where a.belongdate>=?_begdate and a.belongdate<=?_enddate order by a.datetime"		&& cun_tmp20  ¦L³æ«áÂà»O

		ssql =ssql +Chr(10) + "select * from less_cash where belongdate>=?_begdate and belongdate<=?_enddate"		&&cun_tmp21  ¤Ö¦¬²{ª÷

		&&Lihong 2021.12.15 
		IF _Memb_Record
			TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW  &&cun_tmp22  ·|­û®ø¶O

				select c.cardno, c.name_cn, c.name_en, c.tel, SUM(b.invamt) as invamt, SUM(b.invamt - a.recharge_amount) as invamt_noRecharge, SUM(a.recharge_amount) as recharge_amount, 
				SUM(1) as invcnt, SUM(case when a.recharge_amount>0 and a.recharge_uid=a.all_uid then 0 else 1 end) as invcnt_noRecharge, SUM(case when a.recharge_amount>0 then 1 else 0 end) as recharge_count  
				from (SELECT inv.id, SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then d.real_amount+d.round_amount+d.xdisc else 0.00 end) as recharge_amount, 
							SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then 1 else 0 end) as recharge_uid, 
							COUNT(uid) as all_uid 
					from inv_detail_view d 
					left join inv_view inv on d.id=inv.id 
					where ISNULL(inv.memberno,0)>0 and inv.void=0 and YEAR(inv.paidtime)>2000 and belongdate>=?_begdate and belongdate<=?_enddate <<cond>> and d.sitem_sub=0 
					group by inv.id
					) a left join inv_view b on a.id=b.id left join member c with (nolock) on b.memberno=c.id
				group by b.memberno, c.cardno, c.name_cn, c.name_en, c.tel 
				order by c.cardno 
			ENDTEXT 
		ENDIF 

		&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ &&cun_tmp23 
		IF VARTYPE(__deposit_once)#"U" and __deposit_once AND _outlet_id=-1
			ssql_2 = "select inv.*,sys_user.name as pay_cashier_user,"+;
				"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
				"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,cast(ltrim(str(inv.id)) as varchar(20)) as tableno "+;
				" from deposit inv with (nolock) left join deposit_pay_detail pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and ISNULL(inv.void,0)=0 and "+;
				"inv.belongdate>=?_begdate and inv.belongdate<=?_enddate "+ cond +" order by inv.id"						&&deposit²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b) 
		ENDIF 

	Otherwise 					&&²M¾÷

		Do Case

			Case Upper(__checked_method)="USER" OR LOWER(__special_customer)=="ms" &&²M¾÷¤è¦¡,«öuser &&Lihong 2022.02.25 ms

				&&Lihong 2022.05.10 left join sys_user, inv.adduser=?_login_user_name -> (isnull(inv.pay_cashier_user_id, -1) = ?__login_user_id or isnull(inv.pay_cashier_user_id, -1) = -1 and inv.adduser = ?_login_user_name)
				lcadduser_filter = "inv.adduser=?_login_user_name"
				*IF LOWER(__special_customer)=="ms" or Upper(__checked_method)="USER" &&Lihong 2022.05.10 &&Lihong 2023.07.17 or Upper(__checked_method)="USER"
					lcadduser_filter = "(isnull(inv.pay_cashier_user_id, -1) = ?__login_user_id or isnull(inv.pay_cashier_user_id, -1) = -1 and inv.adduser = ?_login_user_name)"
				*ENDIF
				
				*³¡ªù¤ÀªR load_itemdept()°Ñ¼Æ 2022-10-09 by sam &&Lihong 2023.07.17 adduser=?_login_user_name
				lcitemdept_cond = " and year(inv.paidtime)>2000 and cln=0 and "+lcadduser_filter+" " 
				lctblsrc = 2 
				
				ssql="select inv.*, "+; 
				"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
					"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,inv.tableno, sys_user.name as pay_cashier_user "+;
					" from inv with (nolock) left join pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=0 "+;
					" and "+lcadduser_filter+" order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)
					
				ssql=ssql+Chr(10)+"select inv.id,inv.invamt,void_reason.desccn,void_reason.descen from inv with (nolock) left join void_reason with (nolock) on inv.voidreason=void_reason.id where  inv.cln=0 and inv.void=1"+;
					" and "+lcadduser_filter+" order by inv.id"		&&¨ú®øµo²¼(µ²±b«á¨ú®ø)
					
				ssql=ssql+Chr(10)+"select * from payway with (nolock)"
				ssql=ssql+Chr(10)+"select order_void.*,void_reason.desccn,void_reason.descen from order_void with (nolock) left join void_reason with (nolock) on order_void.void_reason=void_reason.id"+;
					" where order_void.cln=0 and order_void.void_time<?_clntime and order_void.void_user=?_login_user_name order by void_time"								&&¨ú®øµæ¦¡
				ssql=ssql+Chr(10)+"select * from inv_disc with (nolock) where id in (select id from inv with (nolock) where year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter+")"		&&¾ã³æ§é¦© &&Lihong 2023.07.17 adduser=?_login_user_name
				ssql=ssql+Chr(10)+"select * from inv_itemdisc with (nolock) where id in (select id from inv with (nolock) where year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter+")"		&&¶µ¥Ø§é¦© &&Lihong 2023.07.17 adduser=?_login_user_name
				ssql=ssql+Chr(10)+"select id,disc_type,desccn,descen from disc with (nolock)"				&&cun_tmp6  ----discount
				ssql=ssql+Chr(10)+"select id,desccn,descen,srv_to_dept from department with (nolock) order by disporder"   && modify by sam 2022-10-08 +Iif(_system_langue="cn","desccn","descen")			&&cun_tmp7  ----department
				
				ssql=ssql+Chr(10)+"select a.id,a.uid,a.parent_id,a.item_id,a.qty,a.orgamt,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.xdisc,a.tax2,a.tax_amount,a.askdept,a.item_code,a.cate_id,b.desccn,b.descen  "+;
					"from inv_detail a with (nolock) left join cate b with (nolock) on a.cate_id=b.id where a.id in (select id from inv with (nolock) where year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter+")"		&&cun_tm8 ----inv_detail 
				&&Lihong 2023.07.17 adduser=?_login_user_name
				
*				ssql=ssql+Chr(10)+"select id,uid,parent_id,item_id,qty,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_amount,xdisc,tax2,tax_amount,askdept,item_code  "+;
*					"from inv_detail where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and adduser=?_login_user_name)"		&&cun_tm8 ----inv_detail
				ssql=ssql+Chr(10)+"select * from itemdept with (nolock)"					&&cun_tmp9	----item-->dept
				ssql=ssql+Chr(10)+"select * from outlet with (nolock)"					&&cun_tmp10 --outlet
				
				&&Lihong 2022.05.10 left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id, adduser=?_login_user_name -> (isnull(pay_cashier_user_id, -1) = ?__login_user_id or isnull(pay_cashier_user_id, -1) = -1 and adduser = ?_login_user_name)
				ssql=ssql+Chr(10)+"select inv.*,sys_user.name as pay_cashier_user from inv with (nolock) left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=0 "+;
				" and "+lcadduser_filter+" order by inv.id"	&&cun_tmp11 --inv
				
				ssql=ssql+Chr(10)+"select id,desccn,descen,code from item with (nolock) where dayend=1 and active=1 or id=-5"				&&cun_tmp12 item(¤éµ²®É¤ÀªR)

&&¤K¹F³q¥I´Ú(void ³æ)

				ssql=ssql+Chr(10)+"select inv.id,inv.pplcnt,inv.orgamt,inv.invamt,inv.discamt,inv.modiamt,inv.rndamt,inv.srvamt,inv.taxamt,inv.fastfood,inv.outlet_id,inv.adduser,inv.pay_cashier_user_id,sys_user.name as pay_cashier_user,pay_detail.qty as pay_qty,"+;
				"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate"+;
					" from inv with (nolock) left join  pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=1 and octopus=1 and "+lcadduser_filter+" order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)
				&&Lihong 2023.07.17 inv.adduser=?_login_user_name

				ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen,c.desccn as cpayway from expense a with (nolock) left join expense_main b with (nolock) "+;
					"on a.exp_id=b.id  left join expense_payway c with (nolock) on a.payway=c.id  where a.cln_id=0  and a.adduser=?_login_user_name order by a.id"		&&cun_tmp14  ¶}¤ä¤ÀªR

				Local _date1,_date2
*				_date1 =Dtot(Date())
*				_date2 =Dtot(Date()+1)
				_date1 =Dtot(sdate)
				_date2 =Dtot(edate +1)

*				ssql=ssql+Chr(10)+"select * from sys_log where adduser=?_login_user_name  and  log_Id=95 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp15   §ó§ï»ù®æ°O¿ý
				ssql=ssql+Chr(10)+"select * from change_price with (nolock) where belongdate between ?_date1 and ?edate order by datetime"

				ssql=ssql+Chr(10)+"select * from sys_log with (nolock) where adduser=?_login_user_name  and  log_Id=182 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp16   §ó§ïµo²¼°O¿ý

				ssql=ssql+Chr(10)+"select * from inv_itemdept with (nolock) where id in (select id from inv with (nolock) where year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter+")"		&&cun_tmp17 ³¡ªù¤À±b (§Y°Ý) &&Lihong 2023.07.17 adduser=?_login_user_name


				ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen from inv_tax a with (nolock) left join tax b with (nolock) on a.tax_id=b.id  where a.id in (select id from inv with (nolock) where year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter+")"		&&cun_tmp18 µ|¶µ
				&&Lihong 2023.07.17 adduser=?_login_user_name

				&&Lihong 2021.04.23 ¦L³æ«á§é¦© §ï¬°«öafter_inv ssql=ssql+Chr(10)+"select * from disc_log where datetime inv_no>0  and void=0 and inv_no in (select id from inv where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and cln=0 and void=0 and adduser=?_login_user_name) order by inv_no"	
				ssql=ssql+Chr(10)+"select id as inv_no, adduser, disc_amount from inv_itemdisc_view where after_inv=1 and id in (select id from inv with (nolock) where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and cln=0 and void=0 and "+lcadduser_filter+") "		&&cun_tmp19  ----¦L³æ«á§é¦©
				ssql=ssql+Chr(10)+"union all select id as inv_no, adduser, disc_amount from inv_disc_view where after_inv=1 and id in (select id from inv with (nolock) where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000";
				+" and cln=0 and void=0 and "+lcadduser_filter+") order by id"		&&cun_tmp19  ----¦L³æ«á§é¦© &&Lihong 2023.07.17 adduser=?_login_user_name
				
				ssql = ssql +Chr(10) + "select a.*,b.desccn,b.descen from item_move a with (nolock) left join item b with (nolock) on a.item_id=b.id where isnull(cln,0)=0 and a.adduser=?_login_user_name order by a.datetime"		&& cun_tmp20  ¦L³æ«áÂà»O


				ssql =ssql +Chr(10) + "select * from less_cash with (nolock) where  isnull(cln,0)=0 and adduser=?_login_user_name"		&&cun_tmp21  ¤Ö¦¬²{ª÷

				&&Lihong 2021.12.15 
				IF _Memb_Record
					TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW  &&cun_tmp22  ·|­û®ø¶O &&Lihong 2023.07.17 inv.adduser=?_login_user_name

						select c.cardno, c.name_cn, c.name_en, c.tel, SUM(b.invamt) as invamt, SUM(b.invamt - a.recharge_amount) as invamt_noRecharge, SUM(a.recharge_amount) as recharge_amount, 
						SUM(1) as invcnt, SUM(case when a.recharge_amount>0 and a.recharge_uid=a.all_uid then 0 else 1 end) as invcnt_noRecharge, SUM(case when a.recharge_amount>0 then 1 else 0 end) as recharge_count  
						from (SELECT inv.id, SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then d.real_amount+d.round_amount+d.xdisc else 0.00 end) as recharge_amount, 
									SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then 1 else 0 end) as recharge_uid, 
									COUNT(uid) as all_uid 
							from inv_detail_view d 
							left join inv_view inv on d.id=inv.id 
							where YEAR(inv.paidtime)>2000 and inv.cln=0 and ISNULL(inv.memberno,0)>0 and inv.void=0 and <<lcadduser_filter>> and d.sitem_sub=0 
							group by inv.id
							) a left join inv_view b on a.id=b.id left join member c with (nolock) on b.memberno=c.id
						group by b.memberno, c.cardno, c.name_cn, c.name_en, c.tel 
						order by c.cardno 
					ENDTEXT  
				ENDIF 
 
				&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ &&cun_tmp23 
				IF VARTYPE(__deposit_once)#"U" and __deposit_once
					ssql_2 = "select inv.*, "+; 
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
						"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,cast(ltrim(str(inv.id)) as varchar(20)) as tableno, sys_user.name as pay_cashier_user "+;
						" from deposit inv with (nolock) left join deposit_pay_detail pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 "+;
						"and ISNULL(inv.cln,0)=0 and ISNULL(inv.void,0)=0 and "+lcadduser_filter+" order by inv.id"						&&deposit²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)
				ENDIF 
		
			Case Upper(__checked_method)="STATION"		&&²M¾÷¤è¦¡,«östation
			
				*³¡ªù¤ÀªR load_itemdept()°Ñ¼Æ 2022-10-09 by sam 
				lcitemdept_cond = " and year(inv.paidtime)>2000 and cln=0 and station_id=?_station_id"
				lctblsrc = 2  
				
				ssql="select inv.*, "+;
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
					"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,inv.tableno,sys_user.name as pay_cashier_user "+;
					" from inv left join  pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=0 and inv.station_id=?_station_id order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)
				ssql=ssql+Chr(10)+"select inv.id,inv.invamt,void_reason.desccn,void_reason.descen from inv left join void_reason on inv.voidreason=void_reason.id where  inv.cln=0 and inv.void=1"+;
					" and inv.station_id=?_station_id  order by inv.id"		&&¨ú®øµo²¼(µ²±b«á¨ú®ø)
				ssql=ssql+Chr(10)+"select * from payway"
				ssql=ssql+Chr(10)+"select order_void.*,void_reason.desccn,void_reason.descen from order_void left join void_reason on order_void.void_reason=void_reason.id"+;
					" where order_void.cln=0 and order_void.void_time<?_clntime and order_void.station_id=?_station_id order by void_time"								&&¨ú®øµæ¦¡
				ssql=ssql+Chr(10)+"select * from inv_disc where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"		&&¾ã³æ§é¦©
				ssql=ssql+Chr(10)+"select * from inv_itemdisc where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"		&&¶µ¥Ø§é¦©
				ssql=ssql+Chr(10)+"select id,disc_type,desccn,descen from disc"				&&cun_tmp6  ----discount
				ssql=ssql+Chr(10)+"select id,desccn,descen,srv_to_dept from department order by disporder "  && modify by sam 2022-10-08 +Iif(_system_langue="cn","desccn","descen")			&&cun_tmp7  ----department
				
				ssql=ssql+Chr(10)+"select a.id,a.uid,a.parent_id,a.item_id,a.qty,a.orgamt,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.xdisc,a.tax2,a.tax_amount,a.askdept,a.item_code,a.cate_id,b.desccn,b.descen  "+;
					"from inv_detail  a  left join cate b on a.cate_id=b.id where a.id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"		&&cun_tm8 ----inv_detail	
								
	*			ssql=ssql+Chr(10)+"select id,uid,parent_id,item_id,qty,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_amount,xdisc,tax2,tax_amount,askdept,item_code  "+;
	*				" from inv_detail where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"		&&cun_tm8 ----inv_detail
					
				ssql=ssql+Chr(10)+"select * from itemdept"					&&cun_tmp9	----item-->dept
				ssql=ssql+Chr(10)+"select * from outlet"					&&cun_tmp10 --outlet
				ssql=ssql+Chr(10)+"select inv.*,sys_user.name as pay_cashier_user from inv with (nolock) left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=0 and inv.station_id=?_station_id order by inv.id"	&&cun_tmp11 --inv
				ssql=ssql+Chr(10)+"select id,desccn,descen,code from item where dayend=1 and active=1 or id=-5"				&&cun_tmp12 item(¤éµ²®É¤ÀªR)

&&¤K¹F³q¥I´Ú(void ³æ)	cun_tmp13
				ssql=ssql+Chr(10)+"select inv.id,inv.pplcnt,inv.orgamt,inv.invamt,inv.discamt,inv.modiamt,inv.rndamt,inv.srvamt,inv.taxamt,inv.fastfood,inv.outlet_id,inv.adduser,inv.pay_cashier_user_id,sys_user.name as pay_cashier_user,pay_detail.qty as pay_qty, "+;
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate"+;
					" from inv left join  pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=1 and octopus=1 and inv.station_id=?_station_id order by inv.id"						&&µo²¼²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)


				ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen,c.desccn as cpayway from expense a left join expense_main b "+;
					"on a.exp_id=b.id  left join expense_payway c on a.payway=c.id  where a.cln_id=0  and a.station_id=?_station_id order by a.id"		&&cun_tmp14  ¶}¤ä¤ÀªR

				Local _date1,_date2
*				_date1 =Dtot(Date())
*				_date2 =Dtot(Date()+1)
				_date1 =Dtot(sdate)
				_date2 =Dtot(edate +1)


*				ssql=ssql+Chr(10)+"select * from sys_log where station=?_computer and  log_Id=95 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp15   §ó§ï»ù®æ°O¿ý
				ssql=ssql+Chr(10)+"select * from change_price where station=?_computer and belongdate between ?_date1 and ?edate order by datetime"

				ssql=ssql+Chr(10)+"select * from sys_log where station=?_computer and  log_Id=182 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp16   §ó§ï»ù®æ°O¿ý

				ssql=ssql+Chr(10)+"select * from inv_itemdept where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"	&&cun_tmp17 ³¡ªù¤À±b (§Y°Ý)

				ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen from inv_tax a left join tax b on a.tax_id=b.id  where a.id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"	&&cun_tmp18 µ|¶µ

				&&Lihong 2021.04.23 ¦L³æ«á§é¦© §ï¬°«öafter_inv ssql=ssql+Chr(10)+"select * from disc_log where inv_no>0  and void=0 and inv_no in (select id from inv where (discamt<>0 or itemdiscamt<>0) and  year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"	&&cun_tmp19
				ssql=ssql+Chr(10)+"select id as inv_no, adduser, disc_amount from inv_itemdisc_view where after_inv=1 and id in (select id from inv where (discamt<>0 or itemdiscamt<>0) and  year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"		&&cun_tmp19  ----¦L³æ«á§é¦©
				ssql=ssql+Chr(10)+"union all select id as inv_no, adduser, disc_amount from inv_disc_view where after_inv=1 and id in (select id from inv where (discamt<>0 or itemdiscamt<>0) and  year(inv.paidtime)>2000 and cln=0 and void=0 and station_id=?_station_id)"		&&cun_tmp19  ----¦L³æ«á§é¦©

				ssql = ssql +Chr(10) + "select a.*,b.desccn,b.descen from item_move a left join item b  on a.item_id=b.id where isnull(cln,0)=0 and a.station=?_computer order by a.datetime"		&& cun_tmp20  ¦L³æ«áÂà»O

				ssql =ssql +Chr(10) + "select * from less_cash where isnull(cln,0)=0 and station=?_computer"		&&cun_tmp21  ¤Ö¦¬²{ª÷

				&&Lihong 2021.12.15 
				IF _Memb_Record
					TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW  &&cun_tmp22  ·|­û®ø¶O

						select c.cardno, c.name_cn, c.name_en, c.tel, SUM(b.invamt) as invamt, SUM(b.invamt - a.recharge_amount) as invamt_noRecharge, SUM(a.recharge_amount) as recharge_amount, 
						SUM(1) as invcnt, SUM(case when a.recharge_amount>0 and a.recharge_uid=a.all_uid then 0 else 1 end) as invcnt_noRecharge, SUM(case when a.recharge_amount>0 then 1 else 0 end) as recharge_count  
						from (SELECT inv.id, SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then d.real_amount+d.round_amount+d.xdisc else 0.00 end) as recharge_amount, 
									SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then 1 else 0 end) as recharge_uid, 
									COUNT(uid) as all_uid 
							from inv_detail_view d 
							left join inv_view inv on d.id=inv.id 
							where YEAR(inv.paidtime)>2000 and inv.cln=0 and ISNULL(inv.memberno,0)>0 and inv.void=0 and inv.station_id=?_station_id and d.sitem_sub=0 
							group by inv.id
							) a left join inv_view b on a.id=b.id left join member c with (nolock) on b.memberno=c.id
						group by b.memberno, c.cardno, c.name_cn, c.name_en, c.tel 
						order by c.cardno 
					ENDTEXT  
				ENDIF 
				&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ &&cun_tmp23 
				IF VARTYPE(__deposit_once)#"U" and __deposit_once
				ssql_2 = "select inv.*, "+;
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
					"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,cast(ltrim(str(inv.id)) as varchar(20)) as tableno, sys_user.name as pay_cashier_user "+;
					" from deposit inv with (nolock) left join deposit_pay_detail pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 "+;
					"and ISNULL(inv.cln,0)=0 and ISNULL(inv.void,0)=0 and inv.add_station=?_station_id order by inv.id"						&&deposit²M³æ(¥¼²M¾÷,¤£¬Ovoid,¤wµ²±b)
				ENDIF 

			Otherwise								&&²M¾÷¤è¦¡,¥þ³¡
				
				*³¡ªù¤ÀªR load_itemdept()°Ñ¼Æ 2022-10-09 by sam 
				lcitemdept_cond = " and year(inv.paidtime)>2000 and cln=0 "
				lctblsrc = 2 

				ssql="select inv.*,"+;
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
					"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,inv.tableno,sys_user.name as pay_cashier_user "+;
					" from inv left join  pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=0 order by inv.id"
				ssql=ssql+Chr(10)+"select inv.id,inv.invamt,void_reason.desccn,void_reason.descen from inv left join void_reason on inv.voidreason=void_reason.id where  inv.cln=0 and inv.void=1"+;
					" order by inv.id"		&&¨ú®øµo²¼(µ²±b«á¨ú®ø)
				ssql=ssql+Chr(10)+"select * from payway"
				ssql=ssql+Chr(10)+"select order_void.*,void_reason.desccn,void_reason.descen from order_void left join void_reason on order_void.void_reason=void_reason.id"+;
					" where order_void.cln=0 and order_void.void_time<?_clntime order by void_time"								&&¨ú®øµæ¦¡
				ssql=ssql+Chr(10)+"select * from inv_disc where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"		&&¾ã³æ§é¦©
				ssql=ssql+Chr(10)+"select * from inv_itemdisc where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"		&&¶µ¥Ø§é¦©
				ssql=ssql+Chr(10)+"select id,disc_type,desccn,descen from disc"				&&cun_tmp6  ----discount
				ssql=ssql+Chr(10)+"select id,desccn,descen,srv_to_dept from department with (nolock) order by disporder "  && modify by sam 2022-10-08 Iif(_system_langue="cn","desccn","descen")			&&cun_tmp7  ----department
				
				ssql=ssql+Chr(10)+"select a.id,a.uid,a.parent_id,a.item_id,a.qty,a.orgamt,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.xdisc,a.tax2,a.tax_amount,a.askdept,a.item_code,a.cate_id,b.desccn,b.descen  "+;
					"from  inv_detail a  left join cate b on a.cate_id=b.id where a.id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"		&&cun_tm8 ----inv_detail					
				
		*		ssql=ssql+Chr(10)+"select id,uid,parent_id,item_id,qty,orgamt,amount,real_amount,round_amount,modi_amount,disc_amount,srv_amount,xdisc,tax2,tax_amount,askdept,item_code  from inv_detail where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"		&&cun_tm8 ----inv_detail
				ssql=ssql+Chr(10)+"select * from itemdept"					&&cun_tmp9	----item-->dept
				ssql=ssql+Chr(10)+"select * from outlet"					&&cun_tmp10 --outlet
				ssql=ssql+Chr(10)+"select inv.*,sys_user.name as pay_cashier_user from inv with (nolock) left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=0 order by inv.id"	&&cun_tmp11 --inv
				ssql=ssql+Chr(10)+"select id,desccn,descen,code from item where dayend=1 and active=1 or id=-5"				&&cun_tmp12 item(¤éµ²®É¤ÀªR)

&&¤K¹F³q¥I´Ú(void ³æ)	cun_tmp13
				ssql=ssql+Chr(10)+"select inv.id,inv.pplcnt,inv.orgamt,inv.invamt,inv.discamt,inv.modiamt,inv.rndamt,inv.srvamt,inv.taxamt,inv.fastfood,inv.outlet_id,inv.adduser,inv.pay_cashier_user_id,sys_user.name as pay_cashier_user,pay_detail.qty as pay_qty,"+;
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate"+;
					" from inv left join  pay_detail on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 and inv.cln=0 and inv.void=1 and octopus=1 order by inv.id"


				ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen,c.desccn as cpayway from expense a left join expense_main b "+;
					"on a.exp_id=b.id  left join expense_payway c on a.payway=c.id  where a.cln_id=0   order by a.id"		&&cun_tmp14  ¶}¤ä¤ÀªR


				Local _date1,_date2
*				_date1 =Dtot(Date())
*				_date2 =Dtot(Date()+1)
				_date1 =Dtot(sdate)
				_date2 =Dtot(edate +1)


*				ssql=ssql+Chr(10)+"select * from sys_log where log_Id=95 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp15   §ó§ï»ù®æ°O¿ý

				ssql=ssql+Chr(10)+"select * from change_price where belongdate between ?_date1 and ?edate order by datetime"


				ssql=ssql+Chr(10)+"select * from sys_log where log_Id=182 and datetime>=?_date1 and datetime <=?_date2  order by datetime"		&&cun_tmp16   §ó§ï»ù®æ°O¿ý
				ssql=ssql+Chr(10)+"select * from inv_itemdept where id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"	&&cun_tmp17 ³¡ªù¤À±b (§Y°Ý)

				ssql=ssql+Chr(10)+"select a.*,b.desccn,b.descen from inv_tax a left join tax b on a.tax_id=b.id  where a.id in (select id from inv where year(inv.paidtime)>2000 and cln=0 and void=0)"	&&cun_tmp18µ|¶µ

				&&Lihong 2021.04.23 ¦L³æ«á§é¦© §ï¬°«öafter_inv ssql=ssql+Chr(10)+"select * from disc_log where inv_no>0  and void=0 and inv_no in (select id from inv where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and cln=0 and void=0)"	&&cun_tmp19 ¦L³æ«á§é¦©
				ssql=ssql+Chr(10)+"select id as inv_no, adduser, disc_amount from inv_itemdisc_view where after_inv=1 and id in (select id from inv where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and cln=0 and void=0)"		&&cun_tmp19  ----¦L³æ«á§é¦©
				ssql=ssql+Chr(10)+"union all select id as inv_no, adduser, disc_amount from inv_disc_view where after_inv=1 and id in (select id from inv where (discamt<>0 or itemdiscamt<>0) and year(inv.paidtime)>2000 and cln=0 and void=0)"	&&cun_tmp19  ----¦L³æ«á§é¦©

				ssql = ssql +Chr(10) + "select a.*,b.desccn,b.descen from item_move a left join item b on a.item_id= b.id where isnull(cln,0)=0 order by a.datetime"		&& cun_tmp20  ¦L³æ«áÂà»O

				ssql =ssql +Chr(10) + "select * from less_cash where isnull(cln,0)=0 "		&&cun_tmp21  ¤Ö¦¬²{ª÷

				&&Lihong 2021.12.15 
				IF _Memb_Record
					TEXT TO ssql ADDITIVE TEXTMERGE NOSHOW  &&cun_tmp22  ·|­û®ø¶O

						select c.cardno, c.name_cn, c.name_en, c.tel, SUM(b.invamt) as invamt, SUM(b.invamt - a.recharge_amount) as invamt_noRecharge, SUM(a.recharge_amount) as recharge_amount, 
						SUM(1) as invcnt, SUM(case when a.recharge_amount>0 and a.recharge_uid=a.all_uid then 0 else 1 end) as invcnt_noRecharge, SUM(case when a.recharge_amount>0 then 1 else 0 end) as recharge_count  
						from (SELECT inv.id, SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then d.real_amount+d.round_amount+d.xdisc else 0.00 end) as recharge_amount, 
									SUM(case when (ISNULL(d.pointrate,0)>0 or ISNULL(d.pointfix,0)>0) then 1 else 0 end) as recharge_uid, 
									COUNT(uid) as all_uid 
							from inv_detail_view d 
							left join inv_view inv on d.id=inv.id 
							where YEAR(inv.paidtime)>2000 and inv.cln=0 and ISNULL(inv.memberno,0)>0 and inv.void=0 and d.sitem_sub=0 
							group by inv.id
							) a left join inv_view b on a.id=b.id left join member c with (nolock) on b.memberno=c.id
						group by b.memberno, c.cardno, c.name_cn, c.name_en, c.tel 
						order by c.cardno 
					ENDTEXT  
				ENDIF 
				
				&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷ &&cun_tmp23 
				IF VARTYPE(__deposit_once)#"U" and __deposit_once
				ssql_2 = "select inv.*,"+;
					"isnull(pay_detail.pay_id,'') as pay_id,ISNULL(pay_detail.payamt,0) as payamt,ISNULL(pay_detail.netamt,0) as netamt,ISNULL(pay_detail.tips,0) as tips,"+;
					"pay_detail.qty as pay_qty,pay_detail.pay_others,pay_detail.changes,pay_detail.changes_id,pay_detail.rate,cast(ltrim(str(inv.id)) as varchar(20)) as tableno, sys_user.name as pay_cashier_user "+;
					" from deposit inv with (nolock) left join deposit_pay_detail pay_detail with (nolock) on inv.id=pay_detail.id left join sys_user with (nolock) on inv.pay_cashier_user_id=sys_user.id where year(inv.paidtime)>2000 "+;
					"and ISNULL(inv.cln,0)=0 and ISNULL(inv.void,0)=0 order by inv.id"
				ENDIF 

		Endcase

Endcase




*---------------------------------------------------------------------------------------
If SQLExec(nhand,ssql,"cun_tmp")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
ENDIF

IF VARTYPE(ssql_2)="C" AND SQLExec(nhand,ssql_2,"cun_tmp23")<0
	Aerror(err)
	frm_wait.Hide
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	Return -1
ENDIF 

IF _chkdept > 0
	*---³¡ªù¤À±b cun_itemdept
	IF !load_itemdept(lcitemdept_cond, lctblsrc)
		RETURN -1
	ENDIF
ENDIF  

RETURN 1
ENDFUNC 


FUNCTION clean_report_ms_cashier

	*If _show_cashier

&&Åã¥Ü­Ó¦¬»È­û
	SELECT cln From cun_tmp GROUP BY cln Order By cln INTO CURSOR cun_tmp_cln_tmp
	SCAN 
		RELEASE tmp_s1
		Select adduser Distinct From cun_tmp WHERE cln=cun_tmp_cln_tmp.cln Order By adduser Into Array tmp_s1		&&¦¬»È­û
		*lnCrasher=Alen(tmp_s1)
		lnCrasher=IIF(VARTYPE(tmp_s1)="U", 0, Alen(tmp_s1))
		IF lnCrasher = 0
			LOOP
		ENDIF 
		*If lnCrasher>1 OR LOWER(__special_customer)=="ms" &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"

			For k=1 To Alen(tmp_s1)
				_crasher=tmp_s1(k)		&&¦¬»È­û¦WºÙ
				
				IF !LOWER(__special_customer)=="ms" &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"
					If Empty(_crasher)
						Loop

					Endif
				ENDIF 

				_header=.T.
				For i=1 To Alen(tmp_s)
					_Pid=tmp_s(i)
					Select cun_tmp2
					Locate For Id=_Pid

					_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))
					_islocal=(cun_tmp2.rate=1)

					Select cun_tmp
					Sum(pay_qty) To N For cln=cun_tmp_cln_tmp.cln and pay_id=_Pid And adduser=_crasher

					Sum tips1,payamt To _tips,_payamt For cln=cun_tmp_cln_tmp.cln and pay_id=_Pid And pay_others=0 And adduser=_crasher
					Sum pay_others To _pay_others For cln=cun_tmp_cln_tmp.cln and pay_id=_Pid And pay_others>0 And adduser=_crasher
					Sum Changes To _changes For cln=cun_tmp_cln_tmp.cln and changes_id=_Pid And adduser=_crasher
					Sum netamt To _netamt For cln=cun_tmp_cln_tmp.cln and pay_id=_Pid And adduser=_crasher

					If  N>0

						Select cln_tmp4
						Append Blank
						If lnCrasher>1 And _header=.T. OR LOWER(__special_customer)=="ms" 	&&¦pªG¦³¦h©ó¤@­Ó¦¬»È­û(¬O§_Åã¥Ü¸òsetting) &&Lihong 2022.02.25 ¼W¥[LOWER(__special_customer)=="ms"
							Replace cln WITH cun_tmp_cln_tmp.cln,crasher With _crasher,r_id With 4,pay_id With _Pid
							_header=.F.
						Endif

*					REPLACE r_id WITH 4,payway WITH _payway,paytimes WITH n,tips WITH _tips,amt WITH _netamt-_tips,tamt WITH _netamt-_tips,adduser WITH _crasher,islocal WITH _islocal,pay_id WITH _pid

						Replace r_id With 4,payway With _payway,paytimes With N,tips With _tips,amt With Iif(_pay_others>0 ,_pay_others, _payamt ) -_changes-_tips,tamt With amt+tips,netamt With _netamt,adduser With _crasher,islocal With _islocal,pay_id With _Pid

					Endif


				Endfor

				Select cun_tmp13					&&²Î­p¤K¹F³qvoid ³æ
				Go Top
				If !Eof()
					Sum netamt To _amt For cln=cun_tmp_cln_tmp.cln and pay_id=-1 And adduser=_crasher
					If _amt>0

						Sum pay_qty To npay For cln=cun_tmp_cln_tmp.cln and pay_id=-1 And adduser=_crasher
						Select cun_tmp2
						Locate For Id>0 And Lock
						If !Found()
							Loop
						Endif

						_pay_id=Id
						_payway=Iif(_system_langue="CN",Trim(desccn),Trim(Descen))



						Select cln_tmp4
						Locate For cln=cun_tmp_cln_tmp.cln and pay_id=-1 And adduser=_crasher
						If Found()

							Replace amt With amt +_amt,tamt With tamt+_amt			&&

						Else

							Select cln_tmp4
							Append Blank		&&¤K¹F³q
							Replace r_id With 4,cln WITH cun_tmp_cln_tmp.cln,payway With _octopus ,paytimes With npay,pay_id With -1,islocal With .T.,adduser With _crasher
							Replace amt With _amt,tamt With amt			&&

						Endif

						Select cln_tmp4		&&²{ª÷­nÅÜ¬°¥[¤@­Ó­t¼Æ
						Locate For cln=cun_tmp_cln_tmp.cln and pay_id=_pay_id  And adduser=_crasher
						If !Found()
							Append Blank
							Replace r_id With 4,cln WITH cun_tmp_cln_tmp.cln,payway With _payway,paytimes With npay,pay_id With _pay_id,islocal With .T.,adduser With _crasher
						Endif


					Endif


				Endif


*!*					Select cln_tmp4
*!*	*				SUM tips,amt,tamt TO _crasher_tips,_crasher_amt,_crasher_tamt FOR adduser=_crasher
*!*					Sum tips,amt  To _crasher_tips,_crasher_amt For adduser=_crasher

*!*					Append Blank
*!*					Replace r_id With 4,crasher With Replicate("-",70),payway With _ctotal,tips With _crasher_tips,amt With _crasher_amt,tamt With amt+tips ,istotal With .T.



			Endfor

		*Endif




&&¦pªG¦h©ó¤@­Ó¦¬»È­û¡A¦A¥[¤W¥þ³¡¥I´Ú¤è¤è¦¡²Î­p

*!*			If lnCrasher>1

*!*				Select cln_tmp4
*!*				Append Blank
*!*				Replace r_id With 4,crasher With Replicate("-",70)

*!*			Endif


	*Endif
	
	ENDSCAN 
	USE IN SELECT("cun_tmp_cln_tmp")
	
	Select cln_tmp4

	If !Bof()

		_recn=Recno()

	Endif

ENDFUNC 


&&Lihong 2022.03.23 ÂàªA°È¶O²v
FUNCTION get_tran_srv_id(_srv_id, _outlet_id, _cate_id, _ordertime, _sit_time)
	_curdatetime_ord = CTOT(LEFT(TTOC(_ordertime),16))
	_curtime_ord = SUBSTR(TTOC(_curdatetime_ord), 12, 5) &&¥h±¼seconds

	_curdatetime_sit = CTOT(LEFT(TTOC(_sit_time),16)) 
	_curtime_sit = SUBSTR(TTOC(_curdatetime_sit), 12, 5)

	&&Lihong 2022.09.29
	_curweekday_ord=Dow(_curdatetime_ord)
	_curweekday_ord=Iif(_curweekday_ord=1,7,_curweekday_ord-1)
	_day_ord="day"+Alltrim(Str(_curweekday_ord))
	_date_ord = TTOD(_curdatetime_ord)

	_belongdate_ord = getbelongdate(_curdatetime_ord)
	Select Id From work_order_tmp14 Where begdate<=_belongdate_ord And enddate>=_belongdate_ord Into Array tmp_s
	_isholiday_ord=(_Tally>0)
	*Select Id From work_order_tmp24 Where begdate<=_belongdate_sit And enddate>=_belongdate_sit Into Array tmp_s
	Select Id From work_order_tmp24 Where CTOT(STUFF(TTOC(begdate),12,5,date_start_time))<=_curdatetime_ord And CTOT(STUFF(TTOC(enddate),12,5,date_end_time))>=_curdatetime_ord ;
	AND ((_curtime_ord>=start_time And _curtime_ord<=end_time) Or (start_time>end_time And (_curtime_ord>=start_time Or  _curtime_ord<=end_time))) Into Array tmp_s
	_isfestival_ord=(_Tally>0)

	SELECT id FROM work_order_tmp15 WHERE (_curtime_ord>=s_from AND _curtime_ord<=s_to) OR (s_from>s_to AND (_curtime_ord>=s_from  OR  _curtime_ord<=s_to)) INTO ARRAY tmp_s
	IF _tally>0
	 	_sid_ord=ALLTRIM(STR(tmp_s(1)))
	ELSE
	 	_sid_ord="0"
	ENDIF
	*
	_curweekday_sit=Dow(_curdatetime_sit)
	_curweekday_sit=Iif(_curweekday_sit=1,7,_curweekday_sit-1)
	_day_sit="day"+Alltrim(Str(_curweekday_sit))
	_date_sit = TTOD(_curdatetime_sit)

	_belongdate_sit = getbelongdate(_curdatetime_sit)
	Select Id From work_order_tmp14 Where begdate<=_belongdate_sit And enddate>=_belongdate_sit Into Array tmp_s
	_isholiday_sit=(_Tally>0)
	*Select Id From work_order_tmp24 Where begdate<=_belongdate_sit And enddate>=_belongdate_sit Into Array tmp_s
	Select Id From work_order_tmp24 Where CTOT(STUFF(TTOC(begdate),12,5,date_start_time))<=_curdatetime_sit And CTOT(STUFF(TTOC(enddate),12,5,date_end_time))>=_curdatetime_sit ;
	AND ((_curtime_sit>=start_time And _curtime_sit<=end_time) Or (start_time>end_time And (_curtime_sit>=start_time Or  _curtime_sit<=end_time))) Into Array tmp_s
	_isfestival_sit=(_Tally>0)

	SELECT id FROM work_order_tmp15 WHERE (_curtime_sit>=s_from AND _curtime_sit<=s_to) OR (s_from>s_to AND (_curtime_sit>=s_from  OR  _curtime_sit<=s_to)) INTO ARRAY tmp_s
	IF _tally>0
	 	_sid_sit=ALLTRIM(STR(tmp_s(1)))
	ELSE
	 	_sid_sit="0"
	ENDIF
	&&

	Select tran_srv_id From work_order_tmp22 Order By sub_id ;
		WHERE srv_id=_srv_id AND (EMPTY(NVL(outlet_id_list, "")) OR ALLTRIM(outlet_id_list)=="*" Or ","+TRANSFORM(_outlet_id)+"," $ ","+RTRIM(outlet_id_list)+",") ;
		AND (EMPTY(NVL(cate_id_list, "")) OR ALLTRIM(cate_id_list)=="*" Or ","+PADL(TRANSFORM(_cate_id), 4, "0")+"," $ ","+RTRIM(cate_id_list)+",") ;
		AND (NVL(calc_type,0)=1 AND _curdatetime_ord>=start_date And _curdatetime_ord<=end_date ;
				OR NVL(calc_type,0)=2 AND _curdatetime_sit>=start_date And _curdatetime_sit<=end_date ) ;
		AND (NVL(calc_type,0)=1 AND (_curtime_ord>=start_time And _curtime_ord<=end_time Or start_time>end_time And (_curtime_ord>=start_time Or _curtime_ord<=end_time)) ;
				OR NVL(calc_type,0)=2 AND (_curtime_sit>=start_time And _curtime_sit<=end_time Or start_time>end_time And (_curtime_sit>=start_time Or _curtime_sit<=end_time))) ;
		AND (NVL(calc_type,0)=1 AND ( (&_day_ord AND !_isholiday_ord AND !_isfestival_ord) Or (_isholiday_ord AND (&_day_ord OR holiday)  And !ex_holiday AND (!_isfestival_ord OR !ex_festival)) Or (_isfestival_ord AND (&_day_ord OR festival)  And !ex_festival AND (!_isholiday_ord OR !ex_holiday)) ); 
		    OR NVL(calc_type,0)=2 AND ( (&_day_sit AND !_isholiday_sit AND !_isfestival_sit) Or (_isholiday_sit AND (&_day_sit OR holiday)  And !ex_holiday AND (!_isfestival_sit OR !ex_festival)) Or (_isfestival_sit AND (&_day_sit OR festival)  And !ex_festival AND (!_isholiday_sit OR !ex_holiday)) ) );
		Into Array tran_srv_tmp_s

	If _Tally>0
		_srv_id = tran_srv_tmp_s[1]
	ENDIF
	RETURN _srv_id 
ENDFUNC


&&Lihong 2022.04.18 ¦X¨Ö³æ
FUNCTION merge_paid_inv_to(lndinv_id, lnsinv_id)

lndinv_id = INT(lndinv_id)
lnsinv_id =  INT(lnsinv_id)

LOCAL ssql, _max_taget_uid, _max_updateno, _max_updateno1,_deposit_id1,_deposit_id2  &&_void_user

*!*	CanAccess = user_access("invinfo_merge_inv")
*!*	IF !CanAccess
*!*		=FMessagebox("_no_access")
*!*		RETURN
*!*	ENDIF 	
*!*	_void_user=IIF(VARTYPE(__access_user_name)="U",_login_user_name,__access_user_name)		&&¡@void_user

TEXT TO ssql noshow
	
	select ISNULL(MAX(uid),0) as max_uid from inv_detail with(nolock) where id=?lndinv_id

	select ISNULL(MAX(updateno),0) as max_updateno from inv with(nolock) 
	
	SELECT SUM(orgamt	) as orgamt, SUM(amount) as amount, SUM(modiamt) as modiamt, SUM(itemdiscamt) as itemdiscamt, SUM(srvamt) as srvamt,
	SUM(taxamt) as taxamt, SUM(rndamt) as rndamt, SUM(discamt) as discamt, SUM(invamt) as invamt, SUM(tips) as tips, SUM(paidamt) as paidamt, SUM(pplcnt) as pplcnt 
	from inv with(nolock) where id=?lndinv_id or id=?lnsinv_id 
	
	SELECT tableno,deposit_id from inv with(nolock) where id=?lndinv_id
	
	SELECT deposit_id from inv with(nolock) where id=?lnsinv_id
ENDTEXT 

IF SQLEXEC(nhand,ssql ,"cun_tmp")<0
	aerror(err)
	*Sqlrollback(nhand)
	*SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

SELECT cun_tmp
_max_taget_uid=cun_tmp.max_uid		&&¥Ø¼ÐÂi³Ì¤jªºUID
SELECT cun_tmp1
_max_updateno = cun_tmp1.max_updateno+1
_max_updateno1 = cun_tmp1.max_updateno+2
USE IN SELECT("cun_tmp1")
SELECT cun_tmp2
LOCAL _orgamt, _amount, _modiamt, _itemdiscamt, _srvamt, _taxamt, _rndamt, _discamt, _invamt, _tips, _paidamt, _pplcnt, _update_ppl  
_orgamt = cun_tmp2.orgamt &&? Error converting data type varchar to numeric
_amount = cun_tmp2.amount
_modiamt = cun_tmp2.modiamt
_itemdiscamt = cun_tmp2.itemdiscamt
_srvamt = cun_tmp2.srvamt
_taxamt = cun_tmp2.taxamt
_rndamt = cun_tmp2.rndamt
_discamt = cun_tmp2.discamt
_invamt = cun_tmp2.invamt
_tips = cun_tmp2.tips
_paidamt =  cun_tmp2.paidamt
_pplcnt = cun_tmp2.pplcnt
USE IN SELECT("cun_tmp2")

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
_deposit_id1=NVL(cun_tmp3.deposit_id,0)
_deposit_id2=NVL(cun_tmp4.deposit_id,0)
IF _deposit_id1>0 AND _deposit_id2>0
	RETURN	 .F.
ENDIF 
_deposit_id1 = MAX(_deposit_id1,_deposit_id2)
USE IN SELECT("cun_tmp4")

_update_ppl = ""
SELECT cun_tmp3
IF !EMPTY(cun_tmp3.tableno)
	_update_ppl = "pplcnt=" + TRANSFORM(_pplcnt) + ", "
ENDIF 

*!*	TEXT TO ssql NOSHOW TEXTMERGE 
*!*		update inv_lock set edit_time=getdate() 
*!*		
*!*		update inv_detail SET id = ?lndinv_id, uid = uid + ?_max_taget_uid  where id=?lnsinv_id
*!*		
*!*		UPDATE inv_modi SET id = ?lndinv_id, item_id = item_id+?_max_taget_uid where id = ?lnsinv_id
*!*		
*!*		UPDATE inv_itemdisc SET id = ?lndinv_id, item_id = item_id + ?_max_taget_uid where id = ?lnsinv_id
*!*		
*!*		UPDATE inv_itemdept SET id = ?lndinv_id, Parent_id = Parent_id + ?_max_taget_uid where id=?lnsinv_id
*!*		
*!*		UPDATE pay_detail SET id = ?lndinv_id where id=?lnsinv_id

*!*		DELETE inv where id=?lnsinv_id 

*!*		update inv set orgamt=<<_orgamt>>, amount=<<_amount>>, modiamt=<<_modiamt>>, itemdiscamt=<<_itemdiscamt>>, srvamt=<<_srvamt>>, 
*!*		taxamt=<<_taxamt>>, rndamt=<<_rndamt>>, discamt=<<_discamt>>, invamt=<<_invamt>>, tips=<<_tips>>, paidamt=<<_paidamt>>, updateno=<<_max_updateno>>, is_edit=1 
*!*		where id=?lndinv_id 
*!*	ENDTEXT
*!*	TRY 
*!*	STRTOFILE(ssql, "D:\t\merge.txt")
*!*	CATCH 
*!*	ENDTRY 

IF SQLSETPROP(nhand,"Transactions",2)<0
	aerror(err)
	SQLSETPROP(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

*!*	IF SQLEXEC(nhand,ssql)<0
*!*		aerror(err)
*!*		Sqlrollback(nhand)
*!*		SQLSetprop(nhand,"Transactions" ,1)
*!*		error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
*!*		
*!*		RETURN	 .F.
*!*	ENDIF

IF SQLEXEC(nhand, "update inv_lock set edit_time=getdate() ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

IF SQLEXEC(nhand, "update inv_detail SET id = ?lndinv_id, uid = uid + ?_max_taget_uid  where id=?lnsinv_id ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

&&dispord
IF SQLEXEC(nhand, "UPDATE inv_modi SET id = ?lndinv_id, item_id = item_id+?_max_taget_uid, dispord = dispord + (select ISNULL(MAX(dispord),0) from inv_modi (nolock) WHERE id = ?lndinv_id)  where id = ?lnsinv_id ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

&&dispord
IF SQLEXEC(nhand, "UPDATE inv_itemdisc SET id = ?lndinv_id, item_id = item_id + ?_max_taget_uid, dispord = dispord + (select ISNULL(MAX(dispord),0) from inv_modi (nolock) WHERE id = ?lndinv_id)  where id = ?lnsinv_id ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

IF SQLEXEC(nhand, "UPDATE inv_itemdept SET id = ?lndinv_id, Parent_id = Parent_id + ?_max_taget_uid where id=?lnsinv_id ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

&&dispord
IF SQLEXEC(nhand, "UPDATE pay_detail SET id = ?lndinv_id, dispord = dispord + (select ISNULL(MAX(dispord),0) from pay_detail (nolock) WHERE id = ?lndinv_id) where id=?lnsinv_id ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

IF SQLEXEC(nhand, "DELETE inv where id=?lnsinv_id ")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

&&Lihong 2022.11.18 ¤@¦¸©Ê­qª÷
IF _deposit_id1>0 AND SQLEXEC(nhand, "update deposit set inv_id=?lndinv_id where id=?_deposit_id1")<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF 

TEXT TO ssql NOSHOW TEXTMERGE 
	update inv set orgamt=<<_orgamt>>, amount=<<_amount>>, modiamt=<<_modiamt>>, itemdiscamt=<<_itemdiscamt>>, srvamt=<<_srvamt>>, 	taxamt=<<_taxamt>>, 
	rndamt=<<_rndamt>>, discamt=<<_discamt>>, invamt=<<_invamt>>, tips=<<_tips>>, paidamt=<<_paidamt>>, updateno=<<_max_updateno>>, <<_update_ppl>> is_edit=1,
	deposit_id=?_deposit_id1 
	where id=?lndinv_id 
ENDTEXT

IF SQLEXEC(nhand, ssql)<0
	aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions" ,1)
	error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
	
	RETURN	 .F.
ENDIF

IF Sqlcommit(nhand)<0
	Aerror(err)
	Sqlrollback(nhand)
	SQLSetprop(nhand,"Transactions",1)
	error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

	*USE IN SELECT("cun_tmp2")

	Return .F.
Endif
SQLSetprop(nhand,"Transactions",1)
*USE IN SELECT("cun_tmp2")

RETURN 

ENDFUNC 


&&Donald 2022.04.19 ¥[±Kºâªk¡A§Ú¼g¤F¤@¤U
FUNCTION Encrypt_with_AES128(lcCaption, lcKey)
LOCAL lccorpstr, lcappsecret, lcIv, lcAES, lccorpsign
lccorpstr = Strconv(ALLTRIM(lcCaption), 9)  &&??UTF8
lcappsecret = ALLTRIM(lcKey)
Set Library To vfpencryption71.fll Additive
lcIv = lcappsecret
lcAES = Encrypt(lccorpstr, lcappsecret, 0, 0, 2, Len(lcappsecret), 16, m.lcIV)
lccorpsign = Strconv(lcAes, 13)    
Release Library vfpencryption71
RETURN lccorpsign
ENDFUNC 
&&Donald 2022.04.19 ¥[±Kºâªk¡A§Ú¼g¤F¤@¤U
FUNCTION Decrypt_with_AES128(lcCaption, lcKey)
LOCAL lccorpstr, lcappsecret, lcIv, lcAES
lccorpstr = Strconv(ALLTRIM(lcCaption), 9)  &&??UTF8
lcappsecret = ALLTRIM(lcKey)
Set Library To vfpencryption71.fll Additive
lcIv = lcappsecret
lcAES = Decrypt(STRCONV(lccorpstr, 14), lcappsecret, 0, 0, 2, Len(lcappsecret), 16, m.lcIV)
Release Library vfpencryption71
RETURN lcAES
ENDFUNC 


&&Lihong 2022.04.19 ¤W¶Çinv¨ìstorellet
FUNCTION upload_storellet
LPARAMETERS lcaction, lninvid, lcmember_code, lccoupon_id &&, invamt, paidtime, _belongdate

IF lcaction == "Del_order_storellet"
	lnorderid = lninvid
	lninvid = -1
ENDIF 

&&check_valid¤£¸òµo²¼

IF VARTYPE(lninvid)#"N"
	 lninvid = 0
	*RETURN 
ENDIF

LOCAL dbsql, _invamt_add_fee 

IF !lcaction == "up"

	nishq = IIF(Vartype(__run_hq_mode)#"U" And __run_hq_mode, 1, 0)
	TEXT TO dbsql NOSHOW TEXTMERGE 
		DECLARE @cloud_check_valid as uniqueidentifier
		DECLARE @inv_seq as int 
		DECLARE @station_id as int 
		
		DECLARE @pos_shop_id as int
		DECLARE @shop_code as nvarchar(20)
		DECLARE @shop_name as nvarchar(40)

		SET @cloud_check_valid = newid()
		SET @inv_seq = (select ISNULL(MAX(inv_seq),0)+1 from storellet_upload with (nolock) where inv_id=?lninvid ) 

	ENDTEXT 
	
	IF "redeem" $ lcaction OR lcaction == "Del_order_storellet"
		TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	

		SET @station_id = ?__station_id
		ENDTEXT 
	ELSE
		TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	

		SET @station_id = isnull((select ISNULL(station_id,0) as station_id from inv with (nolock) where id=?lninvid),0)
		ENDTEXT 
	ENDIF 

	TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	
		IF <<nishq>>=1
		begin
		SET @pos_shop_id = (select shop_id from rms8_station with (nolock) where id=@station_id)
		SET @shop_code = (select code from rms8_shop with (nolock) where id=@pos_shop_id)
		SET @shop_name = (select name from rms8_shop with (nolock) where id=@pos_shop_id)
		end
		else
		begin
		SET @pos_shop_id = -1
		SET @shop_code = ''
		SET @shop_name = ''
		end
	ENDTEXT 
	
	IF lcaction == "Del_inv_storellet" OR lcaction == "Del_order_storellet"
		dbsql_head = dbsql 
	ENDIF 

	IF !lcaction == "Del_order_storellet"
	
		IF "redeem" $ lcaction
		
			_llnull = .null.
			TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	

			INSERT INTO storellet_upload (check_valid, action, station_id, pos_shop_id, shop_code, shop_name, inv_id, invamt, paidtime, belongdate, inv_seq, create_date, coupon_id, member_carno)  
			values (@cloud_check_valid, ?lcaction, @station_id, @pos_shop_id, @shop_code, @shop_name, ?lninvid, ?_llnull, ?_llnull, ?_llnull, @inv_seq, getdate(), ?lccoupon_id, ?lcmember_code)
			
			ENDTEXT 
		
		ELSE 
			&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h
			IF VARTYPE(__cloud_member)#"U" AND __cloud_member
				If SQLExec(nhand, "select a.memberno,b.cloud_plat from inv a with (nolock) left join member b with (nolock) on a.memberno=b.id where a.id=?lninvid", "storellet_inv_item_tmp")<0 
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					IF __debug_mode 
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					ENDIF 
					RETURN .F.
				ENDIF
				IF RECCOUNT("storellet_inv_item_tmp")>0 AND NVL(storellet_inv_item_tmp.memberno, 0)>0 AND !TRIM(NVL(storellet_inv_item_tmp.cloud_plat, ""))=="storellet"
					USE IN SELECT("storellet_inv_item_tmp")
					RETURN 
				ENDIF 
				USE IN SELECT("storellet_inv_item_tmp")
			ENDIF 

			&&Lihong 2022.12.14 storellet inv item 
			_inv_item_jsonstr = ""
			_inv_pay_jsonstr = ""
			_invamt_add_fee = 0.00
			IF lcaction == "Add_inv_storellet" OR lcaction == "Update_inv_storellet" 
				If SQLExec(nhand, "SELECT item_code,sum(qty) as qty, SUM(real_amount) as real_amount from inv_detail with (nolock) where id=?lninvid group by item_code"+CHR(13)+;
				IIF(VARTYPE(__storellet)#"U" AND __storellet and VARTYPE(__storellet_tran)#"U" AND LOWER(__storellet_tran)="white", ;
				"SELECT a.pay_id, b.desccn, b.descen, SUM(a.netamt) as netamt from pay_detail a with (nolock) left join payway b with (nolock) on a.pay_id=b.id where a.id=?lninvid group by a.pay_id, b.desccn, b.descen", ""), "storellet_inv_item_tmp")<0 
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					IF __debug_mode 
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					ENDIF 
					RETURN .F.
				ENDIF
				
				LOCAL lccode,lcqty
				SELECT storellet_inv_item_tmp
				SCAN 
					lccode = RTRIM(storellet_inv_item_tmp.item_code)
					lcqty = TRANSFORM(NVL(storellet_inv_item_tmp.qty,0))
					_inv_item_jsonstr = _inv_item_jsonstr + IIF(EMPTY(_inv_item_jsonstr),"",",") + '{"code":"' + lccode + '", "qty":&lcqty}'
				ENDSCAN 
				IF !EMPTY(_inv_item_jsonstr)
					_inv_item_jsonstr = '{"inv_item":[' + _inv_item_jsonstr + ']}'
				ENDIF 
				*_inv_item_jsonstr = CHRTRAN(_inv_item_jsonstr, CHR(10)+CHR(13), "")
				
				IF VARTYPE(__storellet)#"U" AND __storellet and VARTYPE(__storellet_tran)#"U" AND LOWER(__storellet_tran)="white"
					*SELECT real_amount FROM storellet_inv_item_tmp WHERE TRIM(item_code)=="-6" OR TRIM(item_code)=="-7" INTO CURSOR storellet_inv_item_tmp 
					*_invamt_add_fee = storellet_inv_item_tmp.real_amount 
					SELECT storellet_inv_item_tmp1
					SCAN 
						lccode = RTRIM(TRANSFORM(storellet_inv_item_tmp1.pay_id))
						lcqty = TRANSFORM(NVL(storellet_inv_item_tmp1.netamt,0))
						_inv_pay_jsonstr = _inv_pay_jsonstr + IIF(EMPTY(_inv_pay_jsonstr),"",",") + '{"id":&lccode' + ', "name_cn":"' + RTRIM(storellet_inv_item_tmp1.desccn) + '", "name_en":"' + RTRIM(storellet_inv_item_tmp1.descen) + '", "amt":&lcqty}'
					ENDSCAN 
					IF !EMPTY(_inv_pay_jsonstr)
						_inv_pay_jsonstr = '{"payways":[' + _inv_pay_jsonstr + ']}'
					ENDIF 
				ENDIF 
				*_inv_pay_jsonstr = CHRTRAN(_inv_pay_jsonstr, CHR(10)+CHR(13), "")
				USE IN SELECT("storellet_inv_item_tmp")
				USE IN SELECT("storellet_inv_item_tmp1")
			ENDIF 
			
			&&IF exists (select a.memberno from inv a with (nolock) left join member with (nolock) on a.memberno=member.id left join member_type with (nolock) on member.type_id=member_type.id where a.id=?lninvid AND member_type.desccn='VIP' )
			TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	
			
			INSERT INTO storellet_upload (check_valid, action, station_id, pos_shop_id, shop_code, shop_name, inv_id, invamt, paidtime, belongdate, inv_seq, create_date, member_id, inv_item_jsonstr, inv_pay_jsonstr)  
			SELECT @cloud_check_valid, ?lcaction, @station_id, @pos_shop_id, @shop_code, @shop_name, ?lninvid, invamt, paidtime, belongdate, @inv_seq, getdate(), memberno, ?_inv_item_jsonstr, ?_inv_pay_jsonstr 
			from inv with (nolock) where  id=?lninvid
			
			ENDTEXT 
		
		ENDIF 
		
		If SQLExec(nhand, dbsql)<0 
			Aerror(err)
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			IF __debug_mode 
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			RETURN .F.
		ENDIF
		
		IF lcaction == "Del_inv_storellet" 
		
			TEXT TO dbsql NOSHOW TEXTMERGE 
				SELECT id,disc_remark from  inv_disc with (nolock) where id=?lninvid AND disc_id=-8 UNION ALL SELECT  id,disc_remark from  inv_itemdisc with (nolock) where id=?lninvid AND disc_id=-8 
				SELECT a.memberno, b.cardno FROM inv a with (nolock) left join member b with (nolock) on a.memberno=b.id WHERE a.id=?lninvid 
			ENDTEXT 
			
			If SQLExec(nhand, dbsql, "storellet_del_inv_tmp")<0 
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				IF __debug_mode 
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				ENDIF 
				RETURN .F.
			ENDIF
			
			lnmember_id = storellet_del_inv_tmp1.memberno
			*lcmember_carno_inv = ALLTRIM(storellet_del_inv_tmp1.cardno)
			USE IN SELECT("storellet_del_inv_tmp1")
			SELECT storellet_del_inv_tmp
			SCAN 
				_disc_remark = "," + ALLTRIM(disc_remark) + ","
				IF RECNO()=1
					lcmember_carno = STREXTRACT(_disc_remark, ",", ",",1)
				ENDIF 
				lccoupon_id = STREXTRACT(_disc_remark, ",", ",",2)
	*!*				IF !lcmember_carno==lcmember_carno_inv
	*!*					Sqlrollback(nhand)
	*!*					SQLSetprop(nhand,"Transactions",1)
	*!*					USE IN SELECT("storellet_del_inv_tmp")
	*!*					lcmsg = "INV:"+TRANSFORM(lninvid)+", member_carno_inv:"+lcmember_carno_inv+", member_carno:"+lcmember_carno
	*!*					write_log(111, "Void INV Unredeem, "+lcmsg)
	*!*					fmessagebox("µo²¼·|­û»P§é¦©·|­û¤£¤@­P¡A§R°£µo²¼¥¢±Ñ¡I"+CHR(13)+lcmsg) 
	*!*					RETURN .F.
	*!*				ENDIF 
				_llnull = .null.
				TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 	
				
				INSERT INTO storellet_upload (check_valid, action, station_id, pos_shop_id, shop_code, shop_name, inv_id, invamt, paidtime, belongdate, inv_seq, create_date, member_id, coupon_id, member_carno)  
				values (@cloud_check_valid, 'unredeem2', @station_id, @pos_shop_id, @shop_code, @shop_name, ?lninvid, ?_llnull, ?_llnull, ?_llnull, @inv_seq, getdate(), ?lnmember_id, ?lccoupon_id, ?lcmember_carno)
				
				ENDTEXT 
				If SQLExec(nhand, dbsql_head+CHR(13)+dbsql)<0 
					Aerror(err)
					Sqlrollback(nhand)
					SQLSetprop(nhand,"Transactions",1)
					IF __debug_mode 
						error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
					ENDIF 
					USE IN SELECT("storellet_del_inv_tmp")
					RETURN .F.
				ENDIF
				
			ENDSCAN 
			USE IN SELECT("storellet_del_inv_tmp")
		ENDIF 

	ELSE &&"Del_order_storellet"
		&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h
		IF VARTYPE(__cloud_member)#"U" AND __cloud_member AND lnorderid>0
			If SQLExec(nhand, "select a.memberno,b.cloud_plat from order_main a with (nolock) left join member b with (nolock) on a.memberno=b.id where a.id=?lnorderid", "storellet_inv_item_tmp")<0 
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				IF __debug_mode 
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				ENDIF 
				RETURN .F.
			ENDIF
			IF RECCOUNT("storellet_inv_item_tmp")>0 AND NVL(storellet_inv_item_tmp.memberno, 0)>0 AND !TRIM(NVL(storellet_inv_item_tmp.cloud_plat, ""))=="storellet"
				USE IN SELECT("storellet_inv_item_tmp")
				RETURN 
			ENDIF 
			USE IN SELECT("storellet_inv_item_tmp")
		ENDIF 

		IF VARTYPE(_lnDel_order_storellet_memb_id)#"U"
			lnmember_id = _lnDel_order_storellet_memb_id
			SELECT disc_remark FROM item_disc_tmp WHERE disc_id=-8 UNION ALL SELECT disc_remark FROM order_disc_tmp WHERE disc_id=-8 INTO CURSOR storellet_del_order_tmp
		ELSE 
			TEXT TO dbsql NOSHOW TEXTMERGE 
				SELECT  id, disc_remark from  order_disc with (nolock) where id=?lnorderid AND disc_id=-8
				SELECT a.memberno, b.cardno FROM order_main a with (nolock) left join member b with (nolock) on a.memberno=b.id WHERE a.id=?lnorderid 
			ENDTEXT 
			
			If SQLExec(nhand, dbsql, "storellet_del_order_tmp")<0 
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				IF __debug_mode 
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				ENDIF 
				RETURN .F.
			ENDIF

			lnmember_id = storellet_del_order_tmp1.memberno
			*lcmember_carno_inv = ALLTRIM(storellet_del_order_tmp1.cardno)
			USE IN SELECT("storellet_del_order_tmp1")
		ENDIF 
		
		SELECT storellet_del_order_tmp
		SCAN 
			_disc_remark = "," + ALLTRIM(disc_remark) + ","
			IF RECNO()=1
				lcmember_carno = STREXTRACT(_disc_remark, ",", ",",1)
			ENDIF 
			lccoupon_id = STREXTRACT(_disc_remark, ",", ",",2)
*!*				IF !lcmember_carno==lcmember_carno_inv
*!*					Sqlrollback(nhand)
*!*					SQLSetprop(nhand,"Transactions",1)
*!*					USE IN SELECT("storellet_del_order_tmp")
*!*					lcmsg = "INV:"+TRANSFORM(lninvid)+", member_carno_inv:"+lcmember_carno_inv+", member_carno:"+lcmember_carno
*!*					write_log(111, "Void INV Unredeem, "+lcmsg)
*!*					fmessagebox("µo²¼·|­û»P§é¦©·|­û¤£¤@­P¡A§R°£µo²¼¥¢±Ñ¡I"+CHR(13)+lcmsg) 
*!*					RETURN .F.
*!*				ENDIF 
			
			&&Lihong 2023.04.27 ¦P®É¥Î¥ÕªZ¤h
			IF EMPTY(lcmember_carno) OR EMPTY(lccoupon_id)
				LOOP 
			ENDIF 
			
			_llnull = .null.
			TEXT TO dbsql NOSHOW TEXTMERGE 	
			
			INSERT INTO storellet_upload (check_valid, action, station_id, pos_shop_id, shop_code, shop_name, inv_id, invamt, paidtime, belongdate, inv_seq, create_date, member_id, coupon_id, member_carno)  
			values (@cloud_check_valid, 'unredeem2', @station_id, @pos_shop_id, @shop_code, @shop_name, ?lninvid, ?_llnull, ?_llnull, ?_llnull, @inv_seq, getdate(), ?lnmember_id, ?lccoupon_id, ?lcmember_carno)
			
			ENDTEXT 
			
*!*				TRY 
*!*				STRTOFILE(dbsql_head+CHR(13)+dbsql,"d:\x\storellet.txt")
*!*				CATCH
*!*				ENDTRY 
			
			If SQLExec(nhand, dbsql_head+CHR(13)+dbsql)<0 
				Aerror(err)
				Sqlrollback(nhand)
				SQLSetprop(nhand,"Transactions",1)
				IF __debug_mode 
					error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
				ENDIF 
				USE IN SELECT("storellet_del_order_tmp")
				RETURN .F.
			ENDIF
			
		ENDSCAN 
		USE IN SELECT("storellet_del_order_tmp")

	ENDIF 
	
	RETURN 
ENDIF 

&&Lihong 2022.12.14 storellet inv item inv_item_jsonstr
TEXT TO dbsql NOSHOW TEXTMERGE 
select a.check_valid, a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.inv_id, a.invamt, a.paidtime, a.belongdate, a.inv_seq, a.upcnt, b.cardno, a.coupon_id, a.member_carno, a.inv_item_jsonstr, a.inv_pay_jsonstr, member_type.desccn as member_vip 
from storellet_upload a WITH (nolock) left join member b with (nolock) on a.member_id = b.id left join member_type with (nolock) on b.type_id=member_type.id 
where a.inv_id = ?lninvid and ISNULL(a.upcnt,0)>=0 order by  a.inv_seq 

select a.check_valid, a.action, a.pos_shop_id, a.shop_code, a.shop_name, a.inv_id, a.invamt, a.paidtime, a.belongdate, a.inv_seq, a.upcnt, b.cardno, a.coupon_id, a.member_carno, a.inv_item_jsonstr,  a.inv_pay_jsonstr, member_type.desccn as member_vip 
from storellet_upload a WITH (nolock) left join member b with (nolock) on a.member_id = b.id left join member_type with (nolock) on b.type_id=member_type.id 
where a.inv_id in (select inv_id from storellet_upload WITH (nolock) where station_id=?__station_id and inv_id <>?lninvid and ISNULL(a.upcnt,0)>=0) order by a.inv_id, a.inv_seq 
ENDTEXT 


If SQLExec(nhand, dbsql, "storellet_tmp")<0 
	IF __debug_mode 
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	ENDIF 
	RETURN .F.
ENDIF


LOCAL llok, i, _inv_id, _inv_no, _belongdate 
llok = .T.
FOR i = 1 TO 2 
	
	SELECT IIF(i=1, "storellet_tmp", "storellet_tmp1")
	*IF i=1 AND EMPTY(NVL(points_tmp.cardno, "")) OR EOF("points_tmp"))
		*loop
	*ENDIF 
	SCAN 
		_check_valid = check_valid
		_action = ALLTRIM(action)
		
		_pos_shop_id = TRANSFORM(pos_shop_id)
		_shop_code = ALLTRIM(shop_code)
		_shop_name = ALLTRIM(shop_name)
		
		*lninvid = inv_id
		_inv_id = ALLTRIM(TRANSFORM(inv_id)) 
		_inv_no = ALLTRIM(TRANSFORM(inv_id))
		
		_belongdate = CHRTRAN(TRANSFORM(belongdate), "/", "-")
		_inv_amount = TRANSFORM(invamt) 
		_paidtime = CHRTRAN(TRANSFORM(paidtime), "/", "-")
		_inv_seq = inv_seq
		
		_cardno = ALLTRIM(NVL(cardno, ""))
		_coupon_id = ALLTRIM(NVL(coupon_id,""))
		
		IF "redeem" $ _action
			_cardno = ALLTRIM(member_carno)
		ELSE 
			&&Lihong 2023.06.06
			_storellet_memb_vip="VIP"
			IF VARTYPE(__storellet_cust_type)#"U" AND !EMPTY(__storellet_cust_type)
				_storellet_memb_vip = UPPER(__storellet_cust_type)
			ENDIF 
			IF !EMPTY(_cardno) AND !UPPER(ALLTRIM(NVL(member_vip,""))) == _storellet_memb_vip &&rms6·|­û¤]¤W¶Ç
				_cardno = ""
			ENDIF 
		ENDIF 

	&&Lihong 2022.12.14 storellet inv item inv_item_jsonstr
	lcinv_item_jsonstr = ""
	lcinv_pay_jsonstr = ""
	IF LOWER(_action) == "add_inv_storellet" OR LOWER(_action) == "update_inv_storellet"
		lcinv_item_jsonstr = NVL(inv_item_jsonstr, "")
		lcinv_pay_jsonstr = NVL(inv_pay_jsonstr, "")
	ENDIF 
	
IF "redeem" $ _action
ELSE 		

		TEXT TO lccust_storellet TEXTMERGE NOSHOW 
{"inv":[
{ "check_valid":"<<_check_valid>>", "pos_shop_id":"<<_pos_shop_id>>", "shop_code":"<<_shop_code>>", "shop_name":"<<_shop_name>>",
 "id":"<<_inv_id>>", "belongdate":"<<_belongdate>>", "invamt":<<_inv_amount>>, "paidtime":"<<_paidtime>>", "cust_code":"<<_cardno>>"}
]}
		 ENDTEXT 

		lccust_storellet = CHRTRAN(lccust_storellet, CHR(10)+CHR(13), "")
ENDIF 

		TRY  
		*STRTOFILE(lccust_storellet,"d:\t\storellet.txt")
		CATCH 
		ENDTRY 
		 
		*!*	4 ¤W¶Çµo²¼, °O¿ý®ø¶O¿n¤À
		*!*	/Proan/Upload_cust_points
		*!*	°Ñ¼Æ merchant_area, bmerchant_id, merchant_id, merchant_valid_code
		*!*	¶Ç¤Jªí cust_points ¥]§tµo²¼¬ÛÃö¦r¬q«H®§¦p¤U
		*!*	pos_shop_id,
		*!*	shop_code,
		*!*	shop_name
		*!*	inv_id bitint
		*!*	inv_no int
		*!*	cust_code ·|­û¥d¸¹
		*!*	belongdate µo²¼¤é´Á
		*!*	shop_code ¤À©±½s¸¹ x
		*!*	shop_name ¤À©±¦WºÙ x
		*!*	points ¿n¤À
		*!*	earn_points 
		*!*	redeem_points
		*!*	adj_points
		*!*	inv_amount µo²¼ª÷ÃB
		*!*	inv_qty À³¸Ó¬Oµo²¼±i¼Æ x
		*!*	check_valid ­q³æÀH¾÷½X
		*!*	ªð¦^°Ñ¼Æ upload_result 1 ¤W¶Ç¦¨¥\, 0 ¤W¶Ç¥¢±Ñ

		*_run_mode = "fastfood"  AND VARTYPE(__proan_web_order_call) ¨Ï¥Î
		TEXT TO dbsql NOSHOW TEXTMERGE 
			UPDATE storellet_upload SET upcnt = ISNULL(upcnt,0) +1, up_date=getdate() where check_valid = ?_check_valid AND inv_seq=?_inv_seq
		ENDTEXT 
		IF sqlexec(nhand, dbsql) < 0
			IF __debug_mode 
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF
	
		IF "redeem" $ _action
			IF exec_storellet_api_redeem(_action, _cardno, _coupon_id) = .F.
				IF __debug_mode 
					*fmessagebox(oCMapi.error_message)  &&getmessage()
				ENDIF 
				llok = .F. 
				EXIT 
			ENDIF 
			lcresult = oCMapi.get_value("check_result")
			IF !lcresult=="1"
				lcerrmsg = lcresult
				IF lcresult == "-1" 
					lcerrmsg = lcerrmsg + ":" + oCMapi.get_value("message")
				ENDIF 
				write_log(88,"tbl:"+IIF(VARTYPE(_tableno)="C", _tableno, "") + ", check_valid:" + _check_valid + ", unredeem: Fail, " + "message:"+lcerrmsg +  ", member_code:" + _cardno + ", coupon_id:" + _coupon_id)
			ENDIF 
		ELSE 
			IF exec_storellet_api(_action, lccust_storellet, _inv_id) = .F.
				IF __debug_mode 
					*fmessagebox("¤W¶Ç¿n¤À¿ù»~¡A±N«áÄò¤W¶Ç" + CHR(13) + oCMapi.error_message)  &&getmessage()
				ENDIF 
				llok = .F. &&LOOP ¤£LOOP¥H«OÃÒ¶¶§Ç°õ¦æ
				*SELECT IIF(i=1, "storellet_tmp", "storellet_tmp1")
				*LOCATE FOR VAL(inv_id) <> VAL(_inv_id) REST &&Ä~Äò«á­±inv
				EXIT 
			ENDIF 
			lcresult = oCMapi.get_value("upload_result") &&1 ¦¨¥\ 0 ¥¢±Ñ
		ENDIF 
		
		IF !lcresult=="1"
			=sqlexec(nhand, "UPDATE storellet_upload SET upresult = LEFT(ISNULL(upresult,'') + ',' + CONVERT(varchar(10),upcnt) + ':' + ?lcresult, 250) where check_valid = ?_check_valid AND inv_seq=?_inv_seq" )
			IF __debug_mode 
				*fmessagebox("¶³ºÝ³B²z¿n¤Àªð¦^¿ù»~" )  &&getmessage()
			ENDIF 
		
			
			llok = .F. &&LOOP ¤£LOOP¥H«OÃÒ¶¶§Ç°õ¦æ
			*SELECT IIF(i=1, "storellet_tmp", "storellet_tmp1")
			*LOCATE FOR VAL(inv_id) <> VAL(_inv_id) REST &&Ä~Äò«á­±inv
			EXIT 
		ENDIF 

		TEXT TO dbsql ADDITIVE NOSHOW TEXTMERGE 
			UPDATE storellet_upload SET upcnt = -ISNULL(upcnt, 1), up_date=getdate() where check_valid = ?_check_valid AND inv_seq=?_inv_seq
			/* DELETE storellet_upload where check_valid = ?_check_valid */ 
			 DELETE storellet_upload where upcnt<0 AND datediff(dd, up_date, getdate())>6 
		ENDTEXT 

		IF sqlexec(nhand, dbsql) < 0
			IF __debug_mode 
				Aerror(err)
				error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
			ENDIF 
			llok = .F.
			EXIT 
		ENDIF


	ENDSCAN 
	IF llok = .F.
		EXIT 
	ENDIF 
ENDFOR 

RETURN 
ENDFUNC

&&Lihong 2022.04.19 ¤W¶Çinv¨ìstorellet
FUNCTION exec_storellet_api
LPARAMETERS lccmd, lccust_storellet, lcinvid

IF TYPE("oCMapi") != "O"
	SET CLASSLIB TO class\invoice_base ADDITIVE 
	PUBLIC oCMapi
	oCMapi = CREATEOBJECT("cloud_member_api")
ENDIF 

oCMapi.clear_info()
oCMapi.api_name = lccmd

*DO CASE 
*CASE lccmd == "upload_cust_points"
	oCMapi.api_remark = "invid:" + lcinvid &&¤é»x¥Î
	oCMapi.set_value("inv", lccust_storellet)

	&&Lihong 2022.12.14 storellet inv item inv_item_jsonstr
	IF LOWER(lccmd) == "add_inv_storellet" OR LOWER(lccmd) == "update_inv_storellet" AND !EMPTY(lcinv_item_jsonstr)
		oCMapi.set_value("inv_item", lcinv_item_jsonstr)
	ENDIF 
	IF LOWER(lccmd) == "add_inv_storellet" OR LOWER(lccmd) == "update_inv_storellet" AND !EMPTY(lcinv_pay_jsonstr)
		oCMapi.set_value("payways", lcinv_pay_jsonstr)
	ENDIF 
*ENDCASE 

oCMapi.api_run("storellet")
IF oCMapi.status <> 1 && + getmessage("_get_cust_info_error") + CHR(13)
	IF __debug_mode 
		*fmessagebox(getmessage("_require_member_no") + CHR(13) + oCMapi.error_message)
	ENDIF 
	RETURN .F.
ENDIF 
*
ENDFUNC

&&Lihong 2022.06.01 storellet §I´«/ºM®ø§I´«
FUNCTION exec_storellet_api_redeem
LPARAMETERS lccmd, lcmember_code, lccoupon_id

IF TYPE("oCMapi") != "O"
	SET CLASSLIB TO class\invoice_base ADDITIVE 
	PUBLIC oCMapi
	oCMapi = CREATEOBJECT("cloud_member_api")
ENDIF 

oCMapi.clear_info()
oCMapi.api_name = IIF(lccmd=="redeem", "Redeem_coupon_storellet", "Revoke_redeemed_coupon_storellet")

*DO CASE 
*CASE lccmd == "redeem"
	oCMapi.api_remark = "cust_code:" + lcmember_code + ",coupon_id:" + lccoupon_id &&¤é»x¥Î
	oCMapi.set_value("cust_code", lcmember_code)
	oCMapi.set_value("coupon_id", lccoupon_id)
	
*ENDCASE 
oCMapi.api_run("storellet")
IF oCMapi.status <> 1 && + getmessage("_get_cust_info_error") + CHR(13)
	IF __debug_mode 
		*fmessagebox(getmessage("_require_member_no") + CHR(13) + oCMapi.error_message)
	ENDIF 
	RETURN .F.
ENDIF 
*
ENDFUNC


*************************************************************************
* Description: To return the string of checked items from cursor 
* Parameters: pCr is a cursor name, Result is a return string
* Last amend date: 23 April, 2008
* Author: andrewyeung
*************************************************************************
FUNCTION get_checked_string
LPARAMETERS pCr, pOnce, presult_name

IF PCOUNT() = 1
	pOnce	= .F.
ENDIF
 

IF !pOnce
	
	SELECT * FROM &pCr WHERE checked = .f. INTO CURSOR cr_checked
	IF _tally > 0
		SELECT * FROM &pCr WHERE checked = .t. INTO CURSOR cr_checked

		cComma = ""
		result = ""
		&presult_name = ""
		GO TOP IN "cr_checked"
		DO WHILE NOT EOF("cr_checked")
			IF NOT EOF("cr_checked")
				result = result + cComma + ALLTRIM(cr_checked.code)
				&presult_name = &presult_name+ cComma  + ALLTRIM(cr_checked.name)
				
			ENDIF 		
			cComma = ","
			SKIP IN "cr_checked"
		ENDDO 
	ELSE
		result = "All"
		&presult_name = "All"	
	ENDIF

	IF USED("cr_checked")
		USE IN "cr_checked"
	ENDIF 
ELSE
	SELECT * FROM &pCr WHERE checked = .t. INTO CURSOR cr_checked

	cComma = ""
	result = ""
	&presult_name = ""
	GO TOP IN "cr_checked"
	DO WHILE NOT EOF("cr_checked")
		IF NOT EOF("cr_checked")
			result = result + cComma + ALLTRIM(cr_checked.code)
			&presult_name = &presult_name + cComma + ALLTRIM(cr_checked.name)
		ENDIF 		
		cComma = ","
		SKIP IN "cr_checked"
	ENDDO 
	
	IF USED("cr_checked")
		USE IN "cr_checked"
	ENDIF 
ENDIF 	

RETURN result
ENDFUNC 



*************************************************************************
* Description: To upate cursor and checked with string you passed
* Parameters: pCr is a cursor name, pStr the string you wanted to update
* Last amend date: 23 April, 2008
* Author: andrewyeung
*************************************************************************
FUNCTION update_checked_with_string
LPARAMETERS pCr, pStr, pLenzero

pStr = ALLTRIM(pStr)

result = .F.

_Lenzero = 0
IF VARTYPE(pLzero) = "N"
	_Lenzero = pLenzero
ENDIF 

I = 1		&& string character
cStrCode = ""			&& the code you want to update it

IF pStr = "*" OR UPPER(ALLTRIM(pStr)) = "ALL"
	UPDATE &pCr SET checked = .t. 
	result = .T.
ENDIF 

IF !EMPTY(pStr)
	=ALINES(sCodes, pStr, ",")
	FOR i = 1 TO ALEN(sCodes)
		_chkCode = ALLTRIM(LOWER(sCodes[i]))
		IF _Lenzero > 0
			_chkCode = PADL(alltrim(_chkCode), _Lenzero, "0")
		ENDIF 
		
		UPDATE &pCr  SET checked = .t. WHERE ALLTRIM(LOWER(&pCr..code)) == _chkCode &&ALLTRIM(LOWER(sCodes[i]))
	ENDFOR 
ELSE 
	RETURN .f.
ENDIF 
*!*	DO WHILE I <= LEN(pStr)
*!*		IF SUBSTR(pStr, I, 1) <> ","
*!*			cStrCode = cStrCode + SUBSTR(pStr, I, 1)
*!*			cStrCode = ALLTRIM(cStrCode)
*!*		ELSE 
*!*			UPDATE &pCr  SET checked = 1 WHERE ALLTRIM(&pCr..code) == ALLTRIM(cStrCode)
*!*			cStrCode = ""
*!*			result = .F.
*!*		ENDIF
*!*		I = I + 1
*!*	ENDDO

*!*	IF cStrCode <> ""				&& update the last code
*!*		UPDATE &pCr  SET checked = 1 WHERE ALLTRIM(LOWER(&pCr..code)) == ALLTRIM(LOWER(cStrCode))
*!*		result = .T.
*!*	ENDIF 

RETURN ALEN(sCodes) > 0
ENDFUNC  



*--------------		&&¨t²Î¾Þ§@debug°O¿ý
Function write_debug_log
Lparameters cAction, lnstep 		&&pcode ¥i¥H¬O½sµ{¥N½X,¤]¥i¥H¬OID,cAction ¬O

If Parameters()=0 OR nhand<=0 OR !(VARTYPE(__write_debug_log)#"U" AND __write_debug_log)
	Return
Endif

Local _id,_action,_version
If Vartype(cAction)#"C"
	_action="" 
Else
	_action=Trim(cAction) 
Endif
_action = _action + " Step:" +TRANSFORM(lnstep) + ", Seconds:" + TRANSFORM(SECONDS())

_id=-1

If Vartype(_android_station)="C"

	_station=_android_station

Else

	_station=getcomputername()


Endif


	_version=Iif(Vartype(__exe_version)="U","",__exe_version)

	If Vartype(_android_station)="C"

		ssql="insert into sys_log (station,adduser,datetime,log_id,action,auth_by,auth_what,station_time) values (?_station,?_login_user_name,getdate(),?_id,?_action,'android',?_version,?DATETIME())"

	Else

		ssql="insert into sys_log (station,adduser,datetime,log_id,action,station_time) values (?_station,?_login_user_name,getdate(),?_id,?_action,?DATETIME())"


	Endif

	If SQLExec(nhand,ssql)<0		&&¼g¤J¾Þ§@¤é»x,¤£½×¬O§_¼g¤J¦¨¥\
		Aerror(err)

		If __debug_mode

			Messagebox("error:"+err(2))


		Endif


	Endif


Return

ENDFUNC


*---­pºâform¥i©ñ¤jªºªø¼e---* by sam 
Function calc_monitor_resize
Lparameters pForm		

*!*	If Parameters()=0 &&OR nhand<=0
*!*		RETURN .f.
*!*	ENDIF

*!*	_org_width = &pwidth
*!*	_org_height = &pheight

IF TYPE("main") = "O" AND main.BaseClass $ "Form"
	_pw = main.width
	_ph = main.height
	
ELSE
	_pw = _screen.width
	_ph = _screen.height
ENDIF

_ph = _Ph - SYSMETRIC(9) - SYSMETRIC(20)

	
IF pForm.width >= _pw OR pForm.height >=_ph
	RETURN .f.
ENDIF 




LOCAL _hmargin, _vmargin
_hmargin = 4
_vmargin = 2
	
WITH pForm
	
	_adj_h  = _ph  - .Height - 2
	_adj_h = Max(0, _adj_h)
	_adj_w = FLOOR(_adj_h *  (.Width / .Height))
	
	IF (.width + _adj_w) >= (_pw -_vmargin)
		_adj_w = _pw - .width - SYSMETRIC(4)*2 - _vmargin*2	- 3
		_adj_w = Max(0, _adj_w)
		_adj_h  = FLOOR(_adj_w * (.Height / .Width))
		
		.height = .height + _adj_h
		.width   = MIN(.width + _adj_w, _pw -_vmargin * 2)  
		
		.left = _vmargin + SYSMETRIC(4)
		.top = FLOOR((_ph -  .height) /2) - SYSMETRIC(4)
	ELSE
		.height = .height + _adj_h
		.width   = .width + _adj_w 
		
		.left = FLOOR((_pw - .width)/2 )
		.top = _hmargin * 2
		
	ENDIF 
ENDWITH  



RETURN .t.

ENDFUNC

*---ÀË¬dview¬O§_¦s¦b---* by sam 
Function check_view_exist

TEXT TO cmd noshow	
	select count(1) as viewcol  
		where  not exists (select * from sysobjects where name='inv_view')
			or not exists (select * from sysobjects where name='inv_disc_view')
			or not exists (select * from sysobjects where name='inv_detail_view')
			or not exists (select * from sysobjects where name='inv_itemdisc_view')
			or not exists (select * from sysobjects where name='inv_modi_view')
			or not exists (select * from sysobjects where name='inv_pay_view')
ENDTEXT


If SQLExec(nhand, cmd, "cr_chkview_tmp") < 0
	IF __debug_mode 
		Aerror(err)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
	ENDIF 
	RETURN .f.			
ENDIF
_viewcount = cr_chkview_tmp.viewcol  
USE IN "cr_chkview_tmp"

IF _viewcount > 0 
	IF SQLEXEC(nhand,"exec create_inv_view '', '1900-01-01', '2099-12-31' ") < 0
		IF __debug_mode 
			Aerror(err)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		ENDIF 
		RETURN .f.
	ENDIF 
ENDIF 

RETURN .t.
ENDFUNC

*-------------------------------------------------------------------------------------------
* Function Name  : f0chkChr()
* Desc			 : Check Chr is Correct 
*				   only can input this char "ABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789"
* Parameters     : cInput
*				 : lType = 0 or no parameter 0-9, a-z and _ only		fmessagebox("_0_9_a_z")
*				 : lType = 1 0-9, a-z and symbols						fmessagebox("_symbol_only")
*				 : lType = 1 0-9 only									fmessagebox("_0_9_only")
*				 : lType = 9 check cInput cannot contain ' or "			fmessagebox("_cannot_quote")
* Return		 : .T. / .F. 
*------------------------------------------------------------------------------------------
FUNCTION f0chkChr
LPARAMETERS cInput , lType
cInput = ALLTRIM(cInput)

IF PCOUNT() = 0
	RETURN .F.
ENDIF 

IF PCOUNT() = 1
	lType = 0
ENDIF 

IF VARTYPE(cInput) != "C"
	RETURN .F.
ENDIF 

LOCAL lcBase, l_Result, nFor 

DO case
	CASE lType = 0
		lcBase		= "ABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789-"

	CASE lType = 1
		lcBase		= "ABCDEFGHIJKLMNOPQRSTUVWXYZ ~!@#$%^&*()`_+-=[]\{}|;:<>?,./0123456789"

	CASE lType = 2
		lcBase		= "0123456789"

	CASE lType = 3
		lcBase		= "0123456789-()"

	CASE lType = 4
		lcBase		= "ABCDEFGHIJKLMNOPQRSTUVWXYZ _0123456789-"


*2020-04-09 chris for imp_item check price1-5
	CASE lType = 5
		lcBase		= "0123456789."		


*2022-04-12 chris add type 6 & 7 for ciao he order, call from form\ford_import_he
	CASE lType = 6
		lcBase		= "1234567"		

	CASE lType = 7
		lcBase		= "/1234567"


	OTHERWISE 
		lcBase		= "ABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789"
ENDCASE


l_Result	= .T.


* 2010-10-13
* ¦P©÷¤­ª÷ & far ease ­n¨D item code ¥i¤J ' ¤Î "
* ©ó setup_item fadj fii µ¥¥i¤¹³\¿é¤J, ¥[¤@­Ó type = 8
* ¦ý search & report ®É¨ÌÂÂ¤£¤¹³\¥Î ' " type 9

DO case

	CASE lType = 8
*		IF AT( "'" , cInput ) > 0 OR AT( '"' , cInput ) > 0
*			l_Result	= .F.
*		ENDIF 	
		
		l_Result	= .t.
		
		
	CASE lType = 9
		IF AT( "'" , cInput ) > 0 OR AT( '"' , cInput ) > 0
			l_Result	= .F.
		ENDIF 	

	OTHERWISE 		
		FOR nFor = 1 TO LEN(cInput)
			IF AT(UPPER(SUBSTR(cInput, nFor, 1)), lcBase) = 0
				l_Result	= .F.
				EXIT 
			ENDIF 
		ENDFOR 
ENDCASE 

	
RETURN l_Result 
ENDFUNC 

FUNCTION check_sql_hand()

LOCAL start_dtime, redo_seconds, lninterval, lnhd, lnoldhand
*!*	start_dtime = DATETIME()
*!*	redo_seconds = 35
*!*	lninterval = 3
*!*	lnhd = 0
*!*	DO WHILE DATETIME()-start_dtime < redo_seconds

	WAIT WINDOW "Check SQL Connection ..." NOWAIT 
*!*		If SQLExec(nhand,"")<=0
		*Aerror(err)
		*error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		*Return .F.
		lnhd=connect_sql()
		IF lnhd>0
			=SQLDISCONNECT(nhand)
			lnoldhand = nhand
			nhand=lnhd
			write_Log(-2,"user_access : reconnection SQL success->"+", old_hand: "+TRANSFORM(lnoldhand)+", new_hand: "+TRANSFORM(nhand) )
			WAIT CLEAR 
			RETURN 
		ELSE
			WAIT CLEAR 
			RETURN .F.
			*LOOP 
		ENDIF 
*!*		ELSE
*!*			RETURN 
*!*		ENDIF
*!*		WAIT WINDOW "Check SQL Connection ..." NOWAIT 
*!*		=inkey(lninterval, "H")
*!*	ENDDO 

ENDFUNC 


FUNCTION proan_lock
LPARAMETERS sLock_key, iLock_second
	LOCAL dbsql_tmp, bWait
	TEXT TO dbsql_tmp NOSHOW TEXTMERGE 
		CREATE TABLE lock_info(lock_key nvarchar(200), lock_station_id int, lock_time datetime)
		
		CREATE NONCLUSTERED INDEX [IX_lock_info] ON [dbo].[lock_info]
		(
			[lock_key] ASC
		)
	ENDTEXT 
	
	= SQLEXEC(nhand, dbsql_tmp)
	
	*= SQLEXEC(nhand, "alter table lock_info add lock_shop_id int null")
	*= SQLEXEC(nhand, "alter table lock_info add lock_app_name varchar(100) null")	
	
	bWait = .t.

	DO WHILE bWait	
		= SQLEXEC(nhand, "delete lock_info where getdate() > lock_time or (lock_key = ?sLock_key and lock_station_id = ?__station_id)")
		
		TEXT TO dbsql_tmp NOSHOW TEXTMERGE 
			select b.computer, a.lock_time from lock_info a (nolock)
			left join station b (nolock) on a.lock_station_id = b.id
			where a.lock_key = ?sLock_key
		ENDTEXT 

		IF SQLEXEC(nhand, dbsql_tmp, "cr_tmp11") > 0
			IF RECCOUNT("cr_tmp11") = 0			
				&& »Ý­nµ¥«ÝLOCK®É¶¡
				TEXT TO dbsql_tmp NOSHOW TEXTMERGE 
					INSERT INTO lock_info(lock_key, lock_station_id, lock_time)
					values(?sLock_key, ?__station_id, DATEADD(ss, ?iLock_second, getdate()))
				ENDTEXT 
				= SQLEXEC(nhand, dbsql_tmp)
				RETURN .t.
			ELSE 
				DO FORM form\flock_wait WITH sLock_key TO bResultExit
				IF bResultExit
					RETURN .f.
				ENDIF 
			ENDIF 	
		ELSE 
			RETURN .t.			
		ENDIF 
	ENDDO 
ENDFUNC 

FUNCTION proan_unlock
LPARAMETERS sLock_key
	IF VARTYPE(sLock_key)="C" AND !EMPTY(sLock_key) 
		lcLock_key_filter = " and lock_key = ?sLock_key"
	ELSE 
		lcLock_key_filter = ""
	ENDIF 
	*= SQLEXEC(nhand, "delete lock_info where lock_key = ?sLock_key")
	= SQLEXEC(nhand, "delete lock_info where getdate() > lock_time or (lock_station_id = ?__station_id" + lcLock_key_filter + ")" )
ENDFUNC 

&&§R°£LOG ¥Ø¿ý¤U180¤Ñ«eªº¤é»x By Waston 02/09/2022
FUNCTION delete_rms_log_file() 
	LOCAL lnLog_cnt,i,lnDeleted
	lnDeleted = 0
	lnLog_cnt = ADIR(laLog,"Log\*.txt")
	IF lnLog_cnt = 0 
		RETURN "Not found log file !"
	ENDIF 
	FOR i = 1 TO lnLog_cnt
		IF laLog(i,3) < DATE() - 180
			lcLog_File = "Log\" + laLog(i,1)
			DELETE FILE &lcLog_file
			lnDeleted = lnDeleted + 1
		ENDIF 
	ENDFOR
	IF  lnDeleted = 0 
		RETURN "No log file deleted !" 
	ELSE 
		RETURN "Deleted " + ALLTRIM(STR(lnDeleted)) + " log files !" 
	ENDIF 	
ENDFUNC  


*******************
*  && ³s±µSQL SERVER  «ölink string
********************
Function connect_sql_by
Lparameters  incase, inlinkstr

	IF VARTYPE(inlinkstr) = "C"
		csql = inlinkstr
	ELSE
		DO CASE 
			CASE incase = 1
				csql="driver=sql server;server=pds.poshk.com,7200;uid=sa;pwd=proanpossapwd;database=pos6_source"
		ENDCASE 
	ENDIF 


	=SQLSetprop(0,"displogin",3)  &&do not display error warning

	rtn_handle=Sqlstringconnect(csql)

	*Wait Clea
	IF rtn_handle<0
	*	=Messagebox("server connected  error!",48,"")
		Return -1
	Endif
	=SQLSetprop(rtn_handle,"displogin",3)

	=SQLExec(rtn_handle,"set ANSI_WARNINGS  OFF")

	Return rtn_handle

ENDFUNC


*invdetail³¡ªù¤À±b by sam 
FUNCTION load_itemdept
Lparameters Incond, Intablesrc

	LOCAL _sqlcond, _tblsrc
	_sqlcond = RTRIM(Incond)
	
	IF VARTYPE(Intablesrc)#"N"
		_tblsrc = 0
	ELSE
		_tblsrc = Intablesrc
	ENDIF
	 
	DO CASE
	CASE _tblsrc =1
		lcInv_detail = view_inv_detail
		lcInv = view_inv
	CASE _tblsrc = 2
		lcInv_detail = "inv_detail"
		lcInv = "inv"
	OTHERWISE
		lcInv_detail = "inv_detail_view"
		lcInv = view_inv
	ENDCASE
	
	LOCAL _file1 
	_file1 = "##proantmp" + SYS(2015)
	
	*=SQLEXEC(nhand,"drop table #t1")
	=SQLEXEC(nhand,"drop table #t2")
	=SQLEXEC(nhand,"drop table #t3")

	TEXT TO cmd NOSHOW TEXTMERGE  

		select item_id, uid, askdept, 
		   a.qty as qty, a.srv_per,
		   (a.amount) as org_amt,
		   (a.disc_amount+a.xdisc+a.round_amount) as disc_round, 
		   (a.srv_amount) as svc_amt,	   
		   (a.real_amount+a.round_amount+a.xdisc) as net_amt, 
		   (a.real_amount+a.round_amount+a.xdisc) as org_net_amt,    
		   inv.pplcnt, inv.id,
		   a.tax_amount 
		   into <<_file1>> from <<lcInv_detail>>  a 
		   left join <<lcInv>> inv on a.id = inv.id
		   where inv.void = 0 <<_sqlcond>>
		   --and a.id in (select aa.id from inv aa where aa.void=0 and 1=1 and aa.cln=?_clnid and aa.belongdate = '2022-09-22')	   
		 		   
		   
	update <<_file1>> set net_amt = round(net_amt, 1)  
	update <<_file1>> set disc_round = disc_round + (net_amt - org_net_amt) 
		 
	declare @calc_inv_id int declare @calc_disc numeric(18, 2) 
	declare @calc_uid numeric(18, 5) 
	declare qty_shop_temp cursor LOCAL STATIC READ_ONLY FORWARD_ONLY for   
	 	select id, calc_disc = (net_amt - org_net_amt) from (   
	 	select id, sum(net_amt) as net_amt, sum(org_net_amt) as org_net_amt from <<_file1>> group by id  
	 	) a 
	 	where net_amt <> org_net_amt 
	open qty_shop_temp  
	fetch next from qty_shop_temp into @calc_inv_id, @calc_disc 
	while @@fetch_status = 0 
	begin     
	 	set @calc_uid = (select top 1 uid from <<_file1>> where id = @calc_inv_id    
	 						order by case when disc_round = 0 then 1000000 else disc_round end, net_amt desc)  
	 	
	 	update <<_file1>> set disc_round = disc_round - @calc_disc, net_amt = net_amt - @calc_disc 
	 		where id = @calc_inv_id and uid = @calc_uid 
	 		 
		 fetch next from qty_shop_temp into @calc_inv_id, @calc_disc 
	end  
	close qty_shop_temp  
	deallocate qty_shop_temp
		   
		   
	create index ix_id_uid on <<_file1>>(id, uid)

		select newid() as new_id, 
			t1_qty = (select top 1 qty from <<_file1>> as b where b.id = a.id and b.uid = a.uid),
			t1_org_amt = (select top 1 org_amt from <<_file1>> as b where b.id = a.id and b.uid = a.uid),
			t1_disc_round = (select top 1 disc_round from <<_file1>> as b where b.id = a.id and b.uid = a.uid),
			t1_svc_amt = (select top 1 svc_amt from <<_file1>> as b where b.id = a.id and b.uid = a.uid),
			t1_net_amt = (select top 1 net_amt from <<_file1>> as b where b.id = a.id and b.uid = a.uid),
			net_amt as t3_qty,
			net_amt as t3_org_amt,
			net_amt as t3_disc_round,
			net_amt as t3_svc_amt,
			net_amt as t3_net_amt, * into #t2 
		from (
			select uid, b.dept_id, department.desccn,department.descen, ISNULL(department.disporder, 0) as disporder, 
			floor((a.qty * b.price_per / 100) * 10) / 10  as qty,
			floor((a.org_amt * b.price_per / 100 ) * 10) / 10 as org_amt ,
			floor((a.disc_round * b.price_per / 100) * 10) / 10 as disc_round ,
			floor((a.svc_amt * b.price_per / 100) * 10) / 10 as svc_amt,
			floor((a.net_amt * b.price_per / 100) * 10) / 10 as net_amt,
			--floor((a.tax_amount * b.price_per / 100) * 10) / 10 as tax_amt,
			(a.qty * b.price_per / 100 * item.cost) as cost, a.pplcnt,a.id 
			from <<_file1>> a
			left join itemdept b on a.item_id = b.item_id
			left join item on a.item_id = item.id
			left join department on b.dept_id = department.id
			where not exists(select id from inv_itemdept bb (nolock) where bb.id = a.id and bb.parent_id = a.uid)
		union all 

			 select uid, b.dept_id, department.desccn,department.descen, ISNULL(department.disporder, 0) as disporder,
			  floor((a.qty * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end ) * 10) / 10  as qty,
			  floor((a.org_amt * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end ) * 10) / 10 as org_amt , 
			  floor((a.disc_round * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end ) * 10) / 10 as disc_round,
			  floor((a.svc_amt * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end ) * 10) / 10 as svc_amt,
			  floor((b.amount + b.srvamt + a.disc_round * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end ) * 10) / 10 as net_amt,
			  --floor((a.tax_amount * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end ) * 10) / 10  as tax_amt,
			  (a.qty * case a.org_amt when 0 then 0 else ISNULL(b.amount,0) / a.org_amt end * item.cost) as cost, a.pplcnt,a.id 
			  from <<_file1>> a
			  left join inv_itemdept b on a.id = b.id and a.uid = b.Parent_id and a.item_id = b.item_id 
			  left join item on a.item_id = item.id
			  left join department on b.dept_id = department.id
				--where ISNULL(a.askdept, 0) = 1 and a.id in (select id from inv_itemdept)
			where exists(select id from inv_itemdept bb (nolock) where bb.id = a.id and bb.parent_id = a.uid)
		) a
		    
	
		select id, uid, count(uid) as multi_count, sum(qty) as qty, sum(org_amt) as org_amt, sum(disc_round) as disc_round, 
		sum(svc_amt) as svc_amt, sum(net_amt) as net_amt into #t3 from #t2 group by id, uid

		create index ix_id_uid on #t3(id, uid)
		create index ix_new_id on #t2(new_id)

		update #t2 set 
			t3_qty = (select top 1 qty from #t3 as b where b.id = #t2.id and b.uid = #t2.uid),
			t3_org_amt = (select top 1 org_amt from #t3 as b where b.id = #t2.id and b.uid = #t2.uid),
			t3_disc_round = (select top 1 disc_round from #t3 as b where b.id = #t2.id and b.uid = #t2.uid),
			t3_svc_amt = (select top 1 svc_amt from #t3 as b where b.id = #t2.id and b.uid = #t2.uid),
			t3_net_amt = (select top 1 net_amt from #t3 as b where b.id = #t2.id and b.uid = #t2.uid),	
			net_amt = org_amt + disc_round + svc_amt

		declare @new_id uniqueidentifier
		declare @inv_id int
		declare @uid numeric(10, 5)
		declare @last_inv_id int
		declare @last_uid numeric(10, 5)

		declare qty_recalc_temp cursor LOCAL STATIC READ_ONLY FORWARD_ONLY for 
			select new_id, id, uid from #t2 a 
				where exists(select * from #t3 b where b.id = a.id and b.uid = a.uid and multi_count >= 1)
				order by id, uid, disporder, dept_id

		set @last_inv_id = 0
		set @last_uid = 0
		open qty_recalc_temp 
		fetch next from qty_recalc_temp into @new_id, @inv_id, @uid
		while @@fetch_status = 0
		begin 	
			-- first
			if (@last_inv_id <> @inv_id or @last_uid <> @uid)
			begin
				update #t2 set 
					qty = qty + t1_qty - t3_qty,
					org_amt = org_amt + t1_org_amt - t3_org_amt,
					disc_round = disc_round + t1_disc_round - t3_disc_round,
					svc_amt = svc_amt + t1_svc_amt - t3_svc_amt,
					net_amt = net_amt + t1_org_amt - t3_org_amt + t1_disc_round - t3_disc_round + t1_svc_amt - t3_svc_amt
				where new_id = @new_id

				set @last_inv_id = @inv_id
				set @last_uid = @uid
			end
			fetch next from qty_recalc_temp into @new_id, @inv_id, @uid
		end 

		close qty_recalc_temp 
		deallocate qty_recalc_temp 
		
		
		update #t2 set svc_amt = round(svc_amt, 1), org_amt = ROUND(org_amt , 1),  disc_round = disc_round + (svc_amt - round(svc_amt, 1)) + (org_amt - ROUND(org_amt , 1))

		select * from #t2

	
	ENDTEXT
	
	TRY 
		= STRTOFILE(cmd, "sqlReport_pubpro_itemdept.txt")
		CATCH TO loTmpError 
	ENDTRY 
	
	If SQLExec(nhand, cmd, "cun_itemdept")<0
		Aerror(err)
		frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return.f.
	ENDIF
	

	&&¬O§_Âà²¾ªA°È¶O
	IF VARTYPE(__srv_as_dept)#"U" and __srv_as_dept  
		IF USED("cun_itemdept_plusone_qty")
			USE IN "cun_itemdept_plusone_qty"
		ENDIF 
	
		&&	
		Local _plusOne_dept_id
		_plusOne_dept_id  = 0
		SELECT cun_tmp7
		LOCATE FOR srv_to_dept = .t.
		IF FOUND()
			_plusOne_dept_id = cun_tmp7.id
		ELSE
			GO TOP IN "cun_tmp7"
			LOCATE FOR desccn = "¥[¤@"
			IF FOUND()
				_plusOne_dept_id = cun_tmp7.id
			ENDIF 
		ENDIF 		
	
		IF _plusOne_dept_id > 0
			*¥[¤@®É »Ý­n­pºâ¼Æ¶q	
		 	TEXT TO sph_sql NOSHOW TEXTMERGE
				select id 
				 from <<_file1>> a
				 where (a.svc_amt > 0  OR a.srv_per > 0)
				 	OR exists(select id from inv_itemdept bb (nolock) where bb.id = a.id and bb.parent_id = a.uid and bb.dept_id = ?_plusOne_dept_id )
				 	OR exists(select id from itemdept cc (nolock) where cc.item_id = a.item_id and cc.dept_id = ?_plusOne_dept_id )
					
			ENDTEXT
			IF SQLEXEC(nhand, sph_sql, "cun_itemdept_plusone_qty") < 0
				aerror(err)
				frm_wait.Hide
				error_catch(getmessage("_sqlserver_error"),ALLTRIM(STR(err(1))),TRIM(err(2)),PROGRAM(),LINENO(1))
				Return.f.
			ENDIF
		ENDIF  
	ENDIF 
	
	

	=SQLEXEC(nhand,"drop table " + _file1)
	=SQLEXEC(nhand,"drop table #t2")
	=SQLEXEC(nhand,"drop table #t3")
	
	RETURN .t.
	
ENDFUNC 

&&Donald 2022.10.21
FUNCTION write_log_tran_inv
	LPARAMETERS _id, _Action
	 write_log(_id, LEFT(ALLTRIM(_Action), 200))
ENDFUNC 

&&Lihong 2023.06.16
FUNCTION get_oct_invid()
	LOCAL _oct_invid, ssql 
	_oct_invid=-1
	
	TEXT TO ssql noshow														
		IF NOT exists (select type from sys_options where type='oct_inv'   )
		begin
		declare @nid int
		select @nid=max(a.id) from (select isnull(max(oct_invID),0) as id from inv_view union select isnull(max(oct_invID),0) as id from deposit UNION select isnull(max(aa_sub_oct_invID),0) as id from inv_pay_view) a
		insert into sys_options (defavalue,type,active,disporder,update_date) values (@nid ,'oct_inv',1,0,'1900-01-01')
		end
	ENDTEXT

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		*Sqlrollback(nhand)
		*SQLSetprop(nhand,"Transactions" ,1)
		*frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif

	TEXT TO ssql noshow
		IF  exists (select type from sys_options where type='oct_inv' and defavalue<(select isnull(max(a.id),0) from (select isnull(max(oct_invID),0) as id from inv union select isnull(max(oct_invID),0) as id from deposit UNION select isnull(max(aa_sub_oct_invID),0) as id from pay_detail) a)  )
		update sys_options set defavalue=(select isnull(max(a.id),0) from (select isnull(max(oct_invID),0) as id from inv union select isnull(max(oct_invID),0) as id from deposit UNION select isnull(max(aa_sub_oct_invID),0) as id from pay_detail) a) where type='oct_inv'
	ENDTEXT

	If SQLExec(nhand,ssql)<0
		Aerror(err)
		*Sqlrollback(nhand)
		*SQLSetprop(nhand,"Transactions" ,1)
		*frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif
	
	&&Lihong 2020.01.17 cloud_check_valid 
	ssql="select ISNULL(MAX(defavalue),0) as max_id from sys_options where  type='oct_inv' "

	If SQLExec(nhand,ssql,"cun_tmp_oct_inv")<0
		Aerror(err)
		*Sqlrollback(nhand)
		*SQLSetprop(nhand,"Transactions" ,1)
		*frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif

	_oct_invid=cun_tmp_oct_inv.max_id+1
	USE IN SELECT("cun_tmp_oct_inv")

	If SQLExec(nhand,"update sys_options  set defavalue=?_oct_invid,update_date = getdate() where type='oct_inv' ")<0		&&¥e¥Î¦¡¼g¤J

		Aerror(err)
		*Sqlrollback(nhand)
		*SQLSetprop(nhand,"Transactions" ,1)
		*frm_wait.Hide
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))
		Return -1
	Endif

	RETURN _oct_invid

ENDFUNC 


&&Lihong 2023.08.02 «D°Ý³¡ªù¤À±b
FUNCTION add_non_ask_itemdept(_inv_id)
IF VARTYPE(__save_dept_amt_at_pay)#"U" AND __save_dept_amt_at_pay 
	_default_itemdept_id = -888 &&cun_tmp.id
	TEXT TO ssql TEXTMERGE NOSHOW 
		DELETE inv_itemdept where id=?_inv_id AND parent_id in (select a.uid from inv_detail a with (nolock) left join item with (nolock) on a.item_id=item.id where a.id=?_inv_id and a.sitem_sub=0 and (a.askdept=0 and ISNULL(item.modi_dept_after_inv, 0)=0))

		select a.id,a.uid,a.item_id,a.amount,a.real_amount,a.round_amount,a.modi_amount,a.disc_amount,a.srv_amount,a.tax_amount,a.xdisc
		,c.dept_id,c.price,c.price_per from inv_detail a with (nolock) left join item with (nolock) on a.item_id=item.id left join itemdept c with (nolock) on a.item_id=c.item_id 
		where a.id=?_inv_id and a.sitem_sub=0 and (a.askdept=0 and ISNULL(item.modi_dept_after_inv, 0)=0) and c.dept_id in (select id from department where id<0 or active=1) 
		--and not exists (select id from inv_itemdept where id=?_inv_id and Parent_id=a.uid and dept_id<>?_default_itemdept_id) 
	ENDTEXT 
	If SQLExec(nhand,ssql, "cun_tmp")<0
		Aerror(err)
		frm_wait.Hide
		Sqlrollback(nhand)
		SQLSetprop(nhand,"Transactions",1)
		error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

		RETURN -1
	ENDIF
	SELECT *,srv_amount as samount FROM cun_tmp ORDER BY uid,dept_id INTO CURSOR cun_tmp READWRITE 
	UPDATE cun_tmp SET amount=ROUND((real_amount-srv_amount)*price_per/100, 1), samount=ROUND(srv_amount*price_per/100, 1)
	SELECT uid,MAX(real_amount-srv_amount) as amount,MAX(srv_amount) as samount, SUM(amount) as sum_amount, SUM(samount) as sum_samount FROM cun_tmp GROUP BY uid INTO CURSOR order_itemdept_tmp1
	SCAN 
		IF amount<>sum_amount OR samount<>sum_samount 
			SELECT TOP 1 uid FROM cun_tmp WHERE uid=order_itemdept_tmp1.uid Order By amount Desc  Into Cursor cun_tmp1
			UPDATE cun_tmp SET amount=amount+order_itemdept_tmp1.amount-order_itemdept_tmp1.sum_amount, samount=samount+order_itemdept_tmp1.samount-order_itemdept_tmp1.sum_samount WHERE uid=cun_tmp1.uid 
			SELECT order_itemdept_tmp1
		ENDIF 
	ENDSCAN 
	USE IN SELECT("order_itemdept_tmp1")
	USE IN SELECT("cun_tmp1")
	
	SELECT cun_tmp
	SCAN 
		TEXT TO ssql TEXTMERGE NOSHOW 
			INSERT INTO inv_itemdept (id,parent_id,item_id,dept_id,amount,srvamt) VALUES (?_inv_id,?cun_tmp.uid,?cun_tmp.item_id,?cun_tmp.dept_id,?cun_tmp.amount,?cun_tmp.samount)
		ENDTEXT 
		IF RECNO("cun_tmp")=1
			*ssql = "delete from inv_itemdept where id=?_inv_id" + CHR(13) + ssql 
		ENDIF 
		If SQLExec(nhand,ssql)<0
			Aerror(err)
			frm_wait.Hide
			Sqlrollback(nhand)
			SQLSetprop(nhand,"Transactions",1)
			error_catch(getmessage("_sqlserver_error"),Alltrim(Str(err(1))),Trim(err(2)),Program(),Lineno(1))

			RETURN -1
		Endif
	ENDSCAN 
ENDIF 
RETURN 1

ENDFUNC 